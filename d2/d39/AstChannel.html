<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asterisk - The Open Source Telephony Project: ast_channel locking and reference tracking</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Asterisk - The Open Source Telephony Project
   &#160;<span id="projectnumber">18.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="../../df/d3c/structast__channel.html" title="Main Channel structure associated with a channel. ">ast_channel</a> locking and reference tracking </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section user"><dt>Creating Channels</dt><dd>A channel is allocated using the <a class="el" href="../../d5/d7b/channel_8h.html#a2f18aafad0442206e71033ac6676dbb5" title="Create a channel structure. ">ast_channel_alloc()</a> function. When created, it is automatically inserted into the main channels hash table that keeps track of all active channels in the system. The hash key is based on the channel name. Because of this, if you want to change the name, you <em>must</em> use <a class="el" href="../../d5/d7b/channel_8h.html#aed0df108a26552c41985e4762e4993d8" title="Change channel name. ">ast_change_name()</a>, not change the name field directly. When <a class="el" href="../../d5/d7b/channel_8h.html#a2f18aafad0442206e71033ac6676dbb5" title="Create a channel structure. ">ast_channel_alloc()</a> returns a channel pointer, you now hold both a reference to that channel and a lock on the channel. Once the channel has been set up the lock can be released. In most cases the reference is given to <a class="el" href="../../db/de0/pbx_8h.html#a44b6406c9220f7f2b610ac712369f405" title="Execute the PBX in the current thread. ">ast_pbx_run()</a>.</dd></dl>
<dl class="section user"><dt>Channel Locking</dt><dd>There is a lock associated with every <a class="el" href="../../df/d3c/structast__channel.html" title="Main Channel structure associated with a channel. ">ast_channel</a>. It is allocated internally via <a class="el" href="../../d3/dfb/structastobj2.html">astobj2</a>. To lock or unlock a channel, you must use the <a class="el" href="../../d5/d7b/channel_8h.html#a493bdebe876caafb8ee535853310364a">ast_channel_lock()</a> wrappers.</dd></dl>
<p>Previously, before <a class="el" href="../../df/d3c/structast__channel.html" title="Main Channel structure associated with a channel. ">ast_channel</a> was converted to <a class="el" href="../../d3/dfb/structastobj2.html">astobj2</a>, the channel lock was used in some additional ways that are no longer necessary. Before, the only way to ensure that a channel did not disappear out from under you if you were working with a channel outside of the channel thread that owns it, was to hold the channel lock. Now, that is no longer necessary. You simply must hold a reference to the channel to ensure it does not go away.</p>
<p>The channel must be locked if you need to ensure that data that you reading from the channel does not change while you access it. Further, you must hold the channel lock if you are making a non-atomic change to channel data.</p>
<dl class="section user"><dt>Channel References</dt><dd>There are multiple ways to get a reference to a channel. The first is that you hold a reference to a channel after creating it. The other ways involve using the channel search or the channel traversal APIs. These functions are the ast_channel_get_*() functions or ast_channel_iterator_*() functions. Once a reference is retrieved by one of these methods, you know that the channel will not go away. So, the channel should only get locked as needed for data access or modification. But, make sure that the reference gets released when you are done with it!</dd></dl>
<p>There are different things you can do when you are done with a reference to a channel. The first is to simply release the reference using <a class="el" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380" title="Decrease channel reference count. ">ast_channel_unref()</a>. The other option is to call <a class="el" href="../../d5/d7b/channel_8h.html#a015abb5b26bfba6ca64f10fd9e0468ba" title="Unlink and release reference to a channel. ">ast_channel_release()</a>. This function is generally used where ast_channel_free() was used in the past. The release function releases a reference as well as ensures that the channel is no longer in the global channels container. That way, the channel will get destroyed as soon as any other pending references get released.</p>
<dl class="section user"><dt>Exceptions to the rules</dt><dd>Even though <a class="el" href="../../df/d3c/structast__channel.html" title="Main Channel structure associated with a channel. ">ast_channel</a> is reference counted, there are some places where pointers to an <a class="el" href="../../df/d3c/structast__channel.html" title="Main Channel structure associated with a channel. ">ast_channel</a> get stored, but the reference count does not reflect it. The reason is mostly historical. The only places where this happens should be places where because of how the code works, we <em>know</em> that the pointer to the channel will get removed before the channel goes away. The main example of this is in channel drivers. Channel drivers generally store a pointer to their owner <a class="el" href="../../df/d3c/structast__channel.html" title="Main Channel structure associated with a channel. ">ast_channel</a> in their technology specific pvt struct. In this case, the channel drivers <em>know</em> that this pointer to the channel will be removed in time, because the channel's hangup callback gets called before the channel goes away. </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 8 2021 19:47:12 for Asterisk - The Open Source Telephony Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
