<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asterisk - The Open Source Telephony Project: Object Model implementing objects and containers.</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Asterisk - The Open Source Telephony Project
   &#160;<span id="projectnumber">18.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Object Model implementing objects and containers. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This module implements an abstraction for objects (with locks and reference counts), and containers for these user-defined objects, also supporting locking, reference counting and callbacks.</p>
<p>The internal implementation of objects and containers is opaque to the user, so we can use different data structures as needs arise.</p>
<h1><a class="anchor" id="AstObj2_UsageObjects"></a>
USAGE - OBJECTS</h1>
<p>An ao2 object is a block of memory that the user code can access, and for which the system keeps track (with a bit of help from the programmer) of the number of references around. When an object has no more references (refcount == 0), it is destroyed, by first invoking whatever 'destructor' function the programmer specifies (it can be NULL if none is necessary), and then freeing the memory. This way objects can be shared without worrying who is in charge of freeing them. As an additional feature, ao2 objects are associated to individual locks.</p>
<p>Creating an object requires the size of the object and a pointer to the destructor function: </p><pre class="fragment">struct foo *o;

o = ao2_alloc(sizeof(struct foo), my_destructor_fn);
</pre><p>The value returned points to the user-visible portion of the objects (user-data), but is also used as an identifier for all object-related operations such as refcount and lock manipulations.</p>
<p>On return from <a class="el" href="../../d5/da5/astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc()</a>:</p>
<ul>
<li>the object has a refcount = 1;</li>
<li>the memory for the object is allocated dynamically and zeroed;</li>
<li>we cannot <a class="el" href="../../d8/d8a/astmm_8h.html#a40bca1270eac14ea5da81c924c02c3b7">realloc()</a> the object itself;</li>
<li><p class="startli">we cannot call <a class="el" href="../../d8/d8a/astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free(o)</a> to dispose of the object. Rather, we tell the system that we do not need the reference anymore:</p>
<p class="startli">ao2_ref(o, -1)</p>
<p class="startli">causing the destructor to be called (and then memory freed) when the refcount goes to 0.</p>
</li>
</ul>
<p>ao2_ref(o, +1) can be used to modify the refcount on the object in case we want to pass it around.</p>
<ul>
<li><a class="el" href="../../d5/da5/astobj2_8h.html#aa9fdb5d0a6157a56060d9f7279fe6c49">ao2_lock(obj)</a>, <a class="el" href="../../d5/da5/astobj2_8h.html#a9998bd156b936636a8780385e9a910b2">ao2_unlock(obj)</a>, <a class="el" href="../../d5/da5/astobj2_8h.html#ac565c6d59d59e076a866c3698f41ac9a">ao2_trylock(obj)</a> can be used to manipulate the lock associated with the object.</li>
</ul>
<h1><a class="anchor" id="AstObj2_UsageContainers"></a>
USAGE - CONTAINERS</h1>
<p>An ao2 container is an abstract data structure where we can store ao2 objects, search them (hopefully in an efficient way), and iterate or apply a callback function to them. A container is just an ao2 object itself.</p>
<p>A container must first be allocated, specifying the initial parameters. At the moment, this is done as follows: </p><pre class="fragment">&lt;b&gt;Sample Usage:&lt;/b&gt;
</pre> <div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../d2/da9/structao2__container.html">ao2_container</a> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>;</div><div class="line"></div><div class="line">c = <a class="code" href="../../d5/da5/astobj2_8h.html#aefc16f8aa9087cbc5c55c70cf1dd41b2">ao2_container_alloc_hash</a>(<a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a8ccf751bd6749d062999469f0694e7ad">AO2_ALLOC_OPT_LOCK_MUTEX</a>, 0, MAX_BUCKETS,</div><div class="line">    my_hash_fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, my_cmp_fn);</div></div><!-- fragment --><p>where</p>
<ul>
<li>MAX_BUCKETS is the number of buckets in the hash table,</li>
<li>my_hash_fn() is the (user-supplied) function that returns a hash key for the object (further reduced modulo MAX_BUCKETS by the container's code);</li>
<li>my_cmp_fn() is the default comparison function used when doing searches on the container,</li>
</ul>
<p>A container knows little or nothing about the objects it stores, other than the fact that they have been created by <a class="el" href="../../d5/da5/astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc()</a>. All knowledge of the (user-defined) internals of the objects is left to the (user-supplied) functions passed as arguments to <a class="el" href="../../d5/da5/astobj2_8h.html#aefc16f8aa9087cbc5c55c70cf1dd41b2">ao2_container_alloc_hash()</a>.</p>
<p>If we want to insert an object in a container, we should initialize its fields &ndash; especially, those used by my_hash_fn() &ndash; to compute the bucket to use. Once done, we can link an object to a container with </p><pre class="fragment">ao2_link(c, o);
</pre><p>The function returns NULL in case of errors (and the object is not inserted in the container). Other values mean success (we are not supposed to use the value as a pointer to anything). Linking an object to a container increases its refcount by 1 automatically.</p>
<dl class="section note"><dt>Note</dt><dd>While an object o is in a container, we expect that my_hash_fn(o) will always return the same value. The function does not lock the object to be computed, so modifications of those fields that affect the computation of the hash should be done by extracting the object from the container, and re-inserting it after the change (this is not terribly expensive).</dd>
<dd>
A container with a single buckets is effectively a linked list. However there is no ordering among elements.</dd></dl>
<ul>
<li><a class="el" href="../../d1/de6/AstObj2_Containers.html">AstObj2 Containers</a></li>
<li><a class="el" href="../../d5/da5/astobj2_8h.html">astobj2.h</a> All documentation for functions and data structures </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 8 2021 19:47:03 for Asterisk - The Open Source Telephony Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
