<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asterisk - The Open Source Telephony Project: Example dialplan for Mini-Voicemail</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Asterisk - The Open Source Telephony Project
   &#160;<span id="projectnumber">18.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Example dialplan for Mini-Voicemail </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Example"></a>
dialplan scripts for Mini-Voicemail</h1>
<pre class="fragment">; MINI-VOICEMAIL dialplan example
; ---------------------------------------------------------------------------------------
;
; This is an example on how to use the Mini-Voicemail system to build
; voicemail systems.
;
;.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-
; A macro to test the MINIVMACCOUNT dialplan function
; 	Currently, accountcode and pincode is not used in the application
; 	They where added to be used in dialplan scripting
;
;
[macro-minivmfunctest]
exten =&gt; s,1,set(account=${ARGV1})
exten =&gt; minivm,n,verbose(1,-------------------- Minivm Function test - Accoutn ${account}  -------------)
exten =&gt; s,n,verbose(1,---- Has account:       ${MINIVMACCOUNT(${account}:hasaccount)})
exten =&gt; s,n,verbose(1,---- Fullname:          ${MINIVMACCOUNT(${account}:fullname)})
exten =&gt; s,n,verbose(1,---- Email:             ${MINIVMACCOUNT(${account}:email)})
exten =&gt; s,n,verbose(1,---- Pager:             ${MINIVMACCOUNT(${account}:pager)})
exten =&gt; s,n,verbose(1,---- E-mail template:   ${MINIVMACCOUNT(${account}:etemplate)})
exten =&gt; s,n,verbose(1,---- Pager template:    ${MINIVMACCOUNT(${account}:ptemplate)})
exten =&gt; s,n,verbose(1,---- Account code:      ${MINIVMACCOUNT(${account}:accountcode)})
exten =&gt; s,n,verbose(1,---- Path:              ${MINIVMACCOUNT(${account}:path)})
exten =&gt; s,n,verbose(1,---- Pincode:           ${MINIVMACCOUNT(${account}:pincode)})
exten =&gt; s,n,verbose(1,---- Time zone:         ${MINIVMACCOUNT(${account}:timezone)})
exten =&gt; s,n,verbose(1,---- Language:          ${MINIVMACCOUNT(${account}:language)})
; This requires setvar=customerclass=gold in the account configuration
exten =&gt; s,n,verbose(1,---- Var:customerclass: ${MINIVMACCOUNT(${account}:customerclass)})

[minivm-scenario1]
; minivmtest tests the dialplan function MINIVMACCOUNT
; Check the output in the console with verbose set
exten =&gt; minivmtest,1,answer
exten =&gt; minivmtest,n,wait(0.5)
exten =&gt; minivmtest,n,set(ACCOUNT=do-not-spam-me@example.com)
exten =&gt; minivmtest,n,macro(minivmfunctest, ${ACCOUNT})
exten =&gt; minivmtest,n,playback(beep)
exten =&gt; minivmtest,n,hangup

;.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-
; "minivm" tests a full scenario
; Remember that users may hangup
; This works both for users with accounts in minivm.conf and by just giving an e-mail address
; without configuring an account
exten =&gt; minivm,1,answer
exten =&gt; minivm,n,wait(0.5)	; Wait for Voip channels to settle
exten =&gt; minivm,n,set(account=oej@example.com)
exten =&gt; minivm,n,noop(------------------------------------------- Minivm Greet   -------------)
exten =&gt; minivm,n,minivmgreet(${account})
exten =&gt; minivm,n,verbose(1,-- MINIVM_GREET_STATUS = ${MINIVM_GREET_STATUS} )
exten =&gt; minivm,n,noop(------------------------------------------- Minivm Record  -------------)
exten =&gt; minivm,n,minivmRecord(${account},b)
exten =&gt; minivm,n,goto(minivmcleanup,1)

; Cleanup after recording or hangup
exten =&gt; minivmcleanup,1,noop(------------------------------------------- Minivm Notify  -------------)
;Increment voicemail counter with 1. The counter will be used in the e-mail message
;and in the filename
exten =&gt; minivmcleanup,n,gotoif($[${MINIVM_RECORD_STATUS} != SUCCESS]?minivmrecordfailure,1)
exten =&gt; minivmcleanup,n,set(MINIVMCOUNTER(${account}:voicemailcounter:inc)=1)
exten =&gt; minivmcleanup,n,set(MVM_COUNTER = ${MINIVMCOUNTER(${account}:voicemailcounter)})
exten =&gt; minivmcleanup,n,minivmNotify(${account})
exten =&gt; minivmcleanup,n,verbose(1,-- MINIVM_NOTIFY_STATUS = ${MINIVM_NOTIFY_STATUS} )
; Now, clean up after sending voicemail
exten =&gt; minivmcleanup,n,noop(------------------------------------------- Minivm Delete  -------------)
exten =&gt; minivmcleanup,n,minivmdelete()
exten =&gt; minivmcleanup,n,verbose(1,-- MINIVM_DELETE_STATUS = ${MINIVM_DELETE_STATUS} )

;Recording failed
exten =&gt; minivmrecordfailure,1,playback(vm-sorry)
exten =&gt; minivmrecordfailure,n,wait(1)
exten =&gt; minivmrecordfailure,n,hangup

; If the user hangs up during the recording, we need to clean up
; And send notifications
exten =&gt; h,1,gotoif($[x${MINIVM_DELETE_STATUS} != x] ?h,stop)
exten =&gt; h,n,noop(------------------------------------------- HANGUP during voicemail recording   -------------)
exten =&gt; h,n,goto(minivmcleanup,1)
exten =&gt; h,n(stop),noop(---Minivm DONE----)

;.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-
; Extension to record a greeting message
; Call this like:
;	macro(recordgreetings,alice@atlanta.example.com)
;
[macro-recordgreetings]
exten =&gt; s,1,answer
exten =&gt; s,n,wait(0.5)
exten =&gt; s,n,set(account=${ARGV1])
; This file give extra options not available here, needs to be edited
; Change of password does not work
exten =&gt; s,n(menu),background(vm-options)
exten =&gt; 1,1,setvar(option=u)
exten =&gt; 1,n,macro(minivmrec,${account},${option})
exten =&gt; 1,n,goto(menu)
exten =&gt; 2,1,setvar(option=b)
exten =&gt; 2,n,macro(minivmrec,${account},${option})
exten =&gt; 2,n,goto(menu)
exten =&gt; 3,1,setvar(option=n)
exten =&gt; 3,n,macro(minivmrec,${account},${option})
exten =&gt; 3,n,goto(menu)
exten =&gt; 4,1,setvar(option=t)
exten =&gt; 4,n,macro(minivmrec,${account},${option})
exten =&gt; 4,n,goto(menu)
exten =&gt; *,1,playback(vm-thankyou)
exten =&gt; *,n,wait(1)
exten =&gt; *,n,hangup

exten =&gt; i,1,playback(invalid)
exten =&gt; i,n,goto(menu)

[macro-minivmrec]
exten =&gt; s,1,gotoif(${MINIVMACCOUNT(${account}:hasaccount)}?record)
; Account is not configured in minivm.conf or realtime
; Phony message, add something useful here
exten =&gt; s,n,playback(privacy-incorrect)
exten =&gt; s,n,macroreturn
exten =&gt; record,1,minivmappmess(${ARGV1},${ARGV2})
exten =&gt; record,n,noop(Recording status: ${MINIVM_APPMESS_STATUS})
exten =&gt; record,n,macroreturn

;.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-
; To set a counter and use a template for voicemail to users without acounts
; use something like this
;
; email address is in the "account" channel variable. Set from ast_db or a script
; based on called ID

exten =&gt; sendvoicemail,1,answer
exten =&gt; sendvoicemail,n,wait(0.5)
exten =&gt; sendvoicemail,n,set(domain=${CUT(account,@,2)})
exten =&gt; sendvoicemail,n,set(country=${CUT(domain,.,2)})
exten =&gt; sendvoicemail,n,minivmgreet(${account})
exten =&gt; sendvoicemail,n,minivmRecord(${account},b)
exten =&gt; sendvoicemail,n,goto(sendvmcleanup)

exten =&gt; sendvmcleanup,1,gotoif($[${MINIVM_RECORD_STATUS} != SUCCESS]?done)
; The counter is set in the domain directory, so we don't create one directory per user
; The counter has the email in the name of the counter, increase it
; Set the MVM_COUNTER variable that we use in the template
exten =&gt; sendvmcleanup,n,set(MINIVMCOUNTER(${account}:voicemailcounter:inc)=1)
exten =&gt; sendvmcleanup,n,set(MVM_COUNTER = ${MINIVMCOUNTER(${account}:voicemailcounter)})
; Increase a domain counter too, to see how many voicemails are sent to this domain
; This is just for statistics
exten =&gt; sendvmcleanup,n,set(MINIVMCOUNTER(${domain}:${domain}-all:inc) = 1)

; Send voicemail in e-mail with country-specific template
; The template need to be defined in minivm.conf
;
exten =&gt; sendvmcleanup,n,minivmNotify(${account}, ${country}_email)
exten =&gt; sendvmcleanup,n,minivmDelete()

exten =&gt; sendvmcleanup,n(done),wait(0.5)
exten =&gt; sendvmcleanup,n,hangup

exten =&gt; h,1,gotoif($[${MINIVM_RECORD_STATUS} = SUCCESS]?sendvmcleanup,1))
</pre><p>Back: <a class="el" href="../../de/d85/App_minivm.html">Asterisk Mini-voicemail - A minimal voicemail system</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 8 2021 19:47:03 for Asterisk - The Open Source Telephony Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
