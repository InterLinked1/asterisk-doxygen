<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asterisk - The Open Source Telephony Project: app_voicemail.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Asterisk - The Open Source Telephony Project
   &#160;<span id="projectnumber">18.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_9654b8d08f4bba4e84b362c5fd320bee.html">apps</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">app_voicemail.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/df4/app__voicemail_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * Asterisk -- An open source telephony toolkit.</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * See http://www.asterisk.org for more information about</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * the Asterisk project. Please do not directly contact</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * any of the maintainers of this project for assistance;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * the project provides a web site, mailing lists and IRC</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * channels for your use.</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * This program is free software, distributed under the terms of</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * at the top of the source tree.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * \file</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * \brief Comedian Mail - Voicemail System</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * unixODBC (http://www.unixodbc.org/)</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * A source distribution of University of Washington&#39;s IMAP c-client</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> *         (http://www.washington.edu/imap/)</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * \par See also</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * \arg \ref Config_vm</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * \note For information about voicemail IMAP storage, https://wiki.asterisk.org/wiki/display/AST/IMAP+Voicemail+Storage</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> * \ingroup applications</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> * \todo This module requires res_adsi to load. This needs to be optional</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> * during compilation.</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> * \todo This file is now almost impossible to work with, due to all \#ifdefs.</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> *       Feels like the database code before realtime. Someone - please come up</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> *       with a plan to clean this up.</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">/*! \li \ref app_voicemail.c uses configuration file \ref voicemail.conf</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"> * \addtogroup configuration_file Configuration Files</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"> * \page voicemail.conf voicemail.conf</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"> * \verbinclude voicemail.conf.sample</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/db2/asterisk_8h.html">asterisk.h</a>&quot;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &lt;ctype.h&gt;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &lt;pwd.h&gt;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#ifdef USE_SYSTEM_IMAP</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &lt;imap/c-client.h&gt;</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#include &lt;imap/imap4r1.h&gt;</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#include &lt;imap/linkage.h&gt;</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#elif defined (USE_SYSTEM_CCLIENT)</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#include &lt;c-client/c-client.h&gt;</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#include &lt;c-client/imap4r1.h&gt;</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#include &lt;c-client/linkage.h&gt;</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor">#include &quot;c-client.h&quot;</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#include &quot;imap4r1.h&quot;</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor">#include &quot;linkage.h&quot;</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dd/df2/paths_8h.html">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_SPOOL_DIR */</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">#include &lt;sys/time.h&gt;</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../de/df7/time_8h.html">time.h</a>&gt;</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">#include &lt;dirent.h&gt;</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor">#if defined(__FreeBSD__) || defined(__OpenBSD__)</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="preprocessor">#include &lt;sys/wait.h&gt;</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/logger_8h.html">asterisk/logger.h</a>&quot;</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dd/d42/lock_8h.html">asterisk/lock.h</a>&quot;</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4d/file_8h.html">asterisk/file.h</a>&quot;</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/d7b/channel_8h.html">asterisk/channel.h</a>&quot;</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/de0/pbx_8h.html">asterisk/pbx.h</a>&quot;</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html">asterisk/config.h</a>&quot;</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/dce/say_8h.html">asterisk/say.h</a>&quot;</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/d16/module_8h.html">asterisk/module.h</a>&quot;</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../df/de2/adsi_8h.html">asterisk/adsi.h</a>&quot;</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html">asterisk/app.h</a>&quot;</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/d33/mwi_8h.html">asterisk/mwi.h</a>&quot;</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/d45/manager_8h.html">asterisk/manager.h</a>&quot;</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d3/d08/dsp_8h.html">asterisk/dsp.h</a>&quot;</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/deb/localtime_8h.html">asterisk/localtime.h</a>&quot;</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/db0/cli_8h.html">asterisk/cli.h</a>&quot;</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/d60/utils_8h.html">asterisk/utils.h</a>&quot;</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d1/d0f/stringfields_8h.html">asterisk/stringfields.h</a>&quot;</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d6/d90/strings_8h.html">asterisk/strings.h</a>&quot;</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/dca/smdi_8h.html">asterisk/smdi.h</a>&quot;</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/da5/astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d0/d1e/taskprocessor_8h.html">asterisk/taskprocessor.h</a>&quot;</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/ddc/test_8h.html">asterisk/test.h</a>&quot;</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/d1c/format__cache_8h.html">asterisk/format_cache.h</a>&quot;</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/res__odbc_8h.html">asterisk/res_odbc.h</a>&quot;</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/d7d/threadstorage_8h.html">asterisk/threadstorage.h</a>&quot;</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">/*** DOCUMENTATION</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">   &lt;application name=&quot;VoiceMail&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">         Leave a Voicemail message.</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">         &lt;parameter name=&quot;mailboxs&quot; argsep=&quot;&amp;amp;&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox1&quot; argsep=&quot;@&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">               &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">               &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">            &lt;/argument&gt;</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox2&quot; argsep=&quot;@&quot; multiple=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">               &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">               &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">            &lt;/argument&gt;</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">            &lt;optionlist&gt;</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">               &lt;option name=&quot;b&quot;&gt;</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">                  &lt;para&gt;Play the &lt;literal&gt;busy&lt;/literal&gt; greeting to the calling party.&lt;/para&gt;</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">               &lt;option name=&quot;d&quot;&gt;</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">                  &lt;argument name=&quot;c&quot; /&gt;</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">                  &lt;para&gt;Accept digits for a new extension in context &lt;replaceable&gt;c&lt;/replaceable&gt;,</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">                  if played during the greeting. Context defaults to the current context.&lt;/para&gt;</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">               &lt;option name=&quot;e&quot;&gt;</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">                  &lt;para&gt;Play greetings as early media -- only answer the channel just</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">                  before accepting the voice message.&lt;/para&gt;</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">               &lt;option name=&quot;g&quot;&gt;</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">                  &lt;argument name=&quot;#&quot; required=&quot;true&quot; /&gt;</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">                  &lt;para&gt;Use the specified amount of gain when recording the voicemail</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">                  message. The units are whole-number decibels (dB). Only works on supported</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">                  technologies, which is DAHDI only.&lt;/para&gt;</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">               &lt;option name=&quot;s&quot;&gt;</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">                  &lt;para&gt;Skip the playback of instructions for leaving a message to the</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">                  calling party.&lt;/para&gt;</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">               &lt;option name=&quot;t&quot;&gt;</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">                  &lt;argument name=&quot;x&quot; required=&quot;false&quot; /&gt;</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">                  &lt;para&gt;Play a custom beep tone to the caller instead of the default one.</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">                  If this option is used but no file is specified, the beep is suppressed.&lt;/para&gt;</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">               &lt;option name=&quot;u&quot;&gt;</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">                  &lt;para&gt;Play the &lt;literal&gt;unavailable&lt;/literal&gt; greeting.&lt;/para&gt;</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">               &lt;option name=&quot;U&quot;&gt;</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment">                  &lt;para&gt;Mark message as &lt;literal&gt;URGENT&lt;/literal&gt;.&lt;/para&gt;</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">               &lt;option name=&quot;P&quot;&gt;</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">                  &lt;para&gt;Mark message as &lt;literal&gt;PRIORITY&lt;/literal&gt;.&lt;/para&gt;</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">            &lt;/optionlist&gt;</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">         &lt;para&gt;This application allows the calling party to leave a message for the specified</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment">         list of mailboxes. When multiple mailboxes are specified, the greeting will be taken from</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">         the first mailbox specified. Dialplan execution will stop if the specified mailbox does not</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">         exist.&lt;/para&gt;</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">         &lt;para&gt;The Voicemail application will exit if any of the following DTMF digits are received:&lt;/para&gt;</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">         &lt;enumlist&gt;</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">            &lt;enum name=&quot;0&quot;&gt;</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">               &lt;para&gt;Jump to the &lt;literal&gt;o&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">            &lt;/enum&gt;</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">            &lt;enum name=&quot;*&quot;&gt;</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">               &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">            &lt;/enum&gt;</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">         &lt;/enumlist&gt;</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">         &lt;para&gt;This application will set the following channel variable upon completion:&lt;/para&gt;</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">         &lt;variablelist&gt;</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">            &lt;variable name=&quot;VMSTATUS&quot;&gt;</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">               &lt;para&gt;This indicates the status of the execution of the VoiceMail application.&lt;/para&gt;</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">               &lt;value name=&quot;SUCCESS&quot; /&gt;</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">               &lt;value name=&quot;USEREXIT&quot; /&gt;</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">               &lt;value name=&quot;FAILED&quot; /&gt;</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">            &lt;/variable&gt;</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">         &lt;/variablelist&gt;</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">      &lt;see-also&gt;</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">         &lt;ref type=&quot;application&quot;&gt;VoiceMailMain&lt;/ref&gt;</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">      &lt;/see-also&gt;</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">   &lt;/application&gt;</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">   &lt;application name=&quot;VoiceMailMain&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">         Check Voicemail messages.</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox&quot; /&gt;</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">            &lt;optionlist&gt;</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">               &lt;option name=&quot;p&quot;&gt;</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">                  &lt;para&gt;Consider the &lt;replaceable&gt;mailbox&lt;/replaceable&gt; parameter as a prefix to</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">                  the mailbox that is entered by the caller.&lt;/para&gt;</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment">               &lt;option name=&quot;g&quot;&gt;</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">                  &lt;argument name=&quot;#&quot; required=&quot;true&quot; /&gt;</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">                  &lt;para&gt;Use the specified amount of gain when recording a voicemail message.</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">                  The units are whole-number decibels (dB).&lt;/para&gt;</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">               &lt;option name=&quot;s&quot;&gt;</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">                  &lt;para&gt;Skip checking the passcode for the mailbox.&lt;/para&gt;</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">               &lt;option name=&quot;a&quot;&gt;</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">                  &lt;argument name=&quot;folder&quot; required=&quot;true&quot; /&gt;</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">                  &lt;para&gt;Skip folder prompt and go directly to &lt;replaceable&gt;folder&lt;/replaceable&gt; specified.</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">                  Defaults to &lt;literal&gt;INBOX&lt;/literal&gt; (or &lt;literal&gt;0&lt;/literal&gt;).&lt;/para&gt;</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">                  &lt;enumlist&gt;</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">                     &lt;enum name=&quot;0&quot;&gt;&lt;para&gt;INBOX&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">                     &lt;enum name=&quot;1&quot;&gt;&lt;para&gt;Old&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">                     &lt;enum name=&quot;2&quot;&gt;&lt;para&gt;Work&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">                     &lt;enum name=&quot;3&quot;&gt;&lt;para&gt;Family&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">                     &lt;enum name=&quot;4&quot;&gt;&lt;para&gt;Friends&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">                     &lt;enum name=&quot;5&quot;&gt;&lt;para&gt;Cust1&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">                     &lt;enum name=&quot;6&quot;&gt;&lt;para&gt;Cust2&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">                     &lt;enum name=&quot;7&quot;&gt;&lt;para&gt;Cust3&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">                     &lt;enum name=&quot;8&quot;&gt;&lt;para&gt;Cust4&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">                     &lt;enum name=&quot;9&quot;&gt;&lt;para&gt;Cust5&lt;/para&gt;&lt;/enum&gt;</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">                  &lt;/enumlist&gt;</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">            &lt;/optionlist&gt;</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">         &lt;para&gt;This application allows the calling party to check voicemail messages. A specific</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">         &lt;replaceable&gt;mailbox&lt;/replaceable&gt;, and optional corresponding &lt;replaceable&gt;context&lt;/replaceable&gt;,</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">         may be specified. If a &lt;replaceable&gt;mailbox&lt;/replaceable&gt; is not provided, the calling party will</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">         be prompted to enter one. If a &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, the</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment">         &lt;literal&gt;default&lt;/literal&gt; context will be used.&lt;/para&gt;</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">         &lt;para&gt;The VoiceMailMain application will exit if the following DTMF digit is entered as Mailbox</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment">         or Password, and the extension exists:&lt;/para&gt;</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">         &lt;enumlist&gt;</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">            &lt;enum name=&quot;*&quot;&gt;</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">               &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="comment">            &lt;/enum&gt;</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">         &lt;/enumlist&gt;</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">      &lt;see-also&gt;</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">         &lt;ref type=&quot;application&quot;&gt;VoiceMail&lt;/ref&gt;</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">      &lt;/see-also&gt;</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">   &lt;/application&gt;</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">   &lt;application name=&quot;VMAuthenticate&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">         Authenticate with Voicemail passwords.</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox&quot; /&gt;</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">            &lt;optionlist&gt;</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">               &lt;option name=&quot;s&quot;&gt;</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">                  &lt;para&gt;Skip playing the initial prompts.&lt;/para&gt;</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">            &lt;/optionlist&gt;</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">         &lt;para&gt;This application behaves the same way as the Authenticate application, but the passwords</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">         are taken from &lt;filename&gt;voicemail.conf&lt;/filename&gt;. If the &lt;replaceable&gt;mailbox&lt;/replaceable&gt; is</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">         specified, only that mailbox&#39;s password will be considered valid. If the &lt;replaceable&gt;mailbox&lt;/replaceable&gt;</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">         is not specified, the channel variable &lt;variable&gt;AUTH_MAILBOX&lt;/variable&gt; will be set with the authenticated</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">         mailbox.&lt;/para&gt;</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">         &lt;para&gt;The VMAuthenticate application will exit if the following DTMF digit is entered as Mailbox</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">         or Password, and the extension exists:&lt;/para&gt;</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">         &lt;enumlist&gt;</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">            &lt;enum name=&quot;*&quot;&gt;</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">               &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">            &lt;/enum&gt;</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">         &lt;/enumlist&gt;</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">   &lt;/application&gt;</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">   &lt;application name=&quot;VoiceMailPlayMsg&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">         Play a single voice mail msg from a mailbox by msg id.</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox&quot; /&gt;</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">         &lt;parameter name=&quot;msg_id&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">            &lt;para&gt;The msg id of the msg to play back. &lt;/para&gt;</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">         &lt;variablelist&gt;</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">            &lt;variable name=&quot;VOICEMAIL_PLAYBACKSTATUS&quot;&gt;</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">               &lt;para&gt;The status of the playback attempt as a text string.&lt;/para&gt;</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">               &lt;value name=&quot;SUCCESS&quot;/&gt;</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">               &lt;value name=&quot;FAILED&quot;/&gt;</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">            &lt;/variable&gt;</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">         &lt;/variablelist&gt;</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">   &lt;/application&gt;</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">   &lt;application name=&quot;VMSayName&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">         Play the name of a voicemail user</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox&quot; /&gt;</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">         &lt;para&gt;This application will say the recorded name of the voicemail user specified as the</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">         argument to this application. If no context is provided, &lt;literal&gt;default&lt;/literal&gt; is assumed.&lt;/para&gt;</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">         &lt;para&gt;Similar to the Background() application, playback of the recorded</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">         name can be interrupted by entering an extension, which will be searched</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">         for in the current context.&lt;/para&gt;</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">   &lt;/application&gt;</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">   &lt;function name=&quot;VM_INFO&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">         Returns the selected attribute from a mailbox.</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">      &lt;syntax argsep=&quot;,&quot;&gt;</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">         &lt;parameter name=&quot;mailbox&quot; argsep=&quot;@&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">            &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment">         &lt;parameter name=&quot;attribute&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment">            &lt;optionlist&gt;</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">               &lt;option name=&quot;count&quot;&gt;</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">                  &lt;para&gt;Count of messages in specified &lt;replaceable&gt;folder&lt;/replaceable&gt;.</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">                  If &lt;replaceable&gt;folder&lt;/replaceable&gt; is not specified, defaults to &lt;literal&gt;INBOX&lt;/literal&gt;.&lt;/para&gt;</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">               &lt;option name=&quot;email&quot;&gt;</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">                  &lt;para&gt;E-mail address associated with the mailbox.&lt;/para&gt;</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">               &lt;option name=&quot;exists&quot;&gt;</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">                  &lt;para&gt;Returns a boolean of whether the corresponding &lt;replaceable&gt;mailbox&lt;/replaceable&gt; exists.&lt;/para&gt;</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">               &lt;option name=&quot;fullname&quot;&gt;</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">                  &lt;para&gt;Full name associated with the mailbox.&lt;/para&gt;</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">               &lt;option name=&quot;language&quot;&gt;</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">                  &lt;para&gt;Mailbox language if overridden, otherwise the language of the channel.&lt;/para&gt;</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">               &lt;option name=&quot;locale&quot;&gt;</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">                  &lt;para&gt;Mailbox locale if overridden, otherwise global locale.&lt;/para&gt;</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">               &lt;option name=&quot;pager&quot;&gt;</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">                  &lt;para&gt;Pager e-mail address associated with the mailbox.&lt;/para&gt;</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">               &lt;option name=&quot;password&quot;&gt;</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">                  &lt;para&gt;Mailbox access password.&lt;/para&gt;</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">               &lt;option name=&quot;tz&quot;&gt;</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">                  &lt;para&gt;Mailbox timezone if overridden, otherwise global timezone&lt;/para&gt;</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">               &lt;/option&gt;</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">            &lt;/optionlist&gt;</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">         &lt;parameter name=&quot;folder&quot; required=&quot;false&quot;&gt;</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">            &lt;para&gt;If not specified, &lt;literal&gt;INBOX&lt;/literal&gt; is assumed.&lt;/para&gt;</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">         &lt;para&gt;Returns the selected attribute from the specified &lt;replaceable&gt;mailbox&lt;/replaceable&gt;.</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">         If &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, defaults to the &lt;literal&gt;default&lt;/literal&gt;</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment">         context. Where the &lt;replaceable&gt;folder&lt;/replaceable&gt; can be specified, common folders</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">         include &lt;literal&gt;INBOX&lt;/literal&gt;, &lt;literal&gt;Old&lt;/literal&gt;, &lt;literal&gt;Work&lt;/literal&gt;,</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">         &lt;literal&gt;Family&lt;/literal&gt; and &lt;literal&gt;Friends&lt;/literal&gt;.&lt;/para&gt;</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">   &lt;/function&gt;</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">   &lt;manager name=&quot;VoicemailUsersList&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">         List All Voicemail User Information.</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name=&#39;Login&#39;]/syntax/parameter[@name=&#39;ActionID&#39;])&quot; /&gt;</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">   &lt;/manager&gt;</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">   &lt;manager name=&quot;VoicemailUserStatus&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">         Show the status of given voicemail user&#39;s info.</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name=&#39;Login&#39;]/syntax/parameter[@name=&#39;ActionID&#39;])&quot; /&gt;</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">         &lt;parameter name=&quot;Context&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">            &lt;para&gt;The context you want to check.&lt;/para&gt;</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">         &lt;parameter name=&quot;Mailbox&quot; required=&quot;true&quot;&gt;</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">            &lt;para&gt;The mailbox you want to check.&lt;/para&gt;</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">         &lt;/parameter&gt;</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">         &lt;para&gt;Retrieves the status of the given voicemail user.&lt;/para&gt;</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">   &lt;/manager&gt;</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">   &lt;manager name=&quot;VoicemailRefresh&quot; language=&quot;en_US&quot;&gt;</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment">      &lt;synopsis&gt;</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">         Tell Asterisk to poll mailboxes for a change</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">      &lt;/synopsis&gt;</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">      &lt;syntax&gt;</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name=&#39;Login&#39;]/syntax/parameter[@name=&#39;ActionID&#39;])&quot; /&gt;</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">         &lt;parameter name=&quot;Context&quot; /&gt;</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">         &lt;parameter name=&quot;Mailbox&quot; /&gt;</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">      &lt;/syntax&gt;</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">      &lt;description&gt;</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">         &lt;para&gt;Normally, MWI indicators are only sent when Asterisk itself</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">         changes a mailbox.  With external programs that modify the content</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment">         of a mailbox from outside the application, an option exists called</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">         &lt;literal&gt;pollmailboxes&lt;/literal&gt; that will cause voicemail to</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">         continually scan all mailboxes on a system for changes.  This can</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">         cause a large amount of load on a system.  This command allows</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="comment">         external applications to signal when a particular mailbox has</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">         changed, thus permitting external applications to modify mailboxes</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">         and MWI to work without introducing considerable CPU load.&lt;/para&gt;</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">         &lt;para&gt;If &lt;replaceable&gt;Context&lt;/replaceable&gt; is not specified, all</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">         mailboxes on the system will be polled for changes.  If</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">         &lt;replaceable&gt;Context&lt;/replaceable&gt; is specified, but</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">         &lt;replaceable&gt;Mailbox&lt;/replaceable&gt; is omitted, then all mailboxes</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">         within &lt;replaceable&gt;Context&lt;/replaceable&gt; will be polled.</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment">         Otherwise, only a single mailbox will be polled for changes.&lt;/para&gt;</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">      &lt;/description&gt;</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">   &lt;/manager&gt;</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment"> ***/</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> imapserver[48] = <span class="stringliteral">&quot;localhost&quot;</span>;</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> imapport[8] = <span class="stringliteral">&quot;143&quot;</span>;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> imapflags[128];</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> imapfolder[64] = <span class="stringliteral">&quot;INBOX&quot;</span>;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> imapparentfolder[64];</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> greetingfolder[64] = <span class="stringliteral">&quot;INBOX&quot;</span>;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> authuser[32];</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> authpassword[42];</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imapversion = 1;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> expungeonhangup = 1;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imapgreetings;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_poll_logout;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> delimiter;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">/* mail_open cannot be protected on a stream basis */</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<a class="code" href="../../d8/dc5/structast__mutex__info.html">ast_mutex_t</a> mail_open_lock;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a>;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a>;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<a class="code" href="../../dc/d7d/threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6">AST_THREADSTORAGE</a>(ts_vmstate);</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">/* Forward declarations for IMAP */</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> init_mailstream(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box);</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> write_file(<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *get_header_by_tag(<span class="keywordtype">char</span> *<a class="code" href="../../d5/d65/structheader.html">header</a>, <span class="keywordtype">char</span> *tag, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vm_imap_delete(<span class="keywordtype">char</span> *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu);</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *get_user_by_mailbox(<span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *get_vm_state_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d8/dbc/structuser.html">user</a>, <span class="keywordtype">int</span> interactive);</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *get_vm_state_by_mailbox(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">int</span> interactive);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *create_vm_state_from_user(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu);</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_insert(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms);</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_delete(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms);</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> set_update(MAILSTREAM * stream);</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> init_vm_state(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> save_body(BODY *body, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *section, <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>, <span class="keywordtype">int</span> is_intro);</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> get_mailbox_delimiter(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, MAILSTREAM *stream);</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> mm_parsequota (MAILSTREAM *stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *msg, QUOTALIST *pquota);</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> imap_mailbox_name(<span class="keywordtype">char</span> *spec, <span class="keywordtype">size_t</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box, <span class="keywordtype">int</span> target);</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_store_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> duration, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id);</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vm_imap_update_msg_id(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg, <span class="keywordtype">int</span> folder);</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> update_messages_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d8/dbc/structuser.html">user</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d6/d49/structnumber.html">number</a>);</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e">vm_delete</a>(<span class="keywordtype">char</span> *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>);</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_remove_file (<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum);</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_retrieve_file (<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">int</span> msgnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_delete_old_greeting (<span class="keywordtype">char</span> *dir, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms);</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> check_quota(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>);</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box);</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> imap_logout(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id);</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="keyword">struct </span>vmstate {</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7">AST_LIST_ENTRY</a>(vmstate) list;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;};</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b">AST_LIST_HEAD_STATIC</a>(vmstates, vmstate);</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab396ba916ebd13b58eedfb621a602413">  503</a></span>&#160;<span class="preprocessor">#define SMDI_MWI_WAIT_TIMEOUT 1000 </span><span class="comment">/* 1 second */</span><span class="preprocessor"></span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4ec5f68b5fd7b11e202f1f2f508a3fee">  505</a></span>&#160;<span class="preprocessor">#define COMMAND_TIMEOUT 5000</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">/* Don&#39;t modify these here; set your umask at runtime instead */</span></div><div class="line"><a name="l00507"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">  507</a></span>&#160;<span class="preprocessor">#define  VOICEMAIL_DIR_MODE   0777</span></div><div class="line"><a name="l00508"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">  508</a></span>&#160;<span class="preprocessor">#define  VOICEMAIL_FILE_MODE  0666</span></div><div class="line"><a name="l00509"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">  509</a></span>&#160;<span class="preprocessor">#define  CHUNKSIZE   65536</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">  511</a></span>&#160;<span class="preprocessor">#define VOICEMAIL_CONFIG &quot;voicemail.conf&quot;</span></div><div class="line"><a name="l00512"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5e790f0ee1dbde79705c49bf33a1060d">  512</a></span>&#160;<span class="preprocessor">#define ASTERISK_USERNAME &quot;asterisk&quot;</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">/* Define fast-forward, pause, restart, and reverse keys</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment"> * while listening to a voicemail message - these are</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment"> * strings, not characters */</span></div><div class="line"><a name="l00517"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1eb1e0cbaef35879c60c6afd79dcc6af">  517</a></span>&#160;<span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_FORWARD_KEY &quot;#&quot;</span></div><div class="line"><a name="l00518"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#adf398fc1e24857033174482891adab4a">  518</a></span>&#160;<span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_REVERSE_KEY &quot;*&quot;</span></div><div class="line"><a name="l00519"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aab009b1bd02c3b2580f86581c9fa2c70">  519</a></span>&#160;<span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_PAUSE_KEY &quot;0&quot;</span></div><div class="line"><a name="l00520"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a724057a0c369a6b5dd798ccc31cf53f2">  520</a></span>&#160;<span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_RESTART_KEY &quot;2&quot;</span></div><div class="line"><a name="l00521"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7decd8d5e42401e22d0d86d150e70a04">  521</a></span>&#160;<span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_STOP_KEY &quot;13456789&quot;</span></div><div class="line"><a name="l00522"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ace804dd195bf827b988e3f2282422d25">  522</a></span>&#160;<span class="preprocessor">#define VALID_DTMF &quot;1234567890*#&quot; </span><span class="comment">/* Yes ABCD are valid dtmf but what phones have those? */</span><span class="preprocessor"></span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">/* Default mail command to mail voicemail. Change it with the</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment"> * mailcmd= command in voicemail.conf */</span></div><div class="line"><a name="l00526"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a92d8fb2d08cf9220d520ae9691b5e6c4">  526</a></span>&#160;<span class="preprocessor">#define SENDMAIL &quot;/usr/sbin/sendmail -t&quot;</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">  528</a></span>&#160;<span class="preprocessor">#define INTRO &quot;vm-intro&quot;</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abf5e7cf8ce333dece7920d64415b41d7">  530</a></span>&#160;<span class="preprocessor">#define MAX_MAIL_BODY_CONTENT_SIZE 134217728L // 128 Mbyte</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;</div><div class="line"><a name="l00532"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">  532</a></span>&#160;<span class="preprocessor">#define MAXMSG 100</span></div><div class="line"><a name="l00533"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">  533</a></span>&#160;<span class="preprocessor">#define MAXMSGLIMIT 9999</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div><div class="line"><a name="l00535"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aca7150caac3749421acc40d7bc3483f1">  535</a></span>&#160;<span class="preprocessor">#define MINPASSWORD 0 </span><span class="comment">/*!&lt; Default minimum mailbox password length */</span><span class="preprocessor"></span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div><div class="line"><a name="l00537"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1e31aa9d6eb3fa3e9287e3f3c3c16969">  537</a></span>&#160;<span class="preprocessor">#define BASELINELEN 72</span></div><div class="line"><a name="l00538"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">  538</a></span>&#160;<span class="preprocessor">#define BASEMAXINLINE 256</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="preprocessor">#define ENDL &quot;\r\n&quot;</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00542"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">  542</a></span>&#160;<span class="preprocessor">#define ENDL &quot;\n&quot;</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div><div class="line"><a name="l00545"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad76c4e7e27885ab5ae9cd4652bf0f95a">  545</a></span>&#160;<span class="preprocessor">#define MAX_DATETIME_FORMAT   512</span></div><div class="line"><a name="l00546"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aab88842146c214975db358115d86c726">  546</a></span>&#160;<span class="preprocessor">#define MAX_NUM_CID_CONTEXTS 10</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">  548</a></span>&#160;<span class="preprocessor">#define VM_REVIEW        (1 &lt;&lt; 0)   </span><span class="comment">/*!&lt; After recording, permit the caller to review the recording before saving */</span><span class="preprocessor"></span></div><div class="line"><a name="l00549"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">  549</a></span>&#160;<span class="preprocessor">#define VM_OPERATOR      (1 &lt;&lt; 1)   </span><span class="comment">/*!&lt; Allow 0 to be pressed to go to &#39;o&#39; extension */</span><span class="preprocessor"></span></div><div class="line"><a name="l00550"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">  550</a></span>&#160;<span class="preprocessor">#define VM_SAYCID        (1 &lt;&lt; 2)   </span><span class="comment">/*!&lt; Repeat the CallerID info during envelope playback */</span><span class="preprocessor"></span></div><div class="line"><a name="l00551"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">  551</a></span>&#160;<span class="preprocessor">#define VM_SVMAIL        (1 &lt;&lt; 3)   </span><span class="comment">/*!&lt; Allow the user to compose a new VM from within VoicemailMain */</span><span class="preprocessor"></span></div><div class="line"><a name="l00552"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">  552</a></span>&#160;<span class="preprocessor">#define VM_ENVELOPE      (1 &lt;&lt; 4)   </span><span class="comment">/*!&lt; Play the envelope information (who-from, time received, etc.) */</span><span class="preprocessor"></span></div><div class="line"><a name="l00553"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">  553</a></span>&#160;<span class="preprocessor">#define VM_SAYDURATION   (1 &lt;&lt; 5)   </span><span class="comment">/*!&lt; Play the length of the message during envelope playback */</span><span class="preprocessor"></span></div><div class="line"><a name="l00554"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">  554</a></span>&#160;<span class="preprocessor">#define VM_SKIPAFTERCMD  (1 &lt;&lt; 6)   </span><span class="comment">/*!&lt; After deletion, assume caller wants to go to the next message */</span><span class="preprocessor"></span></div><div class="line"><a name="l00555"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">  555</a></span>&#160;<span class="preprocessor">#define VM_FORCENAME     (1 &lt;&lt; 7)   </span><span class="comment">/*!&lt; Have new users record their name */</span><span class="preprocessor"></span></div><div class="line"><a name="l00556"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">  556</a></span>&#160;<span class="preprocessor">#define VM_FORCEGREET    (1 &lt;&lt; 8)   </span><span class="comment">/*!&lt; Have new users record their greetings */</span><span class="preprocessor"></span></div><div class="line"><a name="l00557"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">  557</a></span>&#160;<span class="preprocessor">#define VM_PBXSKIP       (1 &lt;&lt; 9)   </span><span class="comment">/*!&lt; Skip the [PBX] preamble in the Subject line of emails */</span><span class="preprocessor"></span></div><div class="line"><a name="l00558"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">  558</a></span>&#160;<span class="preprocessor">#define VM_DIRECFORWARD  (1 &lt;&lt; 10)  </span><span class="comment">/*!&lt; Permit caller to use the Directory app for selecting to which mailbox to forward a VM */</span><span class="preprocessor"></span></div><div class="line"><a name="l00559"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">  559</a></span>&#160;<span class="preprocessor">#define VM_ATTACH        (1 &lt;&lt; 11)  </span><span class="comment">/*!&lt; Attach message to voicemail notifications? */</span><span class="preprocessor"></span></div><div class="line"><a name="l00560"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">  560</a></span>&#160;<span class="preprocessor">#define VM_DELETE        (1 &lt;&lt; 12)  </span><span class="comment">/*!&lt; Delete message after sending notification */</span><span class="preprocessor"></span></div><div class="line"><a name="l00561"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">  561</a></span>&#160;<span class="preprocessor">#define VM_ALLOCED       (1 &lt;&lt; 13)  </span><span class="comment">/*!&lt; Structure was malloc&#39;ed, instead of placed in a return (usually static) buffer */</span><span class="preprocessor"></span></div><div class="line"><a name="l00562"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">  562</a></span>&#160;<span class="preprocessor">#define VM_SEARCH        (1 &lt;&lt; 14)  </span><span class="comment">/*!&lt; Search all contexts for a matching mailbox */</span><span class="preprocessor"></span></div><div class="line"><a name="l00563"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">  563</a></span>&#160;<span class="preprocessor">#define VM_TEMPGREETWARN (1 &lt;&lt; 15)  </span><span class="comment">/*!&lt; Remind user tempgreeting is set */</span><span class="preprocessor"></span></div><div class="line"><a name="l00564"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">  564</a></span>&#160;<span class="preprocessor">#define VM_MOVEHEARD     (1 &lt;&lt; 16)  </span><span class="comment">/*!&lt; Move a &quot;heard&quot; message to Old after listening to it */</span><span class="preprocessor"></span></div><div class="line"><a name="l00565"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">  565</a></span>&#160;<span class="preprocessor">#define VM_MESSAGEWRAP   (1 &lt;&lt; 17)  </span><span class="comment">/*!&lt; Wrap around from the last message to the first, and vice-versa */</span><span class="preprocessor"></span></div><div class="line"><a name="l00566"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">  566</a></span>&#160;<span class="preprocessor">#define VM_FWDURGAUTO    (1 &lt;&lt; 18)  </span><span class="comment">/*!&lt; Autoset of Urgent flag on forwarded Urgent messages set globally */</span><span class="preprocessor"></span></div><div class="line"><a name="l00567"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">  567</a></span>&#160;<span class="preprocessor">#define ERROR_LOCK_PATH  -100</span></div><div class="line"><a name="l00568"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae5b8df477c0090cd6966ff1a60907a09">  568</a></span>&#160;<span class="preprocessor">#define ERROR_MAX_MSGS   -101</span></div><div class="line"><a name="l00569"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">  569</a></span>&#160;<span class="preprocessor">#define OPERATOR_EXIT     300</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div><div class="line"><a name="l00571"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64">  571</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64">vm_box</a> {</div><div class="line"><a name="l00572"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">  572</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> =      0,</div><div class="line"><a name="l00573"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">  573</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a> =      1,</div><div class="line"><a name="l00574"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64ae4c30257a35e061da61e8d4e8e8f9169">  574</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64ae4c30257a35e061da61e8d4e8e8f9169">WORK_FOLDER</a> =     2,</div><div class="line"><a name="l00575"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64acc9384c009ceb460c1acdc3b680683bd">  575</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64acc9384c009ceb460c1acdc3b680683bd">FAMILY_FOLDER</a> =      3,</div><div class="line"><a name="l00576"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a3009ee50d2975ad7932cb6e7f610e64f">  576</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a3009ee50d2975ad7932cb6e7f610e64f">FRIENDS_FOLDER</a> =  4,</div><div class="line"><a name="l00577"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">  577</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a> =   -1</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;};</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div><div class="line"><a name="l00580"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849e">  580</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849e">vm_option_flags</a> {</div><div class="line"><a name="l00581"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">  581</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a> =           (1 &lt;&lt; 0),</div><div class="line"><a name="l00582"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">  582</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a> =    (1 &lt;&lt; 1),</div><div class="line"><a name="l00583"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559">  583</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a> = (1 &lt;&lt; 2),</div><div class="line"><a name="l00584"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd">  584</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a> =       (1 &lt;&lt; 3),</div><div class="line"><a name="l00585"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01">  585</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a> =  (1 &lt;&lt; 4),</div><div class="line"><a name="l00586"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae46e13cc6d4a1bfd34b1a4a939cf64f3">  586</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a> =         (1 &lt;&lt; 6),</div><div class="line"><a name="l00587"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">  587</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a> =         (1 &lt;&lt; 7),</div><div class="line"><a name="l00588"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0">  588</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a> =   (1 &lt;&lt; 8),</div><div class="line"><a name="l00589"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce">  589</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a> = (1 &lt;&lt; 9),</div><div class="line"><a name="l00590"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea839b6e6f240aa580e222e9a21bcea333">  590</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea839b6e6f240aa580e222e9a21bcea333">OPT_EARLYM_GREETING</a> =  (1 &lt;&lt; 10),</div><div class="line"><a name="l00591"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea53daa71cf2e363ddf352934ca66b60ee">  591</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea53daa71cf2e363ddf352934ca66b60ee">OPT_BEEP</a> =             (1 &lt;&lt; 11)</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;};</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1">  594</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1">vm_option_args</a> {</div><div class="line"><a name="l00595"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d">  595</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a> = 0,</div><div class="line"><a name="l00596"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ab3c235d8800fef13d32bda9908cb0599">  596</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a> = 1,</div><div class="line"><a name="l00597"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1af287dd95d8f656a0423cc51f3f63e1c5">  597</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1af287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a>   = 2,</div><div class="line"><a name="l00598"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ace0cd0142789f22dc002e491bba8db66">  598</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ace0cd0142789f22dc002e491bba8db66">OPT_ARG_BEEP_TONE</a>  = 3,</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;   <span class="comment">/* This *must* be the last value in this enum! */</span></div><div class="line"><a name="l00600"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1aec7326f60e7edad15d96ff935e5616d6">  600</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a> = 4,</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;};</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53">  603</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53">vm_passwordlocation</a> {</div><div class="line"><a name="l00604"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">  604</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">OPT_PWLOC_VOICEMAILCONF</a> = 0,</div><div class="line"><a name="l00605"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">  605</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>      = 1,</div><div class="line"><a name="l00606"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53a4ea71034662c0e0c184ccfbd68c9e519">  606</a></span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53a4ea71034662c0e0c184ccfbd68c9e519">OPT_PWLOC_USERSCONF</a>     = 2,</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;};</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a520a3c6b7d57903d9a616051da1a019d">AST_APP_OPTIONS</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a59fa4e60d6824425c6874fa59b1dd56a">vm_app_options</a>, {</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;s&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>),</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;b&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a>),</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;u&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a>),</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a7549377df87038be737e8cae73acaa9d">AST_APP_OPTION_ARG</a>(<span class="charliteral">&#39;g&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a>),</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a7549377df87038be737e8cae73acaa9d">AST_APP_OPTION_ARG</a>(<span class="charliteral">&#39;d&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1af287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a>),</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;p&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a>),</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a7549377df87038be737e8cae73acaa9d">AST_APP_OPTION_ARG</a>(<span class="charliteral">&#39;a&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a>),</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;U&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a>),</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;P&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a>),</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a>(<span class="charliteral">&#39;e&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea839b6e6f240aa580e222e9a21bcea333">OPT_EARLYM_GREETING</a>),</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a7549377df87038be737e8cae73acaa9d">AST_APP_OPTION_ARG</a>(<span class="charliteral">&#39;t&#39;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea53daa71cf2e363ddf352934ca66b60ee">OPT_BEEP</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ace0cd0142789f22dc002e491bba8db66">OPT_ARG_BEEP_TONE</a>)</div><div class="line"><a name="l00621"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a59fa4e60d6824425c6874fa59b1dd56a">  621</a></span>&#160;});</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aed86dceeb81c5f7d7d9ed8435651d0b1">  623</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aed86dceeb81c5f7d7d9ed8435651d0b1">mailbox_folders</a>[] = {</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;   imapfolder,</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;   <span class="stringliteral">&quot;INBOX&quot;</span>,</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;   <span class="stringliteral">&quot;Old&quot;</span>,</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;   <span class="stringliteral">&quot;Work&quot;</span>,</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;   <span class="stringliteral">&quot;Family&quot;</span>,</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;   <span class="stringliteral">&quot;Friends&quot;</span>,</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;   <span class="stringliteral">&quot;Cust1&quot;</span>,</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;   <span class="stringliteral">&quot;Cust2&quot;</span>,</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;   <span class="stringliteral">&quot;Cust3&quot;</span>,</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;   <span class="stringliteral">&quot;Cust4&quot;</span>,</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;   <span class="stringliteral">&quot;Cust5&quot;</span>,</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;   <span class="stringliteral">&quot;Deleted&quot;</span>,</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;   <span class="stringliteral">&quot;Urgent&quot;</span>,</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;};</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(<span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>);</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e97699b892f61cc208de9f991cfb293">load_config_from_memory</a>(<span class="keywordtype">int</span> reload, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *ucfg);</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98a361868421e789787246003ce2844f">actual_load_config</a>(<span class="keywordtype">int</span> reload, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *ucfg);</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment">/*! \page vmlang Voicemail Language Syntaxes Supported</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="comment">   \par Syntaxes supported, not really language codes.</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="comment">   \arg \b en    - English</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">   \arg \b de    - German</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment">   \arg \b es    - Spanish</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="comment">   \arg \b fr    - French</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="comment">   \arg \b it    - Italian</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="comment">   \arg \b nl    - Dutch</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="comment">   \arg \b pt    - Portuguese</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment">   \arg \b pt_BR - Portuguese (Brazil)</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">   \arg \b gr    - Greek</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment">   \arg \b no    - Norwegian</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="comment">   \arg \b se    - Swedish</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">   \arg \b tw    - Chinese (Taiwan)</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">   \arg \b ua - Ukrainian</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment">German requires the following additional soundfile:</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="comment">\arg \b 1F  einE (feminine)</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment">Spanish requires the following additional soundfile:</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment">\arg \b 1M      un (masculine)</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="comment">Dutch, Portuguese &amp; Spanish require the following additional soundfiles:</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">\arg \b vm-INBOXs singular of &#39;new&#39;</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">\arg \b vm-Olds      singular of &#39;old/heard/read&#39;</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">NB these are plural:</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">\arg \b vm-INBOX  nieuwe (nl)</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">\arg \b vm-Old    oude (nl)</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="comment">Polish uses:</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="comment">\arg \b vm-new-a  &#39;new&#39;, feminine singular accusative</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment">\arg \b vm-new-e  &#39;new&#39;, feminine plural accusative</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">\arg \b vm-new-ych   &#39;new&#39;, feminine plural genitive</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">\arg \b vm-old-a  &#39;old&#39;, feminine singular accusative</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">\arg \b vm-old-e  &#39;old&#39;, feminine plural accusative</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="comment">\arg \b vm-old-ych   &#39;old&#39;, feminine plural genitive</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="comment">\arg \b digits/1-a   &#39;one&#39;, not always same as &#39;digits/1&#39;</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="comment">\arg \b digits/2-ie  &#39;two&#39;, not always same as &#39;digits/2&#39;</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="comment">Swedish uses:</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="comment">\arg \b vm-nytt      singular of &#39;new&#39;</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment">\arg \b vm-nya    plural of &#39;new&#39;</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment">\arg \b vm-gammalt   singular of &#39;old&#39;</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">\arg \b vm-gamla  plural of &#39;old&#39;</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="comment">\arg \b digits/ett   &#39;one&#39;, not always same as &#39;digits/1&#39;</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="comment">Norwegian uses:</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="comment">\arg \b vm-ny     singular of &#39;new&#39;</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="comment">\arg \b vm-nye    plural of &#39;new&#39;</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="comment">\arg \b vm-gammel singular of &#39;old&#39;</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="comment">\arg \b vm-gamle  plural of &#39;old&#39;</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="comment">Dutch also uses:</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment">\arg \b nl-om     &#39;at&#39;?</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="comment">Spanish also uses:</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment">\arg \b vm-youhaveno</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="comment">Italian requires the following additional soundfile:</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="comment">For vm_intro_it:</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">\arg \b vm-nuovo  new</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">\arg \b vm-nuovi  new plural</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment">\arg \b vm-vecchio   old</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">\arg \b vm-vecchi old plural</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment">Japanese requires the following additional soundfile:</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">\arg \b jp-arimasu          there is</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">\arg \b jp-arimasen         there is not</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment">\arg \b jp-oshitekudasai    please press</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">\arg \b jp-ni               article ni</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment">\arg \b jp-ga               article ga</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment">\arg \b jp-wa               article wa</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">\arg \b jp-wo               article wo</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="comment">Chinese (Taiwan) requires the following additional soundfile:</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="comment">\arg \b vm-tong      A class-word for call (tong1)</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="comment">\arg \b vm-ri     A class-word for day (ri4)</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="comment">\arg \b vm-you    You (ni3)</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="comment">\arg \b vm-haveno   Have no (mei2 you3)</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="comment">\arg \b vm-have     Have (you3)</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="comment">\arg \b vm-listen   To listen (yao4 ting1)</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="comment">\note Don&#39;t use vm-INBOX or vm-Old, because they are the name of the INBOX and Old folders,</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="comment">spelled among others when you have to change folder. For the above reasons, vm-INBOX</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="comment">and vm-Old are spelled plural, to make them sound more as folder name than an adjective.</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div><div class="line"><a name="l00740"></a><span class="lineno"><a class="line" href="../../d5/d11/structbaseio.html">  740</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d5/d11/structbaseio.html">baseio</a> {</div><div class="line"><a name="l00741"></a><span class="lineno"><a class="line" href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">  741</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a>;</div><div class="line"><a name="l00742"></a><span class="lineno"><a class="line" href="../../d5/d11/structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">  742</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d5/d11/structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">iolen</a>;</div><div class="line"><a name="l00743"></a><span class="lineno"><a class="line" href="../../d5/d11/structbaseio.html#a4cd390d771f962d39585708c848317e5">  743</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d5/d11/structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a>;</div><div class="line"><a name="l00744"></a><span class="lineno"><a class="line" href="../../d5/d11/structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">  744</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d5/d11/structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">ateof</a>;</div><div class="line"><a name="l00745"></a><span class="lineno"><a class="line" href="../../d5/d11/structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">  745</a></span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iobuf[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>];</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;};</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div><div class="line"><a name="l00748"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa70bd2af552395335edf781d889e7d75">  748</a></span>&#160;<span class="preprocessor">#define MAX_VM_MBOX_ID_LEN (AST_MAX_EXTENSION)</span></div><div class="line"><a name="l00749"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0ae670a01db4e441f800b0831c5df5cc">  749</a></span>&#160;<span class="preprocessor">#define MAX_VM_CONTEXT_LEN (AST_MAX_CONTEXT)</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment">/* MAX_VM_MAILBOX_LEN allows enough room for the &#39;@&#39; and NULL terminator */</span></div><div class="line"><a name="l00751"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">  751</a></span>&#160;<span class="preprocessor">#define MAX_VM_MAILBOX_LEN (MAX_VM_MBOX_ID_LEN + MAX_VM_CONTEXT_LEN)</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">/*! Structure for linked list of users</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="comment"> * Use ast_vm_user_destroy() to free one of these structures. */</span></div><div class="line"><a name="l00755"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html">  755</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> {</div><div class="line"><a name="l00756"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">  756</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0ae670a01db4e441f800b0831c5df5cc">MAX_VM_CONTEXT_LEN</a>];<span class="comment">/*!&lt; Voicemail context */</span></div><div class="line"><a name="l00757"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">  757</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aa70bd2af552395335edf781d889e7d75">MAX_VM_MBOX_ID_LEN</a>];<span class="comment">/*!&lt; Mailbox id, unique within vm context */</span></div><div class="line"><a name="l00758"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">  758</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>[80];               <span class="comment">/*!&lt; Secret pin code, numbers only */</span></div><div class="line"><a name="l00759"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">  759</a></span>&#160;   <span class="keywordtype">char</span> fullname[80];               <span class="comment">/*!&lt; Full name, for directory app */</span></div><div class="line"><a name="l00760"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">  760</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>;                     <span class="comment">/*!&lt; E-mail address */</span></div><div class="line"><a name="l00761"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">  761</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>;              <span class="comment">/*!&lt; E-mail subject */</span></div><div class="line"><a name="l00762"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">  762</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>;                 <span class="comment">/*!&lt; E-mail body */</span></div><div class="line"><a name="l00763"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">  763</a></span>&#160;   <span class="keywordtype">char</span> pager[80];                  <span class="comment">/*!&lt; E-mail address to pager (no attachment) */</span></div><div class="line"><a name="l00764"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">  764</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>[80];            <span class="comment">/*!&lt; From: Mail address */</span></div><div class="line"><a name="l00765"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">  765</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>[100];            <span class="comment">/*!&lt; From: Username */</span></div><div class="line"><a name="l00766"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">  766</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../da/d45/chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>[<a class="code" href="../../d5/d7b/channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>];     <span class="comment">/*!&lt; Config: Language setting */</span></div><div class="line"><a name="l00767"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">  767</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>[80];                <span class="comment">/*!&lt; Time zone */</span></div><div class="line"><a name="l00768"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">  768</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>[20];                 <span class="comment">/*!&lt; The locale (for presentation of date/time) */</span></div><div class="line"><a name="l00769"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">  769</a></span>&#160;   <span class="keywordtype">char</span> callback[80];</div><div class="line"><a name="l00770"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">  770</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>[80];</div><div class="line"><a name="l00771"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">  771</a></span>&#160;   <span class="keywordtype">char</span> uniqueid[80];               <span class="comment">/*!&lt; Unique integer identifier */</span></div><div class="line"><a name="l00772"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">  772</a></span>&#160;   <span class="keywordtype">char</span> exit[80];</div><div class="line"><a name="l00773"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">  773</a></span>&#160;   <span class="keywordtype">char</span> attachfmt[20];              <span class="comment">/*!&lt; Attachment format */</span></div><div class="line"><a name="l00774"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#ac92588540e8c1d014a08cd8a45462b19">  774</a></span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;              <span class="comment">/*!&lt; VM_ flags */</span></div><div class="line"><a name="l00775"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">  775</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a>;</div><div class="line"><a name="l00776"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">  776</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a>;                     <span class="comment">/*!&lt; Minimum number of seconds per message for this mailbox */</span></div><div class="line"><a name="l00777"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">  777</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>;                      <span class="comment">/*!&lt; Maximum number of msgs per folder for this mailbox */</span></div><div class="line"><a name="l00778"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">  778</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>;               <span class="comment">/*!&lt; Maximum number of deleted msgs saved for this mailbox */</span></div><div class="line"><a name="l00779"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">  779</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>;                     <span class="comment">/*!&lt; Maximum number of seconds per message for this mailbox */</span></div><div class="line"><a name="l00780"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">  780</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a>;            <span class="comment">/*!&lt; Storage location of the password */</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;   <span class="keywordtype">char</span> imapserver[48];             <span class="comment">/*!&lt; IMAP server address */</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;   <span class="keywordtype">char</span> imapport[8];                <span class="comment">/*!&lt; IMAP server port */</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;   <span class="keywordtype">char</span> imapflags[128];             <span class="comment">/*!&lt; IMAP optional flags */</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;   <span class="keywordtype">char</span> imapuser[80];               <span class="comment">/*!&lt; IMAP server login */</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;   <span class="keywordtype">char</span> imappassword[80];           <span class="comment">/*!&lt; IMAP server password if authpassword not defined */</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;   <span class="keywordtype">char</span> imapfolder[64];             <span class="comment">/*!&lt; IMAP voicemail folder */</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;   <span class="keywordtype">char</span> imapvmshareid[80];          <span class="comment">/*!&lt; Shared mailbox ID to use rather than the dialed one */</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;   <span class="keywordtype">int</span> imapversion;                 <span class="comment">/*!&lt; If configuration changes, use the new values */</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00791"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">  791</a></span>&#160;   <span class="keywordtype">double</span> <a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>;                  <span class="comment">/*!&lt; Volume gain for voicemails sent via email */</span></div><div class="line"><a name="l00792"></a><span class="lineno"><a class="line" href="../../da/df6/structast__vm__user.html#ae70209f686c12c7d2fd0c952c9b80587">  792</a></span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7">AST_LIST_ENTRY</a>(<a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a>) list;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;};</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="comment">/*! Voicemail time zones */</span></div><div class="line"><a name="l00796"></a><span class="lineno"><a class="line" href="../../d7/d13/structvm__zone.html">  796</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> {</div><div class="line"><a name="l00797"></a><span class="lineno"><a class="line" href="../../d7/d13/structvm__zone.html#a964e6a050e06dd03632bca724fc9d6a0">  797</a></span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7">AST_LIST_ENTRY</a>(<a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a>) list;</div><div class="line"><a name="l00798"></a><span class="lineno"><a class="line" href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">  798</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>[80];</div><div class="line"><a name="l00799"></a><span class="lineno"><a class="line" href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">  799</a></span>&#160;   <span class="keywordtype">char</span> timezone[80];</div><div class="line"><a name="l00800"></a><span class="lineno"><a class="line" href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">  800</a></span>&#160;   <span class="keywordtype">char</span> msg_format[512];</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;};</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div><div class="line"><a name="l00803"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a120b9c8ba5c2f37645d9d3683655e9f9">  803</a></span>&#160;<span class="preprocessor">#define VMSTATE_MAX_MSG_ARRAY 256</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="comment">/*! Voicemail mailbox state */</span></div><div class="line"><a name="l00806"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html">  806</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> {</div><div class="line"><a name="l00807"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">  807</a></span>&#160;   <span class="keywordtype">char</span> curbox[80];</div><div class="line"><a name="l00808"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">  808</a></span>&#160;   <span class="keywordtype">char</span> username[80];</div><div class="line"><a name="l00809"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">  809</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[80];</div><div class="line"><a name="l00810"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">  810</a></span>&#160;   <span class="keywordtype">char</span> curdir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l00811"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">  811</a></span>&#160;   <span class="keywordtype">char</span> vmbox[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l00812"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">  812</a></span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l00813"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a6df2b4baa52e93571c0ac57d7f318de5">  813</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d27/res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">intro</a>[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l00814"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">  814</a></span>&#160;   <span class="keywordtype">int</span> *<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>;</div><div class="line"><a name="l00815"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">  815</a></span>&#160;   <span class="keywordtype">int</span> *<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>;</div><div class="line"><a name="l00816"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">  816</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">dh_arraysize</a>; <span class="comment">/* used for deleted / heard allocation */</span></div><div class="line"><a name="l00817"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">  817</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;</div><div class="line"><a name="l00818"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">  818</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;</div><div class="line"><a name="l00819"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">  819</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;</div><div class="line"><a name="l00820"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">  820</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;</div><div class="line"><a name="l00821"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">  821</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>;</div><div class="line"><a name="l00822"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">  822</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>;</div><div class="line"><a name="l00823"></a><span class="lineno"><a class="line" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">  823</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a>;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;   <a class="code" href="../../d8/dc5/structast__mutex__info.html">ast_mutex_t</a> <a class="code" href="../../df/d44/app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;   <span class="keywordtype">int</span> updated;                         <span class="comment">/*!&lt; decremented on each mail check until 1 -allows delay */</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;   <span class="keywordtype">long</span> *msgArray;</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;   <span class="keywordtype">unsigned</span> msg_array_max;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;   MAILSTREAM *mailstream;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;   <span class="keywordtype">int</span> vmArrayIndex;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;   <span class="keywordtype">char</span> imapuser[80];                   <span class="comment">/*!&lt; IMAP server login */</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;   <span class="keywordtype">char</span> imapfolder[64];                 <span class="comment">/*!&lt; IMAP voicemail folder */</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;   <span class="keywordtype">char</span> imapserver[48];                 <span class="comment">/*!&lt; IMAP server address */</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;   <span class="keywordtype">char</span> imapport[8];                    <span class="comment">/*!&lt; IMAP server port */</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;   <span class="keywordtype">char</span> imapflags[128];                 <span class="comment">/*!&lt; IMAP optional flags */</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;   <span class="keywordtype">int</span> imapversion;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;   <span class="keywordtype">int</span> interactive;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;   <span class="keywordtype">char</span> introfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];              <span class="comment">/*!&lt; Name of prepended file */</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> quota_limit;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> quota_usage;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *persist_vms;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;};</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> odbc_database[80] = <span class="stringliteral">&quot;asterisk&quot;</span>;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> odbc_table[80] = <span class="stringliteral">&quot;voicemessages&quot;</span>;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="preprocessor">#define RETRIEVE(a,b,c,d) retrieve_file(a,b)</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="preprocessor">#define DISPOSE(a,b) remove_file(a,b)</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="preprocessor">#define STORE(a,b,c,d,e,f,g,h,i,j,k) store_file(a,b,c,d)</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="preprocessor">#define EXISTS(a,b,c,d) (message_exists(a,b))</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="preprocessor">#define RENAME(a,b,c,d,e,f,g,h) (rename_file(a,b,c,d,e,f))</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="preprocessor">#define COPY(a,b,c,d,e,f,g,h) (copy_file(a,b,c,d,e,f))</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="preprocessor">#define DELETE(a,b,c,d) (delete_file(a,b))</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="preprocessor">#define UPDATE_MSG_ID(a, b, c, d, e, f) (odbc_update_msg_id((a), (b), (c)))</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="preprocessor">#define DISPOSE(a,b) (imap_remove_file(a,b))</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="preprocessor">#define STORE(a,b,c,d,e,f,g,h,i,j,k) (imap_store_file(a,b,c,d,e,f,g,h,i,j,k))</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="preprocessor">#define RETRIEVE(a,b,c,d) imap_retrieve_file(a,b,c,d)</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="preprocessor">#define EXISTS(a,b,c,d) (ast_fileexists(c,NULL,d) &gt; 0)</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="preprocessor">#define RENAME(a,b,c,d,e,f,g,h) (rename_file(g,h));</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="preprocessor">#define COPY(a,b,c,d,e,f,g,h) (copy_file(g,h));</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="preprocessor">#define DELETE(a,b,c,d) (vm_imap_delete(a,b,d))</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="preprocessor">#define UPDATE_MSG_ID(a, b, c, d, e, f) (vm_imap_update_msg_id((a), (b), (c), (d), (e), (f)))</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00867"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">  867</a></span>&#160;<span class="preprocessor">#define RETRIEVE(a,b,c,d)</span></div><div class="line"><a name="l00868"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">  868</a></span>&#160;<span class="preprocessor">#define DISPOSE(a,b)</span></div><div class="line"><a name="l00869"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">  869</a></span>&#160;<span class="preprocessor">#define STORE(a,b,c,d,e,f,g,h,i,j,k)</span></div><div class="line"><a name="l00870"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">  870</a></span>&#160;<span class="preprocessor">#define EXISTS(a,b,c,d) (ast_fileexists(c,NULL,d) &gt; 0)</span></div><div class="line"><a name="l00871"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">  871</a></span>&#160;<span class="preprocessor">#define RENAME(a,b,c,d,e,f,g,h) (rename_file(g,h));</span></div><div class="line"><a name="l00872"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">  872</a></span>&#160;<span class="preprocessor">#define COPY(a,b,c,d,e,f,g,h) (copy_plain_file(g,h));</span></div><div class="line"><a name="l00873"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">  873</a></span>&#160;<span class="preprocessor">#define DELETE(a,b,c,d) (vm_delete(c))</span></div><div class="line"><a name="l00874"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a368cc0cb8f1c6fa742a6c6741ceb874e">  874</a></span>&#160;<span class="preprocessor">#define UPDATE_MSG_ID(a, b, c, d, e, f)</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div><div class="line"><a name="l00878"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">  878</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">  880</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>[128];</div><div class="line"><a name="l00881"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">  881</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>[128];</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div><div class="line"><a name="l00883"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">  883</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a>;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;</div><div class="line"><a name="l00885"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">  885</a></span>&#160;<span class="preprocessor">#define PWDCHANGE_INTERNAL (1 &lt;&lt; 1)</span></div><div class="line"><a name="l00886"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">  886</a></span>&#160;<span class="preprocessor">#define PWDCHANGE_EXTERNAL (1 &lt;&lt; 2)</span></div><div class="line"><a name="l00887"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">  887</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="preprocessor">#define tdesc &quot;Comedian Mail (Voicemail System) with ODBC Storage&quot;</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="preprocessor"># ifdef IMAP_STORAGE</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="preprocessor"># define tdesc &quot;Comedian Mail (Voicemail System) with IMAP Storage&quot;</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="preprocessor"># else</span></div><div class="line"><a name="l00895"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">  895</a></span>&#160;<span class="preprocessor"># define tdesc &quot;Comedian Mail (Voicemail System)&quot;</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div><div class="line"><a name="l00899"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">  899</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>[<a class="code" href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div><div class="line"><a name="l00901"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#addcd618c70c26637518d590003c700c2">  901</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#addcd618c70c26637518d590003c700c2">addesc</a> = <span class="stringliteral">&quot;Comedian Mail&quot;</span>;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="comment">/* Leave a message */</span></div><div class="line"><a name="l00904"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a59fdcd2fc4d13afb01e0b1faca7681f5">  904</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a59fdcd2fc4d13afb01e0b1faca7681f5">voicemail_app</a> = <span class="stringliteral">&quot;VoiceMail&quot;</span>;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="comment">/* Check mail, control, etc */</span></div><div class="line"><a name="l00907"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af836feb1d14b54d1ae124391b455426c">  907</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#af836feb1d14b54d1ae124391b455426c">voicemailmain_app</a> = <span class="stringliteral">&quot;VoiceMailMain&quot;</span>;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div><div class="line"><a name="l00909"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af29953afabaf5ed5338cb9a783599366">  909</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#af29953afabaf5ed5338cb9a783599366">vmauthenticate_app</a> = <span class="stringliteral">&quot;VMAuthenticate&quot;</span>;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;</div><div class="line"><a name="l00911"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5ab1eccc691707a65a8dcf627ae9e4b9">  911</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5ab1eccc691707a65a8dcf627ae9e4b9">playmsg_app</a> = <span class="stringliteral">&quot;VoiceMailPlayMsg&quot;</span>;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;</div><div class="line"><a name="l00913"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8d6ccf778afc7f44f12085c8c1b64c75">  913</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a8d6ccf778afc7f44f12085c8c1b64c75">sayname_app</a> = <span class="stringliteral">&quot;VMSayName&quot;</span>;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;</div><div class="line"><a name="l00915"></a><span class="lineno"><a class="line" href="../../d8/d63/structusers.html#adf04f66344e3fb0a6f6a69bf39d19902">  915</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b">AST_LIST_HEAD_STATIC</a>(<a class="code" href="../../d8/d63/structusers.html">users</a>, <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a>);</div><div class="line"><a name="l00916"></a><span class="lineno"><a class="line" href="../../d5/dd3/structzones.html#adf04f66344e3fb0a6f6a69bf39d19902">  916</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b">AST_LIST_HEAD_STATIC</a>(<a class="code" href="../../d5/dd3/structzones.html">zones</a>, <a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a>);</div><div class="line"><a name="l00917"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">  917</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>[80];</div><div class="line"><a name="l00918"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad4786cc0738d237b7697e5448da7d22e">  918</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>[20];</div><div class="line"><a name="l00919"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">  919</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>;</div><div class="line"><a name="l00920"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">  920</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l00921"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">  921</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>;</div><div class="line"><a name="l00922"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">  922</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a> = 128;</div><div class="line"><a name="l00923"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">  923</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>[80] = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e790f0ee1dbde79705c49bf33a1060d">ASTERISK_USERNAME</a>;</div><div class="line"><a name="l00924"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">  924</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>[160] = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a92d8fb2d08cf9220d520ae9691b5e6c4">SENDMAIL</a>;   <span class="comment">/* Configurable mail cmd */</span></div><div class="line"><a name="l00925"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">  925</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>[160];</div><div class="line"><a name="l00926"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">  926</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d8/d32/structast__smdi__interface.html">ast_smdi_interface</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l00927"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">  927</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>[80] = <span class="stringliteral">&quot;wav&quot;</span>;</div><div class="line"><a name="l00928"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">  928</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>;</div><div class="line"><a name="l00929"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">  929</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>;</div><div class="line"><a name="l00930"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">  930</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>;</div><div class="line"><a name="l00931"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">  931</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>;</div><div class="line"><a name="l00932"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">  932</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a> = 3000;</div><div class="line"><a name="l00933"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">  933</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">maxlogins</a> = 3;</div><div class="line"><a name="l00934"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">  934</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aca7150caac3749421acc40d7bc3483f1">MINPASSWORD</a>;</div><div class="line"><a name="l00935"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a54d82ca3eb6fd49d52dfb684e64a6c23">  935</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a>;</div><div class="line"><a name="l00936"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6e510ae693179f025e8850a7e4963a3a">  936</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e510ae693179f025e8850a7e4963a3a">aliasescontext</a>[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0ae670a01db4e441f800b0831c5df5cc">MAX_VM_CONTEXT_LEN</a>];</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="comment">/*! Poll mailboxes for changes since there is something external to</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="comment"> *  app_voicemail that may change them. */</span></div><div class="line"><a name="l00940"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">  940</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a>;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">/*! By default, poll every 30 seconds */</span></div><div class="line"><a name="l00943"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">  943</a></span>&#160;<span class="preprocessor">#define DEFAULT_POLL_FREQ 30</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="comment">/*! Polling frequency */</span></div><div class="line"><a name="l00945"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">  945</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">DEFAULT_POLL_FREQ</a>;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div><div class="line"><a name="l00947"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">  947</a></span>&#160;<a class="code" href="../../dd/d42/lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a>);</div><div class="line"><a name="l00948"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">  948</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../dd/d42/lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">poll_cond</a> = PTHREAD_COND_INITIALIZER;</div><div class="line"><a name="l00949"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">  949</a></span>&#160;<span class="keyword">static</span> pthread_t <a class="code" href="../../dc/df4/app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a> = <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;</div><div class="line"><a name="l00950"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">  950</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a>;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;</div><div class="line"><a name="l00952"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">  952</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../db/d17/structast__taskprocessor.html">ast_taskprocessor</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a>;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;</div><div class="line"><a name="l00954"></a><span class="lineno"><a class="line" href="../../de/d16/structalias__mailbox__mapping.html">  954</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> {</div><div class="line"><a name="l00955"></a><span class="lineno"><a class="line" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">  955</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias</a>;</div><div class="line"><a name="l00956"></a><span class="lineno"><a class="line" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">  956</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>;</div><div class="line"><a name="l00957"></a><span class="lineno"><a class="line" href="../../de/d16/structalias__mailbox__mapping.html#a103a957b017f6b717767bba130a02694">  957</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[0];</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;};</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;</div><div class="line"><a name="l00960"></a><span class="lineno"><a class="line" href="../../d0/d11/structmailbox__alias__mapping.html">  960</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d0/d11/structmailbox__alias__mapping.html">mailbox_alias_mapping</a> {</div><div class="line"><a name="l00961"></a><span class="lineno"><a class="line" href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">  961</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">alias</a>;</div><div class="line"><a name="l00962"></a><span class="lineno"><a class="line" href="../../d0/d11/structmailbox__alias__mapping.html#a85bb287786245ade1ab8a939e4dc4723">  962</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>;</div><div class="line"><a name="l00963"></a><span class="lineno"><a class="line" href="../../d0/d11/structmailbox__alias__mapping.html#a103a957b017f6b717767bba130a02694">  963</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[0];</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;};</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div><div class="line"><a name="l00966"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a384d700a5c87a2551e5ee6ed5ab6b548">  966</a></span>&#160;<span class="preprocessor">#define MAPPING_BUCKETS 511</span></div><div class="line"><a name="l00967"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#adb44a2647e8cd26cfb618f4ca0d0d1a7">  967</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d2/da9/structao2__container.html">ao2_container</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#adb44a2647e8cd26cfb618f4ca0d0d1a7">alias_mailbox_mappings</a>;</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e1d84c64a8c41dcd08f8fc64c280b43">AO2_STRING_FIELD_HASH_FN</a>(<a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a>, alias);</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3247e9fdb87c86de8922299cab408461">AO2_STRING_FIELD_CMP_FN</a>(<a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a>, alias);</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div><div class="line"><a name="l00971"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9d1c2464eb2f95034fffe04efdeba7d6">  971</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d2/da9/structao2__container.html">ao2_container</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a9d1c2464eb2f95034fffe04efdeba7d6">mailbox_alias_mappings</a>;</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e1d84c64a8c41dcd08f8fc64c280b43">AO2_STRING_FIELD_HASH_FN</a>(<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html">mailbox_alias_mapping</a>, <a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>);</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3247e9fdb87c86de8922299cab408461">AO2_STRING_FIELD_CMP_FN</a>(<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html">mailbox_alias_mapping</a>, <a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>);</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="comment">/* custom audio control prompts for voicemail playback */</span></div><div class="line"><a name="l00976"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">  976</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a>[12];</div><div class="line"><a name="l00977"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">  977</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a>[12];</div><div class="line"><a name="l00978"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">  978</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a>[12];</div><div class="line"><a name="l00979"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">  979</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a>[12];</div><div class="line"><a name="l00980"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">  980</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a>[12];</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="comment">/* custom password sounds */</span></div><div class="line"><a name="l00983"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3cf5a09db1d2106c64a9bba41797ba69">  983</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3cf5a09db1d2106c64a9bba41797ba69">vm_login</a>[80] = <span class="stringliteral">&quot;vm-login&quot;</span>;</div><div class="line"><a name="l00984"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3f746748b8e841890dd2a684011248f9">  984</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3f746748b8e841890dd2a684011248f9">vm_newuser</a>[80] = <span class="stringliteral">&quot;vm-newuser&quot;</span>;</div><div class="line"><a name="l00985"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">  985</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">vm_password</a>[80] = <span class="stringliteral">&quot;vm-password&quot;</span>;</div><div class="line"><a name="l00986"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">  986</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a>[80] = <span class="stringliteral">&quot;vm-newpassword&quot;</span>;</div><div class="line"><a name="l00987"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">  987</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a>[80] = <span class="stringliteral">&quot;vm-passchanged&quot;</span>;</div><div class="line"><a name="l00988"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">  988</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a>[80] = <span class="stringliteral">&quot;vm-reenterpassword&quot;</span>;</div><div class="line"><a name="l00989"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">  989</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a>[80] = <span class="stringliteral">&quot;vm-mismatch&quot;</span>;</div><div class="line"><a name="l00990"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">  990</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a>[80] = <span class="stringliteral">&quot;vm-invalid-password&quot;</span>;</div><div class="line"><a name="l00991"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">  991</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>[80] = <span class="stringliteral">&quot;vm-pls-try-again&quot;</span>;</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="comment"> * XXX If we have the time, motivation, etc. to fix up this prompt, one of the following would be appropriate:</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment"> * 1. create a sound along the lines of &quot;Please try again.  When done, press the pound key&quot; which could be spliced</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="comment"> * from existing sound clips.  This would require some programming changes in the area of vm_forward options and also</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;<span class="comment"> * app.c&#39;s __ast_play_and_record function</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="comment"> * 2. create a sound prompt saying &quot;Please try again.  When done recording, press any key to stop and send the prepended</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="comment"> * message.&quot;  At the time of this comment, I think this would require new voice work to be commissioned.</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="comment"> * 3. Something way different like providing instructions before a time out or a post-recording menu.  This would require</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="comment"> * more effort than either of the other two.</span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01003"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad39d37394ef9bcd11d7b2cf55f6b08d"> 1003</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad39d37394ef9bcd11d7b2cf55f6b08d">vm_prepend_timeout</a>[80] = <span class="stringliteral">&quot;vm-then-pound&quot;</span>;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;</div><div class="line"><a name="l01005"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86"> 1005</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a> = {0};</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div><div class="line"><a name="l01007"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301"> 1007</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a> = 2;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div><div class="line"><a name="l01009"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a695d5aca89839d016497739454f9779a"> 1009</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>[<a class="code" href="../../d5/d7b/channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l01010"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8"> 1010</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>[<a class="code" href="../../d5/d7b/channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l01011"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda"> 1011</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>[<a class="code" href="../../d5/d7b/channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e"> 1013</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a>][64];</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f"> 1016</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>;</div><div class="line"><a name="l01017"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816"> 1017</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>;</div><div class="line"><a name="l01018"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04"> 1018</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a>;</div><div class="line"><a name="l01019"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc"> 1019</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a>;</div><div class="line"><a name="l01020"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b"> 1020</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>[100];</div><div class="line"><a name="l01021"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5"> 1021</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>[100];</div><div class="line"><a name="l01022"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5"> 1022</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../d1/d6d/chan__unistim_8c.html#a8bd4accafd4e712317ed9a471738a971">charset</a>[32] = <span class="stringliteral">&quot;ISO-8859-1&quot;</span>;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div><div class="line"><a name="l01024"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd"> 1024</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a>[4] = <span class="stringliteral">&quot;\x00\x00\x00\x0F&quot;</span>;</div><div class="line"><a name="l01025"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767"> 1025</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767">adsisec</a>[4] = <span class="stringliteral">&quot;\x9B\xDB\xF7\xAC&quot;</span>;</div><div class="line"><a name="l01026"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37"> 1026</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a> = 1;</div><div class="line"><a name="l01027"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908"> 1027</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>[32] = <span class="stringliteral">&quot;%A, %B %d, %Y at %r&quot;</span>;</div><div class="line"><a name="l01028"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a960c0aad2b4d7e3e2917975674fe3afa"> 1028</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a960c0aad2b4d7e3e2917975674fe3afa">pagerdateformat</a>[32] = <span class="stringliteral">&quot;%A, %B %d, %Y at %r&quot;</span>;</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="comment">/* Forward declarations - generic */</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box);</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu);</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">advanced_options</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msg, <span class="keywordtype">int</span> option, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain);</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *num, <span class="keywordtype">char</span> *outgoing_context);</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *playfile, <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime,</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;         <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> outsidecaller, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> *sound_duration, <span class="keyword">const</span> <span class="keywordtype">char</span> *unlockdir,</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;         <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id, <span class="keywordtype">int</span> forwardintro);</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650">vm_tempgreeting</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain);</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>);</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">notify_new_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>);</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0">make_email_file</a>(FILE *p, <span class="keywordtype">char</span> *srcemail, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *attach2, <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>, <span class="keywordtype">int</span> duration, <span class="keywordtype">int</span> attach_user_voicemail, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keywordtype">int</span> imap, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id);</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d45/test__http__media__cache_8c.html#a80c8e3ae5087d90d422675d034eeebc7">options</a>);</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(FILE *p, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *greeting_attachment, <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keywordtype">char</span> *bound, <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> <a class="code" href="../../df/d44/app__meetme_8c.html#ae9dd6bdb4c5c0529195a03583d0d4a8d">last</a>, <span class="keywordtype">int</span> msgnum);</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *key);</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a27203edbc5e249fcac868c0488271b29">read_password_from_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *secretfn, <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>, <span class="keywordtype">int</span> passwordlen);</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a616064b374d2f44d6fdab04f8509b138">write_password_to_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *secretfn, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>);</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>);</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_ids [], <span class="keywordtype">size_t</span> num_msgs, <span class="keywordtype">int</span> *msg_nums, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu);</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu);</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6850fa64e511b2de06fd2dd36a267883">append_vmu_info_astman</a>(<span class="keyword">struct</span> <a class="code" href="../../d2/d8a/structmansession.html">mansession</a> *s, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span>* event_name, <span class="keyword">const</span> <span class="keywordtype">char</span>* actionid);</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment"> * Place a message in the indicated folder</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="comment"> * \param vmu Voicemail user</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="comment"> * \param vms Current voicemail state for the user</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;<span class="comment"> * \param msg The message number to save</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;<span class="comment"> * \param box The folder into which the message should be saved</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;<span class="comment"> * \param[out] newmsg The new message number of the saved message</span></div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;<span class="comment"> * \param move Tells whether to copy or to move the message</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="comment"> * \note the &quot;move&quot; parameter is only honored for IMAP voicemail presently</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;<span class="comment"> * \retval 0 Success</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="comment"> * \retval other Failure</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msg, <span class="keywordtype">int</span> box, <span class="keywordtype">int</span> *newmsg, <span class="keywordtype">int</span> move);</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae48d2d40fd20f61d2324906383df2d6e">vm_mailbox_snapshot_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keywordtype">int</span> descending, <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491">ast_vm_snapshot_sort_val</a> sort_val, <span class="keywordtype">int</span> combine_INBOX_and_OLD);</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a654bcd2aee84a0c6d2f90e01f9b5acb8">vm_mailbox_snapshot_destroy</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *mailbox_snapshot);</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90b1b36a3d0c11b8b335f20efe172552">vm_msg_forward</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#a4540ed6a1ea3b69a813ff82e0cfb7587">from_mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *from_context, <span class="keyword">const</span> <span class="keywordtype">char</span> *from_folder, <span class="keyword">const</span> <span class="keywordtype">char</span> *to_mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *to_context, <span class="keyword">const</span> <span class="keywordtype">char</span> *to_folder, <span class="keywordtype">size_t</span> num_msgs, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_ids[], <span class="keywordtype">int</span> delete_old);</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aea7a0b8f32697c42dd05115e26a114d8">vm_msg_move</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">size_t</span> num_msgs, <span class="keyword">const</span> <span class="keywordtype">char</span> *oldfolder, <span class="keyword">const</span> <span class="keywordtype">char</span> *old_msg_ids[], <span class="keyword">const</span> <span class="keywordtype">char</span> *newfolder);</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abc03cd67e3d9bff7bde30ff5877c317f">vm_msg_remove</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">size_t</span> num_msgs, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keyword">const</span> <span class="keywordtype">char</span> *msgs[]);</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1a4393102d360b132fa006873ad4435c">vm_msg_play</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_num, <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac0c37deb099c676114ef0032ad449375">ast_vm_msg_play_cb</a> cb);</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a07c88336f106270f57593724e39f0604">vm_test_destroy_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>);</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3dbfac8e2b5d54afabfa52585d42873">vm_test_create_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>);</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="comment"> * \internal</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment"> * \brief Parse the given mailbox_id into mailbox and context.</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="comment"> * \since 12.0.0</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment"> * \param mailbox_id The mailbox@context string to separate.</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="comment"> * \param mailbox Where the mailbox part will start.</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;<span class="comment"> * \param context Where the context part will start.  (&quot;default&quot; if not present)</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="comment"> * \retval 0 on success.</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="comment"> * \retval -1 on error.</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01094"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6"> 1094</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<span class="keywordtype">char</span> *mailbox_id, <span class="keywordtype">char</span> **<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keywordtype">char</span> **<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;{</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_id) || !mailbox || !context) {</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;   }</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;   *context = mailbox_id;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;   *mailbox = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(context, <span class="stringliteral">&quot;@&quot;</span>);</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(*mailbox)) {</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;   }</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(*context)) {</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;      *context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;   }</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;}</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div><div class="line"><a name="l01110"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778"> 1110</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d2/da9/structao2__container.html">ao2_container</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"><a class="line" href="../../de/d24/structinprocess.html"> 1112</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../de/d24/structinprocess.html">inprocess</a> {</div><div class="line"><a name="l01113"></a><span class="lineno"><a class="line" href="../../de/d24/structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf"> 1113</a></span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../de/d24/structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>;</div><div class="line"><a name="l01114"></a><span class="lineno"><a class="line" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895"> 1114</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>;</div><div class="line"><a name="l01115"></a><span class="lineno"><a class="line" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95"> 1115</a></span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>[0];</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;};</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039"> 1118</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039">inprocess_hash_fn</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;{</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;   <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../de/d24/structinprocess.html">inprocess</a> *i = obj;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;   <span class="keywordflow">return</span> atoi(i-&gt;<a class="code" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>);</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;}</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;</div><div class="line"><a name="l01124"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90"> 1124</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90">inprocess_cmp_fn</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;{</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../de/d24/structinprocess.html">inprocess</a> *i = obj, *j = arg;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;   <span class="keywordflow">if</span> (strcmp(i-&gt;<a class="code" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>, j-&gt;mailbox)) {</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;   }</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;   <span class="keywordflow">return</span> !strcmp(i-&gt;<a class="code" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>, j-&gt;context) ? <a class="code" href="../../d5/da5/astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> : 0;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;}</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div><div class="line"><a name="l01133"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c"> 1133</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keywordtype">int</span> delta)</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;{</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;   <span class="keywordtype">int</span> context_len = strlen(context) + 1;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;   <span class="keywordtype">int</span> mailbox_len = strlen(mailbox) + 1;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../de/d24/structinprocess.html">inprocess</a> *i, *arg = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(<span class="keyword">sizeof</span>(*arg) + context_len + mailbox_len);</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;   arg-&gt;<a class="code" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">context</a> = arg-&gt;<a class="code" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a> + mailbox_len;</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(arg-&gt;<a class="code" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>, mailbox, mailbox_len); <span class="comment">/* SAFE */</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(arg-&gt;<a class="code" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>, context, context_len); <span class="comment">/* SAFE */</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#aa9fdb5d0a6157a56060d9f7279fe6c49">ao2_lock</a>(inprocess_container);</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;   <span class="keywordflow">if</span> ((i = <a class="code" href="../../d5/da5/astobj2_8h.html#a911e0703891a9a7aaf73978152092586">ao2_find</a>(inprocess_container, arg, 0))) {</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;      <span class="keywordtype">int</span> ret = <a class="code" href="../../dd/d42/lock_8h.html#a8a3bd496edfec04a95683ace66676200">ast_atomic_fetchadd_int</a>(&amp;i-&gt;<a class="code" href="../../de/d24/structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, delta);</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a9998bd156b936636a8780385e9a910b2">ao2_unlock</a>(inprocess_container);</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(i, -1);</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;   }</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;   <span class="keywordflow">if</span> (delta &lt; 0) {</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;BUG: ref count decrement on non-existing object???\n&quot;</span>);</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;   }</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;   <span class="keywordflow">if</span> (!(i = <a class="code" href="../../d5/da5/astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*i) + context_len + mailbox_len, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a9998bd156b936636a8780385e9a910b2">ao2_unlock</a>(inprocess_container);</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;   }</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;   i-&gt;<a class="code" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">context</a> = i-&gt;<a class="code" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a> + mailbox_len;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(i-&gt;<a class="code" href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>, mailbox, mailbox_len); <span class="comment">/* SAFE */</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(i-&gt;<a class="code" href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>, context, context_len); <span class="comment">/* SAFE */</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;   i-&gt;<a class="code" href="../../de/d24/structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = delta;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a1ad9f122bcae95a470639402faa3d2ee">ao2_link</a>(inprocess_container, i);</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a9998bd156b936636a8780385e9a910b2">ao2_unlock</a>(inprocess_container);</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(i, -1);</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;}</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="preprocessor">#if !(defined(ODBC_STORAGE) || defined(IMAP_STORAGE))</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keywordtype">int</span> shortcircuit);</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="comment"> * \brief Strips control and non 7-bit clean characters from input string.</span></div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="comment"> * \note To map control and none 7-bit characters to a 7-bit clean characters</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="comment"> *  please use ast_str_encode_mine().</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01175"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c"> 1175</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">strip_control_and_high</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input</a>, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>, <span class="keywordtype">size_t</span> buflen)</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;{</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;   <span class="keywordtype">char</span> *bufptr = <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;   <span class="keywordflow">for</span> (; *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input</a>; input++) {</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;      <span class="keywordflow">if</span> (*input &lt; 32) {</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;      }</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;      *bufptr++ = *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input</a>;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      <span class="keywordflow">if</span> (bufptr == buf + buflen - 1) {</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;      }</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;   }</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;   *bufptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;}</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="comment"> * \brief Sets default voicemail system options to a voicemail user.</span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;<span class="comment"> * This applies select global settings to a newly created (dynamic) instance of a voicemail user.</span></div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;<span class="comment"> * - all the globalflags</span></div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;<span class="comment"> * - the saydurationminfo</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;<span class="comment"> * - the callcontext</span></div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;<span class="comment"> * - the dialcontext</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;<span class="comment"> * - the exitcontext</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;<span class="comment"> * - vmmaxsecs, vmmaxmsg, maxdeletedmsg</span></div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;<span class="comment"> * - volume gain.</span></div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<span class="comment"> * - emailsubject, emailbody set to NULL</span></div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01205"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0"> 1205</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;{</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;   <a class="code" href="../../d5/d60/utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(vmu, (&amp;globalflags), <a class="code" href="../../d5/d60/utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a>;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;   <span class="keywordflow">if</span> (saydurationminfo) {</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a>;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;   }</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>, callcontext, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>));</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>, dialcontext, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>));</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, exitcontext, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>));</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, zonetag, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, locale, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>));</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;   <span class="keywordflow">if</span> (vmminsecs) {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>;</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;   }</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;   <span class="keywordflow">if</span> (vmmaxsecs) {</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;   }</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;   <span class="keywordflow">if</span> (maxmsg) {</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;   }</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;   <span class="keywordflow">if</span> (maxdeletedmsg) {</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;   }</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>);</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapfolder, imapfolder, <span class="keyword">sizeof</span>(vmu-&gt;imapfolder));</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapserver, imapserver, <span class="keyword">sizeof</span>(vmu-&gt;imapserver));</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapport, imapport, <span class="keyword">sizeof</span>(vmu-&gt;imapport));</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapflags, imapflags, <span class="keyword">sizeof</span>(vmu-&gt;imapflags));</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;}</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;<span class="comment"> * \brief Sets a specific property value.</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="comment"> * \param vmu The voicemail user object to work with.</span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="comment"> * \param var The name of the property to be set.</span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="comment"> * \param value The value to be set to the property.</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="comment"> * The property name must be one of the understood properties. See the source for details.</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01252"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587"> 1252</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587">apply_option</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>)</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;{</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;attach&quot;</span>)) {</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;attachfmt&quot;</span>)) {</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>));</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;serveremail&quot;</span>)) {</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>));</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;fromstring&quot;</span>)) {</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>));</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;emailbody&quot;</span>)) {</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(value));</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;emailsubject&quot;</span>)) {</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(value));</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;language&quot;</span>)) {</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>));</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;tz&quot;</span>)) {</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;locale&quot;</span>)) {</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>));</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapuser&quot;</span>)) {</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapuser, value, <span class="keyword">sizeof</span>(vmu-&gt;imapuser));</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapserver&quot;</span>)) {</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapserver, value, <span class="keyword">sizeof</span>(vmu-&gt;imapserver));</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapport&quot;</span>)) {</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapport, value, <span class="keyword">sizeof</span>(vmu-&gt;imapport));</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapflags&quot;</span>)) {</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapflags, value, <span class="keyword">sizeof</span>(vmu-&gt;imapflags));</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imappassword&quot;</span>) || !strcasecmp(var, <span class="stringliteral">&quot;imapsecret&quot;</span>)) {</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imappassword, value, <span class="keyword">sizeof</span>(vmu-&gt;imappassword));</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapfolder&quot;</span>)) {</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapfolder, value, <span class="keyword">sizeof</span>(vmu-&gt;imapfolder));</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapvmshareid&quot;</span>)) {</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;imapvmshareid, value, <span class="keyword">sizeof</span>(vmu-&gt;imapvmshareid));</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;      vmu-&gt;imapversion = imapversion;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;delete&quot;</span>) || !strcasecmp(var, <span class="stringliteral">&quot;deletevoicemail&quot;</span>)) {</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>);</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;saycid&quot;</span>)){</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>);</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;sendvoicemail&quot;</span>)){</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>);</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;review&quot;</span>)){</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>);</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;tempgreetwarn&quot;</span>)){</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>);</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;messagewrap&quot;</span>)){</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>);</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;operator&quot;</span>)) {</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>);</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;envelope&quot;</span>)){</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>);</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;moveheard&quot;</span>)){</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>);</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;sayduration&quot;</span>)){</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>);</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;saydurationm&quot;</span>)){</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;      <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a> = x;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min duration for say duration\n&quot;</span>);</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;      }</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;forcename&quot;</span>)){</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>);</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;forcegreetings&quot;</span>)){</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>);</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;callback&quot;</span>)) {</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>));</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;dialout&quot;</span>)) {</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>));</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;exitcontext&quot;</span>)) {</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>));</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;minsecs&quot;</span>)) {</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;      <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1 &amp;&amp; x &gt;= 0) {</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a> = x;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min message length of %s. Using global value %d\n&quot;</span>, value, vmminsecs);</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;      }</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;maxmessage&quot;</span>) || !strcasecmp(var, <span class="stringliteral">&quot;maxsecs&quot;</span>)) {</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = atoi(value);</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;      <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> &lt;= 0) {</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message length of %s. Using global value %d\n&quot;</span>, value, vmmaxsecs);</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = atoi(value);</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;      }</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;maxmessage&quot;</span>))</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Option &#39;maxmessage&#39; has been deprecated in favor of &#39;maxsecs&#39;.  Please make that change in your voicemail config.\n&quot;</span>);</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;maxmsg&quot;</span>)) {</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = atoi(value);</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      <span class="comment">/* Accept maxmsg=0 (Greetings only voicemail) */</span></div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;      <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &lt; 0) {</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages per folder maxmsg=%s. Using default value %d\n&quot;</span>, value, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &gt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of messages per folder is %d. Cannot accept value maxmsg=%s\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, value);</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;      }</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;nextaftercmd&quot;</span>)) {</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>);</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;backupdeleted&quot;</span>)) {</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;      <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1)</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = x;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(value))</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = 0;</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;      <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> &lt; 0) {</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of deleted messages saved per mailbox backupdeleted=%s. Using default value %d\n&quot;</span>, value, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> &gt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of deleted messages saved per mailbox is %d. Cannot accept value backupdeleted=%s\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, value);</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;      }</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;volgain&quot;</span>)) {</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;      sscanf(value, <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>);</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;passwordlocation&quot;</span>)) {</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(value, <span class="stringliteral">&quot;spooldir&quot;</span>)) {</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">OPT_PWLOC_VOICEMAILCONF</a>;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;      }</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;options&quot;</span>)) {</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a>(vmu, value);</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;   }</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;}</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;</div><div class="line"><a name="l01391"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f"> 1391</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f">vm_check_password_shell</a>(<span class="keywordtype">char</span> *command, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;{</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;   <span class="keywordtype">int</span> fds[2], pid = 0;</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;   memset(buf, 0, len);</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;   <span class="keywordflow">if</span> (pipe(fds)) {</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;      snprintf(buf, len, <span class="stringliteral">&quot;FAILURE: Pipe failed: %s&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;      <span class="comment">/* good to go*/</span></div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;      pid = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0">ast_safe_fork</a>(0);</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;      <span class="keywordflow">if</span> (pid &lt; 0) {</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;         <span class="comment">/* ok maybe not */</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;         close(fds[0]);</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;         close(fds[1]);</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;         snprintf(buf, len, <span class="stringliteral">&quot;FAILURE: Fork failed&quot;</span>);</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid) {</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;         <span class="comment">/* parent */</span></div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;         close(fds[1]);</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;         <span class="keywordflow">if</span> (read(fds[0], buf, len) &lt; 0) {</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;read() failed: %s\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;         }</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;         close(fds[0]);</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;         <span class="comment">/*  child */</span></div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2">AST_DECLARE_APP_ARGS</a>(arg,</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;            <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(v)[20];</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;         );</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;         <span class="keywordtype">char</span> *mycmd = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(command);</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;         close(fds[0]);</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;         dup2(fds[1], STDOUT_FILENO);</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;         close(fds[1]);</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97">ast_close_fds_above_n</a>(STDOUT_FILENO);</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#accfcb380df76a64251d88ef49c2dd4e3">AST_NONSTANDARD_APP_ARGS</a>(arg, mycmd, <span class="charliteral">&#39; &#39;</span>);</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;         execv(arg.v[0], arg.v);</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;         printf(<span class="stringliteral">&quot;FAILURE: %s&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;         _exit(0);</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;      }</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;   }</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;}</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;<span class="comment"> * \brief Check that password meets minimum required length</span></div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;<span class="comment"> * \param vmu The voicemail user to change the password for.</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;<span class="comment"> * \param password The password string to check</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;<span class="comment"> * \return zero on ok, 1 on not ok.</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01444"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc"> 1444</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc">check_password</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>)</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;{</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;   <span class="comment">/* check minimum length */</span></div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;   <span class="keywordflow">if</span> (strlen(password) &lt; minpassword)</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;   <span class="comment">/* check that password does not contain &#39;*&#39; character */</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(password) &amp;&amp; password[0] == <span class="charliteral">&#39;*&#39;</span>)</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(ext_pass_check_cmd)) {</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;      <span class="keywordtype">char</span> cmd[255], <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[255];</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Verify password policies for %s\n&quot;</span>, password);</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;      snprintf(cmd, <span class="keyword">sizeof</span>(cmd), <span class="stringliteral">&quot;%s %s %s %s %s&quot;</span>, ext_pass_check_cmd, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, password);</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f">vm_check_password_shell</a>(cmd, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Result: %s\n&quot;</span>, buf);</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;         <span class="keywordflow">if</span> (!strncasecmp(buf, <span class="stringliteral">&quot;VALID&quot;</span>, 5)) {</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Passed password check: &#39;%s&#39;\n&quot;</span>, buf);</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(buf, <span class="stringliteral">&quot;FAILURE&quot;</span>, 7)) {</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to execute password validation script: &#39;%s&#39;.\n&quot;</span>, buf);</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Password doesn&#39;t match policies for user %s %s\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, password);</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;         }</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      }</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;   }</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;}</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="comment"> * \brief Performs a change of the voicemail passowrd in the realtime engine.</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="comment"> * \param vmu The voicemail user to change the password for.</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment"> * \param password The new value to be set to the password for this user.</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment"> * This only works if there is a realtime engine configured.</span></div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="comment"> * This is called from the (top level) vm_change_password.</span></div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01485"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c"> 1485</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c">change_password_realtime</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>)</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;{</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;   <span class="keywordflow">if</span> (!strcmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, password)) {</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;      <span class="comment">/* No change (but an update would return 0 rows updated, so we opt out here) */</span></div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;   }</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;   <span class="keywordflow">if</span> (strlen(password) &gt; 10) {</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4">ast_realtime_require_field</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;password&quot;</span>, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, strlen(password), <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;   }</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a30c75d60cfd1f61e41c7275bb30c77f6">ast_update2_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, <span class="stringliteral">&quot;mailbox&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>, <span class="stringliteral">&quot;password&quot;</span>, password, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>) &gt; 0) {</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PASSWORDCHANGED&quot;</span>, <span class="stringliteral">&quot;Message: realtime engine updated with new password\r\nPasswordSource: realtime&quot;</span>);</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, password, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;      res = 0;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;   }</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;}</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment"> * \brief Destructively Parse options and apply.</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01507"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2"> 1507</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d45/test__http__media__cache_8c.html#a80c8e3ae5087d90d422675d034eeebc7">options</a>)</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;{</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;   <span class="keywordtype">char</span> *stringp;</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;   <span class="keywordtype">char</span> *s;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;   stringp = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(options);</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;   <span class="keywordflow">while</span> ((s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>))) {</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;      value = s;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;      <span class="keywordflow">if</span> ((var = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;value, <span class="stringliteral">&quot;=&quot;</span>)) &amp;&amp; value) {</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587">apply_option</a>(vmu, var, value);</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;      }</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;   }</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;}</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;<span class="comment"> * \brief Loads the options specific to a voicemail user.</span></div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;<span class="comment"> * This is called when a vm_user structure is being set up, such as from load_options.</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01526"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f"> 1526</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f">apply_options_full</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *<a class="code" href="../../db/d37/hsearch_8c.html#ad0f0f85b3cab490a81baa02c4b9edf45">retval</a>, <span class="keyword">struct</span> <a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>)</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;{</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;   <span class="keywordflow">for</span> (; <a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>; var = var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">next</a>) {</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;vmsecret&quot;</span>)) {</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;secret&quot;</span>) || !strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;password&quot;</span>)) { <span class="comment">/* don&#39;t overwrite vmsecret if it exists */</span></div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>)) {</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) &amp;&amp; var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid password detected for mailbox %s.  The password&quot;</span></div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;                  <span class="stringliteral">&quot;\n\tmust be reset in voicemail.conf.\n&quot;</span>, retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;            }</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;         }</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;uniqueid&quot;</span>)) {</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">uniqueid</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">uniqueid</a>));</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pager&quot;</span>)) {</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>));</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;email&quot;</span>)) {</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>);</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;         retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;fullname&quot;</span>)) {</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>));</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>));</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;emailsubject&quot;</span>)) {</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;         retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;emailbody&quot;</span>)) {</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;         retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapuser&quot;</span>)) {</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imapuser, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapuser));</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapserver&quot;</span>)) {</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imapserver, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapserver));</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapport&quot;</span>)) {</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imapport, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapport));</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapflags&quot;</span>)) {</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imapflags, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapflags));</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imappassword&quot;</span>) || !strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapsecret&quot;</span>)) {</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imappassword, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imappassword));</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapfolder&quot;</span>)) {</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imapfolder, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapfolder));</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapvmshareid&quot;</span>)) {</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;imapvmshareid, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapvmshareid));</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;         retval-&gt;imapversion = imapversion;</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;      } <span class="keywordflow">else</span></div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587">apply_option</a>(retval, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;   }</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;}</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;<span class="comment"> * \brief Determines if a DTMF key entered is valid.</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;<span class="comment"> * \param key The character to be compared. expects a single character. Though is capable of handling a string, this is internally copies using ast_strdupa.</span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;<span class="comment"> * Tests the character entered against the set of valid DTMF characters.</span></div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="comment"> * \return 1 if the character entered is a valid DTMF digit, 0 if the character is invalid.</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01592"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb"> 1592</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *key)</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;{</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;   <span class="keywordtype">char</span> *local_key = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(key);</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; strlen(key); ++i) {</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;      <span class="keywordflow">if</span> (!strchr(<a class="code" href="../../dc/df4/app__voicemail_8c.html#ace804dd195bf827b988e3f2282422d25">VALID_DTMF</a>, *local_key)) {</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid DTMF key \&quot;%c\&quot; used in voicemail configuration file\n&quot;</span>, *local_key);</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;      }</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;      local_key++;</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;   }</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;   <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;}</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;<span class="comment"> * \brief Finds a voicemail user from the realtime engine.</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;<span class="comment"> * \param ivm</span></div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="comment"> * \param mailbox</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="comment"> * This is called as a fall through case when the normal find_user() was not able to find a user. That is, the default it so look in the usual voicemail users file first.</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment"> * \return The ast_vm_user structure for the user that was found.</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01617"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e"> 1617</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e">find_user_realtime</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *ivm, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;{</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *<a class="code" href="../../db/d37/hsearch_8c.html#ad0f0f85b3cab490a81baa02c4b9edf45">retval</a>;</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;   <span class="keywordflow">if</span> ((retval = (ivm ? ivm : <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*retval))))) {</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;      <span class="keywordflow">if</span> (ivm) {</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;         memset(retval, 0, <span class="keyword">sizeof</span>(*retval));</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;      }</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(retval);</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;      <span class="keywordflow">if</span> (!ivm) {</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;         <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(retval, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;      }</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;      <span class="keywordflow">if</span> (mailbox) {</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, mailbox, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>));</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      }</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;      <span class="keywordflow">if</span> (!context &amp;&amp; <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>)) {</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;         var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1a03993603e2bc2463153857836645bb">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;mailbox&quot;</span>, mailbox, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;         var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1a03993603e2bc2463153857836645bb">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;mailbox&quot;</span>, mailbox, <span class="stringliteral">&quot;context&quot;</span>, context, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;      }</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;      <span class="keywordflow">if</span> (var) {</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f">apply_options_full</a>(retval, var);</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#adea5390496e5477192d86f340d512d04">ast_variables_destroy</a>(var);</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;         <span class="keywordflow">if</span> (!ivm)</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;            <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(retval);</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;         retval = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;      }</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;   }</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../db/d37/hsearch_8c.html#ad0f0f85b3cab490a81baa02c4b9edf45">retval</a>;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;}</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="comment"> * \brief Finds a voicemail user from the users file or the realtime engine.</span></div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="comment"> * \param ivm</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="comment"> * \param mailbox</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;<span class="comment"> * \return The ast_vm_user structure for the user that was found.</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01658"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061"> 1658</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *ivm, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;{</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;   <span class="comment">/* This function could be made to generate one from a database, too */</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *cur;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;   <span class="keywordflow">if</span> (!context &amp;&amp; !<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>))</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, cur, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;      <span class="keywordflow">if</span> (cur-&gt;imapversion != imapversion) {</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;      }</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>) &amp;&amp; !strcasecmp(mailbox, cur-&gt;mailbox))</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;      <span class="keywordflow">if</span> (context &amp;&amp; (!strcasecmp(context, cur-&gt;context)) &amp;&amp; (!strcasecmp(mailbox, cur-&gt;mailbox)))</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;   }</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;   <span class="keywordflow">if</span> (cur) {</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;      <span class="comment">/* Make a copy, so that on a reload, we have no race */</span></div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;      <span class="keywordflow">if</span> ((vmu = (ivm ? ivm : <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*vmu))))) {</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>);</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;         *vmu = *cur;</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(cur-&gt;email);</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(cur-&gt;emailbody);</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(cur-&gt;emailsubject);</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;         <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, !ivm, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6">AST_LIST_NEXT</a>(vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;      }</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;   }</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;   <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;      vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e">find_user_realtime</a>(ivm, context, mailbox);</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;   }</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;   <span class="keywordflow">if</span> (!vmu &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(aliasescontext)) {</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *mapping;</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;      <span class="keywordtype">char</span> *search_string = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a>);</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;      snprintf(search_string, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a>, <span class="stringliteral">&quot;%s%s%s&quot;</span>,</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;         mailbox,</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;@&quot;</span>,</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(context, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;      mapping = <a class="code" href="../../d5/da5/astobj2_8h.html#a911e0703891a9a7aaf73978152092586">ao2_find</a>(alias_mailbox_mappings, search_string, <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35caa13a6e0771cc457e86f425d95c3b8d54">OBJ_SEARCH_KEY</a>);</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;      <span class="keywordflow">if</span> (mapping) {</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;         <span class="keywordtype">char</span> *search_mailbox = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;         <span class="keywordtype">char</span> *search_context = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>), &amp;search_mailbox, &amp;search_context);</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mapping, -1);</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;         vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(ivm, search_mailbox, search_context);</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;      }</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;   }</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;   <span class="keywordflow">return</span> vmu;</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;}</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="comment"> * \brief Resets a user password to a specified password.</span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;<span class="comment"> * \param mailbox</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;<span class="comment"> * \param newpass</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;<span class="comment"> * This does the actual change password work, called by the vm_change_password() function.</span></div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01729"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01"> 1729</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">reset_user_pw</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *newpass)</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;{</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;   <span class="comment">/* This function could be made to generate one from a database, too */</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *cur;</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, cur, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;      <span class="keywordflow">if</span> ((!context || !strcasecmp(context, cur-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>)) &amp;&amp;</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;         (!strcasecmp(mailbox, cur-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)))</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;   }</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;   <span class="keywordflow">if</span> (cur) {</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(cur-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpass, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;      res = 0;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;   }</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;}</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;<span class="comment"> * \brief Check if configuration file is valid</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01751"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04"> 1751</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg)</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;{</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;   <span class="keywordflow">return</span> cfg &amp;&amp; cfg != <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;}</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;<span class="comment"> * \brief The handler for the change password option.</span></div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;<span class="comment"> * \param vmu The voicemail user to work with.</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;<span class="comment"> * \param newpassword The new password (that has been gathered from the appropriate prompting).</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<span class="comment"> * This is called when a new user logs in for the first time and the option to force them to change their password is set.</span></div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;<span class="comment"> * It is also called when the user wants to change their password from menu option &#39;5&#39; on the mailbox options menu.</span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01763"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a778f09605f89f85529e369351472b174"> 1763</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a778f09605f89f85529e369351472b174">vm_change_password</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *newpassword)</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;{</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a>   *cfg = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d7/db2/structast__category.html">ast_category</a> *cat = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;   <span class="keywordtype">char</span> *category = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fabc16a274124ae96d43f8e52e344292c3">CONFIG_FLAG_WITHCOMMENTS</a> };</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;   <span class="keywordtype">char</span> secretfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;   <span class="keywordtype">int</span> found = 0;</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c">change_password_realtime</a>(vmu, newpassword))</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;   <span class="comment">/* check if we should store the secret in the spool directory next to the messages */</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;   <span class="keywordflow">switch</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a>) {</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>:</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;      snprintf(secretfn, <span class="keyword">sizeof</span>(secretfn), <span class="stringliteral">&quot;%s%s/%s/secret.conf&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a616064b374d2f44d6fdab04f8509b138">write_password_to_file</a>(secretfn, newpassword) == 0) {</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PASSWORDCHANGED&quot;</span>, <span class="stringliteral">&quot;Message: secret.conf updated with new password\r\nPasswordSource: secret.conf&quot;</span>);</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Writing voicemail password to file %s succeeded\n&quot;</span>, secretfn);</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">reset_user_pw</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, newpassword);</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Writing voicemail password to file %s failed, falling back to config file\n&quot;</span>, secretfn);</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;      }</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;      <span class="comment">/* Fall-through */</span></div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">OPT_PWLOC_VOICEMAILCONF</a>:</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;      <span class="keywordflow">if</span> ((cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, config_flags)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(cfg)) {</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;         <span class="keywordflow">while</span> ((category = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(cfg, category))) {</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;            <span class="keywordflow">if</span> (!strcasecmp(category, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>)) {</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;               <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;               <span class="keywordtype">char</span> *<span class="keyword">new</span> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;               <span class="keywordflow">if</span> (!(tmp = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, category, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>))) {</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;We could not find the mailbox.\n&quot;</span>);</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;                  <span class="keywordflow">break</span>;</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;               }</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;               value = strstr(tmp, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;               <span class="keywordflow">if</span> (!value) {</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;                  <span class="keyword">new</span> = <a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>(strlen(newpassword) + 1);</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;                  sprintf(<span class="keyword">new</span>, <span class="stringliteral">&quot;%s&quot;</span>, newpassword);</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;                  <span class="keyword">new</span> = <a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>((strlen(value) + strlen(newpassword) + 1));</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;                  sprintf(<span class="keyword">new</span>, <span class="stringliteral">&quot;%s%s&quot;</span>, newpassword, value);</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;               }</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;               <span class="keywordflow">if</span> (!(cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a976052ba6bdad7e94e60cd4bc1c3f3b2">ast_category_get</a>(cfg, category, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to get category structure.\n&quot;</span>);</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;                  <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<span class="keyword">new</span>);</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;                  <span class="keywordflow">break</span>;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;               }</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;               <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8">ast_variable_update</a>(cat, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="keyword">new</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;               found = 1;</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;               <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<span class="keyword">new</span>);</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;            }</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;         }</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;         <span class="comment">/* save the results */</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;         <span class="keywordflow">if</span> (found) {</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PASSWORDCHANGED&quot;</span>, <span class="stringliteral">&quot;Message: voicemail.conf updated with new password\r\nPasswordSource: voicemail.conf&quot;</span>);</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">reset_user_pw</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, newpassword);</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, cfg, <span class="stringliteral">&quot;app_voicemail&quot;</span>);</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;         }</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;      }</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;      <span class="comment">/* Fall-through */</span></div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53a4ea71034662c0e0c184ccfbd68c9e519">OPT_PWLOC_USERSCONF</a>:</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;      <span class="comment">/* check users.conf and update the password stored for the mailbox */</span></div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;      <span class="comment">/* if no vmsecret entry exists create one. */</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;      <span class="keywordflow">if</span> ((cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(cfg)) {</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;we are looking for %s\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;         <span class="keywordflow">for</span> (category = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(cfg, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); category; category = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(cfg, category)) {</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;users.conf: %s\n&quot;</span>, category);</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;            <span class="keywordflow">if</span> (!strcasecmp(category, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) {</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;               <span class="keywordtype">char</span> <span class="keyword">new</span>[strlen(newpassword) + 1];</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, category, <span class="stringliteral">&quot;vmsecret&quot;</span>)) {</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;                  <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;looks like we need to make vmsecret!\n&quot;</span>);</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;                  var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66581086d34dfe7ea86b0644bacef239">ast_variable_new</a>(<span class="stringliteral">&quot;vmsecret&quot;</span>, newpassword, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;                  var = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;               }</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;               sprintf(<span class="keyword">new</span>, <span class="stringliteral">&quot;%s&quot;</span>, newpassword);</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;               <span class="keywordflow">if</span> (!(cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a976052ba6bdad7e94e60cd4bc1c3f3b2">ast_category_get</a>(cfg, category, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;                  <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;failed to get category!\n&quot;</span>);</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;                  <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(var);</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;                  <span class="keywordflow">break</span>;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;               }</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;               <span class="keywordflow">if</span> (!var) {</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;                  <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8">ast_variable_update</a>(cat, <span class="stringliteral">&quot;vmsecret&quot;</span>, <span class="keyword">new</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;                  <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a57a3200e5b440d7135eaf0450ea559fe">ast_variable_append</a>(cat, var);</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;               }</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;               found = 1;</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;            }</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;         }</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;         <span class="comment">/* save the results and clean things up */</span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;         <span class="keywordflow">if</span> (found) {</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PASSWORDCHANGED&quot;</span>, <span class="stringliteral">&quot;Message: users.conf updated with new password\r\nPasswordSource: users.conf&quot;</span>);</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">reset_user_pw</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, newpassword);</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, cfg, <span class="stringliteral">&quot;app_voicemail&quot;</span>);</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;         }</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;      }</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;   }</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;}</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;</div><div class="line"><a name="l01876"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f"> 1876</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *newpassword)</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;{</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[255];</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;   snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%s %s %s %s&quot;</span>, ext_pass_cmd, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, newpassword);</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;External password: %s\n&quot;</span>,buf);</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(buf)) {</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PASSWORDCHANGED&quot;</span>, <span class="stringliteral">&quot;Message: external script updated with new password\r\nPasswordSource: external&quot;</span>);</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;      <span class="comment">/* Reset the password in memory, too */</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">reset_user_pw</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, newpassword);</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;   }</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;}</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="comment"> * \brief Creates a file system path expression for a folder within the voicemail data folder and the appropriate context.</span></div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="comment"> * \param dest The variable to hold the output generated path expression. This buffer should be of size PATH_MAX.</span></div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="comment"> * \param len The length of the path string that was written out.</span></div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;<span class="comment"> * \param ext</span></div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="comment"> * \param folder</span></div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="comment"> * The path is constructed as</span></div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="comment"> *    VM_SPOOL_DIRcontext/ext/folder</span></div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01902"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22"> 1902</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(<span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d43/http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;{</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;   <span class="keywordflow">return</span> snprintf(dest, len, <span class="stringliteral">&quot;%s%s/%s/%s&quot;</span>, VM_SPOOL_DIR, context, ext, folder);</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;}</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;<span class="comment"> * \brief Creates a file system path expression for a folder within the voicemail data folder and the appropriate context.</span></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="comment"> * \param dest The variable to hold the output generated path expression. This buffer should be of size PATH_MAX.</span></div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;<span class="comment"> * \param len The length of the path string that was written out.</span></div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;<span class="comment"> * \param dir</span></div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;<span class="comment"> * \param num</span></div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;<span class="comment"> * The path is constructed as</span></div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;<span class="comment"> *    VM_SPOOL_DIRcontext/ext/folder</span></div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01919"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd"> 1919</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(<span class="keywordtype">char</span> *dest, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">int</span> num)</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;{</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;   <span class="keywordflow">return</span> snprintf(dest, len, <span class="stringliteral">&quot;%s/msg%04d&quot;</span>, dir, num);</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;}</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="comment">/* same as mkstemp, but return a FILE * */</span></div><div class="line"><a name="l01925"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a823c8996a141b154215521998b4adedf"> 1925</a></span>&#160;<span class="keyword">static</span> FILE *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(<span class="keywordtype">char</span> *<span class="keyword">template</span>)</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;{</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;   FILE *p = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;   <span class="keywordtype">int</span> pfd = mkstemp(<span class="keyword">template</span>);</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;   chmod(<span class="keyword">template</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a> &amp; ~my_umask);</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;   <span class="keywordflow">if</span> (pfd &gt; -1) {</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;      p = fdopen(pfd, <span class="stringliteral">&quot;w+&quot;</span>);</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;      <span class="keywordflow">if</span> (!p) {</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;         close(pfd);</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;         pfd = -1;</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;      }</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;   }</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;   <span class="keywordflow">return</span> p;</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;}</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="comment">/*! \brief basically mkdir -p $dest/$context/$ext/$folder</span></div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="comment"> * \param dest    String. base directory.</span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;<span class="comment"> * \param len     Length of dest.</span></div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="comment"> * \param context String. Ignored if is null or empty string.</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;<span class="comment"> * \param ext     String. Ignored if is null or empty string.</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="comment"> * \param folder  String. Ignored if is null or empty string.</span></div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="comment"> * \return -1 on failure, 0 on success.</span></div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01948"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938"> 1948</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(<span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d43/http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;{</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;   mode_t   mode = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">VOICEMAIL_DIR_MODE</a>;</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(dest, len, context, ext, folder);</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../d5/d60/utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0">ast_mkdir</a>(dest, mode))) {</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;ast_mkdir &#39;%s&#39; failed: %s\n&quot;</span>, dest, strerror(res));</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;   }</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;}</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;</div><div class="line"><a name="l01961"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541"> 1961</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;{</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; <span class="keywordtype">id</span> == 0) {</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;      <span class="keywordflow">return</span> vmu-&gt;imapfolder;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;   }</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;   <span class="keywordflow">return</span> (<span class="keywordtype">id</span> &gt;= 0 &amp;&amp; <span class="keywordtype">id</span> &lt; <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mailbox_folders)) ? mailbox_folders[<a class="code" href="../../da/dfb/app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a>] : <span class="stringliteral">&quot;Unknown&quot;</span>;</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;}</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div><div class="line"><a name="l01971"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6039669cd57ff47a2df5e25685b660c4"> 1971</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6039669cd57ff47a2df5e25685b660c4">vm_index_to_foldername</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;{</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keywordtype">id</span>);</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;}</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div><div class="line"><a name="l01977"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447"> 1977</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>)</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;{</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;   <span class="keywordtype">size_t</span> i;</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mailbox_folders); i++) {</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;      <span class="keywordflow">if</span> (strcasecmp(name, mailbox_folders[i]) == 0) {</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;         <span class="keywordflow">return</span> i;</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;      }</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;   }</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;   <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;}</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;</div><div class="line"><a name="l01990"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617"> 1990</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;{</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;   <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;   }</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>);</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>)) {</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu);</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;   }</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;}</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div><div class="line"><a name="l02008"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8dd478366d9ea311c99d0e564bfb1cee"> 2008</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8dd478366d9ea311c99d0e564bfb1cee">free_user_final</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;{</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;   <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;   }</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) {</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;      <a class="code" href="../../dc/d33/mwi_8h.html#ab6397dc158885461fdc0a21138dda6f9">ast_delete_mwi_state_full</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;   }</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;}</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;</div><div class="line"><a name="l02021"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8c38a20df9d7ac0e6aa6e1d9e18e5356"> 2021</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c38a20df9d7ac0e6aa6e1d9e18e5356">vm_allocate_dh</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> count_msg) {</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;   <span class="keywordtype">int</span> arraysize = (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &gt; count_msg ? vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> : count_msg);</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;   <span class="comment">/* remove old allocation */</span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>) {</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>);</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;   }</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>) {</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>);</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;   }</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">dh_arraysize</a> = 0;</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;   <span class="keywordflow">if</span> (arraysize &gt; 0) {</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;      <span class="keywordflow">if</span> (!(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(arraysize, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)))) {</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;      }</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;      <span class="keywordflow">if</span> (!(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(arraysize, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)))) {</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>);</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;      }</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">dh_arraysize</a> = arraysize;</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;   }</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;}</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;<span class="comment">/* All IMAP-specific functions should go in this block. This</span></div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;<span class="comment"> * keeps them from being spread out all over the code */</span></div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vm_imap_delete(<span class="keywordtype">char</span> *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;{</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;   <span class="keywordtype">char</span> arg[10];</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> messageNum;</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;   <span class="comment">/* If greetings aren&#39;t stored in IMAP, just delete the file */</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt; 0 &amp;&amp; !imapgreetings) {</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(file, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;   }</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;   <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 1)) &amp;&amp; !(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0))) {</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t find a vm_state for mailbox %s. Unable to set \\DELETED flag for message %d\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, msgnum);</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;   }</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt; 0) {</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;      imap_delete_old_greeting(file, vms);</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;   }</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;   <span class="comment">/* find real message number based on msgnum */</span></div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;   <span class="comment">/* this may be an index into vms-&gt;msgArray based on the msgnum. */</span></div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;   messageNum = vms-&gt;msgArray[msgnum];</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;   <span class="keywordflow">if</span> (messageNum == 0) {</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;msgnum %d, mailbox message %lu is zero.\n&quot;</span>, msgnum, messageNum);</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;   }</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;deleting msgnum %d, which is mailbox message %lu\n&quot;</span>, msgnum, messageNum);</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;   <span class="comment">/* delete message */</span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;   snprintf (arg, <span class="keyword">sizeof</span>(arg), <span class="stringliteral">&quot;%lu&quot;</span>, messageNum);</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;   mail_setflag (vms-&gt;mailstream, arg, <span class="stringliteral">&quot;\\DELETED&quot;</span>);</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;   mail_expunge(vms-&gt;mailstream);</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;}</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vm_imap_update_msg_id(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg, <span class="keywordtype">int</span> folder)</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;{</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan;</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;   <span class="keywordtype">char</span> *cid;</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>;</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>;</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *duration_str;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;   <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;   <span class="comment">/*</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="comment">    * First, get things initially set up. If any of this fails, then</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="comment">    * back out before doing anything substantial</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;   vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0);</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;   <span class="keywordflow">if</span> (!vms) {</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;   }</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(vms, vmu, folder)) {</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;   }</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;   chan = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>();</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;   <span class="keywordflow">if</span> (!chan) {</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(vms, vmu);</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;   }</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;   <span class="comment">/*</span></div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;<span class="comment">    * We need to make sure the new message we save has the same</span></div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;<span class="comment">    * callerid, flag, and duration as the original message</span></div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;   cid = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>));</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cid)) {</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;      <a class="code" href="../../de/d47/callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df">ast_callerid_parse</a>(cid, &amp;cid_name, &amp;cid_num);</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#afdaf014aa17389de35cba4df16860b0d">ast_party_caller_init</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan));</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cid_name)) {</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aab4036618469f3fa9ab26a22726ba2db">name</a>.<a class="code" href="../../d8/d6f/structast__party__name.html#aaa04218f9e3a9065afa8be2491da8904">valid</a> = 1;</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aab4036618469f3fa9ab26a22726ba2db">name</a>.<a class="code" href="../../d8/d6f/structast__party__name.html#ab50d783982593ef993ea0b68f7ad8b80">str</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(cid_name);</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;      }</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cid_num)) {</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aca2d7de6c89f201dc8bd0a2642d2a352">number</a>.<a class="code" href="../../d6/dbb/structast__party__number.html#aaa04218f9e3a9065afa8be2491da8904">valid</a> = 1;</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aca2d7de6c89f201dc8bd0a2642d2a352">number</a>.<a class="code" href="../../d6/dbb/structast__party__number.html#ab50d783982593ef993ea0b68f7ad8b80">str</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(cid_num);</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;      }</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;   }</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;   duration_str = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>);</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(duration_str)) {</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;      sscanf(duration_str, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;duration);</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;   }</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;   <span class="comment">/*</span></div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;<span class="comment">    * IMAP messages cannot be altered once delivered. So we have to delete the</span></div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;<span class="comment">    * current message and then re-add it with the updated message ID.</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;<span class="comment">    *</span></div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;<span class="comment">    * Furthermore, there currently is no atomic way to create a new message and to</span></div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;<span class="comment">    * store it in an arbitrary folder. So we have to save it to the INBOX and then</span></div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;<span class="comment">    * move to the appropriate folder.</span></div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;   <span class="keywordflow">if</span> (!imap_store_file(dir, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, msgnum, chan, vmu, vmfmts,</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;         duration, vms, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;flag&quot;</span>), msg_id)) {</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;      <span class="keywordflow">if</span> (folder != <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>) {</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(vmu, vms, msgnum, folder, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;      }</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;      vm_imap_delete(dir, msgnum, vmu);</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;   }</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(vms, vmu);</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(chan);</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;}</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_retrieve_greeting(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;{</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms_p;</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>, *filename;</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;   <span class="keywordtype">char</span> dest[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;   BODY *body;</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;   <span class="keywordtype">int</span> ret = 0;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;   <span class="keywordtype">int</span> curr_mbox;</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;   <span class="comment">/* This function is only used for retrieval of IMAP greetings</span></div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;<span class="comment">    * regular messages are not retrieved this way, nor are greetings</span></div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;<span class="comment">    * if they are stored locally*/</span></div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1 || !imapgreetings) {</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;      file = strrchr(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(dir), <span class="charliteral">&#39;/&#39;</span>);</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;      <span class="keywordflow">if</span> (file)</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;         *file++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Failed to procure file name from directory passed.\n&quot;</span>);</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;      }</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;   }</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;   <span class="comment">/* check if someone is accessing this box right now... */</span></div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;   <span class="keywordflow">if</span> (!(vms_p = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 1)) &amp;&amp;</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;      !(vms_p = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0))) {</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;      <span class="comment">/* Unlike when retrieving a message, it is reasonable not to be able to find a</span></div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;<span class="comment">      * vm_state for a mailbox when trying to retrieve a greeting. Just create one,</span></div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<span class="comment">      * that&#39;s all we need to do.</span></div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;<span class="comment">      */</span></div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;      <span class="keywordflow">if</span> (!(vms_p = create_vm_state_from_user(vmu))) {</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to create vm_state object!\n&quot;</span>);</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;      }</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;   }</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;   <span class="comment">/* Greetings will never have a prepended message */</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;   *vms_p-&gt;introfn = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;   <span class="comment">/* get the current mailbox so that we can point the mailstream back to it later */</span></div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;   curr_mbox = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;   <span class="keywordflow">if</span> (init_mailstream(vms_p, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>) || !vms_p-&gt;mailstream) {</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream is NULL or can&#39;t init_mailstream\n&quot;</span>);</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;   }</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;   <span class="comment">/*XXX Yuck, this could probably be done a lot better */</span></div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; vms_p-&gt;mailstream-&gt;nmsgs; i++) {</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;      mail_fetchstructure(vms_p-&gt;mailstream, i + 1, &amp;body);</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;      <span class="comment">/* We have the body, now we extract the file name of the first attachment. */</span></div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;      <span class="keywordflow">if</span> (body-&gt;nested.part &amp;&amp; body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;         <span class="keywordtype">char</span> *attachment = body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value;</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;         <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>[strlen(attachment) + 1];</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;         strcpy(copy, attachment); <span class="comment">/* safe */</span></div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;         attachment = <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>;</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;         filename = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;attachment, <span class="stringliteral">&quot;.&quot;</span>);</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;         <span class="keywordflow">if</span> (!strcmp(filename, file)) {</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, dir, <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>));</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;            vms_p-&gt;msgArray[vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = i + 1;</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(dest, <span class="keyword">sizeof</span>(dest), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;            save_body(body, vms_p, <span class="stringliteral">&quot;2&quot;</span>, attachment, 0);</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;            ret = 0;</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;         }</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;There is no file attached to this IMAP message.\n&quot;</span>);</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;         ret = -1;</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;      }</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;   }</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;   <span class="keywordflow">if</span> (curr_mbox != -1) {</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;      <span class="comment">/* restore previous mbox stream */</span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;      <span class="keywordflow">if</span> (init_mailstream(vms_p, curr_mbox) || !vms_p-&gt;mailstream) {</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream is NULL or can&#39;t init_mailstream\n&quot;</span>);</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;         ret = -1;</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;      }</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;   }</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;   <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;}</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_retrieve_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">int</span> msgnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context)</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;{</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;   BODY *body;</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;   <span class="keywordtype">char</span> *header_content;</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;   <span class="keywordtype">char</span> *attachedfilefmt;</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[80];</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;   <span class="keywordtype">char</span> text_file[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;   FILE *text_file_ptr;</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;   <span class="keywordtype">int</span> curr_mbox;</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, context, mailbox))) {</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t find user with mailbox %s@%s\n&quot;</span>, mailbox, context);</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;   }</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt; 0) {</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;      <span class="keywordflow">if</span> (imapgreetings) {</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;         res = imap_retrieve_greeting(dir, msgnum, vmu);</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;         res = 0;</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;      }</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;   }</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;   <span class="comment">/* Before anything can happen, we need a vm_state so that we can</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="comment">    * actually access the imap server through the vms-&gt;mailstream</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;   <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 1)) &amp;&amp; !(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0))) {</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;      <span class="comment">/* This should not happen. If it does, then I guess we&#39;d</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="comment">       * need to create the vm_state, extract which mailbox to</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="comment">       * open, and then set up the msgArray so that the correct</span></div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="comment">       * IMAP message could be accessed. If I have seen correctly</span></div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;<span class="comment">       * though, the vms should be obtainable from the vmstates list</span></div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;<span class="comment">       * and should have its msgArray properly set up.</span></div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t find a vm_state for mailbox %s!!! Oh no!\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;      res = -1;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;   }</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;   <span class="comment">/* Ensure we have the correct mailbox open and have a valid mailstream for it */</span></div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;   curr_mbox = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;   <span class="keywordflow">if</span> (curr_mbox &lt; 0) {</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Mailbox folder curbox not set, defaulting to Inbox\n&quot;</span>);</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;      curr_mbox = 0;</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;   }</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;   init_mailstream(vms, curr_mbox);</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;mailstream) {</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream for %s is NULL\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;      res = -1;</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;   }</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), dir, msgnum);</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;   snprintf(vms-&gt;introfn, <span class="keyword">sizeof</span>(vms-&gt;introfn), <span class="stringliteral">&quot;%sintro&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;   <span class="comment">/* Don&#39;t try to retrieve a message from IMAP if it already is on the file system */</span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;      res = 0;</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;   }</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Before mail_fetchheaders, curmsg is: %d, imap messages is %lu\n&quot;</span>, msgnum, vms-&gt;msgArray[msgnum]);</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;msgArray[msgnum] == 0) {</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Trying to access unknown message\n&quot;</span>);</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;      res = -1;</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;   }</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;   <span class="comment">/* This will only work for new messages... */</span></div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;   header_content = mail_fetchheader (vms-&gt;mailstream, vms-&gt;msgArray[msgnum]);</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;   <span class="comment">/* empty string means no valid header */</span></div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(header_content)) {</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not fetch header for message number %ld\n&quot;</span>, vms-&gt;msgArray[msgnum]);</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;      res = -1;</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;   }</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;   mail_fetchstructure(vms-&gt;mailstream, vms-&gt;msgArray[msgnum], &amp;body);</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;   <span class="comment">/* We have the body, now we extract the file name of the first attachment. */</span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;   <span class="keywordflow">if</span> (body-&gt;nested.part &amp;&amp; body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;      attachedfilefmt = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;There is no file attached to this IMAP message.\n&quot;</span>);</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;      res = -1;</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;   }</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;   <span class="comment">/* Find the format of the attached file */</span></div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;   <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;attachedfilefmt, <span class="stringliteral">&quot;.&quot;</span>);</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;   <span class="keywordflow">if</span> (!attachedfilefmt) {</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;File format could not be obtained from IMAP message attachment\n&quot;</span>);</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;      res = -1;</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;   }</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;   save_body(body, vms, <span class="stringliteral">&quot;2&quot;</span>, attachedfilefmt, 0);</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;   <span class="keywordflow">if</span> (save_body(body, vms, <span class="stringliteral">&quot;3&quot;</span>, attachedfilefmt, 1)) {</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;      *vms-&gt;introfn = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;   }</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;   <span class="comment">/* Get info from headers!! */</span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;   snprintf(text_file, <span class="keyword">sizeof</span>(text_file), <span class="stringliteral">&quot;%s.%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="stringliteral">&quot;txt&quot;</span>);</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;   <span class="keywordflow">if</span> (!(text_file_ptr = fopen(text_file, <span class="stringliteral">&quot;w&quot;</span>))) {</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to open/create file %s: %s\n&quot;</span>, text_file, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;   }</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;   fprintf(text_file_ptr, <span class="stringliteral">&quot;%s\n&quot;</span>, <span class="stringliteral">&quot;[message]&quot;</span>);</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Name:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;callerid=\&quot;%s\&quot; &quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;   }</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Num:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;&lt;%s&gt;\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;   }</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Context:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;context=%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;   }</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Orig-time:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;origtime=%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;   }</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Duration:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;duration=%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;   }</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Category:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;category=%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;   }</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Flag:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;flag=%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;   }</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;   <span class="keywordflow">if</span> (get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Message-ID:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf))) {</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;      fprintf(text_file_ptr, <span class="stringliteral">&quot;msg_id=%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;   }</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;   fclose(text_file_ptr);</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>:</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;}</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> folder_int(<span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;{</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;   <span class="comment">/*assume a NULL folder means INBOX*/</span></div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;   <span class="keywordflow">if</span> (!folder) {</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;   }</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(folder, imapfolder)) {</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Old&quot;</span>)) {</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Work&quot;</span>)) {</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;      <span class="keywordflow">return</span> 2;</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Family&quot;</span>)) {</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;      <span class="keywordflow">return</span> 3;</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Friends&quot;</span>)) {</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;      <span class="keywordflow">return</span> 4;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust1&quot;</span>)) {</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;      <span class="keywordflow">return</span> 5;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust2&quot;</span>)) {</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;      <span class="keywordflow">return</span> 6;</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust3&quot;</span>)) {</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;      <span class="keywordflow">return</span> 7;</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust4&quot;</span>)) {</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;      <span class="keywordflow">return</span> 8;</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust5&quot;</span>)) {</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;      <span class="keywordflow">return</span> 9;</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Urgent&quot;</span>)) {</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;      <span class="keywordflow">return</span> 11;</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;   } <span class="keywordflow">else</span> { <span class="comment">/*assume they meant INBOX if folder is not found otherwise*/</span></div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;   }</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;}</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> __messagecount(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;{</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;   SEARCHPGM *pgm;</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;   SEARCHHEADER *hdr;</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, vmus;</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms_p;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;   <span class="keywordtype">int</span> ret = 0;</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;   <span class="keywordtype">int</span> fold = folder_int(folder);</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;   <span class="keywordtype">int</span> urgent = 0;</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;   <span class="comment">/* If URGENT, then look at INBOX */</span></div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;   <span class="keywordflow">if</span> (fold == 11) {</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;      fold = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>;</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;      urgent = 1;</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;   }</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox))</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;   <span class="comment">/* We have to get the user before we can open the stream! */</span></div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;   vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox);</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;   <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t find mailbox %s in context %s\n&quot;</span>, mailbox, context);</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;      <span class="comment">/* No IMAP account available */</span></div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;      <span class="keywordflow">if</span> (vmu-&gt;imapuser[0] == <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;IMAP user not set for mailbox %s\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;      }</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;   }</div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;   <span class="comment">/* No IMAP account available */</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;imapuser[0] == <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;IMAP user not set for mailbox %s\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;   }</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;   <span class="comment">/* check if someone is accessing this box right now... */</span></div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;   vms_p = get_vm_state_by_imapuser(vmu-&gt;imapuser, 1);</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;   <span class="keywordflow">if</span> (!vms_p) {</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;      vms_p = get_vm_state_by_mailbox(mailbox, context, 1);</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;   }</div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;   <span class="keywordflow">if</span> (vms_p) {</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Returning before search - user is logged in\n&quot;</span>);</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;      <span class="keywordflow">if</span> (fold == 0) { <span class="comment">/* INBOX */</span></div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;         <span class="keywordflow">return</span> urgent ? vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> : vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;</div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;      }</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;      <span class="keywordflow">if</span> (fold == 1) { <span class="comment">/* Old messages */</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;         <span class="keywordflow">return</span> vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;      }</div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;   }</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;   <span class="comment">/* add one if not there... */</span></div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;   vms_p = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0);</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;   <span class="keywordflow">if</span> (!vms_p) {</div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;      vms_p = get_vm_state_by_mailbox(mailbox, context, 0);</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;   }</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;   <span class="keywordflow">if</span> (!vms_p) {</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;      vms_p = create_vm_state_from_user(vmu);</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;   }</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;   ret = init_mailstream(vms_p, fold);</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;   <span class="keywordflow">if</span> (!vms_p-&gt;mailstream) {</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Houston we have a problem - IMAP mailstream is NULL\n&quot;</span>);</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;   }</div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;   <span class="keywordflow">if</span> (ret == 0) {</div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;      pgm = mail_newsearchpgm ();</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;      hdr = mail_newsearchheader (<span class="stringliteral">&quot;X-Asterisk-VM-Extension&quot;</span>, (<span class="keywordtype">char</span> *)(!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : mailbox));</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;      hdr-&gt;next = mail_newsearchheader(<span class="stringliteral">&quot;X-Asterisk-VM-Context&quot;</span>, (<span class="keywordtype">char</span> *) <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(context, <span class="stringliteral">&quot;default&quot;</span>));</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;      pgm-&gt;header = hdr;</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;      <span class="keywordflow">if</span> (fold != <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;         pgm-&gt;unseen = 1;</div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;         pgm-&gt;seen = 0;</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;      }</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;      <span class="comment">/* In the special case where fold is 1 (old messages) we have to do things a bit</span></div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;<span class="comment">       * differently. Old messages are stored in the INBOX but are marked as &quot;seen&quot;</span></div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;         pgm-&gt;unseen = 0;</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;         pgm-&gt;seen = 1;</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;      }</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;      <span class="comment">/* look for urgent messages */</span></div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;      <span class="keywordflow">if</span> (fold == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>) {</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;         <span class="keywordflow">if</span> (urgent) {</div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;            pgm-&gt;flagged = 1;</div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;            pgm-&gt;unflagged = 0;</div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;            pgm-&gt;flagged = 0;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;            pgm-&gt;unflagged = 1;</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;         }</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;      }</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;      pgm-&gt;undeleted = 1;</div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;      pgm-&gt;deleted = 0;</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;      vms_p-&gt;vmArrayIndex = 0;</div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;      mail_search_full (vms_p-&gt;mailstream, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pgm, NIL);</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;      <span class="keywordflow">if</span> (fold == 0 &amp;&amp; urgent == 0)</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;         vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = vms_p-&gt;vmArrayIndex;</div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;      <span class="keywordflow">if</span> (fold == 1)</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;         vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = vms_p-&gt;vmArrayIndex;</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;      <span class="keywordflow">if</span> (fold == 0 &amp;&amp; urgent == 1)</div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;         vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> = vms_p-&gt;vmArrayIndex;</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;      <span class="comment">/*Freeing the searchpgm also frees the searchhdr*/</span></div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;      mail_free_searchpgm(&amp;pgm);</div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;      vms_p-&gt;updated = 0;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;      <span class="keywordflow">return</span> vms_p-&gt;vmArrayIndex;</div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;      mail_ping(vms_p-&gt;mailstream);</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;   }</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;}</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_check_limits(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;{</div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;   <span class="comment">/* Check if mailbox is full */</span></div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;   check_quota(vms, vmu-&gt;imapfolder);</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;quota_limit &amp;&amp; vms-&gt;quota_usage &gt;= vms-&gt;quota_limit) {</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;*** QUOTA EXCEEDED!! %u &gt;= %u\n&quot;</span>, vms-&gt;quota_usage, vms-&gt;quota_limit);</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;      <span class="keywordflow">if</span> (chan) {</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;      }</div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;   }</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;   <span class="comment">/* Check if we have exceeded maxmsg */</span></div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Checking message number quota: mailbox has %d messages, maximum is set to %d, current messages %d\n&quot;</span>, msgnum, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0));</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt;= vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> - <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, +1)) {</div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to leave message since we will exceed the maximum number of messages allowed (%u &gt;= %u)\n&quot;</span>, msgnum, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;      <span class="keywordflow">if</span> (chan) {</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;      }</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;   }</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;}</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;<span class="comment"> * \brief Gets the number of messages that exist in a mailbox folder.</span></div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;<span class="comment"> * \param mailbox_id</span></div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;<span class="comment"> * \param folder</span></div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;<span class="comment"> * This method is used when IMAP backend is used.</span></div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;<span class="comment"> * \return The number of messages in this mailbox folder (zero or more).</span></div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;{</div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_id)</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mailbox_id), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;   }</div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;</div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder) || !strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>)) {</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;      <span class="keywordflow">return</span> __messagecount(context, mailbox, <span class="stringliteral">&quot;INBOX&quot;</span>) + __messagecount(context, mailbox, <span class="stringliteral">&quot;Urgent&quot;</span>);</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;      <span class="keywordflow">return</span> __messagecount(context, mailbox, folder);</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;   }</div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;}</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;</div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_store_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> duration, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id)</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;{</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;   <span class="keywordtype">char</span> *myserveremail = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;   <span class="keywordtype">char</span> introfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;   <span class="keywordtype">char</span> mailbox[256];</div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;   <span class="keywordtype">char</span> *stringp;</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;   FILE *p = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[80] = <span class="stringliteral">&quot;/tmp/astmail-XXXXXX&quot;</span>;</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;   <span class="keywordtype">long</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;</div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;   <span class="keywordtype">void</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;   <span class="keywordtype">int</span> tempcopy = 0;</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;   STRING <a class="code" href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>;</div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;   <span class="keywordtype">int</span> ret; <span class="comment">/* for better error checking */</span></div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;   <span class="keywordtype">char</span> *imap_flags = NIL;</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;   <span class="keywordtype">int</span> msgcount;</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;   <span class="keywordtype">int</span> box = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>;</div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;</div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;   snprintf(mailbox, <span class="keyword">sizeof</span>(mailbox), <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;   msgcount = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(mailbox, <span class="stringliteral">&quot;INBOX&quot;</span>) + <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(mailbox, <span class="stringliteral">&quot;Old&quot;</span>);</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;   <span class="comment">/* Back out early if this is a greeting and we don&#39;t want to store greetings in IMAP */</span></div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt; 0) {</div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;      <span class="keywordflow">if</span>(!imapgreetings) {</div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;         box = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>;</div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;      }</div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;   }</div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;</div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;   <span class="keywordflow">if</span> (imap_check_limits(chan, vms, vmu, msgcount)) {</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;   }</div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;   <span class="comment">/* Set urgent flag for IMAP message */</span></div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) {</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Setting message flag \\\\FLAGGED.\n&quot;</span>);</div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;      imap_flags = <span class="stringliteral">&quot;\\FLAGGED&quot;</span>;</div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;   }</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;   <span class="comment">/* Attach only the first format */</span></div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;   fmt = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(fmt);</div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;   stringp = fmt;</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;   <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);</div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;</div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>))</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;      myserveremail = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1)</div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a> (fn, dir, <span class="keyword">sizeof</span>(fn));</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;</div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;   snprintf(introfn, <span class="keyword">sizeof</span>(introfn), <span class="stringliteral">&quot;%sintro&quot;</span>, fn);</div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(introfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &lt;= 0) {</div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;      *introfn = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;   }</div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;</div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>)) {</div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;      <span class="comment">/* We need the vmu-&gt;email to be set when we call make_email_file, but</span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;<span class="comment">       * if we keep it set, a duplicate e-mail will be created. So at the end</span></div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;<span class="comment">       * of this function, we will revert back to an empty string if tempcopy</span></div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;<span class="comment">       * is 1.</span></div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(vmu-&gt;imapuser);</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;      tempcopy = 1;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;   }</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;   <span class="keywordflow">if</span> (!strcmp(fmt, <span class="stringliteral">&quot;wav49&quot;</span>))</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;      fmt = <span class="stringliteral">&quot;WAV&quot;</span>;</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Storing file &#39;%s&#39;, format &#39;%s&#39;\n&quot;</span>, fn, fmt);</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;   <span class="comment">/* Make a temporary file instead of piping directly to sendmail, in case the mail</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;<span class="comment">      command hangs. */</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;   <span class="keywordflow">if</span> (!(p = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(tmp))) {</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to store &#39;%s&#39; (can&#39;t create temporary file)\n&quot;</span>, fn);</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;      <span class="keywordflow">if</span> (tempcopy) {</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>);</div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;      }</div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;   }</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt; 0 &amp;&amp; imapgreetings) {</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;      <span class="keywordflow">if</span> ((ret = init_mailstream(vms, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>))) {</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open mailstream.\n&quot;</span>);</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;      }</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;      imap_delete_old_greeting(fn, vms);</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;   }</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;</div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0">make_email_file</a>(p, myserveremail, vmu, msgnum, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>,</div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;      chan ? <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d6/d49/structnumber.html">number</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d6/d49/structnumber.html">number</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;      chan ? <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.str, NULL) : NULL,</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;      fn, introfn, fmt, duration, 1, chan, NULL, 1, flag, msg_id);</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;   <span class="comment">/* read mail file to memory */</span></div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;   len = ftell(p);</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;   rewind(p);</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;   <span class="keywordflow">if</span> (!(buf = <a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>(len + 1))) {</div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Can&#39;t allocate %ld bytes to read message\n&quot;</span>, len + 1);</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;      fclose(p);</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;      <span class="keywordflow">if</span> (tempcopy)</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;         *(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>) = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;   }</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;   <span class="keywordflow">if</span> (fread(buf, 1, len, p) != <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;      <span class="keywordflow">if</span> (ferror(p)) {</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error while reading mail file: %s\n&quot;</span>, tmp);</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;      }</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;   }</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;   ((<span class="keywordtype">char</span> *) buf)[<a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;   INIT(&amp;str, mail_string, buf, len);</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;   ret = init_mailstream(vms, box);</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;   <span class="keywordflow">if</span> (ret == 0) {</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;      imap_mailbox_name(mailbox, <span class="keyword">sizeof</span>(mailbox), vms, box, 1);</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;      <span class="keywordflow">if</span>(!mail_append_full(vms-&gt;mailstream, mailbox, imap_flags, NIL, &amp;str))</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error while sending the message to %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;      fclose(p);</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;      unlink(tmp);</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not initialize mailstream for %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;      fclose(p);</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;      unlink(tmp);</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;   }</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;%s stored\n&quot;</span>, fn);</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;   <span class="keywordflow">if</span> (tempcopy)</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;      *(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>) = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;}</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;<span class="comment"> * \brief Gets the number of messages that exist in the inbox folder.</span></div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;<span class="comment"> * \param mailbox_context</span></div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;<span class="comment"> * \param newmsgs The variable that is updated with the count of new messages within this inbox.</span></div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;<span class="comment"> * \param oldmsgs The variable that is updated with the count of old messages within this inbox.</span></div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;<span class="comment"> * \param urgentmsgs The variable that is updated with the count of urgent messages within this inbox.</span></div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;<span class="comment"> * This method is used when IMAP backend is used.</span></div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;<span class="comment"> * Simultaneously determines the count of new,old, and urgent messages. The total messages would then be the sum of these three.</span></div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_context, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;{</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;   <span class="keywordtype">char</span> *mailboxnc;</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;   <span class="keywordtype">char</span> *mb;</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;   <span class="keywordtype">char</span> *cur;</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;   <span class="keywordflow">if</span> (newmsgs)</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;      *newmsgs = 0;</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;   <span class="keywordflow">if</span> (oldmsgs)</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;      *oldmsgs = 0;</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;   <span class="keywordflow">if</span> (urgentmsgs)</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;      *urgentmsgs = 0;</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Mailbox is set to %s\n&quot;</span>, mailbox_context);</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;   <span class="comment">/* If no mailbox, return immediately */</span></div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_context))</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox_context, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;   context = strchr(tmp, <span class="charliteral">&#39;@&#39;</span>);</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;   <span class="keywordflow">if</span> (strchr(mailbox_context, <span class="charliteral">&#39;,&#39;</span>)) {</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;      <span class="keywordtype">int</span> tmpnew, tmpold, tmpurgent;</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox_context, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;      mb = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;      <span class="keywordflow">while</span> ((cur = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;mb, <span class="stringliteral">&quot;, &quot;</span>))) {</div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cur)) {</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(cur, urgentmsgs ? &amp;tmpurgent : <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, newmsgs ? &amp;tmpnew : NULL, oldmsgs ? &amp;tmpold : NULL))</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;            <span class="keywordflow">else</span> {</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;               <span class="keywordflow">if</span> (newmsgs)</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;                  *newmsgs += tmpnew;</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;               <span class="keywordflow">if</span> (oldmsgs)</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;                  *oldmsgs += tmpold;</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;               <span class="keywordflow">if</span> (urgentmsgs)</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;                  *urgentmsgs += tmpurgent;</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;            }</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;         }</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;      }</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;   }</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;   <span class="keywordflow">if</span> (context) {</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;      *context = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;      mailboxnc = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;      context++;</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;      mailboxnc = (<span class="keywordtype">char</span> *) mailbox_context;</div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;   }</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;   <span class="keywordflow">if</span> (newmsgs) {</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, context, mailboxnc);</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;      <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t find mailbox %s in context %s\n&quot;</span>, mailboxnc, context);</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;      }</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;      <span class="keywordflow">if</span> ((*newmsgs = __messagecount(context, mailboxnc, vmu-&gt;imapfolder)) &lt; 0) {</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;      }</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;   }</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;   <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;      <span class="keywordflow">if</span> ((*oldmsgs = __messagecount(context, mailboxnc, <span class="stringliteral">&quot;Old&quot;</span>)) &lt; 0) {</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;      }</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;   }</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;   <span class="keywordflow">if</span> (urgentmsgs) {</div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;      <span class="keywordflow">if</span> ((*urgentmsgs = __messagecount(context, mailboxnc, <span class="stringliteral">&quot;Urgent&quot;</span>)) &lt; 0) {</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;      }</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;   }</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;}</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;<span class="comment">/**</span></div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;<span class="comment"> * \brief Determines if the given folder has messages.</span></div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;<span class="comment"> * \param mailbox The @ delimited string for user@context. If no context is found, uses &#39;default&#39; for the context.</span></div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;<span class="comment"> * \param folder the folder to look in</span></div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;<span class="comment"> * This function is used when the mailbox is stored in an IMAP back end.</span></div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;<span class="comment"> * This invokes the messagecount(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.</span></div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;<span class="comment"> * \return 1 if the folder has one or more messages. zero otherwise.</span></div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;{</div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[256], *tmp2, *box, *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;   tmp2 = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;   <span class="keywordflow">if</span> (strchr(tmp2, <span class="charliteral">&#39;,&#39;</span>) || strchr(tmp2, <span class="charliteral">&#39;&amp;&#39;</span>)) {</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;      <span class="keywordflow">while</span> ((box = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp2, <span class="stringliteral">&quot;,&amp;&quot;</span>))) {</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(box)) {</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a>(box, folder)) {</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;               <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;            }</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;         }</div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;      }</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;   }</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;   <span class="keywordflow">if</span> ((context = strchr(tmp, <span class="charliteral">&#39;@&#39;</span>))) {</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;      *context++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;   }</div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;   <span class="keywordflow">return</span> __messagecount(context, tmp, folder) ? 1 : 0;</div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;}</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;<span class="comment"> * \brief Copies a message from one mailbox to another.</span></div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;<span class="comment"> * \param imbox</span></div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;<span class="comment"> * \param msgnum</span></div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;<span class="comment"> * \param duration</span></div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;<span class="comment"> * \param recip</span></div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;<span class="comment"> * \param fmt</span></div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;<span class="comment"> * \param dir</span></div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;<span class="comment"> * This works with IMAP storage based mailboxes.</span></div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039">copy_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> imbox, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *recip, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *dir, <span class="keywordtype">char</span> *flag, <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_folder)</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;{</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *sendvms = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;   <span class="keywordtype">char</span> messagestring[10]; <span class="comment">/*I guess this could be a problem if someone has more than 999999999 messages...*/</span></div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt;= recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>) {</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to copy mail, mailbox %s is full\n&quot;</span>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;   }</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;   <span class="keywordflow">if</span> (!(sendvms = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0))) {</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t get vm_state for originator&#39;s mailbox!!\n&quot;</span>);</div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;   }</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;   <span class="keywordflow">if</span> (!get_vm_state_by_imapuser(recip-&gt;imapuser, 0)) {</div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t get vm_state for destination mailbox!\n&quot;</span>);</div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;   }</div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;   snprintf(messagestring, <span class="keyword">sizeof</span>(messagestring), <span class="stringliteral">&quot;%ld&quot;</span>, sendvms-&gt;msgArray[msgnum]);</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;sendvms-&gt;lock);</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;   <span class="keywordflow">if</span> ((mail_copy(sendvms-&gt;mailstream, messagestring, (<span class="keywordtype">char</span> *) <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, imbox)) == T)) {</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;sendvms-&gt;lock);</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;   }</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;sendvms-&gt;lock);</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;   <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to copy message from mailbox %s to mailbox %s\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;   <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;}</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;</div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> imap_mailbox_name(<span class="keywordtype">char</span> *spec, <span class="keywordtype">size_t</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box, <span class="keywordtype">int</span> use_folder)</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;{</div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[256], *t = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;   <span class="keywordtype">size_t</span> left = <span class="keyword">sizeof</span>(<a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>);</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;   <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>), <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, box), <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;   }</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;   <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>) {</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="stringliteral">&quot;vm-INBOX&quot;</span>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>));</div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;      snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, box));</div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;   }</div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;</div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;   <span class="comment">/* Build up server information */</span></div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a603020160399d4876ec09fd299ebcaf9">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;{%s:%s/imap&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vms-&gt;imapserver, imapserver), <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vms-&gt;imapport, imapport));</div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;</div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;   <span class="comment">/* Add authentication user if present */</span></div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(authuser))</div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a603020160399d4876ec09fd299ebcaf9">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/authuser=%s&quot;</span>, authuser);</div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;</div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;   <span class="comment">/* Add flags if present */</span></div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(imapflags) || !(<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vms-&gt;imapflags))) {</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a603020160399d4876ec09fd299ebcaf9">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/%s&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vms-&gt;imapflags, imapflags));</div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;   }</div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;   <span class="comment">/* End with username */</span></div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;<span class="preprocessor">#if 1</span></div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a603020160399d4876ec09fd299ebcaf9">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/user=%s}&quot;</span>, vms-&gt;imapuser);</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a603020160399d4876ec09fd299ebcaf9">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/user=%s/novalidate-cert}&quot;</span>, vms-&gt;imapuser);</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;   <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> || box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>)</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;      snprintf(spec, len, <span class="stringliteral">&quot;%s%s&quot;</span>, tmp, use_folder? vms-&gt;imapfolder: <span class="stringliteral">&quot;INBOX&quot;</span>);</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>)</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;      snprintf(spec, len, <span class="stringliteral">&quot;%s%s&quot;</span>, tmp, greetingfolder);</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;   <span class="keywordflow">else</span> {   <span class="comment">/* Other folders such as Friends, Family, etc... */</span></div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(imapparentfolder)) {</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;         <span class="comment">/* imapparentfolder would typically be set to INBOX */</span></div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;         snprintf(spec, len, <span class="stringliteral">&quot;%s%s%c%s&quot;</span>, tmp, imapparentfolder, delimiter, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, box));</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;         snprintf(spec, len, <span class="stringliteral">&quot;%s%s&quot;</span>, tmp, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, box));</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;      }</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;   }</div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;}</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> init_mailstream(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box)</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;{</div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;   MAILSTREAM *stream = NIL;</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;   <span class="keywordtype">long</span> <a class="code" href="../../dc/d6b/res__xmpp_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>;</div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[256];</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;</div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;   <span class="keywordflow">if</span> (!vms) {</div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;vm_state is NULL!\n&quot;</span>);</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;   }</div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;vm_state user is:%s\n&quot;</span>, vms-&gt;imapuser);</div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;mailstream == NIL || !vms-&gt;mailstream) {</div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;mailstream not set.\n&quot;</span>);</div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;      stream = vms-&gt;mailstream;</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;   }</div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;   <span class="comment">/* debug = T;  user wants protocol telemetry? */</span></div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;   debug = NIL;  <span class="comment">/* NO protocol telemetry? */</span></div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;</div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;   <span class="keywordflow">if</span> (delimiter == <span class="charliteral">&#39;\0&#39;</span>) {      <span class="comment">/* did not probe the server yet */</span></div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;      <span class="keywordtype">char</span> *cp;</div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;<span class="preprocessor">#ifdef USE_SYSTEM_IMAP</span></div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;<span class="preprocessor">#include &lt;imap/linkage.c&gt;</span></div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;<span class="preprocessor">#elif defined(USE_SYSTEM_CCLIENT)</span></div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;<span class="preprocessor">#include &lt;c-client/linkage.c&gt;</span></div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;<span class="preprocessor">#include &quot;linkage.c&quot;</span></div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;      <span class="comment">/* Connect to INBOX first to get folders delimiter */</span></div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;      imap_mailbox_name(tmp, <span class="keyword">sizeof</span>(tmp), vms, 0, 1);</div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;mail_open_lock);</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;      stream = mail_open (stream, tmp, debug ? OP_DEBUG : NIL);</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;mail_open_lock);</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;      <span class="keywordflow">if</span> (stream == NIL) {</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Can&#39;t connect to imap server %s\n&quot;</span>, tmp);</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;      }</div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;      get_mailbox_delimiter(vms, stream);</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;      <span class="comment">/* update delimiter in imapfolder */</span></div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;      <span class="keywordflow">for</span> (cp = vms-&gt;imapfolder; *cp; cp++)</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;         <span class="keywordflow">if</span> (*cp == <span class="charliteral">&#39;/&#39;</span>)</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;            *cp = delimiter;</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;   }</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;   <span class="comment">/* Now connect to the target folder */</span></div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;   imap_mailbox_name(tmp, <span class="keyword">sizeof</span>(tmp), vms, box, 1);</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Before mail_open, server: %s, box:%d\n&quot;</span>, tmp, box);</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;mail_open_lock);</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;   vms-&gt;mailstream = mail_open (stream, tmp, debug ? OP_DEBUG : NIL);</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;   <span class="comment">/* Create the folder if it dosn&#39;t exist */</span></div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;mailstream &amp;&amp; !mail_status(vms-&gt;mailstream, tmp, SA_UIDNEXT)) {</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;      mail_create(vms-&gt;mailstream, tmp);</div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;   }</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;mail_open_lock);</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;mailstream == NIL) {</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;   }</div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;}</div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;</div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box)</div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;{</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;   SEARCHPGM *pgm;</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;   SEARCHHEADER *hdr;</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;   <span class="keywordtype">int</span> urgent = 0;</div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;</div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;   <span class="comment">/* If Urgent, then look at INBOX */</span></div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;   <span class="keywordflow">if</span> (box == 11) {</div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;      box = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>;</div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;      urgent = 1;</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;   }</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;</div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;imapuser, vmu-&gt;imapuser, <span class="keyword">sizeof</span>(vms-&gt;imapuser));</div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;imapfolder, vmu-&gt;imapfolder, <span class="keyword">sizeof</span>(vms-&gt;imapfolder));</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;imapserver, vmu-&gt;imapserver, <span class="keyword">sizeof</span>(vms-&gt;imapserver));</div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;imapport, vmu-&gt;imapport, <span class="keyword">sizeof</span>(vms-&gt;imapport));</div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;imapflags, vmu-&gt;imapflags, <span class="keyword">sizeof</span>(vms-&gt;imapflags));</div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;   vms-&gt;imapversion = vmu-&gt;imapversion;</div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Before init_mailstream, user is %s\n&quot;</span>, vmu-&gt;imapuser);</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;   <span class="keywordflow">if</span> (init_mailstream(vms, box) || !vms-&gt;mailstream) {</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not initialize mailstream\n&quot;</span>);</div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;   }</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;   <span class="comment">/* Check Quota */</span></div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;   <span class="keywordflow">if</span>  (box == 0)  {</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Mailbox name set to: %s, about to check quotas\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;      check_quota(vms, (<span class="keywordtype">char</span> *) <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;   }</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;   pgm = mail_newsearchpgm();</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;</div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;   <span class="comment">/* Check IMAP folder for Asterisk messages only... */</span></div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;   hdr = mail_newsearchheader(<span class="stringliteral">&quot;X-Asterisk-VM-Extension&quot;</span>, (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>));</div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;   hdr-&gt;next = mail_newsearchheader(<span class="stringliteral">&quot;X-Asterisk-VM-Context&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;   pgm-&gt;header = hdr;</div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;   pgm-&gt;deleted = 0;</div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;   pgm-&gt;undeleted = 1;</div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;</div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;   <span class="comment">/* if box = NEW_FOLDER, check for new, if box = OLD_FOLDER, check for read */</span></div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;   <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> &amp;&amp; urgent == 1) {</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;      pgm-&gt;unseen = 1;</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;      pgm-&gt;seen = 0;</div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;      pgm-&gt;flagged = 1;</div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;      pgm-&gt;unflagged = 0;</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> &amp;&amp; urgent == 0) {</div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;      pgm-&gt;unseen = 1;</div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;      pgm-&gt;seen = 0;</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;      pgm-&gt;flagged = 0;</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;      pgm-&gt;unflagged = 1;</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;      pgm-&gt;seen = 1;</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;      pgm-&gt;unseen = 0;</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;   }</div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;</div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Before mail_search_full, user is %s\n&quot;</span>, vmu-&gt;imapuser);</div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;</div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;   vms-&gt;vmArrayIndex = 0;</div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;   mail_search_full (vms-&gt;mailstream, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pgm, NIL);</div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = vms-&gt;vmArrayIndex - 1;</div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;   mail_free_searchpgm(&amp;pgm);</div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;   <span class="comment">/* Since IMAP storage actually stores both old and new messages in the same IMAP folder,</span></div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;<span class="comment">    * ensure to allocate enough space to account for all of them. Warn if old messages</span></div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;<span class="comment">    * have not been checked first as that is required.</span></div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;   <span class="keywordflow">if</span> (box == 0 &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">dh_arraysize</a>) {</div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The code expects the old messages to be checked first, fix the code.\n&quot;</span>);</div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;   }</div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c38a20df9d7ac0e6aa6e1d9e18e5356">vm_allocate_dh</a>(vms, vmu, box == 0 ? vms-&gt;vmArrayIndex + vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> : vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)) {</div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;   }</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;}</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;</div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> write_file(<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len)</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;{</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;   FILE *output;</div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;</div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;   <span class="keywordflow">if</span> (!filename || !buffer) {</div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;   }</div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;</div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;   <span class="keywordflow">if</span> (!(output = fopen(filename, <span class="stringliteral">&quot;w&quot;</span>))) {</div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to open/create file %s: %s\n&quot;</span>, filename, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;   }</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;</div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;   <span class="keywordflow">if</span> (fwrite(buffer, len, 1, output) != 1) {</div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;      <span class="keywordflow">if</span> (ferror(output)) {</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Short write while writing e-mail body: %s.\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;      }</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;   }</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;   fclose (output);</div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;}</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;</div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> update_messages_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d8/dbc/structuser.html">user</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d6/d49/structnumber.html">number</a>)</div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;{</div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms = get_vm_state_by_imapuser(user, 1);</div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;</div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;   <span class="keywordflow">if</span> (!vms &amp;&amp; !(vms = get_vm_state_by_imapuser(user, 0))) {</div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;   }</div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;</div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;saving mailbox message number %lu as message %d. Interactive set to %d\n&quot;</span>, number, vms-&gt;vmArrayIndex, vms-&gt;interactive);</div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;</div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;   <span class="comment">/* Ensure we have room for the next message. */</span></div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;vmArrayIndex &gt;= vms-&gt;msg_array_max) {</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;      <span class="keywordtype">long</span> *new_mem = <a class="code" href="../../d8/d8a/astmm_8h.html#aa6bcdb74dc1508c22986f0adf171a0f2">ast_realloc</a>(vms-&gt;msgArray, 2 * vms-&gt;msg_array_max * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));</div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;      <span class="keywordflow">if</span> (!new_mem) {</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;         <span class="keywordflow">return</span>;</div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;      }</div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;      vms-&gt;msgArray = new_mem;</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;      vms-&gt;msg_array_max *= 2;</div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;   }</div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;</div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;   vms-&gt;msgArray[vms-&gt;vmArrayIndex++] = number;</div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;}</div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;</div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;<span class="keywordtype">void</span> mm_searched(MAILSTREAM *stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)</div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;{</div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;   <span class="keywordtype">char</span> *mailbox = stream-&gt;mailbox, <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[1024] = <span class="stringliteral">&quot;&quot;</span>, *<a class="code" href="../../dc/d12/res__config__ldap_8c.html#a930c15eddfe0826ff30e658c9d50b9b4">user</a>;</div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;</div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;   <span class="keywordflow">if</span> (!(user = get_user_by_mailbox(mailbox, <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>))))</div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;</div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;   update_messages_by_imapuser(user, number);</div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;}</div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;</div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *find_user_realtime_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *imapuser)</div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;{</div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;</div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;   vmu = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span> *vmu);</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;   <span class="keywordflow">if</span> (!vmu)</div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;   <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);</div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;</div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;   var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1a03993603e2bc2463153857836645bb">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;imapuser&quot;</span>, imapuser, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;   <span class="keywordflow">if</span> (var) {</div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f">apply_options_full</a>(vmu, var);</div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#adea5390496e5477192d86f340d512d04">ast_variables_destroy</a>(var);</div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;      <span class="keywordflow">return</span> vmu;</div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu);</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;   }</div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;}</div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;</div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;<span class="comment">/* Interfaces to C-client */</span></div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;</div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;<span class="keywordtype">void</span> mm_exists(MAILSTREAM * stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;{</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;   <span class="comment">/* mail_ping will callback here if new mail! */</span></div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;Entering EXISTS callback for message %ld\n&quot;</span>, number);</div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;   <span class="keywordflow">if</span> (number == 0) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;   set_update(stream);</div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;}</div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;</div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;</div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;<span class="keywordtype">void</span> mm_expunged(MAILSTREAM * stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)</div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;{</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;   <span class="comment">/* mail_ping will callback here if expunged mail! */</span></div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;Entering EXPUNGE callback for message %ld\n&quot;</span>, number);</div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;   <span class="keywordflow">if</span> (number == 0) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;   set_update(stream);</div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;}</div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;</div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;</div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;<span class="keywordtype">void</span> mm_flags(MAILSTREAM * stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)</div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;{</div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;   <span class="comment">/* mail_ping will callback here if read mail! */</span></div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;Entering FLAGS callback for message %ld\n&quot;</span>, number);</div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;   <span class="keywordflow">if</span> (number == 0) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;   set_update(stream);</div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;}</div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;</div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;</div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;<span class="keywordtype">void</span> mm_notify(MAILSTREAM * stream, <span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">long</span> errflg)</div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;{</div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Entering NOTIFY callback, errflag is %ld, string is %s\n&quot;</span>, errflg, <span class="keywordtype">string</span>);</div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;   mm_log (<span class="keywordtype">string</span>, errflg);</div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;}</div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;</div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;</div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;<span class="keywordtype">void</span> mm_list(MAILSTREAM * stream, <span class="keywordtype">int</span> delim, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">long</span> attributes)</div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;{</div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;   <span class="keywordflow">if</span> (delimiter == <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;      delimiter = delim;</div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;   }</div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;</div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Delimiter set to %c and mailbox %s\n&quot;</span>, delim, mailbox);</div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_NOINFERIORS)</div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;no inferiors\n&quot;</span>);</div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_NOSELECT)</div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;no select\n&quot;</span>);</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_MARKED)</div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;marked\n&quot;</span>);</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_UNMARKED)</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;unmarked\n&quot;</span>);</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;}</div><div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;</div><div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;</div><div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;<span class="keywordtype">void</span> mm_lsub(MAILSTREAM * stream, <span class="keywordtype">int</span> delim, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">long</span> attributes)</div><div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;{</div><div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Delimiter set to %c and mailbox %s\n&quot;</span>, delim, mailbox);</div><div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_NOINFERIORS)</div><div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;no inferiors\n&quot;</span>);</div><div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_NOSELECT)</div><div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;no select\n&quot;</span>);</div><div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_MARKED)</div><div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;marked\n&quot;</span>);</div><div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;   <span class="keywordflow">if</span> (attributes &amp; LATT_UNMARKED)</div><div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;unmarked\n&quot;</span>);</div><div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;}</div><div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;</div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;</div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;<span class="keywordtype">void</span> mm_status(MAILSTREAM * stream, <span class="keywordtype">char</span> *mailbox, MAILSTATUS * <a class="code" href="../../de/dcd/app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>)</div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;{</div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> *<a class="code" href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>;</div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;</div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8c/logger_8h.html#a33f6031de4ab6d1406465a7a3ee18e86">DEBUG_ATLEAST</a>(5) || !(str = <a class="code" href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a>(256))) {</div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;       <span class="keywordflow">return</span>;</div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;   }</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;</div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot; Mailbox %s&quot;</span>, mailbox);</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;   <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_MESSAGES) {</div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;, %lu messages&quot;</span>, status-&gt;messages);</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;   }</div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;   <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_RECENT) {</div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;, %lu recent&quot;</span>, status-&gt;recent);</div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;   }</div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;   <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_UNSEEN) {</div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;, %lu unseen&quot;</span>, status-&gt;unseen);</div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;   }</div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;   <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_UIDVALIDITY) {</div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;, %lu UID validity&quot;</span>, status-&gt;uidvalidity);</div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;   }</div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;   <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_UIDNEXT) {</div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;, %lu next UID&quot;</span>, status-&gt;uidnext);</div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;   }</div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;   <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str));</div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;</div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str);</div><div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;}</div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;</div><div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;</div><div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;<span class="keywordtype">void</span> mm_log(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">long</span> errflg)</div><div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;{</div><div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;   <span class="keywordflow">switch</span> ((<span class="keywordtype">short</span>) errflg) {</div><div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;      <span class="keywordflow">case</span> NIL:</div><div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;IMAP Info: %s\n&quot;</span>, <span class="keywordtype">string</span>);</div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;      <span class="keywordflow">case</span> PARSE:</div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;      <span class="keywordflow">case</span> WARN:</div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;IMAP Warning: %s\n&quot;</span>, <span class="keywordtype">string</span>);</div><div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="../../d1/d04/hash_8c.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>:</div><div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP Error: %s\n&quot;</span>, <span class="keywordtype">string</span>);</div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;   }</div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;}</div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;</div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;</div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;<span class="keywordtype">void</span> mm_dlog(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>)</div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;{</div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;   <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <span class="keywordtype">string</span>);</div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;}</div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;</div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;<span class="keywordtype">void</span> mm_login(NETMBX * mb, <span class="keywordtype">char</span> *user, <span class="keywordtype">char</span> *pwd, <span class="keywordtype">long</span> trial)</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;{</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;</div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;Entering callback mm_login\n&quot;</span>);</div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;</div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(user, mb-&gt;user, MAILTMPLEN);</div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;</div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;   <span class="comment">/* We should only do this when necessary */</span></div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(authpassword)) {</div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(pwd, authpassword, MAILTMPLEN);</div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;         <span class="keywordflow">if</span> (!strcasecmp(mb-&gt;user, vmu-&gt;imapuser)) {</div><div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(pwd, vmu-&gt;imappassword, MAILTMPLEN);</div><div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;         }</div><div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;      }</div><div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;      <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;         <span class="keywordflow">if</span> ((vmu = find_user_realtime_imapuser(mb-&gt;user))) {</div><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(pwd, vmu-&gt;imappassword, MAILTMPLEN);</div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;         }</div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;      }</div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;   }</div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;}</div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;</div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;</div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;<span class="keywordtype">void</span> mm_critical(MAILSTREAM * stream)</div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;{</div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;}</div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;</div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;</div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;<span class="keywordtype">void</span> mm_nocritical(MAILSTREAM * stream)</div><div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;{</div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;}</div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;</div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;<span class="keywordtype">long</span> mm_diskerror(MAILSTREAM * stream, <span class="keywordtype">long</span> errcode, <span class="keywordtype">long</span> serious)</div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;{</div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;   kill (getpid (), SIGSTOP);</div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;   <span class="keywordflow">return</span> NIL;</div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;}</div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;</div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;</div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;<span class="keywordtype">void</span> mm_fatal(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>)</div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;{</div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;   <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP access FATAL error: %s\n&quot;</span>, <span class="keywordtype">string</span>);</div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;}</div><div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;</div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="comment">/* C-client callback to handle quota */</span></div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> mm_parsequota(MAILSTREAM *stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *msg, QUOTALIST *pquota)</div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;{</div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;   <span class="keywordtype">char</span> *mailbox = stream-&gt;mailbox, *<a class="code" href="../../dc/d12/res__config__ldap_8c.html#a930c15eddfe0826ff30e658c9d50b9b4">user</a>;</div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[1024] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a> = 0, limit = 0;</div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;</div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;   <span class="keywordflow">while</span> (pquota) {</div><div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;      usage = pquota-&gt;usage;</div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;      limit = pquota-&gt;limit;</div><div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;      pquota = pquota-&gt;next;</div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;   }</div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;</div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;   <span class="keywordflow">if</span> (!(user = get_user_by_mailbox(mailbox, buf, <span class="keyword">sizeof</span>(buf))) || (!(vms = get_vm_state_by_imapuser(user, 2)) &amp;&amp; !(vms = get_vm_state_by_imapuser(user, 0)))) {</div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;No state found.\n&quot;</span>);</div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;   }</div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;</div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;User %s usage is %lu, limit is %lu\n&quot;</span>, user, usage, limit);</div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;</div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;   vms-&gt;quota_usage = <a class="code" href="../../d6/d47/utils_2frame_8c.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a>;</div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;   vms-&gt;quota_limit = limit;</div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;}</div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;</div><div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *get_header_by_tag(<span class="keywordtype">char</span> *<a class="code" href="../../d5/d65/structheader.html">header</a>, <span class="keywordtype">char</span> *tag, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>, <span class="keywordtype">size_t</span> len)</div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;{</div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;   <span class="keywordtype">char</span> *start, *eol_pnt;</div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;   <span class="keywordtype">int</span> taglen;</div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;</div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(header) || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(tag))</div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;</div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;   taglen = strlen(tag) + 1;</div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;   <span class="keywordflow">if</span> (taglen &lt; 1)</div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;</div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;   <span class="keywordflow">if</span> (!(start = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a0d78ab95e54db8c72a64038cfefb5161">strcasestr</a>(header, tag)))</div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;</div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;   <span class="comment">/* Since we can be called multiple times we should clear our buffer */</span></div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;   memset(buf, 0, len);</div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;</div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, start+taglen, len);</div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;   <span class="keywordflow">if</span> ((eol_pnt = strchr(buf,<span class="charliteral">&#39;\r&#39;</span>)) || (eol_pnt = strchr(buf,<span class="charliteral">&#39;\n&#39;</span>)))</div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;      *eol_pnt = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;}</div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;</div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *get_user_by_mailbox(<span class="keywordtype">char</span> *mailbox, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len)</div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;{</div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;   <span class="keywordtype">char</span> *start, *eol_pnt, *<a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a>;</div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;</div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox))</div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;</div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;   <span class="keywordflow">if</span> (!(start = strstr(mailbox, <span class="stringliteral">&quot;/user=&quot;</span>)))</div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;</div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, start+6, len);</div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;</div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;   <span class="keywordflow">if</span> (!(quote = strchr(buf, <span class="charliteral">&#39;&quot;&#39;</span>))) {</div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;      <span class="keywordflow">if</span> ((eol_pnt = strchr(buf, <span class="charliteral">&#39;/&#39;</span>)) || (eol_pnt = strchr(buf, <span class="charliteral">&#39;}&#39;</span>))) {</div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;         *eol_pnt = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;      }</div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;      <span class="keywordflow">if</span> ((eol_pnt = strchr(quote + 1, <span class="charliteral">&#39;&quot;&#39;</span>))) {</div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;         *eol_pnt = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;      }</div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;      <span class="keywordflow">return</span> quote + 1;</div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;   }</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;}</div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *create_vm_state_from_user(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;{</div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms_p;</div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;</div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;   pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);</div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;   <span class="keywordflow">if</span> ((vms_p = pthread_getspecific(ts_vmstate.key)) &amp;&amp; !strcmp(vms_p-&gt;imapuser, vmu-&gt;imapuser) &amp;&amp; !strcmp(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) {</div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;      <span class="keywordflow">return</span> vms_p;</div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;   }</div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Adding new vmstate for %s\n&quot;</span>, vmu-&gt;imapuser);</div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;   <span class="comment">/* XXX: Is this correctly freed always? */</span></div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;   <span class="keywordflow">if</span> (!(vms_p = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*vms_p))))</div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;imapuser, vmu-&gt;imapuser, <span class="keyword">sizeof</span>(vms_p-&gt;imapuser));</div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;imapfolder, vmu-&gt;imapfolder, <span class="keyword">sizeof</span>(vms_p-&gt;imapfolder));</div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;imapserver, vmu-&gt;imapserver, <span class="keyword">sizeof</span>(vms_p-&gt;imapserver));</div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;imapport, vmu-&gt;imapport, <span class="keyword">sizeof</span>(vms_p-&gt;imapport));</div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;imapflags, vmu-&gt;imapflags, <span class="keyword">sizeof</span>(vms_p-&gt;imapflags));</div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>)); <span class="comment">/* save for access from interactive entry point */</span></div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>));</div><div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;   vms_p-&gt;mailstream = NIL; <span class="comment">/* save for access from interactive entry point */</span></div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;   vms_p-&gt;imapversion = vmu-&gt;imapversion;</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Copied %s to %s\n&quot;</span>, vmu-&gt;imapuser, vms_p-&gt;imapuser);</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;   vms_p-&gt;updated = 1;</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;   <span class="comment">/* set mailbox to INBOX! */</span></div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, 0), <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));</div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;   init_vm_state(vms_p);</div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;   vmstate_insert(vms_p);</div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;   <span class="keywordflow">return</span> vms_p;</div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;}</div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;</div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *get_vm_state_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *user, <span class="keywordtype">int</span> interactive)</div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;{</div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;   <span class="keyword">struct </span>vmstate *vlist = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;</div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;   <span class="keywordflow">if</span> (interactive) {</div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;      pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);</div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;      <span class="keywordflow">if</span> ((vms = pthread_getspecific(ts_vmstate.key)) &amp;&amp; !strcmp(vms-&gt;imapuser, user)) {</div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;         <span class="keywordflow">return</span> vms;</div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;      }</div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;   }</div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;</div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;vmstates, vlist, list) {</div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;      <span class="keywordflow">if</span> (!vlist-&gt;vms) {</div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;error: vms is NULL for %s\n&quot;</span>, user);</div><div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;      }</div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;      <span class="keywordflow">if</span> (vlist-&gt;vms-&gt;imapversion != imapversion) {</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;      }</div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;</div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;      <span class="keywordflow">if</span> (!strcmp(vlist-&gt;vms-&gt;imapuser, user) &amp;&amp; (interactive == 2 || vlist-&gt;vms-&gt;interactive == interactive)) {</div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;         <span class="keywordflow">return</span> vlist-&gt;vms;</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;      }</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;   }</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;</div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;%s not found in vmstates\n&quot;</span>, user);</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;}</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *get_vm_state_by_mailbox(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keywordtype">int</span> interactive)</div><div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;{</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;   <span class="keyword">struct </span>vmstate *vlist = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *local_context = <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(context, <span class="stringliteral">&quot;default&quot;</span>);</div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;   <span class="keywordflow">if</span> (interactive) {</div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;      pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);</div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;      <span class="keywordflow">if</span> ((vms = pthread_getspecific(ts_vmstate.key)) &amp;&amp;</div><div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;          !strcmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>,mailbox) &amp;&amp; !strcmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, local_context)) {</div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;         <span class="keywordflow">return</span> vms;</div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;      }</div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;   }</div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;</div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;vmstates, vlist, list) {</div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;      <span class="keywordflow">if</span> (!vlist-&gt;vms) {</div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;error: vms is NULL for %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;      }</div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;      <span class="keywordflow">if</span> (vlist-&gt;vms-&gt;imapversion != imapversion) {</div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;      }</div><div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;</div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;comparing mailbox %s@%s (i=%d) to vmstate mailbox %s@%s (i=%d)\n&quot;</span>, mailbox, local_context, interactive, vlist-&gt;vms-&gt;username, vlist-&gt;vms-&gt;context, vlist-&gt;vms-&gt;interactive);</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;      <span class="keywordflow">if</span> (!strcmp(vlist-&gt;vms-&gt;username, mailbox) &amp;&amp; !strcmp(vlist-&gt;vms-&gt;context, local_context) &amp;&amp; vlist-&gt;vms-&gt;interactive == interactive) {</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Found it!\n&quot;</span>);</div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;         <span class="keywordflow">return</span> vlist-&gt;vms;</div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;      }</div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;   }</div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;%s not found in vmstates\n&quot;</span>, mailbox);</div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;</div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;}</div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;</div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_insert(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;{</div><div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;   <span class="keyword">struct </span>vmstate *v;</div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *altvms;</div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;   <span class="comment">/* If interactive, it probably already exists, and we should</span></div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;<span class="comment">      use the one we already have since it is more up to date.</span></div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;<span class="comment">      We can compare the username to find the duplicate */</span></div><div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;interactive == 1) {</div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;      altvms = get_vm_state_by_mailbox(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, 0);</div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;      <span class="keywordflow">if</span> (altvms) {</div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Duplicate mailbox %s, copying message info...\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = altvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;</div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = altvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;         vms-&gt;vmArrayIndex = altvms-&gt;vmArrayIndex;</div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;         <span class="comment">/* XXX: no msgArray copying? */</span></div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = altvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;</div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = altvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;</div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;         <span class="comment">/* get a pointer to the persistent store */</span></div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;         vms-&gt;persist_vms = altvms;</div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;         <span class="comment">/* Reuse the mailstream? */</span></div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;<span class="preprocessor">#ifdef REALLY_FAST_EVEN_IF_IT_MEANS_RESOURCE_LEAKS</span></div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;         vms-&gt;mailstream = altvms-&gt;mailstream;</div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;         vms-&gt;mailstream = NIL;</div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;      }</div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;   }</div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;   <span class="keywordflow">if</span> (!(v = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*v))))</div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;</div><div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;   v-&gt;vms = vms;</div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;</div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Inserting vm_state for user:%s, mailbox %s\n&quot;</span>, vms-&gt;imapuser, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;</div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a>(&amp;vmstates, v, list);</div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;}</div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;</div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_delete(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;{</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;   <span class="keyword">struct </span>vmstate *vc = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *altvms = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;</div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;   <span class="comment">/* If interactive, we should copy pertinent info</span></div><div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;<span class="comment">      back to the persistent state (to make update immediate) */</span></div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;interactive == 1 &amp;&amp; (altvms = vms-&gt;persist_vms)) {</div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Duplicate mailbox %s, copying message info...\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;      altvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;</div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;      altvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;</div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;      altvms-&gt;updated = 1;</div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;      vms-&gt;mailstream = mail_close(vms-&gt;mailstream);</div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;</div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;      <span class="comment">/* Interactive states are not stored within the persistent list */</span></div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;   }</div><div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Removing vm_state for user:%s, mailbox %s\n&quot;</span>, vms-&gt;imapuser, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;vmstates, vc, list) {</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;      <span class="keywordflow">if</span> (vc-&gt;vms == vms) {</div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c">AST_LIST_REMOVE_CURRENT</a>(list);</div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;      }</div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;   }</div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a></div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;vmstates);</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;   <span class="keywordflow">if</span> (vc) {</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ab8977a71822daa556f19f30ba6eec765">ast_mutex_destroy</a>(&amp;vc-&gt;vms-&gt;lock);</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vc-&gt;vms-&gt;msgArray);</div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;      vc-&gt;vms-&gt;msgArray = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;      vc-&gt;vms-&gt;msg_array_max = 0;</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;      <span class="comment">/* XXX: is no one supposed to free vms itself? */</span></div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vc);</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;No vmstate found for user:%s, mailbox %s\n&quot;</span>, vms-&gt;imapuser, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;   }</div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;}</div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;</div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> set_update(MAILSTREAM * stream)</div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;{</div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms;</div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;   <span class="keywordtype">char</span> *mailbox = stream-&gt;mailbox, *<a class="code" href="../../dc/d12/res__config__ldap_8c.html#a930c15eddfe0826ff30e658c9d50b9b4">user</a>;</div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;   <span class="keywordtype">char</span> buf[1024] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;</div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;   <span class="keywordflow">if</span> (!(user = get_user_by_mailbox(mailbox, buf, <span class="keyword">sizeof</span>(buf))) || !(vms = get_vm_state_by_imapuser(user, 0))) {</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;      <span class="keywordflow">if</span> (user &amp;&amp; <a class="code" href="../../d1/d8c/logger_8h.html#a33f6031de4ab6d1406465a7a3ee18e86">DEBUG_ATLEAST</a>(3))</div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;User %s mailbox not found for update.\n&quot;</span>, user);</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;   }</div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;User %s mailbox set for update.\n&quot;</span>, user);</div><div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;   vms-&gt;updated = 1; <span class="comment">/* Set updated flag since mailbox changed */</span></div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;}</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;</div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> init_vm_state(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;{</div><div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;   vms-&gt;msg_array_max = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a120b9c8ba5c2f37645d9d3683655e9f9">VMSTATE_MAX_MSG_ARRAY</a>;</div><div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;   vms-&gt;msgArray = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(vms-&gt;msg_array_max, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));</div><div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;msgArray) {</div><div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;      <span class="comment">/* Out of mem? This can&#39;t be good. */</span></div><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;      vms-&gt;msg_array_max = 0;</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;   }</div><div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;   vms-&gt;vmArrayIndex = 0;</div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a76e8ed6bb354be6c6dd9e51acc1d7a1b">ast_mutex_init</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;}</div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;</div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> save_body(BODY *body, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *section, <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>, <span class="keywordtype">int</span> is_intro)</div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;{</div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;   <span class="keywordtype">char</span> *body_content;</div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;   <span class="keywordtype">char</span> *body_decoded;</div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a> = is_intro ? vms-&gt;introfn : vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>;</div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len = 0;</div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> newlen = 0;</div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;   <span class="keywordtype">char</span> filename[256];</div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;</div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;   <span class="keywordflow">if</span> (!body || body == NIL)</div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;</div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;   body_content = mail_fetchbody(vms-&gt;mailstream, vms-&gt;msgArray[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>], section, &amp;len);</div><div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;   <span class="keywordflow">if</span> (len &gt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#abf5e7cf8ce333dece7920d64415b41d7">MAX_MAIL_BODY_CONTENT_SIZE</a>) {</div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>,</div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;         <span class="stringliteral">&quot;Msgno %ld, section %s. The body&#39;s content size %ld is huge (max %ld). User:%s, mailbox %s\n&quot;</span>,</div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;         vms-&gt;msgArray[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>], section, len, <a class="code" href="../../dc/df4/app__voicemail_8c.html#abf5e7cf8ce333dece7920d64415b41d7">MAX_MAIL_BODY_CONTENT_SIZE</a>, vms-&gt;imapuser, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;   }</div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;   <span class="keywordflow">if</span> (body_content != NIL &amp;&amp; len) {</div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;      snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.%s&quot;</span>, fn, format);</div><div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;      <span class="comment">/* ast_debug(1, body_content); */</span></div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;      body_decoded = rfc822_base64((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) body_content, len, &amp;newlen);</div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;      <span class="comment">/* If the body of the file is empty, return an error */</span></div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;      <span class="keywordflow">if</span> (!newlen || !body_decoded) {</div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;      }</div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;      write_file(filename, (<span class="keywordtype">char</span> *) body_decoded, newlen);</div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;Body of message is NULL.\n&quot;</span>);</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;   }</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;}</div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;<span class="comment"> * \brief Get delimiter via mm_list callback</span></div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;<span class="comment"> * \param vms     The voicemail state object</span></div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;<span class="comment"> * \param stream</span></div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;<span class="comment"> * Determines the delimiter character that is used by the underlying IMAP based mail store.</span></div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;<span class="comment">/* MUTEX should already be held */</span></div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> get_mailbox_delimiter(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, MAILSTREAM *stream) {</div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[50];</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;   snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;{%s}&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vms-&gt;imapserver, imapserver));</div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;   mail_list(stream, tmp, <span class="stringliteral">&quot;*&quot;</span>);</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;}</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;<span class="comment"> * \brief Check Quota for user</span></div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;<span class="comment"> * \param vms a pointer to a vm_state struct, will use the mailstream property of this.</span></div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;<span class="comment"> * \param mailbox the mailbox to check the quota for.</span></div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;<span class="comment"> * Calls imap_getquotaroot, which will populate its results into the vm_state vms input structure.</span></div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> check_quota(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *mailbox) {</div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;   mail_parameters(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, SET_QUOTA, (<span class="keywordtype">void</span> *) mm_parsequota);</div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Mailbox name set to: %s, about to check quotas\n&quot;</span>, mailbox);</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;   <span class="keywordflow">if</span> (vms &amp;&amp; vms-&gt;mailstream != <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;      imap_getquotaroot(vms-&gt;mailstream, mailbox);</div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Mailstream not available for mailbox: %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;   }</div><div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;}</div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;</div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* IMAP_STORAGE */</span><span class="preprocessor"></span></div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;<span class="comment">/*! \brief Lock file path</span></div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;<span class="comment"> * only return failure if ast_lock_path returns &#39;timeout&#39;,</span></div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;<span class="comment"> * not if the path does not exist or any other reason</span></div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03729"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1"> 3729</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;{</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;   <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a74c57b5a842dcbc15cc991a31f679a13">ast_lock_path</a>(path)) {</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a>:</div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;   <span class="keywordflow">default</span>:</div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;   }</div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;}</div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;</div><div class="line"><a name="l03739"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0"> 3739</a></span>&#160;<span class="preprocessor">#define MSG_ID_LEN 256</span></div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;</div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;<span class="comment">/* Used to attach a unique identifier to an msg_id */</span></div><div class="line"><a name="l03742"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2033797bc323fad1d911cd46640e3fdd"> 3742</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2033797bc323fad1d911cd46640e3fdd">msg_id_incrementor</a>;</div><div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;<span class="comment"> * \brief Sets the destination string to a uniquely identifying msg_id string</span></div><div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;<span class="comment"> * \param dst pointer to a character buffer that should contain MSG_ID_LEN characters.</span></div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(<span class="keywordtype">char</span> *dst);</div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;</div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;<span class="keyword">struct </span>generic_prepare_struct {</div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;   <span class="keywordtype">char</span> *sql;</div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;   <span class="keywordtype">int</span> argc;</div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;   <span class="keywordtype">char</span> **argv;</div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;};</div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;<span class="keyword">static</span> SQLHSTMT <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj, <span class="keywordtype">void</span> *data)</div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;{</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct *gps = data;</div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;   <span class="keywordtype">int</span> res, i;</div><div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;</div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;   res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;<a class="code" href="../../df/d36/structodbc__obj.html#ae83918cc26dc7acd65bbec1712593054">con</a>, &amp;stmt);</div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Alloc Handle failed!\n&quot;</span>);</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;   }</div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;   res = <a class="code" href="../../de/d96/res__odbc_8h.html#a6c76549f7fd9feafdca9bf90f57f224a">ast_odbc_prepare</a>(obj, stmt, gps-&gt;sql);</div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Prepare failed![%s]\n&quot;</span>, gps-&gt;sql);</div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;   }</div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; gps-&gt;argc; i++)</div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;      SQLBindParameter(stmt, i + 1, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(gps-&gt;argv[i]), 0, gps-&gt;argv[i], 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;</div><div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;   <span class="keywordflow">return</span> stmt;</div><div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;}</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> odbc_update_msg_id(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msg_num, <span class="keywordtype">char</span> *msg_id)</div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;{</div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;   <span class="keywordtype">char</span> msg_num_str[20];</div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;   <span class="keywordtype">char</span> *argv[] = { msg_id, dir, msg_num_str };</div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 3, .argv = argv };</div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;</div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to update message ID for message %d in %s\n&quot;</span>, msg_num, dir);</div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;   }</div><div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;</div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;   snprintf(msg_num_str, <span class="keyword">sizeof</span>(msg_num_str), <span class="stringliteral">&quot;%d&quot;</span>, msg_num);</div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;UPDATE %s SET msg_id=? WHERE dir=? AND msgnum=?&quot;</span>, odbc_table);</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;   }</div><div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;}</div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;<span class="comment"> * \brief Retrieves a file from an ODBC data store.</span></div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;<span class="comment"> * \param dir the path to the file to be retrieved.</span></div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;<span class="comment"> * \param msgnum the message number, such as within a mailbox folder.</span></div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;<span class="comment"> * This method is used by the RETRIEVE macro when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;<span class="comment"> * The purpose is to get the message from the database store to the local file system, so that the message may be played, or the information file may be read.</span></div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;<span class="comment"> * The file is looked up by invoking a SQL on the odbc_table (default &#39;voicemessages&#39;) using the dir and msgnum input parameters.</span></div><div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;<span class="comment"> * The output is the message information file with the name msgnum and the extension .txt</span></div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;<span class="comment"> * and the message file with the extension of its format, in the directory with base file name of the msgnum.</span></div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;<span class="comment"> * \return 0 on success, -1 on error.</span></div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> retrieve_file(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;{</div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;   <span class="keywordtype">int</span> x = 0;</div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;   <span class="keywordtype">int</span> fd = -1;</div><div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;   <span class="keywordtype">size_t</span> fdlen = 0;</div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;   <span class="keywordtype">void</span> *fdm = MAP_FAILED;</div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;   SQLSMALLINT colcount = 0;</div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;   <span class="keywordtype">char</span> fmt[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>;</div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;   <span class="keywordtype">char</span> coltitle[256];</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;   SQLSMALLINT collen;</div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;   SQLSMALLINT datatype;</div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;   SQLSMALLINT decimaldigits;</div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;   SQLSMALLINT nullable;</div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;   SQLULEN colsize;</div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;   SQLLEN colsize2;</div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;   FILE *f = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;   <span class="keywordtype">char</span> rowdata[80];</div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;   <span class="keywordtype">char</span> full_fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;   <span class="keywordtype">char</span> msgnums[80];</div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;   <span class="keywordtype">char</span> msg_id[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;   <span class="keywordtype">char</span> *argv[] = { dir, msgnums };</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;   }</div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;</div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fmt, vmfmts, <span class="keyword">sizeof</span>(fmt));</div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;   c = strchr(fmt, <span class="charliteral">&#39;|&#39;</span>);</div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;   <span class="keywordflow">if</span> (c)</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;      *c = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(fmt, <span class="stringliteral">&quot;wav49&quot;</span>))</div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;      strcpy(fmt, <span class="stringliteral">&quot;WAV&quot;</span>);</div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;</div><div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;   snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1)</div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;   <span class="comment">/* Create the information file */</span></div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;   snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);</div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;   <span class="keywordflow">if</span> (!(f = fopen(full_fn, <span class="stringliteral">&quot;w+&quot;</span>))) {</div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open/create &#39;%s&#39;\n&quot;</span>, full_fn);</div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;      <span class="keywordflow">goto</span> bail;</div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;   }</div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;   snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.%s&quot;</span>, fn, fmt);</div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT * FROM %s WHERE dir=? AND msgnum=?&quot;</span>, odbc_table);</div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;</div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;      <span class="keywordflow">goto</span> bail;</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;   }</div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;   res = SQLFetch(stmt);</div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;      <span class="keywordflow">if</span> (res != SQL_NO_DATA) {</div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;      }</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;   }</div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;</div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;   fd = open(full_fn, O_RDWR | O_CREAT | O_TRUNC, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>);</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;   <span class="keywordflow">if</span> (fd &lt; 0) {</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write &#39;%s&#39;: %s\n&quot;</span>, full_fn, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;   }</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;</div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;   res = SQLNumResultCols(stmt, &amp;colcount);</div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Column Count error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;   }</div><div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;</div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;   fprintf(f, <span class="stringliteral">&quot;[message]\n&quot;</span>);</div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; colcount; x++) {</div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;      rowdata[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;      colsize = 0;</div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;      collen = <span class="keyword">sizeof</span>(coltitle);</div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;      res = SQLDescribeCol(stmt, x + 1, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) coltitle, <span class="keyword">sizeof</span>(coltitle), &amp;collen,</div><div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;                     &amp;datatype, &amp;colsize, &amp;decimaldigits, &amp;nullable);</div><div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;      <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Describe Column error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;         <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;      }</div><div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(coltitle, <span class="stringliteral">&quot;recording&quot;</span>)) {</div><div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;         off_t offset;</div><div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;         res = SQLGetData(stmt, x + 1, SQL_BINARY, rowdata, 0, &amp;colsize2);</div><div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;         fdlen = colsize2;</div><div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;         <span class="keywordflow">if</span> (fd &gt; -1) {</div><div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;            <span class="keywordtype">char</span> <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[1] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;            lseek(fd, fdlen - 1, SEEK_SET);</div><div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;            <span class="keywordflow">if</span> (write(fd, tmp, 1) != 1) {</div><div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;               close(fd);</div><div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;               fd = -1;</div><div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;               <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;            }</div><div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;            <span class="comment">/* Read out in small chunks */</span></div><div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;            <span class="keywordflow">for</span> (offset = 0; offset &lt; colsize2; offset += <a class="code" href="../../dc/df4/app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>) {</div><div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;               <span class="keywordflow">if</span> ((fdm = mmap(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, offset)) == MAP_FAILED) {</div><div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Could not mmap the output file: %s (%d)\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>), <a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>);</div><div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;                  <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;               }</div><div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;               res = SQLGetData(stmt, x + 1, SQL_BINARY, fdm, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;               munmap(fdm, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>);</div><div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;               <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;                  unlink(full_fn);</div><div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;                  <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;               }</div><div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;            }</div><div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;            <span class="keywordflow">if</span> (truncate(full_fn, fdlen) &lt; 0) {</div><div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to truncate &#39;%s&#39;: %s\n&quot;</span>, full_fn, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;            }</div><div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;         }</div><div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;         res = SQLGetData(stmt, x + 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;         <span class="keywordflow">if</span> (res == SQL_NULL_DATA &amp;&amp; !strcasecmp(coltitle, <span class="stringliteral">&quot;msg_id&quot;</span>)) {</div><div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;            <span class="comment">/* Generate msg_id now, but don&#39;t store it until we&#39;re done with this</span></div><div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;<span class="comment">               connection */</span></div><div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(msg_id);</div><div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;            snprintf(rowdata, <span class="keyword">sizeof</span>(rowdata), <span class="stringliteral">&quot;%s&quot;</span>, msg_id);</div><div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == SQL_NULL_DATA &amp;&amp; !strcasecmp(coltitle, <span class="stringliteral">&quot;category&quot;</span>)) {</div><div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;            <span class="comment">/* Ignore null column value for category */</span></div><div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Ignoring null category column in ODBC voicemail retrieve_file.\n&quot;</span>);</div><div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error! coltitle=%s\n[%s]\n\n&quot;</span>, coltitle, sql);</div><div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;            <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;         }</div><div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;         <span class="keywordflow">if</span> (strcasecmp(coltitle, <span class="stringliteral">&quot;msgnum&quot;</span>) &amp;&amp; strcasecmp(coltitle, <span class="stringliteral">&quot;dir&quot;</span>)) {</div><div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;            fprintf(f, <span class="stringliteral">&quot;%s=%s\n&quot;</span>, coltitle, rowdata);</div><div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;         }</div><div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;      }</div><div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;   }</div><div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;</div><div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;bail_with_handle:</div><div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;   SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;</div><div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;bail:</div><div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;   <span class="keywordflow">if</span> (f)</div><div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;      fclose(f);</div><div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;   <span class="keywordflow">if</span> (fd &gt; -1)</div><div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;      close(fd);</div><div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;</div><div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;</div><div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;   <span class="comment">/* If res_odbc is configured to only allow a single database connection, we</span></div><div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;<span class="comment">      will deadlock if we try to do this before releasing the connection we</span></div><div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;<span class="comment">      were just using. */</span></div><div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(msg_id)) {</div><div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;      odbc_update_msg_id(dir, msgnum, msg_id);</div><div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;   }</div><div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;</div><div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;   <span class="keywordflow">return</span> x - 1;</div><div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;}</div><div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;<span class="comment"> * \brief Determines the highest message number in use for a given user and mailbox folder.</span></div><div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;<span class="comment"> * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.</span></div><div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;<span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;<span class="comment"> * Typical use to set the msgnum would be to take the value returned from this method and add one to it.</span></div><div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;<span class="comment"> * \return the value of zero or greater to indicate the last message index in use, -1 to indicate none.</span></div><div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)</div><div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;{</div><div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;   <span class="keywordtype">int</span> x = -1;</div><div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;   <span class="keywordtype">char</span> rowdata[20];</div><div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;   <span class="keywordtype">char</span> *argv[] = { dir };</div><div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 1, .argv = argv };</div><div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;</div><div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;   }</div><div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;</div><div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT msgnum FROM %s WHERE dir=? order by msgnum desc&quot;</span>, odbc_table);</div><div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;</div><div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;      <span class="keywordflow">goto</span> bail;</div><div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;   }</div><div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;</div><div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;   res = SQLFetch(stmt);</div><div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;      <span class="keywordflow">if</span> (res == SQL_NO_DATA) {</div><div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a739c2b2152120f3ac341424b9a595562">AST_LOG_DEBUG</a>, <span class="stringliteral">&quot;Directory &#39;%s&#39; has no messages and therefore no index was retrieved.\n&quot;</span>, dir);</div><div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;      }</div><div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;   }</div><div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;</div><div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;   res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;   }</div><div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;</div><div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;   <span class="keywordflow">if</span> (sscanf(rowdata, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) != 1) {</div><div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to read message index!\n&quot;</span>);</div><div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;   }</div><div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;</div><div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;bail_with_handle:</div><div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;   SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;</div><div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;bail:</div><div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;</div><div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;   <span class="keywordflow">return</span> x;</div><div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;}</div><div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;<span class="comment"> * \brief Determines if the specified message exists.</span></div><div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;<span class="comment"> * \param dir the folder the mailbox folder to look for messages.</span></div><div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;<span class="comment"> * \param msgnum the message index to query for.</span></div><div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;<span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;<span class="comment"> * \return greater than zero if the message exists, zero when the message does not exist or on error.</span></div><div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> message_exists(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;{</div><div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;   <span class="keywordtype">int</span> x = 0;</div><div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;   <span class="keywordtype">char</span> rowdata[20];</div><div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;   <span class="keywordtype">char</span> msgnums[20];</div><div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;   <span class="keywordtype">char</span> *argv[] = { dir, msgnums };</div><div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };</div><div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;</div><div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;   }</div><div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;</div><div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;   snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);</div><div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir=? AND msgnum=?&quot;</span>, odbc_table);</div><div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;      <span class="keywordflow">goto</span> bail;</div><div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;   }</div><div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;</div><div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;   res = SQLFetch(stmt);</div><div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;   }</div><div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;</div><div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;   res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;   }</div><div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;</div><div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;   <span class="keywordflow">if</span> (sscanf(rowdata, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) != 1) {</div><div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to read message count!\n&quot;</span>);</div><div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;   }</div><div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;</div><div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;bail_with_handle:</div><div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;   SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;</div><div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;bail:</div><div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;   <span class="keywordflow">return</span> x;</div><div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;}</div><div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;<span class="comment"> * \brief returns the number of messages found.</span></div><div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;<span class="comment"> * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.</span></div><div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;<span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;<span class="comment"> * \return The count of messages being zero or more, less than zero on error.</span></div><div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)</div><div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;{</div><div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;   <span class="keywordtype">int</span> x = -1;</div><div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;   <span class="keywordtype">char</span> rowdata[20];</div><div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;   <span class="keywordtype">char</span> *argv[] = { dir };</div><div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 1, .argv = argv };</div><div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;</div><div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;   }</div><div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;</div><div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir=?&quot;</span>, odbc_table);</div><div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;      <span class="keywordflow">goto</span> bail;</div><div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;   }</div><div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;</div><div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;   res = SQLFetch(stmt);</div><div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;   }</div><div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;</div><div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;   res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;   }</div><div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;</div><div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;   <span class="keywordflow">if</span> (sscanf(rowdata, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) != 1) {</div><div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to read message count!\n&quot;</span>);</div><div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;   }</div><div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;</div><div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;bail_with_handle:</div><div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;   SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;</div><div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;bail:</div><div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;   <span class="keywordflow">return</span> x;</div><div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;}</div><div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;<span class="comment"> * \brief Deletes a message from the mailbox folder.</span></div><div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;<span class="comment"> * \param sdir The mailbox folder to work in.</span></div><div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;<span class="comment"> * \param smsg The message index to be deleted.</span></div><div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;<span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;<span class="comment"> * The specified message is directly deleted from the database &#39;voicemessages&#39; table.</span></div><div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;<span class="comment"> * \return the value greater than zero on success to indicate the number of messages, less than zero on error.</span></div><div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de9/res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sdir, <span class="keywordtype">int</span> smsg)</div><div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;{</div><div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;   <span class="keywordtype">char</span> msgnums[20];</div><div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;   <span class="keywordtype">char</span> *argv[] = { <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, msgnums };</div><div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };</div><div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;</div><div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;   }</div><div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;</div><div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;   argv[0] = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(sdir);</div><div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;</div><div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;   snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, smsg);</div><div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM %s WHERE dir=? AND msgnum=?&quot;</span>, odbc_table);</div><div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;   }</div><div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;</div><div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;}</div><div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;<span class="comment"> * \brief Copies a voicemail from one mailbox to another.</span></div><div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;<span class="comment"> * \param sdir the folder for which to look for the message to be copied.</span></div><div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;<span class="comment"> * \param smsg the index of the message to be copied.</span></div><div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;<span class="comment"> * \param ddir the destination folder to copy the message into.</span></div><div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;<span class="comment"> * \param dmsg the index to be used for the copied message.</span></div><div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;<span class="comment"> * \param dmailboxuser The user who owns the mailbox tha contains the destination folder.</span></div><div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;<span class="comment"> * \param dmailboxcontext The context for the destination user.</span></div><div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;<span class="comment"> * This method is used for the COPY macro when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> copy_file(<span class="keywordtype">char</span> *sdir, <span class="keywordtype">int</span> smsg, <span class="keywordtype">char</span> *ddir, <span class="keywordtype">int</span> dmsg, <span class="keywordtype">char</span> *dmailboxuser, <span class="keywordtype">char</span> *dmailboxcontext)</div><div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;{</div><div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;   <span class="keywordtype">char</span> sql[512];</div><div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;   <span class="keywordtype">char</span> msgnums[20];</div><div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;   <span class="keywordtype">char</span> msgnumd[20];</div><div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;   <span class="keywordtype">char</span> msg_id[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a>];</div><div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;   <span class="keywordtype">char</span> *argv[] = { ddir, msgnumd, msg_id, dmailboxuser, dmailboxcontext, sdir, msgnums };</div><div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 7, .argv = argv };</div><div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;</div><div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(msg_id);</div><div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;   <a class="code" href="../../d9/de9/res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(ddir, dmsg);</div><div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;   }</div><div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;</div><div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;   snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, smsg);</div><div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;   snprintf(msgnumd, <span class="keyword">sizeof</span>(msgnumd), <span class="stringliteral">&quot;%d&quot;</span>, dmsg);</div><div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO %s (dir, msgnum, msg_id, context, macrocontext, callerid, origtime, duration, recording, flag, mailboxuser, mailboxcontext) SELECT ?,?,?,context,macrocontext,callerid,origtime,duration,recording,flag,?,? FROM %s WHERE dir=? AND msgnum=?&quot;</span>, odbc_table, odbc_table);</div><div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;   <span class="keywordflow">if</span> (!stmt)</div><div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s] (You probably don&#39;t have MySQL 4.1 or later installed)\n\n&quot;</span>, sql);</div><div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;</div><div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;}</div><div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;</div><div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;<span class="keyword">struct </span>insert_data {</div><div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;   <span class="keywordtype">char</span> *sql;</div><div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *dir;</div><div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msgnums;</div><div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;   <span class="keywordtype">void</span> *data;</div><div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;   SQLLEN datalen;</div><div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;   SQLLEN indlen;</div><div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *macrocontext;</div><div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid;</div><div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime;</div><div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *duration;</div><div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser;</div><div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext;</div><div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *category;</div><div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>;</div><div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id;</div><div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;};</div><div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;</div><div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;<span class="keyword">static</span> SQLHSTMT insert_data_cb(<span class="keyword">struct</span> <a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj, <span class="keywordtype">void</span> *vdata)</div><div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;{</div><div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;   <span class="keyword">struct </span>insert_data *data = vdata;</div><div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;</div><div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;   res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;<a class="code" href="../../df/d36/structodbc__obj.html#ae83918cc26dc7acd65bbec1712593054">con</a>, &amp;stmt);</div><div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Alloc Handle failed!\n&quot;</span>);</div><div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;   }</div><div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;</div><div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;   SQLBindParameter(stmt, 1, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;dir), 0, (<span class="keywordtype">void</span> *) data-&gt;dir, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;   SQLBindParameter(stmt, 2, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;msgnums), 0, (<span class="keywordtype">void</span> *) data-&gt;msgnums, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;   SQLBindParameter(stmt, 3, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_LONGVARBINARY, data-&gt;datalen, 0, (<span class="keywordtype">void</span> *) data-&gt;data, data-&gt;datalen, &amp;data-&gt;indlen);</div><div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;   SQLBindParameter(stmt, 4, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;context), 0, (<span class="keywordtype">void</span> *) data-&gt;context, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;   SQLBindParameter(stmt, 5, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;macrocontext), 0, (<span class="keywordtype">void</span> *) data-&gt;macrocontext, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;   SQLBindParameter(stmt, 6, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;callerid), 0, (<span class="keywordtype">void</span> *) data-&gt;callerid, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;   SQLBindParameter(stmt, 7, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;origtime), 0, (<span class="keywordtype">void</span> *) data-&gt;origtime, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;   SQLBindParameter(stmt, 8, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;duration), 0, (<span class="keywordtype">void</span> *) data-&gt;duration, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;   SQLBindParameter(stmt, 9, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;mailboxuser), 0, (<span class="keywordtype">void</span> *) data-&gt;mailboxuser, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;   SQLBindParameter(stmt, 10, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;mailboxcontext), 0, (<span class="keywordtype">void</span> *) data-&gt;mailboxcontext, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;   SQLBindParameter(stmt, 11, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;flag), 0, (<span class="keywordtype">void</span> *) data-&gt;flag, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;   SQLBindParameter(stmt, 12, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;msg_id), 0, (<span class="keywordtype">void</span> *) data-&gt;msg_id, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(data-&gt;category)) {</div><div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;      SQLBindParameter(stmt, 13, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;category), 0, (<span class="keywordtype">void</span> *) data-&gt;category, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;   }</div><div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;   res = <a class="code" href="../../de/d96/res__odbc_8h.html#ac4f32679338ee77cd43a130162456dbb">ast_odbc_execute_sql</a>(obj, stmt, data-&gt;sql);</div><div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Direct Execute failed!\n&quot;</span>);</div><div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;   }</div><div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;</div><div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;   <span class="keywordflow">return</span> stmt;</div><div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;}</div><div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;<span class="comment"> * \brief Stores a voicemail into the database.</span></div><div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;<span class="comment"> * \param dir the folder the mailbox folder to store the message.</span></div><div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;<span class="comment"> * \param mailboxuser the user owning the mailbox folder.</span></div><div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;<span class="comment"> * \param mailboxcontext</span></div><div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;<span class="comment"> * \param msgnum the message index for the message to be stored.</span></div><div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;<span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;<span class="comment"> * The message sound file and information file is looked up on the file system.</span></div><div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;<span class="comment"> * A SQL query is invoked to store the message into the (MySQL) database.</span></div><div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;<span class="comment"> * \return the zero on success -1 on error.</span></div><div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> store_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;{</div><div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;   <span class="keywordtype">int</span> fd = -1;</div><div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;   <span class="keywordtype">void</span> *fdm = MAP_FAILED;</div><div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;   off_t fdlen = -1;</div><div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;   <span class="keywordtype">char</span> msgnums[20];</div><div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;   <span class="keywordtype">char</span> full_fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;   <span class="keywordtype">char</span> fmt[80]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>;</div><div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;   <span class="keyword">struct </span>insert_data idata = { .sql = sql, .msgnums = msgnums, .dir = dir, .mailboxuser = mailboxuser, .mailboxcontext = mailboxcontext,</div><div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;      .context = <span class="stringliteral">&quot;&quot;</span>, .macrocontext = <span class="stringliteral">&quot;&quot;</span>, .callerid = <span class="stringliteral">&quot;&quot;</span>, .origtime = <span class="stringliteral">&quot;&quot;</span>, .duration = <span class="stringliteral">&quot;&quot;</span>, .category = <span class="stringliteral">&quot;&quot;</span>, .flag = <span class="stringliteral">&quot;&quot;</span>, .msg_id = <span class="stringliteral">&quot;&quot;</span> };</div><div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;</div><div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;   <a class="code" href="../../d9/de9/res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(dir, msgnum);</div><div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;</div><div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;   }</div><div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;</div><div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;   <span class="keywordflow">do</span> {</div><div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fmt, vmfmts, <span class="keyword">sizeof</span>(fmt));</div><div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;      c = strchr(fmt, <span class="charliteral">&#39;|&#39;</span>);</div><div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;      <span class="keywordflow">if</span> (c)</div><div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;         *c = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(fmt, <span class="stringliteral">&quot;wav49&quot;</span>))</div><div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;         strcpy(fmt, <span class="stringliteral">&quot;WAV&quot;</span>);</div><div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;      snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);</div><div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;      <span class="keywordflow">if</span> (msgnum &gt; -1)</div><div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);</div><div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));</div><div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;      snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);</div><div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;      cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(full_fn, config_flags);</div><div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;      snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.%s&quot;</span>, fn, fmt);</div><div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;      fd = open(full_fn, O_RDWR);</div><div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;      <span class="keywordflow">if</span> (fd &lt; 0) {</div><div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Open of sound file &#39;%s&#39; failed: %s\n&quot;</span>, full_fn, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;         res = -1;</div><div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;      }</div><div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(cfg)) {</div><div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;         <span class="keywordflow">if</span> (!(idata.context = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>))) {</div><div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;            idata.context = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;         }</div><div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;         <span class="keywordflow">if</span> (!(idata.macrocontext = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;macrocontext&quot;</span>))) {</div><div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;            idata.macrocontext = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;         }</div><div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;         <span class="keywordflow">if</span> (!(idata.callerid = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {</div><div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;            idata.callerid = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;         }</div><div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;         <span class="keywordflow">if</span> (!(idata.origtime = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {</div><div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;            idata.origtime = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;         }</div><div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;         <span class="keywordflow">if</span> (!(idata.duration = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {</div><div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;            idata.duration = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;         }</div><div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;         <span class="keywordflow">if</span> (!(idata.category = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;category&quot;</span>))) {</div><div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;            idata.category = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;         }</div><div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;         <span class="keywordflow">if</span> (!(idata.flag = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;flag&quot;</span>))) {</div><div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;            idata.flag = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;         }</div><div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;         <span class="keywordflow">if</span> (!(idata.msg_id = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;msg_id&quot;</span>))) {</div><div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;            idata.msg_id = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;         }</div><div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;      }</div><div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;      fdlen = lseek(fd, 0, SEEK_END);</div><div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;      <span class="keywordflow">if</span> (fdlen &lt; 0 || lseek(fd, 0, SEEK_SET) &lt; 0) {</div><div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to process sound file &#39;%s&#39;: %s\n&quot;</span>, full_fn, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;         res = -1;</div><div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;      }</div><div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;      fdm = mmap(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fdlen, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);</div><div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;      <span class="keywordflow">if</span> (fdm == MAP_FAILED) {</div><div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Memory map failed for sound file &#39;%s&#39;!\n&quot;</span>, full_fn);</div><div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;         res = -1;</div><div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;      }</div><div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;      idata.data = fdm;</div><div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;      idata.datalen = idata.indlen = fdlen;</div><div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;</div><div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(idata.category))</div><div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;         snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO %s (dir,msgnum,recording,context,macrocontext,callerid,origtime,duration,mailboxuser,mailboxcontext,flag,msg_id,category) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;</span>, odbc_table);</div><div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;         snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO %s (dir,msgnum,recording,context,macrocontext,callerid,origtime,duration,mailboxuser,mailboxcontext,flag,msg_id) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)&quot;</span>, odbc_table);</div><div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;</div><div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(idata.origtime)) {</div><div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;         idata.origtime = <span class="stringliteral">&quot;0&quot;</span>;</div><div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;      }</div><div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;</div><div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(idata.duration)) {</div><div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;         idata.duration = <span class="stringliteral">&quot;0&quot;</span>;</div><div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;      }</div><div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;</div><div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;      <span class="keywordflow">if</span> ((stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ac29fe8d9aba364c43aa8b5c47e48587e">ast_odbc_direct_execute</a>(obj, insert_data_cb, &amp;idata))) {</div><div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;         SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;         res = -1;</div><div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;      }</div><div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;   } <span class="keywordflow">while</span> (0);</div><div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;</div><div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;</div><div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(cfg))</div><div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;   <span class="keywordflow">if</span> (fdm != MAP_FAILED)</div><div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;      munmap(fdm, fdlen);</div><div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;   <span class="keywordflow">if</span> (fd &gt; -1)</div><div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;      close(fd);</div><div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;}</div><div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;<span class="comment"> * \brief Renames a message in a mailbox folder.</span></div><div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;<span class="comment"> * \param sdir The folder of the message to be renamed.</span></div><div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;<span class="comment"> * \param smsg The index of the message to be renamed.</span></div><div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;<span class="comment"> * \param mailboxuser The user to become the owner of the message after it is renamed. Usually this will be the same as the original owner.</span></div><div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;<span class="comment"> * \param mailboxcontext The context to be set for the message. Usually this will be the same as the original context.</span></div><div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;<span class="comment"> * \param ddir The destination folder for the message to be renamed into</span></div><div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;<span class="comment"> * \param dmsg The destination message for the message to be renamed.</span></div><div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;<span class="comment"> * This method is used by the RENAME macro when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;<span class="comment"> * The is usually used to resequence the messages in the mailbox, such as to delete messag index 0, it would be called successively to slide all the other messages down one index.</span></div><div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;<span class="comment"> * But in theory, because the SQL query performs an update on (dir, msgnum, mailboxuser, mailboxcontext) in the database, it should be possible to have the message relocated to another mailbox or context as well.</span></div><div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3">rename_file</a>(<span class="keywordtype">char</span> *sdir, <span class="keywordtype">int</span> smsg, <span class="keywordtype">char</span> *mailboxuser, <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">char</span> *ddir, <span class="keywordtype">int</span> dmsg)</div><div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;{</div><div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;   SQLHSTMT stmt;</div><div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;   <span class="keywordtype">char</span> msgnums[20];</div><div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;   <span class="keywordtype">char</span> msgnumd[20];</div><div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;   <span class="keywordtype">char</span> *argv[] = { ddir, msgnumd, mailboxuser, mailboxcontext, sdir, msgnums };</div><div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 6, .argv = argv };</div><div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;</div><div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;   <a class="code" href="../../d9/de9/res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(ddir, dmsg);</div><div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;</div><div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;   }</div><div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;</div><div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;   snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, smsg);</div><div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;   snprintf(msgnumd, <span class="keyword">sizeof</span>(msgnumd), <span class="stringliteral">&quot;%d&quot;</span>, dmsg);</div><div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;UPDATE %s SET dir=?, msgnum=?, mailboxuser=?, mailboxcontext=? WHERE dir=? AND msgnum=?&quot;</span>, odbc_table);</div><div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;   <span class="keywordflow">if</span> (!stmt)</div><div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;}</div><div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;<span class="comment"> * \brief Removes a voicemail message file.</span></div><div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;<span class="comment"> * \param dir the path to the message file.</span></div><div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;<span class="comment"> * \param msgnum the unique number for the message within the mailbox.</span></div><div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;<span class="comment"> * Removes the message content file and the information file.</span></div><div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;<span class="comment"> * This method is used by the DISPOSE macro when mailboxes are stored in an ODBC back end.</span></div><div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;<span class="comment"> * Typical use is to clean up after a RETRIEVE operation.</span></div><div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;<span class="comment"> * Note that this does not remove the message from the mailbox folders, to do that we would use delete_file().</span></div><div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> remove_file(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;{</div><div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;   <span class="keywordtype">char</span> full_fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;   <span class="keywordtype">char</span> msgnums[80];</div><div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;</div><div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1) {</div><div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;      snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);</div><div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);</div><div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;   } <span class="keywordflow">else</span></div><div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));</div><div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;   <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;   snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);</div><div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;   unlink(full_fn);</div><div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;}</div><div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;<span class="comment"> * \brief Find all .txt files - even if they are not in sequence from 0000.</span></div><div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;<span class="comment"> * \param dir</span></div><div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;<span class="comment"> * This method is used when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</span></div><div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;<span class="comment"> * \return the count of messages, zero or more.</span></div><div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04524"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6"> 4524</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)</div><div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;{</div><div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;</div><div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;   <span class="keywordtype">int</span> vmcount = 0;</div><div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;   DIR *vmdir = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;   <span class="keyword">struct </span>dirent *vment = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;</div><div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(dir))</div><div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;</div><div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;</div><div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;   <span class="keywordflow">if</span> ((vmdir = opendir(dir))) {</div><div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;      <span class="keywordflow">while</span> ((vment = readdir(vmdir))) {</div><div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;         <span class="keywordflow">if</span> (strlen(vment-&gt;d_name) &gt; 7 &amp;&amp; !strncmp(vment-&gt;d_name + 7, <span class="stringliteral">&quot;.txt&quot;</span>, 4)) {</div><div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;            vmcount++;</div><div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;         }</div><div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;      }</div><div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;      closedir(vmdir);</div><div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;   }</div><div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;</div><div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;   <span class="keywordflow">return</span> vmcount;</div><div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;}</div><div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;<span class="comment"> * \brief Renames a message in a mailbox folder.</span></div><div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;<span class="comment"> * \param sfn The path to the mailbox information and data file to be renamed.</span></div><div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;<span class="comment"> * \param dfn The path for where the message data and information files will be renamed to.</span></div><div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;<span class="comment"> * This method is used by the RENAME macro when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</span></div><div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04554"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3"> 4554</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3">rename_file</a>(<span class="keywordtype">char</span> *sfn, <span class="keywordtype">char</span> *dfn)</div><div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;{</div><div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;   <span class="keywordtype">char</span> stxt[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;   <span class="keywordtype">char</span> dtxt[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;   <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(sfn, dfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;   snprintf(stxt, <span class="keyword">sizeof</span>(stxt), <span class="stringliteral">&quot;%s.txt&quot;</span>, sfn);</div><div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;   snprintf(dtxt, <span class="keyword">sizeof</span>(dtxt), <span class="stringliteral">&quot;%s.txt&quot;</span>, dfn);</div><div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#ab845019b2f1bb324ff57e14192d62c39">ast_update_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, sfn, <span class="stringliteral">&quot;filename&quot;</span>, dfn, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;   }</div><div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;   rename(stxt, dtxt);</div><div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;}</div><div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;<span class="comment"> * \brief Determines the highest message number in use for a given user and mailbox folder.</span></div><div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;<span class="comment"> * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.</span></div><div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;<span class="comment"> * This method is used when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</span></div><div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;<span class="comment"> * Typical use to set the msgnum would be to take the value returned from this method and add one to it.</span></div><div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;<span class="comment"> * \note Should always be called with a lock already set on dir.</span></div><div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;<span class="comment"> * \return the value of zero or greaterto indicate the last message index in use, -1 to indicate none.</span></div><div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04578"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429"> 4578</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)</div><div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;{</div><div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d4/dfb/misdn__config_8c.html#a92a7399cbb76f6349df98d9432ad52c6">map</a>[<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;   DIR *msgdir;</div><div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;   <span class="keyword">struct </span>dirent *msgdirent;</div><div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;   <span class="keywordtype">int</span> msgdirint;</div><div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/d5a/structextension.html">extension</a>[4];</div><div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;   <span class="keywordtype">int</span> stopcount = 0;</div><div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;</div><div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;   <span class="comment">/* Reading the entire directory into a file map scales better than</span></div><div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;<span class="comment">    * doing a stat repeatedly on a predicted sequence.  I suspect this</span></div><div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;<span class="comment">    * is partially due to stat(2) internally doing a readdir(2) itself to</span></div><div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;<span class="comment">    * find each file. */</span></div><div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;   <span class="keywordflow">if</span> (!(msgdir = opendir(dir))) {</div><div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;   }</div><div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;</div><div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;   <span class="keywordflow">while</span> ((msgdirent = readdir(msgdir))) {</div><div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;      <span class="keywordflow">if</span> (sscanf(msgdirent-&gt;d_name, <span class="stringliteral">&quot;msg%30d.%3s&quot;</span>, &amp;msgdirint, extension) == 2 &amp;&amp; !strcmp(extension, <span class="stringliteral">&quot;txt&quot;</span>) &amp;&amp; msgdirint &lt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {</div><div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;         map[msgdirint] = 1;</div><div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;         stopcount++;</div><div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;%s map[%d] = %d, count = %d\n&quot;</span>, dir, msgdirint, map[msgdirint], stopcount);</div><div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;      }</div><div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;   }</div><div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;   closedir(msgdir);</div><div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;</div><div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>; x++) {</div><div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;      <span class="keywordflow">if</span> (map[x] == 1) {</div><div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160;         stopcount--;</div><div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (map[x] == 0 &amp;&amp; !stopcount) {</div><div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;      }</div><div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;   }</div><div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;</div><div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;   <span class="keywordflow">return</span> x - 1;</div><div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;}</div><div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;</div><div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* #ifndef IMAP_STORAGE */</span><span class="preprocessor"></span></div><div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* #else of #ifdef ODBC_STORAGE */</span><span class="preprocessor"></span></div><div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;<span class="comment"> * \brief Utility function to copy a file.</span></div><div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;<span class="comment"> * \param infile The path to the file to be copied. The file must be readable, it is opened in read only mode.</span></div><div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;<span class="comment"> * \param outfile The path for which to copy the file to. The directory permissions must allow the creation (or truncation) of the file, and allow for opening the file in write only mode.</span></div><div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;<span class="comment"> * When the compiler option HARDLINK_WHEN_POSSIBLE is set, the copy operation will attempt to use the hard link facility instead of copy the file (to save disk space). If the link operation fails, it falls back to the copy operation.</span></div><div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;<span class="comment"> * The copy operation copies up to 4096 bytes at once.</span></div><div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04629"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531"> 4629</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>(<span class="keywordtype">char</span> *infile, <span class="keywordtype">char</span> *outfile)</div><div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;{</div><div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;   <span class="keywordtype">int</span> ifd;</div><div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;   <span class="keywordtype">int</span> ofd;</div><div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;</div><div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;   <span class="keywordtype">char</span> buf[4096];</div><div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;</div><div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;<span class="preprocessor">#ifdef HARDLINK_WHEN_POSSIBLE</span></div><div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;   <span class="comment">/* Hard link if possible; saves disk space &amp; is faster */</span></div><div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;   <span class="keywordflow">if</span> (!link(infile, outfile)) {</div><div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;   }</div><div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;</div><div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;   <span class="keywordflow">if</span> ((ifd = open(infile, O_RDONLY)) &lt; 0) {</div><div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s in read-only mode: %s\n&quot;</span>, infile, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;   }</div><div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;</div><div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;   <span class="keywordflow">if</span> ((ofd = open(outfile, O_WRONLY | O_TRUNC | O_CREAT, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>)) &lt; 0) {</div><div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s in write-only mode: %s\n&quot;</span>, outfile, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;      close(ifd);</div><div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;   }</div><div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;</div><div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;   <span class="keywordflow">for</span> (;;) {</div><div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;      <span class="keywordtype">int</span> wrlen;</div><div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;</div><div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;      len = read(ifd, buf, <span class="keyword">sizeof</span>(buf));</div><div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;      <span class="keywordflow">if</span> (!len) {</div><div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;         res = 0;</div><div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;      }</div><div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;</div><div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;      <span class="keywordflow">if</span> (len &lt; 0) {</div><div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Read failed on %s: %s\n&quot;</span>, infile, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;      }</div><div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;</div><div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;      wrlen = write(ofd, buf, len);</div><div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOMEM || <a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOSPC || wrlen != len) {</div><div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Write failed on %s (%d of %d): %s\n&quot;</span>, outfile, wrlen, len, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;      }</div><div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;   }</div><div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;</div><div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;   close(ifd);</div><div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;   close(ofd);</div><div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;      unlink(outfile);</div><div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;   }</div><div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;</div><div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;}</div><div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160;<span class="comment"> * \brief Copies a voicemail information (envelope) file.</span></div><div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;<span class="comment"> * \param frompath</span></div><div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;<span class="comment"> * \param topath</span></div><div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160;<span class="comment"> * Every voicemail has the data (.wav) file, and the information file.</span></div><div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;<span class="comment"> * This function performs the file system copying of the information file for a voicemail, handling the internal fields and their values.</span></div><div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;<span class="comment"> * This is used by the COPY macro when not using IMAP storage.</span></div><div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04694"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1"> 4694</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1">copy_plain_file</a>(<span class="keywordtype">char</span> *frompath, <span class="keywordtype">char</span> *topath)</div><div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;{</div><div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160;   <span class="keywordtype">char</span> frompath2[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], topath2[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>, *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *origmailbox = <span class="stringliteral">&quot;&quot;</span>, *context = <span class="stringliteral">&quot;&quot;</span>, *macrocontext = <span class="stringliteral">&quot;&quot;</span>, *<a class="code" href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d9/d47/cdr__beanstalkd_8c.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = <span class="stringliteral">&quot;&quot;</span>, *callerchan = <span class="stringliteral">&quot;&quot;</span>, *callerid = <span class="stringliteral">&quot;&quot;</span>, *origdate = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime = <span class="stringliteral">&quot;&quot;</span>, *category = <span class="stringliteral">&quot;&quot;</span>, *duration = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;</div><div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;   <a class="code" href="../../d2/d4d/file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b">ast_filecopy</a>(frompath, topath, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;   snprintf(frompath2, <span class="keyword">sizeof</span>(frompath2), <span class="stringliteral">&quot;%s.txt&quot;</span>, frompath);</div><div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;   snprintf(topath2, <span class="keyword">sizeof</span>(topath2), <span class="stringliteral">&quot;%s.txt&quot;</span>, topath);</div><div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;</div><div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;      var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1a03993603e2bc2463153857836645bb">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, frompath, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;      <span class="comment">/* This cycle converts ast_variable linked list, to va_list list of arguments, may be there is a better way to do it? */</span></div><div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;      <span class="keywordflow">for</span> (tmp = var; <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>; tmp = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">next</a>) {</div><div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;         <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;origmailbox&quot;</span>)) {</div><div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;            origmailbox = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {</div><div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;            context = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;macrocontext&quot;</span>)) {</div><div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;            macrocontext = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;exten&quot;</span>)) {</div><div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;            <a class="code" href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;priority&quot;</span>)) {</div><div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;            priority = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerchan&quot;</span>)) {</div><div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;            callerchan = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerid&quot;</span>)) {</div><div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;            callerid = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;origdate&quot;</span>)) {</div><div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;            origdate = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;origtime&quot;</span>)) {</div><div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;            origtime = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;category&quot;</span>)) {</div><div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;            category = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;duration&quot;</span>)) {</div><div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;            duration = tmp-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;</div><div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;         }</div><div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;      }</div><div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2">ast_store_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, topath, <span class="stringliteral">&quot;origmailbox&quot;</span>, origmailbox, <span class="stringliteral">&quot;context&quot;</span>, context, <span class="stringliteral">&quot;macrocontext&quot;</span>, macrocontext, <span class="stringliteral">&quot;exten&quot;</span>, <a class="code" href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;priority&quot;</span>, priority, <span class="stringliteral">&quot;callerchan&quot;</span>, callerchan, <span class="stringliteral">&quot;callerid&quot;</span>, callerid, <span class="stringliteral">&quot;origdate&quot;</span>, origdate, <span class="stringliteral">&quot;origtime&quot;</span>, origtime, <span class="stringliteral">&quot;category&quot;</span>, category, <span class="stringliteral">&quot;duration&quot;</span>, duration, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;   }</div><div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>(frompath2, topath2);</div><div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#adea5390496e5477192d86f340d512d04">ast_variables_destroy</a>(var);</div><div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;}</div><div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;<span class="comment"> * \brief Removes the voicemail sound and information file.</span></div><div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;<span class="comment"> * \param file The path to the sound file. This will be the folder and message index, without the extension.</span></div><div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;<span class="comment"> * This is used by the DELETE macro when voicemails are stored on the file system.</span></div><div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04749"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e"> 4749</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e">vm_delete</a>(<span class="keywordtype">char</span> *file)</div><div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;{</div><div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;   <span class="keywordtype">char</span> *txt;</div><div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;   <span class="keywordtype">int</span> txtsize = 0;</div><div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;</div><div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;   txtsize = (strlen(file) + 5)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);</div><div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;   txt = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(txtsize);</div><div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;   <span class="comment">/* Sprintf here would safe because we alloca&#39;d exactly the right length,</span></div><div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;<span class="comment">    * but trying to eliminate all sprintf&#39;s anyhow</span></div><div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, file, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;   }</div><div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;   snprintf(txt, txtsize, <span class="stringliteral">&quot;%s.txt&quot;</span>, file);</div><div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;   unlink(txt);</div><div class="line"><a name="l04764"></a><span class="lineno"> 4764</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(file, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;}</div><div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;<span class="comment"> * \brief utility used by inchar(), for base_encode()</span></div><div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04770"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86"> 4770</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86">inbuf</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d11/structbaseio.html">baseio</a> *bio, FILE *fi)</div><div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;{</div><div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;   <span class="keywordtype">int</span> l;</div><div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;</div><div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;   <span class="keywordflow">if</span> (bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">ateof</a>)</div><div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;</div><div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;   <span class="keywordflow">if</span> ((l = fread(bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">iobuf</a>, 1, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>, fi)) != <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>) {</div><div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;      bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">ateof</a> = 1;</div><div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;      <span class="keywordflow">if</span> (l == 0) {</div><div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;         <span class="comment">/* Assume EOF */</span></div><div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;      }</div><div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;   }</div><div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;</div><div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;   bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">iolen</a> = l;</div><div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;   bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a> = 0;</div><div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;</div><div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;   <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;}</div><div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;<span class="comment"> * \brief utility used by base_encode()</span></div><div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04794"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e"> 4794</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e">inchar</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d11/structbaseio.html">baseio</a> *bio, FILE *fi)</div><div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;{</div><div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;   <span class="keywordflow">if</span> (bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a>&gt;=bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">iolen</a>) {</div><div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86">inbuf</a>(bio, fi))</div><div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;         <span class="keywordflow">return</span> EOF;</div><div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;   }</div><div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;</div><div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;   <span class="keywordflow">return</span> bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">iobuf</a>[bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a>++];</div><div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160;}</div><div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;<span class="comment"> * \brief utility used by base_encode()</span></div><div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04807"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa"> 4807</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa">ochar</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d11/structbaseio.html">baseio</a> *bio, <span class="keywordtype">int</span> c, FILE *so)</div><div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;{</div><div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;   <span class="keywordflow">if</span> (bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a> &gt;= <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1e31aa9d6eb3fa3e9287e3f3c3c16969">BASELINELEN</a>) {</div><div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;      <span class="keywordflow">if</span> (fputs(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, so) == EOF) {</div><div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;      }</div><div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;</div><div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;      bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a> = 0;</div><div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;   }</div><div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;</div><div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;   <span class="keywordflow">if</span> (putc(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) c), so) == EOF) {</div><div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;   }</div><div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;</div><div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;   bio-&gt;<a class="code" href="../../d5/d11/structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a>++;</div><div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;</div><div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;   <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;}</div><div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;<span class="comment"> * \brief Performs a base 64 encode algorithm on the contents of a File</span></div><div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;<span class="comment"> * \param filename The path to the file to be encoded. Must be readable, file is opened in read mode.</span></div><div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;<span class="comment"> * \param so A FILE handle to the output file to receive the base 64 encoded contents of the input file, identified by filename.</span></div><div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;<span class="comment"> * TODO: shouldn&#39;t this (and the above 3 support functions) be put into some kind of external utility location, such as funcs/func_base64.c ?</span></div><div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04835"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17"> 4835</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17">base_encode</a>(<span class="keywordtype">char</span> *filename, FILE *so)</div><div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;{</div><div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dtable[] = { <span class="charliteral">&#39;A&#39;</span>, <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;F&#39;</span>, <span class="charliteral">&#39;G&#39;</span>, <span class="charliteral">&#39;H&#39;</span>, <span class="charliteral">&#39;I&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;K&#39;</span>,</div><div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;      <span class="charliteral">&#39;L&#39;</span>, <span class="charliteral">&#39;M&#39;</span>, <span class="charliteral">&#39;N&#39;</span>, <span class="charliteral">&#39;O&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;Q&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39;T&#39;</span>, <span class="charliteral">&#39;U&#39;</span>, <span class="charliteral">&#39;V&#39;</span>, <span class="charliteral">&#39;W&#39;</span>, <span class="charliteral">&#39;X&#39;</span>, <span class="charliteral">&#39;Y&#39;</span>, <span class="charliteral">&#39;Z&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;b&#39;</span>, <span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;f&#39;</span>,</div><div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;      <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;h&#39;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="charliteral">&#39;j&#39;</span>, <span class="charliteral">&#39;k&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;m&#39;</span>, <span class="charliteral">&#39;n&#39;</span>, <span class="charliteral">&#39;o&#39;</span>, <span class="charliteral">&#39;p&#39;</span>, <span class="charliteral">&#39;q&#39;</span>, <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;u&#39;</span>, <span class="charliteral">&#39;v&#39;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="charliteral">&#39;x&#39;</span>, <span class="charliteral">&#39;y&#39;</span>, <span class="charliteral">&#39;z&#39;</span>, <span class="charliteral">&#39;0&#39;</span>,</div><div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;      <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;5&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;+&#39;</span>, <span class="charliteral">&#39;/&#39;</span>};</div><div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;   <span class="keywordtype">int</span> i, hiteof = 0;</div><div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;   FILE *fi;</div><div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d5/d11/structbaseio.html">baseio</a> bio;</div><div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;</div><div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;   memset(&amp;bio, 0, <span class="keyword">sizeof</span>(bio));</div><div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;   bio.<a class="code" href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>;</div><div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;</div><div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;   <span class="keywordflow">if</span> (!(fi = fopen(filename, <span class="stringliteral">&quot;rb&quot;</span>))) {</div><div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open file: %s: %s\n&quot;</span>, filename, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;   }</div><div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;</div><div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;   <span class="keywordflow">while</span> (!hiteof){</div><div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> igroup[3], ogroup[4];</div><div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;      <span class="keywordtype">int</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>, n;</div><div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;</div><div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;      memset(igroup, 0, <span class="keyword">sizeof</span>(igroup));</div><div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;</div><div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;      <span class="keywordflow">for</span> (n = 0; n &lt; 3; n++) {</div><div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;         <span class="keywordflow">if</span> ((c = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e">inchar</a>(&amp;bio, fi)) == EOF) {</div><div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;            hiteof = 1;</div><div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;         }</div><div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;</div><div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;         igroup[n] = (<span class="keywordtype">unsigned</span> char) c;</div><div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;      }</div><div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;</div><div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;      <span class="keywordflow">if</span> (n &gt; 0) {</div><div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;         ogroup[0]= dtable[igroup[0] &gt;&gt; 2];</div><div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;         ogroup[1]= dtable[((igroup[0] &amp; 3) &lt;&lt; 4) | (igroup[1] &gt;&gt; 4)];</div><div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;         ogroup[2]= dtable[((igroup[1] &amp; 0xF) &lt;&lt; 2) | (igroup[2] &gt;&gt; 6)];</div><div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;         ogroup[3]= dtable[igroup[2] &amp; 0x3F];</div><div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;</div><div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;         <span class="keywordflow">if</span> (n &lt; 3) {</div><div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;            ogroup[3] = <span class="charliteral">&#39;=&#39;</span>;</div><div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;</div><div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;            <span class="keywordflow">if</span> (n &lt; 2)</div><div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;               ogroup[2] = <span class="charliteral">&#39;=&#39;</span>;</div><div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;         }</div><div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;</div><div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;         <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)</div><div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa">ochar</a>(&amp;bio, ogroup[i], so);</div><div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;      }</div><div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;   }</div><div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;</div><div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;   fclose(fi);</div><div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;</div><div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;   <span class="keywordflow">if</span> (fputs(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, so) == EOF) {</div><div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;   }</div><div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;</div><div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;   <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;}</div><div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;</div><div class="line"><a name="l04895"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f"> 4895</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">char</span> *dur, <span class="keywordtype">char</span> *date, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)</div><div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;{</div><div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;   <span class="keywordtype">char</span> callerid[256];</div><div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;   <span class="keywordtype">char</span> num[12];</div><div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;   <span class="keywordtype">char</span> fromdir[256], fromfile[256];</div><div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *origcallerid, *origtime;</div><div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;   <span class="keywordtype">char</span> origcidname[80], origcidnum[80], origdate[80];</div><div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;   <span class="keywordtype">int</span> inttime;</div><div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;</div><div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;   <span class="comment">/* Prepare variables for substitution in email body and subject */</span></div><div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_NAME&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>);</div><div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_DUR&quot;</span>, dur);</div><div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;   snprintf(num, <span class="keyword">sizeof</span>(num), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);</div><div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_MSGNUM&quot;</span>, num);</div><div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CONTEXT&quot;</span>, context);</div><div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_MAILBOX&quot;</span>, mailbox);</div><div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CALLERID&quot;</span>, (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cidname) || !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cidnum)) ?</div><div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;      <a class="code" href="../../de/d47/callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(callerid, <span class="keyword">sizeof</span>(callerid), cidname, cidnum, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : <span class="stringliteral">&quot;an unknown caller&quot;</span>);</div><div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CIDNAME&quot;</span>, (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cidname) ? cidname : <span class="stringliteral">&quot;an unknown caller&quot;</span>));</div><div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CIDNUM&quot;</span>, (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cidnum) ? cidnum : <span class="stringliteral">&quot;an unknown caller&quot;</span>));</div><div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_DATE&quot;</span>, date);</div><div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CATEGORY&quot;</span>, category ? <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(category) : <span class="stringliteral">&quot;no category&quot;</span>);</div><div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_FLAG&quot;</span>, flag);</div><div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;</div><div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;   <span class="comment">/* Retrieve info from VM attribute file */</span></div><div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(fromdir, <span class="keyword">sizeof</span>(fromdir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, fromfolder);</div><div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fromfile, <span class="keyword">sizeof</span>(fromfile), fromdir, msgnum - 1);</div><div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;   <span class="keywordflow">if</span> (strlen(fromfile) &lt; <span class="keyword">sizeof</span>(fromfile) - 5) {</div><div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;      strcat(fromfile, <span class="stringliteral">&quot;.txt&quot;</span>);</div><div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;   }</div><div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;   <span class="keywordflow">if</span> (!(msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(fromfile, config_flags)) || !(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg))) {</div><div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Config load for message text file &#39;%s&#39; failed\n&quot;</span>, fromfile);</div><div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;   }</div><div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;</div><div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;   <span class="keywordflow">if</span> ((origcallerid = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {</div><div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_CALLERID&quot;</span>, origcallerid);</div><div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;      <a class="code" href="../../de/d47/callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(origcallerid, origcidname, <span class="keyword">sizeof</span>(origcidname), origcidnum, <span class="keyword">sizeof</span>(origcidnum));</div><div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_CIDNAME&quot;</span>, origcidname);</div><div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_CIDNUM&quot;</span>, origcidnum);</div><div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;   }</div><div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;</div><div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;   <span class="keywordflow">if</span> ((origtime = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>)) &amp;&amp; sscanf(origtime, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;inttime) == 1) {</div><div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;      <span class="keyword">struct </span>timeval tv = { inttime, };</div><div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> tm;</div><div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;      <a class="code" href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a>(&amp;tv, &amp;tm, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;      <a class="code" href="../../d5/deb/localtime_8h.html#ad5092e0e84f5959f275d6de28438250e">ast_strftime_locale</a>(origdate, <span class="keyword">sizeof</span>(origdate), emaildateformat, &amp;tm, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div><div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_DATE&quot;</span>, origdate);</div><div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;   }</div><div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;}</div><div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;<span class="comment"> * \brief Wraps a character sequence in double quotes, escaping occurences of quotes within the string.</span></div><div class="line"><a name="l04951"></a><span class="lineno"> 4951</span>&#160;<span class="comment"> * \param from The string to work with.</span></div><div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;<span class="comment"> * \param buf The buffer into which to write the modified quoted string.</span></div><div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;<span class="comment"> * \param maxlen Always zero, but see \see ast_str</span></div><div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;<span class="comment"> * \return The destination string with quotes wrapped on it (the to field).</span></div><div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04957"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258"> 4957</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258">ast_str_quote</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/da2/structast__str.html">ast_str</a> **buf, ssize_t maxlen, <span class="keyword">const</span> <span class="keywordtype">char</span> *from)</div><div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;{</div><div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;</div><div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;   <span class="comment">/* We&#39;re only ever passing 0 to maxlen, so short output isn&#39;t possible */</span></div><div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(buf, maxlen, <span class="stringliteral">&quot;\&quot;&quot;</span>);</div><div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;   <span class="keywordflow">for</span> (ptr = from; *ptr; ptr++) {</div><div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;      <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;&quot;&#39;</span> || *ptr == <span class="charliteral">&#39;\\&#39;</span>) {</div><div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(buf, maxlen, <span class="stringliteral">&quot;\\%c&quot;</span>, *ptr);</div><div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(buf, maxlen, <span class="stringliteral">&quot;%c&quot;</span>, *ptr);</div><div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;      }</div><div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160;   }</div><div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(buf, maxlen, <span class="stringliteral">&quot;\&quot;&quot;</span>);</div><div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;</div><div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(*buf);</div><div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;}</div><div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;<span class="comment">/*! \brief</span></div><div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;<span class="comment"> * fill in *tm for current time according to the proper timezone, if any.</span></div><div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;<span class="comment"> * \return tm so it can be used as a function argument.</span></div><div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04979"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac80ec334a4e45426a7c522b34d1c4774"> 4979</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#ac80ec334a4e45426a7c522b34d1c4774">vmu_tm</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> *tm)</div><div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;{</div><div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;   <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *z = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;   <span class="keyword">struct </span>timeval t = <a class="code" href="../../de/df7/time_8h.html#ad3899efb6f0e348556ef69f5b16aa7f7">ast_tvnow</a>();</div><div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;</div><div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;   <span class="comment">/* Does this user have a timezone specified? */</span></div><div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>)) {</div><div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;      <span class="comment">/* Find the zone in the list */</span></div><div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>, z, list) {</div><div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;         <span class="keywordflow">if</span> (!strcmp(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">name</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>))</div><div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;      }</div><div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;   }</div><div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a>(&amp;t, tm, z ? z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a> : <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;   <span class="keywordflow">return</span> tm;</div><div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;}</div><div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;<span class="comment"></span></div><div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;<span class="comment">/*!\brief Check if the string would need encoding within the MIME standard, to</span></div><div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;<span class="comment"> * avoid confusing certain mail software that expects messages to be 7-bit</span></div><div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;<span class="comment"> * clean.</span></div><div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05002"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb"> 5002</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>)</div><div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;{</div><div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;   <span class="keywordflow">for</span> (; *<a class="code" href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>; str++) {</div><div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;      <span class="keywordflow">if</span> (*str &gt; 126 || *str &lt; 32 || strchr(<span class="stringliteral">&quot;()&lt;&gt;@,:;/\&quot;[]?.=&quot;</span>, *str)) {</div><div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;         <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;      }</div><div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;   }</div><div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;}</div><div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;<span class="comment"></span></div><div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;<span class="comment">/*!\brief Encode a string according to the MIME rules for encoding strings</span></div><div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;<span class="comment"> * that are not 7-bit clean or contain control characters.</span></div><div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;<span class="comment"> * Additionally, if the encoded string would exceed the MIME limit of 76</span></div><div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;<span class="comment"> * characters per line, then the encoding will be broken up into multiple</span></div><div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;<span class="comment"> * sections, separated by a space character, in order to facilitate</span></div><div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;<span class="comment"> * breaking up the associated header across multiple lines.</span></div><div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;<span class="comment"> * \param end An expandable buffer for holding the result</span></div><div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;<span class="comment"> * \param maxlen Always zero, but see \see ast_str</span></div><div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;<span class="comment"> * \param start A string to be encoded</span></div><div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;<span class="comment"> * \param preamble The length of the first line already used for this string,</span></div><div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;<span class="comment"> * to ensure that each line maintains a maximum length of 76 chars.</span></div><div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;<span class="comment"> * \param postamble the length of any additional characters appended to the</span></div><div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;<span class="comment"> * line, used to ensure proper field wrapping.</span></div><div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;<span class="comment"> * \retval The encoded string.</span></div><div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05029"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a"> 5029</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/da2/structast__str.html">ast_str</a> **<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#a8fd806ad19b8f5513a4cf18cbf77532c">end</a>, ssize_t maxlen, <span class="keyword">const</span> <span class="keywordtype">char</span> *start, <span class="keywordtype">size_t</span> preamble, <span class="keywordtype">size_t</span> postamble)</div><div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;{</div><div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> *tmp = <a class="code" href="../../d6/d90/strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(80);</div><div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160;   <span class="keywordtype">int</span> first_section = 1;</div><div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;</div><div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a8239b9ad10367bfc936e9b60ff7706a8">ast_str_reset</a>(*end);</div><div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;tmp, -1, <span class="stringliteral">&quot;=?%s?Q?&quot;</span>, charset);</div><div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;   <span class="keywordflow">for</span> (; *start; start++) {</div><div class="line"><a name="l05037"></a><span class="lineno"> 5037</span>&#160;      <span class="keywordtype">int</span> need_encoding = 0;</div><div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;      <span class="keywordflow">if</span> (*start &lt; 33 || *start &gt; 126 || strchr(<span class="stringliteral">&quot;()&lt;&gt;@,:;/\&quot;[]?.=_&quot;</span>, *start)) {</div><div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;         need_encoding = 1;</div><div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;      }</div><div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;      <span class="keywordflow">if</span> ((first_section &amp;&amp; need_encoding &amp;&amp; preamble + <a class="code" href="../../d6/d90/strings_8h.html#aabc005bd1c7e249e8f8659d57d4500b6">ast_str_strlen</a>(tmp) &gt; 70) ||</div><div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;         (first_section &amp;&amp; !need_encoding &amp;&amp; preamble + <a class="code" href="../../d6/d90/strings_8h.html#aabc005bd1c7e249e8f8659d57d4500b6">ast_str_strlen</a>(tmp) &gt; 72) ||</div><div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;         (!first_section &amp;&amp; need_encoding &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#aabc005bd1c7e249e8f8659d57d4500b6">ast_str_strlen</a>(tmp) &gt; 70) ||</div><div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;         (!first_section &amp;&amp; !need_encoding &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#aabc005bd1c7e249e8f8659d57d4500b6">ast_str_strlen</a>(tmp) &gt; 72)) {</div><div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;         <span class="comment">/* Start new line */</span></div><div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(end, maxlen, <span class="stringliteral">&quot;%s%s?=&quot;</span>, first_section ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; &quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(tmp));</div><div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;tmp, -1, <span class="stringliteral">&quot;=?%s?Q?&quot;</span>, charset);</div><div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;         first_section = 0;</div><div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;      }</div><div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;      <span class="keywordflow">if</span> (need_encoding &amp;&amp; *start == <span class="charliteral">&#39; &#39;</span>) {</div><div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;tmp, -1, <span class="stringliteral">&quot;_&quot;</span>);</div><div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (need_encoding) {</div><div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;tmp, -1, <span class="stringliteral">&quot;=%hhX&quot;</span>, *start);</div><div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;tmp, -1, <span class="stringliteral">&quot;%c&quot;</span>, *start);</div><div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;      }</div><div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;   }</div><div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(end, maxlen, <span class="stringliteral">&quot;%s%s?=%s&quot;</span>, first_section ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; &quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(tmp), <a class="code" href="../../d6/d90/strings_8h.html#aabc005bd1c7e249e8f8659d57d4500b6">ast_str_strlen</a>(tmp) + postamble &gt; 74 ? <span class="stringliteral">&quot; &quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(*end);</div><div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;}</div><div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;<span class="comment"></span></div><div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;<span class="comment"> * \brief Creates the email file to be sent to indicate a new voicemail exists for a user.</span></div><div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;<span class="comment"> * \param p The output file to generate the email contents into.</span></div><div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;<span class="comment"> * \param srcemail The email address to send the email to, presumably the email address for the owner of the mailbox.</span></div><div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;<span class="comment"> * \param vmu The voicemail user who is sending the voicemail.</span></div><div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;<span class="comment"> * \param msgnum The message index in the mailbox folder.</span></div><div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;<span class="comment"> * \param mailbox The voicemail box to read the voicemail to be notified in this email.</span></div><div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;<span class="comment"> * \param fromfolder</span></div><div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;<span class="comment"> * \param cidnum The caller ID number.</span></div><div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;<span class="comment"> * \param cidname The caller ID name.</span></div><div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;<span class="comment"> * \param attach the name of the sound file to be attached to the email, if attach_user_voicemail == 1.</span></div><div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;<span class="comment"> * \param attach2</span></div><div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;<span class="comment"> * \param format The message sound file format. i.e. .wav</span></div><div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;<span class="comment"> * \param duration The time of the message content, in seconds.</span></div><div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;<span class="comment"> * \param attach_user_voicemail if 1, the sound file is attached to the email.</span></div><div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;<span class="comment"> * \param category</span></div><div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160;<span class="comment"> * \param imap if == 1, indicates the target folder for the email notification to be sent to will be an IMAP mailstore. This causes additional mailbox headers to be set, which would facilitate searching for the email in the destination IMAP folder.</span></div><div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;<span class="comment"> * \param flag, msg_id</span></div><div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160;<span class="comment"> * The email body, and base 64 encoded attachement (if any) are stored to the file identified by *p. This method does not actually send the email.  That is done by invoking the configure &#39;mailcmd&#39; and piping this generated file into it, or with the sendemail() function.</span></div><div class="line"><a name="l05084"></a><span class="lineno"> 5084</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05085"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0"> 5085</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0">make_email_file</a>(FILE *p,</div><div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;      <span class="keywordtype">char</span> *srcemail,</div><div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;      <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu,</div><div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;      <span class="keywordtype">int</span> msgnum,</div><div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160;      <span class="keywordtype">char</span> *context,</div><div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;      <span class="keywordtype">char</span> *mailbox,</div><div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder,</div><div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;      <span class="keywordtype">char</span> *cidnum,</div><div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160;      <span class="keywordtype">char</span> *cidname,</div><div class="line"><a name="l05094"></a><span class="lineno"> 5094</span>&#160;      <span class="keywordtype">char</span> *attach,</div><div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;      <span class="keywordtype">char</span> *attach2,</div><div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;      <span class="keywordtype">char</span> *format,</div><div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160;      <span class="keywordtype">int</span> duration,</div><div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;      <span class="keywordtype">int</span> attach_user_voicemail,</div><div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;      <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *category,</div><div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;      <span class="keywordtype">int</span> imap,</div><div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *flag,</div><div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id)</div><div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160;{</div><div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;   <span class="keywordtype">char</span> date[256];</div><div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/d8a/muted_8c.html#a41c3a180b50c6b2ddcc1b6843a48f205">host</a>[<a class="code" href="../../d9/d94/network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160;   <span class="keywordtype">char</span> who[256];</div><div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;   <span class="keywordtype">char</span> bound[256];</div><div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160;   <span class="keywordtype">char</span> dur[256];</div><div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> tm;</div><div class="line"><a name="l05111"></a><span class="lineno"> 5111</span>&#160;   <span class="keywordtype">char</span> enc_cidnum[256] = <span class="stringliteral">&quot;&quot;</span>, enc_cidname[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05112"></a><span class="lineno"> 5112</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> *str1 = <a class="code" href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a>(16), *str2 = <a class="code" href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a>(16);</div><div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;   <span class="keywordtype">char</span> *greeting_attachment;</div><div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;   <span class="keywordtype">char</span> filename[256];</div><div class="line"><a name="l05115"></a><span class="lineno"> 5115</span>&#160;   <span class="keywordtype">int</span> first_line;</div><div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;   <span class="keywordtype">char</span> *emailsbuf;</div><div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d1/dc0/pbx__dundi_8c.html#aadd75c09e15efa9061997f033b3f224b">email</a>;</div><div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;</div><div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;   <span class="keywordflow">if</span> (!str1 || !str2) {</div><div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str1);</div><div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str2);</div><div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;   }</div><div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;</div><div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;   <span class="keywordflow">if</span> (cidnum) {</div><div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">strip_control_and_high</a>(cidnum, enc_cidnum, <span class="keyword">sizeof</span>(enc_cidnum));</div><div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;   }</div><div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;   <span class="keywordflow">if</span> (cidname) {</div><div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">strip_control_and_high</a>(cidname, enc_cidname, <span class="keyword">sizeof</span>(enc_cidname));</div><div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;   }</div><div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;   gethostname(host, <span class="keyword">sizeof</span>(host) - 1);</div><div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;</div><div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;   <span class="keywordflow">if</span> (strchr(srcemail, <span class="charliteral">&#39;@&#39;</span>)) {</div><div class="line"><a name="l05134"></a><span class="lineno"> 5134</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(who, srcemail, <span class="keyword">sizeof</span>(who));</div><div class="line"><a name="l05135"></a><span class="lineno"> 5135</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05136"></a><span class="lineno"> 5136</span>&#160;      snprintf(who, <span class="keyword">sizeof</span>(who), <span class="stringliteral">&quot;%s@%s&quot;</span>, srcemail, host);</div><div class="line"><a name="l05137"></a><span class="lineno"> 5137</span>&#160;   }</div><div class="line"><a name="l05138"></a><span class="lineno"> 5138</span>&#160;</div><div class="line"><a name="l05139"></a><span class="lineno"> 5139</span>&#160;   greeting_attachment = strrchr(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(attach), <span class="charliteral">&#39;/&#39;</span>);</div><div class="line"><a name="l05140"></a><span class="lineno"> 5140</span>&#160;   <span class="keywordflow">if</span> (greeting_attachment) {</div><div class="line"><a name="l05141"></a><span class="lineno"> 5141</span>&#160;      *greeting_attachment++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05142"></a><span class="lineno"> 5142</span>&#160;   }</div><div class="line"><a name="l05143"></a><span class="lineno"> 5143</span>&#160;</div><div class="line"><a name="l05144"></a><span class="lineno"> 5144</span>&#160;   snprintf(dur, <span class="keyword">sizeof</span>(dur), <span class="stringliteral">&quot;%d:%02d&quot;</span>, duration / 60, duration % 60);</div><div class="line"><a name="l05145"></a><span class="lineno"> 5145</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#aa8e63928b14a347bd3973d680b885f93">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), <span class="stringliteral">&quot;%a, %d %b %Y %H:%M:%S %z&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac80ec334a4e45426a7c522b34d1c4774">vmu_tm</a>(vmu, &amp;tm));</div><div class="line"><a name="l05146"></a><span class="lineno"> 5146</span>&#160;   fprintf(p, <span class="stringliteral">&quot;Date: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, date);</div><div class="line"><a name="l05147"></a><span class="lineno"> 5147</span>&#160;</div><div class="line"><a name="l05148"></a><span class="lineno"> 5148</span>&#160;   <span class="comment">/* Set date format for voicemail mail */</span></div><div class="line"><a name="l05149"></a><span class="lineno"> 5149</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#ad5092e0e84f5959f275d6de28438250e">ast_strftime_locale</a>(date, <span class="keyword">sizeof</span>(date), emaildateformat, &amp;tm, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div><div class="line"><a name="l05150"></a><span class="lineno"> 5150</span>&#160;</div><div class="line"><a name="l05151"></a><span class="lineno"> 5151</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(fromstring) || !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>)) {</div><div class="line"><a name="l05152"></a><span class="lineno"> 5152</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast;</div><div class="line"><a name="l05153"></a><span class="lineno"> 5153</span>&#160;      <span class="keywordtype">char</span> *e_fromstring = !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>) ? vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a> : <a class="code" href="../../dc/df4/app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>;</div><div class="line"><a name="l05154"></a><span class="lineno"> 5154</span>&#160;      <span class="keywordflow">if</span> ((ast = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l05155"></a><span class="lineno"> 5155</span>&#160;         <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l05156"></a><span class="lineno"> 5156</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, enc_cidnum, enc_cidname, dur, date, category, flag);</div><div class="line"><a name="l05157"></a><span class="lineno"> 5157</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a>(&amp;str1, 0, ast, e_fromstring);</div><div class="line"><a name="l05158"></a><span class="lineno"> 5158</span>&#160;</div><div class="line"><a name="l05159"></a><span class="lineno"> 5159</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1))) {</div><div class="line"><a name="l05160"></a><span class="lineno"> 5160</span>&#160;            first_line = 1;</div><div class="line"><a name="l05161"></a><span class="lineno"> 5161</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(&amp;str2, 0, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1), strlen(<span class="stringliteral">&quot;From: &quot;</span>), strlen(who) + 3);</div><div class="line"><a name="l05162"></a><span class="lineno"> 5162</span>&#160;            <span class="keywordflow">while</span> ((ptr = strchr(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), <span class="charliteral">&#39; &#39;</span>))) {</div><div class="line"><a name="l05163"></a><span class="lineno"> 5163</span>&#160;               *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05164"></a><span class="lineno"> 5164</span>&#160;               fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;From:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05165"></a><span class="lineno"> 5165</span>&#160;               first_line = 0;</div><div class="line"><a name="l05166"></a><span class="lineno"> 5166</span>&#160;               <span class="comment">/* Substring is smaller, so this will never grow */</span></div><div class="line"><a name="l05167"></a><span class="lineno"> 5167</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;str2, 0, <span class="stringliteral">&quot;%s&quot;</span>, ptr + 1);</div><div class="line"><a name="l05168"></a><span class="lineno"> 5168</span>&#160;            }</div><div class="line"><a name="l05169"></a><span class="lineno"> 5169</span>&#160;            fprintf(p, <span class="stringliteral">&quot;%s %s &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;From:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), who);</div><div class="line"><a name="l05170"></a><span class="lineno"> 5170</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05171"></a><span class="lineno"> 5171</span>&#160;            fprintf(p, <span class="stringliteral">&quot;From: %s &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258">ast_str_quote</a>(&amp;str2, 0, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1)), who);</div><div class="line"><a name="l05172"></a><span class="lineno"> 5172</span>&#160;         }</div><div class="line"><a name="l05173"></a><span class="lineno"> 5173</span>&#160;         ast = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(ast);</div><div class="line"><a name="l05174"></a><span class="lineno"> 5174</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05175"></a><span class="lineno"> 5175</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);</div><div class="line"><a name="l05176"></a><span class="lineno"> 5176</span>&#160;      }</div><div class="line"><a name="l05177"></a><span class="lineno"> 5177</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05178"></a><span class="lineno"> 5178</span>&#160;      fprintf(p, <span class="stringliteral">&quot;From: Asterisk PBX &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, who);</div><div class="line"><a name="l05179"></a><span class="lineno"> 5179</span>&#160;   }</div><div class="line"><a name="l05180"></a><span class="lineno"> 5180</span>&#160;</div><div class="line"><a name="l05181"></a><span class="lineno"> 5181</span>&#160;   emailsbuf = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>);</div><div class="line"><a name="l05182"></a><span class="lineno"> 5182</span>&#160;   fprintf(p, <span class="stringliteral">&quot;To:&quot;</span>);</div><div class="line"><a name="l05183"></a><span class="lineno"> 5183</span>&#160;   first_line = 1;</div><div class="line"><a name="l05184"></a><span class="lineno"> 5184</span>&#160;   <span class="keywordflow">while</span> ((email = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;emailsbuf, <span class="stringliteral">&quot;|&quot;</span>))) {</div><div class="line"><a name="l05185"></a><span class="lineno"> 5185</span>&#160;      <span class="keywordtype">char</span> *next = emailsbuf;</div><div class="line"><a name="l05186"></a><span class="lineno"> 5186</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>)) {</div><div class="line"><a name="l05187"></a><span class="lineno"> 5187</span>&#160;         <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l05188"></a><span class="lineno"> 5188</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(&amp;str2, 0, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, first_line ? strlen(<span class="stringliteral">&quot;To: &quot;</span>) : 0, strlen(email) + 3 + (next ? strlen(<span class="stringliteral">&quot;,&quot;</span>) : 0));</div><div class="line"><a name="l05189"></a><span class="lineno"> 5189</span>&#160;         <span class="keywordflow">while</span> ((ptr = strchr(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), <span class="charliteral">&#39; &#39;</span>))) {</div><div class="line"><a name="l05190"></a><span class="lineno"> 5190</span>&#160;            *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05191"></a><span class="lineno"> 5191</span>&#160;            fprintf(p, <span class="stringliteral">&quot; %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05192"></a><span class="lineno"> 5192</span>&#160;            <span class="comment">/* Substring is smaller, so this will never grow */</span></div><div class="line"><a name="l05193"></a><span class="lineno"> 5193</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;str2, 0, <span class="stringliteral">&quot;%s&quot;</span>, ptr + 1);</div><div class="line"><a name="l05194"></a><span class="lineno"> 5194</span>&#160;         }</div><div class="line"><a name="l05195"></a><span class="lineno"> 5195</span>&#160;         fprintf(p, <span class="stringliteral">&quot; %s &lt;%s&gt;%s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), email, next ? <span class="stringliteral">&quot;,&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l05196"></a><span class="lineno"> 5196</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05197"></a><span class="lineno"> 5197</span>&#160;         fprintf(p, <span class="stringliteral">&quot; %s &lt;%s&gt;%s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258">ast_str_quote</a>(&amp;str2, 0, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>), email, next ? <span class="stringliteral">&quot;,&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l05198"></a><span class="lineno"> 5198</span>&#160;      }</div><div class="line"><a name="l05199"></a><span class="lineno"> 5199</span>&#160;      first_line = 0;</div><div class="line"><a name="l05200"></a><span class="lineno"> 5200</span>&#160;   }</div><div class="line"><a name="l05201"></a><span class="lineno"> 5201</span>&#160;</div><div class="line"><a name="l05202"></a><span class="lineno"> 5202</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt;= -1) {</div><div class="line"><a name="l05203"></a><span class="lineno"> 5203</span>&#160;      fprintf(p, <span class="stringliteral">&quot;Subject: New greeting &#39;%s&#39; on %s.&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, greeting_attachment, date);</div><div class="line"><a name="l05204"></a><span class="lineno"> 5204</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(emailsubject) || !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>)) {</div><div class="line"><a name="l05205"></a><span class="lineno"> 5205</span>&#160;      <span class="keywordtype">char</span> *e_subj = !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>) ? vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> : <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>;</div><div class="line"><a name="l05206"></a><span class="lineno"> 5206</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast;</div><div class="line"><a name="l05207"></a><span class="lineno"> 5207</span>&#160;      <span class="keywordflow">if</span> ((ast = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l05208"></a><span class="lineno"> 5208</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</div><div class="line"><a name="l05209"></a><span class="lineno"> 5209</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a>(&amp;str1, 0, ast, e_subj);</div><div class="line"><a name="l05210"></a><span class="lineno"> 5210</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1))) {</div><div class="line"><a name="l05211"></a><span class="lineno"> 5211</span>&#160;            <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l05212"></a><span class="lineno"> 5212</span>&#160;            first_line = 1;</div><div class="line"><a name="l05213"></a><span class="lineno"> 5213</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(&amp;str2, 0, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1), strlen(<span class="stringliteral">&quot;Subject: &quot;</span>), 0);</div><div class="line"><a name="l05214"></a><span class="lineno"> 5214</span>&#160;            <span class="keywordflow">while</span> ((ptr = strchr(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), <span class="charliteral">&#39; &#39;</span>))) {</div><div class="line"><a name="l05215"></a><span class="lineno"> 5215</span>&#160;               *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05216"></a><span class="lineno"> 5216</span>&#160;               fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;Subject:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05217"></a><span class="lineno"> 5217</span>&#160;               first_line = 0;</div><div class="line"><a name="l05218"></a><span class="lineno"> 5218</span>&#160;               <span class="comment">/* Substring is smaller, so this will never grow */</span></div><div class="line"><a name="l05219"></a><span class="lineno"> 5219</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;str2, 0, <span class="stringliteral">&quot;%s&quot;</span>, ptr + 1);</div><div class="line"><a name="l05220"></a><span class="lineno"> 5220</span>&#160;            }</div><div class="line"><a name="l05221"></a><span class="lineno"> 5221</span>&#160;            fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;Subject:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05222"></a><span class="lineno"> 5222</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05223"></a><span class="lineno"> 5223</span>&#160;            fprintf(p, <span class="stringliteral">&quot;Subject: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1));</div><div class="line"><a name="l05224"></a><span class="lineno"> 5224</span>&#160;         }</div><div class="line"><a name="l05225"></a><span class="lineno"> 5225</span>&#160;         ast = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(ast);</div><div class="line"><a name="l05226"></a><span class="lineno"> 5226</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05227"></a><span class="lineno"> 5227</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);</div><div class="line"><a name="l05228"></a><span class="lineno"> 5228</span>&#160;      }</div><div class="line"><a name="l05229"></a><span class="lineno"> 5229</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">VM_PBXSKIP</a>)) {</div><div class="line"><a name="l05230"></a><span class="lineno"> 5230</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag)) {</div><div class="line"><a name="l05231"></a><span class="lineno"> 5231</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Subject: New message %d in mailbox %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1, mailbox);</div><div class="line"><a name="l05232"></a><span class="lineno"> 5232</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05233"></a><span class="lineno"> 5233</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Subject: New %s message %d in mailbox %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, flag, msgnum + 1, mailbox);</div><div class="line"><a name="l05234"></a><span class="lineno"> 5234</span>&#160;      }</div><div class="line"><a name="l05235"></a><span class="lineno"> 5235</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05236"></a><span class="lineno"> 5236</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag)) {</div><div class="line"><a name="l05237"></a><span class="lineno"> 5237</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Subject: [PBX]: New message %d in mailbox %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1, mailbox);</div><div class="line"><a name="l05238"></a><span class="lineno"> 5238</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05239"></a><span class="lineno"> 5239</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Subject: [PBX]: New %s message %d in mailbox %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, flag, msgnum + 1, mailbox);</div><div class="line"><a name="l05240"></a><span class="lineno"> 5240</span>&#160;      }</div><div class="line"><a name="l05241"></a><span class="lineno"> 5241</span>&#160;   }</div><div class="line"><a name="l05242"></a><span class="lineno"> 5242</span>&#160;</div><div class="line"><a name="l05243"></a><span class="lineno"> 5243</span>&#160;   fprintf(p, <span class="stringliteral">&quot;Message-ID: &lt;Asterisk-%d-%u-%s-%d@%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1,</div><div class="line"><a name="l05244"></a><span class="lineno"> 5244</span>&#160;      (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) <a class="code" href="../../d5/d60/utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), mailbox, (<span class="keywordtype">int</span>) getpid(), host);</div><div class="line"><a name="l05245"></a><span class="lineno"> 5245</span>&#160;   <span class="keywordflow">if</span> (imap) {</div><div class="line"><a name="l05246"></a><span class="lineno"> 5246</span>&#160;      <span class="comment">/* additional information needed for IMAP searching */</span></div><div class="line"><a name="l05247"></a><span class="lineno"> 5247</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Message-Num: %d&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1);</div><div class="line"><a name="l05248"></a><span class="lineno"> 5248</span>&#160;      <span class="comment">/* fprintf(p, &quot;X-Asterisk-VM-Orig-Mailbox: %s&quot; ENDL, ext); */</span></div><div class="line"><a name="l05249"></a><span class="lineno"> 5249</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Server-Name: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, fromstring);</div><div class="line"><a name="l05250"></a><span class="lineno"> 5250</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Context: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, context);</div><div class="line"><a name="l05251"></a><span class="lineno"> 5251</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l05252"></a><span class="lineno"> 5252</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Extension: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : mailbox));</div><div class="line"><a name="l05253"></a><span class="lineno"> 5253</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l05254"></a><span class="lineno"> 5254</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Extension: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, mailbox);</div><div class="line"><a name="l05255"></a><span class="lineno"> 5255</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05256"></a><span class="lineno"> 5256</span>&#160;      <span class="comment">/* flag added for Urgent */</span></div><div class="line"><a name="l05257"></a><span class="lineno"> 5257</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Flag: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(flag, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l05258"></a><span class="lineno"> 5258</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Priority: %d&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, chan ? <a class="code" href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a>(chan) : 0);</div><div class="line"><a name="l05259"></a><span class="lineno"> 5259</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Num: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidnum);</div><div class="line"><a name="l05260"></a><span class="lineno"> 5260</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Name: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidname);</div><div class="line"><a name="l05261"></a><span class="lineno"> 5261</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Duration: %d&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, duration);</div><div class="line"><a name="l05262"></a><span class="lineno"> 5262</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category)) {</div><div class="line"><a name="l05263"></a><span class="lineno"> 5263</span>&#160;         fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Category: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, category);</div><div class="line"><a name="l05264"></a><span class="lineno"> 5264</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05265"></a><span class="lineno"> 5265</span>&#160;         fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Category: &quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);</div><div class="line"><a name="l05266"></a><span class="lineno"> 5266</span>&#160;      }</div><div class="line"><a name="l05267"></a><span class="lineno"> 5267</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Message-Type: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum &gt; -1 ? <span class="stringliteral">&quot;Message&quot;</span> : greeting_attachment);</div><div class="line"><a name="l05268"></a><span class="lineno"> 5268</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Orig-date: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, date);</div><div class="line"><a name="l05269"></a><span class="lineno"> 5269</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Orig-time: %ld&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, (<span class="keywordtype">long</span>) time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div><div class="line"><a name="l05270"></a><span class="lineno"> 5270</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Message-ID: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msg_id);</div><div class="line"><a name="l05271"></a><span class="lineno"> 5271</span>&#160;   }</div><div class="line"><a name="l05272"></a><span class="lineno"> 5272</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cidnum)) {</div><div class="line"><a name="l05273"></a><span class="lineno"> 5273</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-CallerID: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidnum);</div><div class="line"><a name="l05274"></a><span class="lineno"> 5274</span>&#160;   }</div><div class="line"><a name="l05275"></a><span class="lineno"> 5275</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cidname)) {</div><div class="line"><a name="l05276"></a><span class="lineno"> 5276</span>&#160;      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-CallerIDName: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidname);</div><div class="line"><a name="l05277"></a><span class="lineno"> 5277</span>&#160;   }</div><div class="line"><a name="l05278"></a><span class="lineno"> 5278</span>&#160;   fprintf(p, <span class="stringliteral">&quot;MIME-Version: 1.0&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);</div><div class="line"><a name="l05279"></a><span class="lineno"> 5279</span>&#160;   <span class="keywordflow">if</span> (attach_user_voicemail) {</div><div class="line"><a name="l05280"></a><span class="lineno"> 5280</span>&#160;      <span class="comment">/* Something unique. */</span></div><div class="line"><a name="l05281"></a><span class="lineno"> 5281</span>&#160;      snprintf(bound, <span class="keyword">sizeof</span>(bound), <span class="stringliteral">&quot;----voicemail_%d%s%d%u&quot;</span>, msgnum + 1, mailbox,</div><div class="line"><a name="l05282"></a><span class="lineno"> 5282</span>&#160;         (<span class="keywordtype">int</span>) getpid(), (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) <a class="code" href="../../d5/d60/utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());</div><div class="line"><a name="l05283"></a><span class="lineno"> 5283</span>&#160;</div><div class="line"><a name="l05284"></a><span class="lineno"> 5284</span>&#160;      fprintf(p, <span class="stringliteral">&quot;Content-Type: multipart/mixed; boundary=\&quot;%s\&quot;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, bound);</div><div class="line"><a name="l05285"></a><span class="lineno"> 5285</span>&#160;      fprintf(p, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <span class="stringliteral">&quot;This is a multi-part message in MIME format.&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);</div><div class="line"><a name="l05286"></a><span class="lineno"> 5286</span>&#160;      fprintf(p, <span class="stringliteral">&quot;--%s&quot;</span> ENDL, bound);</div><div class="line"><a name="l05287"></a><span class="lineno"> 5287</span>&#160;   }</div><div class="line"><a name="l05288"></a><span class="lineno"> 5288</span>&#160;   fprintf(p, <span class="stringliteral">&quot;Content-Type: text/plain; charset=%s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <span class="stringliteral">&quot;Content-Transfer-Encoding: 8bit&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, charset);</div><div class="line"><a name="l05289"></a><span class="lineno"> 5289</span>&#160;   <span class="keywordflow">if</span> (msgnum &lt;= -1) {</div><div class="line"><a name="l05290"></a><span class="lineno"> 5290</span>&#160;      fprintf(p, <span class="stringliteral">&quot;This message is to let you know that your greeting &#39;%s&#39; was changed on %s.&quot;</span> ENDL</div><div class="line"><a name="l05291"></a><span class="lineno"> 5291</span>&#160;            <span class="stringliteral">&quot;Please do not delete this message, lest your greeting vanish with it.&quot;</span> ENDL ENDL,</div><div class="line"><a name="l05292"></a><span class="lineno"> 5292</span>&#160;            greeting_attachment, date);</div><div class="line"><a name="l05293"></a><span class="lineno"> 5293</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (emailbody || vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>) {</div><div class="line"><a name="l05294"></a><span class="lineno"> 5294</span>&#160;      <span class="keywordtype">char</span>* e_body = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> ? vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> : <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>;</div><div class="line"><a name="l05295"></a><span class="lineno"> 5295</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast;</div><div class="line"><a name="l05296"></a><span class="lineno"> 5296</span>&#160;      <span class="keywordflow">if</span> ((ast = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l05297"></a><span class="lineno"> 5297</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</div><div class="line"><a name="l05298"></a><span class="lineno"> 5298</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a>(&amp;str1, 0, ast, e_body);</div><div class="line"><a name="l05299"></a><span class="lineno"> 5299</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l05300"></a><span class="lineno"> 5300</span>&#160;            {</div><div class="line"><a name="l05301"></a><span class="lineno"> 5301</span>&#160;               <span class="comment">/* Convert body to native line terminators for IMAP backend */</span></div><div class="line"><a name="l05302"></a><span class="lineno"> 5302</span>&#160;               <span class="keywordtype">char</span> *line = <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1), *next;</div><div class="line"><a name="l05303"></a><span class="lineno"> 5303</span>&#160;               <span class="keywordflow">do</span> {</div><div class="line"><a name="l05304"></a><span class="lineno"> 5304</span>&#160;                  <span class="comment">/* Terminate line before outputting it to the file */</span></div><div class="line"><a name="l05305"></a><span class="lineno"> 5305</span>&#160;                  <span class="keywordflow">if</span> ((next = strchr(line, <span class="charliteral">&#39;\n&#39;</span>))) {</div><div class="line"><a name="l05306"></a><span class="lineno"> 5306</span>&#160;                     *next++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05307"></a><span class="lineno"> 5307</span>&#160;                  }</div><div class="line"><a name="l05308"></a><span class="lineno"> 5308</span>&#160;                  fprintf(p, <span class="stringliteral">&quot;%s&quot;</span> ENDL, line);</div><div class="line"><a name="l05309"></a><span class="lineno"> 5309</span>&#160;                  line = next;</div><div class="line"><a name="l05310"></a><span class="lineno"> 5310</span>&#160;               } <span class="keywordflow">while</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(line));</div><div class="line"><a name="l05311"></a><span class="lineno"> 5311</span>&#160;            }</div><div class="line"><a name="l05312"></a><span class="lineno"> 5312</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l05313"></a><span class="lineno"> 5313</span>&#160;         fprintf(p, <span class="stringliteral">&quot;%s&quot;</span> ENDL, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1));</div><div class="line"><a name="l05314"></a><span class="lineno"> 5314</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05315"></a><span class="lineno"> 5315</span>&#160;         ast = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(ast);</div><div class="line"><a name="l05316"></a><span class="lineno"> 5316</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05317"></a><span class="lineno"> 5317</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);</div><div class="line"><a name="l05318"></a><span class="lineno"> 5318</span>&#160;      }</div><div class="line"><a name="l05319"></a><span class="lineno"> 5319</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05320"></a><span class="lineno"> 5320</span>&#160;      <span class="keywordflow">if</span> (strcmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, mailbox)) {</div><div class="line"><a name="l05321"></a><span class="lineno"> 5321</span>&#160;         <span class="comment">/* Forwarded type */</span></div><div class="line"><a name="l05322"></a><span class="lineno"> 5322</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l05323"></a><span class="lineno"> 5323</span>&#160;         <span class="keyword">const</span> <span class="keywordtype">char</span> *v;</div><div class="line"><a name="l05324"></a><span class="lineno"> 5324</span>&#160;         <span class="keywordtype">int</span> inttime;</div><div class="line"><a name="l05325"></a><span class="lineno"> 5325</span>&#160;         <span class="keywordtype">char</span> fromdir[256], fromfile[256], origdate[80] = <span class="stringliteral">&quot;&quot;</span>, origcallerid[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05326"></a><span class="lineno"> 5326</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l05327"></a><span class="lineno"> 5327</span>&#160;         <span class="comment">/* Retrieve info from VM attribute file */</span></div><div class="line"><a name="l05328"></a><span class="lineno"> 5328</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(fromdir, <span class="keyword">sizeof</span>(fromdir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, fromfolder);</div><div class="line"><a name="l05329"></a><span class="lineno"> 5329</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fromfile, <span class="keyword">sizeof</span>(fromfile), fromdir, msgnum);</div><div class="line"><a name="l05330"></a><span class="lineno"> 5330</span>&#160;         <span class="keywordflow">if</span> (strlen(fromfile) &lt; <span class="keyword">sizeof</span>(fromfile) - 5) {</div><div class="line"><a name="l05331"></a><span class="lineno"> 5331</span>&#160;            strcat(fromfile, <span class="stringliteral">&quot;.txt&quot;</span>);</div><div class="line"><a name="l05332"></a><span class="lineno"> 5332</span>&#160;         }</div><div class="line"><a name="l05333"></a><span class="lineno"> 5333</span>&#160;         <span class="keywordflow">if</span> ((msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(fromfile, config_flags)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg)) {</div><div class="line"><a name="l05334"></a><span class="lineno"> 5334</span>&#160;            <span class="keywordflow">if</span> ((v = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {</div><div class="line"><a name="l05335"></a><span class="lineno"> 5335</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(origcallerid, v, <span class="keyword">sizeof</span>(origcallerid));</div><div class="line"><a name="l05336"></a><span class="lineno"> 5336</span>&#160;            }</div><div class="line"><a name="l05337"></a><span class="lineno"> 5337</span>&#160;</div><div class="line"><a name="l05338"></a><span class="lineno"> 5338</span>&#160;            <span class="comment">/* You might be tempted to do origdate, except that a) it&#39;s in the wrong</span></div><div class="line"><a name="l05339"></a><span class="lineno"> 5339</span>&#160;<span class="comment">             * format, and b) it&#39;s missing for IMAP recordings. */</span></div><div class="line"><a name="l05340"></a><span class="lineno"> 5340</span>&#160;            <span class="keywordflow">if</span> ((v = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>)) &amp;&amp; sscanf(v, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;inttime) == 1) {</div><div class="line"><a name="l05341"></a><span class="lineno"> 5341</span>&#160;               <span class="keyword">struct </span>timeval tv = { inttime, };</div><div class="line"><a name="l05342"></a><span class="lineno"> 5342</span>&#160;               <span class="keyword">struct </span><a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> tm;</div><div class="line"><a name="l05343"></a><span class="lineno"> 5343</span>&#160;               <a class="code" href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a>(&amp;tv, &amp;tm, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l05344"></a><span class="lineno"> 5344</span>&#160;               <a class="code" href="../../d5/deb/localtime_8h.html#ad5092e0e84f5959f275d6de28438250e">ast_strftime_locale</a>(origdate, <span class="keyword">sizeof</span>(origdate), emaildateformat, &amp;tm, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div><div class="line"><a name="l05345"></a><span class="lineno"> 5345</span>&#160;            }</div><div class="line"><a name="l05346"></a><span class="lineno"> 5346</span>&#160;            fprintf(p, <span class="stringliteral">&quot;Dear %s:&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\tJust wanted to let you know you were just forwarded&quot;</span></div><div class="line"><a name="l05347"></a><span class="lineno"> 5347</span>&#160;               <span class="stringliteral">&quot; a %s long message (number %d)&quot;</span> ENDL <span class="stringliteral">&quot;in mailbox %s from %s, on %s&quot;</span> ENDL</div><div class="line"><a name="l05348"></a><span class="lineno"> 5348</span>&#160;               <span class="stringliteral">&quot;(originally sent by %s on %s)&quot;</span> ENDL <span class="stringliteral">&quot;so you might want to check it when you get a&quot;</span></div><div class="line"><a name="l05349"></a><span class="lineno"> 5349</span>&#160;               <span class="stringliteral">&quot; chance.  Thanks!&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\t\t\t\t--Asterisk&quot;</span> ENDL ENDL, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, dur,</div><div class="line"><a name="l05350"></a><span class="lineno"> 5350</span>&#160;               msgnum + 1, mailbox, (cidname ? cidname : (cidnum ? cidnum : <span class="stringliteral">&quot;an unknown caller&quot;</span>)),</div><div class="line"><a name="l05351"></a><span class="lineno"> 5351</span>&#160;               date, origcallerid, origdate);</div><div class="line"><a name="l05352"></a><span class="lineno"> 5352</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l05353"></a><span class="lineno"> 5353</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05354"></a><span class="lineno"> 5354</span>&#160;            <span class="keywordflow">goto</span> plain_message;</div><div class="line"><a name="l05355"></a><span class="lineno"> 5355</span>&#160;         }</div><div class="line"><a name="l05356"></a><span class="lineno"> 5356</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05357"></a><span class="lineno"> 5357</span>&#160;plain_message:</div><div class="line"><a name="l05358"></a><span class="lineno"> 5358</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Dear %s:&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\tJust wanted to let you know you were just left a &quot;</span></div><div class="line"><a name="l05359"></a><span class="lineno"> 5359</span>&#160;            <span class="stringliteral">&quot;%s long message (number %d)&quot;</span> ENDL <span class="stringliteral">&quot;in mailbox %s from %s, on %s so you might&quot;</span> ENDL</div><div class="line"><a name="l05360"></a><span class="lineno"> 5360</span>&#160;            <span class="stringliteral">&quot;want to check it when you get a chance.  Thanks!&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\t\t\t\t--Asterisk&quot;</span></div><div class="line"><a name="l05361"></a><span class="lineno"> 5361</span>&#160;            ENDL ENDL, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, dur, msgnum + 1, mailbox,</div><div class="line"><a name="l05362"></a><span class="lineno"> 5362</span>&#160;            (cidname ? cidname : (cidnum ? cidnum : <span class="stringliteral">&quot;an unknown caller&quot;</span>)), date);</div><div class="line"><a name="l05363"></a><span class="lineno"> 5363</span>&#160;      }</div><div class="line"><a name="l05364"></a><span class="lineno"> 5364</span>&#160;   }</div><div class="line"><a name="l05365"></a><span class="lineno"> 5365</span>&#160;</div><div class="line"><a name="l05366"></a><span class="lineno"> 5366</span>&#160;   <span class="keywordflow">if</span> (imap || attach_user_voicemail) {</div><div class="line"><a name="l05367"></a><span class="lineno"> 5367</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(attach2)) {</div><div class="line"><a name="l05368"></a><span class="lineno"> 5368</span>&#160;         snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;msg%04d.%s&quot;</span>, msgnum, format);</div><div class="line"><a name="l05369"></a><span class="lineno"> 5369</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;creating second attachment filename %s\n&quot;</span>, filename);</div><div class="line"><a name="l05370"></a><span class="lineno"> 5370</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(p, vmu, format, attach, greeting_attachment, mailbox, bound, filename, 0, msgnum);</div><div class="line"><a name="l05371"></a><span class="lineno"> 5371</span>&#160;         snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;msgintro%04d.%s&quot;</span>, msgnum, format);</div><div class="line"><a name="l05372"></a><span class="lineno"> 5372</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;creating attachment filename %s\n&quot;</span>, filename);</div><div class="line"><a name="l05373"></a><span class="lineno"> 5373</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(p, vmu, format, attach2, greeting_attachment, mailbox, bound, filename, 1, msgnum);</div><div class="line"><a name="l05374"></a><span class="lineno"> 5374</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05375"></a><span class="lineno"> 5375</span>&#160;         snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;msg%04d.%s&quot;</span>, msgnum, format);</div><div class="line"><a name="l05376"></a><span class="lineno"> 5376</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;creating attachment filename %s, no second attachment.\n&quot;</span>, filename);</div><div class="line"><a name="l05377"></a><span class="lineno"> 5377</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(p, vmu, format, attach, greeting_attachment, mailbox, bound, filename, 1, msgnum);</div><div class="line"><a name="l05378"></a><span class="lineno"> 5378</span>&#160;      }</div><div class="line"><a name="l05379"></a><span class="lineno"> 5379</span>&#160;   }</div><div class="line"><a name="l05380"></a><span class="lineno"> 5380</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str1);</div><div class="line"><a name="l05381"></a><span class="lineno"> 5381</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str2);</div><div class="line"><a name="l05382"></a><span class="lineno"> 5382</span>&#160;}</div><div class="line"><a name="l05383"></a><span class="lineno"> 5383</span>&#160;</div><div class="line"><a name="l05384"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf"> 5384</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(FILE *p, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *format, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *greeting_attachment, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">char</span> *bound, <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> <a class="code" href="../../df/d44/app__meetme_8c.html#ae9dd6bdb4c5c0529195a03583d0d4a8d">last</a>, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l05385"></a><span class="lineno"> 5385</span>&#160;{</div><div class="line"><a name="l05386"></a><span class="lineno"> 5386</span>&#160;   <span class="keywordtype">char</span> fname[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05387"></a><span class="lineno"> 5387</span>&#160;   <span class="keywordtype">char</span> sox_gain_tmpdir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05388"></a><span class="lineno"> 5388</span>&#160;   <span class="keywordtype">char</span> *file_to_delete = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dir_to_delete = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l05389"></a><span class="lineno"> 5389</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l05390"></a><span class="lineno"> 5390</span>&#160;   <span class="keywordtype">char</span> altfname[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05391"></a><span class="lineno"> 5391</span>&#160;   <span class="keywordtype">int</span> altused = 0;</div><div class="line"><a name="l05392"></a><span class="lineno"> 5392</span>&#160;   <span class="keywordtype">char</span> altformat[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05393"></a><span class="lineno"> 5393</span>&#160;   <span class="keywordtype">char</span> *c = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l05394"></a><span class="lineno"> 5394</span>&#160;</div><div class="line"><a name="l05395"></a><span class="lineno"> 5395</span>&#160;   <span class="comment">/* Eww. We want formats to tell us their own MIME type */</span></div><div class="line"><a name="l05396"></a><span class="lineno"> 5396</span>&#160;   <span class="keywordtype">char</span> *mime_type = (!strcasecmp(format, <span class="stringliteral">&quot;ogg&quot;</span>)) ? <span class="stringliteral">&quot;application/&quot;</span> : <span class="stringliteral">&quot;audio/x-&quot;</span>;</div><div class="line"><a name="l05397"></a><span class="lineno"> 5397</span>&#160;</div><div class="line"><a name="l05398"></a><span class="lineno"> 5398</span>&#160;   <span class="comment">/* Users of multiple file formats need special attention. */</span></div><div class="line"><a name="l05399"></a><span class="lineno"> 5399</span>&#160;   snprintf(fname, <span class="keyword">sizeof</span>(fname), <span class="stringliteral">&quot;%s.%s&quot;</span>, attach, format);</div><div class="line"><a name="l05400"></a><span class="lineno"> 5400</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a34ed7a76195d923c099606f796294a3b">ast_file_is_readable</a>(fname)) {</div><div class="line"><a name="l05401"></a><span class="lineno"> 5401</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(altformat, vmfmts, <span class="keyword">sizeof</span>(altformat));</div><div class="line"><a name="l05402"></a><span class="lineno"> 5402</span>&#160;      c = strchr(altformat, <span class="charliteral">&#39;|&#39;</span>);</div><div class="line"><a name="l05403"></a><span class="lineno"> 5403</span>&#160;      <span class="keywordflow">if</span> (c) {</div><div class="line"><a name="l05404"></a><span class="lineno"> 5404</span>&#160;         *c = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05405"></a><span class="lineno"> 5405</span>&#160;      }</div><div class="line"><a name="l05406"></a><span class="lineno"> 5406</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open file: %s: %s - trying first/alternate format %s\n&quot;</span>, fname, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>), altformat);</div><div class="line"><a name="l05407"></a><span class="lineno"> 5407</span>&#160;      snprintf(altfname, <span class="keyword">sizeof</span>(altfname), <span class="stringliteral">&quot;%s.%s&quot;</span>, attach, altformat);</div><div class="line"><a name="l05408"></a><span class="lineno"> 5408</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a34ed7a76195d923c099606f796294a3b">ast_file_is_readable</a>(altfname)) {</div><div class="line"><a name="l05409"></a><span class="lineno"> 5409</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open file: %s: %s - alternate format %s failure\n&quot;</span>, altfname, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>), altformat);</div><div class="line"><a name="l05410"></a><span class="lineno"> 5410</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05411"></a><span class="lineno"> 5411</span>&#160;         altused = 1;</div><div class="line"><a name="l05412"></a><span class="lineno"> 5412</span>&#160;      }</div><div class="line"><a name="l05413"></a><span class="lineno"> 5413</span>&#160;   }</div><div class="line"><a name="l05414"></a><span class="lineno"> 5414</span>&#160;</div><div class="line"><a name="l05415"></a><span class="lineno"> 5415</span>&#160;   <span class="comment">/* This &#39;while&#39; loop will only execute once. We use it so that we can &#39;break&#39; */</span></div><div class="line"><a name="l05416"></a><span class="lineno"> 5416</span>&#160;   <span class="keywordflow">while</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &lt; -.001 || vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &gt; .001 || altused) {</div><div class="line"><a name="l05417"></a><span class="lineno"> 5417</span>&#160;      <span class="keywordtype">char</span> tmpdir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05418"></a><span class="lineno"> 5418</span>&#160;</div><div class="line"><a name="l05419"></a><span class="lineno"> 5419</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(tmpdir, <span class="keyword">sizeof</span>(tmpdir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="stringliteral">&quot;tmp&quot;</span>);</div><div class="line"><a name="l05420"></a><span class="lineno"> 5420</span>&#160;</div><div class="line"><a name="l05421"></a><span class="lineno"> 5421</span>&#160;      res = snprintf(sox_gain_tmpdir, <span class="keyword">sizeof</span>(sox_gain_tmpdir), <span class="stringliteral">&quot;%s/vm-gain-XXXXXX&quot;</span>, tmpdir);</div><div class="line"><a name="l05422"></a><span class="lineno"> 5422</span>&#160;      <span class="keywordflow">if</span> (res &gt;= <span class="keyword">sizeof</span>(sox_gain_tmpdir)) {</div><div class="line"><a name="l05423"></a><span class="lineno"> 5423</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create temporary directory path %s: Out of buffer space\n&quot;</span>, tmpdir);</div><div class="line"><a name="l05424"></a><span class="lineno"> 5424</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l05425"></a><span class="lineno"> 5425</span>&#160;      }</div><div class="line"><a name="l05426"></a><span class="lineno"> 5426</span>&#160;</div><div class="line"><a name="l05427"></a><span class="lineno"> 5427</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a09c40bd781f93eb20cdd2eedf34eadeb">mkdtemp</a>(sox_gain_tmpdir)) {</div><div class="line"><a name="l05428"></a><span class="lineno"> 5428</span>&#160;         <span class="keywordtype">int</span> soxstatus = 0;</div><div class="line"><a name="l05429"></a><span class="lineno"> 5429</span>&#160;         <span class="keywordtype">char</span> sox_gain_cmd[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05430"></a><span class="lineno"> 5430</span>&#160;</div><div class="line"><a name="l05431"></a><span class="lineno"> 5431</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;sox_gain_tmpdir: %s\n&quot;</span>, sox_gain_tmpdir);</div><div class="line"><a name="l05432"></a><span class="lineno"> 5432</span>&#160;</div><div class="line"><a name="l05433"></a><span class="lineno"> 5433</span>&#160;         <span class="comment">/* Save for later */</span></div><div class="line"><a name="l05434"></a><span class="lineno"> 5434</span>&#160;         dir_to_delete = sox_gain_tmpdir;</div><div class="line"><a name="l05435"></a><span class="lineno"> 5435</span>&#160;</div><div class="line"><a name="l05436"></a><span class="lineno"> 5436</span>&#160;         res = snprintf(fname, <span class="keyword">sizeof</span>(fname), <span class="stringliteral">&quot;%s/output.%s&quot;</span>, sox_gain_tmpdir, format);</div><div class="line"><a name="l05437"></a><span class="lineno"> 5437</span>&#160;         <span class="keywordflow">if</span> (res &gt;= <span class="keyword">sizeof</span>(fname)) {</div><div class="line"><a name="l05438"></a><span class="lineno"> 5438</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create filename buffer for %s/output.%s: Too long\n&quot;</span>, sox_gain_tmpdir, format);</div><div class="line"><a name="l05439"></a><span class="lineno"> 5439</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l05440"></a><span class="lineno"> 5440</span>&#160;         }</div><div class="line"><a name="l05441"></a><span class="lineno"> 5441</span>&#160;</div><div class="line"><a name="l05442"></a><span class="lineno"> 5442</span>&#160;         <span class="keywordflow">if</span> (!altused) {</div><div class="line"><a name="l05443"></a><span class="lineno"> 5443</span>&#160;            res = snprintf(sox_gain_cmd, <span class="keyword">sizeof</span>(sox_gain_cmd), <span class="stringliteral">&quot;sox -v %.4f %s.%s %s&quot;</span>,</div><div class="line"><a name="l05444"></a><span class="lineno"> 5444</span>&#160;                        vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>, attach, format, fname);</div><div class="line"><a name="l05445"></a><span class="lineno"> 5445</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05446"></a><span class="lineno"> 5446</span>&#160;            <span class="keywordflow">if</span> (!strcasecmp(format, <span class="stringliteral">&quot;wav&quot;</span>)) {</div><div class="line"><a name="l05447"></a><span class="lineno"> 5447</span>&#160;               <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &lt; -.001 || vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &gt; .001) {</div><div class="line"><a name="l05448"></a><span class="lineno"> 5448</span>&#160;                  res = snprintf(sox_gain_cmd, <span class="keyword">sizeof</span>(sox_gain_cmd), <span class="stringliteral">&quot;sox -v %.4f %s.%s -e signed-integer -b 16 %s&quot;</span>,</div><div class="line"><a name="l05449"></a><span class="lineno"> 5449</span>&#160;                              vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>, attach, altformat, fname);</div><div class="line"><a name="l05450"></a><span class="lineno"> 5450</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05451"></a><span class="lineno"> 5451</span>&#160;                  res = snprintf(sox_gain_cmd, <span class="keyword">sizeof</span>(sox_gain_cmd), <span class="stringliteral">&quot;sox %s.%s -e signed-integer -b 16 %s&quot;</span>,</div><div class="line"><a name="l05452"></a><span class="lineno"> 5452</span>&#160;                              attach, altformat, fname);</div><div class="line"><a name="l05453"></a><span class="lineno"> 5453</span>&#160;               }</div><div class="line"><a name="l05454"></a><span class="lineno"> 5454</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05455"></a><span class="lineno"> 5455</span>&#160;               <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &lt; -.001 || vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &gt; .001) {</div><div class="line"><a name="l05456"></a><span class="lineno"> 5456</span>&#160;                  res = snprintf(sox_gain_cmd, <span class="keyword">sizeof</span>(sox_gain_cmd), <span class="stringliteral">&quot;sox -v %.4f %s.%s %s&quot;</span>,</div><div class="line"><a name="l05457"></a><span class="lineno"> 5457</span>&#160;                              vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>, attach, altformat, fname);</div><div class="line"><a name="l05458"></a><span class="lineno"> 5458</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05459"></a><span class="lineno"> 5459</span>&#160;                  res = snprintf(sox_gain_cmd, <span class="keyword">sizeof</span>(sox_gain_cmd), <span class="stringliteral">&quot;sox %s.%s %s&quot;</span>,</div><div class="line"><a name="l05460"></a><span class="lineno"> 5460</span>&#160;                              attach, altformat, fname);</div><div class="line"><a name="l05461"></a><span class="lineno"> 5461</span>&#160;               }</div><div class="line"><a name="l05462"></a><span class="lineno"> 5462</span>&#160;            }</div><div class="line"><a name="l05463"></a><span class="lineno"> 5463</span>&#160;         }</div><div class="line"><a name="l05464"></a><span class="lineno"> 5464</span>&#160;</div><div class="line"><a name="l05465"></a><span class="lineno"> 5465</span>&#160;         <span class="keywordflow">if</span> (res &gt;= <span class="keyword">sizeof</span>(sox_gain_cmd)) {</div><div class="line"><a name="l05466"></a><span class="lineno"> 5466</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to generate sox command, out of buffer space\n&quot;</span>);</div><div class="line"><a name="l05467"></a><span class="lineno"> 5467</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l05468"></a><span class="lineno"> 5468</span>&#160;         }</div><div class="line"><a name="l05469"></a><span class="lineno"> 5469</span>&#160;</div><div class="line"><a name="l05470"></a><span class="lineno"> 5470</span>&#160;         soxstatus = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(sox_gain_cmd);</div><div class="line"><a name="l05471"></a><span class="lineno"> 5471</span>&#160;         <span class="keywordflow">if</span> (!soxstatus) {</div><div class="line"><a name="l05472"></a><span class="lineno"> 5472</span>&#160;            <span class="comment">/* Save for later */</span></div><div class="line"><a name="l05473"></a><span class="lineno"> 5473</span>&#160;            file_to_delete = fname;</div><div class="line"><a name="l05474"></a><span class="lineno"> 5474</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;VOLGAIN: Stored at: %s - Level: %.4f - Mailbox: %s\n&quot;</span>, fname, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>, mailbox);</div><div class="line"><a name="l05475"></a><span class="lineno"> 5475</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05476"></a><span class="lineno"> 5476</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Sox failed to re-encode %s: %s (have you installed support for all sox file formats?)\n&quot;</span>,</div><div class="line"><a name="l05477"></a><span class="lineno"> 5477</span>&#160;                  fname,</div><div class="line"><a name="l05478"></a><span class="lineno"> 5478</span>&#160;                  soxstatus == 1 ? <span class="stringliteral">&quot;Problem with command line options&quot;</span> : <span class="stringliteral">&quot;An error occurred during file processing&quot;</span>);</div><div class="line"><a name="l05479"></a><span class="lineno"> 5479</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Voicemail attachment will have no volume gain.\n&quot;</span>);</div><div class="line"><a name="l05480"></a><span class="lineno"> 5480</span>&#160;         }</div><div class="line"><a name="l05481"></a><span class="lineno"> 5481</span>&#160;      }</div><div class="line"><a name="l05482"></a><span class="lineno"> 5482</span>&#160;</div><div class="line"><a name="l05483"></a><span class="lineno"> 5483</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l05484"></a><span class="lineno"> 5484</span>&#160;   }</div><div class="line"><a name="l05485"></a><span class="lineno"> 5485</span>&#160;</div><div class="line"><a name="l05486"></a><span class="lineno"> 5486</span>&#160;   <span class="keywordflow">if</span> (!file_to_delete) {</div><div class="line"><a name="l05487"></a><span class="lineno"> 5487</span>&#160;      res = snprintf(fname, <span class="keyword">sizeof</span>(fname), <span class="stringliteral">&quot;%s.%s&quot;</span>, attach, format);</div><div class="line"><a name="l05488"></a><span class="lineno"> 5488</span>&#160;      <span class="keywordflow">if</span> (res &gt;= <span class="keyword">sizeof</span>(fname)) {</div><div class="line"><a name="l05489"></a><span class="lineno"> 5489</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create filename buffer for %s.%s: Too long\n&quot;</span>, attach, format);</div><div class="line"><a name="l05490"></a><span class="lineno"> 5490</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05491"></a><span class="lineno"> 5491</span>&#160;      }</div><div class="line"><a name="l05492"></a><span class="lineno"> 5492</span>&#160;   }</div><div class="line"><a name="l05493"></a><span class="lineno"> 5493</span>&#160;</div><div class="line"><a name="l05494"></a><span class="lineno"> 5494</span>&#160;   fprintf(p, <span class="stringliteral">&quot;--%s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, bound);</div><div class="line"><a name="l05495"></a><span class="lineno"> 5495</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1)</div><div class="line"><a name="l05496"></a><span class="lineno"> 5496</span>&#160;      fprintf(p, <span class="stringliteral">&quot;Content-Type: %s%s; name=\&quot;%s\&quot;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, mime_type, format, filename);</div><div class="line"><a name="l05497"></a><span class="lineno"> 5497</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l05498"></a><span class="lineno"> 5498</span>&#160;      fprintf(p, <span class="stringliteral">&quot;Content-Type: %s%s; name=\&quot;%s.%s\&quot;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, mime_type, format, greeting_attachment, format);</div><div class="line"><a name="l05499"></a><span class="lineno"> 5499</span>&#160;   fprintf(p, <span class="stringliteral">&quot;Content-Transfer-Encoding: base64&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);</div><div class="line"><a name="l05500"></a><span class="lineno"> 5500</span>&#160;   fprintf(p, <span class="stringliteral">&quot;Content-Description: Voicemail sound attachment.&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);</div><div class="line"><a name="l05501"></a><span class="lineno"> 5501</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1)</div><div class="line"><a name="l05502"></a><span class="lineno"> 5502</span>&#160;      fprintf(p, <span class="stringliteral">&quot;Content-Disposition: attachment; filename=\&quot;%s\&quot;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, filename);</div><div class="line"><a name="l05503"></a><span class="lineno"> 5503</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l05504"></a><span class="lineno"> 5504</span>&#160;      fprintf(p, <span class="stringliteral">&quot;Content-Disposition: attachment; filename=\&quot;%s.%s\&quot;&quot;</span> ENDL ENDL, greeting_attachment, format);</div><div class="line"><a name="l05505"></a><span class="lineno"> 5505</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17">base_encode</a>(fname, p);</div><div class="line"><a name="l05506"></a><span class="lineno"> 5506</span>&#160;   <span class="keywordflow">if</span> (last)</div><div class="line"><a name="l05507"></a><span class="lineno"> 5507</span>&#160;      fprintf(p, ENDL ENDL <span class="stringliteral">&quot;--%s--&quot;</span> ENDL <span class="stringliteral">&quot;.&quot;</span> ENDL, bound);</div><div class="line"><a name="l05508"></a><span class="lineno"> 5508</span>&#160;</div><div class="line"><a name="l05509"></a><span class="lineno"> 5509</span>&#160;   <span class="keywordflow">if</span> (file_to_delete) {</div><div class="line"><a name="l05510"></a><span class="lineno"> 5510</span>&#160;      unlink(file_to_delete);</div><div class="line"><a name="l05511"></a><span class="lineno"> 5511</span>&#160;   }</div><div class="line"><a name="l05512"></a><span class="lineno"> 5512</span>&#160;</div><div class="line"><a name="l05513"></a><span class="lineno"> 5513</span>&#160;   <span class="keywordflow">if</span> (dir_to_delete) {</div><div class="line"><a name="l05514"></a><span class="lineno"> 5514</span>&#160;      rmdir(dir_to_delete);</div><div class="line"><a name="l05515"></a><span class="lineno"> 5515</span>&#160;   }</div><div class="line"><a name="l05516"></a><span class="lineno"> 5516</span>&#160;</div><div class="line"><a name="l05517"></a><span class="lineno"> 5517</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05518"></a><span class="lineno"> 5518</span>&#160;}</div><div class="line"><a name="l05519"></a><span class="lineno"> 5519</span>&#160;</div><div class="line"><a name="l05520"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3fd02e9399fad0b67dd0a7d6f4af464e"> 5520</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3fd02e9399fad0b67dd0a7d6f4af464e">sendmail</a>(<span class="keywordtype">char</span> *srcemail,</div><div class="line"><a name="l05521"></a><span class="lineno"> 5521</span>&#160;      <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu,</div><div class="line"><a name="l05522"></a><span class="lineno"> 5522</span>&#160;      <span class="keywordtype">int</span> msgnum,</div><div class="line"><a name="l05523"></a><span class="lineno"> 5523</span>&#160;      <span class="keywordtype">char</span> *context,</div><div class="line"><a name="l05524"></a><span class="lineno"> 5524</span>&#160;      <span class="keywordtype">char</span> *mailbox,</div><div class="line"><a name="l05525"></a><span class="lineno"> 5525</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder,</div><div class="line"><a name="l05526"></a><span class="lineno"> 5526</span>&#160;      <span class="keywordtype">char</span> *cidnum,</div><div class="line"><a name="l05527"></a><span class="lineno"> 5527</span>&#160;      <span class="keywordtype">char</span> *cidname,</div><div class="line"><a name="l05528"></a><span class="lineno"> 5528</span>&#160;      <span class="keywordtype">char</span> *attach,</div><div class="line"><a name="l05529"></a><span class="lineno"> 5529</span>&#160;      <span class="keywordtype">char</span> *attach2,</div><div class="line"><a name="l05530"></a><span class="lineno"> 5530</span>&#160;      <span class="keywordtype">char</span> *format,</div><div class="line"><a name="l05531"></a><span class="lineno"> 5531</span>&#160;      <span class="keywordtype">int</span> duration,</div><div class="line"><a name="l05532"></a><span class="lineno"> 5532</span>&#160;      <span class="keywordtype">int</span> attach_user_voicemail,</div><div class="line"><a name="l05533"></a><span class="lineno"> 5533</span>&#160;      <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line"><a name="l05534"></a><span class="lineno"> 5534</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *category,</div><div class="line"><a name="l05535"></a><span class="lineno"> 5535</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *flag,</div><div class="line"><a name="l05536"></a><span class="lineno"> 5536</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id)</div><div class="line"><a name="l05537"></a><span class="lineno"> 5537</span>&#160;{</div><div class="line"><a name="l05538"></a><span class="lineno"> 5538</span>&#160;   FILE *p = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l05539"></a><span class="lineno"> 5539</span>&#160;   <span class="keywordtype">char</span> tmp[80] = <span class="stringliteral">&quot;/tmp/astmail-XXXXXX&quot;</span>;</div><div class="line"><a name="l05540"></a><span class="lineno"> 5540</span>&#160;   <span class="keywordtype">char</span> tmp2[256];</div><div class="line"><a name="l05541"></a><span class="lineno"> 5541</span>&#160;   <span class="keywordtype">char</span> *stringp;</div><div class="line"><a name="l05542"></a><span class="lineno"> 5542</span>&#160;</div><div class="line"><a name="l05543"></a><span class="lineno"> 5543</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>)) {</div><div class="line"><a name="l05544"></a><span class="lineno"> 5544</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;E-mail address missing for mailbox [%s].  E-mail will not be sent.\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l05545"></a><span class="lineno"> 5545</span>&#160;      <span class="keywordflow">return</span>(0);</div><div class="line"><a name="l05546"></a><span class="lineno"> 5546</span>&#160;   }</div><div class="line"><a name="l05547"></a><span class="lineno"> 5547</span>&#160;</div><div class="line"><a name="l05548"></a><span class="lineno"> 5548</span>&#160;   <span class="comment">/* Mail only the first format */</span></div><div class="line"><a name="l05549"></a><span class="lineno"> 5549</span>&#160;   format = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(format);</div><div class="line"><a name="l05550"></a><span class="lineno"> 5550</span>&#160;   stringp = <a class="code" href="../../da/d45/chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>;</div><div class="line"><a name="l05551"></a><span class="lineno"> 5551</span>&#160;   <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);</div><div class="line"><a name="l05552"></a><span class="lineno"> 5552</span>&#160;</div><div class="line"><a name="l05553"></a><span class="lineno"> 5553</span>&#160;   <span class="keywordflow">if</span> (!strcmp(format, <span class="stringliteral">&quot;wav49&quot;</span>))</div><div class="line"><a name="l05554"></a><span class="lineno"> 5554</span>&#160;      format = <span class="stringliteral">&quot;WAV&quot;</span>;</div><div class="line"><a name="l05555"></a><span class="lineno"> 5555</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Attaching file &#39;%s&#39;, format &#39;%s&#39;, uservm is &#39;%d&#39;, global is %u\n&quot;</span>, attach, format, attach_user_voicemail, <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>));</div><div class="line"><a name="l05556"></a><span class="lineno"> 5556</span>&#160;   <span class="comment">/* Make a temporary file instead of piping directly to sendmail, in case the mail</span></div><div class="line"><a name="l05557"></a><span class="lineno"> 5557</span>&#160;<span class="comment">      command hangs */</span></div><div class="line"><a name="l05558"></a><span class="lineno"> 5558</span>&#160;   <span class="keywordflow">if</span> ((p = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(tmp)) == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line"><a name="l05559"></a><span class="lineno"> 5559</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to launch &#39;%s&#39; (can&#39;t create temporary file)\n&quot;</span>, mailcmd);</div><div class="line"><a name="l05560"></a><span class="lineno"> 5560</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05561"></a><span class="lineno"> 5561</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05562"></a><span class="lineno"> 5562</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0">make_email_file</a>(p, srcemail, vmu, msgnum, context, mailbox, fromfolder, cidnum, cidname, attach, attach2, format, duration, attach_user_voicemail, chan, category, 0, flag, msg_id);</div><div class="line"><a name="l05563"></a><span class="lineno"> 5563</span>&#160;      fclose(p);</div><div class="line"><a name="l05564"></a><span class="lineno"> 5564</span>&#160;      snprintf(tmp2, <span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">&quot;( %s &lt; %s ; rm -f %s ) &amp;&quot;</span>, mailcmd, tmp, tmp);</div><div class="line"><a name="l05565"></a><span class="lineno"> 5565</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(tmp2);</div><div class="line"><a name="l05566"></a><span class="lineno"> 5566</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Sent mail to %s with command &#39;%s&#39;\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>, mailcmd);</div><div class="line"><a name="l05567"></a><span class="lineno"> 5567</span>&#160;   }</div><div class="line"><a name="l05568"></a><span class="lineno"> 5568</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05569"></a><span class="lineno"> 5569</span>&#160;}</div><div class="line"><a name="l05570"></a><span class="lineno"> 5570</span>&#160;</div><div class="line"><a name="l05571"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe"> 5571</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe">sendpage</a>(<span class="keywordtype">char</span> *srcemail, <span class="keywordtype">char</span> *pager, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">int</span> duration, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)</div><div class="line"><a name="l05572"></a><span class="lineno"> 5572</span>&#160;{</div><div class="line"><a name="l05573"></a><span class="lineno"> 5573</span>&#160;   <span class="keywordtype">char</span> enc_cidnum[256], enc_cidname[256];</div><div class="line"><a name="l05574"></a><span class="lineno"> 5574</span>&#160;   <span class="keywordtype">char</span> date[256];</div><div class="line"><a name="l05575"></a><span class="lineno"> 5575</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/d8a/muted_8c.html#a41c3a180b50c6b2ddcc1b6843a48f205">host</a>[<a class="code" href="../../d9/d94/network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05576"></a><span class="lineno"> 5576</span>&#160;   <span class="keywordtype">char</span> who[256];</div><div class="line"><a name="l05577"></a><span class="lineno"> 5577</span>&#160;   <span class="keywordtype">char</span> dur[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05578"></a><span class="lineno"> 5578</span>&#160;   <span class="keywordtype">char</span> tmp[80] = <span class="stringliteral">&quot;/tmp/astmail-XXXXXX&quot;</span>;</div><div class="line"><a name="l05579"></a><span class="lineno"> 5579</span>&#160;   <span class="keywordtype">char</span> tmp2[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05580"></a><span class="lineno"> 5580</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> tm;</div><div class="line"><a name="l05581"></a><span class="lineno"> 5581</span>&#160;   FILE *p;</div><div class="line"><a name="l05582"></a><span class="lineno"> 5582</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> *str1 = <a class="code" href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a>(16), *str2 = <a class="code" href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a>(16);</div><div class="line"><a name="l05583"></a><span class="lineno"> 5583</span>&#160;</div><div class="line"><a name="l05584"></a><span class="lineno"> 5584</span>&#160;   <span class="keywordflow">if</span> (!str1 || !str2) {</div><div class="line"><a name="l05585"></a><span class="lineno"> 5585</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str1);</div><div class="line"><a name="l05586"></a><span class="lineno"> 5586</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str2);</div><div class="line"><a name="l05587"></a><span class="lineno"> 5587</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05588"></a><span class="lineno"> 5588</span>&#160;   }</div><div class="line"><a name="l05589"></a><span class="lineno"> 5589</span>&#160;</div><div class="line"><a name="l05590"></a><span class="lineno"> 5590</span>&#160;   <span class="keywordflow">if</span> (cidnum) {</div><div class="line"><a name="l05591"></a><span class="lineno"> 5591</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">strip_control_and_high</a>(cidnum, enc_cidnum, <span class="keyword">sizeof</span>(enc_cidnum));</div><div class="line"><a name="l05592"></a><span class="lineno"> 5592</span>&#160;   }</div><div class="line"><a name="l05593"></a><span class="lineno"> 5593</span>&#160;   <span class="keywordflow">if</span> (cidname) {</div><div class="line"><a name="l05594"></a><span class="lineno"> 5594</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">strip_control_and_high</a>(cidname, enc_cidname, <span class="keyword">sizeof</span>(enc_cidname));</div><div class="line"><a name="l05595"></a><span class="lineno"> 5595</span>&#160;   }</div><div class="line"><a name="l05596"></a><span class="lineno"> 5596</span>&#160;</div><div class="line"><a name="l05597"></a><span class="lineno"> 5597</span>&#160;   <span class="keywordflow">if</span> ((p = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(tmp)) == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line"><a name="l05598"></a><span class="lineno"> 5598</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to launch &#39;%s&#39; (can&#39;t create temporary file)\n&quot;</span>, mailcmd);</div><div class="line"><a name="l05599"></a><span class="lineno"> 5599</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str1);</div><div class="line"><a name="l05600"></a><span class="lineno"> 5600</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str2);</div><div class="line"><a name="l05601"></a><span class="lineno"> 5601</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05602"></a><span class="lineno"> 5602</span>&#160;   }</div><div class="line"><a name="l05603"></a><span class="lineno"> 5603</span>&#160;   gethostname(host, <span class="keyword">sizeof</span>(host)-1);</div><div class="line"><a name="l05604"></a><span class="lineno"> 5604</span>&#160;   <span class="keywordflow">if</span> (strchr(srcemail, <span class="charliteral">&#39;@&#39;</span>)) {</div><div class="line"><a name="l05605"></a><span class="lineno"> 5605</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(who, srcemail, <span class="keyword">sizeof</span>(who));</div><div class="line"><a name="l05606"></a><span class="lineno"> 5606</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05607"></a><span class="lineno"> 5607</span>&#160;      snprintf(who, <span class="keyword">sizeof</span>(who), <span class="stringliteral">&quot;%s@%s&quot;</span>, srcemail, host);</div><div class="line"><a name="l05608"></a><span class="lineno"> 5608</span>&#160;   }</div><div class="line"><a name="l05609"></a><span class="lineno"> 5609</span>&#160;   snprintf(dur, <span class="keyword">sizeof</span>(dur), <span class="stringliteral">&quot;%d:%02d&quot;</span>, duration / 60, duration % 60);</div><div class="line"><a name="l05610"></a><span class="lineno"> 5610</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#aa8e63928b14a347bd3973d680b885f93">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), <span class="stringliteral">&quot;%a, %d %b %Y %H:%M:%S %z&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac80ec334a4e45426a7c522b34d1c4774">vmu_tm</a>(vmu, &amp;tm));</div><div class="line"><a name="l05611"></a><span class="lineno"> 5611</span>&#160;   fprintf(p, <span class="stringliteral">&quot;Date: %s\n&quot;</span>, date);</div><div class="line"><a name="l05612"></a><span class="lineno"> 5612</span>&#160;</div><div class="line"><a name="l05613"></a><span class="lineno"> 5613</span>&#160;   <span class="comment">/* Reformat for custom pager format */</span></div><div class="line"><a name="l05614"></a><span class="lineno"> 5614</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#ad5092e0e84f5959f275d6de28438250e">ast_strftime_locale</a>(date, <span class="keyword">sizeof</span>(date), pagerdateformat, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac80ec334a4e45426a7c522b34d1c4774">vmu_tm</a>(vmu, &amp;tm), <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div><div class="line"><a name="l05615"></a><span class="lineno"> 5615</span>&#160;</div><div class="line"><a name="l05616"></a><span class="lineno"> 5616</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(pagerfromstring)) {</div><div class="line"><a name="l05617"></a><span class="lineno"> 5617</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast;</div><div class="line"><a name="l05618"></a><span class="lineno"> 5618</span>&#160;      <span class="keywordflow">if</span> ((ast = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l05619"></a><span class="lineno"> 5619</span>&#160;         <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l05620"></a><span class="lineno"> 5620</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, enc_cidnum, enc_cidname, dur, date, category, flag);</div><div class="line"><a name="l05621"></a><span class="lineno"> 5621</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a>(&amp;str1, 0, ast, pagerfromstring);</div><div class="line"><a name="l05622"></a><span class="lineno"> 5622</span>&#160;</div><div class="line"><a name="l05623"></a><span class="lineno"> 5623</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1))) {</div><div class="line"><a name="l05624"></a><span class="lineno"> 5624</span>&#160;            <span class="keywordtype">int</span> first_line = 1;</div><div class="line"><a name="l05625"></a><span class="lineno"> 5625</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(&amp;str2, 0, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1), strlen(<span class="stringliteral">&quot;From: &quot;</span>), strlen(who) + 3);</div><div class="line"><a name="l05626"></a><span class="lineno"> 5626</span>&#160;            <span class="keywordflow">while</span> ((ptr = strchr(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), <span class="charliteral">&#39; &#39;</span>))) {</div><div class="line"><a name="l05627"></a><span class="lineno"> 5627</span>&#160;               *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05628"></a><span class="lineno"> 5628</span>&#160;               fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;From:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05629"></a><span class="lineno"> 5629</span>&#160;               first_line = 0;</div><div class="line"><a name="l05630"></a><span class="lineno"> 5630</span>&#160;               <span class="comment">/* Substring is smaller, so this will never grow */</span></div><div class="line"><a name="l05631"></a><span class="lineno"> 5631</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;str2, 0, <span class="stringliteral">&quot;%s&quot;</span>, ptr + 1);</div><div class="line"><a name="l05632"></a><span class="lineno"> 5632</span>&#160;            }</div><div class="line"><a name="l05633"></a><span class="lineno"> 5633</span>&#160;            fprintf(p, <span class="stringliteral">&quot;%s %s &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;From:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), who);</div><div class="line"><a name="l05634"></a><span class="lineno"> 5634</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05635"></a><span class="lineno"> 5635</span>&#160;            fprintf(p, <span class="stringliteral">&quot;From: %s &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258">ast_str_quote</a>(&amp;str2, 0, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1)), who);</div><div class="line"><a name="l05636"></a><span class="lineno"> 5636</span>&#160;         }</div><div class="line"><a name="l05637"></a><span class="lineno"> 5637</span>&#160;         ast = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(ast);</div><div class="line"><a name="l05638"></a><span class="lineno"> 5638</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05639"></a><span class="lineno"> 5639</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);</div><div class="line"><a name="l05640"></a><span class="lineno"> 5640</span>&#160;      }</div><div class="line"><a name="l05641"></a><span class="lineno"> 5641</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05642"></a><span class="lineno"> 5642</span>&#160;      fprintf(p, <span class="stringliteral">&quot;From: Asterisk PBX &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, who);</div><div class="line"><a name="l05643"></a><span class="lineno"> 5643</span>&#160;   }</div><div class="line"><a name="l05644"></a><span class="lineno"> 5644</span>&#160;</div><div class="line"><a name="l05645"></a><span class="lineno"> 5645</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>)) {</div><div class="line"><a name="l05646"></a><span class="lineno"> 5646</span>&#160;      <span class="keywordtype">int</span> first_line = 1;</div><div class="line"><a name="l05647"></a><span class="lineno"> 5647</span>&#160;      <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l05648"></a><span class="lineno"> 5648</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(&amp;str2, 0, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, strlen(<span class="stringliteral">&quot;To: &quot;</span>), strlen(pager) + 3);</div><div class="line"><a name="l05649"></a><span class="lineno"> 5649</span>&#160;      <span class="keywordflow">while</span> ((ptr = strchr(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), <span class="charliteral">&#39; &#39;</span>))) {</div><div class="line"><a name="l05650"></a><span class="lineno"> 5650</span>&#160;         *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05651"></a><span class="lineno"> 5651</span>&#160;         fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;To:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05652"></a><span class="lineno"> 5652</span>&#160;         first_line = 0;</div><div class="line"><a name="l05653"></a><span class="lineno"> 5653</span>&#160;         <span class="comment">/* Substring is smaller, so this will never grow */</span></div><div class="line"><a name="l05654"></a><span class="lineno"> 5654</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;str2, 0, <span class="stringliteral">&quot;%s&quot;</span>, ptr + 1);</div><div class="line"><a name="l05655"></a><span class="lineno"> 5655</span>&#160;      }</div><div class="line"><a name="l05656"></a><span class="lineno"> 5656</span>&#160;      fprintf(p, <span class="stringliteral">&quot;%s %s &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;To:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), pager);</div><div class="line"><a name="l05657"></a><span class="lineno"> 5657</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05658"></a><span class="lineno"> 5658</span>&#160;      fprintf(p, <span class="stringliteral">&quot;To: %s &lt;%s&gt;&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258">ast_str_quote</a>(&amp;str2, 0, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>), pager);</div><div class="line"><a name="l05659"></a><span class="lineno"> 5659</span>&#160;   }</div><div class="line"><a name="l05660"></a><span class="lineno"> 5660</span>&#160;</div><div class="line"><a name="l05661"></a><span class="lineno"> 5661</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(pagersubject)) {</div><div class="line"><a name="l05662"></a><span class="lineno"> 5662</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast;</div><div class="line"><a name="l05663"></a><span class="lineno"> 5663</span>&#160;      <span class="keywordflow">if</span> ((ast = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l05664"></a><span class="lineno"> 5664</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</div><div class="line"><a name="l05665"></a><span class="lineno"> 5665</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a>(&amp;str1, 0, ast, pagersubject);</div><div class="line"><a name="l05666"></a><span class="lineno"> 5666</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a>(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1))) {</div><div class="line"><a name="l05667"></a><span class="lineno"> 5667</span>&#160;            <span class="keywordtype">int</span> first_line = 1;</div><div class="line"><a name="l05668"></a><span class="lineno"> 5668</span>&#160;            <span class="keywordtype">char</span> *ptr;</div><div class="line"><a name="l05669"></a><span class="lineno"> 5669</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a>(&amp;str2, 0, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1), strlen(<span class="stringliteral">&quot;Subject: &quot;</span>), 0);</div><div class="line"><a name="l05670"></a><span class="lineno"> 5670</span>&#160;            <span class="keywordflow">while</span> ((ptr = strchr(<a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2), <span class="charliteral">&#39; &#39;</span>))) {</div><div class="line"><a name="l05671"></a><span class="lineno"> 5671</span>&#160;               *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05672"></a><span class="lineno"> 5672</span>&#160;               fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;Subject:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05673"></a><span class="lineno"> 5673</span>&#160;               first_line = 0;</div><div class="line"><a name="l05674"></a><span class="lineno"> 5674</span>&#160;               <span class="comment">/* Substring is smaller, so this will never grow */</span></div><div class="line"><a name="l05675"></a><span class="lineno"> 5675</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;str2, 0, <span class="stringliteral">&quot;%s&quot;</span>, ptr + 1);</div><div class="line"><a name="l05676"></a><span class="lineno"> 5676</span>&#160;            }</div><div class="line"><a name="l05677"></a><span class="lineno"> 5677</span>&#160;            fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;Subject:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str2));</div><div class="line"><a name="l05678"></a><span class="lineno"> 5678</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05679"></a><span class="lineno"> 5679</span>&#160;            fprintf(p, <span class="stringliteral">&quot;Subject: %s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1));</div><div class="line"><a name="l05680"></a><span class="lineno"> 5680</span>&#160;         }</div><div class="line"><a name="l05681"></a><span class="lineno"> 5681</span>&#160;         ast = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(ast);</div><div class="line"><a name="l05682"></a><span class="lineno"> 5682</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05683"></a><span class="lineno"> 5683</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);</div><div class="line"><a name="l05684"></a><span class="lineno"> 5684</span>&#160;      }</div><div class="line"><a name="l05685"></a><span class="lineno"> 5685</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05686"></a><span class="lineno"> 5686</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag)) {</div><div class="line"><a name="l05687"></a><span class="lineno"> 5687</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Subject: New VM\n\n&quot;</span>);</div><div class="line"><a name="l05688"></a><span class="lineno"> 5688</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05689"></a><span class="lineno"> 5689</span>&#160;         fprintf(p, <span class="stringliteral">&quot;Subject: New %s VM\n\n&quot;</span>, flag);</div><div class="line"><a name="l05690"></a><span class="lineno"> 5690</span>&#160;      }</div><div class="line"><a name="l05691"></a><span class="lineno"> 5691</span>&#160;   }</div><div class="line"><a name="l05692"></a><span class="lineno"> 5692</span>&#160;</div><div class="line"><a name="l05693"></a><span class="lineno"> 5693</span>&#160;   <span class="keywordflow">if</span> (pagerbody) {</div><div class="line"><a name="l05694"></a><span class="lineno"> 5694</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast;</div><div class="line"><a name="l05695"></a><span class="lineno"> 5695</span>&#160;      <span class="keywordflow">if</span> ((ast = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l05696"></a><span class="lineno"> 5696</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</div><div class="line"><a name="l05697"></a><span class="lineno"> 5697</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a>(&amp;str1, 0, ast, pagerbody);</div><div class="line"><a name="l05698"></a><span class="lineno"> 5698</span>&#160;         fprintf(p, <span class="stringliteral">&quot;%s&quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str1));</div><div class="line"><a name="l05699"></a><span class="lineno"> 5699</span>&#160;         ast = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(ast);</div><div class="line"><a name="l05700"></a><span class="lineno"> 5700</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05701"></a><span class="lineno"> 5701</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);</div><div class="line"><a name="l05702"></a><span class="lineno"> 5702</span>&#160;      }</div><div class="line"><a name="l05703"></a><span class="lineno"> 5703</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05704"></a><span class="lineno"> 5704</span>&#160;      fprintf(p, <span class="stringliteral">&quot;New %s long %s msg in box %s\n&quot;</span></div><div class="line"><a name="l05705"></a><span class="lineno"> 5705</span>&#160;            <span class="stringliteral">&quot;from %s, on %s&quot;</span>, dur, flag, mailbox, (cidname ? cidname : (cidnum ? cidnum : <span class="stringliteral">&quot;unknown&quot;</span>)), date);</div><div class="line"><a name="l05706"></a><span class="lineno"> 5706</span>&#160;   }</div><div class="line"><a name="l05707"></a><span class="lineno"> 5707</span>&#160;</div><div class="line"><a name="l05708"></a><span class="lineno"> 5708</span>&#160;   fclose(p);</div><div class="line"><a name="l05709"></a><span class="lineno"> 5709</span>&#160;   snprintf(tmp2, <span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">&quot;( %s &lt; %s ; rm -f %s ) &amp;&quot;</span>, mailcmd, tmp, tmp);</div><div class="line"><a name="l05710"></a><span class="lineno"> 5710</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(tmp2);</div><div class="line"><a name="l05711"></a><span class="lineno"> 5711</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Sent page to %s with command &#39;%s&#39;\n&quot;</span>, pager, mailcmd);</div><div class="line"><a name="l05712"></a><span class="lineno"> 5712</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str1);</div><div class="line"><a name="l05713"></a><span class="lineno"> 5713</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(str2);</div><div class="line"><a name="l05714"></a><span class="lineno"> 5714</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05715"></a><span class="lineno"> 5715</span>&#160;}</div><div class="line"><a name="l05716"></a><span class="lineno"> 5716</span>&#160;<span class="comment"></span></div><div class="line"><a name="l05717"></a><span class="lineno"> 5717</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l05718"></a><span class="lineno"> 5718</span>&#160;<span class="comment"> * \brief Gets the current date and time, as formatted string.</span></div><div class="line"><a name="l05719"></a><span class="lineno"> 5719</span>&#160;<span class="comment"> * \param s The buffer to hold the output formatted date.</span></div><div class="line"><a name="l05720"></a><span class="lineno"> 5720</span>&#160;<span class="comment"> * \param len the length of the buffer. Used to prevent buffer overflow in ast_strftime.</span></div><div class="line"><a name="l05721"></a><span class="lineno"> 5721</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05722"></a><span class="lineno"> 5722</span>&#160;<span class="comment"> * The date format string used is &quot;%a %b %e %r UTC %Y&quot;.</span></div><div class="line"><a name="l05723"></a><span class="lineno"> 5723</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05724"></a><span class="lineno"> 5724</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l05725"></a><span class="lineno"> 5725</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05726"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271"> 5726</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">get_date</a>(<span class="keywordtype">char</span> *s, <span class="keywordtype">int</span> len)</div><div class="line"><a name="l05727"></a><span class="lineno"> 5727</span>&#160;{</div><div class="line"><a name="l05728"></a><span class="lineno"> 5728</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d5/d84/structast__tm.html">ast_tm</a> tm;</div><div class="line"><a name="l05729"></a><span class="lineno"> 5729</span>&#160;   <span class="keyword">struct </span>timeval t = <a class="code" href="../../de/df7/time_8h.html#ad3899efb6f0e348556ef69f5b16aa7f7">ast_tvnow</a>();</div><div class="line"><a name="l05730"></a><span class="lineno"> 5730</span>&#160;</div><div class="line"><a name="l05731"></a><span class="lineno"> 5731</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a>(&amp;t, &amp;tm, <span class="stringliteral">&quot;UTC&quot;</span>);</div><div class="line"><a name="l05732"></a><span class="lineno"> 5732</span>&#160;</div><div class="line"><a name="l05733"></a><span class="lineno"> 5733</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d5/deb/localtime_8h.html#aa8e63928b14a347bd3973d680b885f93">ast_strftime</a>(s, len, <span class="stringliteral">&quot;%a %b %e %r UTC %Y&quot;</span>, &amp;tm);</div><div class="line"><a name="l05734"></a><span class="lineno"> 5734</span>&#160;}</div><div class="line"><a name="l05735"></a><span class="lineno"> 5735</span>&#160;</div><div class="line"><a name="l05736"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456"> 5736</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456">invent_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d43/http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keywordtype">int</span> busy, <span class="keywordtype">char</span> *ecodes)</div><div class="line"><a name="l05737"></a><span class="lineno"> 5737</span>&#160;{</div><div class="line"><a name="l05738"></a><span class="lineno"> 5738</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l05739"></a><span class="lineno"> 5739</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05740"></a><span class="lineno"> 5740</span>&#160;   <span class="keywordtype">char</span> dest[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05741"></a><span class="lineno"> 5741</span>&#160;</div><div class="line"><a name="l05742"></a><span class="lineno"> 5742</span>&#160;   snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, context, ext);</div><div class="line"><a name="l05743"></a><span class="lineno"> 5743</span>&#160;</div><div class="line"><a name="l05744"></a><span class="lineno"> 5744</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(dest, <span class="keyword">sizeof</span>(dest), context, ext, <span class="stringliteral">&quot;&quot;</span>))) {</div><div class="line"><a name="l05745"></a><span class="lineno"> 5745</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to make directory(%s)\n&quot;</span>, fn);</div><div class="line"><a name="l05746"></a><span class="lineno"> 5746</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05747"></a><span class="lineno"> 5747</span>&#160;   }</div><div class="line"><a name="l05748"></a><span class="lineno"> 5748</span>&#160;</div><div class="line"><a name="l05749"></a><span class="lineno"> 5749</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(fn, -1, ext, context);</div><div class="line"><a name="l05750"></a><span class="lineno"> 5750</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l05751"></a><span class="lineno"> 5751</span>&#160;      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, fn, ecodes);</div><div class="line"><a name="l05752"></a><span class="lineno"> 5752</span>&#160;      <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l05753"></a><span class="lineno"> 5753</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);</div><div class="line"><a name="l05754"></a><span class="lineno"> 5754</span>&#160;         <span class="keywordflow">return</span> res;</div><div class="line"><a name="l05755"></a><span class="lineno"> 5755</span>&#160;      }</div><div class="line"><a name="l05756"></a><span class="lineno"> 5756</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05757"></a><span class="lineno"> 5757</span>&#160;      <span class="comment">/* Dispose just in case */</span></div><div class="line"><a name="l05758"></a><span class="lineno"> 5758</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);</div><div class="line"><a name="l05759"></a><span class="lineno"> 5759</span>&#160;      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-theperson&quot;</span>, ecodes);</div><div class="line"><a name="l05760"></a><span class="lineno"> 5760</span>&#160;      <span class="keywordflow">if</span> (res)</div><div class="line"><a name="l05761"></a><span class="lineno"> 5761</span>&#160;         <span class="keywordflow">return</span> res;</div><div class="line"><a name="l05762"></a><span class="lineno"> 5762</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce">ast_say_digit_str</a>(chan, ext, ecodes, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l05763"></a><span class="lineno"> 5763</span>&#160;      <span class="keywordflow">if</span> (res)</div><div class="line"><a name="l05764"></a><span class="lineno"> 5764</span>&#160;         <span class="keywordflow">return</span> res;</div><div class="line"><a name="l05765"></a><span class="lineno"> 5765</span>&#160;   }</div><div class="line"><a name="l05766"></a><span class="lineno"> 5766</span>&#160;   res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, busy ? <span class="stringliteral">&quot;vm-isonphone&quot;</span> : <span class="stringliteral">&quot;vm-isunavail&quot;</span>, ecodes);</div><div class="line"><a name="l05767"></a><span class="lineno"> 5767</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l05768"></a><span class="lineno"> 5768</span>&#160;}</div><div class="line"><a name="l05769"></a><span class="lineno"> 5769</span>&#160;</div><div class="line"><a name="l05770"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2"> 5770</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2">free_zone</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *z)</div><div class="line"><a name="l05771"></a><span class="lineno"> 5771</span>&#160;{</div><div class="line"><a name="l05772"></a><span class="lineno"> 5772</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(z);</div><div class="line"><a name="l05773"></a><span class="lineno"> 5773</span>&#160;}</div><div class="line"><a name="l05774"></a><span class="lineno"> 5774</span>&#160;</div><div class="line"><a name="l05775"></a><span class="lineno"> 5775</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l05776"></a><span class="lineno"> 5776</span>&#160;</div><div class="line"><a name="l05777"></a><span class="lineno"> 5777</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> count_messages_in_folder(<span class="keyword">struct</span> <a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *odbc, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keywordtype">int</span> *messages)</div><div class="line"><a name="l05778"></a><span class="lineno"> 5778</span>&#160;{</div><div class="line"><a name="l05779"></a><span class="lineno"> 5779</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l05780"></a><span class="lineno"> 5780</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05781"></a><span class="lineno"> 5781</span>&#160;   <span class="keywordtype">char</span> rowdata[20];</div><div class="line"><a name="l05782"></a><span class="lineno"> 5782</span>&#160;   SQLHSTMT stmt = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l05783"></a><span class="lineno"> 5783</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 0 };</div><div class="line"><a name="l05784"></a><span class="lineno"> 5784</span>&#160;</div><div class="line"><a name="l05785"></a><span class="lineno"> 5785</span>&#160;   <span class="keywordflow">if</span> (!messages) {</div><div class="line"><a name="l05786"></a><span class="lineno"> 5786</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05787"></a><span class="lineno"> 5787</span>&#160;   }</div><div class="line"><a name="l05788"></a><span class="lineno"> 5788</span>&#160;</div><div class="line"><a name="l05789"></a><span class="lineno"> 5789</span>&#160;   snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &#39;%s%s/%s/%s&#39;&quot;</span>, odbc_table, VM_SPOOL_DIR, context, mailbox, folder);</div><div class="line"><a name="l05790"></a><span class="lineno"> 5790</span>&#160;   <span class="keywordflow">if</span> (!(stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(odbc, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps))) {</div><div class="line"><a name="l05791"></a><span class="lineno"> 5791</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l05792"></a><span class="lineno"> 5792</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l05793"></a><span class="lineno"> 5793</span>&#160;   }</div><div class="line"><a name="l05794"></a><span class="lineno"> 5794</span>&#160;   res = SQLFetch(stmt);</div><div class="line"><a name="l05795"></a><span class="lineno"> 5795</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l05796"></a><span class="lineno"> 5796</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l05797"></a><span class="lineno"> 5797</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l05798"></a><span class="lineno"> 5798</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l05799"></a><span class="lineno"> 5799</span>&#160;   }</div><div class="line"><a name="l05800"></a><span class="lineno"> 5800</span>&#160;   res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l05801"></a><span class="lineno"> 5801</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l05802"></a><span class="lineno"> 5802</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l05803"></a><span class="lineno"> 5803</span>&#160;      SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l05804"></a><span class="lineno"> 5804</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l05805"></a><span class="lineno"> 5805</span>&#160;   }</div><div class="line"><a name="l05806"></a><span class="lineno"> 5806</span>&#160;</div><div class="line"><a name="l05807"></a><span class="lineno"> 5807</span>&#160;   *messages = atoi(rowdata);</div><div class="line"><a name="l05808"></a><span class="lineno"> 5808</span>&#160;   SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l05809"></a><span class="lineno"> 5809</span>&#160;</div><div class="line"><a name="l05810"></a><span class="lineno"> 5810</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05811"></a><span class="lineno"> 5811</span>&#160;}</div><div class="line"><a name="l05812"></a><span class="lineno"> 5812</span>&#160;</div><div class="line"><a name="l05813"></a><span class="lineno"> 5813</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)</div><div class="line"><a name="l05814"></a><span class="lineno"> 5814</span>&#160;{</div><div class="line"><a name="l05815"></a><span class="lineno"> 5815</span>&#160;   <span class="keywordtype">char</span> tmp[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l05816"></a><span class="lineno"> 5816</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj;</div><div class="line"><a name="l05817"></a><span class="lineno"> 5817</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l05818"></a><span class="lineno"> 5818</span>&#160;</div><div class="line"><a name="l05819"></a><span class="lineno"> 5819</span>&#160;   <span class="keywordflow">if</span> (newmsgs)</div><div class="line"><a name="l05820"></a><span class="lineno"> 5820</span>&#160;      *newmsgs = 0;</div><div class="line"><a name="l05821"></a><span class="lineno"> 5821</span>&#160;   <span class="keywordflow">if</span> (oldmsgs)</div><div class="line"><a name="l05822"></a><span class="lineno"> 5822</span>&#160;      *oldmsgs = 0;</div><div class="line"><a name="l05823"></a><span class="lineno"> 5823</span>&#160;   <span class="keywordflow">if</span> (urgentmsgs)</div><div class="line"><a name="l05824"></a><span class="lineno"> 5824</span>&#160;      *urgentmsgs = 0;</div><div class="line"><a name="l05825"></a><span class="lineno"> 5825</span>&#160;</div><div class="line"><a name="l05826"></a><span class="lineno"> 5826</span>&#160;   <span class="comment">/* If no mailbox, return immediately */</span></div><div class="line"><a name="l05827"></a><span class="lineno"> 5827</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox))</div><div class="line"><a name="l05828"></a><span class="lineno"> 5828</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05829"></a><span class="lineno"> 5829</span>&#160;</div><div class="line"><a name="l05830"></a><span class="lineno"> 5830</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l05831"></a><span class="lineno"> 5831</span>&#160;</div><div class="line"><a name="l05832"></a><span class="lineno"> 5832</span>&#160;   <span class="keywordflow">if</span> (strchr(mailbox, <span class="charliteral">&#39; &#39;</span>) || strchr(mailbox, <span class="charliteral">&#39;,&#39;</span>)) {</div><div class="line"><a name="l05833"></a><span class="lineno"> 5833</span>&#160;      <span class="keywordtype">int</span> u, n, o;</div><div class="line"><a name="l05834"></a><span class="lineno"> 5834</span>&#160;      <span class="keywordtype">char</span> *<a class="code" href="../../df/d36/structodbc__obj.html#a35f93192e944901f5d3da32e8e937902">next</a>, *remaining = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l05835"></a><span class="lineno"> 5835</span>&#160;      <span class="keywordflow">while</span> ((next = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;remaining, <span class="stringliteral">&quot; ,&quot;</span>))) {</div><div class="line"><a name="l05836"></a><span class="lineno"> 5836</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(next, urgentmsgs ? &amp;u : <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;n, &amp;o)) {</div><div class="line"><a name="l05837"></a><span class="lineno"> 5837</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05838"></a><span class="lineno"> 5838</span>&#160;         }</div><div class="line"><a name="l05839"></a><span class="lineno"> 5839</span>&#160;         <span class="keywordflow">if</span> (urgentmsgs) {</div><div class="line"><a name="l05840"></a><span class="lineno"> 5840</span>&#160;            *urgentmsgs += u;</div><div class="line"><a name="l05841"></a><span class="lineno"> 5841</span>&#160;         }</div><div class="line"><a name="l05842"></a><span class="lineno"> 5842</span>&#160;         <span class="keywordflow">if</span> (newmsgs) {</div><div class="line"><a name="l05843"></a><span class="lineno"> 5843</span>&#160;            *newmsgs += n;</div><div class="line"><a name="l05844"></a><span class="lineno"> 5844</span>&#160;         }</div><div class="line"><a name="l05845"></a><span class="lineno"> 5845</span>&#160;         <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line"><a name="l05846"></a><span class="lineno"> 5846</span>&#160;            *oldmsgs += o;</div><div class="line"><a name="l05847"></a><span class="lineno"> 5847</span>&#160;         }</div><div class="line"><a name="l05848"></a><span class="lineno"> 5848</span>&#160;      }</div><div class="line"><a name="l05849"></a><span class="lineno"> 5849</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05850"></a><span class="lineno"> 5850</span>&#160;   }</div><div class="line"><a name="l05851"></a><span class="lineno"> 5851</span>&#160;</div><div class="line"><a name="l05852"></a><span class="lineno"> 5852</span>&#160;   context = strchr(tmp, <span class="charliteral">&#39;@&#39;</span>);</div><div class="line"><a name="l05853"></a><span class="lineno"> 5853</span>&#160;   <span class="keywordflow">if</span> (context) {</div><div class="line"><a name="l05854"></a><span class="lineno"> 5854</span>&#160;      *context = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l05855"></a><span class="lineno"> 5855</span>&#160;      context++;</div><div class="line"><a name="l05856"></a><span class="lineno"> 5856</span>&#160;   } <span class="keywordflow">else</span></div><div class="line"><a name="l05857"></a><span class="lineno"> 5857</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l05858"></a><span class="lineno"> 5858</span>&#160;</div><div class="line"><a name="l05859"></a><span class="lineno"> 5859</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l05860"></a><span class="lineno"> 5860</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l05861"></a><span class="lineno"> 5861</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l05862"></a><span class="lineno"> 5862</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05863"></a><span class="lineno"> 5863</span>&#160;   }</div><div class="line"><a name="l05864"></a><span class="lineno"> 5864</span>&#160;</div><div class="line"><a name="l05865"></a><span class="lineno"> 5865</span>&#160;   <span class="keywordflow">if</span> (count_messages_in_folder(obj, context, tmp, <span class="stringliteral">&quot;INBOX&quot;</span>, newmsgs)</div><div class="line"><a name="l05866"></a><span class="lineno"> 5866</span>&#160;      || count_messages_in_folder(obj, context, tmp, <span class="stringliteral">&quot;Old&quot;</span>, oldmsgs)</div><div class="line"><a name="l05867"></a><span class="lineno"> 5867</span>&#160;      || count_messages_in_folder(obj, context, tmp, <span class="stringliteral">&quot;Urgent&quot;</span>, urgentmsgs)) {</div><div class="line"><a name="l05868"></a><span class="lineno"> 5868</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain message count for mailbox %s@%s\n&quot;</span>,</div><div class="line"><a name="l05869"></a><span class="lineno"> 5869</span>&#160;            tmp, context);</div><div class="line"><a name="l05870"></a><span class="lineno"> 5870</span>&#160;   }</div><div class="line"><a name="l05871"></a><span class="lineno"> 5871</span>&#160;</div><div class="line"><a name="l05872"></a><span class="lineno"> 5872</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l05873"></a><span class="lineno"> 5873</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05874"></a><span class="lineno"> 5874</span>&#160;}</div><div class="line"><a name="l05875"></a><span class="lineno"> 5875</span>&#160;<span class="comment"></span></div><div class="line"><a name="l05876"></a><span class="lineno"> 5876</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l05877"></a><span class="lineno"> 5877</span>&#160;<span class="comment"> * \brief Gets the number of messages that exist in a mailbox folder.</span></div><div class="line"><a name="l05878"></a><span class="lineno"> 5878</span>&#160;<span class="comment"> * \param mailbox_id</span></div><div class="line"><a name="l05879"></a><span class="lineno"> 5879</span>&#160;<span class="comment"> * \param folder</span></div><div class="line"><a name="l05880"></a><span class="lineno"> 5880</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05881"></a><span class="lineno"> 5881</span>&#160;<span class="comment"> * This method is used when ODBC backend is used.</span></div><div class="line"><a name="l05882"></a><span class="lineno"> 5882</span>&#160;<span class="comment"> * \return The number of messages in this mailbox folder (zero or more).</span></div><div class="line"><a name="l05883"></a><span class="lineno"> 5883</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05884"></a><span class="lineno"> 5884</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l05885"></a><span class="lineno"> 5885</span>&#160;{</div><div class="line"><a name="l05886"></a><span class="lineno"> 5886</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d36/structodbc__obj.html">odbc_obj</a> *obj = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l05887"></a><span class="lineno"> 5887</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l05888"></a><span class="lineno"> 5888</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l05889"></a><span class="lineno"> 5889</span>&#160;   <span class="keywordtype">int</span> nummsgs = 0;</div><div class="line"><a name="l05890"></a><span class="lineno"> 5890</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l05891"></a><span class="lineno"> 5891</span>&#160;   SQLHSTMT stmt = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l05892"></a><span class="lineno"> 5892</span>&#160;   <span class="keywordtype">char</span> sql[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05893"></a><span class="lineno"> 5893</span>&#160;   <span class="keywordtype">char</span> rowdata[20];</div><div class="line"><a name="l05894"></a><span class="lineno"> 5894</span>&#160;   <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 0 };</div><div class="line"><a name="l05895"></a><span class="lineno"> 5895</span>&#160;</div><div class="line"><a name="l05896"></a><span class="lineno"> 5896</span>&#160;   <span class="comment">/* If no mailbox, return immediately */</span></div><div class="line"><a name="l05897"></a><span class="lineno"> 5897</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_id)</div><div class="line"><a name="l05898"></a><span class="lineno"> 5898</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mailbox_id), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l05899"></a><span class="lineno"> 5899</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05900"></a><span class="lineno"> 5900</span>&#160;   }</div><div class="line"><a name="l05901"></a><span class="lineno"> 5901</span>&#160;</div><div class="line"><a name="l05902"></a><span class="lineno"> 5902</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder)) {</div><div class="line"><a name="l05903"></a><span class="lineno"> 5903</span>&#160;      folder = <span class="stringliteral">&quot;INBOX&quot;</span>;</div><div class="line"><a name="l05904"></a><span class="lineno"> 5904</span>&#160;   }</div><div class="line"><a name="l05905"></a><span class="lineno"> 5905</span>&#160;</div><div class="line"><a name="l05906"></a><span class="lineno"> 5906</span>&#160;   obj = <a class="code" href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a>(odbc_database, 0);</div><div class="line"><a name="l05907"></a><span class="lineno"> 5907</span>&#160;   <span class="keywordflow">if</span> (!obj) {</div><div class="line"><a name="l05908"></a><span class="lineno"> 5908</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &#39;%s&#39;!\n&quot;</span>, odbc_database);</div><div class="line"><a name="l05909"></a><span class="lineno"> 5909</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05910"></a><span class="lineno"> 5910</span>&#160;   }</div><div class="line"><a name="l05911"></a><span class="lineno"> 5911</span>&#160;</div><div class="line"><a name="l05912"></a><span class="lineno"> 5912</span>&#160;   <span class="keywordflow">if</span> (!strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>)) {</div><div class="line"><a name="l05913"></a><span class="lineno"> 5913</span>&#160;      snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &#39;%s%s/%s/INBOX&#39; OR dir = &#39;%s%s/%s/Urgent&#39;&quot;</span>, odbc_table, VM_SPOOL_DIR, context, mailbox, VM_SPOOL_DIR, context, mailbox);</div><div class="line"><a name="l05914"></a><span class="lineno"> 5914</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05915"></a><span class="lineno"> 5915</span>&#160;      snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &#39;%s%s/%s/%s&#39;&quot;</span>, odbc_table, VM_SPOOL_DIR, context, mailbox, folder);</div><div class="line"><a name="l05916"></a><span class="lineno"> 5916</span>&#160;   }</div><div class="line"><a name="l05917"></a><span class="lineno"> 5917</span>&#160;</div><div class="line"><a name="l05918"></a><span class="lineno"> 5918</span>&#160;   stmt = <a class="code" href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);</div><div class="line"><a name="l05919"></a><span class="lineno"> 5919</span>&#160;   <span class="keywordflow">if</span> (!stmt) {</div><div class="line"><a name="l05920"></a><span class="lineno"> 5920</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l05921"></a><span class="lineno"> 5921</span>&#160;      <span class="keywordflow">goto</span> bail;</div><div class="line"><a name="l05922"></a><span class="lineno"> 5922</span>&#160;   }</div><div class="line"><a name="l05923"></a><span class="lineno"> 5923</span>&#160;   res = SQLFetch(stmt);</div><div class="line"><a name="l05924"></a><span class="lineno"> 5924</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l05925"></a><span class="lineno"> 5925</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l05926"></a><span class="lineno"> 5926</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l05927"></a><span class="lineno"> 5927</span>&#160;   }</div><div class="line"><a name="l05928"></a><span class="lineno"> 5928</span>&#160;   res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l05929"></a><span class="lineno"> 5929</span>&#160;   <span class="keywordflow">if</span> (!SQL_SUCCEEDED(res)) {</div><div class="line"><a name="l05930"></a><span class="lineno"> 5930</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);</div><div class="line"><a name="l05931"></a><span class="lineno"> 5931</span>&#160;      <span class="keywordflow">goto</span> bail_with_handle;</div><div class="line"><a name="l05932"></a><span class="lineno"> 5932</span>&#160;   }</div><div class="line"><a name="l05933"></a><span class="lineno"> 5933</span>&#160;   nummsgs = atoi(rowdata);</div><div class="line"><a name="l05934"></a><span class="lineno"> 5934</span>&#160;</div><div class="line"><a name="l05935"></a><span class="lineno"> 5935</span>&#160;bail_with_handle:</div><div class="line"><a name="l05936"></a><span class="lineno"> 5936</span>&#160;   SQLFreeHandle(SQL_HANDLE_STMT, stmt);</div><div class="line"><a name="l05937"></a><span class="lineno"> 5937</span>&#160;</div><div class="line"><a name="l05938"></a><span class="lineno"> 5938</span>&#160;bail:</div><div class="line"><a name="l05939"></a><span class="lineno"> 5939</span>&#160;   <a class="code" href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a>(obj);</div><div class="line"><a name="l05940"></a><span class="lineno"> 5940</span>&#160;   <span class="keywordflow">return</span> nummsgs;</div><div class="line"><a name="l05941"></a><span class="lineno"> 5941</span>&#160;}</div><div class="line"><a name="l05942"></a><span class="lineno"> 5942</span>&#160;<span class="comment"></span></div><div class="line"><a name="l05943"></a><span class="lineno"> 5943</span>&#160;<span class="comment">/**</span></div><div class="line"><a name="l05944"></a><span class="lineno"> 5944</span>&#160;<span class="comment"> * \brief Determines if the given folder has messages.</span></div><div class="line"><a name="l05945"></a><span class="lineno"> 5945</span>&#160;<span class="comment"> * \param mailbox The @ delimited string for user@context. If no context is found, uses &#39;default&#39; for the context.</span></div><div class="line"><a name="l05946"></a><span class="lineno"> 5946</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05947"></a><span class="lineno"> 5947</span>&#160;<span class="comment"> * This function is used when the mailbox is stored in an ODBC back end.</span></div><div class="line"><a name="l05948"></a><span class="lineno"> 5948</span>&#160;<span class="comment"> * This invokes the messagecount(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.</span></div><div class="line"><a name="l05949"></a><span class="lineno"> 5949</span>&#160;<span class="comment"> * \return 1 if the folder has one or more messages. zero otherwise.</span></div><div class="line"><a name="l05950"></a><span class="lineno"> 5950</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05951"></a><span class="lineno"> 5951</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd5/res__ari__mailboxes_8c.html#a29d08f8b2448744d75ca9ebc4e218419">mailboxes</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l05952"></a><span class="lineno"> 5952</span>&#160;{</div><div class="line"><a name="l05953"></a><span class="lineno"> 5953</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;</div><div class="line"><a name="l05954"></a><span class="lineno"> 5954</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l05955"></a><span class="lineno"> 5955</span>&#160;</div><div class="line"><a name="l05956"></a><span class="lineno"> 5956</span>&#160;   parse = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mailboxes);</div><div class="line"><a name="l05957"></a><span class="lineno"> 5957</span>&#160;   <span class="keywordflow">while</span> ((mailbox = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;parse, <span class="stringliteral">&quot;,&amp;&quot;</span>))) {</div><div class="line"><a name="l05958"></a><span class="lineno"> 5958</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(mailbox, folder)) {</div><div class="line"><a name="l05959"></a><span class="lineno"> 5959</span>&#160;         <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l05960"></a><span class="lineno"> 5960</span>&#160;      }</div><div class="line"><a name="l05961"></a><span class="lineno"> 5961</span>&#160;   }</div><div class="line"><a name="l05962"></a><span class="lineno"> 5962</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l05963"></a><span class="lineno"> 5963</span>&#160;}</div><div class="line"><a name="l05964"></a><span class="lineno"> 5964</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05965"></a><span class="lineno"> 5965</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l05966"></a><span class="lineno"> 5966</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l05967"></a><span class="lineno"> 5967</span>&#160;<span class="comment"> * \brief Copies a message from one mailbox to another.</span></div><div class="line"><a name="l05968"></a><span class="lineno"> 5968</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l05969"></a><span class="lineno"> 5969</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l05970"></a><span class="lineno"> 5970</span>&#160;<span class="comment"> * \param imbox</span></div><div class="line"><a name="l05971"></a><span class="lineno"> 5971</span>&#160;<span class="comment"> * \param msgnum</span></div><div class="line"><a name="l05972"></a><span class="lineno"> 5972</span>&#160;<span class="comment"> * \param duration</span></div><div class="line"><a name="l05973"></a><span class="lineno"> 5973</span>&#160;<span class="comment"> * \param recip</span></div><div class="line"><a name="l05974"></a><span class="lineno"> 5974</span>&#160;<span class="comment"> * \param fmt</span></div><div class="line"><a name="l05975"></a><span class="lineno"> 5975</span>&#160;<span class="comment"> * \param dir</span></div><div class="line"><a name="l05976"></a><span class="lineno"> 5976</span>&#160;<span class="comment"> * \param flag, dest_folder</span></div><div class="line"><a name="l05977"></a><span class="lineno"> 5977</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05978"></a><span class="lineno"> 5978</span>&#160;<span class="comment"> * This is only used by file storage based mailboxes.</span></div><div class="line"><a name="l05979"></a><span class="lineno"> 5979</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05980"></a><span class="lineno"> 5980</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l05981"></a><span class="lineno"> 5981</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05982"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039"> 5982</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039">copy_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> imbox, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *recip, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag, <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_folder)</div><div class="line"><a name="l05983"></a><span class="lineno"> 5983</span>&#160;{</div><div class="line"><a name="l05984"></a><span class="lineno"> 5984</span>&#160;   <span class="keywordtype">char</span> fromdir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], todir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], frompath[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], topath[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l05985"></a><span class="lineno"> 5985</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *frombox = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, imbox);</div><div class="line"><a name="l05986"></a><span class="lineno"> 5986</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *userfolder;</div><div class="line"><a name="l05987"></a><span class="lineno"> 5987</span>&#160;   <span class="keywordtype">int</span> recipmsgnum;</div><div class="line"><a name="l05988"></a><span class="lineno"> 5988</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l05989"></a><span class="lineno"> 5989</span>&#160;</div><div class="line"><a name="l05990"></a><span class="lineno"> 5990</span>&#160;   <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Copying message from %s@%s to %s@%s\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l05991"></a><span class="lineno"> 5991</span>&#160;</div><div class="line"><a name="l05992"></a><span class="lineno"> 5992</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) { <span class="comment">/* If urgent, copy to Urgent folder */</span></div><div class="line"><a name="l05993"></a><span class="lineno"> 5993</span>&#160;      userfolder = <span class="stringliteral">&quot;Urgent&quot;</span>;</div><div class="line"><a name="l05994"></a><span class="lineno"> 5994</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(dest_folder)) {</div><div class="line"><a name="l05995"></a><span class="lineno"> 5995</span>&#160;      userfolder = dest_folder;</div><div class="line"><a name="l05996"></a><span class="lineno"> 5996</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l05997"></a><span class="lineno"> 5997</span>&#160;      userfolder = <span class="stringliteral">&quot;INBOX&quot;</span>;</div><div class="line"><a name="l05998"></a><span class="lineno"> 5998</span>&#160;   }</div><div class="line"><a name="l05999"></a><span class="lineno"> 5999</span>&#160;</div><div class="line"><a name="l06000"></a><span class="lineno"> 6000</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(todir, <span class="keyword">sizeof</span>(todir), recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, userfolder);</div><div class="line"><a name="l06001"></a><span class="lineno"> 6001</span>&#160;</div><div class="line"><a name="l06002"></a><span class="lineno"> 6002</span>&#160;   <span class="keywordflow">if</span> (!dir)</div><div class="line"><a name="l06003"></a><span class="lineno"> 6003</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(fromdir, <span class="keyword">sizeof</span>(fromdir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, frombox);</div><div class="line"><a name="l06004"></a><span class="lineno"> 6004</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l06005"></a><span class="lineno"> 6005</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fromdir, dir, <span class="keyword">sizeof</span>(fromdir));</div><div class="line"><a name="l06006"></a><span class="lineno"> 6006</span>&#160;</div><div class="line"><a name="l06007"></a><span class="lineno"> 6007</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(frompath, <span class="keyword">sizeof</span>(frompath), fromdir, msgnum);</div><div class="line"><a name="l06008"></a><span class="lineno"> 6008</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(todir, <span class="keyword">sizeof</span>(todir), recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, userfolder);</div><div class="line"><a name="l06009"></a><span class="lineno"> 6009</span>&#160;</div><div class="line"><a name="l06010"></a><span class="lineno"> 6010</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(todir))</div><div class="line"><a name="l06011"></a><span class="lineno"> 6011</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;</div><div class="line"><a name="l06012"></a><span class="lineno"> 6012</span>&#160;</div><div class="line"><a name="l06013"></a><span class="lineno"> 6013</span>&#160;   recipmsgnum = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(recip, todir) + 1;</div><div class="line"><a name="l06014"></a><span class="lineno"> 6014</span>&#160;   <span class="keywordflow">if</span> (recipmsgnum &lt; recip-&gt;maxmsg - (imbox ? 0 : <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0))) {</div><div class="line"><a name="l06015"></a><span class="lineno"> 6015</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(topath, <span class="keyword">sizeof</span>(topath), todir, recipmsgnum);</div><div class="line"><a name="l06016"></a><span class="lineno"> 6016</span>&#160;<span class="preprocessor">#ifndef ODBC_STORAGE</span></div><div class="line"><a name="l06017"></a><span class="lineno"> 6017</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(fromdir, msgnum, frompath, chan ? <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan) : <span class="stringliteral">&quot;&quot;</span>)) {</div><div class="line"><a name="l06018"></a><span class="lineno"> 6018</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">COPY</a>(fromdir, msgnum, todir, recipmsgnum, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, frompath, topath);</div><div class="line"><a name="l06019"></a><span class="lineno"> 6019</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06020"></a><span class="lineno"> 6020</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06021"></a><span class="lineno"> 6021</span>&#160;         <span class="comment">/* If we are prepending a message for ODBC, then the message already</span></div><div class="line"><a name="l06022"></a><span class="lineno"> 6022</span>&#160;<span class="comment">          * exists in the database, but we want to force copying from the</span></div><div class="line"><a name="l06023"></a><span class="lineno"> 6023</span>&#160;<span class="comment">          * filesystem (since only the FS contains the prepend). */</span></div><div class="line"><a name="l06024"></a><span class="lineno"> 6024</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1">copy_plain_file</a>(frompath, topath);</div><div class="line"><a name="l06025"></a><span class="lineno"> 6025</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a>(todir, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, recipmsgnum, chan, recip, fmt, duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l06026"></a><span class="lineno"> 6026</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e">vm_delete</a>(topath);</div><div class="line"><a name="l06027"></a><span class="lineno"> 6027</span>&#160;<span class="preprocessor">#ifndef ODBC_STORAGE</span></div><div class="line"><a name="l06028"></a><span class="lineno"> 6028</span>&#160;      }</div><div class="line"><a name="l06029"></a><span class="lineno"> 6029</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06030"></a><span class="lineno"> 6030</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06031"></a><span class="lineno"> 6031</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Recipient mailbox %s@%s is full\n&quot;</span>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recip-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l06032"></a><span class="lineno"> 6032</span>&#160;      res = -1;</div><div class="line"><a name="l06033"></a><span class="lineno"> 6033</span>&#160;   }</div><div class="line"><a name="l06034"></a><span class="lineno"> 6034</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(todir);</div><div class="line"><a name="l06035"></a><span class="lineno"> 6035</span>&#160;   <span class="keywordflow">if</span> (chan) {</div><div class="line"><a name="l06036"></a><span class="lineno"> 6036</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d4/d77/structast__party__caller.html">ast_party_caller</a> *caller = <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan);</div><div class="line"><a name="l06037"></a><span class="lineno"> 6037</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">notify_new_message</a>(chan, recip, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, recipmsgnum, duration, fmt,</div><div class="line"><a name="l06038"></a><span class="lineno"> 6038</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(caller-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aca2d7de6c89f201dc8bd0a2642d2a352">number</a>.<a class="code" href="../../d6/dbb/structast__party__number.html#aaa04218f9e3a9065afa8be2491da8904">valid</a>, caller-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aca2d7de6c89f201dc8bd0a2642d2a352">number</a>.<a class="code" href="../../d6/dbb/structast__party__number.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06039"></a><span class="lineno"> 6039</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(caller-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aab4036618469f3fa9ab26a22726ba2db">name</a>.<a class="code" href="../../d8/d6f/structast__party__name.html#aaa04218f9e3a9065afa8be2491da8904">valid</a>, caller-&gt;<a class="code" href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">id</a>.<a class="code" href="../../d1/dcb/structast__party__id.html#aab4036618469f3fa9ab26a22726ba2db">name</a>.<a class="code" href="../../d8/d6f/structast__party__name.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06040"></a><span class="lineno"> 6040</span>&#160;         flag);</div><div class="line"><a name="l06041"></a><span class="lineno"> 6041</span>&#160;   }</div><div class="line"><a name="l06042"></a><span class="lineno"> 6042</span>&#160;</div><div class="line"><a name="l06043"></a><span class="lineno"> 6043</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l06044"></a><span class="lineno"> 6044</span>&#160;}</div><div class="line"><a name="l06045"></a><span class="lineno"> 6045</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06046"></a><span class="lineno"> 6046</span>&#160;<span class="preprocessor">#if !(defined(IMAP_STORAGE) || defined(ODBC_STORAGE))</span></div><div class="line"><a name="l06047"></a><span class="lineno"> 6047</span>&#160;</div><div class="line"><a name="l06048"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf"> 6048</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l06049"></a><span class="lineno"> 6049</span>&#160;{</div><div class="line"><a name="l06050"></a><span class="lineno"> 6050</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l06051"></a><span class="lineno"> 6051</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l06052"></a><span class="lineno"> 6052</span>&#160;</div><div class="line"><a name="l06053"></a><span class="lineno"> 6053</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_id)</div><div class="line"><a name="l06054"></a><span class="lineno"> 6054</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mailbox_id), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l06055"></a><span class="lineno"> 6055</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06056"></a><span class="lineno"> 6056</span>&#160;   }</div><div class="line"><a name="l06057"></a><span class="lineno"> 6057</span>&#160;</div><div class="line"><a name="l06058"></a><span class="lineno"> 6058</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, mailbox, folder, 0) + (folder &amp;&amp; strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>) ? 0 : <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, mailbox, <span class="stringliteral">&quot;Urgent&quot;</span>, 0));</div><div class="line"><a name="l06059"></a><span class="lineno"> 6059</span>&#160;}</div><div class="line"><a name="l06060"></a><span class="lineno"> 6060</span>&#160;</div><div class="line"><a name="l06061"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa"> 6061</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keywordtype">int</span> shortcircuit)</div><div class="line"><a name="l06062"></a><span class="lineno"> 6062</span>&#160;{</div><div class="line"><a name="l06063"></a><span class="lineno"> 6063</span>&#160;   DIR *dir;</div><div class="line"><a name="l06064"></a><span class="lineno"> 6064</span>&#160;   <span class="keyword">struct </span>dirent *de;</div><div class="line"><a name="l06065"></a><span class="lineno"> 6065</span>&#160;   <span class="keywordtype">char</span> fn[256];</div><div class="line"><a name="l06066"></a><span class="lineno"> 6066</span>&#160;   <span class="keywordtype">int</span> ret = 0;</div><div class="line"><a name="l06067"></a><span class="lineno"> 6067</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *mapping;</div><div class="line"><a name="l06068"></a><span class="lineno"> 6068</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>;</div><div class="line"><a name="l06069"></a><span class="lineno"> 6069</span>&#160;   <span class="keywordtype">char</span> *m;</div><div class="line"><a name="l06070"></a><span class="lineno"> 6070</span>&#160;</div><div class="line"><a name="l06071"></a><span class="lineno"> 6071</span>&#160;   <span class="comment">/* If no mailbox, return immediately */</span></div><div class="line"><a name="l06072"></a><span class="lineno"> 6072</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox))</div><div class="line"><a name="l06073"></a><span class="lineno"> 6073</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06074"></a><span class="lineno"> 6074</span>&#160;</div><div class="line"><a name="l06075"></a><span class="lineno"> 6075</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder))</div><div class="line"><a name="l06076"></a><span class="lineno"> 6076</span>&#160;      folder = <span class="stringliteral">&quot;INBOX&quot;</span>;</div><div class="line"><a name="l06077"></a><span class="lineno"> 6077</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context))</div><div class="line"><a name="l06078"></a><span class="lineno"> 6078</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l06079"></a><span class="lineno"> 6079</span>&#160;</div><div class="line"><a name="l06080"></a><span class="lineno"> 6080</span>&#160;   c = (<span class="keywordtype">char</span> *)context;</div><div class="line"><a name="l06081"></a><span class="lineno"> 6081</span>&#160;   m = (<span class="keywordtype">char</span> *)mailbox;</div><div class="line"><a name="l06082"></a><span class="lineno"> 6082</span>&#160;</div><div class="line"><a name="l06083"></a><span class="lineno"> 6083</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(aliasescontext)) {</div><div class="line"><a name="l06084"></a><span class="lineno"> 6084</span>&#160;      <span class="keywordtype">char</span> tmp[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a>];</div><div class="line"><a name="l06085"></a><span class="lineno"> 6085</span>&#160;</div><div class="line"><a name="l06086"></a><span class="lineno"> 6086</span>&#160;      snprintf(tmp, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a>, <span class="stringliteral">&quot;%s@%s&quot;</span>, mailbox, context);</div><div class="line"><a name="l06087"></a><span class="lineno"> 6087</span>&#160;      mapping = <a class="code" href="../../d5/da5/astobj2_8h.html#a911e0703891a9a7aaf73978152092586">ao2_find</a>(alias_mailbox_mappings, tmp, <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35caa13a6e0771cc457e86f425d95c3b8d54">OBJ_SEARCH_KEY</a>);</div><div class="line"><a name="l06088"></a><span class="lineno"> 6088</span>&#160;      <span class="keywordflow">if</span> (mapping) {</div><div class="line"><a name="l06089"></a><span class="lineno"> 6089</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>), &amp;m, &amp;c);</div><div class="line"><a name="l06090"></a><span class="lineno"> 6090</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mapping, -1);</div><div class="line"><a name="l06091"></a><span class="lineno"> 6091</span>&#160;      }</div><div class="line"><a name="l06092"></a><span class="lineno"> 6092</span>&#160;   }</div><div class="line"><a name="l06093"></a><span class="lineno"> 6093</span>&#160;</div><div class="line"><a name="l06094"></a><span class="lineno"> 6094</span>&#160;   snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s%s/%s/%s&quot;</span>, VM_SPOOL_DIR, c, m, folder);</div><div class="line"><a name="l06095"></a><span class="lineno"> 6095</span>&#160;</div><div class="line"><a name="l06096"></a><span class="lineno"> 6096</span>&#160;   <span class="keywordflow">if</span> (!(dir = opendir(fn)))</div><div class="line"><a name="l06097"></a><span class="lineno"> 6097</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06098"></a><span class="lineno"> 6098</span>&#160;</div><div class="line"><a name="l06099"></a><span class="lineno"> 6099</span>&#160;   <span class="keywordflow">while</span> ((de = readdir(dir))) {</div><div class="line"><a name="l06100"></a><span class="lineno"> 6100</span>&#160;      <span class="keywordflow">if</span> (!strncasecmp(de-&gt;d_name, <span class="stringliteral">&quot;msg&quot;</span>, 3)) {</div><div class="line"><a name="l06101"></a><span class="lineno"> 6101</span>&#160;         <span class="keywordflow">if</span> (shortcircuit) {</div><div class="line"><a name="l06102"></a><span class="lineno"> 6102</span>&#160;            ret = 1;</div><div class="line"><a name="l06103"></a><span class="lineno"> 6103</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l06104"></a><span class="lineno"> 6104</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(de-&gt;d_name + 8, <span class="stringliteral">&quot;txt&quot;</span>, 3)) {</div><div class="line"><a name="l06105"></a><span class="lineno"> 6105</span>&#160;            ret++;</div><div class="line"><a name="l06106"></a><span class="lineno"> 6106</span>&#160;         }</div><div class="line"><a name="l06107"></a><span class="lineno"> 6107</span>&#160;      }</div><div class="line"><a name="l06108"></a><span class="lineno"> 6108</span>&#160;   }</div><div class="line"><a name="l06109"></a><span class="lineno"> 6109</span>&#160;</div><div class="line"><a name="l06110"></a><span class="lineno"> 6110</span>&#160;   closedir(dir);</div><div class="line"><a name="l06111"></a><span class="lineno"> 6111</span>&#160;</div><div class="line"><a name="l06112"></a><span class="lineno"> 6112</span>&#160;   <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l06113"></a><span class="lineno"> 6113</span>&#160;}</div><div class="line"><a name="l06114"></a><span class="lineno"> 6114</span>&#160;<span class="comment"></span></div><div class="line"><a name="l06115"></a><span class="lineno"> 6115</span>&#160;<span class="comment">/**</span></div><div class="line"><a name="l06116"></a><span class="lineno"> 6116</span>&#160;<span class="comment"> * \brief Determines if the given folder has messages.</span></div><div class="line"><a name="l06117"></a><span class="lineno"> 6117</span>&#160;<span class="comment"> * \param mailbox The \@ delimited string for user\@context. If no context is found, uses &#39;default&#39; for the context.</span></div><div class="line"><a name="l06118"></a><span class="lineno"> 6118</span>&#160;<span class="comment"> * \param folder the folder to look in</span></div><div class="line"><a name="l06119"></a><span class="lineno"> 6119</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06120"></a><span class="lineno"> 6120</span>&#160;<span class="comment"> * This function is used when the mailbox is stored in a filesystem back end.</span></div><div class="line"><a name="l06121"></a><span class="lineno"> 6121</span>&#160;<span class="comment"> * This invokes the __has_voicemail(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.</span></div><div class="line"><a name="l06122"></a><span class="lineno"> 6122</span>&#160;<span class="comment"> * \return 1 if the folder has one or more messages. zero otherwise.</span></div><div class="line"><a name="l06123"></a><span class="lineno"> 6123</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l06124"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7"> 6124</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line"><a name="l06125"></a><span class="lineno"> 6125</span>&#160;{</div><div class="line"><a name="l06126"></a><span class="lineno"> 6126</span>&#160;   <span class="keywordtype">char</span> tmp[256], *tmp2 = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>, *box, *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l06127"></a><span class="lineno"> 6127</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l06128"></a><span class="lineno"> 6128</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder)) {</div><div class="line"><a name="l06129"></a><span class="lineno"> 6129</span>&#160;      folder = <span class="stringliteral">&quot;INBOX&quot;</span>;</div><div class="line"><a name="l06130"></a><span class="lineno"> 6130</span>&#160;   }</div><div class="line"><a name="l06131"></a><span class="lineno"> 6131</span>&#160;   <span class="keywordflow">while</span> ((box = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp2, <span class="stringliteral">&quot;,&amp;&quot;</span>))) {</div><div class="line"><a name="l06132"></a><span class="lineno"> 6132</span>&#160;      <span class="keywordflow">if</span> ((context = strchr(box, <span class="charliteral">&#39;@&#39;</span>)))</div><div class="line"><a name="l06133"></a><span class="lineno"> 6133</span>&#160;         *context++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l06134"></a><span class="lineno"> 6134</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l06135"></a><span class="lineno"> 6135</span>&#160;         context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l06136"></a><span class="lineno"> 6136</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, box, folder, 1))</div><div class="line"><a name="l06137"></a><span class="lineno"> 6137</span>&#160;         <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l06138"></a><span class="lineno"> 6138</span>&#160;      <span class="comment">/* If we are checking INBOX, we should check Urgent as well */</span></div><div class="line"><a name="l06139"></a><span class="lineno"> 6139</span>&#160;      <span class="keywordflow">if</span> (!strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, box, <span class="stringliteral">&quot;Urgent&quot;</span>, 1)) {</div><div class="line"><a name="l06140"></a><span class="lineno"> 6140</span>&#160;         <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l06141"></a><span class="lineno"> 6141</span>&#160;      }</div><div class="line"><a name="l06142"></a><span class="lineno"> 6142</span>&#160;   }</div><div class="line"><a name="l06143"></a><span class="lineno"> 6143</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06144"></a><span class="lineno"> 6144</span>&#160;}</div><div class="line"><a name="l06145"></a><span class="lineno"> 6145</span>&#160;<span class="comment"></span></div><div class="line"><a name="l06146"></a><span class="lineno"> 6146</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l06147"></a><span class="lineno"> 6147</span>&#160;<span class="comment"> * \brief Check the given mailbox&#39;s message count.</span></div><div class="line"><a name="l06148"></a><span class="lineno"> 6148</span>&#160;<span class="comment"> * \param mailbox The @ delimited string for user@context. If no context is found, uses &#39;default&#39; for the context.</span></div><div class="line"><a name="l06149"></a><span class="lineno"> 6149</span>&#160;<span class="comment"> * \param urgentmsgs  urgent message count.</span></div><div class="line"><a name="l06150"></a><span class="lineno"> 6150</span>&#160;<span class="comment"> * \param newmsgs new message count.</span></div><div class="line"><a name="l06151"></a><span class="lineno"> 6151</span>&#160;<span class="comment"> * \param oldmsgs old message count pointer</span></div><div class="line"><a name="l06152"></a><span class="lineno"> 6152</span>&#160;<span class="comment"> * \return -1 if error occurred, 0 otherwise.</span></div><div class="line"><a name="l06153"></a><span class="lineno"> 6153</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l06154"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b"> 6154</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)</div><div class="line"><a name="l06155"></a><span class="lineno"> 6155</span>&#160;{</div><div class="line"><a name="l06156"></a><span class="lineno"> 6156</span>&#160;   <span class="keywordtype">char</span> tmp[256];</div><div class="line"><a name="l06157"></a><span class="lineno"> 6157</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l06158"></a><span class="lineno"> 6158</span>&#160;</div><div class="line"><a name="l06159"></a><span class="lineno"> 6159</span>&#160;   <span class="comment">/* If no mailbox, return immediately */</span></div><div class="line"><a name="l06160"></a><span class="lineno"> 6160</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) {</div><div class="line"><a name="l06161"></a><span class="lineno"> 6161</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06162"></a><span class="lineno"> 6162</span>&#160;   }</div><div class="line"><a name="l06163"></a><span class="lineno"> 6163</span>&#160;</div><div class="line"><a name="l06164"></a><span class="lineno"> 6164</span>&#160;   <span class="keywordflow">if</span> (newmsgs) {</div><div class="line"><a name="l06165"></a><span class="lineno"> 6165</span>&#160;      *newmsgs = 0;</div><div class="line"><a name="l06166"></a><span class="lineno"> 6166</span>&#160;   }</div><div class="line"><a name="l06167"></a><span class="lineno"> 6167</span>&#160;   <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line"><a name="l06168"></a><span class="lineno"> 6168</span>&#160;      *oldmsgs = 0;</div><div class="line"><a name="l06169"></a><span class="lineno"> 6169</span>&#160;   }</div><div class="line"><a name="l06170"></a><span class="lineno"> 6170</span>&#160;   <span class="keywordflow">if</span> (urgentmsgs) {</div><div class="line"><a name="l06171"></a><span class="lineno"> 6171</span>&#160;      *urgentmsgs = 0;</div><div class="line"><a name="l06172"></a><span class="lineno"> 6172</span>&#160;   }</div><div class="line"><a name="l06173"></a><span class="lineno"> 6173</span>&#160;</div><div class="line"><a name="l06174"></a><span class="lineno"> 6174</span>&#160;   <span class="keywordflow">if</span> (strchr(mailbox, <span class="charliteral">&#39;,&#39;</span>)) {</div><div class="line"><a name="l06175"></a><span class="lineno"> 6175</span>&#160;      <span class="keywordtype">int</span> tmpnew, tmpold, tmpurgent;</div><div class="line"><a name="l06176"></a><span class="lineno"> 6176</span>&#160;      <span class="keywordtype">char</span> *mb, *cur;</div><div class="line"><a name="l06177"></a><span class="lineno"> 6177</span>&#160;</div><div class="line"><a name="l06178"></a><span class="lineno"> 6178</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l06179"></a><span class="lineno"> 6179</span>&#160;      mb = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l06180"></a><span class="lineno"> 6180</span>&#160;      <span class="keywordflow">while</span> ((cur = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;mb, <span class="stringliteral">&quot;, &quot;</span>))) {</div><div class="line"><a name="l06181"></a><span class="lineno"> 6181</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cur)) {</div><div class="line"><a name="l06182"></a><span class="lineno"> 6182</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(cur, urgentmsgs ? &amp;tmpurgent : <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, newmsgs ? &amp;tmpnew : NULL, oldmsgs ? &amp;tmpold : NULL)) {</div><div class="line"><a name="l06183"></a><span class="lineno"> 6183</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06184"></a><span class="lineno"> 6184</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06185"></a><span class="lineno"> 6185</span>&#160;               <span class="keywordflow">if</span> (newmsgs) {</div><div class="line"><a name="l06186"></a><span class="lineno"> 6186</span>&#160;                  *newmsgs += tmpnew;</div><div class="line"><a name="l06187"></a><span class="lineno"> 6187</span>&#160;               }</div><div class="line"><a name="l06188"></a><span class="lineno"> 6188</span>&#160;               <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line"><a name="l06189"></a><span class="lineno"> 6189</span>&#160;                  *oldmsgs += tmpold;</div><div class="line"><a name="l06190"></a><span class="lineno"> 6190</span>&#160;               }</div><div class="line"><a name="l06191"></a><span class="lineno"> 6191</span>&#160;               <span class="keywordflow">if</span> (urgentmsgs) {</div><div class="line"><a name="l06192"></a><span class="lineno"> 6192</span>&#160;                  *urgentmsgs += tmpurgent;</div><div class="line"><a name="l06193"></a><span class="lineno"> 6193</span>&#160;               }</div><div class="line"><a name="l06194"></a><span class="lineno"> 6194</span>&#160;            }</div><div class="line"><a name="l06195"></a><span class="lineno"> 6195</span>&#160;         }</div><div class="line"><a name="l06196"></a><span class="lineno"> 6196</span>&#160;      }</div><div class="line"><a name="l06197"></a><span class="lineno"> 6197</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06198"></a><span class="lineno"> 6198</span>&#160;   }</div><div class="line"><a name="l06199"></a><span class="lineno"> 6199</span>&#160;</div><div class="line"><a name="l06200"></a><span class="lineno"> 6200</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));</div><div class="line"><a name="l06201"></a><span class="lineno"> 6201</span>&#160;</div><div class="line"><a name="l06202"></a><span class="lineno"> 6202</span>&#160;   <span class="keywordflow">if</span> ((context = strchr(tmp, <span class="charliteral">&#39;@&#39;</span>))) {</div><div class="line"><a name="l06203"></a><span class="lineno"> 6203</span>&#160;      *context++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l06204"></a><span class="lineno"> 6204</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06205"></a><span class="lineno"> 6205</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l06206"></a><span class="lineno"> 6206</span>&#160;   }</div><div class="line"><a name="l06207"></a><span class="lineno"> 6207</span>&#160;</div><div class="line"><a name="l06208"></a><span class="lineno"> 6208</span>&#160;   <span class="keywordflow">if</span> (newmsgs) {</div><div class="line"><a name="l06209"></a><span class="lineno"> 6209</span>&#160;      *newmsgs = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, tmp, <span class="stringliteral">&quot;INBOX&quot;</span>, 0);</div><div class="line"><a name="l06210"></a><span class="lineno"> 6210</span>&#160;   }</div><div class="line"><a name="l06211"></a><span class="lineno"> 6211</span>&#160;   <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line"><a name="l06212"></a><span class="lineno"> 6212</span>&#160;      *oldmsgs = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, tmp, <span class="stringliteral">&quot;Old&quot;</span>, 0);</div><div class="line"><a name="l06213"></a><span class="lineno"> 6213</span>&#160;   }</div><div class="line"><a name="l06214"></a><span class="lineno"> 6214</span>&#160;   <span class="keywordflow">if</span> (urgentmsgs) {</div><div class="line"><a name="l06215"></a><span class="lineno"> 6215</span>&#160;      *urgentmsgs = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, tmp, <span class="stringliteral">&quot;Urgent&quot;</span>, 0);</div><div class="line"><a name="l06216"></a><span class="lineno"> 6216</span>&#160;   }</div><div class="line"><a name="l06217"></a><span class="lineno"> 6217</span>&#160;</div><div class="line"><a name="l06218"></a><span class="lineno"> 6218</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06219"></a><span class="lineno"> 6219</span>&#160;}</div><div class="line"><a name="l06220"></a><span class="lineno"> 6220</span>&#160;</div><div class="line"><a name="l06221"></a><span class="lineno"> 6221</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06222"></a><span class="lineno"> 6222</span>&#160;</div><div class="line"><a name="l06223"></a><span class="lineno"> 6223</span>&#160;<span class="comment">/* Exactly the same function for file-based, ODBC-based, and IMAP-based, so why create 3 different copies? */</span></div><div class="line"><a name="l06224"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79"> 6224</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)</div><div class="line"><a name="l06225"></a><span class="lineno"> 6225</span>&#160;{</div><div class="line"><a name="l06226"></a><span class="lineno"> 6226</span>&#160;   <span class="keywordtype">int</span> urgentmsgs = 0;</div><div class="line"><a name="l06227"></a><span class="lineno"> 6227</span>&#160;   <span class="keywordtype">int</span> res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(mailbox, &amp;urgentmsgs, newmsgs, oldmsgs);</div><div class="line"><a name="l06228"></a><span class="lineno"> 6228</span>&#160;   <span class="keywordflow">if</span> (newmsgs) {</div><div class="line"><a name="l06229"></a><span class="lineno"> 6229</span>&#160;      *newmsgs += urgentmsgs;</div><div class="line"><a name="l06230"></a><span class="lineno"> 6230</span>&#160;   }</div><div class="line"><a name="l06231"></a><span class="lineno"> 6231</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l06232"></a><span class="lineno"> 6232</span>&#160;}</div><div class="line"><a name="l06233"></a><span class="lineno"> 6233</span>&#160;</div><div class="line"><a name="l06234"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7"> 6234</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d5a/structextension.html">extension</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)</div><div class="line"><a name="l06235"></a><span class="lineno"> 6235</span>&#160;{</div><div class="line"><a name="l06236"></a><span class="lineno"> 6236</span>&#160;   <span class="keywordtype">char</span> arguments[255];</div><div class="line"><a name="l06237"></a><span class="lineno"> 6237</span>&#160;   <span class="keywordtype">char</span> ext_context[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06238"></a><span class="lineno"> 6238</span>&#160;   <span class="keywordtype">int</span> newvoicemails = 0, oldvoicemails = 0, urgentvoicemails = 0;</div><div class="line"><a name="l06239"></a><span class="lineno"> 6239</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d3/d61/structast__smdi__mwi__message.html">ast_smdi_mwi_message</a> *mwi_msg;</div><div class="line"><a name="l06240"></a><span class="lineno"> 6240</span>&#160;</div><div class="line"><a name="l06241"></a><span class="lineno"> 6241</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context))</div><div class="line"><a name="l06242"></a><span class="lineno"> 6242</span>&#160;      snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, extension, context);</div><div class="line"><a name="l06243"></a><span class="lineno"> 6243</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l06244"></a><span class="lineno"> 6244</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(ext_context, extension, <span class="keyword">sizeof</span>(ext_context));</div><div class="line"><a name="l06245"></a><span class="lineno"> 6245</span>&#160;</div><div class="line"><a name="l06246"></a><span class="lineno"> 6246</span>&#160;   <span class="keywordflow">if</span> (smdi_iface) {</div><div class="line"><a name="l06247"></a><span class="lineno"> 6247</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a76b4d3927cacd1bcd5da9ca8fe375cb6">ast_app_has_voicemail</a>(ext_context, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))</div><div class="line"><a name="l06248"></a><span class="lineno"> 6248</span>&#160;         <a class="code" href="../../dc/dca/smdi_8h.html#a6c1ad3c56eeed633ea2f8c9efabe66ba">ast_smdi_mwi_set</a>(smdi_iface, extension);</div><div class="line"><a name="l06249"></a><span class="lineno"> 6249</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l06250"></a><span class="lineno"> 6250</span>&#160;         <a class="code" href="../../dc/dca/smdi_8h.html#a9debceb53aa38da429365ca91e50cd35">ast_smdi_mwi_unset</a>(smdi_iface, extension);</div><div class="line"><a name="l06251"></a><span class="lineno"> 6251</span>&#160;</div><div class="line"><a name="l06252"></a><span class="lineno"> 6252</span>&#160;      <span class="keywordflow">if</span> ((mwi_msg = <a class="code" href="../../dc/dca/smdi_8h.html#a57edcf9aa93ccef269ad6ba1d2222609">ast_smdi_mwi_message_wait_station</a>(smdi_iface, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab396ba916ebd13b58eedfb621a602413">SMDI_MWI_WAIT_TIMEOUT</a>, extension))) {</div><div class="line"><a name="l06253"></a><span class="lineno"> 6253</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Error executing SMDI MWI change for %s\n&quot;</span>, extension);</div><div class="line"><a name="l06254"></a><span class="lineno"> 6254</span>&#160;         <span class="keywordflow">if</span> (!strncmp(mwi_msg-&gt;<a class="code" href="../../d3/d61/structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>, <span class="stringliteral">&quot;INV&quot;</span>, 3))</div><div class="line"><a name="l06255"></a><span class="lineno"> 6255</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid MWI extension: %s\n&quot;</span>, mwi_msg-&gt;<a class="code" href="../../d3/d61/structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>);</div><div class="line"><a name="l06256"></a><span class="lineno"> 6256</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(mwi_msg-&gt;<a class="code" href="../../d3/d61/structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>, <span class="stringliteral">&quot;BLK&quot;</span>, 3))</div><div class="line"><a name="l06257"></a><span class="lineno"> 6257</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;MWI light was already on or off for %s\n&quot;</span>, mwi_msg-&gt;<a class="code" href="../../d3/d61/structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>);</div><div class="line"><a name="l06258"></a><span class="lineno"> 6258</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;The switch reported &#39;%s&#39;\n&quot;</span>, mwi_msg-&gt;<a class="code" href="../../d3/d61/structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>);</div><div class="line"><a name="l06259"></a><span class="lineno"> 6259</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mwi_msg, -1);</div><div class="line"><a name="l06260"></a><span class="lineno"> 6260</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06261"></a><span class="lineno"> 6261</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Successfully executed SMDI MWI change for %s\n&quot;</span>, extension);</div><div class="line"><a name="l06262"></a><span class="lineno"> 6262</span>&#160;      }</div><div class="line"><a name="l06263"></a><span class="lineno"> 6263</span>&#160;   }</div><div class="line"><a name="l06264"></a><span class="lineno"> 6264</span>&#160;</div><div class="line"><a name="l06265"></a><span class="lineno"> 6265</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(externnotify)) {</div><div class="line"><a name="l06266"></a><span class="lineno"> 6266</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(ext_context, &amp;urgentvoicemails, &amp;newvoicemails, &amp;oldvoicemails)) {</div><div class="line"><a name="l06267"></a><span class="lineno"> 6267</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Problem in calculating number of voicemail messages available for extension %s\n&quot;</span>, extension);</div><div class="line"><a name="l06268"></a><span class="lineno"> 6268</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06269"></a><span class="lineno"> 6269</span>&#160;         snprintf(arguments, <span class="keyword">sizeof</span>(arguments), <span class="stringliteral">&quot;%s %s %s %d %d %d &amp;&quot;</span>,</div><div class="line"><a name="l06270"></a><span class="lineno"> 6270</span>&#160;            externnotify, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(context, <span class="stringliteral">&quot;\&quot;\&quot;&quot;</span>),</div><div class="line"><a name="l06271"></a><span class="lineno"> 6271</span>&#160;            extension, newvoicemails,</div><div class="line"><a name="l06272"></a><span class="lineno"> 6272</span>&#160;            oldvoicemails, urgentvoicemails);</div><div class="line"><a name="l06273"></a><span class="lineno"> 6273</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Executing %s\n&quot;</span>, arguments);</div><div class="line"><a name="l06274"></a><span class="lineno"> 6274</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(arguments);</div><div class="line"><a name="l06275"></a><span class="lineno"> 6275</span>&#160;      }</div><div class="line"><a name="l06276"></a><span class="lineno"> 6276</span>&#160;   }</div><div class="line"><a name="l06277"></a><span class="lineno"> 6277</span>&#160;}</div><div class="line"><a name="l06278"></a><span class="lineno"> 6278</span>&#160;<span class="comment"></span></div><div class="line"><a name="l06279"></a><span class="lineno"> 6279</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l06280"></a><span class="lineno"> 6280</span>&#160;<span class="comment"> * \brief Variables used for saving a voicemail.</span></div><div class="line"><a name="l06281"></a><span class="lineno"> 6281</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06282"></a><span class="lineno"> 6282</span>&#160;<span class="comment"> * This includes the record gain, mode flags, and the exit context of the chanel that was used for leaving the voicemail.</span></div><div class="line"><a name="l06283"></a><span class="lineno"> 6283</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l06284"></a><span class="lineno"> 6284</span>&#160;<span class="keyword">struct </span><a class="code" href="../../dd/df7/structleave__vm__options.html">leave_vm_options</a> {</div><div class="line"><a name="l06285"></a><span class="lineno"> 6285</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags;</div><div class="line"><a name="l06286"></a><span class="lineno"> 6286</span>&#160;   <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain;</div><div class="line"><a name="l06287"></a><span class="lineno"><a class="line" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81"> 6287</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a>;</div><div class="line"><a name="l06288"></a><span class="lineno"><a class="line" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856"> 6288</a></span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a>;</div><div class="line"><a name="l06289"></a><span class="lineno"> 6289</span>&#160;};</div><div class="line"><a name="l06290"></a><span class="lineno"> 6290</span>&#160;</div><div class="line"><a name="l06291"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e"> 6291</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(<span class="keywordtype">char</span> *dst)</div><div class="line"><a name="l06292"></a><span class="lineno"> 6292</span>&#160;{</div><div class="line"><a name="l06293"></a><span class="lineno"> 6293</span>&#160;   <span class="comment">/* msg id is time of msg_id generation plus an incrementing value</span></div><div class="line"><a name="l06294"></a><span class="lineno"> 6294</span>&#160;<span class="comment">    * called each time a new msg_id is generated. This should achieve uniqueness,</span></div><div class="line"><a name="l06295"></a><span class="lineno"> 6295</span>&#160;<span class="comment">    * but only in single system solutions.</span></div><div class="line"><a name="l06296"></a><span class="lineno"> 6296</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l06297"></a><span class="lineno"> 6297</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> unique_counter = <a class="code" href="../../dd/d42/lock_8h.html#a8a3bd496edfec04a95683ace66676200">ast_atomic_fetchadd_int</a>(&amp;msg_id_incrementor, +1);</div><div class="line"><a name="l06298"></a><span class="lineno"> 6298</span>&#160;   snprintf(dst, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a>, <span class="stringliteral">&quot;%ld-%08x&quot;</span>, (<span class="keywordtype">long</span>) time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>), unique_counter);</div><div class="line"><a name="l06299"></a><span class="lineno"> 6299</span>&#160;}</div><div class="line"><a name="l06300"></a><span class="lineno"> 6300</span>&#160;<span class="comment"></span></div><div class="line"><a name="l06301"></a><span class="lineno"> 6301</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l06302"></a><span class="lineno"> 6302</span>&#160;<span class="comment"> * \internal</span></div><div class="line"><a name="l06303"></a><span class="lineno"> 6303</span>&#160;<span class="comment"> * \brief Creates a voicemail based on a specified file to a mailbox.</span></div><div class="line"><a name="l06304"></a><span class="lineno"> 6304</span>&#160;<span class="comment"> * \param recdata A vm_recording_data containing filename and voicemail txt info.</span></div><div class="line"><a name="l06305"></a><span class="lineno"> 6305</span>&#160;<span class="comment"> * \retval -1 failure</span></div><div class="line"><a name="l06306"></a><span class="lineno"> 6306</span>&#160;<span class="comment"> * \retval 0 success</span></div><div class="line"><a name="l06307"></a><span class="lineno"> 6307</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06308"></a><span class="lineno"> 6308</span>&#160;<span class="comment"> * This is installed to the app.h voicemail functions and accommodates all voicemail</span></div><div class="line"><a name="l06309"></a><span class="lineno"> 6309</span>&#160;<span class="comment"> * storage methods. It should probably be broken out along with leave_voicemail at</span></div><div class="line"><a name="l06310"></a><span class="lineno"> 6310</span>&#160;<span class="comment"> * some point in the future.</span></div><div class="line"><a name="l06311"></a><span class="lineno"> 6311</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06312"></a><span class="lineno"> 6312</span>&#160;<span class="comment"> * This function currently only works for a single recipient and only uses the format</span></div><div class="line"><a name="l06313"></a><span class="lineno"> 6313</span>&#160;<span class="comment"> * specified in recording_ext.</span></div><div class="line"><a name="l06314"></a><span class="lineno"> 6314</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l06315"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6261648db5348c63c5a399887cdc7bcb"> 6315</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6261648db5348c63c5a399887cdc7bcb">msg_create_from_file</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d45/structast__vm__recording__data.html">ast_vm_recording_data</a> *recdata)</div><div class="line"><a name="l06316"></a><span class="lineno"> 6316</span>&#160;{</div><div class="line"><a name="l06317"></a><span class="lineno"> 6317</span>&#160;   <span class="comment">/* voicemail recipient structure */</span></div><div class="line"><a name="l06318"></a><span class="lineno"> 6318</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *recipient; <span class="comment">/* points to svm once it&#39;s been created */</span></div><div class="line"><a name="l06319"></a><span class="lineno"> 6319</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> svm; <span class="comment">/* struct storing the voicemail recipient */</span></div><div class="line"><a name="l06320"></a><span class="lineno"> 6320</span>&#160;</div><div class="line"><a name="l06321"></a><span class="lineno"> 6321</span>&#160;   <span class="comment">/* File paths */</span></div><div class="line"><a name="l06322"></a><span class="lineno"> 6322</span>&#160;   <span class="keywordtype">char</span> tmpdir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* directory temp files are stored in */</span></div><div class="line"><a name="l06323"></a><span class="lineno"> 6323</span>&#160;   <span class="keywordtype">char</span> tmptxtfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* tmp file for voicemail txt file */</span></div><div class="line"><a name="l06324"></a><span class="lineno"> 6324</span>&#160;   <span class="keywordtype">char</span> desttxtfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* final destination for txt file */</span></div><div class="line"><a name="l06325"></a><span class="lineno"> 6325</span>&#160;   <span class="keywordtype">char</span> tmpaudiofile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* tmp file where audio is stored */</span></div><div class="line"><a name="l06326"></a><span class="lineno"> 6326</span>&#160;   <span class="keywordtype">char</span> dir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* destination for tmp files on completion */</span></div><div class="line"><a name="l06327"></a><span class="lineno"> 6327</span>&#160;   <span class="keywordtype">char</span> destination[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* destination with msgXXXX.  Basically &lt;dir&gt;/msgXXXX */</span></div><div class="line"><a name="l06328"></a><span class="lineno"> 6328</span>&#160;</div><div class="line"><a name="l06329"></a><span class="lineno"> 6329</span>&#160;   <span class="comment">/* stuff that only seems to be needed for IMAP */</span></div><div class="line"><a name="l06330"></a><span class="lineno"> 6330</span>&#160;<span class="preprocessor">   #ifdef IMAP_STORAGE</span></div><div class="line"><a name="l06331"></a><span class="lineno"> 6331</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l06332"></a><span class="lineno"> 6332</span>&#160;   <span class="keywordtype">char</span> ext_context[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06333"></a><span class="lineno"> 6333</span>&#160;   <span class="keywordtype">char</span> *fmt = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#ab99aadde533836bd12636e2d3ab3912b">recording_ext</a>);</div><div class="line"><a name="l06334"></a><span class="lineno"> 6334</span>&#160;   <span class="keywordtype">int</span> newmsgs = 0;</div><div class="line"><a name="l06335"></a><span class="lineno"> 6335</span>&#160;   <span class="keywordtype">int</span> oldmsgs = 0;</div><div class="line"><a name="l06336"></a><span class="lineno"> 6336</span>&#160;<span class="preprocessor">   #endif</span></div><div class="line"><a name="l06337"></a><span class="lineno"> 6337</span>&#160;</div><div class="line"><a name="l06338"></a><span class="lineno"> 6338</span>&#160;   <span class="comment">/* miscellaneous operational variables */</span></div><div class="line"><a name="l06339"></a><span class="lineno"> 6339</span>&#160;   <span class="keywordtype">int</span> res = 0; <span class="comment">/* Used to store error codes from functions */</span></div><div class="line"><a name="l06340"></a><span class="lineno"> 6340</span>&#160;   <span class="keywordtype">int</span> txtdes <span class="comment">/* File descriptor for the text file used to write the voicemail info */</span>;</div><div class="line"><a name="l06341"></a><span class="lineno"> 6341</span>&#160;   FILE *txt; <span class="comment">/* FILE pointer to text file used to write the voicemail info */</span></div><div class="line"><a name="l06342"></a><span class="lineno"> 6342</span>&#160;   <span class="keywordtype">char</span> date[256]; <span class="comment">/* string used to hold date of the voicemail (only used for ODBC) */</span></div><div class="line"><a name="l06343"></a><span class="lineno"> 6343</span>&#160;   <span class="keywordtype">int</span> msgnum; <span class="comment">/* the 4 digit number designated to the voicemail */</span></div><div class="line"><a name="l06344"></a><span class="lineno"> 6344</span>&#160;   <span class="keywordtype">int</span> duration = 0; <span class="comment">/* Length of the audio being recorded in seconds */</span></div><div class="line"><a name="l06345"></a><span class="lineno"> 6345</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../db/dbc/structast__filestream.html">ast_filestream</a> *recording_fs; <span class="comment">/*used to read the recording to get duration data */</span></div><div class="line"><a name="l06346"></a><span class="lineno"> 6346</span>&#160;</div><div class="line"><a name="l06347"></a><span class="lineno"> 6347</span>&#160;   <span class="comment">/* We aren&#39;t currently doing anything with category, since it comes from a channel variable and</span></div><div class="line"><a name="l06348"></a><span class="lineno"> 6348</span>&#160;<span class="comment">    * this function doesn&#39;t use channels, but this function could add that as an argument later. */</span></div><div class="line"><a name="l06349"></a><span class="lineno"> 6349</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *category = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/* pointless for now */</span></div><div class="line"><a name="l06350"></a><span class="lineno"> 6350</span>&#160;   <span class="keywordtype">char</span> msg_id[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a>];</div><div class="line"><a name="l06351"></a><span class="lineno"> 6351</span>&#160;</div><div class="line"><a name="l06352"></a><span class="lineno"> 6352</span>&#160;   <span class="comment">/* Start by checking to see if the file actually exists... */</span></div><div class="line"><a name="l06353"></a><span class="lineno"> 6353</span>&#160;   <span class="keywordflow">if</span> (!(<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a40dd33d7fa211edd276ab547f4ad5d73">recording_file</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#ab99aadde533836bd12636e2d3ab3912b">recording_ext</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06354"></a><span class="lineno"> 6354</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;File: %s not found.\n&quot;</span>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a40dd33d7fa211edd276ab547f4ad5d73">recording_file</a>);</div><div class="line"><a name="l06355"></a><span class="lineno"> 6355</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06356"></a><span class="lineno"> 6356</span>&#160;   }</div><div class="line"><a name="l06357"></a><span class="lineno"> 6357</span>&#160;</div><div class="line"><a name="l06358"></a><span class="lineno"> 6358</span>&#160;   memset(&amp;svm, 0, <span class="keyword">sizeof</span>(svm));</div><div class="line"><a name="l06359"></a><span class="lineno"> 6359</span>&#160;   <span class="keywordflow">if</span> (!(recipient = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;svm, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a7faec841658b88ad0cfbc684853acad3">context</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>))) {</div><div class="line"><a name="l06360"></a><span class="lineno"> 6360</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No entry in voicemail config file for &#39;%s@%s&#39;\n&quot;</span>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a7faec841658b88ad0cfbc684853acad3">context</a>);</div><div class="line"><a name="l06361"></a><span class="lineno"> 6361</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06362"></a><span class="lineno"> 6362</span>&#160;   }</div><div class="line"><a name="l06363"></a><span class="lineno"> 6363</span>&#160;</div><div class="line"><a name="l06364"></a><span class="lineno"> 6364</span>&#160;   <span class="comment">/* determine duration in seconds */</span></div><div class="line"><a name="l06365"></a><span class="lineno"> 6365</span>&#160;   <span class="keywordflow">if</span> ((recording_fs = <a class="code" href="../../d2/d4d/file_8h.html#ad572060ea434390db3d1ccde4511dfcd">ast_readfile</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a40dd33d7fa211edd276ab547f4ad5d73">recording_file</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#ab99aadde533836bd12636e2d3ab3912b">recording_ext</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">VOICEMAIL_DIR_MODE</a>))) {</div><div class="line"><a name="l06366"></a><span class="lineno"> 6366</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4d/file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07">ast_seekstream</a>(recording_fs, 0, SEEK_END)) {</div><div class="line"><a name="l06367"></a><span class="lineno"> 6367</span>&#160;         <span class="keywordtype">long</span> framelength = <a class="code" href="../../d2/d4d/file_8h.html#a01771a318e7adea51499040f27b4278a">ast_tellstream</a>(recording_fs);</div><div class="line"><a name="l06368"></a><span class="lineno"> 6368</span>&#160;         <span class="keywordtype">int</span> sample_rate = <a class="code" href="../../d2/d4d/file_8h.html#ab4afbcd56a1aaf40eca3827e6d890372">ast_ratestream</a>(recording_fs);</div><div class="line"><a name="l06369"></a><span class="lineno"> 6369</span>&#160;         <span class="keywordflow">if</span> (sample_rate) {</div><div class="line"><a name="l06370"></a><span class="lineno"> 6370</span>&#160;            duration = (int) (framelength / sample_rate);</div><div class="line"><a name="l06371"></a><span class="lineno"> 6371</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06372"></a><span class="lineno"> 6372</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Unable to determine sample rate of recording %s\n&quot;</span>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a40dd33d7fa211edd276ab547f4ad5d73">recording_file</a>);</div><div class="line"><a name="l06373"></a><span class="lineno"> 6373</span>&#160;         }</div><div class="line"><a name="l06374"></a><span class="lineno"> 6374</span>&#160;      }</div><div class="line"><a name="l06375"></a><span class="lineno"> 6375</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a>(recording_fs);</div><div class="line"><a name="l06376"></a><span class="lineno"> 6376</span>&#160;   }</div><div class="line"><a name="l06377"></a><span class="lineno"> 6377</span>&#160;</div><div class="line"><a name="l06378"></a><span class="lineno"> 6378</span>&#160;   <span class="comment">/* If the duration was below the minimum duration for the user, let&#39;s just drop the whole thing now */</span></div><div class="line"><a name="l06379"></a><span class="lineno"> 6379</span>&#160;   <span class="keywordflow">if</span> (duration &lt; recipient-&gt;minsecs) {</div><div class="line"><a name="l06380"></a><span class="lineno"> 6380</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Copying recording to voicemail %s@%s skipped because duration was shorter than &quot;</span></div><div class="line"><a name="l06381"></a><span class="lineno"> 6381</span>&#160;               <span class="stringliteral">&quot;minmessage of recipient\n&quot;</span>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a7faec841658b88ad0cfbc684853acad3">context</a>);</div><div class="line"><a name="l06382"></a><span class="lineno"> 6382</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06383"></a><span class="lineno"> 6383</span>&#160;   }</div><div class="line"><a name="l06384"></a><span class="lineno"> 6384</span>&#160;</div><div class="line"><a name="l06385"></a><span class="lineno"> 6385</span>&#160;   <span class="comment">/* Note that this number must be dropped back to a net sum of zero before returning from this function */</span></div><div class="line"><a name="l06386"></a><span class="lineno"> 6386</span>&#160;</div><div class="line"><a name="l06387"></a><span class="lineno"> 6387</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(tmpdir, <span class="keyword">sizeof</span>(tmpdir), recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>, <span class="stringliteral">&quot;tmp&quot;</span>))) {</div><div class="line"><a name="l06388"></a><span class="lineno"> 6388</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to make directory.\n&quot;</span>);</div><div class="line"><a name="l06389"></a><span class="lineno"> 6389</span>&#160;   }</div><div class="line"><a name="l06390"></a><span class="lineno"> 6390</span>&#160;</div><div class="line"><a name="l06391"></a><span class="lineno"> 6391</span>&#160;   snprintf(tmptxtfile, <span class="keyword">sizeof</span>(tmptxtfile), <span class="stringliteral">&quot;%s/XXXXXX&quot;</span>, tmpdir);</div><div class="line"><a name="l06392"></a><span class="lineno"> 6392</span>&#160;   txtdes = mkstemp(tmptxtfile);</div><div class="line"><a name="l06393"></a><span class="lineno"> 6393</span>&#160;   <span class="keywordflow">if</span> (txtdes &lt; 0) {</div><div class="line"><a name="l06394"></a><span class="lineno"> 6394</span>&#160;      chmod(tmptxtfile, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a> &amp; ~my_umask);</div><div class="line"><a name="l06395"></a><span class="lineno"> 6395</span>&#160;      <span class="comment">/* Something screwed up.  Abort. */</span></div><div class="line"><a name="l06396"></a><span class="lineno"> 6396</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create message file: %s\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l06397"></a><span class="lineno"> 6397</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06398"></a><span class="lineno"> 6398</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06399"></a><span class="lineno"> 6399</span>&#160;   }</div><div class="line"><a name="l06400"></a><span class="lineno"> 6400</span>&#160;</div><div class="line"><a name="l06401"></a><span class="lineno"> 6401</span>&#160;   <span class="comment">/* Store information */</span></div><div class="line"><a name="l06402"></a><span class="lineno"> 6402</span>&#160;   txt = fdopen(txtdes, <span class="stringliteral">&quot;w+&quot;</span>);</div><div class="line"><a name="l06403"></a><span class="lineno"> 6403</span>&#160;   <span class="keywordflow">if</span> (txt) {</div><div class="line"><a name="l06404"></a><span class="lineno"> 6404</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(msg_id);</div><div class="line"><a name="l06405"></a><span class="lineno"> 6405</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">get_date</a>(date, <span class="keyword">sizeof</span>(date));</div><div class="line"><a name="l06406"></a><span class="lineno"> 6406</span>&#160;      fprintf(txt,</div><div class="line"><a name="l06407"></a><span class="lineno"> 6407</span>&#160;         <span class="stringliteral">&quot;;\n&quot;</span></div><div class="line"><a name="l06408"></a><span class="lineno"> 6408</span>&#160;         <span class="stringliteral">&quot;; Message Information file\n&quot;</span></div><div class="line"><a name="l06409"></a><span class="lineno"> 6409</span>&#160;         <span class="stringliteral">&quot;;\n&quot;</span></div><div class="line"><a name="l06410"></a><span class="lineno"> 6410</span>&#160;         <span class="stringliteral">&quot;[message]\n&quot;</span></div><div class="line"><a name="l06411"></a><span class="lineno"> 6411</span>&#160;         <span class="stringliteral">&quot;origmailbox=%s\n&quot;</span></div><div class="line"><a name="l06412"></a><span class="lineno"> 6412</span>&#160;         <span class="stringliteral">&quot;context=%s\n&quot;</span></div><div class="line"><a name="l06413"></a><span class="lineno"> 6413</span>&#160;         <span class="stringliteral">&quot;macrocontext=%s\n&quot;</span></div><div class="line"><a name="l06414"></a><span class="lineno"> 6414</span>&#160;         <span class="stringliteral">&quot;exten=%s\n&quot;</span></div><div class="line"><a name="l06415"></a><span class="lineno"> 6415</span>&#160;         <span class="stringliteral">&quot;rdnis=Unknown\n&quot;</span></div><div class="line"><a name="l06416"></a><span class="lineno"> 6416</span>&#160;         <span class="stringliteral">&quot;priority=%d\n&quot;</span></div><div class="line"><a name="l06417"></a><span class="lineno"> 6417</span>&#160;         <span class="stringliteral">&quot;callerchan=%s\n&quot;</span></div><div class="line"><a name="l06418"></a><span class="lineno"> 6418</span>&#160;         <span class="stringliteral">&quot;callerid=%s\n&quot;</span></div><div class="line"><a name="l06419"></a><span class="lineno"> 6419</span>&#160;         <span class="stringliteral">&quot;origdate=%s\n&quot;</span></div><div class="line"><a name="l06420"></a><span class="lineno"> 6420</span>&#160;         <span class="stringliteral">&quot;origtime=%ld\n&quot;</span></div><div class="line"><a name="l06421"></a><span class="lineno"> 6421</span>&#160;         <span class="stringliteral">&quot;category=%s\n&quot;</span></div><div class="line"><a name="l06422"></a><span class="lineno"> 6422</span>&#160;         <span class="stringliteral">&quot;msg_id=%s\n&quot;</span></div><div class="line"><a name="l06423"></a><span class="lineno"> 6423</span>&#160;         <span class="stringliteral">&quot;flag=\n&quot;</span> <span class="comment">/* flags not supported in copy from file yet */</span></div><div class="line"><a name="l06424"></a><span class="lineno"> 6424</span>&#160;         <span class="stringliteral">&quot;duration=%d\n&quot;</span>, <span class="comment">/* Don&#39;t have any reliable way to get duration of file. */</span></div><div class="line"><a name="l06425"></a><span class="lineno"> 6425</span>&#160;</div><div class="line"><a name="l06426"></a><span class="lineno"> 6426</span>&#160;         recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>,</div><div class="line"><a name="l06427"></a><span class="lineno"> 6427</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#ab72e1828c8ae3ac5b663c22ac5f7f7eb">call_context</a>, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06428"></a><span class="lineno"> 6428</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a29e2f9d32a5e270df22ec41e8def7fab">call_macrocontext</a>, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06429"></a><span class="lineno"> 6429</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#abb2534e0096a9f91aa1541900be4edf1">call_extension</a>, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06430"></a><span class="lineno"> 6430</span>&#160;         recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a6c4ee520c857eb74851962c54f6c2bf1">call_priority</a>,</div><div class="line"><a name="l06431"></a><span class="lineno"> 6431</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a6289cadce5fd2b3dbf516cdd824638f5">call_callerchan</a>, <span class="stringliteral">&quot;Unknown&quot;</span>),</div><div class="line"><a name="l06432"></a><span class="lineno"> 6432</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a8531d21b3ca3a109d9b8d0d88d079c3b">call_callerid</a>, <span class="stringliteral">&quot;Unknown&quot;</span>),</div><div class="line"><a name="l06433"></a><span class="lineno"> 6433</span>&#160;         date, (<span class="keywordtype">long</span>) time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06434"></a><span class="lineno"> 6434</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(category, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06435"></a><span class="lineno"> 6435</span>&#160;         msg_id,</div><div class="line"><a name="l06436"></a><span class="lineno"> 6436</span>&#160;         duration);</div><div class="line"><a name="l06437"></a><span class="lineno"> 6437</span>&#160;</div><div class="line"><a name="l06438"></a><span class="lineno"> 6438</span>&#160;      <span class="comment">/* Since we are recording from a file, we shouldn&#39;t need to do anything else with</span></div><div class="line"><a name="l06439"></a><span class="lineno"> 6439</span>&#160;<span class="comment">       * this txt file */</span></div><div class="line"><a name="l06440"></a><span class="lineno"> 6440</span>&#160;      fclose(txt);</div><div class="line"><a name="l06441"></a><span class="lineno"> 6441</span>&#160;</div><div class="line"><a name="l06442"></a><span class="lineno"> 6442</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06443"></a><span class="lineno"> 6443</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error opening text file for output\n&quot;</span>);</div><div class="line"><a name="l06444"></a><span class="lineno"> 6444</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l06445"></a><span class="lineno"> 6445</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l06446"></a><span class="lineno"> 6446</span>&#160;      }</div><div class="line"><a name="l06447"></a><span class="lineno"> 6447</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06448"></a><span class="lineno"> 6448</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06449"></a><span class="lineno"> 6449</span>&#160;   }</div><div class="line"><a name="l06450"></a><span class="lineno"> 6450</span>&#160;</div><div class="line"><a name="l06451"></a><span class="lineno"> 6451</span>&#160;   <span class="comment">/* At this point, the actual creation of a voicemail message should be finished.</span></div><div class="line"><a name="l06452"></a><span class="lineno"> 6452</span>&#160;<span class="comment">    * Now we just need to copy the files being recorded into the receiving folder. */</span></div><div class="line"><a name="l06453"></a><span class="lineno"> 6453</span>&#160;</div><div class="line"><a name="l06454"></a><span class="lineno"> 6454</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(dir, <span class="keyword">sizeof</span>(dir), recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a80d52a4ea102b992a471e7515e675b20">folder</a>);</div><div class="line"><a name="l06455"></a><span class="lineno"> 6455</span>&#160;</div><div class="line"><a name="l06456"></a><span class="lineno"> 6456</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l06457"></a><span class="lineno"> 6457</span>&#160;   <span class="comment">/* make recipient info into an inboxcount friendly string */</span></div><div class="line"><a name="l06458"></a><span class="lineno"> 6458</span>&#160;   snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l06459"></a><span class="lineno"> 6459</span>&#160;</div><div class="line"><a name="l06460"></a><span class="lineno"> 6460</span>&#160;   <span class="comment">/* Is ext a mailbox? */</span></div><div class="line"><a name="l06461"></a><span class="lineno"> 6461</span>&#160;   <span class="comment">/* must open stream for this user to get info! */</span></div><div class="line"><a name="l06462"></a><span class="lineno"> 6462</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(ext_context, &amp;newmsgs, &amp;oldmsgs);</div><div class="line"><a name="l06463"></a><span class="lineno"> 6463</span>&#160;   <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line"><a name="l06464"></a><span class="lineno"> 6464</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Can not leave voicemail, unable to count messages\n&quot;</span>);</div><div class="line"><a name="l06465"></a><span class="lineno"> 6465</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06466"></a><span class="lineno"> 6466</span>&#160;      unlink(tmptxtfile);</div><div class="line"><a name="l06467"></a><span class="lineno"> 6467</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06468"></a><span class="lineno"> 6468</span>&#160;   }</div><div class="line"><a name="l06469"></a><span class="lineno"> 6469</span>&#160;   <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0))) {</div><div class="line"><a name="l06470"></a><span class="lineno"> 6470</span>&#160;   <span class="comment">/* It is possible under certain circumstances that inboxcount did not</span></div><div class="line"><a name="l06471"></a><span class="lineno"> 6471</span>&#160;<span class="comment">    * create a vm_state when it was needed. This is a catchall which will</span></div><div class="line"><a name="l06472"></a><span class="lineno"> 6472</span>&#160;<span class="comment">    * rarely be used.</span></div><div class="line"><a name="l06473"></a><span class="lineno"> 6473</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l06474"></a><span class="lineno"> 6474</span>&#160;      <span class="keywordflow">if</span> (!(vms = create_vm_state_from_user(recipient))) {</div><div class="line"><a name="l06475"></a><span class="lineno"> 6475</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t allocate necessary space\n&quot;</span>);</div><div class="line"><a name="l06476"></a><span class="lineno"> 6476</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06477"></a><span class="lineno"> 6477</span>&#160;         unlink(tmptxtfile);</div><div class="line"><a name="l06478"></a><span class="lineno"> 6478</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06479"></a><span class="lineno"> 6479</span>&#160;      }</div><div class="line"><a name="l06480"></a><span class="lineno"> 6480</span>&#160;   }</div><div class="line"><a name="l06481"></a><span class="lineno"> 6481</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>++;</div><div class="line"><a name="l06482"></a><span class="lineno"> 6482</span>&#160;</div><div class="line"><a name="l06483"></a><span class="lineno"> 6483</span>&#160;   <span class="comment">/* here is a big difference! We add one to it later */</span></div><div class="line"><a name="l06484"></a><span class="lineno"> 6484</span>&#160;   msgnum = newmsgs + oldmsgs;</div><div class="line"><a name="l06485"></a><span class="lineno"> 6485</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Messagecount set to %d\n&quot;</span>, msgnum);</div><div class="line"><a name="l06486"></a><span class="lineno"> 6486</span>&#160;   snprintf(destination, <span class="keyword">sizeof</span>(destination), <span class="stringliteral">&quot;%simap/msg%s%04d&quot;</span>, VM_SPOOL_DIR, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, msgnum);</div><div class="line"><a name="l06487"></a><span class="lineno"> 6487</span>&#160;</div><div class="line"><a name="l06488"></a><span class="lineno"> 6488</span>&#160;   <span class="comment">/* Check to see if we have enough room in the mailbox. If not, spit out an error and end</span></div><div class="line"><a name="l06489"></a><span class="lineno"> 6489</span>&#160;<span class="comment">    * Note that imap_check_limits raises inprocess_count if successful */</span></div><div class="line"><a name="l06490"></a><span class="lineno"> 6490</span>&#160;   <span class="keywordflow">if</span> ((res = imap_check_limits(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vms, recipient, msgnum))) {</div><div class="line"><a name="l06491"></a><span class="lineno"> 6491</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Didn&#39;t copy to voicemail. Mailbox for %s@%s is full.\n&quot;</span>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l06492"></a><span class="lineno"> 6492</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06493"></a><span class="lineno"> 6493</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06494"></a><span class="lineno"> 6494</span>&#160;      unlink(tmptxtfile);</div><div class="line"><a name="l06495"></a><span class="lineno"> 6495</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06496"></a><span class="lineno"> 6496</span>&#160;   }</div><div class="line"><a name="l06497"></a><span class="lineno"> 6497</span>&#160;</div><div class="line"><a name="l06498"></a><span class="lineno"> 6498</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l06499"></a><span class="lineno"> 6499</span>&#160;</div><div class="line"><a name="l06500"></a><span class="lineno"> 6500</span>&#160;   <span class="comment">/* Check to see if the mailbox is full for ODBC/File storage */</span></div><div class="line"><a name="l06501"></a><span class="lineno"> 6501</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;mailbox = %d : inprocess = %d\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a>(recipient, dir),</div><div class="line"><a name="l06502"></a><span class="lineno"> 6502</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 0));</div><div class="line"><a name="l06503"></a><span class="lineno"> 6503</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a>(recipient, dir) &gt; recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> - <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, +1)) {</div><div class="line"><a name="l06504"></a><span class="lineno"> 6504</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Didn&#39;t copy to voicemail. Mailbox for %s@%s is full.\n&quot;</span>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l06505"></a><span class="lineno"> 6505</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06506"></a><span class="lineno"> 6506</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06507"></a><span class="lineno"> 6507</span>&#160;      unlink(tmptxtfile);</div><div class="line"><a name="l06508"></a><span class="lineno"> 6508</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06509"></a><span class="lineno"> 6509</span>&#160;   }</div><div class="line"><a name="l06510"></a><span class="lineno"> 6510</span>&#160;</div><div class="line"><a name="l06511"></a><span class="lineno"> 6511</span>&#160;   msgnum = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(recipient, dir) + 1;</div><div class="line"><a name="l06512"></a><span class="lineno"> 6512</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06513"></a><span class="lineno"> 6513</span>&#160;</div><div class="line"><a name="l06514"></a><span class="lineno"> 6514</span>&#160;   <span class="comment">/* Lock the directory receiving the voicemail since we want it to still exist when we attempt to copy the voicemail.</span></div><div class="line"><a name="l06515"></a><span class="lineno"> 6515</span>&#160;<span class="comment">    * We need to unlock it before we return. */</span></div><div class="line"><a name="l06516"></a><span class="lineno"> 6516</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(dir)) {</div><div class="line"><a name="l06517"></a><span class="lineno"> 6517</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t lock directory %s.  Voicemail will be lost.\n&quot;</span>, dir);</div><div class="line"><a name="l06518"></a><span class="lineno"> 6518</span>&#160;      <span class="comment">/* Delete files */</span></div><div class="line"><a name="l06519"></a><span class="lineno"> 6519</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tmptxtfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l06520"></a><span class="lineno"> 6520</span>&#160;      unlink(tmptxtfile);</div><div class="line"><a name="l06521"></a><span class="lineno"> 6521</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06522"></a><span class="lineno"> 6522</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06523"></a><span class="lineno"> 6523</span>&#160;   }</div><div class="line"><a name="l06524"></a><span class="lineno"> 6524</span>&#160;</div><div class="line"><a name="l06525"></a><span class="lineno"> 6525</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(destination, <span class="keyword">sizeof</span>(destination), dir, msgnum);</div><div class="line"><a name="l06526"></a><span class="lineno"> 6526</span>&#160;</div><div class="line"><a name="l06527"></a><span class="lineno"> 6527</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(tmpaudiofile, <span class="keyword">sizeof</span>(tmpaudiofile), tmpdir, msgnum);</div><div class="line"><a name="l06528"></a><span class="lineno"> 6528</span>&#160;</div><div class="line"><a name="l06529"></a><span class="lineno"> 6529</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b">ast_filecopy</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a40dd33d7fa211edd276ab547f4ad5d73">recording_file</a>, tmpaudiofile, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#ab99aadde533836bd12636e2d3ab3912b">recording_ext</a>)) {</div><div class="line"><a name="l06530"></a><span class="lineno"> 6530</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Audio file failed to copy to tmp dir. Probably low disk space.\n&quot;</span>);</div><div class="line"><a name="l06531"></a><span class="lineno"> 6531</span>&#160;</div><div class="line"><a name="l06532"></a><span class="lineno"> 6532</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06533"></a><span class="lineno"> 6533</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l06534"></a><span class="lineno"> 6534</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06535"></a><span class="lineno"> 6535</span>&#160;      unlink(tmptxtfile);</div><div class="line"><a name="l06536"></a><span class="lineno"> 6536</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06537"></a><span class="lineno"> 6537</span>&#160;   }</div><div class="line"><a name="l06538"></a><span class="lineno"> 6538</span>&#160;</div><div class="line"><a name="l06539"></a><span class="lineno"> 6539</span>&#160;   <span class="comment">/* Alright, try to copy to the destination folder now. */</span></div><div class="line"><a name="l06540"></a><span class="lineno"> 6540</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(tmpaudiofile, destination, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#ab99aadde533836bd12636e2d3ab3912b">recording_ext</a>)) {</div><div class="line"><a name="l06541"></a><span class="lineno"> 6541</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Audio file failed to move to destination directory. Permissions/Overlap?\n&quot;</span>);</div><div class="line"><a name="l06542"></a><span class="lineno"> 6542</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06543"></a><span class="lineno"> 6543</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l06544"></a><span class="lineno"> 6544</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06545"></a><span class="lineno"> 6545</span>&#160;      unlink(tmptxtfile);</div><div class="line"><a name="l06546"></a><span class="lineno"> 6546</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06547"></a><span class="lineno"> 6547</span>&#160;   }</div><div class="line"><a name="l06548"></a><span class="lineno"> 6548</span>&#160;</div><div class="line"><a name="l06549"></a><span class="lineno"> 6549</span>&#160;   snprintf(desttxtfile, <span class="keyword">sizeof</span>(desttxtfile), <span class="stringliteral">&quot;%s.txt&quot;</span>, destination);</div><div class="line"><a name="l06550"></a><span class="lineno"> 6550</span>&#160;   rename(tmptxtfile, desttxtfile);</div><div class="line"><a name="l06551"></a><span class="lineno"> 6551</span>&#160;</div><div class="line"><a name="l06552"></a><span class="lineno"> 6552</span>&#160;   <span class="keywordflow">if</span> (chmod(desttxtfile, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>) &lt; 0) {</div><div class="line"><a name="l06553"></a><span class="lineno"> 6553</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t set permissions on voicemail text file %s: %s&quot;</span>, desttxtfile, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l06554"></a><span class="lineno"> 6554</span>&#160;   }</div><div class="line"><a name="l06555"></a><span class="lineno"> 6555</span>&#160;</div><div class="line"><a name="l06556"></a><span class="lineno"> 6556</span>&#160;</div><div class="line"><a name="l06557"></a><span class="lineno"> 6557</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l06558"></a><span class="lineno"> 6558</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06559"></a><span class="lineno"> 6559</span>&#160;</div><div class="line"><a name="l06560"></a><span class="lineno"> 6560</span>&#160;   <span class="comment">/* If we copied something, we should store it either to ODBC or IMAP if we are using those. The STORE macro allows us</span></div><div class="line"><a name="l06561"></a><span class="lineno"> 6561</span>&#160;<span class="comment">    * to do both with one line and is also safe to use with file storage mode. Also, if we are using ODBC, now is a good</span></div><div class="line"><a name="l06562"></a><span class="lineno"> 6562</span>&#160;<span class="comment">    * time to create the voicemail database entry. */</span></div><div class="line"><a name="l06563"></a><span class="lineno"> 6563</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(destination, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l06564"></a><span class="lineno"> 6564</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l06565"></a><span class="lineno"> 6565</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">get_date</a>(date, <span class="keyword">sizeof</span>(date));</div><div class="line"><a name="l06566"></a><span class="lineno"> 6566</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2">ast_store_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>,</div><div class="line"><a name="l06567"></a><span class="lineno"> 6567</span>&#160;            <span class="stringliteral">&quot;origmailbox&quot;</span>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">mailbox</a>,</div><div class="line"><a name="l06568"></a><span class="lineno"> 6568</span>&#160;            <span class="stringliteral">&quot;context&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a7faec841658b88ad0cfbc684853acad3">context</a>, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06569"></a><span class="lineno"> 6569</span>&#160;            <span class="stringliteral">&quot;macrocontext&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a29e2f9d32a5e270df22ec41e8def7fab">call_macrocontext</a>, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06570"></a><span class="lineno"> 6570</span>&#160;            <span class="stringliteral">&quot;exten&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#abb2534e0096a9f91aa1541900be4edf1">call_extension</a>, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06571"></a><span class="lineno"> 6571</span>&#160;            <span class="stringliteral">&quot;priority&quot;</span>, recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a6c4ee520c857eb74851962c54f6c2bf1">call_priority</a>,</div><div class="line"><a name="l06572"></a><span class="lineno"> 6572</span>&#160;            <span class="stringliteral">&quot;callerchan&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a6289cadce5fd2b3dbf516cdd824638f5">call_callerchan</a>, <span class="stringliteral">&quot;Unknown&quot;</span>),</div><div class="line"><a name="l06573"></a><span class="lineno"> 6573</span>&#160;            <span class="stringliteral">&quot;callerid&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(recdata-&gt;<a class="code" href="../../df/d45/structast__vm__recording__data.html#a8531d21b3ca3a109d9b8d0d88d079c3b">call_callerid</a>, <span class="stringliteral">&quot;Unknown&quot;</span>),</div><div class="line"><a name="l06574"></a><span class="lineno"> 6574</span>&#160;            <span class="stringliteral">&quot;origdate&quot;</span>, date,</div><div class="line"><a name="l06575"></a><span class="lineno"> 6575</span>&#160;            <span class="stringliteral">&quot;origtime&quot;</span>, time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06576"></a><span class="lineno"> 6576</span>&#160;            <span class="stringliteral">&quot;category&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(category, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06577"></a><span class="lineno"> 6577</span>&#160;            <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile,</div><div class="line"><a name="l06578"></a><span class="lineno"> 6578</span>&#160;            <span class="stringliteral">&quot;duration&quot;</span>, duration,</div><div class="line"><a name="l06579"></a><span class="lineno"> 6579</span>&#160;            <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l06580"></a><span class="lineno"> 6580</span>&#160;      }</div><div class="line"><a name="l06581"></a><span class="lineno"> 6581</span>&#160;</div><div class="line"><a name="l06582"></a><span class="lineno"> 6582</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a>(dir, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, recipient-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, msgnum, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, recipient, fmt, 0, vms, <span class="stringliteral">&quot;&quot;</span>, msg_id);</div><div class="line"><a name="l06583"></a><span class="lineno"> 6583</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(recipient);</div><div class="line"><a name="l06584"></a><span class="lineno"> 6584</span>&#160;   }</div><div class="line"><a name="l06585"></a><span class="lineno"> 6585</span>&#160;</div><div class="line"><a name="l06586"></a><span class="lineno"> 6586</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recipient);</div><div class="line"><a name="l06587"></a><span class="lineno"> 6587</span>&#160;   unlink(tmptxtfile);</div><div class="line"><a name="l06588"></a><span class="lineno"> 6588</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06589"></a><span class="lineno"> 6589</span>&#160;}</div><div class="line"><a name="l06590"></a><span class="lineno"> 6590</span>&#160;<span class="comment"></span></div><div class="line"><a name="l06591"></a><span class="lineno"> 6591</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l06592"></a><span class="lineno"> 6592</span>&#160;<span class="comment"> * \brief Prompts the user and records a voicemail to a mailbox.</span></div><div class="line"><a name="l06593"></a><span class="lineno"> 6593</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l06594"></a><span class="lineno"> 6594</span>&#160;<span class="comment"> * \param ext</span></div><div class="line"><a name="l06595"></a><span class="lineno"> 6595</span>&#160;<span class="comment"> * \param options OPT_BUSY_GREETING, OPT_UNAVAIL_GREETING</span></div><div class="line"><a name="l06596"></a><span class="lineno"> 6596</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06597"></a><span class="lineno"> 6597</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06598"></a><span class="lineno"> 6598</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l06599"></a><span class="lineno"> 6599</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l06600"></a><span class="lineno"> 6600</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l06601"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff"> 6601</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff">leave_voicemail</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *<a class="code" href="../../dd/d43/http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">struct</span> <a class="code" href="../../dd/df7/structleave__vm__options.html">leave_vm_options</a> *<a class="code" href="../../d4/d45/test__http__media__cache_8c.html#a80c8e3ae5087d90d422675d034eeebc7">options</a>)</div><div class="line"><a name="l06602"></a><span class="lineno"> 6602</span>&#160;{</div><div class="line"><a name="l06603"></a><span class="lineno"> 6603</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l06604"></a><span class="lineno"> 6604</span>&#160;   <span class="keywordtype">int</span> newmsgs, oldmsgs;</div><div class="line"><a name="l06605"></a><span class="lineno"> 6605</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06606"></a><span class="lineno"> 6606</span>&#160;   <span class="keywordtype">char</span> txtfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l06607"></a><span class="lineno"> 6607</span>&#160;   <span class="keywordtype">char</span> tmptxtfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l06608"></a><span class="lineno"> 6608</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l06609"></a><span class="lineno"> 6609</span>&#160;   <span class="keywordtype">char</span> callerid[256];</div><div class="line"><a name="l06610"></a><span class="lineno"> 6610</span>&#160;   FILE *txt;</div><div class="line"><a name="l06611"></a><span class="lineno"> 6611</span>&#160;   <span class="keywordtype">char</span> date[256];</div><div class="line"><a name="l06612"></a><span class="lineno"> 6612</span>&#160;   <span class="keywordtype">int</span> txtdes;</div><div class="line"><a name="l06613"></a><span class="lineno"> 6613</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l06614"></a><span class="lineno"> 6614</span>&#160;   <span class="keywordtype">int</span> msgnum;</div><div class="line"><a name="l06615"></a><span class="lineno"> 6615</span>&#160;   <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l06616"></a><span class="lineno"> 6616</span>&#160;   <span class="keywordtype">int</span> sound_duration = 0;</div><div class="line"><a name="l06617"></a><span class="lineno"> 6617</span>&#160;   <span class="keywordtype">int</span> ausemacro = 0;</div><div class="line"><a name="l06618"></a><span class="lineno"> 6618</span>&#160;   <span class="keywordtype">int</span> ousemacro = 0;</div><div class="line"><a name="l06619"></a><span class="lineno"> 6619</span>&#160;   <span class="keywordtype">int</span> ouseexten = 0;</div><div class="line"><a name="l06620"></a><span class="lineno"> 6620</span>&#160;   <span class="keywordtype">int</span> greeting_only = 0;</div><div class="line"><a name="l06621"></a><span class="lineno"> 6621</span>&#160;   <span class="keywordtype">char</span> tmpdur[16];</div><div class="line"><a name="l06622"></a><span class="lineno"> 6622</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d9/d47/cdr__beanstalkd_8c.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>[16];</div><div class="line"><a name="l06623"></a><span class="lineno"> 6623</span>&#160;   <span class="keywordtype">char</span> origtime[16];</div><div class="line"><a name="l06624"></a><span class="lineno"> 6624</span>&#160;   <span class="keywordtype">char</span> dir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l06625"></a><span class="lineno"> 6625</span>&#160;   <span class="keywordtype">char</span> tmpdir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l06626"></a><span class="lineno"> 6626</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l06627"></a><span class="lineno"> 6627</span>&#160;   <span class="keywordtype">char</span> prefile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06628"></a><span class="lineno"> 6628</span>&#160;   <span class="keywordtype">char</span> tempfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06629"></a><span class="lineno"> 6629</span>&#160;   <span class="keywordtype">char</span> ext_context[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06630"></a><span class="lineno"> 6630</span>&#160;   <span class="keywordtype">char</span> fmt[80];</div><div class="line"><a name="l06631"></a><span class="lineno"> 6631</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l06632"></a><span class="lineno"> 6632</span>&#160;   <span class="keywordtype">char</span> ecodes[17] = <span class="stringliteral">&quot;#&quot;</span>;</div><div class="line"><a name="l06633"></a><span class="lineno"> 6633</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> *tmp = <a class="code" href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a>(16);</div><div class="line"><a name="l06634"></a><span class="lineno"> 6634</span>&#160;   <span class="keywordtype">char</span> *tmpptr;</div><div class="line"><a name="l06635"></a><span class="lineno"> 6635</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l06636"></a><span class="lineno"> 6636</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> svm;</div><div class="line"><a name="l06637"></a><span class="lineno"> 6637</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *category = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l06638"></a><span class="lineno"> 6638</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *code;</div><div class="line"><a name="l06639"></a><span class="lineno"> 6639</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *alldtmf = <span class="stringliteral">&quot;0123456789ABCD*#&quot;</span>;</div><div class="line"><a name="l06640"></a><span class="lineno"> 6640</span>&#160;   <span class="keywordtype">char</span> flag[80];</div><div class="line"><a name="l06641"></a><span class="lineno"> 6641</span>&#160;</div><div class="line"><a name="l06642"></a><span class="lineno"> 6642</span>&#160;   <span class="keywordflow">if</span> (!tmp) {</div><div class="line"><a name="l06643"></a><span class="lineno"> 6643</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06644"></a><span class="lineno"> 6644</span>&#160;   }</div><div class="line"><a name="l06645"></a><span class="lineno"> 6645</span>&#160;</div><div class="line"><a name="l06646"></a><span class="lineno"> 6646</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(&amp;tmp, 0, <span class="stringliteral">&quot;%s&quot;</span>, ext);</div><div class="line"><a name="l06647"></a><span class="lineno"> 6647</span>&#160;   ext = <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(tmp);</div><div class="line"><a name="l06648"></a><span class="lineno"> 6648</span>&#160;   <span class="keywordflow">if</span> ((context = strchr(ext, <span class="charliteral">&#39;@&#39;</span>))) {</div><div class="line"><a name="l06649"></a><span class="lineno"> 6649</span>&#160;      *context++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l06650"></a><span class="lineno"> 6650</span>&#160;      tmpptr = strchr(context, <span class="charliteral">&#39;&amp;&#39;</span>);</div><div class="line"><a name="l06651"></a><span class="lineno"> 6651</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06652"></a><span class="lineno"> 6652</span>&#160;      tmpptr = strchr(ext, <span class="charliteral">&#39;&amp;&#39;</span>);</div><div class="line"><a name="l06653"></a><span class="lineno"> 6653</span>&#160;   }</div><div class="line"><a name="l06654"></a><span class="lineno"> 6654</span>&#160;</div><div class="line"><a name="l06655"></a><span class="lineno"> 6655</span>&#160;   <span class="keywordflow">if</span> (tmpptr)</div><div class="line"><a name="l06656"></a><span class="lineno"> 6656</span>&#160;      *tmpptr++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l06657"></a><span class="lineno"> 6657</span>&#160;</div><div class="line"><a name="l06658"></a><span class="lineno"> 6658</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#a493bdebe876caafb8ee535853310364a">ast_channel_lock</a>(chan);</div><div class="line"><a name="l06659"></a><span class="lineno"> 6659</span>&#160;   <span class="keywordflow">if</span> ((category = <a class="code" href="../../db/de0/pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;VM_CATEGORY&quot;</span>))) {</div><div class="line"><a name="l06660"></a><span class="lineno"> 6660</span>&#160;      category = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(category);</div><div class="line"><a name="l06661"></a><span class="lineno"> 6661</span>&#160;   }</div><div class="line"><a name="l06662"></a><span class="lineno"> 6662</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#af476c537b29be3f29240489032f9db39">ast_channel_unlock</a>(chan);</div><div class="line"><a name="l06663"></a><span class="lineno"> 6663</span>&#160;</div><div class="line"><a name="l06664"></a><span class="lineno"> 6664</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a>)) {</div><div class="line"><a name="l06665"></a><span class="lineno"> 6665</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(flag, <span class="stringliteral">&quot;Urgent&quot;</span>, <span class="keyword">sizeof</span>(flag));</div><div class="line"><a name="l06666"></a><span class="lineno"> 6666</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a>)) {</div><div class="line"><a name="l06667"></a><span class="lineno"> 6667</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(flag, <span class="stringliteral">&quot;PRIORITY&quot;</span>, <span class="keyword">sizeof</span>(flag));</div><div class="line"><a name="l06668"></a><span class="lineno"> 6668</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06669"></a><span class="lineno"> 6669</span>&#160;      flag[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l06670"></a><span class="lineno"> 6670</span>&#160;   }</div><div class="line"><a name="l06671"></a><span class="lineno"> 6671</span>&#160;</div><div class="line"><a name="l06672"></a><span class="lineno"> 6672</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Before find_user\n&quot;</span>);</div><div class="line"><a name="l06673"></a><span class="lineno"> 6673</span>&#160;   memset(&amp;svm, 0, <span class="keyword">sizeof</span>(svm));</div><div class="line"><a name="l06674"></a><span class="lineno"> 6674</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;svm, context, ext))) {</div><div class="line"><a name="l06675"></a><span class="lineno"> 6675</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No entry in voicemail config file for &#39;%s&#39;\n&quot;</span>, ext);</div><div class="line"><a name="l06676"></a><span class="lineno"> 6676</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l06677"></a><span class="lineno"> 6677</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06678"></a><span class="lineno"> 6678</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l06679"></a><span class="lineno"> 6679</span>&#160;   }</div><div class="line"><a name="l06680"></a><span class="lineno"> 6680</span>&#160;</div><div class="line"><a name="l06681"></a><span class="lineno"> 6681</span>&#160;   <span class="comment">/* If maxmsg is zero, act as a &quot;greetings only&quot; voicemail: Exit successfully without recording */</span></div><div class="line"><a name="l06682"></a><span class="lineno"> 6682</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> == 0) {</div><div class="line"><a name="l06683"></a><span class="lineno"> 6683</span>&#160;      greeting_only = 1;</div><div class="line"><a name="l06684"></a><span class="lineno"> 6684</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);</div><div class="line"><a name="l06685"></a><span class="lineno"> 6685</span>&#160;   }</div><div class="line"><a name="l06686"></a><span class="lineno"> 6686</span>&#160;</div><div class="line"><a name="l06687"></a><span class="lineno"> 6687</span>&#160;   <span class="comment">/* Setup pre-file if appropriate */</span></div><div class="line"><a name="l06688"></a><span class="lineno"> 6688</span>&#160;   <span class="keywordflow">if</span> (strcmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, <span class="stringliteral">&quot;default&quot;</span>))</div><div class="line"><a name="l06689"></a><span class="lineno"> 6689</span>&#160;      snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, ext, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l06690"></a><span class="lineno"> 6690</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l06691"></a><span class="lineno"> 6691</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(ext_context, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="keyword">sizeof</span>(ext_context));</div><div class="line"><a name="l06692"></a><span class="lineno"> 6692</span>&#160;</div><div class="line"><a name="l06693"></a><span class="lineno"> 6693</span>&#160;   <span class="comment">/* Set the path to the prefile. Will be one of</span></div><div class="line"><a name="l06694"></a><span class="lineno"> 6694</span>&#160;<span class="comment">      VM_SPOOL_DIRcontext/ext/busy</span></div><div class="line"><a name="l06695"></a><span class="lineno"> 6695</span>&#160;<span class="comment">      VM_SPOOL_DIRcontext/ext/unavail</span></div><div class="line"><a name="l06696"></a><span class="lineno"> 6696</span>&#160;<span class="comment">      Depending on the flag set in options.</span></div><div class="line"><a name="l06697"></a><span class="lineno"> 6697</span>&#160;<span class="comment">   */</span></div><div class="line"><a name="l06698"></a><span class="lineno"> 6698</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a>)) {</div><div class="line"><a name="l06699"></a><span class="lineno"> 6699</span>&#160;      snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/busy&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext);</div><div class="line"><a name="l06700"></a><span class="lineno"> 6700</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a>)) {</div><div class="line"><a name="l06701"></a><span class="lineno"> 6701</span>&#160;      snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/unavail&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext);</div><div class="line"><a name="l06702"></a><span class="lineno"> 6702</span>&#160;   }</div><div class="line"><a name="l06703"></a><span class="lineno"> 6703</span>&#160;   <span class="comment">/* Set the path to the tmpfile as</span></div><div class="line"><a name="l06704"></a><span class="lineno"> 6704</span>&#160;<span class="comment">      VM_SPOOL_DIR/context/ext/temp</span></div><div class="line"><a name="l06705"></a><span class="lineno"> 6705</span>&#160;<span class="comment">      and attempt to create the folder structure.</span></div><div class="line"><a name="l06706"></a><span class="lineno"> 6706</span>&#160;<span class="comment">   */</span></div><div class="line"><a name="l06707"></a><span class="lineno"> 6707</span>&#160;   snprintf(tempfile, <span class="keyword">sizeof</span>(tempfile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext);</div><div class="line"><a name="l06708"></a><span class="lineno"> 6708</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(tmpdir, <span class="keyword">sizeof</span>(tmpdir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext, <span class="stringliteral">&quot;tmp&quot;</span>))) {</div><div class="line"><a name="l06709"></a><span class="lineno"> 6709</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to make directory (%s)\n&quot;</span>, tempfile);</div><div class="line"><a name="l06710"></a><span class="lineno"> 6710</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06711"></a><span class="lineno"> 6711</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06712"></a><span class="lineno"> 6712</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06713"></a><span class="lineno"> 6713</span>&#160;   }</div><div class="line"><a name="l06714"></a><span class="lineno"> 6714</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(tempfile, -1, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l06715"></a><span class="lineno"> 6715</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(tempfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0)</div><div class="line"><a name="l06716"></a><span class="lineno"> 6716</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(prefile, tempfile, <span class="keyword">sizeof</span>(prefile));</div><div class="line"><a name="l06717"></a><span class="lineno"> 6717</span>&#160;</div><div class="line"><a name="l06718"></a><span class="lineno"> 6718</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(tempfile, -1);</div><div class="line"><a name="l06719"></a><span class="lineno"> 6719</span>&#160;   <span class="comment">/* It&#39;s easier just to try to make it than to check for its existence */</span></div><div class="line"><a name="l06720"></a><span class="lineno"> 6720</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l06721"></a><span class="lineno"> 6721</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(dir, <span class="keyword">sizeof</span>(dir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext, <span class="stringliteral">&quot;INBOX&quot;</span>);</div><div class="line"><a name="l06722"></a><span class="lineno"> 6722</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l06723"></a><span class="lineno"> 6723</span>&#160;   snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%simap&quot;</span>, VM_SPOOL_DIR);</div><div class="line"><a name="l06724"></a><span class="lineno"> 6724</span>&#160;   <span class="keywordflow">if</span> (mkdir(dir, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">VOICEMAIL_DIR_MODE</a>) &amp;&amp; <a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EEXIST) {</div><div class="line"><a name="l06725"></a><span class="lineno"> 6725</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;mkdir &#39;%s&#39; failed: %s\n&quot;</span>, dir, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l06726"></a><span class="lineno"> 6726</span>&#160;   }</div><div class="line"><a name="l06727"></a><span class="lineno"> 6727</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06728"></a><span class="lineno"> 6728</span>&#160;</div><div class="line"><a name="l06729"></a><span class="lineno"> 6729</span>&#160;   <span class="comment">/* Check current or macro-calling context for special extensions */</span></div><div class="line"><a name="l06730"></a><span class="lineno"> 6730</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>)) {</div><div class="line"><a name="l06731"></a><span class="lineno"> 6731</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {</div><div class="line"><a name="l06732"></a><span class="lineno"> 6732</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="stringliteral">&quot;o&quot;</span>, 1,</div><div class="line"><a name="l06733"></a><span class="lineno"> 6733</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06734"></a><span class="lineno"> 6734</span>&#160;            strncat(ecodes, <span class="stringliteral">&quot;0&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06735"></a><span class="lineno"> 6735</span>&#160;            ouseexten = 1;</div><div class="line"><a name="l06736"></a><span class="lineno"> 6736</span>&#160;         }</div><div class="line"><a name="l06737"></a><span class="lineno"> 6737</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan), <span class="stringliteral">&quot;o&quot;</span>, 1,</div><div class="line"><a name="l06738"></a><span class="lineno"> 6738</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06739"></a><span class="lineno"> 6739</span>&#160;         strncat(ecodes, <span class="stringliteral">&quot;0&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06740"></a><span class="lineno"> 6740</span>&#160;         ouseexten = 1;</div><div class="line"><a name="l06741"></a><span class="lineno"> 6741</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan))</div><div class="line"><a name="l06742"></a><span class="lineno"> 6742</span>&#160;         &amp;&amp; <a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan), <span class="stringliteral">&quot;o&quot;</span>, 1,</div><div class="line"><a name="l06743"></a><span class="lineno"> 6743</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06744"></a><span class="lineno"> 6744</span>&#160;         strncat(ecodes, <span class="stringliteral">&quot;0&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06745"></a><span class="lineno"> 6745</span>&#160;         ousemacro = 1;</div><div class="line"><a name="l06746"></a><span class="lineno"> 6746</span>&#160;      }</div><div class="line"><a name="l06747"></a><span class="lineno"> 6747</span>&#160;   }</div><div class="line"><a name="l06748"></a><span class="lineno"> 6748</span>&#160;</div><div class="line"><a name="l06749"></a><span class="lineno"> 6749</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {</div><div class="line"><a name="l06750"></a><span class="lineno"> 6750</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="stringliteral">&quot;a&quot;</span>, 1,</div><div class="line"><a name="l06751"></a><span class="lineno"> 6751</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06752"></a><span class="lineno"> 6752</span>&#160;         strncat(ecodes, <span class="stringliteral">&quot;*&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06753"></a><span class="lineno"> 6753</span>&#160;      }</div><div class="line"><a name="l06754"></a><span class="lineno"> 6754</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan), <span class="stringliteral">&quot;a&quot;</span>, 1,</div><div class="line"><a name="l06755"></a><span class="lineno"> 6755</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06756"></a><span class="lineno"> 6756</span>&#160;      strncat(ecodes, <span class="stringliteral">&quot;*&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06757"></a><span class="lineno"> 6757</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan))</div><div class="line"><a name="l06758"></a><span class="lineno"> 6758</span>&#160;      &amp;&amp; <a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan), <span class="stringliteral">&quot;a&quot;</span>, 1,</div><div class="line"><a name="l06759"></a><span class="lineno"> 6759</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06760"></a><span class="lineno"> 6760</span>&#160;      strncat(ecodes, <span class="stringliteral">&quot;*&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06761"></a><span class="lineno"> 6761</span>&#160;      ausemacro = 1;</div><div class="line"><a name="l06762"></a><span class="lineno"> 6762</span>&#160;   }</div><div class="line"><a name="l06763"></a><span class="lineno"> 6763</span>&#160;</div><div class="line"><a name="l06764"></a><span class="lineno"> 6764</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>)) {</div><div class="line"><a name="l06765"></a><span class="lineno"> 6765</span>&#160;      <span class="keywordflow">for</span> (code = alldtmf; *code; code++) {</div><div class="line"><a name="l06766"></a><span class="lineno"> 6766</span>&#160;         <span class="keywordtype">char</span> e[2] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06767"></a><span class="lineno"> 6767</span>&#160;         e[0] = *code;</div><div class="line"><a name="l06768"></a><span class="lineno"> 6768</span>&#160;         <span class="keywordflow">if</span> (strchr(ecodes, e[0]) == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="line"><a name="l06769"></a><span class="lineno"> 6769</span>&#160;            &amp;&amp; <a class="code" href="../../db/de0/pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e">ast_canmatch_extension</a>(chan,</div><div class="line"><a name="l06770"></a><span class="lineno"> 6770</span>&#160;               (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a>) ? options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a> : <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan)),</div><div class="line"><a name="l06771"></a><span class="lineno"> 6771</span>&#160;               e, 1, <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l06772"></a><span class="lineno"> 6772</span>&#160;            strncat(ecodes, e, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);</div><div class="line"><a name="l06773"></a><span class="lineno"> 6773</span>&#160;         }</div><div class="line"><a name="l06774"></a><span class="lineno"> 6774</span>&#160;      }</div><div class="line"><a name="l06775"></a><span class="lineno"> 6775</span>&#160;   }</div><div class="line"><a name="l06776"></a><span class="lineno"> 6776</span>&#160;</div><div class="line"><a name="l06777"></a><span class="lineno"> 6777</span>&#160;   <span class="comment">/* Play the beginning intro if desired */</span></div><div class="line"><a name="l06778"></a><span class="lineno"> 6778</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(prefile)) {</div><div class="line"><a name="l06779"></a><span class="lineno"> 6779</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l06780"></a><span class="lineno"> 6780</span>&#160;      <span class="keywordtype">int</span> success =</div><div class="line"><a name="l06781"></a><span class="lineno"> 6781</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06782"></a><span class="lineno"> 6782</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, ext, context);</div><div class="line"><a name="l06783"></a><span class="lineno"> 6783</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l06784"></a><span class="lineno"> 6784</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, prefile, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan)) &gt; -1)</div><div class="line"><a name="l06785"></a><span class="lineno"> 6785</span>&#160;            res = <a class="code" href="../../d2/d4d/file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137">ast_waitstream</a>(chan, ecodes);</div><div class="line"><a name="l06786"></a><span class="lineno"> 6786</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l06787"></a><span class="lineno"> 6787</span>&#160;         <span class="keywordflow">if</span> (success == -1) {</div><div class="line"><a name="l06788"></a><span class="lineno"> 6788</span>&#160;            <span class="comment">/* We couldn&#39;t retrieve the file from the database, but we found it on the file system. Let&#39;s put it in the database. */</span></div><div class="line"><a name="l06789"></a><span class="lineno"> 6789</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Greeting not retrieved from database, but found in file storage. Inserting into database\n&quot;</span>);</div><div class="line"><a name="l06790"></a><span class="lineno"> 6790</span>&#160;            store_file(prefile, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06791"></a><span class="lineno"> 6791</span>&#160;         }</div><div class="line"><a name="l06792"></a><span class="lineno"> 6792</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06793"></a><span class="lineno"> 6793</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l06794"></a><span class="lineno"> 6794</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;%s doesn&#39;t exist, doing what we can\n&quot;</span>, prefile);</div><div class="line"><a name="l06795"></a><span class="lineno"> 6795</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456">invent_message</a>(chan, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext, <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a>), ecodes);</div><div class="line"><a name="l06796"></a><span class="lineno"> 6796</span>&#160;      }</div><div class="line"><a name="l06797"></a><span class="lineno"> 6797</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);</div><div class="line"><a name="l06798"></a><span class="lineno"> 6798</span>&#160;      <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line"><a name="l06799"></a><span class="lineno"> 6799</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Hang up during prefile playback\n&quot;</span>);</div><div class="line"><a name="l06800"></a><span class="lineno"> 6800</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06801"></a><span class="lineno"> 6801</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l06802"></a><span class="lineno"> 6802</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06803"></a><span class="lineno"> 6803</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06804"></a><span class="lineno"> 6804</span>&#160;      }</div><div class="line"><a name="l06805"></a><span class="lineno"> 6805</span>&#160;   }</div><div class="line"><a name="l06806"></a><span class="lineno"> 6806</span>&#160;   <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;#&#39;</span>) {</div><div class="line"><a name="l06807"></a><span class="lineno"> 6807</span>&#160;      <span class="comment">/* On a &#39;#&#39; we skip the instructions */</span></div><div class="line"><a name="l06808"></a><span class="lineno"> 6808</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);</div><div class="line"><a name="l06809"></a><span class="lineno"> 6809</span>&#160;      res = 0;</div><div class="line"><a name="l06810"></a><span class="lineno"> 6810</span>&#160;   }</div><div class="line"><a name="l06811"></a><span class="lineno"> 6811</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; !<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>)) {</div><div class="line"><a name="l06812"></a><span class="lineno"> 6812</span>&#160;      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">INTRO</a>, ecodes);</div><div class="line"><a name="l06813"></a><span class="lineno"> 6813</span>&#160;      <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;#&#39;</span>) {</div><div class="line"><a name="l06814"></a><span class="lineno"> 6814</span>&#160;         <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);</div><div class="line"><a name="l06815"></a><span class="lineno"> 6815</span>&#160;         res = 0;</div><div class="line"><a name="l06816"></a><span class="lineno"> 6816</span>&#160;      }</div><div class="line"><a name="l06817"></a><span class="lineno"> 6817</span>&#160;   }</div><div class="line"><a name="l06818"></a><span class="lineno"> 6818</span>&#160;   <span class="keywordflow">if</span> (res &gt; 0)</div><div class="line"><a name="l06819"></a><span class="lineno"> 6819</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line"><a name="l06820"></a><span class="lineno"> 6820</span>&#160;   <span class="comment">/* Check for a &#39;*&#39; here in case the caller wants to escape from voicemail to something</span></div><div class="line"><a name="l06821"></a><span class="lineno"> 6821</span>&#160;<span class="comment">    other than the operator -- an automated attendant or mailbox login for example */</span></div><div class="line"><a name="l06822"></a><span class="lineno"> 6822</span>&#160;   <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l06823"></a><span class="lineno"> 6823</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#a018b7a29cef2d62074dc46e9aaad0d1a">ast_channel_exten_set</a>(chan, <span class="stringliteral">&quot;a&quot;</span>);</div><div class="line"><a name="l06824"></a><span class="lineno"> 6824</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {</div><div class="line"><a name="l06825"></a><span class="lineno"> 6825</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>);</div><div class="line"><a name="l06826"></a><span class="lineno"> 6826</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ausemacro &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan))) {</div><div class="line"><a name="l06827"></a><span class="lineno"> 6827</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan));</div><div class="line"><a name="l06828"></a><span class="lineno"> 6828</span>&#160;      }</div><div class="line"><a name="l06829"></a><span class="lineno"> 6829</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#ae56cab679c0cda6436b930bc74297895">ast_channel_priority_set</a>(chan, 0);</div><div class="line"><a name="l06830"></a><span class="lineno"> 6830</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06831"></a><span class="lineno"> 6831</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;USEREXIT&quot;</span>);</div><div class="line"><a name="l06832"></a><span class="lineno"> 6832</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06833"></a><span class="lineno"> 6833</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l06834"></a><span class="lineno"> 6834</span>&#160;   }</div><div class="line"><a name="l06835"></a><span class="lineno"> 6835</span>&#160;</div><div class="line"><a name="l06836"></a><span class="lineno"> 6836</span>&#160;   <span class="comment">/* Check for a &#39;0&#39; here */</span></div><div class="line"><a name="l06837"></a><span class="lineno"> 6837</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>) &amp;&amp; res == <span class="charliteral">&#39;0&#39;</span>) {</div><div class="line"><a name="l06838"></a><span class="lineno"> 6838</span>&#160;   <a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>:</div><div class="line"><a name="l06839"></a><span class="lineno"> 6839</span>&#160;      <span class="keywordflow">if</span> (ouseexten || ousemacro) {</div><div class="line"><a name="l06840"></a><span class="lineno"> 6840</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#a018b7a29cef2d62074dc46e9aaad0d1a">ast_channel_exten_set</a>(chan, <span class="stringliteral">&quot;o&quot;</span>);</div><div class="line"><a name="l06841"></a><span class="lineno"> 6841</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {</div><div class="line"><a name="l06842"></a><span class="lineno"> 6842</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>);</div><div class="line"><a name="l06843"></a><span class="lineno"> 6843</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ousemacro &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan))) {</div><div class="line"><a name="l06844"></a><span class="lineno"> 6844</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan));</div><div class="line"><a name="l06845"></a><span class="lineno"> 6845</span>&#160;         }</div><div class="line"><a name="l06846"></a><span class="lineno"> 6846</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;transfer&quot;</span>);</div><div class="line"><a name="l06847"></a><span class="lineno"> 6847</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#ae56cab679c0cda6436b930bc74297895">ast_channel_priority_set</a>(chan, 0);</div><div class="line"><a name="l06848"></a><span class="lineno"> 6848</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;USEREXIT&quot;</span>);</div><div class="line"><a name="l06849"></a><span class="lineno"> 6849</span>&#160;      }</div><div class="line"><a name="l06850"></a><span class="lineno"> 6850</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06851"></a><span class="lineno"> 6851</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06852"></a><span class="lineno"> 6852</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a>;</div><div class="line"><a name="l06853"></a><span class="lineno"> 6853</span>&#160;   }</div><div class="line"><a name="l06854"></a><span class="lineno"> 6854</span>&#160;</div><div class="line"><a name="l06855"></a><span class="lineno"> 6855</span>&#160;   <span class="comment">/* Allow all other digits to exit Voicemail and return to the dialplan */</span></div><div class="line"><a name="l06856"></a><span class="lineno"> 6856</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>) &amp;&amp; res &gt; 0) {</div><div class="line"><a name="l06857"></a><span class="lineno"> 6857</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a>)) {</div><div class="line"><a name="l06858"></a><span class="lineno"> 6858</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a>);</div><div class="line"><a name="l06859"></a><span class="lineno"> 6859</span>&#160;      }</div><div class="line"><a name="l06860"></a><span class="lineno"> 6860</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06861"></a><span class="lineno"> 6861</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06862"></a><span class="lineno"> 6862</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;USEREXIT&quot;</span>);</div><div class="line"><a name="l06863"></a><span class="lineno"> 6863</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l06864"></a><span class="lineno"> 6864</span>&#160;   }</div><div class="line"><a name="l06865"></a><span class="lineno"> 6865</span>&#160;</div><div class="line"><a name="l06866"></a><span class="lineno"> 6866</span>&#160;   <span class="keywordflow">if</span> (greeting_only) {</div><div class="line"><a name="l06867"></a><span class="lineno"> 6867</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Greetings only VM (maxmsg=0), Skipping voicemail recording\n&quot;</span>);</div><div class="line"><a name="l06868"></a><span class="lineno"> 6868</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);</div><div class="line"><a name="l06869"></a><span class="lineno"> 6869</span>&#160;      res = 0;</div><div class="line"><a name="l06870"></a><span class="lineno"> 6870</span>&#160;      <span class="keywordflow">goto</span> leave_vm_out;</div><div class="line"><a name="l06871"></a><span class="lineno"> 6871</span>&#160;   }</div><div class="line"><a name="l06872"></a><span class="lineno"> 6872</span>&#160;</div><div class="line"><a name="l06873"></a><span class="lineno"> 6873</span>&#160;   <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line"><a name="l06874"></a><span class="lineno"> 6874</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06875"></a><span class="lineno"> 6875</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l06876"></a><span class="lineno"> 6876</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06877"></a><span class="lineno"> 6877</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06878"></a><span class="lineno"> 6878</span>&#160;   }</div><div class="line"><a name="l06879"></a><span class="lineno"> 6879</span>&#160;   <span class="comment">/* The meat of recording the message...  All the announcements and beeps have been played*/</span></div><div class="line"><a name="l06880"></a><span class="lineno"> 6880</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660">ast_channel_state</a>(chan) != <a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {</div><div class="line"><a name="l06881"></a><span class="lineno"> 6881</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#aec583a3e25358ee552a4f3df53914cd0">ast_answer</a>(chan);</div><div class="line"><a name="l06882"></a><span class="lineno"> 6882</span>&#160;   }</div><div class="line"><a name="l06883"></a><span class="lineno"> 6883</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fmt, vmfmts, <span class="keyword">sizeof</span>(fmt));</div><div class="line"><a name="l06884"></a><span class="lineno"> 6884</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(fmt)) {</div><div class="line"><a name="l06885"></a><span class="lineno"> 6885</span>&#160;      <span class="keywordtype">char</span> msg_id[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l06886"></a><span class="lineno"> 6886</span>&#160;      msgnum = 0;</div><div class="line"><a name="l06887"></a><span class="lineno"> 6887</span>&#160;</div><div class="line"><a name="l06888"></a><span class="lineno"> 6888</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l06889"></a><span class="lineno"> 6889</span>&#160;      <span class="comment">/* Is ext a mailbox? */</span></div><div class="line"><a name="l06890"></a><span class="lineno"> 6890</span>&#160;      <span class="comment">/* must open stream for this user to get info! */</span></div><div class="line"><a name="l06891"></a><span class="lineno"> 6891</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(ext_context, &amp;newmsgs, &amp;oldmsgs);</div><div class="line"><a name="l06892"></a><span class="lineno"> 6892</span>&#160;      <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line"><a name="l06893"></a><span class="lineno"> 6893</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Can not leave voicemail, unable to count messages\n&quot;</span>);</div><div class="line"><a name="l06894"></a><span class="lineno"> 6894</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06895"></a><span class="lineno"> 6895</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06896"></a><span class="lineno"> 6896</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06897"></a><span class="lineno"> 6897</span>&#160;      }</div><div class="line"><a name="l06898"></a><span class="lineno"> 6898</span>&#160;      <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(ext, context, 0))) {</div><div class="line"><a name="l06899"></a><span class="lineno"> 6899</span>&#160;      <span class="comment">/* It is possible under certain circumstances that inboxcount did not</span></div><div class="line"><a name="l06900"></a><span class="lineno"> 6900</span>&#160;<span class="comment">       * create a vm_state when it was needed. This is a catchall which will</span></div><div class="line"><a name="l06901"></a><span class="lineno"> 6901</span>&#160;<span class="comment">       * rarely be used.</span></div><div class="line"><a name="l06902"></a><span class="lineno"> 6902</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l06903"></a><span class="lineno"> 6903</span>&#160;         <span class="keywordflow">if</span> (!(vms = create_vm_state_from_user(vmu))) {</div><div class="line"><a name="l06904"></a><span class="lineno"> 6904</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t allocate necessary space\n&quot;</span>);</div><div class="line"><a name="l06905"></a><span class="lineno"> 6905</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l06906"></a><span class="lineno"> 6906</span>&#160;            <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l06907"></a><span class="lineno"> 6907</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l06908"></a><span class="lineno"> 6908</span>&#160;         }</div><div class="line"><a name="l06909"></a><span class="lineno"> 6909</span>&#160;      }</div><div class="line"><a name="l06910"></a><span class="lineno"> 6910</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>++;</div><div class="line"><a name="l06911"></a><span class="lineno"> 6911</span>&#160;</div><div class="line"><a name="l06912"></a><span class="lineno"> 6912</span>&#160;      <span class="comment">/* here is a big difference! We add one to it later */</span></div><div class="line"><a name="l06913"></a><span class="lineno"> 6913</span>&#160;      msgnum = newmsgs + oldmsgs;</div><div class="line"><a name="l06914"></a><span class="lineno"> 6914</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Messagecount set to %d\n&quot;</span>, msgnum);</div><div class="line"><a name="l06915"></a><span class="lineno"> 6915</span>&#160;      snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%simap/msg%s%04d&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, msgnum);</div><div class="line"><a name="l06916"></a><span class="lineno"> 6916</span>&#160;      <span class="comment">/* set variable for compatibility */</span></div><div class="line"><a name="l06917"></a><span class="lineno"> 6917</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VM_MESSAGEFILE&quot;</span>, <span class="stringliteral">&quot;IMAP_STORAGE&quot;</span>);</div><div class="line"><a name="l06918"></a><span class="lineno"> 6918</span>&#160;</div><div class="line"><a name="l06919"></a><span class="lineno"> 6919</span>&#160;      <span class="keywordflow">if</span> ((res = imap_check_limits(chan, vms, vmu, msgnum))) {</div><div class="line"><a name="l06920"></a><span class="lineno"> 6920</span>&#160;         <span class="keywordflow">goto</span> leave_vm_out;</div><div class="line"><a name="l06921"></a><span class="lineno"> 6921</span>&#160;      }</div><div class="line"><a name="l06922"></a><span class="lineno"> 6922</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l06923"></a><span class="lineno"> 6923</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a>(vmu, dir) &gt;= vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> - <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, +1)) {</div><div class="line"><a name="l06924"></a><span class="lineno"> 6924</span>&#160;         res = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l06925"></a><span class="lineno"> 6925</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l06926"></a><span class="lineno"> 6926</span>&#160;            res = <a class="code" href="../../d2/d4d/file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l06927"></a><span class="lineno"> 6927</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No more messages possible\n&quot;</span>);</div><div class="line"><a name="l06928"></a><span class="lineno"> 6928</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l06929"></a><span class="lineno"> 6929</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06930"></a><span class="lineno"> 6930</span>&#160;         <span class="keywordflow">goto</span> leave_vm_out;</div><div class="line"><a name="l06931"></a><span class="lineno"> 6931</span>&#160;      }</div><div class="line"><a name="l06932"></a><span class="lineno"> 6932</span>&#160;</div><div class="line"><a name="l06933"></a><span class="lineno"> 6933</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l06934"></a><span class="lineno"> 6934</span>&#160;      snprintf(tmptxtfile, <span class="keyword">sizeof</span>(tmptxtfile), <span class="stringliteral">&quot;%s/XXXXXX&quot;</span>, tmpdir);</div><div class="line"><a name="l06935"></a><span class="lineno"> 6935</span>&#160;      txtdes = mkstemp(tmptxtfile);</div><div class="line"><a name="l06936"></a><span class="lineno"> 6936</span>&#160;      chmod(tmptxtfile, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a> &amp; ~my_umask);</div><div class="line"><a name="l06937"></a><span class="lineno"> 6937</span>&#160;      <span class="keywordflow">if</span> (txtdes &lt; 0) {</div><div class="line"><a name="l06938"></a><span class="lineno"> 6938</span>&#160;         res = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l06939"></a><span class="lineno"> 6939</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l06940"></a><span class="lineno"> 6940</span>&#160;            res = <a class="code" href="../../d2/d4d/file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l06941"></a><span class="lineno"> 6941</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create message file: %s\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l06942"></a><span class="lineno"> 6942</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l06943"></a><span class="lineno"> 6943</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l06944"></a><span class="lineno"> 6944</span>&#160;         <span class="keywordflow">goto</span> leave_vm_out;</div><div class="line"><a name="l06945"></a><span class="lineno"> 6945</span>&#160;      }</div><div class="line"><a name="l06946"></a><span class="lineno"> 6946</span>&#160;</div><div class="line"><a name="l06947"></a><span class="lineno"> 6947</span>&#160;      <span class="comment">/* Now play the beep once we have the message number for our next message. */</span></div><div class="line"><a name="l06948"></a><span class="lineno"> 6948</span>&#160;      <span class="keywordflow">if</span> (res &gt;= 0) {</div><div class="line"><a name="l06949"></a><span class="lineno"> 6949</span>&#160;         <span class="comment">/* Unless we&#39;re *really* silent, try to send the beep */</span></div><div class="line"><a name="l06950"></a><span class="lineno"> 6950</span>&#160;         <span class="comment">/* Play default or custom beep, unless no beep desired */</span></div><div class="line"><a name="l06951"></a><span class="lineno"> 6951</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a>)) {</div><div class="line"><a name="l06952"></a><span class="lineno"> 6952</span>&#160;            res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l06953"></a><span class="lineno"> 6953</span>&#160;         }</div><div class="line"><a name="l06954"></a><span class="lineno"> 6954</span>&#160;      }</div><div class="line"><a name="l06955"></a><span class="lineno"> 6955</span>&#160;</div><div class="line"><a name="l06956"></a><span class="lineno"> 6956</span>&#160;      <span class="comment">/* Store information in real-time storage */</span></div><div class="line"><a name="l06957"></a><span class="lineno"> 6957</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l06958"></a><span class="lineno"> 6958</span>&#160;         snprintf(priority, <span class="keyword">sizeof</span>(priority), <span class="stringliteral">&quot;%d&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a>(chan));</div><div class="line"><a name="l06959"></a><span class="lineno"> 6959</span>&#160;         snprintf(origtime, <span class="keyword">sizeof</span>(origtime), <span class="stringliteral">&quot;%ld&quot;</span>, (<span class="keywordtype">long</span>) time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div><div class="line"><a name="l06960"></a><span class="lineno"> 6960</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">get_date</a>(date, <span class="keyword">sizeof</span>(date));</div><div class="line"><a name="l06961"></a><span class="lineno"> 6961</span>&#160;         <a class="code" href="../../de/d47/callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(callerid, <span class="keyword">sizeof</span>(callerid),</div><div class="line"><a name="l06962"></a><span class="lineno"> 6962</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06963"></a><span class="lineno"> 6963</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06964"></a><span class="lineno"> 6964</span>&#160;            <span class="stringliteral">&quot;Unknown&quot;</span>);</div><div class="line"><a name="l06965"></a><span class="lineno"> 6965</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2">ast_store_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>,</div><div class="line"><a name="l06966"></a><span class="lineno"> 6966</span>&#160;            <span class="stringliteral">&quot;origmailbox&quot;</span>, ext,</div><div class="line"><a name="l06967"></a><span class="lineno"> 6967</span>&#160;            <span class="stringliteral">&quot;context&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan),</div><div class="line"><a name="l06968"></a><span class="lineno"> 6968</span>&#160;            <span class="stringliteral">&quot;macrocontext&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan),</div><div class="line"><a name="l06969"></a><span class="lineno"> 6969</span>&#160;            <span class="stringliteral">&quot;exten&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(chan),</div><div class="line"><a name="l06970"></a><span class="lineno"> 6970</span>&#160;            <span class="stringliteral">&quot;priority&quot;</span>, priority,</div><div class="line"><a name="l06971"></a><span class="lineno"> 6971</span>&#160;            <span class="stringliteral">&quot;callerchan&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan),</div><div class="line"><a name="l06972"></a><span class="lineno"> 6972</span>&#160;            <span class="stringliteral">&quot;callerid&quot;</span>, callerid,</div><div class="line"><a name="l06973"></a><span class="lineno"> 6973</span>&#160;            <span class="stringliteral">&quot;origdate&quot;</span>, date,</div><div class="line"><a name="l06974"></a><span class="lineno"> 6974</span>&#160;            <span class="stringliteral">&quot;origtime&quot;</span>, origtime,</div><div class="line"><a name="l06975"></a><span class="lineno"> 6975</span>&#160;            <span class="stringliteral">&quot;category&quot;</span>, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(category, <span class="stringliteral">&quot;&quot;</span>),</div><div class="line"><a name="l06976"></a><span class="lineno"> 6976</span>&#160;            <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile,</div><div class="line"><a name="l06977"></a><span class="lineno"> 6977</span>&#160;            <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l06978"></a><span class="lineno"> 6978</span>&#160;      }</div><div class="line"><a name="l06979"></a><span class="lineno"> 6979</span>&#160;</div><div class="line"><a name="l06980"></a><span class="lineno"> 6980</span>&#160;      <span class="comment">/* Store information */</span></div><div class="line"><a name="l06981"></a><span class="lineno"> 6981</span>&#160;      txt = fdopen(txtdes, <span class="stringliteral">&quot;w+&quot;</span>);</div><div class="line"><a name="l06982"></a><span class="lineno"> 6982</span>&#160;      <span class="keywordflow">if</span> (txt) {</div><div class="line"><a name="l06983"></a><span class="lineno"> 6983</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(msg_id);</div><div class="line"><a name="l06984"></a><span class="lineno"> 6984</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">get_date</a>(date, <span class="keyword">sizeof</span>(date));</div><div class="line"><a name="l06985"></a><span class="lineno"> 6985</span>&#160;         <a class="code" href="../../de/d47/callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(callerid, <span class="keyword">sizeof</span>(callerid),</div><div class="line"><a name="l06986"></a><span class="lineno"> 6986</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06987"></a><span class="lineno"> 6987</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l06988"></a><span class="lineno"> 6988</span>&#160;            <span class="stringliteral">&quot;Unknown&quot;</span>);</div><div class="line"><a name="l06989"></a><span class="lineno"> 6989</span>&#160;         fprintf(txt,</div><div class="line"><a name="l06990"></a><span class="lineno"> 6990</span>&#160;            <span class="stringliteral">&quot;;\n&quot;</span></div><div class="line"><a name="l06991"></a><span class="lineno"> 6991</span>&#160;            <span class="stringliteral">&quot;; Message Information file\n&quot;</span></div><div class="line"><a name="l06992"></a><span class="lineno"> 6992</span>&#160;            <span class="stringliteral">&quot;;\n&quot;</span></div><div class="line"><a name="l06993"></a><span class="lineno"> 6993</span>&#160;            <span class="stringliteral">&quot;[message]\n&quot;</span></div><div class="line"><a name="l06994"></a><span class="lineno"> 6994</span>&#160;            <span class="stringliteral">&quot;origmailbox=%s\n&quot;</span></div><div class="line"><a name="l06995"></a><span class="lineno"> 6995</span>&#160;            <span class="stringliteral">&quot;context=%s\n&quot;</span></div><div class="line"><a name="l06996"></a><span class="lineno"> 6996</span>&#160;            <span class="stringliteral">&quot;macrocontext=%s\n&quot;</span></div><div class="line"><a name="l06997"></a><span class="lineno"> 6997</span>&#160;            <span class="stringliteral">&quot;exten=%s\n&quot;</span></div><div class="line"><a name="l06998"></a><span class="lineno"> 6998</span>&#160;            <span class="stringliteral">&quot;rdnis=%s\n&quot;</span></div><div class="line"><a name="l06999"></a><span class="lineno"> 6999</span>&#160;            <span class="stringliteral">&quot;priority=%d\n&quot;</span></div><div class="line"><a name="l07000"></a><span class="lineno"> 7000</span>&#160;            <span class="stringliteral">&quot;callerchan=%s\n&quot;</span></div><div class="line"><a name="l07001"></a><span class="lineno"> 7001</span>&#160;            <span class="stringliteral">&quot;callerid=%s\n&quot;</span></div><div class="line"><a name="l07002"></a><span class="lineno"> 7002</span>&#160;            <span class="stringliteral">&quot;origdate=%s\n&quot;</span></div><div class="line"><a name="l07003"></a><span class="lineno"> 7003</span>&#160;            <span class="stringliteral">&quot;origtime=%ld\n&quot;</span></div><div class="line"><a name="l07004"></a><span class="lineno"> 7004</span>&#160;            <span class="stringliteral">&quot;category=%s\n&quot;</span></div><div class="line"><a name="l07005"></a><span class="lineno"> 7005</span>&#160;            <span class="stringliteral">&quot;msg_id=%s\n&quot;</span>,</div><div class="line"><a name="l07006"></a><span class="lineno"> 7006</span>&#160;            ext,</div><div class="line"><a name="l07007"></a><span class="lineno"> 7007</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan),</div><div class="line"><a name="l07008"></a><span class="lineno"> 7008</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a>(chan),</div><div class="line"><a name="l07009"></a><span class="lineno"> 7009</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(chan),</div><div class="line"><a name="l07010"></a><span class="lineno"> 7010</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ad2334e69c466aec25ba3cbba53b7201b">ast_channel_redirecting</a>(chan)-&gt;from.number.valid,</div><div class="line"><a name="l07011"></a><span class="lineno"> 7011</span>&#160;               <a class="code" href="../../d5/d7b/channel_8h.html#ad2334e69c466aec25ba3cbba53b7201b">ast_channel_redirecting</a>(chan)-&gt;from.number.str, <span class="stringliteral">&quot;unknown&quot;</span>),</div><div class="line"><a name="l07012"></a><span class="lineno"> 7012</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a>(chan),</div><div class="line"><a name="l07013"></a><span class="lineno"> 7013</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan),</div><div class="line"><a name="l07014"></a><span class="lineno"> 7014</span>&#160;            callerid,</div><div class="line"><a name="l07015"></a><span class="lineno"> 7015</span>&#160;            date, (<span class="keywordtype">long</span>) time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l07016"></a><span class="lineno"> 7016</span>&#160;            category ? category : <span class="stringliteral">&quot;&quot;</span>,</div><div class="line"><a name="l07017"></a><span class="lineno"> 7017</span>&#160;            msg_id);</div><div class="line"><a name="l07018"></a><span class="lineno"> 7018</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07019"></a><span class="lineno"> 7019</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Error opening text file for output\n&quot;</span>);</div><div class="line"><a name="l07020"></a><span class="lineno"> 7020</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l07021"></a><span class="lineno"> 7021</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l07022"></a><span class="lineno"> 7022</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l07023"></a><span class="lineno"> 7023</span>&#160;         }</div><div class="line"><a name="l07024"></a><span class="lineno"> 7024</span>&#160;         res = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l07025"></a><span class="lineno"> 7025</span>&#160;         <span class="keywordflow">goto</span> leave_vm_out;</div><div class="line"><a name="l07026"></a><span class="lineno"> 7026</span>&#160;      }</div><div class="line"><a name="l07027"></a><span class="lineno"> 7027</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tmptxtfile, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>, fmt, 1, vmu, &amp;duration, &amp;sound_duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, options-&gt;<a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a>, vms, flag, msg_id, 0);</div><div class="line"><a name="l07028"></a><span class="lineno"> 7028</span>&#160;</div><div class="line"><a name="l07029"></a><span class="lineno"> 7029</span>&#160;      <span class="comment">/* At this point, either we were instructed to make the message Urgent</span></div><div class="line"><a name="l07030"></a><span class="lineno"> 7030</span>&#160;<span class="comment">         by arguments to VoiceMail or during the review process by the person</span></div><div class="line"><a name="l07031"></a><span class="lineno"> 7031</span>&#160;<span class="comment">         leaving the message. So we update the directory where we want this</span></div><div class="line"><a name="l07032"></a><span class="lineno"> 7032</span>&#160;<span class="comment">         message to go. */</span></div><div class="line"><a name="l07033"></a><span class="lineno"> 7033</span>&#160;      <span class="keywordflow">if</span> (!strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) {</div><div class="line"><a name="l07034"></a><span class="lineno"> 7034</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(dir, <span class="keyword">sizeof</span>(dir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ext, <span class="stringliteral">&quot;Urgent&quot;</span>);</div><div class="line"><a name="l07035"></a><span class="lineno"> 7035</span>&#160;      }</div><div class="line"><a name="l07036"></a><span class="lineno"> 7036</span>&#160;</div><div class="line"><a name="l07037"></a><span class="lineno"> 7037</span>&#160;      <span class="keywordflow">if</span> (txt) {</div><div class="line"><a name="l07038"></a><span class="lineno"> 7038</span>&#160;         fprintf(txt, <span class="stringliteral">&quot;flag=%s\n&quot;</span>, flag);</div><div class="line"><a name="l07039"></a><span class="lineno"> 7039</span>&#160;         <span class="keywordflow">if</span> (sound_duration &lt; vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a>) {</div><div class="line"><a name="l07040"></a><span class="lineno"> 7040</span>&#160;            fclose(txt);</div><div class="line"><a name="l07041"></a><span class="lineno"> 7041</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Recording was %d seconds long but needs to be at least %d - abandoning\n&quot;</span>, sound_duration, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a>);</div><div class="line"><a name="l07042"></a><span class="lineno"> 7042</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tmptxtfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l07043"></a><span class="lineno"> 7043</span>&#160;            unlink(tmptxtfile);</div><div class="line"><a name="l07044"></a><span class="lineno"> 7044</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l07045"></a><span class="lineno"> 7045</span>&#160;               <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l07046"></a><span class="lineno"> 7046</span>&#160;            }</div><div class="line"><a name="l07047"></a><span class="lineno"> 7047</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l07048"></a><span class="lineno"> 7048</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07049"></a><span class="lineno"> 7049</span>&#160;            fprintf(txt, <span class="stringliteral">&quot;duration=%d\n&quot;</span>, duration);</div><div class="line"><a name="l07050"></a><span class="lineno"> 7050</span>&#160;            fclose(txt);</div><div class="line"><a name="l07051"></a><span class="lineno"> 7051</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(dir)) {</div><div class="line"><a name="l07052"></a><span class="lineno"> 7052</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t lock directory %s.  Voicemail will be lost.\n&quot;</span>, dir);</div><div class="line"><a name="l07053"></a><span class="lineno"> 7053</span>&#160;               <span class="comment">/* Delete files */</span></div><div class="line"><a name="l07054"></a><span class="lineno"> 7054</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tmptxtfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l07055"></a><span class="lineno"> 7055</span>&#160;               unlink(tmptxtfile);</div><div class="line"><a name="l07056"></a><span class="lineno"> 7056</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l07057"></a><span class="lineno"> 7057</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(tmptxtfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &lt;= 0) {</div><div class="line"><a name="l07058"></a><span class="lineno"> 7058</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;The recorded media file is gone, so we should remove the .txt file too!\n&quot;</span>);</div><div class="line"><a name="l07059"></a><span class="lineno"> 7059</span>&#160;               unlink(tmptxtfile);</div><div class="line"><a name="l07060"></a><span class="lineno"> 7060</span>&#160;               <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l07061"></a><span class="lineno"> 7061</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l07062"></a><span class="lineno"> 7062</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l07063"></a><span class="lineno"> 7063</span>&#160;                  <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l07064"></a><span class="lineno"> 7064</span>&#160;               }</div><div class="line"><a name="l07065"></a><span class="lineno"> 7065</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07066"></a><span class="lineno"> 7066</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l07067"></a><span class="lineno"> 7067</span>&#160;               msgnum = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(vmu, dir) + 1;</div><div class="line"><a name="l07068"></a><span class="lineno"> 7068</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07069"></a><span class="lineno"> 7069</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);</div><div class="line"><a name="l07070"></a><span class="lineno"> 7070</span>&#160;</div><div class="line"><a name="l07071"></a><span class="lineno"> 7071</span>&#160;               <span class="comment">/* assign a variable with the name of the voicemail file */</span></div><div class="line"><a name="l07072"></a><span class="lineno"> 7072</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l07073"></a><span class="lineno"> 7073</span>&#160;               <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VM_MESSAGEFILE&quot;</span>, fn);</div><div class="line"><a name="l07074"></a><span class="lineno"> 7074</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l07075"></a><span class="lineno"> 7075</span>&#160;               <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VM_MESSAGEFILE&quot;</span>, <span class="stringliteral">&quot;IMAP_STORAGE&quot;</span>);</div><div class="line"><a name="l07076"></a><span class="lineno"> 7076</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07077"></a><span class="lineno"> 7077</span>&#160;</div><div class="line"><a name="l07078"></a><span class="lineno"> 7078</span>&#160;               snprintf(txtfile, <span class="keyword">sizeof</span>(txtfile), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);</div><div class="line"><a name="l07079"></a><span class="lineno"> 7079</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(tmptxtfile, fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l07080"></a><span class="lineno"> 7080</span>&#160;               rename(tmptxtfile, txtfile);</div><div class="line"><a name="l07081"></a><span class="lineno"> 7081</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l07082"></a><span class="lineno"> 7082</span>&#160;</div><div class="line"><a name="l07083"></a><span class="lineno"> 7083</span>&#160;               <span class="comment">/* Properly set permissions on voicemail text descriptor file.</span></div><div class="line"><a name="l07084"></a><span class="lineno"> 7084</span>&#160;<span class="comment">                  Unfortunately mkstemp() makes this file 0600 on most unix systems. */</span></div><div class="line"><a name="l07085"></a><span class="lineno"> 7085</span>&#160;               <span class="keywordflow">if</span> (chmod(txtfile, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>) &lt; 0)</div><div class="line"><a name="l07086"></a><span class="lineno"> 7086</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t set permissions on voicemail text file %s: %s&quot;</span>, txtfile, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l07087"></a><span class="lineno"> 7087</span>&#160;</div><div class="line"><a name="l07088"></a><span class="lineno"> 7088</span>&#160;               <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l07089"></a><span class="lineno"> 7089</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l07090"></a><span class="lineno"> 7090</span>&#160;                  snprintf(tmpdur, <span class="keyword">sizeof</span>(tmpdur), <span class="stringliteral">&quot;%d&quot;</span>, duration);</div><div class="line"><a name="l07091"></a><span class="lineno"> 7091</span>&#160;                  <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#ab845019b2f1bb324ff57e14192d62c39">ast_update_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <span class="stringliteral">&quot;filename&quot;</span>, fn, <span class="stringliteral">&quot;duration&quot;</span>, tmpdur, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l07092"></a><span class="lineno"> 7092</span>&#160;               }</div><div class="line"><a name="l07093"></a><span class="lineno"> 7093</span>&#160;               <span class="comment">/* We must store the file first, before copying the message, because</span></div><div class="line"><a name="l07094"></a><span class="lineno"> 7094</span>&#160;<span class="comment">                * ODBC storage does the entire copy with SQL.</span></div><div class="line"><a name="l07095"></a><span class="lineno"> 7095</span>&#160;<span class="comment">                */</span></div><div class="line"><a name="l07096"></a><span class="lineno"> 7096</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l07097"></a><span class="lineno"> 7097</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a>(dir, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, msgnum, chan, vmu, fmt, duration, vms, flag, msg_id);</div><div class="line"><a name="l07098"></a><span class="lineno"> 7098</span>&#160;               }</div><div class="line"><a name="l07099"></a><span class="lineno"> 7099</span>&#160;</div><div class="line"><a name="l07100"></a><span class="lineno"> 7100</span>&#160;               <span class="comment">/* Are there to be more recipients of this message? */</span></div><div class="line"><a name="l07101"></a><span class="lineno"> 7101</span>&#160;               <span class="keywordflow">while</span> (tmpptr) {</div><div class="line"><a name="l07102"></a><span class="lineno"> 7102</span>&#160;                  <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> recipu, *recip;</div><div class="line"><a name="l07103"></a><span class="lineno"> 7103</span>&#160;                  <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, *cntx;</div><div class="line"><a name="l07104"></a><span class="lineno"> 7104</span>&#160;</div><div class="line"><a name="l07105"></a><span class="lineno"> 7105</span>&#160;                  exten = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmpptr, <span class="stringliteral">&quot;&amp;&quot;</span>);</div><div class="line"><a name="l07106"></a><span class="lineno"> 7106</span>&#160;                  cntx = strchr(exten, <span class="charliteral">&#39;@&#39;</span>);</div><div class="line"><a name="l07107"></a><span class="lineno"> 7107</span>&#160;                  <span class="keywordflow">if</span> (cntx) {</div><div class="line"><a name="l07108"></a><span class="lineno"> 7108</span>&#160;                     *cntx = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l07109"></a><span class="lineno"> 7109</span>&#160;                     cntx++;</div><div class="line"><a name="l07110"></a><span class="lineno"> 7110</span>&#160;                  }</div><div class="line"><a name="l07111"></a><span class="lineno"> 7111</span>&#160;                  memset(&amp;recipu, 0, <span class="keyword">sizeof</span>(recipu));</div><div class="line"><a name="l07112"></a><span class="lineno"> 7112</span>&#160;                  <span class="keywordflow">if</span> ((recip = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;recipu, cntx, exten))) {</div><div class="line"><a name="l07113"></a><span class="lineno"> 7113</span>&#160;                     <a class="code" href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039">copy_message</a>(chan, vmu, 0, msgnum, duration, recip, fmt, dir, flag, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l07114"></a><span class="lineno"> 7114</span>&#160;                     <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recip);</div><div class="line"><a name="l07115"></a><span class="lineno"> 7115</span>&#160;                  }</div><div class="line"><a name="l07116"></a><span class="lineno"> 7116</span>&#160;               }</div><div class="line"><a name="l07117"></a><span class="lineno"> 7117</span>&#160;</div><div class="line"><a name="l07118"></a><span class="lineno"> 7118</span>&#160;               <span class="comment">/* Notification needs to happen after the copy, though. */</span></div><div class="line"><a name="l07119"></a><span class="lineno"> 7119</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l07120"></a><span class="lineno"> 7120</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07121"></a><span class="lineno"> 7121</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">notify_new_message</a>(chan, vmu, vms, msgnum, duration, fmt,</div><div class="line"><a name="l07122"></a><span class="lineno"> 7122</span>&#160;                     <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l07123"></a><span class="lineno"> 7123</span>&#160;                     <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l07124"></a><span class="lineno"> 7124</span>&#160;                     flag);</div><div class="line"><a name="l07125"></a><span class="lineno"> 7125</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l07126"></a><span class="lineno"> 7126</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">notify_new_message</a>(chan, vmu, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, msgnum, duration, fmt,</div><div class="line"><a name="l07127"></a><span class="lineno"> 7127</span>&#160;                     <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l07128"></a><span class="lineno"> 7128</span>&#160;                     <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l07129"></a><span class="lineno"> 7129</span>&#160;                     flag);</div><div class="line"><a name="l07130"></a><span class="lineno"> 7130</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07131"></a><span class="lineno"> 7131</span>&#160;               }</div><div class="line"><a name="l07132"></a><span class="lineno"> 7132</span>&#160;</div><div class="line"><a name="l07133"></a><span class="lineno"> 7133</span>&#160;               <span class="comment">/* Disposal needs to happen after the optional move and copy */</span></div><div class="line"><a name="l07134"></a><span class="lineno"> 7134</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l07135"></a><span class="lineno"> 7135</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(dir, msgnum);</div><div class="line"><a name="l07136"></a><span class="lineno"> 7136</span>&#160;               }</div><div class="line"><a name="l07137"></a><span class="lineno"> 7137</span>&#160;            }</div><div class="line"><a name="l07138"></a><span class="lineno"> 7138</span>&#160;         }</div><div class="line"><a name="l07139"></a><span class="lineno"> 7139</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07140"></a><span class="lineno"> 7140</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l07141"></a><span class="lineno"> 7141</span>&#160;      }</div><div class="line"><a name="l07142"></a><span class="lineno"> 7142</span>&#160;      <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;0&#39;</span>) {</div><div class="line"><a name="l07143"></a><span class="lineno"> 7143</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>;</div><div class="line"><a name="l07144"></a><span class="lineno"> 7144</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; res != <span class="charliteral">&#39;t&#39;</span>)</div><div class="line"><a name="l07145"></a><span class="lineno"> 7145</span>&#160;         res = 0;</div><div class="line"><a name="l07146"></a><span class="lineno"> 7146</span>&#160;</div><div class="line"><a name="l07147"></a><span class="lineno"> 7147</span>&#160;      <span class="keywordflow">if</span> (sound_duration &lt; vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a>)</div><div class="line"><a name="l07148"></a><span class="lineno"> 7148</span>&#160;         <span class="comment">/* XXX We should really give a prompt too short/option start again, with leave_vm_out called only after a timeout XXX */</span></div><div class="line"><a name="l07149"></a><span class="lineno"> 7149</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l07150"></a><span class="lineno"> 7150</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l07151"></a><span class="lineno"> 7151</span>&#160;         <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);</div><div class="line"><a name="l07152"></a><span class="lineno"> 7152</span>&#160;   } <span class="keywordflow">else</span></div><div class="line"><a name="l07153"></a><span class="lineno"> 7153</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No format for saving voicemail?\n&quot;</span>);</div><div class="line"><a name="l07154"></a><span class="lineno"> 7154</span>&#160;leave_vm_out:</div><div class="line"><a name="l07155"></a><span class="lineno"> 7155</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l07156"></a><span class="lineno"> 7156</span>&#160;</div><div class="line"><a name="l07157"></a><span class="lineno"> 7157</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07158"></a><span class="lineno"> 7158</span>&#160;   <span class="comment">/* expunge message - use UID Expunge if supported on IMAP server*/</span></div><div class="line"><a name="l07159"></a><span class="lineno"> 7159</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;*** Checking if we can expunge, expungeonhangup set to %d\n&quot;</span>, expungeonhangup);</div><div class="line"><a name="l07160"></a><span class="lineno"> 7160</span>&#160;   <span class="keywordflow">if</span> (expungeonhangup == 1 &amp;&amp; vms-&gt;mailstream != <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line"><a name="l07161"></a><span class="lineno"> 7161</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07162"></a><span class="lineno"> 7162</span>&#160;<span class="preprocessor">#ifdef HAVE_IMAP_TK2006</span></div><div class="line"><a name="l07163"></a><span class="lineno"> 7163</span>&#160;      <span class="keywordflow">if</span> (LEVELUIDPLUS (vms-&gt;mailstream)) {</div><div class="line"><a name="l07164"></a><span class="lineno"> 7164</span>&#160;         mail_expunge_full(vms-&gt;mailstream, NIL, EX_UID);</div><div class="line"><a name="l07165"></a><span class="lineno"> 7165</span>&#160;      } <span class="keywordflow">else</span></div><div class="line"><a name="l07166"></a><span class="lineno"> 7166</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07167"></a><span class="lineno"> 7167</span>&#160;         mail_expunge(vms-&gt;mailstream);</div><div class="line"><a name="l07168"></a><span class="lineno"> 7168</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07169"></a><span class="lineno"> 7169</span>&#160;   }</div><div class="line"><a name="l07170"></a><span class="lineno"> 7170</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07171"></a><span class="lineno"> 7171</span>&#160;</div><div class="line"><a name="l07172"></a><span class="lineno"> 7172</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);</div><div class="line"><a name="l07173"></a><span class="lineno"> 7173</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l07174"></a><span class="lineno"> 7174</span>&#160;}</div><div class="line"><a name="l07175"></a><span class="lineno"> 7175</span>&#160;</div><div class="line"><a name="l07176"></a><span class="lineno"> 7176</span>&#160;<span class="preprocessor">#if !defined(IMAP_STORAGE)</span></div><div class="line"><a name="l07177"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acda2b7f1e36ad72fc556cc67cb2004c0"> 7177</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acda2b7f1e36ad72fc556cc67cb2004c0">resequence_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> stopcount)</div><div class="line"><a name="l07178"></a><span class="lineno"> 7178</span>&#160;{</div><div class="line"><a name="l07179"></a><span class="lineno"> 7179</span>&#160;   <span class="comment">/* we know the actual number of messages, so stop process when number is hit */</span></div><div class="line"><a name="l07180"></a><span class="lineno"> 7180</span>&#160;</div><div class="line"><a name="l07181"></a><span class="lineno"> 7181</span>&#160;   <span class="keywordtype">int</span> x, dest;</div><div class="line"><a name="l07182"></a><span class="lineno"> 7182</span>&#160;   <span class="keywordtype">char</span> sfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07183"></a><span class="lineno"> 7183</span>&#160;   <span class="keywordtype">char</span> dfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07184"></a><span class="lineno"> 7184</span>&#160;</div><div class="line"><a name="l07185"></a><span class="lineno"> 7185</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(dir)) {</div><div class="line"><a name="l07186"></a><span class="lineno"> 7186</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;</div><div class="line"><a name="l07187"></a><span class="lineno"> 7187</span>&#160;   }</div><div class="line"><a name="l07188"></a><span class="lineno"> 7188</span>&#160;</div><div class="line"><a name="l07189"></a><span class="lineno"> 7189</span>&#160;   <span class="keywordflow">for</span> (x = 0, dest = 0; dest != stopcount &amp;&amp; x &lt; vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> + 10; x++) {</div><div class="line"><a name="l07190"></a><span class="lineno"> 7190</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(sfn, <span class="keyword">sizeof</span>(sfn), dir, x);</div><div class="line"><a name="l07191"></a><span class="lineno"> 7191</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(dir, x, sfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l07192"></a><span class="lineno"> 7192</span>&#160;</div><div class="line"><a name="l07193"></a><span class="lineno"> 7193</span>&#160;         <span class="keywordflow">if</span> (x != dest) {</div><div class="line"><a name="l07194"></a><span class="lineno"> 7194</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(dfn, <span class="keyword">sizeof</span>(dfn), dir, dest);</div><div class="line"><a name="l07195"></a><span class="lineno"> 7195</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a>(dir, x, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, dir, dest, sfn, dfn);</div><div class="line"><a name="l07196"></a><span class="lineno"> 7196</span>&#160;         }</div><div class="line"><a name="l07197"></a><span class="lineno"> 7197</span>&#160;</div><div class="line"><a name="l07198"></a><span class="lineno"> 7198</span>&#160;         dest++;</div><div class="line"><a name="l07199"></a><span class="lineno"> 7199</span>&#160;      }</div><div class="line"><a name="l07200"></a><span class="lineno"> 7200</span>&#160;   }</div><div class="line"><a name="l07201"></a><span class="lineno"> 7201</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(dir);</div><div class="line"><a name="l07202"></a><span class="lineno"> 7202</span>&#160;</div><div class="line"><a name="l07203"></a><span class="lineno"> 7203</span>&#160;   <span class="keywordflow">return</span> dest;</div><div class="line"><a name="l07204"></a><span class="lineno"> 7204</span>&#160;}</div><div class="line"><a name="l07205"></a><span class="lineno"> 7205</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07206"></a><span class="lineno"> 7206</span>&#160;</div><div class="line"><a name="l07207"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7"> 7207</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> num, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>)</div><div class="line"><a name="l07208"></a><span class="lineno"> 7208</span>&#160;{</div><div class="line"><a name="l07209"></a><span class="lineno"> 7209</span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07210"></a><span class="lineno"> 7210</span>&#160;   d = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, num, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, language, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l07211"></a><span class="lineno"> 7211</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07212"></a><span class="lineno"> 7212</span>&#160;}</div><div class="line"><a name="l07213"></a><span class="lineno"> 7213</span>&#160;</div><div class="line"><a name="l07214"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464"> 7214</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msg, <span class="keywordtype">int</span> box, <span class="keywordtype">int</span> *newmsg, <span class="keywordtype">int</span> move)</div><div class="line"><a name="l07215"></a><span class="lineno"> 7215</span>&#160;{</div><div class="line"><a name="l07216"></a><span class="lineno"> 7216</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07217"></a><span class="lineno"> 7217</span>&#160;   <span class="comment">/* we must use mbox(x) folder names, and copy the message there */</span></div><div class="line"><a name="l07218"></a><span class="lineno"> 7218</span>&#160;   <span class="comment">/* simple. huh? */</span></div><div class="line"><a name="l07219"></a><span class="lineno"> 7219</span>&#160;   <span class="keywordtype">char</span> sequence[10];</div><div class="line"><a name="l07220"></a><span class="lineno"> 7220</span>&#160;   <span class="keywordtype">char</span> mailbox[256];</div><div class="line"><a name="l07221"></a><span class="lineno"> 7221</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l07222"></a><span class="lineno"> 7222</span>&#160;   <span class="keywordtype">int</span> curr_mbox;</div><div class="line"><a name="l07223"></a><span class="lineno"> 7223</span>&#160;</div><div class="line"><a name="l07224"></a><span class="lineno"> 7224</span>&#160;   <span class="comment">/* get the real IMAP message number for this message */</span></div><div class="line"><a name="l07225"></a><span class="lineno"> 7225</span>&#160;   snprintf(sequence, <span class="keyword">sizeof</span>(sequence), <span class="stringliteral">&quot;%ld&quot;</span>, vms-&gt;msgArray[msg]);</div><div class="line"><a name="l07226"></a><span class="lineno"> 7226</span>&#160;</div><div class="line"><a name="l07227"></a><span class="lineno"> 7227</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Copying sequence %s to mailbox %s\n&quot;</span>, sequence, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l07228"></a><span class="lineno"> 7228</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07229"></a><span class="lineno"> 7229</span>&#160;   <span class="comment">/* if save to Old folder, put in INBOX as read */</span></div><div class="line"><a name="l07230"></a><span class="lineno"> 7230</span>&#160;   <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {</div><div class="line"><a name="l07231"></a><span class="lineno"> 7231</span>&#160;      mail_setflag(vms-&gt;mailstream, sequence, <span class="stringliteral">&quot;\\Seen&quot;</span>);</div><div class="line"><a name="l07232"></a><span class="lineno"> 7232</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>) {</div><div class="line"><a name="l07233"></a><span class="lineno"> 7233</span>&#160;      mail_clearflag(vms-&gt;mailstream, sequence, <span class="stringliteral">&quot;\\Seen&quot;</span>);</div><div class="line"><a name="l07234"></a><span class="lineno"> 7234</span>&#160;   }</div><div class="line"><a name="l07235"></a><span class="lineno"> 7235</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>) &amp;&amp; (box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> || box == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>)) {</div><div class="line"><a name="l07236"></a><span class="lineno"> 7236</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07237"></a><span class="lineno"> 7237</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l07238"></a><span class="lineno"> 7238</span>&#160;   }</div><div class="line"><a name="l07239"></a><span class="lineno"> 7239</span>&#160;</div><div class="line"><a name="l07240"></a><span class="lineno"> 7240</span>&#160;   <span class="comment">/* get the current mailbox so that we can point the mailstream back to it later */</span></div><div class="line"><a name="l07241"></a><span class="lineno"> 7241</span>&#160;   curr_mbox = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l07242"></a><span class="lineno"> 7242</span>&#160;</div><div class="line"><a name="l07243"></a><span class="lineno"> 7243</span>&#160;   <span class="comment">/* Create the folder if it dosn&#39;t exist */</span></div><div class="line"><a name="l07244"></a><span class="lineno"> 7244</span>&#160;   imap_mailbox_name(mailbox, <span class="keyword">sizeof</span>(mailbox), vms, box, 1); <span class="comment">/* Get the full mailbox name */</span></div><div class="line"><a name="l07245"></a><span class="lineno"> 7245</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;mailstream &amp;&amp; !mail_status(vms-&gt;mailstream, mailbox, SA_UIDNEXT)) {</div><div class="line"><a name="l07246"></a><span class="lineno"> 7246</span>&#160;         <span class="keywordflow">if</span> (mail_create(vms-&gt;mailstream, mailbox) != NIL) {</div><div class="line"><a name="l07247"></a><span class="lineno"> 7247</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Folder %s created!\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l07248"></a><span class="lineno"> 7248</span>&#160;      }</div><div class="line"><a name="l07249"></a><span class="lineno"> 7249</span>&#160;   }</div><div class="line"><a name="l07250"></a><span class="lineno"> 7250</span>&#160;</div><div class="line"><a name="l07251"></a><span class="lineno"> 7251</span>&#160;   <span class="comment">/* restore previous mbox stream */</span></div><div class="line"><a name="l07252"></a><span class="lineno"> 7252</span>&#160;   <span class="keywordflow">if</span> (init_mailstream(vms, curr_mbox) || !vms-&gt;mailstream) {</div><div class="line"><a name="l07253"></a><span class="lineno"> 7253</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream is NULL or can&#39;t init_mailstream\n&quot;</span>);</div><div class="line"><a name="l07254"></a><span class="lineno"> 7254</span>&#160;      res = -1;</div><div class="line"><a name="l07255"></a><span class="lineno"> 7255</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07256"></a><span class="lineno"> 7256</span>&#160;      <span class="keywordflow">if</span> (move) {</div><div class="line"><a name="l07257"></a><span class="lineno"> 7257</span>&#160;         res = !mail_move(vms-&gt;mailstream, sequence, (<span class="keywordtype">char</span> *) <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l07258"></a><span class="lineno"> 7258</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07259"></a><span class="lineno"> 7259</span>&#160;         res = !mail_copy(vms-&gt;mailstream, sequence, (<span class="keywordtype">char</span> *) <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l07260"></a><span class="lineno"> 7260</span>&#160;      }</div><div class="line"><a name="l07261"></a><span class="lineno"> 7261</span>&#160;   }</div><div class="line"><a name="l07262"></a><span class="lineno"> 7262</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07263"></a><span class="lineno"> 7263</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l07264"></a><span class="lineno"> 7264</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l07265"></a><span class="lineno"> 7265</span>&#160;   <span class="keywordtype">char</span> *dir = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>;</div><div class="line"><a name="l07266"></a><span class="lineno"> 7266</span>&#160;   <span class="keywordtype">char</span> *username = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>;</div><div class="line"><a name="l07267"></a><span class="lineno"> 7267</span>&#160;   <span class="keywordtype">char</span> *context = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>;</div><div class="line"><a name="l07268"></a><span class="lineno"> 7268</span>&#160;   <span class="keywordtype">char</span> sfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07269"></a><span class="lineno"> 7269</span>&#160;   <span class="keywordtype">char</span> dfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07270"></a><span class="lineno"> 7270</span>&#160;   <span class="keywordtype">char</span> ddir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07271"></a><span class="lineno"> 7271</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *dbox = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box);</div><div class="line"><a name="l07272"></a><span class="lineno"> 7272</span>&#160;   <span class="keywordtype">int</span> x, i;</div><div class="line"><a name="l07273"></a><span class="lineno"> 7273</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(ddir, <span class="keyword">sizeof</span>(ddir), context, username, dbox);</div><div class="line"><a name="l07274"></a><span class="lineno"> 7274</span>&#160;</div><div class="line"><a name="l07275"></a><span class="lineno"> 7275</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(ddir))</div><div class="line"><a name="l07276"></a><span class="lineno"> 7276</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;</div><div class="line"><a name="l07277"></a><span class="lineno"> 7277</span>&#160;</div><div class="line"><a name="l07278"></a><span class="lineno"> 7278</span>&#160;   x = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(vmu, ddir) + 1;</div><div class="line"><a name="l07279"></a><span class="lineno"> 7279</span>&#160;</div><div class="line"><a name="l07280"></a><span class="lineno"> 7280</span>&#160;   <span class="keywordflow">if</span> (box == 10 &amp;&amp; x &gt;= vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>) { <span class="comment">/* &quot;Deleted&quot; folder*/</span></div><div class="line"><a name="l07281"></a><span class="lineno"> 7281</span>&#160;      x--;</div><div class="line"><a name="l07282"></a><span class="lineno"> 7282</span>&#160;      <span class="keywordflow">for</span> (i = 1; i &lt;= x; i++) {</div><div class="line"><a name="l07283"></a><span class="lineno"> 7283</span>&#160;         <span class="comment">/* Push files down a &quot;slot&quot;.  The oldest file (msg0000) will be deleted. */</span></div><div class="line"><a name="l07284"></a><span class="lineno"> 7284</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(sfn, <span class="keyword">sizeof</span>(sfn), ddir, i);</div><div class="line"><a name="l07285"></a><span class="lineno"> 7285</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(dfn, <span class="keyword">sizeof</span>(dfn), ddir, i - 1);</div><div class="line"><a name="l07286"></a><span class="lineno"> 7286</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(ddir, i, sfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l07287"></a><span class="lineno"> 7287</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a>(ddir, i, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, ddir, i - 1, sfn, dfn);</div><div class="line"><a name="l07288"></a><span class="lineno"> 7288</span>&#160;         } <span class="keywordflow">else</span></div><div class="line"><a name="l07289"></a><span class="lineno"> 7289</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l07290"></a><span class="lineno"> 7290</span>&#160;      }</div><div class="line"><a name="l07291"></a><span class="lineno"> 7291</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07292"></a><span class="lineno"> 7292</span>&#160;      <span class="keywordflow">if</span> (x &gt;= vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>) {</div><div class="line"><a name="l07293"></a><span class="lineno"> 7293</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(ddir);</div><div class="line"><a name="l07294"></a><span class="lineno"> 7294</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5b8df477c0090cd6966ff1a60907a09">ERROR_MAX_MSGS</a>;</div><div class="line"><a name="l07295"></a><span class="lineno"> 7295</span>&#160;      }</div><div class="line"><a name="l07296"></a><span class="lineno"> 7296</span>&#160;   }</div><div class="line"><a name="l07297"></a><span class="lineno"> 7297</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(sfn, <span class="keyword">sizeof</span>(sfn), dir, msg);</div><div class="line"><a name="l07298"></a><span class="lineno"> 7298</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(dfn, <span class="keyword">sizeof</span>(dfn), ddir, x);</div><div class="line"><a name="l07299"></a><span class="lineno"> 7299</span>&#160;   <span class="keywordflow">if</span> (strcmp(sfn, dfn)) {</div><div class="line"><a name="l07300"></a><span class="lineno"> 7300</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">COPY</a>(dir, msg, ddir, x, username, context, sfn, dfn);</div><div class="line"><a name="l07301"></a><span class="lineno"> 7301</span>&#160;   }</div><div class="line"><a name="l07302"></a><span class="lineno"> 7302</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(ddir);</div><div class="line"><a name="l07303"></a><span class="lineno"> 7303</span>&#160;</div><div class="line"><a name="l07304"></a><span class="lineno"> 7304</span>&#160;   <span class="keywordflow">if</span> (newmsg) {</div><div class="line"><a name="l07305"></a><span class="lineno"> 7305</span>&#160;      *newmsg = x;</div><div class="line"><a name="l07306"></a><span class="lineno"> 7306</span>&#160;   }</div><div class="line"><a name="l07307"></a><span class="lineno"> 7307</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l07308"></a><span class="lineno"> 7308</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07309"></a><span class="lineno"> 7309</span>&#160;}</div><div class="line"><a name="l07310"></a><span class="lineno"> 7310</span>&#160;</div><div class="line"><a name="l07311"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7"> 7311</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf)</div><div class="line"><a name="l07312"></a><span class="lineno"> 7312</span>&#160;{</div><div class="line"><a name="l07313"></a><span class="lineno"> 7313</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07314"></a><span class="lineno"> 7314</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Comedian Mail&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07315"></a><span class="lineno"> 7315</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;(C)2002-2006 Digium, Inc.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07316"></a><span class="lineno"> 7316</span>&#160;   <span class="keywordflow">return</span> bytes;</div><div class="line"><a name="l07317"></a><span class="lineno"> 7317</span>&#160;}</div><div class="line"><a name="l07318"></a><span class="lineno"> 7318</span>&#160;</div><div class="line"><a name="l07319"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c"> 7319</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c">adsi_load_vmail</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> *useadsi)</div><div class="line"><a name="l07320"></a><span class="lineno"> 7320</span>&#160;{</div><div class="line"><a name="l07321"></a><span class="lineno"> 7321</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07322"></a><span class="lineno"> 7322</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07323"></a><span class="lineno"> 7323</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07324"></a><span class="lineno"> 7324</span>&#160;   <span class="keywordtype">char</span> num[5];</div><div class="line"><a name="l07325"></a><span class="lineno"> 7325</span>&#160;</div><div class="line"><a name="l07326"></a><span class="lineno"> 7326</span>&#160;   *useadsi = 0;</div><div class="line"><a name="l07327"></a><span class="lineno"> 7327</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a392cb4fb1c98045c30589b62edb127ca">ast_adsi_data_mode</a>(buf + bytes);</div><div class="line"><a name="l07328"></a><span class="lineno"> 7328</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07329"></a><span class="lineno"> 7329</span>&#160;</div><div class="line"><a name="l07330"></a><span class="lineno"> 7330</span>&#160;   bytes = 0;</div><div class="line"><a name="l07331"></a><span class="lineno"> 7331</span>&#160;   bytes += <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf);</div><div class="line"><a name="l07332"></a><span class="lineno"> 7332</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Downloading Scripts&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07333"></a><span class="lineno"> 7333</span>&#160;<span class="preprocessor">#ifdef DISPLAY</span></div><div class="line"><a name="l07334"></a><span class="lineno"> 7334</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   .&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07335"></a><span class="lineno"> 7335</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07336"></a><span class="lineno"> 7336</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07337"></a><span class="lineno"> 7337</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a392cb4fb1c98045c30589b62edb127ca">ast_adsi_data_mode</a>(buf + bytes);</div><div class="line"><a name="l07338"></a><span class="lineno"> 7338</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07339"></a><span class="lineno"> 7339</span>&#160;</div><div class="line"><a name="l07340"></a><span class="lineno"> 7340</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/de2/adsi_8h.html#a664d01277c0ae1f12abbe6806ffcaccc">ast_adsi_begin_download</a>(chan, addesc, adsifdn, adsisec, adsiver)) {</div><div class="line"><a name="l07341"></a><span class="lineno"> 7341</span>&#160;      bytes = 0;</div><div class="line"><a name="l07342"></a><span class="lineno"> 7342</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Load Cancelled.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07343"></a><span class="lineno"> 7343</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;ADSI Unavailable&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07344"></a><span class="lineno"> 7344</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07345"></a><span class="lineno"> 7345</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07346"></a><span class="lineno"> 7346</span>&#160;      <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07347"></a><span class="lineno"> 7347</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l07348"></a><span class="lineno"> 7348</span>&#160;   }</div><div class="line"><a name="l07349"></a><span class="lineno"> 7349</span>&#160;</div><div class="line"><a name="l07350"></a><span class="lineno"> 7350</span>&#160;<span class="preprocessor">#ifdef DISPLAY</span></div><div class="line"><a name="l07351"></a><span class="lineno"> 7351</span>&#160;   <span class="comment">/* Add a dot */</span></div><div class="line"><a name="l07352"></a><span class="lineno"> 7352</span>&#160;   bytes = 0;</div><div class="line"><a name="l07353"></a><span class="lineno"> 7353</span>&#160;   bytes += ast_adsi_logo(buf);</div><div class="line"><a name="l07354"></a><span class="lineno"> 7354</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Downloading Scripts&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07355"></a><span class="lineno"> 7355</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   ..&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07356"></a><span class="lineno"> 7356</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07357"></a><span class="lineno"> 7357</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07358"></a><span class="lineno"> 7358</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07359"></a><span class="lineno"> 7359</span>&#160;   bytes = 0;</div><div class="line"><a name="l07360"></a><span class="lineno"> 7360</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 0, <span class="stringliteral">&quot;Listen&quot;</span>, <span class="stringliteral">&quot;Listen&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, 1);</div><div class="line"><a name="l07361"></a><span class="lineno"> 7361</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1, <span class="stringliteral">&quot;Folder&quot;</span>, <span class="stringliteral">&quot;Folder&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, 1);</div><div class="line"><a name="l07362"></a><span class="lineno"> 7362</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 2, <span class="stringliteral">&quot;Advanced&quot;</span>, <span class="stringliteral">&quot;Advnced&quot;</span>, <span class="stringliteral">&quot;3&quot;</span>, 1);</div><div class="line"><a name="l07363"></a><span class="lineno"> 7363</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3, <span class="stringliteral">&quot;Options&quot;</span>, <span class="stringliteral">&quot;Options&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, 1);</div><div class="line"><a name="l07364"></a><span class="lineno"> 7364</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 4, <span class="stringliteral">&quot;Help&quot;</span>, <span class="stringliteral">&quot;Help&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>, 1);</div><div class="line"><a name="l07365"></a><span class="lineno"> 7365</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 5, <span class="stringliteral">&quot;Exit&quot;</span>, <span class="stringliteral">&quot;Exit&quot;</span>, <span class="stringliteral">&quot;#&quot;</span>, 1);</div><div class="line"><a name="l07366"></a><span class="lineno"> 7366</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);</div><div class="line"><a name="l07367"></a><span class="lineno"> 7367</span>&#160;</div><div class="line"><a name="l07368"></a><span class="lineno"> 7368</span>&#160;<span class="preprocessor">#ifdef DISPLAY</span></div><div class="line"><a name="l07369"></a><span class="lineno"> 7369</span>&#160;   <span class="comment">/* Add another dot */</span></div><div class="line"><a name="l07370"></a><span class="lineno"> 7370</span>&#160;   bytes = 0;</div><div class="line"><a name="l07371"></a><span class="lineno"> 7371</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   ...&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07372"></a><span class="lineno"> 7372</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07373"></a><span class="lineno"> 7373</span>&#160;</div><div class="line"><a name="l07374"></a><span class="lineno"> 7374</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07375"></a><span class="lineno"> 7375</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07376"></a><span class="lineno"> 7376</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07377"></a><span class="lineno"> 7377</span>&#160;</div><div class="line"><a name="l07378"></a><span class="lineno"> 7378</span>&#160;   bytes = 0;</div><div class="line"><a name="l07379"></a><span class="lineno"> 7379</span>&#160;   <span class="comment">/* These buttons we load but don&#39;t use yet */</span></div><div class="line"><a name="l07380"></a><span class="lineno"> 7380</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 6, <span class="stringliteral">&quot;Previous&quot;</span>, <span class="stringliteral">&quot;Prev&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>, 1);</div><div class="line"><a name="l07381"></a><span class="lineno"> 7381</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 8, <span class="stringliteral">&quot;Repeat&quot;</span>, <span class="stringliteral">&quot;Repeat&quot;</span>, <span class="stringliteral">&quot;5&quot;</span>, 1);</div><div class="line"><a name="l07382"></a><span class="lineno"> 7382</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 7, <span class="stringliteral">&quot;Delete&quot;</span>, <span class="stringliteral">&quot;Delete&quot;</span>, <span class="stringliteral">&quot;7&quot;</span>, 1);</div><div class="line"><a name="l07383"></a><span class="lineno"> 7383</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 9, <span class="stringliteral">&quot;Next&quot;</span>, <span class="stringliteral">&quot;Next&quot;</span>, <span class="stringliteral">&quot;6&quot;</span>, 1);</div><div class="line"><a name="l07384"></a><span class="lineno"> 7384</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 10, <span class="stringliteral">&quot;Save&quot;</span>, <span class="stringliteral">&quot;Save&quot;</span>, <span class="stringliteral">&quot;9&quot;</span>, 1);</div><div class="line"><a name="l07385"></a><span class="lineno"> 7385</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 11, <span class="stringliteral">&quot;Undelete&quot;</span>, <span class="stringliteral">&quot;Restore&quot;</span>, <span class="stringliteral">&quot;7&quot;</span>, 1);</div><div class="line"><a name="l07386"></a><span class="lineno"> 7386</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);</div><div class="line"><a name="l07387"></a><span class="lineno"> 7387</span>&#160;</div><div class="line"><a name="l07388"></a><span class="lineno"> 7388</span>&#160;<span class="preprocessor">#ifdef DISPLAY</span></div><div class="line"><a name="l07389"></a><span class="lineno"> 7389</span>&#160;   <span class="comment">/* Add another dot */</span></div><div class="line"><a name="l07390"></a><span class="lineno"> 7390</span>&#160;   bytes = 0;</div><div class="line"><a name="l07391"></a><span class="lineno"> 7391</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   ....&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07392"></a><span class="lineno"> 7392</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07393"></a><span class="lineno"> 7393</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07394"></a><span class="lineno"> 7394</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07395"></a><span class="lineno"> 7395</span>&#160;</div><div class="line"><a name="l07396"></a><span class="lineno"> 7396</span>&#160;   bytes = 0;</div><div class="line"><a name="l07397"></a><span class="lineno"> 7397</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 5; x++) {</div><div class="line"><a name="l07398"></a><span class="lineno"> 7398</span>&#160;      snprintf(num, <span class="keyword">sizeof</span>(num), <span class="stringliteral">&quot;%d&quot;</span>, x);</div><div class="line"><a name="l07399"></a><span class="lineno"> 7399</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + x, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x), num, 1);</div><div class="line"><a name="l07400"></a><span class="lineno"> 7400</span>&#160;   }</div><div class="line"><a name="l07401"></a><span class="lineno"> 7401</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + 5, <span class="stringliteral">&quot;Cancel&quot;</span>, <span class="stringliteral">&quot;Cancel&quot;</span>, <span class="stringliteral">&quot;#&quot;</span>, 1);</div><div class="line"><a name="l07402"></a><span class="lineno"> 7402</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);</div><div class="line"><a name="l07403"></a><span class="lineno"> 7403</span>&#160;</div><div class="line"><a name="l07404"></a><span class="lineno"> 7404</span>&#160;<span class="preprocessor">#ifdef DISPLAY</span></div><div class="line"><a name="l07405"></a><span class="lineno"> 7405</span>&#160;   <span class="comment">/* Add another dot */</span></div><div class="line"><a name="l07406"></a><span class="lineno"> 7406</span>&#160;   bytes = 0;</div><div class="line"><a name="l07407"></a><span class="lineno"> 7407</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   .....&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07408"></a><span class="lineno"> 7408</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07409"></a><span class="lineno"> 7409</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07410"></a><span class="lineno"> 7410</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07411"></a><span class="lineno"> 7411</span>&#160;</div><div class="line"><a name="l07412"></a><span class="lineno"> 7412</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/de2/adsi_8h.html#acc50da4e3e25e75245268963ecc5fcd0">ast_adsi_end_download</a>(chan)) {</div><div class="line"><a name="l07413"></a><span class="lineno"> 7413</span>&#160;      bytes = 0;</div><div class="line"><a name="l07414"></a><span class="lineno"> 7414</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Download Unsuccessful.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07415"></a><span class="lineno"> 7415</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;ADSI Unavailable&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07416"></a><span class="lineno"> 7416</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07417"></a><span class="lineno"> 7417</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07418"></a><span class="lineno"> 7418</span>&#160;      <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07419"></a><span class="lineno"> 7419</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l07420"></a><span class="lineno"> 7420</span>&#160;   }</div><div class="line"><a name="l07421"></a><span class="lineno"> 7421</span>&#160;   bytes = 0;</div><div class="line"><a name="l07422"></a><span class="lineno"> 7422</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#adcf83d43ae50c9f89365699d8974c7b7">ast_adsi_download_disconnect</a>(buf + bytes);</div><div class="line"><a name="l07423"></a><span class="lineno"> 7423</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07424"></a><span class="lineno"> 7424</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);</div><div class="line"><a name="l07425"></a><span class="lineno"> 7425</span>&#160;</div><div class="line"><a name="l07426"></a><span class="lineno"> 7426</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Done downloading scripts...\n&quot;</span>);</div><div class="line"><a name="l07427"></a><span class="lineno"> 7427</span>&#160;</div><div class="line"><a name="l07428"></a><span class="lineno"> 7428</span>&#160;<span class="preprocessor">#ifdef DISPLAY</span></div><div class="line"><a name="l07429"></a><span class="lineno"> 7429</span>&#160;   <span class="comment">/* Add last dot */</span></div><div class="line"><a name="l07430"></a><span class="lineno"> 7430</span>&#160;   bytes = 0;</div><div class="line"><a name="l07431"></a><span class="lineno"> 7431</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;   ......&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07432"></a><span class="lineno"> 7432</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07433"></a><span class="lineno"> 7433</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07434"></a><span class="lineno"> 7434</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Restarting session...\n&quot;</span>);</div><div class="line"><a name="l07435"></a><span class="lineno"> 7435</span>&#160;</div><div class="line"><a name="l07436"></a><span class="lineno"> 7436</span>&#160;   bytes = 0;</div><div class="line"><a name="l07437"></a><span class="lineno"> 7437</span>&#160;   <span class="comment">/* Load the session now */</span></div><div class="line"><a name="l07438"></a><span class="lineno"> 7438</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/de2/adsi_8h.html#ac80689408529c01f75cb698fc2e407fb">ast_adsi_load_session</a>(chan, adsifdn, adsiver, 1) == 1) {</div><div class="line"><a name="l07439"></a><span class="lineno"> 7439</span>&#160;      *useadsi = 1;</div><div class="line"><a name="l07440"></a><span class="lineno"> 7440</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Scripts Loaded!&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07441"></a><span class="lineno"> 7441</span>&#160;   } <span class="keywordflow">else</span></div><div class="line"><a name="l07442"></a><span class="lineno"> 7442</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Load Failed!&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07443"></a><span class="lineno"> 7443</span>&#160;</div><div class="line"><a name="l07444"></a><span class="lineno"> 7444</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07445"></a><span class="lineno"> 7445</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l07446"></a><span class="lineno"> 7446</span>&#160;}</div><div class="line"><a name="l07447"></a><span class="lineno"> 7447</span>&#160;</div><div class="line"><a name="l07448"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7"> 7448</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> *useadsi)</div><div class="line"><a name="l07449"></a><span class="lineno"> 7449</span>&#160;{</div><div class="line"><a name="l07450"></a><span class="lineno"> 7450</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07451"></a><span class="lineno"> 7451</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07452"></a><span class="lineno"> 7452</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07453"></a><span class="lineno"> 7453</span>&#160;   x = <a class="code" href="../../df/de2/adsi_8h.html#ac80689408529c01f75cb698fc2e407fb">ast_adsi_load_session</a>(chan, adsifdn, adsiver, 1);</div><div class="line"><a name="l07454"></a><span class="lineno"> 7454</span>&#160;   <span class="keywordflow">if</span> (x &lt; 0)</div><div class="line"><a name="l07455"></a><span class="lineno"> 7455</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07456"></a><span class="lineno"> 7456</span>&#160;   <span class="keywordflow">if</span> (!x) {</div><div class="line"><a name="l07457"></a><span class="lineno"> 7457</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c">adsi_load_vmail</a>(chan, useadsi)) {</div><div class="line"><a name="l07458"></a><span class="lineno"> 7458</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to upload voicemail scripts\n&quot;</span>);</div><div class="line"><a name="l07459"></a><span class="lineno"> 7459</span>&#160;         <span class="keywordflow">return</span>;</div><div class="line"><a name="l07460"></a><span class="lineno"> 7460</span>&#160;      }</div><div class="line"><a name="l07461"></a><span class="lineno"> 7461</span>&#160;   } <span class="keywordflow">else</span></div><div class="line"><a name="l07462"></a><span class="lineno"> 7462</span>&#160;      *useadsi = 1;</div><div class="line"><a name="l07463"></a><span class="lineno"> 7463</span>&#160;}</div><div class="line"><a name="l07464"></a><span class="lineno"> 7464</span>&#160;</div><div class="line"><a name="l07465"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a"> 7465</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan)</div><div class="line"><a name="l07466"></a><span class="lineno"> 7466</span>&#160;{</div><div class="line"><a name="l07467"></a><span class="lineno"> 7467</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07468"></a><span class="lineno"> 7468</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07469"></a><span class="lineno"> 7469</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07470"></a><span class="lineno"> 7470</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07471"></a><span class="lineno"> 7471</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07472"></a><span class="lineno"> 7472</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07473"></a><span class="lineno"> 7473</span>&#160;</div><div class="line"><a name="l07474"></a><span class="lineno"> 7474</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 8; x++)</div><div class="line"><a name="l07475"></a><span class="lineno"> 7475</span>&#160;      keys[x] = 0;</div><div class="line"><a name="l07476"></a><span class="lineno"> 7476</span>&#160;   <span class="comment">/* Set one key for next */</span></div><div class="line"><a name="l07477"></a><span class="lineno"> 7477</span>&#160;   keys[3] = <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3;</div><div class="line"><a name="l07478"></a><span class="lineno"> 7478</span>&#160;</div><div class="line"><a name="l07479"></a><span class="lineno"> 7479</span>&#160;   bytes += <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);</div><div class="line"><a name="l07480"></a><span class="lineno"> 7480</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07481"></a><span class="lineno"> 7481</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07482"></a><span class="lineno"> 7482</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07483"></a><span class="lineno"> 7483</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ac1207eca69705174ac9cdcc71d49fb2f">ast_adsi_input_format</a>(buf + bytes, 1, <a class="code" href="../../df/de2/adsi_8h.html#ae5cda91c55554914c5b7af2cfddca68f">ADSI_DIR_FROM_LEFT</a>, 0, <span class="stringliteral">&quot;Mailbox: ******&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07484"></a><span class="lineno"> 7484</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#abbaf47d66d63f4844a68ddfa8209e73e">ast_adsi_input_control</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, 1, 1, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>);</div><div class="line"><a name="l07485"></a><span class="lineno"> 7485</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3, <span class="stringliteral">&quot;Enter&quot;</span>, <span class="stringliteral">&quot;Enter&quot;</span>, <span class="stringliteral">&quot;#&quot;</span>, 1);</div><div class="line"><a name="l07486"></a><span class="lineno"> 7486</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07487"></a><span class="lineno"> 7487</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07488"></a><span class="lineno"> 7488</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07489"></a><span class="lineno"> 7489</span>&#160;}</div><div class="line"><a name="l07490"></a><span class="lineno"> 7490</span>&#160;</div><div class="line"><a name="l07491"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47"> 7491</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47">adsi_password</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan)</div><div class="line"><a name="l07492"></a><span class="lineno"> 7492</span>&#160;{</div><div class="line"><a name="l07493"></a><span class="lineno"> 7493</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07494"></a><span class="lineno"> 7494</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07495"></a><span class="lineno"> 7495</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07496"></a><span class="lineno"> 7496</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07497"></a><span class="lineno"> 7497</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07498"></a><span class="lineno"> 7498</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07499"></a><span class="lineno"> 7499</span>&#160;</div><div class="line"><a name="l07500"></a><span class="lineno"> 7500</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 8; x++)</div><div class="line"><a name="l07501"></a><span class="lineno"> 7501</span>&#160;      keys[x] = 0;</div><div class="line"><a name="l07502"></a><span class="lineno"> 7502</span>&#160;   <span class="comment">/* Set one key for next */</span></div><div class="line"><a name="l07503"></a><span class="lineno"> 7503</span>&#160;   keys[3] = <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3;</div><div class="line"><a name="l07504"></a><span class="lineno"> 7504</span>&#160;</div><div class="line"><a name="l07505"></a><span class="lineno"> 7505</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07506"></a><span class="lineno"> 7506</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ac1207eca69705174ac9cdcc71d49fb2f">ast_adsi_input_format</a>(buf + bytes, 1, <a class="code" href="../../df/de2/adsi_8h.html#ae5cda91c55554914c5b7af2cfddca68f">ADSI_DIR_FROM_LEFT</a>, 0, <span class="stringliteral">&quot;Password: ******&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07507"></a><span class="lineno"> 7507</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#abbaf47d66d63f4844a68ddfa8209e73e">ast_adsi_input_control</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, 0, 1, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>);</div><div class="line"><a name="l07508"></a><span class="lineno"> 7508</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07509"></a><span class="lineno"> 7509</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07510"></a><span class="lineno"> 7510</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07511"></a><span class="lineno"> 7511</span>&#160;}</div><div class="line"><a name="l07512"></a><span class="lineno"> 7512</span>&#160;</div><div class="line"><a name="l07513"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5"> 7513</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> start, <span class="keywordtype">char</span> *label)</div><div class="line"><a name="l07514"></a><span class="lineno"> 7514</span>&#160;{</div><div class="line"><a name="l07515"></a><span class="lineno"> 7515</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07516"></a><span class="lineno"> 7516</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07517"></a><span class="lineno"> 7517</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07518"></a><span class="lineno"> 7518</span>&#160;   <span class="keywordtype">int</span> x, y;</div><div class="line"><a name="l07519"></a><span class="lineno"> 7519</span>&#160;</div><div class="line"><a name="l07520"></a><span class="lineno"> 7520</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07521"></a><span class="lineno"> 7521</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07522"></a><span class="lineno"> 7522</span>&#160;</div><div class="line"><a name="l07523"></a><span class="lineno"> 7523</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 5; x++) {</div><div class="line"><a name="l07524"></a><span class="lineno"> 7524</span>&#160;      y = <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + start + x;</div><div class="line"><a name="l07525"></a><span class="lineno"> 7525</span>&#160;      <span class="keywordflow">if</span> (y &gt; <a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + 4)</div><div class="line"><a name="l07526"></a><span class="lineno"> 7526</span>&#160;         y = 0;</div><div class="line"><a name="l07527"></a><span class="lineno"> 7527</span>&#160;      keys[x] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | y;</div><div class="line"><a name="l07528"></a><span class="lineno"> 7528</span>&#160;   }</div><div class="line"><a name="l07529"></a><span class="lineno"> 7529</span>&#160;   keys[5] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 17);</div><div class="line"><a name="l07530"></a><span class="lineno"> 7530</span>&#160;   keys[6] = 0;</div><div class="line"><a name="l07531"></a><span class="lineno"> 7531</span>&#160;   keys[7] = 0;</div><div class="line"><a name="l07532"></a><span class="lineno"> 7532</span>&#160;</div><div class="line"><a name="l07533"></a><span class="lineno"> 7533</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, label, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07534"></a><span class="lineno"> 7534</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07535"></a><span class="lineno"> 7535</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07536"></a><span class="lineno"> 7536</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07537"></a><span class="lineno"> 7537</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07538"></a><span class="lineno"> 7538</span>&#160;</div><div class="line"><a name="l07539"></a><span class="lineno"> 7539</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07540"></a><span class="lineno"> 7540</span>&#160;}</div><div class="line"><a name="l07541"></a><span class="lineno"> 7541</span>&#160;</div><div class="line"><a name="l07542"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd"> 7542</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l07543"></a><span class="lineno"> 7543</span>&#160;{</div><div class="line"><a name="l07544"></a><span class="lineno"> 7544</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07545"></a><span class="lineno"> 7545</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07546"></a><span class="lineno"> 7546</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../db/d09/func__realtime_8c.html#aef4a708d73ca36016d9360f84685350d">buf1</a>[256], <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>[256];</div><div class="line"><a name="l07547"></a><span class="lineno"> 7547</span>&#160;   <span class="keywordtype">char</span> fn2[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07548"></a><span class="lineno"> 7548</span>&#160;</div><div class="line"><a name="l07549"></a><span class="lineno"> 7549</span>&#160;   <span class="keywordtype">char</span> cid[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l07550"></a><span class="lineno"> 7550</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d5/d85/structval.html">val</a>;</div><div class="line"><a name="l07551"></a><span class="lineno"> 7551</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>, *num;</div><div class="line"><a name="l07552"></a><span class="lineno"> 7552</span>&#160;   <span class="keywordtype">char</span> datetime[21] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l07553"></a><span class="lineno"> 7553</span>&#160;   FILE *f;</div><div class="line"><a name="l07554"></a><span class="lineno"> 7554</span>&#160;</div><div class="line"><a name="l07555"></a><span class="lineno"> 7555</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07556"></a><span class="lineno"> 7556</span>&#160;</div><div class="line"><a name="l07557"></a><span class="lineno"> 7557</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07558"></a><span class="lineno"> 7558</span>&#160;</div><div class="line"><a name="l07559"></a><span class="lineno"> 7559</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07560"></a><span class="lineno"> 7560</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07561"></a><span class="lineno"> 7561</span>&#160;</div><div class="line"><a name="l07562"></a><span class="lineno"> 7562</span>&#160;   <span class="comment">/* Retrieve important info */</span></div><div class="line"><a name="l07563"></a><span class="lineno"> 7563</span>&#160;   snprintf(fn2, <span class="keyword">sizeof</span>(fn2), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l07564"></a><span class="lineno"> 7564</span>&#160;   f = fopen(fn2, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line"><a name="l07565"></a><span class="lineno"> 7565</span>&#160;   <span class="keywordflow">if</span> (f) {</div><div class="line"><a name="l07566"></a><span class="lineno"> 7566</span>&#160;      <span class="keywordflow">while</span> (!feof(f)) {</div><div class="line"><a name="l07567"></a><span class="lineno"> 7567</span>&#160;         <span class="keywordflow">if</span> (!fgets((<span class="keywordtype">char</span> *) buf, <span class="keyword">sizeof</span>(buf), f)) {</div><div class="line"><a name="l07568"></a><span class="lineno"> 7568</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l07569"></a><span class="lineno"> 7569</span>&#160;         }</div><div class="line"><a name="l07570"></a><span class="lineno"> 7570</span>&#160;         <span class="keywordflow">if</span> (!feof(f)) {</div><div class="line"><a name="l07571"></a><span class="lineno"> 7571</span>&#160;            <span class="keywordtype">char</span> *stringp = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l07572"></a><span class="lineno"> 7572</span>&#160;            stringp = (<span class="keywordtype">char</span> *) buf;</div><div class="line"><a name="l07573"></a><span class="lineno"> 7573</span>&#160;            <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;=&quot;</span>);</div><div class="line"><a name="l07574"></a><span class="lineno"> 7574</span>&#160;            val = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;=&quot;</span>);</div><div class="line"><a name="l07575"></a><span class="lineno"> 7575</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(val)) {</div><div class="line"><a name="l07576"></a><span class="lineno"> 7576</span>&#160;               <span class="keywordflow">if</span> (!strcmp((<span class="keywordtype">char</span> *) buf, <span class="stringliteral">&quot;callerid&quot;</span>))</div><div class="line"><a name="l07577"></a><span class="lineno"> 7577</span>&#160;                  <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(cid, val, <span class="keyword">sizeof</span>(cid));</div><div class="line"><a name="l07578"></a><span class="lineno"> 7578</span>&#160;               <span class="keywordflow">if</span> (!strcmp((<span class="keywordtype">char</span> *) buf, <span class="stringliteral">&quot;origdate&quot;</span>))</div><div class="line"><a name="l07579"></a><span class="lineno"> 7579</span>&#160;                  <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(datetime, val, <span class="keyword">sizeof</span>(datetime));</div><div class="line"><a name="l07580"></a><span class="lineno"> 7580</span>&#160;            }</div><div class="line"><a name="l07581"></a><span class="lineno"> 7581</span>&#160;         }</div><div class="line"><a name="l07582"></a><span class="lineno"> 7582</span>&#160;      }</div><div class="line"><a name="l07583"></a><span class="lineno"> 7583</span>&#160;      fclose(f);</div><div class="line"><a name="l07584"></a><span class="lineno"> 7584</span>&#160;   }</div><div class="line"><a name="l07585"></a><span class="lineno"> 7585</span>&#160;   <span class="comment">/* New meaning for keys */</span></div><div class="line"><a name="l07586"></a><span class="lineno"> 7586</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 5; x++)</div><div class="line"><a name="l07587"></a><span class="lineno"> 7587</span>&#160;      keys[x] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 6 + x);</div><div class="line"><a name="l07588"></a><span class="lineno"> 7588</span>&#160;   keys[6] = 0x0;</div><div class="line"><a name="l07589"></a><span class="lineno"> 7589</span>&#160;   keys[7] = 0x0;</div><div class="line"><a name="l07590"></a><span class="lineno"> 7590</span>&#160;</div><div class="line"><a name="l07591"></a><span class="lineno"> 7591</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l07592"></a><span class="lineno"> 7592</span>&#160;      <span class="comment">/* No prev key, provide &quot;Folder&quot; instead */</span></div><div class="line"><a name="l07593"></a><span class="lineno"> 7593</span>&#160;      keys[0] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);</div><div class="line"><a name="l07594"></a><span class="lineno"> 7594</span>&#160;   }</div><div class="line"><a name="l07595"></a><span class="lineno"> 7595</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt;= vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l07596"></a><span class="lineno"> 7596</span>&#160;      <span class="comment">/* If last message ... */</span></div><div class="line"><a name="l07597"></a><span class="lineno"> 7597</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l07598"></a><span class="lineno"> 7598</span>&#160;         <span class="comment">/* but not only message, provide &quot;Folder&quot; instead */</span></div><div class="line"><a name="l07599"></a><span class="lineno"> 7599</span>&#160;         keys[3] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);</div><div class="line"><a name="l07600"></a><span class="lineno"> 7600</span>&#160;         bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07601"></a><span class="lineno"> 7601</span>&#160;</div><div class="line"><a name="l07602"></a><span class="lineno"> 7602</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07603"></a><span class="lineno"> 7603</span>&#160;         <span class="comment">/* Otherwise if only message, leave blank */</span></div><div class="line"><a name="l07604"></a><span class="lineno"> 7604</span>&#160;         keys[3] = 1;</div><div class="line"><a name="l07605"></a><span class="lineno"> 7605</span>&#160;      }</div><div class="line"><a name="l07606"></a><span class="lineno"> 7606</span>&#160;   }</div><div class="line"><a name="l07607"></a><span class="lineno"> 7607</span>&#160;</div><div class="line"><a name="l07608"></a><span class="lineno"> 7608</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cid)) {</div><div class="line"><a name="l07609"></a><span class="lineno"> 7609</span>&#160;      <a class="code" href="../../de/d47/callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df">ast_callerid_parse</a>(cid, &amp;name, &amp;num);</div><div class="line"><a name="l07610"></a><span class="lineno"> 7610</span>&#160;      <span class="keywordflow">if</span> (!name)</div><div class="line"><a name="l07611"></a><span class="lineno"> 7611</span>&#160;         name = num;</div><div class="line"><a name="l07612"></a><span class="lineno"> 7612</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07613"></a><span class="lineno"> 7613</span>&#160;      name = <span class="stringliteral">&quot;Unknown Caller&quot;</span>;</div><div class="line"><a name="l07614"></a><span class="lineno"> 7614</span>&#160;   }</div><div class="line"><a name="l07615"></a><span class="lineno"> 7615</span>&#160;</div><div class="line"><a name="l07616"></a><span class="lineno"> 7616</span>&#160;   <span class="comment">/* If deleted, show &quot;undeleted&quot; */</span></div><div class="line"><a name="l07617"></a><span class="lineno"> 7617</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07618"></a><span class="lineno"> 7618</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07619"></a><span class="lineno"> 7619</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07620"></a><span class="lineno"> 7620</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>]) {</div><div class="line"><a name="l07621"></a><span class="lineno"> 7621</span>&#160;      keys[1] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 11);</div><div class="line"><a name="l07622"></a><span class="lineno"> 7622</span>&#160;   }</div><div class="line"><a name="l07623"></a><span class="lineno"> 7623</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07624"></a><span class="lineno"> 7624</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07625"></a><span class="lineno"> 7625</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07626"></a><span class="lineno"> 7626</span>&#160;</div><div class="line"><a name="l07627"></a><span class="lineno"> 7627</span>&#160;   <span class="comment">/* Except &quot;Exit&quot; */</span></div><div class="line"><a name="l07628"></a><span class="lineno"> 7628</span>&#160;   keys[5] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 5);</div><div class="line"><a name="l07629"></a><span class="lineno"> 7629</span>&#160;   snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;%s%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>,</div><div class="line"><a name="l07630"></a><span class="lineno"> 7630</span>&#160;      strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) ? <span class="stringliteral">&quot; Messages&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07631"></a><span class="lineno"> 7631</span>&#160;   snprintf(buf2, <span class="keyword">sizeof</span>(buf2), <span class="stringliteral">&quot;Message %d of %d&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);</div><div class="line"><a name="l07632"></a><span class="lineno"> 7632</span>&#160;</div><div class="line"><a name="l07633"></a><span class="lineno"> 7633</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf1, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07634"></a><span class="lineno"> 7634</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf2, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07635"></a><span class="lineno"> 7635</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, name, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07636"></a><span class="lineno"> 7636</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, datetime, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07637"></a><span class="lineno"> 7637</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07638"></a><span class="lineno"> 7638</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07639"></a><span class="lineno"> 7639</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07640"></a><span class="lineno"> 7640</span>&#160;</div><div class="line"><a name="l07641"></a><span class="lineno"> 7641</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07642"></a><span class="lineno"> 7642</span>&#160;}</div><div class="line"><a name="l07643"></a><span class="lineno"> 7643</span>&#160;</div><div class="line"><a name="l07644"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4"> 7644</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4">adsi_delete</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l07645"></a><span class="lineno"> 7645</span>&#160;{</div><div class="line"><a name="l07646"></a><span class="lineno"> 7646</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07647"></a><span class="lineno"> 7647</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07648"></a><span class="lineno"> 7648</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07649"></a><span class="lineno"> 7649</span>&#160;</div><div class="line"><a name="l07650"></a><span class="lineno"> 7650</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07651"></a><span class="lineno"> 7651</span>&#160;</div><div class="line"><a name="l07652"></a><span class="lineno"> 7652</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07653"></a><span class="lineno"> 7653</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07654"></a><span class="lineno"> 7654</span>&#160;</div><div class="line"><a name="l07655"></a><span class="lineno"> 7655</span>&#160;   <span class="comment">/* New meaning for keys */</span></div><div class="line"><a name="l07656"></a><span class="lineno"> 7656</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 5; x++)</div><div class="line"><a name="l07657"></a><span class="lineno"> 7657</span>&#160;      keys[x] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 6 + x);</div><div class="line"><a name="l07658"></a><span class="lineno"> 7658</span>&#160;</div><div class="line"><a name="l07659"></a><span class="lineno"> 7659</span>&#160;   keys[6] = 0x0;</div><div class="line"><a name="l07660"></a><span class="lineno"> 7660</span>&#160;   keys[7] = 0x0;</div><div class="line"><a name="l07661"></a><span class="lineno"> 7661</span>&#160;</div><div class="line"><a name="l07662"></a><span class="lineno"> 7662</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l07663"></a><span class="lineno"> 7663</span>&#160;      <span class="comment">/* No prev key, provide &quot;Folder&quot; instead */</span></div><div class="line"><a name="l07664"></a><span class="lineno"> 7664</span>&#160;      keys[0] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);</div><div class="line"><a name="l07665"></a><span class="lineno"> 7665</span>&#160;   }</div><div class="line"><a name="l07666"></a><span class="lineno"> 7666</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt;= vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l07667"></a><span class="lineno"> 7667</span>&#160;      <span class="comment">/* If last message ... */</span></div><div class="line"><a name="l07668"></a><span class="lineno"> 7668</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l07669"></a><span class="lineno"> 7669</span>&#160;         <span class="comment">/* but not only message, provide &quot;Folder&quot; instead */</span></div><div class="line"><a name="l07670"></a><span class="lineno"> 7670</span>&#160;         keys[3] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);</div><div class="line"><a name="l07671"></a><span class="lineno"> 7671</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07672"></a><span class="lineno"> 7672</span>&#160;         <span class="comment">/* Otherwise if only message, leave blank */</span></div><div class="line"><a name="l07673"></a><span class="lineno"> 7673</span>&#160;         keys[3] = 1;</div><div class="line"><a name="l07674"></a><span class="lineno"> 7674</span>&#160;      }</div><div class="line"><a name="l07675"></a><span class="lineno"> 7675</span>&#160;   }</div><div class="line"><a name="l07676"></a><span class="lineno"> 7676</span>&#160;</div><div class="line"><a name="l07677"></a><span class="lineno"> 7677</span>&#160;   <span class="comment">/* If deleted, show &quot;undeleted&quot; */</span></div><div class="line"><a name="l07678"></a><span class="lineno"> 7678</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07679"></a><span class="lineno"> 7679</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07680"></a><span class="lineno"> 7680</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07681"></a><span class="lineno"> 7681</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>]) {</div><div class="line"><a name="l07682"></a><span class="lineno"> 7682</span>&#160;      keys[1] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 11);</div><div class="line"><a name="l07683"></a><span class="lineno"> 7683</span>&#160;   }</div><div class="line"><a name="l07684"></a><span class="lineno"> 7684</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07685"></a><span class="lineno"> 7685</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l07686"></a><span class="lineno"> 7686</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07687"></a><span class="lineno"> 7687</span>&#160;</div><div class="line"><a name="l07688"></a><span class="lineno"> 7688</span>&#160;   <span class="comment">/* Except &quot;Exit&quot; */</span></div><div class="line"><a name="l07689"></a><span class="lineno"> 7689</span>&#160;   keys[5] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 5);</div><div class="line"><a name="l07690"></a><span class="lineno"> 7690</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07691"></a><span class="lineno"> 7691</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07692"></a><span class="lineno"> 7692</span>&#160;</div><div class="line"><a name="l07693"></a><span class="lineno"> 7693</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07694"></a><span class="lineno"> 7694</span>&#160;}</div><div class="line"><a name="l07695"></a><span class="lineno"> 7695</span>&#160;</div><div class="line"><a name="l07696"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc"> 7696</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l07697"></a><span class="lineno"> 7697</span>&#160;{</div><div class="line"><a name="l07698"></a><span class="lineno"> 7698</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l07699"></a><span class="lineno"> 7699</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../db/d09/func__realtime_8c.html#aef4a708d73ca36016d9360f84685350d">buf1</a>[256] = <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l07700"></a><span class="lineno"> 7700</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07701"></a><span class="lineno"> 7701</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07702"></a><span class="lineno"> 7702</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07703"></a><span class="lineno"> 7703</span>&#160;</div><div class="line"><a name="l07704"></a><span class="lineno"> 7704</span>&#160;   <span class="keywordtype">char</span> *newm = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) ? <span class="stringliteral">&quot;message&quot;</span> : <span class="stringliteral">&quot;messages&quot;</span>;</div><div class="line"><a name="l07705"></a><span class="lineno"> 7705</span>&#160;   <span class="keywordtype">char</span> *oldm = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) ? <span class="stringliteral">&quot;message&quot;</span> : <span class="stringliteral">&quot;messages&quot;</span>;</div><div class="line"><a name="l07706"></a><span class="lineno"> 7706</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07707"></a><span class="lineno"> 7707</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07708"></a><span class="lineno"> 7708</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l07709"></a><span class="lineno"> 7709</span>&#160;      snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;You have %d new&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>);</div><div class="line"><a name="l07710"></a><span class="lineno"> 7710</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l07711"></a><span class="lineno"> 7711</span>&#160;         strncat(buf1, <span class="stringliteral">&quot; and&quot;</span>, <span class="keyword">sizeof</span>(buf1) - strlen(buf1) - 1);</div><div class="line"><a name="l07712"></a><span class="lineno"> 7712</span>&#160;         snprintf(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>), <span class="stringliteral">&quot;%d old %s.&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, oldm);</div><div class="line"><a name="l07713"></a><span class="lineno"> 7713</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07714"></a><span class="lineno"> 7714</span>&#160;         snprintf(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>), <span class="stringliteral">&quot;%s.&quot;</span>, newm);</div><div class="line"><a name="l07715"></a><span class="lineno"> 7715</span>&#160;      }</div><div class="line"><a name="l07716"></a><span class="lineno"> 7716</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l07717"></a><span class="lineno"> 7717</span>&#160;      snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;You have %d old&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>);</div><div class="line"><a name="l07718"></a><span class="lineno"> 7718</span>&#160;      snprintf(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>), <span class="stringliteral">&quot;%s.&quot;</span>, oldm);</div><div class="line"><a name="l07719"></a><span class="lineno"> 7719</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07720"></a><span class="lineno"> 7720</span>&#160;      strcpy(buf1, <span class="stringliteral">&quot;You have no messages.&quot;</span>);</div><div class="line"><a name="l07721"></a><span class="lineno"> 7721</span>&#160;      <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>[0] = <span class="charliteral">&#39; &#39;</span>;</div><div class="line"><a name="l07722"></a><span class="lineno"> 7722</span>&#160;      <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l07723"></a><span class="lineno"> 7723</span>&#160;   }</div><div class="line"><a name="l07724"></a><span class="lineno"> 7724</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf1, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07725"></a><span class="lineno"> 7725</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07726"></a><span class="lineno"> 7726</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07727"></a><span class="lineno"> 7727</span>&#160;</div><div class="line"><a name="l07728"></a><span class="lineno"> 7728</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 6; x++)</div><div class="line"><a name="l07729"></a><span class="lineno"> 7729</span>&#160;      keys[x] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + x);</div><div class="line"><a name="l07730"></a><span class="lineno"> 7730</span>&#160;   keys[6] = 0;</div><div class="line"><a name="l07731"></a><span class="lineno"> 7731</span>&#160;   keys[7] = 0;</div><div class="line"><a name="l07732"></a><span class="lineno"> 7732</span>&#160;</div><div class="line"><a name="l07733"></a><span class="lineno"> 7733</span>&#160;   <span class="comment">/* Don&#39;t let them listen if there are none */</span></div><div class="line"><a name="l07734"></a><span class="lineno"> 7734</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0)</div><div class="line"><a name="l07735"></a><span class="lineno"> 7735</span>&#160;      keys[0] = 1;</div><div class="line"><a name="l07736"></a><span class="lineno"> 7736</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07737"></a><span class="lineno"> 7737</span>&#160;</div><div class="line"><a name="l07738"></a><span class="lineno"> 7738</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07739"></a><span class="lineno"> 7739</span>&#160;</div><div class="line"><a name="l07740"></a><span class="lineno"> 7740</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07741"></a><span class="lineno"> 7741</span>&#160;}</div><div class="line"><a name="l07742"></a><span class="lineno"> 7742</span>&#160;</div><div class="line"><a name="l07743"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353"> 7743</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353">adsi_status2</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l07744"></a><span class="lineno"> 7744</span>&#160;{</div><div class="line"><a name="l07745"></a><span class="lineno"> 7745</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l07746"></a><span class="lineno"> 7746</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../db/d09/func__realtime_8c.html#aef4a708d73ca36016d9360f84685350d">buf1</a>[256] = <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l07747"></a><span class="lineno"> 7747</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07748"></a><span class="lineno"> 7748</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/df1/structkeys.html">keys</a>[8];</div><div class="line"><a name="l07749"></a><span class="lineno"> 7749</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07750"></a><span class="lineno"> 7750</span>&#160;</div><div class="line"><a name="l07751"></a><span class="lineno"> 7751</span>&#160;   <span class="keywordtype">char</span> *mess = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> == 0) ? <span class="stringliteral">&quot;message&quot;</span> : <span class="stringliteral">&quot;messages&quot;</span>;</div><div class="line"><a name="l07752"></a><span class="lineno"> 7752</span>&#160;</div><div class="line"><a name="l07753"></a><span class="lineno"> 7753</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07754"></a><span class="lineno"> 7754</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07755"></a><span class="lineno"> 7755</span>&#160;</div><div class="line"><a name="l07756"></a><span class="lineno"> 7756</span>&#160;   <span class="comment">/* Original command keys */</span></div><div class="line"><a name="l07757"></a><span class="lineno"> 7757</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; 6; x++)</div><div class="line"><a name="l07758"></a><span class="lineno"> 7758</span>&#160;      keys[x] = <a class="code" href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + x);</div><div class="line"><a name="l07759"></a><span class="lineno"> 7759</span>&#160;</div><div class="line"><a name="l07760"></a><span class="lineno"> 7760</span>&#160;   keys[6] = 0;</div><div class="line"><a name="l07761"></a><span class="lineno"> 7761</span>&#160;   keys[7] = 0;</div><div class="line"><a name="l07762"></a><span class="lineno"> 7762</span>&#160;</div><div class="line"><a name="l07763"></a><span class="lineno"> 7763</span>&#160;   <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1) &lt; 1)</div><div class="line"><a name="l07764"></a><span class="lineno"> 7764</span>&#160;      keys[0] = 0;</div><div class="line"><a name="l07765"></a><span class="lineno"> 7765</span>&#160;</div><div class="line"><a name="l07766"></a><span class="lineno"> 7766</span>&#160;   snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;%s%s has&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>,</div><div class="line"><a name="l07767"></a><span class="lineno"> 7767</span>&#160;      strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) ? <span class="stringliteral">&quot; folder&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07768"></a><span class="lineno"> 7768</span>&#160;</div><div class="line"><a name="l07769"></a><span class="lineno"> 7769</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1)</div><div class="line"><a name="l07770"></a><span class="lineno"> 7770</span>&#160;      snprintf(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>), <span class="stringliteral">&quot;%d %s.&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1, mess);</div><div class="line"><a name="l07771"></a><span class="lineno"> 7771</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l07772"></a><span class="lineno"> 7772</span>&#160;      strcpy(<a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="stringliteral">&quot;no messages.&quot;</span>);</div><div class="line"><a name="l07773"></a><span class="lineno"> 7773</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf1, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07774"></a><span class="lineno"> 7774</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <a class="code" href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07775"></a><span class="lineno"> 7775</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07776"></a><span class="lineno"> 7776</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07777"></a><span class="lineno"> 7777</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a>(buf + bytes, keys);</div><div class="line"><a name="l07778"></a><span class="lineno"> 7778</span>&#160;</div><div class="line"><a name="l07779"></a><span class="lineno"> 7779</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07780"></a><span class="lineno"> 7780</span>&#160;</div><div class="line"><a name="l07781"></a><span class="lineno"> 7781</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07782"></a><span class="lineno"> 7782</span>&#160;</div><div class="line"><a name="l07783"></a><span class="lineno"> 7783</span>&#160;}</div><div class="line"><a name="l07784"></a><span class="lineno"> 7784</span>&#160;</div><div class="line"><a name="l07785"></a><span class="lineno"> 7785</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l07786"></a><span class="lineno"> 7786</span>&#160;<span class="comment">static void adsi_clear(struct ast_channel *chan)</span></div><div class="line"><a name="l07787"></a><span class="lineno"> 7787</span>&#160;<span class="comment">{</span></div><div class="line"><a name="l07788"></a><span class="lineno"> 7788</span>&#160;<span class="comment">   char buf[256];</span></div><div class="line"><a name="l07789"></a><span class="lineno"> 7789</span>&#160;<span class="comment">   int bytes=0;</span></div><div class="line"><a name="l07790"></a><span class="lineno"> 7790</span>&#160;<span class="comment">   if (!ast_adsi_available(chan))</span></div><div class="line"><a name="l07791"></a><span class="lineno"> 7791</span>&#160;<span class="comment">      return;</span></div><div class="line"><a name="l07792"></a><span class="lineno"> 7792</span>&#160;<span class="comment">   bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span></div><div class="line"><a name="l07793"></a><span class="lineno"> 7793</span>&#160;<span class="comment">   bytes += ast_adsi_voice_mode(buf + bytes, 0);</span></div><div class="line"><a name="l07794"></a><span class="lineno"> 7794</span>&#160;<span class="comment"></span></div><div class="line"><a name="l07795"></a><span class="lineno"> 7795</span>&#160;<span class="comment">   ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span></div><div class="line"><a name="l07796"></a><span class="lineno"> 7796</span>&#160;<span class="comment">}</span></div><div class="line"><a name="l07797"></a><span class="lineno"> 7797</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l07798"></a><span class="lineno"> 7798</span>&#160;</div><div class="line"><a name="l07799"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa"> 7799</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa">adsi_goodbye</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan)</div><div class="line"><a name="l07800"></a><span class="lineno"> 7800</span>&#160;{</div><div class="line"><a name="l07801"></a><span class="lineno"> 7801</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l07802"></a><span class="lineno"> 7802</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l07803"></a><span class="lineno"> 7803</span>&#160;</div><div class="line"><a name="l07804"></a><span class="lineno"> 7804</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan))</div><div class="line"><a name="l07805"></a><span class="lineno"> 7805</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l07806"></a><span class="lineno"> 7806</span>&#160;   bytes += <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);</div><div class="line"><a name="l07807"></a><span class="lineno"> 7807</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07808"></a><span class="lineno"> 7808</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Goodbye&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l07809"></a><span class="lineno"> 7809</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l07810"></a><span class="lineno"> 7810</span>&#160;   bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l07811"></a><span class="lineno"> 7811</span>&#160;</div><div class="line"><a name="l07812"></a><span class="lineno"> 7812</span>&#160;   <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l07813"></a><span class="lineno"> 7813</span>&#160;}</div><div class="line"><a name="l07814"></a><span class="lineno"> 7814</span>&#160;<span class="comment"></span></div><div class="line"><a name="l07815"></a><span class="lineno"> 7815</span>&#160;<span class="comment">/*!\brief get_folder: Folder menu</span></div><div class="line"><a name="l07816"></a><span class="lineno"> 7816</span>&#160;<span class="comment"> * Plays &quot;press 1 for INBOX messages&quot; etc.</span></div><div class="line"><a name="l07817"></a><span class="lineno"> 7817</span>&#160;<span class="comment"> * Should possibly be internationalized</span></div><div class="line"><a name="l07818"></a><span class="lineno"> 7818</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l07819"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5"> 7819</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5">get_folder</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> start)</div><div class="line"><a name="l07820"></a><span class="lineno"> 7820</span>&#160;{</div><div class="line"><a name="l07821"></a><span class="lineno"> 7821</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07822"></a><span class="lineno"> 7822</span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07823"></a><span class="lineno"> 7823</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07824"></a><span class="lineno"> 7824</span>&#160;   d = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-press&quot;</span>);  <span class="comment">/* &quot;Press&quot; */</span></div><div class="line"><a name="l07825"></a><span class="lineno"> 7825</span>&#160;   <span class="keywordflow">if</span> (d)</div><div class="line"><a name="l07826"></a><span class="lineno"> 7826</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07827"></a><span class="lineno"> 7827</span>&#160;   <span class="keywordflow">for</span> (x = start; x &lt; 5; x++) { <span class="comment">/* For all folders */</span></div><div class="line"><a name="l07828"></a><span class="lineno"> 7828</span>&#160;      <span class="keywordflow">if</span> ((d = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, x, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))</div><div class="line"><a name="l07829"></a><span class="lineno"> 7829</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07830"></a><span class="lineno"> 7830</span>&#160;      d = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-for&quot;</span>); <span class="comment">/* &quot;for&quot; */</span></div><div class="line"><a name="l07831"></a><span class="lineno"> 7831</span>&#160;      <span class="keywordflow">if</span> (d)</div><div class="line"><a name="l07832"></a><span class="lineno"> 7832</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07833"></a><span class="lineno"> 7833</span>&#160;      snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x));  <span class="comment">/* Folder name */</span></div><div class="line"><a name="l07834"></a><span class="lineno"> 7834</span>&#160;</div><div class="line"><a name="l07835"></a><span class="lineno"> 7835</span>&#160;      <span class="comment">/* The inbox folder can have its name changed under certain conditions</span></div><div class="line"><a name="l07836"></a><span class="lineno"> 7836</span>&#160;<span class="comment">       * so this checks if the sound file exists for the inbox folder name and</span></div><div class="line"><a name="l07837"></a><span class="lineno"> 7837</span>&#160;<span class="comment">       * if it doesn&#39;t, plays the default name instead. */</span></div><div class="line"><a name="l07838"></a><span class="lineno"> 7838</span>&#160;      <span class="keywordflow">if</span> (x == 0) {</div><div class="line"><a name="l07839"></a><span class="lineno"> 7839</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l07840"></a><span class="lineno"> 7840</span>&#160;            d = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, fn);</div><div class="line"><a name="l07841"></a><span class="lineno"> 7841</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07842"></a><span class="lineno"> 7842</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Failed to find file %s; falling back to INBOX\n&quot;</span>, fn);</div><div class="line"><a name="l07843"></a><span class="lineno"> 7843</span>&#160;            d = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l07844"></a><span class="lineno"> 7844</span>&#160;         }</div><div class="line"><a name="l07845"></a><span class="lineno"> 7845</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07846"></a><span class="lineno"> 7846</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>, <span class="stringliteral">&quot;Message: folder name %s&quot;</span>, fn);</div><div class="line"><a name="l07847"></a><span class="lineno"> 7847</span>&#160;         d = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, fn);</div><div class="line"><a name="l07848"></a><span class="lineno"> 7848</span>&#160;      }</div><div class="line"><a name="l07849"></a><span class="lineno"> 7849</span>&#160;</div><div class="line"><a name="l07850"></a><span class="lineno"> 7850</span>&#160;      <span class="keywordflow">if</span> (d)</div><div class="line"><a name="l07851"></a><span class="lineno"> 7851</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07852"></a><span class="lineno"> 7852</span>&#160;      d = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 500);</div><div class="line"><a name="l07853"></a><span class="lineno"> 7853</span>&#160;      <span class="keywordflow">if</span> (d)</div><div class="line"><a name="l07854"></a><span class="lineno"> 7854</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07855"></a><span class="lineno"> 7855</span>&#160;   }</div><div class="line"><a name="l07856"></a><span class="lineno"> 7856</span>&#160;</div><div class="line"><a name="l07857"></a><span class="lineno"> 7857</span>&#160;   d = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocancel&quot;</span>); <span class="comment">/* &quot;or pound to cancel&quot; */</span></div><div class="line"><a name="l07858"></a><span class="lineno"> 7858</span>&#160;   <span class="keywordflow">if</span> (d)</div><div class="line"><a name="l07859"></a><span class="lineno"> 7859</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07860"></a><span class="lineno"> 7860</span>&#160;   d = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 4000);</div><div class="line"><a name="l07861"></a><span class="lineno"> 7861</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07862"></a><span class="lineno"> 7862</span>&#160;}</div><div class="line"><a name="l07863"></a><span class="lineno"> 7863</span>&#160;</div><div class="line"><a name="l07864"></a><span class="lineno"> 7864</span>&#160;<span class="comment">/* Japanese Syntax */</span></div><div class="line"><a name="l07865"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5609ea8da6381561640e886177df9640"> 7865</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5609ea8da6381561640e886177df9640">get_folder_ja</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> start)</div><div class="line"><a name="l07866"></a><span class="lineno"> 7866</span>&#160;{</div><div class="line"><a name="l07867"></a><span class="lineno"> 7867</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l07868"></a><span class="lineno"> 7868</span>&#160;   <span class="keywordtype">int</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07869"></a><span class="lineno"> 7869</span>&#160;   <span class="keywordtype">char</span> fn[256];</div><div class="line"><a name="l07870"></a><span class="lineno"> 7870</span>&#160;   <span class="keywordflow">for</span> (x = start; x &lt; 5; x++) {    <span class="comment">/* For all folders */</span></div><div class="line"><a name="l07871"></a><span class="lineno"> 7871</span>&#160;      <span class="keywordflow">if</span> ((d = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, x, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), (<span class="keywordtype">char</span> *) <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l07872"></a><span class="lineno"> 7872</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07873"></a><span class="lineno"> 7873</span>&#160;      }</div><div class="line"><a name="l07874"></a><span class="lineno"> 7874</span>&#160;      snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(NULL, x));     <span class="comment">/* Folder name */</span></div><div class="line"><a name="l07875"></a><span class="lineno"> 7875</span>&#160;      d = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, fn);</div><div class="line"><a name="l07876"></a><span class="lineno"> 7876</span>&#160;      <span class="keywordflow">if</span> (d) {</div><div class="line"><a name="l07877"></a><span class="lineno"> 7877</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07878"></a><span class="lineno"> 7878</span>&#160;      }</div><div class="line"><a name="l07879"></a><span class="lineno"> 7879</span>&#160;      d = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 500);</div><div class="line"><a name="l07880"></a><span class="lineno"> 7880</span>&#160;      <span class="keywordflow">if</span> (d) {</div><div class="line"><a name="l07881"></a><span class="lineno"> 7881</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07882"></a><span class="lineno"> 7882</span>&#160;      }</div><div class="line"><a name="l07883"></a><span class="lineno"> 7883</span>&#160;   }</div><div class="line"><a name="l07884"></a><span class="lineno"> 7884</span>&#160;   d = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocancel&quot;</span>); <span class="comment">/* &quot;or pound to cancel&quot; */</span></div><div class="line"><a name="l07885"></a><span class="lineno"> 7885</span>&#160;   <span class="keywordflow">if</span> (d) {</div><div class="line"><a name="l07886"></a><span class="lineno"> 7886</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07887"></a><span class="lineno"> 7887</span>&#160;   }</div><div class="line"><a name="l07888"></a><span class="lineno"> 7888</span>&#160;   d = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 4000);</div><div class="line"><a name="l07889"></a><span class="lineno"> 7889</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line"><a name="l07890"></a><span class="lineno"> 7890</span>&#160;}</div><div class="line"><a name="l07891"></a><span class="lineno"> 7891</span>&#160;<span class="comment"></span></div><div class="line"><a name="l07892"></a><span class="lineno"> 7892</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l07893"></a><span class="lineno"> 7893</span>&#160;<span class="comment"> * \brief plays a prompt and waits for a keypress.</span></div><div class="line"><a name="l07894"></a><span class="lineno"> 7894</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l07895"></a><span class="lineno"> 7895</span>&#160;<span class="comment"> * \param fn the name of the voice prompt file to be played. For example, &#39;vm-changeto&#39;, &#39;vm-savefolder&#39;</span></div><div class="line"><a name="l07896"></a><span class="lineno"> 7896</span>&#160;<span class="comment"> * \param start Does not appear to be used at this time.</span></div><div class="line"><a name="l07897"></a><span class="lineno"> 7897</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l07898"></a><span class="lineno"> 7898</span>&#160;<span class="comment"> * This is used by the main menu option to move a message to a folder or to save a message into a folder.</span></div><div class="line"><a name="l07899"></a><span class="lineno"> 7899</span>&#160;<span class="comment"> * After playing the  message identified by the fn parameter value, it calls get_folder(), which plays the</span></div><div class="line"><a name="l07900"></a><span class="lineno"> 7900</span>&#160;<span class="comment"> * prompting for the number inputs that correspond to the available folders.</span></div><div class="line"><a name="l07901"></a><span class="lineno"> 7901</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l07902"></a><span class="lineno"> 7902</span>&#160;<span class="comment"> * \return zero on success, or -1 on error.</span></div><div class="line"><a name="l07903"></a><span class="lineno"> 7903</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l07904"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6"> 7904</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6">get_folder2</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *fn, <span class="keywordtype">int</span> start)</div><div class="line"><a name="l07905"></a><span class="lineno"> 7905</span>&#160;{</div><div class="line"><a name="l07906"></a><span class="lineno"> 7906</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l07907"></a><span class="lineno"> 7907</span>&#160;   <span class="keywordtype">int</span> loops = 0;</div><div class="line"><a name="l07908"></a><span class="lineno"> 7908</span>&#160;</div><div class="line"><a name="l07909"></a><span class="lineno"> 7909</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, fn);  <span class="comment">/* Folder name */</span></div><div class="line"><a name="l07910"></a><span class="lineno"> 7910</span>&#160;   <span class="keywordflow">while</span> (((res &lt; <span class="charliteral">&#39;0&#39;</span>) || (res &gt; <span class="charliteral">&#39;9&#39;</span>)) &amp;&amp;</div><div class="line"><a name="l07911"></a><span class="lineno"> 7911</span>&#160;         (res != <span class="charliteral">&#39;#&#39;</span>) &amp;&amp; (res &gt;= 0) &amp;&amp;</div><div class="line"><a name="l07912"></a><span class="lineno"> 7912</span>&#160;         loops &lt; 4) {</div><div class="line"><a name="l07913"></a><span class="lineno"> 7913</span>&#160;      <span class="comment">/* res = get_folder(chan, 0); */</span></div><div class="line"><a name="l07914"></a><span class="lineno"> 7914</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ja&quot;</span>)) {   <span class="comment">/* Japanese syntax */</span></div><div class="line"><a name="l07915"></a><span class="lineno"> 7915</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5609ea8da6381561640e886177df9640">get_folder_ja</a>(chan, 0);</div><div class="line"><a name="l07916"></a><span class="lineno"> 7916</span>&#160;      } <span class="keywordflow">else</span> { <span class="comment">/* Default syntax */</span></div><div class="line"><a name="l07917"></a><span class="lineno"> 7917</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5">get_folder</a>(chan, 0);</div><div class="line"><a name="l07918"></a><span class="lineno"> 7918</span>&#160;      }</div><div class="line"><a name="l07919"></a><span class="lineno"> 7919</span>&#160;      loops++;</div><div class="line"><a name="l07920"></a><span class="lineno"> 7920</span>&#160;   }</div><div class="line"><a name="l07921"></a><span class="lineno"> 7921</span>&#160;   <span class="keywordflow">if</span> (loops == 4) { <span class="comment">/* give up */</span></div><div class="line"><a name="l07922"></a><span class="lineno"> 7922</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>, <span class="charliteral">&#39;#&#39;</span>, <span class="charliteral">&#39;#&#39;</span>);</div><div class="line"><a name="l07923"></a><span class="lineno"> 7923</span>&#160;      <span class="keywordflow">return</span> <span class="charliteral">&#39;#&#39;</span>;</div><div class="line"><a name="l07924"></a><span class="lineno"> 7924</span>&#160;   }</div><div class="line"><a name="l07925"></a><span class="lineno"> 7925</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l07926"></a><span class="lineno"> 7926</span>&#160;      isprint(res) ? res : <span class="charliteral">&#39;?&#39;</span>, isprint(res) ? res : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l07927"></a><span class="lineno"> 7927</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l07928"></a><span class="lineno"> 7928</span>&#160;}</div><div class="line"><a name="l07929"></a><span class="lineno"> 7929</span>&#160;<span class="comment"></span></div><div class="line"><a name="l07930"></a><span class="lineno"> 7930</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l07931"></a><span class="lineno"> 7931</span>&#160;<span class="comment"> * \brief presents the option to prepend to an existing message when forwarding it.</span></div><div class="line"><a name="l07932"></a><span class="lineno"> 7932</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l07933"></a><span class="lineno"> 7933</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l07934"></a><span class="lineno"> 7934</span>&#160;<span class="comment"> * \param curdir</span></div><div class="line"><a name="l07935"></a><span class="lineno"> 7935</span>&#160;<span class="comment"> * \param curmsg</span></div><div class="line"><a name="l07936"></a><span class="lineno"> 7936</span>&#160;<span class="comment"> * \param vm_fmts</span></div><div class="line"><a name="l07937"></a><span class="lineno"> 7937</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l07938"></a><span class="lineno"> 7938</span>&#160;<span class="comment"> * \param record_gain</span></div><div class="line"><a name="l07939"></a><span class="lineno"> 7939</span>&#160;<span class="comment"> * \param duration</span></div><div class="line"><a name="l07940"></a><span class="lineno"> 7940</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l07941"></a><span class="lineno"> 7941</span>&#160;<span class="comment"> * \param flag</span></div><div class="line"><a name="l07942"></a><span class="lineno"> 7942</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l07943"></a><span class="lineno"> 7943</span>&#160;<span class="comment"> * Presents a prompt for 1 to prepend the current message, 2 to forward the message without prepending, or * to return to the main menu.</span></div><div class="line"><a name="l07944"></a><span class="lineno"> 7944</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l07945"></a><span class="lineno"> 7945</span>&#160;<span class="comment"> * This is invoked from forward_message() when performing a forward operation (option 8 from main menu).</span></div><div class="line"><a name="l07946"></a><span class="lineno"> 7946</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l07947"></a><span class="lineno"> 7947</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l07948"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273"> 7948</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273">vm_forwardoptions</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *curdir, <span class="keywordtype">int</span> curmsg, <span class="keywordtype">char</span> *vm_fmts,</div><div class="line"><a name="l07949"></a><span class="lineno"> 7949</span>&#160;         <span class="keywordtype">char</span> *context, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain, <span class="keywordtype">long</span> *duration, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *flag)</div><div class="line"><a name="l07950"></a><span class="lineno"> 7950</span>&#160;{</div><div class="line"><a name="l07951"></a><span class="lineno"> 7951</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l07952"></a><span class="lineno"> 7952</span>&#160;   <span class="keywordtype">int</span> retries = 0, prepend_duration = 0, already_recorded = 0;</div><div class="line"><a name="l07953"></a><span class="lineno"> 7953</span>&#160;   <span class="keywordtype">char</span> msgfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], backup[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], backup_textfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07954"></a><span class="lineno"> 7954</span>&#160;   <span class="keywordtype">char</span> textfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l07955"></a><span class="lineno"> 7955</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l07956"></a><span class="lineno"> 7956</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l07957"></a><span class="lineno"> 7957</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l07958"></a><span class="lineno"> 7958</span>&#160;   <span class="keywordtype">signed</span> <span class="keywordtype">char</span> zero_gain = 0;</div><div class="line"><a name="l07959"></a><span class="lineno"> 7959</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l07960"></a><span class="lineno"> 7960</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l07961"></a><span class="lineno"> 7961</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l07962"></a><span class="lineno"> 7962</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *duration_str;</div><div class="line"><a name="l07963"></a><span class="lineno"> 7963</span>&#160;</div><div class="line"><a name="l07964"></a><span class="lineno"> 7964</span>&#160;   <span class="comment">/* Must always populate duration correctly */</span></div><div class="line"><a name="l07965"></a><span class="lineno"> 7965</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), curdir, curmsg);</div><div class="line"><a name="l07966"></a><span class="lineno"> 7966</span>&#160;   strcpy(textfile, msgfile);</div><div class="line"><a name="l07967"></a><span class="lineno"> 7967</span>&#160;   strcpy(backup, msgfile);</div><div class="line"><a name="l07968"></a><span class="lineno"> 7968</span>&#160;   strcpy(backup_textfile, msgfile);</div><div class="line"><a name="l07969"></a><span class="lineno"> 7969</span>&#160;   strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - strlen(textfile) - 1);</div><div class="line"><a name="l07970"></a><span class="lineno"> 7970</span>&#160;   strncat(backup, <span class="stringliteral">&quot;-bak&quot;</span>, <span class="keyword">sizeof</span>(backup) - strlen(backup) - 1);</div><div class="line"><a name="l07971"></a><span class="lineno"> 7971</span>&#160;   strncat(backup_textfile, <span class="stringliteral">&quot;-bak.txt&quot;</span>, <span class="keyword">sizeof</span>(backup_textfile) - strlen(backup_textfile) - 1);</div><div class="line"><a name="l07972"></a><span class="lineno"> 7972</span>&#160;</div><div class="line"><a name="l07973"></a><span class="lineno"> 7973</span>&#160;   <span class="keywordflow">if</span> ((msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(textfile, config_flags)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg) &amp;&amp; (duration_str = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {</div><div class="line"><a name="l07974"></a><span class="lineno"> 7974</span>&#160;      *duration = atoi(duration_str);</div><div class="line"><a name="l07975"></a><span class="lineno"> 7975</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l07976"></a><span class="lineno"> 7976</span>&#160;      *duration = 0;</div><div class="line"><a name="l07977"></a><span class="lineno"> 7977</span>&#160;   }</div><div class="line"><a name="l07978"></a><span class="lineno"> 7978</span>&#160;</div><div class="line"><a name="l07979"></a><span class="lineno"> 7979</span>&#160;   <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>) &amp;&amp; (cmd != <span class="charliteral">&#39;*&#39;</span>)) {</div><div class="line"><a name="l07980"></a><span class="lineno"> 7980</span>&#160;      <span class="keywordflow">if</span> (cmd)</div><div class="line"><a name="l07981"></a><span class="lineno"> 7981</span>&#160;         retries = 0;</div><div class="line"><a name="l07982"></a><span class="lineno"> 7982</span>&#160;      <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l07983"></a><span class="lineno"> 7983</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:</div><div class="line"><a name="l07984"></a><span class="lineno"> 7984</span>&#160;</div><div class="line"><a name="l07985"></a><span class="lineno"> 7985</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l07986"></a><span class="lineno"> 7986</span>&#160;         <span class="comment">/* Record new intro file */</span></div><div class="line"><a name="l07987"></a><span class="lineno"> 7987</span>&#160;         <span class="keywordflow">if</span> (msg_cfg &amp;&amp; msg_cfg != <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l07988"></a><span class="lineno"> 7988</span>&#160;            msg_id = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;msg_id&quot;</span>);</div><div class="line"><a name="l07989"></a><span class="lineno"> 7989</span>&#160;         }</div><div class="line"><a name="l07990"></a><span class="lineno"> 7990</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;introfn, <span class="keyword">sizeof</span>(vms-&gt;introfn), curdir, curmsg);</div><div class="line"><a name="l07991"></a><span class="lineno"> 7991</span>&#160;         strncat(vms-&gt;introfn, <span class="stringliteral">&quot;intro&quot;</span>, <span class="keyword">sizeof</span>(vms-&gt;introfn));</div><div class="line"><a name="l07992"></a><span class="lineno"> 7992</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-record-prepend&quot;</span>);</div><div class="line"><a name="l07993"></a><span class="lineno"> 7993</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>);</div><div class="line"><a name="l07994"></a><span class="lineno"> 7994</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vms-&gt;introfn, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>, vm_fmts, 1, vmu, (<span class="keywordtype">int</span> *) duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, flag, msg_id, 1);</div><div class="line"><a name="l07995"></a><span class="lineno"> 7995</span>&#160;         <span class="keywordflow">if</span> (cmd == -1) {</div><div class="line"><a name="l07996"></a><span class="lineno"> 7996</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l07997"></a><span class="lineno"> 7997</span>&#160;         }</div><div class="line"><a name="l07998"></a><span class="lineno"> 7998</span>&#160;         cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l07999"></a><span class="lineno"> 7999</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l08000"></a><span class="lineno"> 8000</span>&#160;</div><div class="line"><a name="l08001"></a><span class="lineno"> 8001</span>&#160;         <span class="comment">/* prepend a message to the current message, update the metadata and return */</span></div><div class="line"><a name="l08002"></a><span class="lineno"> 8002</span>&#160;</div><div class="line"><a name="l08003"></a><span class="lineno"> 8003</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), curdir, curmsg);</div><div class="line"><a name="l08004"></a><span class="lineno"> 8004</span>&#160;         strcpy(textfile, msgfile);</div><div class="line"><a name="l08005"></a><span class="lineno"> 8005</span>&#160;         strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - 1);</div><div class="line"><a name="l08006"></a><span class="lineno"> 8006</span>&#160;         *duration = 0;</div><div class="line"><a name="l08007"></a><span class="lineno"> 8007</span>&#160;</div><div class="line"><a name="l08008"></a><span class="lineno"> 8008</span>&#160;         <span class="comment">/* if we can&#39;t read the message metadata, stop now */</span></div><div class="line"><a name="l08009"></a><span class="lineno"> 8009</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg)) {</div><div class="line"><a name="l08010"></a><span class="lineno"> 8010</span>&#160;            cmd = 0;</div><div class="line"><a name="l08011"></a><span class="lineno"> 8011</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08012"></a><span class="lineno"> 8012</span>&#160;         }</div><div class="line"><a name="l08013"></a><span class="lineno"> 8013</span>&#160;</div><div class="line"><a name="l08014"></a><span class="lineno"> 8014</span>&#160;         <span class="comment">/* Back up the original file, so we can retry the prepend and restore it after forward. */</span></div><div class="line"><a name="l08015"></a><span class="lineno"> 8015</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l08016"></a><span class="lineno"> 8016</span>&#160;         <span class="keywordflow">if</span> (already_recorded) {</div><div class="line"><a name="l08017"></a><span class="lineno"> 8017</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b">ast_filecopy</a>(backup, msgfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08018"></a><span class="lineno"> 8018</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>(backup_textfile, textfile);</div><div class="line"><a name="l08019"></a><span class="lineno"> 8019</span>&#160;         }</div><div class="line"><a name="l08020"></a><span class="lineno"> 8020</span>&#160;         <span class="keywordflow">else</span> {</div><div class="line"><a name="l08021"></a><span class="lineno"> 8021</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b">ast_filecopy</a>(msgfile, backup, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08022"></a><span class="lineno"> 8022</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>(textfile, backup_textfile);</div><div class="line"><a name="l08023"></a><span class="lineno"> 8023</span>&#160;         }</div><div class="line"><a name="l08024"></a><span class="lineno"> 8024</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08025"></a><span class="lineno"> 8025</span>&#160;         already_recorded = 1;</div><div class="line"><a name="l08026"></a><span class="lineno"> 8026</span>&#160;</div><div class="line"><a name="l08027"></a><span class="lineno"> 8027</span>&#160;         <span class="keywordflow">if</span> (record_gain)</div><div class="line"><a name="l08028"></a><span class="lineno"> 8028</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#adcfd8d241b6de48068ead143ac29978d">ast_channel_setoption</a>(chan, <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;record_gain, <span class="keyword">sizeof</span>(record_gain), 0);</div><div class="line"><a name="l08029"></a><span class="lineno"> 8029</span>&#160;</div><div class="line"><a name="l08030"></a><span class="lineno"> 8030</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a6c0c71b2a228214f089f4516a4d91793">ast_play_and_prepend</a>(chan, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, msgfile, 0, vm_fmts, &amp;prepend_duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1, silencethreshold, maxsilence);</div><div class="line"><a name="l08031"></a><span class="lineno"> 8031</span>&#160;</div><div class="line"><a name="l08032"></a><span class="lineno"> 8032</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;S&#39;</span>) { <span class="comment">/* If we timed out, tell the user it didn&#39;t work properly and clean up the files */</span></div><div class="line"><a name="l08033"></a><span class="lineno"> 8033</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, vm_pls_try_again, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">/* this might be removed if a proper vm_prepend_timeout is ever recorded */</span></div><div class="line"><a name="l08034"></a><span class="lineno"> 8034</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, vm_prepend_timeout, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l08035"></a><span class="lineno"> 8035</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(backup, msgfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08036"></a><span class="lineno"> 8036</span>&#160;         }</div><div class="line"><a name="l08037"></a><span class="lineno"> 8037</span>&#160;</div><div class="line"><a name="l08038"></a><span class="lineno"> 8038</span>&#160;         <span class="keywordflow">if</span> (record_gain)</div><div class="line"><a name="l08039"></a><span class="lineno"> 8039</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#adcfd8d241b6de48068ead143ac29978d">ast_channel_setoption</a>(chan, <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;zero_gain, <span class="keyword">sizeof</span>(zero_gain), 0);</div><div class="line"><a name="l08040"></a><span class="lineno"> 8040</span>&#160;</div><div class="line"><a name="l08041"></a><span class="lineno"> 8041</span>&#160;</div><div class="line"><a name="l08042"></a><span class="lineno"> 8042</span>&#160;         <span class="keywordflow">if</span> ((duration_str = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>)))</div><div class="line"><a name="l08043"></a><span class="lineno"> 8043</span>&#160;            *duration = atoi(duration_str);</div><div class="line"><a name="l08044"></a><span class="lineno"> 8044</span>&#160;</div><div class="line"><a name="l08045"></a><span class="lineno"> 8045</span>&#160;         <span class="keywordflow">if</span> (prepend_duration) {</div><div class="line"><a name="l08046"></a><span class="lineno"> 8046</span>&#160;            <span class="keyword">struct </span><a class="code" href="../../d7/db2/structast__category.html">ast_category</a> *msg_cat;</div><div class="line"><a name="l08047"></a><span class="lineno"> 8047</span>&#160;            <span class="comment">/* need enough space for a maximum-length message duration */</span></div><div class="line"><a name="l08048"></a><span class="lineno"> 8048</span>&#160;            <span class="keywordtype">char</span> duration_buf[12];</div><div class="line"><a name="l08049"></a><span class="lineno"> 8049</span>&#160;</div><div class="line"><a name="l08050"></a><span class="lineno"> 8050</span>&#160;            *duration += prepend_duration;</div><div class="line"><a name="l08051"></a><span class="lineno"> 8051</span>&#160;            msg_cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a976052ba6bdad7e94e60cd4bc1c3f3b2">ast_category_get</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08052"></a><span class="lineno"> 8052</span>&#160;            snprintf(duration_buf, <span class="keyword">sizeof</span>(duration_buf), <span class="stringliteral">&quot;%ld&quot;</span>, *duration);</div><div class="line"><a name="l08053"></a><span class="lineno"> 8053</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8">ast_variable_update</a>(msg_cat, <span class="stringliteral">&quot;duration&quot;</span>, duration_buf, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)) {</div><div class="line"><a name="l08054"></a><span class="lineno"> 8054</span>&#160;               <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(textfile, msg_cfg, <span class="stringliteral">&quot;app_voicemail&quot;</span>);</div><div class="line"><a name="l08055"></a><span class="lineno"> 8055</span>&#160;            }</div><div class="line"><a name="l08056"></a><span class="lineno"> 8056</span>&#160;         }</div><div class="line"><a name="l08057"></a><span class="lineno"> 8057</span>&#160;</div><div class="line"><a name="l08058"></a><span class="lineno"> 8058</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08059"></a><span class="lineno"> 8059</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l08060"></a><span class="lineno"> 8060</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:</div><div class="line"><a name="l08061"></a><span class="lineno"> 8061</span>&#160;         <span class="comment">/* NULL out introfile so we know there is no intro! */</span></div><div class="line"><a name="l08062"></a><span class="lineno"> 8062</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08063"></a><span class="lineno"> 8063</span>&#160;         *vms-&gt;introfn = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l08064"></a><span class="lineno"> 8064</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08065"></a><span class="lineno"> 8065</span>&#160;         cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l08066"></a><span class="lineno"> 8066</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l08067"></a><span class="lineno"> 8067</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l08068"></a><span class="lineno"> 8068</span>&#160;         cmd = <span class="charliteral">&#39;*&#39;</span>;</div><div class="line"><a name="l08069"></a><span class="lineno"> 8069</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l08070"></a><span class="lineno"> 8070</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l08071"></a><span class="lineno"> 8071</span>&#160;         <span class="comment">/* If time_out and return to menu, reset already_recorded */</span></div><div class="line"><a name="l08072"></a><span class="lineno"> 8072</span>&#160;         already_recorded = 0;</div><div class="line"><a name="l08073"></a><span class="lineno"> 8073</span>&#160;</div><div class="line"><a name="l08074"></a><span class="lineno"> 8074</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-forwardoptions&quot;</span>);</div><div class="line"><a name="l08075"></a><span class="lineno"> 8075</span>&#160;            <span class="comment">/* &quot;Press 1 to prepend a message or 2 to forward the message without prepending&quot; */</span></div><div class="line"><a name="l08076"></a><span class="lineno"> 8076</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l08077"></a><span class="lineno"> 8077</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starmain&quot;</span>);</div><div class="line"><a name="l08078"></a><span class="lineno"> 8078</span>&#160;            <span class="comment">/* &quot;press star to return to the main menu&quot; */</span></div><div class="line"><a name="l08079"></a><span class="lineno"> 8079</span>&#160;         }</div><div class="line"><a name="l08080"></a><span class="lineno"> 8080</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l08081"></a><span class="lineno"> 8081</span>&#160;            cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l08082"></a><span class="lineno"> 8082</span>&#160;         }</div><div class="line"><a name="l08083"></a><span class="lineno"> 8083</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l08084"></a><span class="lineno"> 8084</span>&#160;            retries++;</div><div class="line"><a name="l08085"></a><span class="lineno"> 8085</span>&#160;         }</div><div class="line"><a name="l08086"></a><span class="lineno"> 8086</span>&#160;         <span class="keywordflow">if</span> (retries &gt; 3) {</div><div class="line"><a name="l08087"></a><span class="lineno"> 8087</span>&#160;            cmd = <span class="charliteral">&#39;*&#39;</span>; <span class="comment">/* Let&#39;s cancel this beast */</span></div><div class="line"><a name="l08088"></a><span class="lineno"> 8088</span>&#160;         }</div><div class="line"><a name="l08089"></a><span class="lineno"> 8089</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l08090"></a><span class="lineno"> 8090</span>&#160;            isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l08091"></a><span class="lineno"> 8091</span>&#160;      }</div><div class="line"><a name="l08092"></a><span class="lineno"> 8092</span>&#160;   }</div><div class="line"><a name="l08093"></a><span class="lineno"> 8093</span>&#160;</div><div class="line"><a name="l08094"></a><span class="lineno"> 8094</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg))</div><div class="line"><a name="l08095"></a><span class="lineno"> 8095</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l08096"></a><span class="lineno"> 8096</span>&#160;   <span class="keywordflow">if</span> (prepend_duration)</div><div class="line"><a name="l08097"></a><span class="lineno"> 8097</span>&#160;      *duration = prepend_duration;</div><div class="line"><a name="l08098"></a><span class="lineno"> 8098</span>&#160;</div><div class="line"><a name="l08099"></a><span class="lineno"> 8099</span>&#160;   <span class="keywordflow">if</span> (already_recorded &amp;&amp; cmd == -1) {</div><div class="line"><a name="l08100"></a><span class="lineno"> 8100</span>&#160;      <span class="comment">/* restore original message if prepention cancelled */</span></div><div class="line"><a name="l08101"></a><span class="lineno"> 8101</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(backup, msgfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08102"></a><span class="lineno"> 8102</span>&#160;      rename(backup_textfile, textfile);</div><div class="line"><a name="l08103"></a><span class="lineno"> 8103</span>&#160;   }</div><div class="line"><a name="l08104"></a><span class="lineno"> 8104</span>&#160;</div><div class="line"><a name="l08105"></a><span class="lineno"> 8105</span>&#160;   <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;S&#39;</span>) <span class="comment">/* XXX entering this block with a value of &#39;S&#39; is probably no longer possible. */</span></div><div class="line"><a name="l08106"></a><span class="lineno"> 8106</span>&#160;      cmd = 0;</div><div class="line"><a name="l08107"></a><span class="lineno"> 8107</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l08108"></a><span class="lineno"> 8108</span>&#160;}</div><div class="line"><a name="l08109"></a><span class="lineno"> 8109</span>&#160;</div><div class="line"><a name="l08110"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4"> 8110</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *channel_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *box, <span class="keywordtype">int</span> urgent, <span class="keywordtype">int</span> <span class="keyword">new</span>, <span class="keywordtype">int</span> old)</div><div class="line"><a name="l08111"></a><span class="lineno"> 8111</span>&#160;{</div><div class="line"><a name="l08112"></a><span class="lineno"> 8112</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l08113"></a><span class="lineno"> 8113</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l08114"></a><span class="lineno"> 8114</span>&#160;</div><div class="line"><a name="l08115"></a><span class="lineno"> 8115</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(box), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l08116"></a><span class="lineno"> 8116</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l08117"></a><span class="lineno"> 8117</span>&#160;   }</div><div class="line"><a name="l08118"></a><span class="lineno"> 8118</span>&#160;</div><div class="line"><a name="l08119"></a><span class="lineno"> 8119</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Queueing event for mailbox %s  New: %d   Old: %d\n&quot;</span>, box, <span class="keyword">new</span> + urgent, old);</div><div class="line"><a name="l08120"></a><span class="lineno"> 8120</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#a3cbb94b9d65cd0a9beb2276292946a61">ast_publish_mwi_state_channel</a>(mailbox, context, <span class="keyword">new</span> + urgent, old, channel_id);</div><div class="line"><a name="l08121"></a><span class="lineno"> 8121</span>&#160;</div><div class="line"><a name="l08122"></a><span class="lineno"> 8122</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(aliasescontext)) {</div><div class="line"><a name="l08123"></a><span class="lineno"> 8123</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d9/d97/structao2__iterator.html">ao2_iterator</a> *<a class="code" href="../../d5/dfe/chan__sip_8c.html#a6763e6050c81d7501cebb1d4b1fc0970">aliases</a>;</div><div class="line"><a name="l08124"></a><span class="lineno"> 8124</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d0/d11/structmailbox__alias__mapping.html">mailbox_alias_mapping</a> *mapping;</div><div class="line"><a name="l08125"></a><span class="lineno"> 8125</span>&#160;</div><div class="line"><a name="l08126"></a><span class="lineno"> 8126</span>&#160;      aliases = <a class="code" href="../../d5/da5/astobj2_8h.html#a911e0703891a9a7aaf73978152092586">ao2_find</a>(mailbox_alias_mappings, box, <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35caa13a6e0771cc457e86f425d95c3b8d54">OBJ_SEARCH_KEY</a> | <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>);</div><div class="line"><a name="l08127"></a><span class="lineno"> 8127</span>&#160;      <span class="keywordflow">while</span> ((mapping = <a class="code" href="../../d5/da5/astobj2_8h.html#a17990ea630db7dbd1252ef0132133a2b">ao2_iterator_next</a>(aliases))) {</div><div class="line"><a name="l08128"></a><span class="lineno"> 8128</span>&#160;         <span class="keywordtype">char</span> <a class="code" href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">alias</a>[strlen(mapping-&gt;<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">alias</a>) + 1];</div><div class="line"><a name="l08129"></a><span class="lineno"> 8129</span>&#160;         strcpy(alias, mapping-&gt;<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">alias</a>); <span class="comment">/* safe */</span></div><div class="line"><a name="l08130"></a><span class="lineno"> 8130</span>&#160;         mailbox = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l08131"></a><span class="lineno"> 8131</span>&#160;         context = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l08132"></a><span class="lineno"> 8132</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Found alias mapping: %s -&gt; %s\n&quot;</span>, mapping-&gt;<a class="code" href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">alias</a>, box);</div><div class="line"><a name="l08133"></a><span class="lineno"> 8133</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(alias, &amp;mailbox, &amp;context);</div><div class="line"><a name="l08134"></a><span class="lineno"> 8134</span>&#160;         <a class="code" href="../../dc/d33/mwi_8h.html#a3cbb94b9d65cd0a9beb2276292946a61">ast_publish_mwi_state_channel</a>(mailbox, context, <span class="keyword">new</span> + urgent, old, channel_id);</div><div class="line"><a name="l08135"></a><span class="lineno"> 8135</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mapping, -1);</div><div class="line"><a name="l08136"></a><span class="lineno"> 8136</span>&#160;      }</div><div class="line"><a name="l08137"></a><span class="lineno"> 8137</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#ad36841ab6daa3997f7ca7047ad2d033a">ao2_iterator_destroy</a>(aliases);</div><div class="line"><a name="l08138"></a><span class="lineno"> 8138</span>&#160;   }</div><div class="line"><a name="l08139"></a><span class="lineno"> 8139</span>&#160;}</div><div class="line"><a name="l08140"></a><span class="lineno"> 8140</span>&#160;<span class="comment"></span></div><div class="line"><a name="l08141"></a><span class="lineno"> 8141</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l08142"></a><span class="lineno"> 8142</span>&#160;<span class="comment"> * \brief Sends email notification that a user has a new voicemail waiting for them.</span></div><div class="line"><a name="l08143"></a><span class="lineno"> 8143</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l08144"></a><span class="lineno"> 8144</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l08145"></a><span class="lineno"> 8145</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l08146"></a><span class="lineno"> 8146</span>&#160;<span class="comment"> * \param msgnum</span></div><div class="line"><a name="l08147"></a><span class="lineno"> 8147</span>&#160;<span class="comment"> * \param duration</span></div><div class="line"><a name="l08148"></a><span class="lineno"> 8148</span>&#160;<span class="comment"> * \param fmt</span></div><div class="line"><a name="l08149"></a><span class="lineno"> 8149</span>&#160;<span class="comment"> * \param cidnum The Caller ID phone number value.</span></div><div class="line"><a name="l08150"></a><span class="lineno"> 8150</span>&#160;<span class="comment"> * \param cidname The Caller ID name value.</span></div><div class="line"><a name="l08151"></a><span class="lineno"> 8151</span>&#160;<span class="comment"> * \param flag</span></div><div class="line"><a name="l08152"></a><span class="lineno"> 8152</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l08153"></a><span class="lineno"> 8153</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l08154"></a><span class="lineno"> 8154</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l08155"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158"> 8155</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">notify_new_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)</div><div class="line"><a name="l08156"></a><span class="lineno"> 8156</span>&#160;{</div><div class="line"><a name="l08157"></a><span class="lineno"> 8157</span>&#160;   <span class="keywordtype">char</span> todir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], ext_context[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], *stringp;</div><div class="line"><a name="l08158"></a><span class="lineno"> 8158</span>&#160;   <span class="keywordtype">int</span> newmsgs = 0, oldmsgs = 0, urgentmsgs = 0;</div><div class="line"><a name="l08159"></a><span class="lineno"> 8159</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *category;</div><div class="line"><a name="l08160"></a><span class="lineno"> 8160</span>&#160;   <span class="keywordtype">char</span> *myserveremail = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;</div><div class="line"><a name="l08161"></a><span class="lineno"> 8161</span>&#160;</div><div class="line"><a name="l08162"></a><span class="lineno"> 8162</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#a493bdebe876caafb8ee535853310364a">ast_channel_lock</a>(chan);</div><div class="line"><a name="l08163"></a><span class="lineno"> 8163</span>&#160;   <span class="keywordflow">if</span> ((category = <a class="code" href="../../db/de0/pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;VM_CATEGORY&quot;</span>))) {</div><div class="line"><a name="l08164"></a><span class="lineno"> 8164</span>&#160;      category = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(category);</div><div class="line"><a name="l08165"></a><span class="lineno"> 8165</span>&#160;   }</div><div class="line"><a name="l08166"></a><span class="lineno"> 8166</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#af476c537b29be3f29240489032f9db39">ast_channel_unlock</a>(chan);</div><div class="line"><a name="l08167"></a><span class="lineno"> 8167</span>&#160;</div><div class="line"><a name="l08168"></a><span class="lineno"> 8168</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l08169"></a><span class="lineno"> 8169</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a>(todir, <span class="keyword">sizeof</span>(todir), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>) ? <span class="stringliteral">&quot;Urgent&quot;</span> : <span class="stringliteral">&quot;INBOX&quot;</span>);</div><div class="line"><a name="l08170"></a><span class="lineno"> 8170</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l08171"></a><span class="lineno"> 8171</span>&#160;   snprintf(todir, <span class="keyword">sizeof</span>(todir), <span class="stringliteral">&quot;%simap&quot;</span>, VM_SPOOL_DIR);</div><div class="line"><a name="l08172"></a><span class="lineno"> 8172</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08173"></a><span class="lineno"> 8173</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), todir, msgnum);</div><div class="line"><a name="l08174"></a><span class="lineno"> 8174</span>&#160;   snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l08175"></a><span class="lineno"> 8175</span>&#160;</div><div class="line"><a name="l08176"></a><span class="lineno"> 8176</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>)) {</div><div class="line"><a name="l08177"></a><span class="lineno"> 8177</span>&#160;      <span class="keywordflow">if</span> (strstr(fmt, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>))</div><div class="line"><a name="l08178"></a><span class="lineno"> 8178</span>&#160;         fmt = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>;</div><div class="line"><a name="l08179"></a><span class="lineno"> 8179</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l08180"></a><span class="lineno"> 8180</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Attachment format &#39;%s&#39; is not one of the recorded formats &#39;%s&#39;.  Falling back to default format for &#39;%s@%s&#39;.\n&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>, fmt, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l08181"></a><span class="lineno"> 8181</span>&#160;   }</div><div class="line"><a name="l08182"></a><span class="lineno"> 8182</span>&#160;</div><div class="line"><a name="l08183"></a><span class="lineno"> 8183</span>&#160;   <span class="comment">/* Attach only the first format */</span></div><div class="line"><a name="l08184"></a><span class="lineno"> 8184</span>&#160;   fmt = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(fmt);</div><div class="line"><a name="l08185"></a><span class="lineno"> 8185</span>&#160;   stringp = fmt;</div><div class="line"><a name="l08186"></a><span class="lineno"> 8186</span>&#160;   <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);</div><div class="line"><a name="l08187"></a><span class="lineno"> 8187</span>&#160;</div><div class="line"><a name="l08188"></a><span class="lineno"> 8188</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>))</div><div class="line"><a name="l08189"></a><span class="lineno"> 8189</span>&#160;      myserveremail = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;</div><div class="line"><a name="l08190"></a><span class="lineno"> 8190</span>&#160;</div><div class="line"><a name="l08191"></a><span class="lineno"> 8191</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>)) {</div><div class="line"><a name="l08192"></a><span class="lineno"> 8192</span>&#160;      <span class="keywordtype">int</span> attach_user_voicemail = <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);</div><div class="line"><a name="l08193"></a><span class="lineno"> 8193</span>&#160;      <span class="keywordtype">char</span> *msg_id = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l08194"></a><span class="lineno"> 8194</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08195"></a><span class="lineno"> 8195</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l08196"></a><span class="lineno"> 8196</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l08197"></a><span class="lineno"> 8197</span>&#160;      <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l08198"></a><span class="lineno"> 8198</span>&#160;</div><div class="line"><a name="l08199"></a><span class="lineno"> 8199</span>&#160;      snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);</div><div class="line"><a name="l08200"></a><span class="lineno"> 8200</span>&#160;      msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l08201"></a><span class="lineno"> 8201</span>&#160;      <span class="keywordflow">if</span> (msg_cfg &amp;&amp; msg_cfg != <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l08202"></a><span class="lineno"> 8202</span>&#160;         msg_id = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;msg_id&quot;</span>));</div><div class="line"><a name="l08203"></a><span class="lineno"> 8203</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l08204"></a><span class="lineno"> 8204</span>&#160;      }</div><div class="line"><a name="l08205"></a><span class="lineno"> 8205</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08206"></a><span class="lineno"> 8206</span>&#160;</div><div class="line"><a name="l08207"></a><span class="lineno"> 8207</span>&#160;      <span class="keywordflow">if</span> (attach_user_voicemail)</div><div class="line"><a name="l08208"></a><span class="lineno"> 8208</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(todir, msgnum, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l08209"></a><span class="lineno"> 8209</span>&#160;</div><div class="line"><a name="l08210"></a><span class="lineno"> 8210</span>&#160;      <span class="comment">/* XXX possible imap issue, should category be NULL XXX */</span></div><div class="line"><a name="l08211"></a><span class="lineno"> 8211</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3fd02e9399fad0b67dd0a7d6f4af464e">sendmail</a>(myserveremail, vmu, msgnum, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, 0), cidnum, cidname, fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fmt, duration, attach_user_voicemail, chan, category, flag, msg_id);</div><div class="line"><a name="l08212"></a><span class="lineno"> 8212</span>&#160;</div><div class="line"><a name="l08213"></a><span class="lineno"> 8213</span>&#160;      <span class="keywordflow">if</span> (attach_user_voicemail)</div><div class="line"><a name="l08214"></a><span class="lineno"> 8214</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(todir, msgnum);</div><div class="line"><a name="l08215"></a><span class="lineno"> 8215</span>&#160;   }</div><div class="line"><a name="l08216"></a><span class="lineno"> 8216</span>&#160;</div><div class="line"><a name="l08217"></a><span class="lineno"> 8217</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>)) {</div><div class="line"><a name="l08218"></a><span class="lineno"> 8218</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe">sendpage</a>(myserveremail, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, msgnum, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, 0), cidnum, cidname, duration, vmu, category, flag);</div><div class="line"><a name="l08219"></a><span class="lineno"> 8219</span>&#160;   }</div><div class="line"><a name="l08220"></a><span class="lineno"> 8220</span>&#160;</div><div class="line"><a name="l08221"></a><span class="lineno"> 8221</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>))</div><div class="line"><a name="l08222"></a><span class="lineno"> 8222</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(todir, msgnum, fn, vmu);</div><div class="line"><a name="l08223"></a><span class="lineno"> 8223</span>&#160;</div><div class="line"><a name="l08224"></a><span class="lineno"> 8224</span>&#160;   <span class="comment">/* Leave voicemail for someone */</span></div><div class="line"><a name="l08225"></a><span class="lineno"> 8225</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a76b4d3927cacd1bcd5da9ca8fe375cb6">ast_app_has_voicemail</a>(ext_context, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))</div><div class="line"><a name="l08226"></a><span class="lineno"> 8226</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ace2a3d783f4f79818e14265ae719f06c">ast_app_inboxcount2</a>(ext_context, &amp;urgentmsgs, &amp;newmsgs, &amp;oldmsgs);</div><div class="line"><a name="l08227"></a><span class="lineno"> 8227</span>&#160;</div><div class="line"><a name="l08228"></a><span class="lineno"> 8228</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a3b6254f6d3832ef928f0a727113b1c63">ast_channel_uniqueid</a>(chan), ext_context, urgentmsgs, newmsgs, oldmsgs);</div><div class="line"><a name="l08229"></a><span class="lineno"> 8229</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, flag);</div><div class="line"><a name="l08230"></a><span class="lineno"> 8230</span>&#160;</div><div class="line"><a name="l08231"></a><span class="lineno"> 8231</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08232"></a><span class="lineno"> 8232</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e">vm_delete</a>(fn);  <span class="comment">/* Delete the file, but not the IMAP message */</span></div><div class="line"><a name="l08233"></a><span class="lineno"> 8233</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>))  { <span class="comment">/* Delete the IMAP message if delete = yes */</span></div><div class="line"><a name="l08234"></a><span class="lineno"> 8234</span>&#160;      vm_imap_delete(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu);</div><div class="line"><a name="l08235"></a><span class="lineno"> 8235</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>--;  <span class="comment">/* Fix new message count */</span></div><div class="line"><a name="l08236"></a><span class="lineno"> 8236</span>&#160;   }</div><div class="line"><a name="l08237"></a><span class="lineno"> 8237</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08238"></a><span class="lineno"> 8238</span>&#160;</div><div class="line"><a name="l08239"></a><span class="lineno"> 8239</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l08240"></a><span class="lineno"> 8240</span>&#160;}</div><div class="line"><a name="l08241"></a><span class="lineno"> 8241</span>&#160;<span class="comment"></span></div><div class="line"><a name="l08242"></a><span class="lineno"> 8242</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l08243"></a><span class="lineno"> 8243</span>&#160;<span class="comment"> * \brief Sends a voicemail message to a mailbox recipient.</span></div><div class="line"><a name="l08244"></a><span class="lineno"> 8244</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l08245"></a><span class="lineno"> 8245</span>&#160;<span class="comment"> * \param context</span></div><div class="line"><a name="l08246"></a><span class="lineno"> 8246</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l08247"></a><span class="lineno"> 8247</span>&#160;<span class="comment"> * \param sender</span></div><div class="line"><a name="l08248"></a><span class="lineno"> 8248</span>&#160;<span class="comment"> * \param fmt</span></div><div class="line"><a name="l08249"></a><span class="lineno"> 8249</span>&#160;<span class="comment"> * \param is_new_message Used to indicate the mode for which this method was invoked.</span></div><div class="line"><a name="l08250"></a><span class="lineno"> 8250</span>&#160;<span class="comment"> *             Will be 0 when called to forward an existing message (option 8)</span></div><div class="line"><a name="l08251"></a><span class="lineno"> 8251</span>&#160;<span class="comment"> *             Will be 1 when called to leave a message (option 3-&gt;5)</span></div><div class="line"><a name="l08252"></a><span class="lineno"> 8252</span>&#160;<span class="comment"> * \param record_gain</span></div><div class="line"><a name="l08253"></a><span class="lineno"> 8253</span>&#160;<span class="comment"> * \param urgent</span></div><div class="line"><a name="l08254"></a><span class="lineno"> 8254</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l08255"></a><span class="lineno"> 8255</span>&#160;<span class="comment"> * Reads the destination mailbox(es) from keypad input for CID, or if use_directory feature is enabled, the Directory.</span></div><div class="line"><a name="l08256"></a><span class="lineno"> 8256</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l08257"></a><span class="lineno"> 8257</span>&#160;<span class="comment"> * When in the leave message mode (is_new_message == 1):</span></div><div class="line"><a name="l08258"></a><span class="lineno"> 8258</span>&#160;<span class="comment"> *   - allow the leaving of a message for ourselves. (Will not allow us to forward a message to ourselves, when is_new_message == 0).</span></div><div class="line"><a name="l08259"></a><span class="lineno"> 8259</span>&#160;<span class="comment"> *   - attempt to determine the context and mailbox, and then invoke leave_message() function to record and store the message.</span></div><div class="line"><a name="l08260"></a><span class="lineno"> 8260</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l08261"></a><span class="lineno"> 8261</span>&#160;<span class="comment"> * When in the forward message mode (is_new_message == 0):</span></div><div class="line"><a name="l08262"></a><span class="lineno"> 8262</span>&#160;<span class="comment"> *   - retrieves the current message to be forwarded</span></div><div class="line"><a name="l08263"></a><span class="lineno"> 8263</span>&#160;<span class="comment"> *   - copies the original message to a temporary file, so updates to the envelope can be done.</span></div><div class="line"><a name="l08264"></a><span class="lineno"> 8264</span>&#160;<span class="comment"> *   - determines the target mailbox and folders</span></div><div class="line"><a name="l08265"></a><span class="lineno"> 8265</span>&#160;<span class="comment"> *   - copies the message into the target mailbox, using copy_message() or by generating the message into an email attachment if using imap folders.</span></div><div class="line"><a name="l08266"></a><span class="lineno"> 8266</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l08267"></a><span class="lineno"> 8267</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l08268"></a><span class="lineno"> 8268</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l08269"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c"> 8269</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c">forward_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *context, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *sender, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> is_new_message, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain, <span class="keywordtype">int</span> urgent)</div><div class="line"><a name="l08270"></a><span class="lineno"> 8270</span>&#160;{</div><div class="line"><a name="l08271"></a><span class="lineno"> 8271</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08272"></a><span class="lineno"> 8272</span>&#160;   <span class="keywordtype">int</span> todircount = 0;</div><div class="line"><a name="l08273"></a><span class="lineno"> 8273</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *dstvms;</div><div class="line"><a name="l08274"></a><span class="lineno"> 8274</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08275"></a><span class="lineno"> 8275</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>[70]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l08276"></a><span class="lineno"> 8276</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>]; <span class="comment">/* for playback of name greeting */</span></div><div class="line"><a name="l08277"></a><span class="lineno"> 8277</span>&#160;   <span class="keywordtype">char</span> ecodes[16] = <span class="stringliteral">&quot;#&quot;</span>;</div><div class="line"><a name="l08278"></a><span class="lineno"> 8278</span>&#160;   <span class="keywordtype">int</span> res = 0, cmd = 0;</div><div class="line"><a name="l08279"></a><span class="lineno"> 8279</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *receiver = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *vmtmp;</div><div class="line"><a name="l08280"></a><span class="lineno"> 8280</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a547735280f0983afc46bf476d17be24a">AST_LIST_HEAD_NOLOCK_STATIC</a>(extensions, <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a>);</div><div class="line"><a name="l08281"></a><span class="lineno"> 8281</span>&#160;   <span class="keywordtype">char</span> *stringp;</div><div class="line"><a name="l08282"></a><span class="lineno"> 8282</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *s;</div><div class="line"><a name="l08283"></a><span class="lineno"> 8283</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> mailbox_context[256];</div><div class="line"><a name="l08284"></a><span class="lineno"> 8284</span>&#160;   <span class="keywordtype">int</span> saved_messages = 0;</div><div class="line"><a name="l08285"></a><span class="lineno"> 8285</span>&#160;   <span class="keywordtype">int</span> valid_extensions = 0;</div><div class="line"><a name="l08286"></a><span class="lineno"> 8286</span>&#160;   <span class="keywordtype">char</span> *dir;</div><div class="line"><a name="l08287"></a><span class="lineno"> 8287</span>&#160;   <span class="keywordtype">int</span> curmsg;</div><div class="line"><a name="l08288"></a><span class="lineno"> 8288</span>&#160;   <span class="keywordtype">char</span> urgent_str[7] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l08289"></a><span class="lineno"> 8289</span>&#160;   <span class="keywordtype">int</span> prompt_played = 0;</div><div class="line"><a name="l08290"></a><span class="lineno"> 8290</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l08291"></a><span class="lineno"> 8291</span>&#160;   <span class="keywordtype">char</span> msgfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], textfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], backup[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], backup_textfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l08292"></a><span class="lineno"> 8292</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08293"></a><span class="lineno"> 8293</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">VM_FWDURGAUTO</a>)) {</div><div class="line"><a name="l08294"></a><span class="lineno"> 8294</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(urgent_str, urgent ? <span class="stringliteral">&quot;Urgent&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">sizeof</span>(urgent_str));</div><div class="line"><a name="l08295"></a><span class="lineno"> 8295</span>&#160;   }</div><div class="line"><a name="l08296"></a><span class="lineno"> 8296</span>&#160;</div><div class="line"><a name="l08297"></a><span class="lineno"> 8297</span>&#160;   <span class="keywordflow">if</span> (vms == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l08298"></a><span class="lineno"> 8298</span>&#160;   dir = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>;</div><div class="line"><a name="l08299"></a><span class="lineno"> 8299</span>&#160;   curmsg = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;</div><div class="line"><a name="l08300"></a><span class="lineno"> 8300</span>&#160;</div><div class="line"><a name="l08301"></a><span class="lineno"> 8301</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;FORWARD&quot;</span>, <span class="stringliteral">&quot;Message: entering forward message menu&quot;</span>);</div><div class="line"><a name="l08302"></a><span class="lineno"> 8302</span>&#160;   <span class="keywordflow">while</span> (!res &amp;&amp; !valid_extensions) {</div><div class="line"><a name="l08303"></a><span class="lineno"> 8303</span>&#160;      <span class="keywordtype">int</span> use_directory = 0;</div><div class="line"><a name="l08304"></a><span class="lineno"> 8304</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a>)) {</div><div class="line"><a name="l08305"></a><span class="lineno"> 8305</span>&#160;         <span class="keywordtype">int</span> <a class="code" href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a> = 0;</div><div class="line"><a name="l08306"></a><span class="lineno"> 8306</span>&#160;         <span class="keywordtype">int</span> retries = 0;</div><div class="line"><a name="l08307"></a><span class="lineno"> 8307</span>&#160;         cmd = 0;</div><div class="line"><a name="l08308"></a><span class="lineno"> 8308</span>&#160;         <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; !done ){</div><div class="line"><a name="l08309"></a><span class="lineno"> 8309</span>&#160;            <span class="keywordflow">if</span> (cmd)</div><div class="line"><a name="l08310"></a><span class="lineno"> 8310</span>&#160;               retries = 0;</div><div class="line"><a name="l08311"></a><span class="lineno"> 8311</span>&#160;            <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l08312"></a><span class="lineno"> 8312</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:</div><div class="line"><a name="l08313"></a><span class="lineno"> 8313</span>&#160;               use_directory = 0;</div><div class="line"><a name="l08314"></a><span class="lineno"> 8314</span>&#160;               done = 1;</div><div class="line"><a name="l08315"></a><span class="lineno"> 8315</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08316"></a><span class="lineno"> 8316</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:</div><div class="line"><a name="l08317"></a><span class="lineno"> 8317</span>&#160;               use_directory = 1;</div><div class="line"><a name="l08318"></a><span class="lineno"> 8318</span>&#160;               done = 1;</div><div class="line"><a name="l08319"></a><span class="lineno"> 8319</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08320"></a><span class="lineno"> 8320</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l08321"></a><span class="lineno"> 8321</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l08322"></a><span class="lineno"> 8322</span>&#160;               done = 1;</div><div class="line"><a name="l08323"></a><span class="lineno"> 8323</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08324"></a><span class="lineno"> 8324</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l08325"></a><span class="lineno"> 8325</span>&#160;               <span class="comment">/* Press 1 to enter an extension press 2 to use the directory */</span></div><div class="line"><a name="l08326"></a><span class="lineno"> 8326</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-forward&quot;</span>);</div><div class="line"><a name="l08327"></a><span class="lineno"> 8327</span>&#160;               <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l08328"></a><span class="lineno"> 8328</span>&#160;                  cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 3000);</div><div class="line"><a name="l08329"></a><span class="lineno"> 8329</span>&#160;               }</div><div class="line"><a name="l08330"></a><span class="lineno"> 8330</span>&#160;               <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l08331"></a><span class="lineno"> 8331</span>&#160;                  retries++;</div><div class="line"><a name="l08332"></a><span class="lineno"> 8332</span>&#160;               }</div><div class="line"><a name="l08333"></a><span class="lineno"> 8333</span>&#160;               <span class="keywordflow">if</span> (retries &gt; 3) {</div><div class="line"><a name="l08334"></a><span class="lineno"> 8334</span>&#160;                  cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l08335"></a><span class="lineno"> 8335</span>&#160;                  done = 1;</div><div class="line"><a name="l08336"></a><span class="lineno"> 8336</span>&#160;               }</div><div class="line"><a name="l08337"></a><span class="lineno"> 8337</span>&#160;               <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l08338"></a><span class="lineno"> 8338</span>&#160;                  isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l08339"></a><span class="lineno"> 8339</span>&#160;            }</div><div class="line"><a name="l08340"></a><span class="lineno"> 8340</span>&#160;         }</div><div class="line"><a name="l08341"></a><span class="lineno"> 8341</span>&#160;         <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span>)</div><div class="line"><a name="l08342"></a><span class="lineno"> 8342</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08343"></a><span class="lineno"> 8343</span>&#160;      }</div><div class="line"><a name="l08344"></a><span class="lineno"> 8344</span>&#160;</div><div class="line"><a name="l08345"></a><span class="lineno"> 8345</span>&#160;      <span class="keywordflow">if</span> (use_directory) {</div><div class="line"><a name="l08346"></a><span class="lineno"> 8346</span>&#160;         <span class="comment">/* use app_directory */</span></div><div class="line"><a name="l08347"></a><span class="lineno"> 8347</span>&#160;</div><div class="line"><a name="l08348"></a><span class="lineno"> 8348</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../d0/da3/structast__app.html">ast_app</a>* directory_app;</div><div class="line"><a name="l08349"></a><span class="lineno"> 8349</span>&#160;</div><div class="line"><a name="l08350"></a><span class="lineno"> 8350</span>&#160;         directory_app = <a class="code" href="../../db/de0/pbx_8h.html#ad4a6912dcd2ad44a186d0a284afafc51">pbx_findapp</a>(<span class="stringliteral">&quot;Directory&quot;</span>);</div><div class="line"><a name="l08351"></a><span class="lineno"> 8351</span>&#160;         <span class="keywordflow">if</span> (directory_app) {</div><div class="line"><a name="l08352"></a><span class="lineno"> 8352</span>&#160;            <span class="keywordtype">char</span> vmcontext[256];</div><div class="line"><a name="l08353"></a><span class="lineno"> 8353</span>&#160;            <span class="keywordtype">char</span> old_context[strlen(<a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan)) + 1];</div><div class="line"><a name="l08354"></a><span class="lineno"> 8354</span>&#160;            <span class="keywordtype">char</span> old_exten[strlen(<a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(chan)) + 1];</div><div class="line"><a name="l08355"></a><span class="lineno"> 8355</span>&#160;            <span class="keywordtype">int</span> old_priority;</div><div class="line"><a name="l08356"></a><span class="lineno"> 8356</span>&#160;            <span class="comment">/* make backup copies */</span></div><div class="line"><a name="l08357"></a><span class="lineno"> 8357</span>&#160;            strcpy(old_context, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan)); <span class="comment">/* safe */</span></div><div class="line"><a name="l08358"></a><span class="lineno"> 8358</span>&#160;            strcpy(old_exten, <a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(chan)); <span class="comment">/* safe */</span></div><div class="line"><a name="l08359"></a><span class="lineno"> 8359</span>&#160;            old_priority = <a class="code" href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a>(chan);</div><div class="line"><a name="l08360"></a><span class="lineno"> 8360</span>&#160;</div><div class="line"><a name="l08361"></a><span class="lineno"> 8361</span>&#160;            <span class="comment">/* call the Directory, changes the channel */</span></div><div class="line"><a name="l08362"></a><span class="lineno"> 8362</span>&#160;            snprintf(vmcontext, <span class="keyword">sizeof</span>(vmcontext), <span class="stringliteral">&quot;%s,,v&quot;</span>, context ? context : <span class="stringliteral">&quot;default&quot;</span>);</div><div class="line"><a name="l08363"></a><span class="lineno"> 8363</span>&#160;            res = <a class="code" href="../../db/de0/pbx_8h.html#a6e3dbc57c03c23543354ef108c31fac8">pbx_exec</a>(chan, directory_app, vmcontext);</div><div class="line"><a name="l08364"></a><span class="lineno"> 8364</span>&#160;</div><div class="line"><a name="l08365"></a><span class="lineno"> 8365</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(username, <a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(chan), <span class="keyword">sizeof</span>(username));</div><div class="line"><a name="l08366"></a><span class="lineno"> 8366</span>&#160;</div><div class="line"><a name="l08367"></a><span class="lineno"> 8367</span>&#160;            <span class="comment">/* restore the old context, exten, and priority */</span></div><div class="line"><a name="l08368"></a><span class="lineno"> 8368</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, old_context);</div><div class="line"><a name="l08369"></a><span class="lineno"> 8369</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#a018b7a29cef2d62074dc46e9aaad0d1a">ast_channel_exten_set</a>(chan, old_exten);</div><div class="line"><a name="l08370"></a><span class="lineno"> 8370</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#ae56cab679c0cda6436b930bc74297895">ast_channel_priority_set</a>(chan, old_priority);</div><div class="line"><a name="l08371"></a><span class="lineno"> 8371</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08372"></a><span class="lineno"> 8372</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find the Directory application, disabling directory_forward\n&quot;</span>);</div><div class="line"><a name="l08373"></a><span class="lineno"> 8373</span>&#160;            <a class="code" href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a>);</div><div class="line"><a name="l08374"></a><span class="lineno"> 8374</span>&#160;         }</div><div class="line"><a name="l08375"></a><span class="lineno"> 8375</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08376"></a><span class="lineno"> 8376</span>&#160;         <span class="comment">/* Ask for an extension */</span></div><div class="line"><a name="l08377"></a><span class="lineno"> 8377</span>&#160;         res = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-extension&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan)); <span class="comment">/* &quot;extension&quot; */</span></div><div class="line"><a name="l08378"></a><span class="lineno"> 8378</span>&#160;         prompt_played++;</div><div class="line"><a name="l08379"></a><span class="lineno"> 8379</span>&#160;         <span class="keywordflow">if</span> (res || prompt_played &gt; 4)</div><div class="line"><a name="l08380"></a><span class="lineno"> 8380</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08381"></a><span class="lineno"> 8381</span>&#160;         <span class="keywordflow">if</span> ((res = <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, username, <span class="keyword">sizeof</span>(username) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>)) &lt; 0)</div><div class="line"><a name="l08382"></a><span class="lineno"> 8382</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08383"></a><span class="lineno"> 8383</span>&#160;      }</div><div class="line"><a name="l08384"></a><span class="lineno"> 8384</span>&#160;</div><div class="line"><a name="l08385"></a><span class="lineno"> 8385</span>&#160;      <span class="comment">/* start all over if no username */</span></div><div class="line"><a name="l08386"></a><span class="lineno"> 8386</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(username))</div><div class="line"><a name="l08387"></a><span class="lineno"> 8387</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l08388"></a><span class="lineno"> 8388</span>&#160;      stringp = username;</div><div class="line"><a name="l08389"></a><span class="lineno"> 8389</span>&#160;      s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;*&quot;</span>);</div><div class="line"><a name="l08390"></a><span class="lineno"> 8390</span>&#160;      <span class="comment">/* start optimistic */</span></div><div class="line"><a name="l08391"></a><span class="lineno"> 8391</span>&#160;      valid_extensions = 1;</div><div class="line"><a name="l08392"></a><span class="lineno"> 8392</span>&#160;      <span class="keywordflow">while</span> (s) {</div><div class="line"><a name="l08393"></a><span class="lineno"> 8393</span>&#160;         snprintf((<span class="keywordtype">char</span>*)mailbox_context, <span class="keyword">sizeof</span>(mailbox_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, s, context ? context : <span class="stringliteral">&quot;default&quot;</span>);</div><div class="line"><a name="l08394"></a><span class="lineno"> 8394</span>&#160;         <span class="keywordflow">if</span> ((is_new_message == 1 || strcmp(s, sender-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) &amp;&amp; (receiver = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, context, s))) {</div><div class="line"><a name="l08395"></a><span class="lineno"> 8395</span>&#160;            <span class="keywordtype">int</span> oldmsgs;</div><div class="line"><a name="l08396"></a><span class="lineno"> 8396</span>&#160;            <span class="keywordtype">int</span> newmsgs;</div><div class="line"><a name="l08397"></a><span class="lineno"> 8397</span>&#160;            <span class="keywordtype">int</span> capacity;</div><div class="line"><a name="l08398"></a><span class="lineno"> 8398</span>&#160;</div><div class="line"><a name="l08399"></a><span class="lineno"> 8399</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(mailbox_context, &amp;newmsgs, &amp;oldmsgs)) {</div><div class="line"><a name="l08400"></a><span class="lineno"> 8400</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Problem in calculating number of voicemail messages available for extension %s\n&quot;</span>, mailbox_context);</div><div class="line"><a name="l08401"></a><span class="lineno"> 8401</span>&#160;               <span class="comment">/* Shouldn&#39;t happen, but allow trying another extension if it does */</span></div><div class="line"><a name="l08402"></a><span class="lineno"> 8402</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;pbx-invalid&quot;</span>);</div><div class="line"><a name="l08403"></a><span class="lineno"> 8403</span>&#160;               valid_extensions = 0;</div><div class="line"><a name="l08404"></a><span class="lineno"> 8404</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08405"></a><span class="lineno"> 8405</span>&#160;            }</div><div class="line"><a name="l08406"></a><span class="lineno"> 8406</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08407"></a><span class="lineno"> 8407</span>&#160;            <span class="keywordflow">if</span> (!(dstvms = get_vm_state_by_mailbox(s, context, 0))) {</div><div class="line"><a name="l08408"></a><span class="lineno"> 8408</span>&#160;               <span class="keywordflow">if</span> (!(dstvms = create_vm_state_from_user(receiver))) {</div><div class="line"><a name="l08409"></a><span class="lineno"> 8409</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t allocate necessary space\n&quot;</span>);</div><div class="line"><a name="l08410"></a><span class="lineno"> 8410</span>&#160;                  <span class="comment">/* Shouldn&#39;t happen, but allow trying another extension if it does */</span></div><div class="line"><a name="l08411"></a><span class="lineno"> 8411</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;pbx-invalid&quot;</span>);</div><div class="line"><a name="l08412"></a><span class="lineno"> 8412</span>&#160;                  valid_extensions = 0;</div><div class="line"><a name="l08413"></a><span class="lineno"> 8413</span>&#160;                  <span class="keywordflow">break</span>;</div><div class="line"><a name="l08414"></a><span class="lineno"> 8414</span>&#160;               }</div><div class="line"><a name="l08415"></a><span class="lineno"> 8415</span>&#160;            }</div><div class="line"><a name="l08416"></a><span class="lineno"> 8416</span>&#160;            check_quota(dstvms, imapfolder);</div><div class="line"><a name="l08417"></a><span class="lineno"> 8417</span>&#160;            <span class="keywordflow">if</span> (dstvms-&gt;quota_limit &amp;&amp; dstvms-&gt;quota_usage &gt;= dstvms-&gt;quota_limit) {</div><div class="line"><a name="l08418"></a><span class="lineno"> 8418</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Mailbox &#39;%s&#39; is exceeded quota %u &gt;= %u\n&quot;</span>, mailbox_context, dstvms-&gt;quota_usage, dstvms-&gt;quota_limit);</div><div class="line"><a name="l08419"></a><span class="lineno"> 8419</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l08420"></a><span class="lineno"> 8420</span>&#160;               valid_extensions = 0;</div><div class="line"><a name="l08421"></a><span class="lineno"> 8421</span>&#160;               <span class="keywordflow">while</span> ((vmtmp = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;extensions, list))) {</div><div class="line"><a name="l08422"></a><span class="lineno"> 8422</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</div><div class="line"><a name="l08423"></a><span class="lineno"> 8423</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmtmp);</div><div class="line"><a name="l08424"></a><span class="lineno"> 8424</span>&#160;               }</div><div class="line"><a name="l08425"></a><span class="lineno"> 8425</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08426"></a><span class="lineno"> 8426</span>&#160;            }</div><div class="line"><a name="l08427"></a><span class="lineno"> 8427</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08428"></a><span class="lineno"> 8428</span>&#160;            capacity = receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> - <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, +1);</div><div class="line"><a name="l08429"></a><span class="lineno"> 8429</span>&#160;            <span class="keywordflow">if</span> ((newmsgs + oldmsgs) &gt;= capacity) {</div><div class="line"><a name="l08430"></a><span class="lineno"> 8430</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Mailbox &#39;%s&#39; is full with capacity of %d, prompting for another extension.\n&quot;</span>, mailbox_context, capacity);</div><div class="line"><a name="l08431"></a><span class="lineno"> 8431</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l08432"></a><span class="lineno"> 8432</span>&#160;               valid_extensions = 0;</div><div class="line"><a name="l08433"></a><span class="lineno"> 8433</span>&#160;               <span class="keywordflow">while</span> ((vmtmp = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;extensions, list))) {</div><div class="line"><a name="l08434"></a><span class="lineno"> 8434</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</div><div class="line"><a name="l08435"></a><span class="lineno"> 8435</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmtmp);</div><div class="line"><a name="l08436"></a><span class="lineno"> 8436</span>&#160;               }</div><div class="line"><a name="l08437"></a><span class="lineno"> 8437</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1);</div><div class="line"><a name="l08438"></a><span class="lineno"> 8438</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08439"></a><span class="lineno"> 8439</span>&#160;            }</div><div class="line"><a name="l08440"></a><span class="lineno"> 8440</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307">AST_LIST_INSERT_HEAD</a>(&amp;extensions, receiver, list);</div><div class="line"><a name="l08441"></a><span class="lineno"> 8441</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08442"></a><span class="lineno"> 8442</span>&#160;            <span class="comment">/* XXX Optimization for the future.  When we encounter a single bad extension,</span></div><div class="line"><a name="l08443"></a><span class="lineno"> 8443</span>&#160;<span class="comment">             * bailing out on all of the extensions may not be the way to go.  We should</span></div><div class="line"><a name="l08444"></a><span class="lineno"> 8444</span>&#160;<span class="comment">             * probably just bail on that single extension, then allow the user to enter</span></div><div class="line"><a name="l08445"></a><span class="lineno"> 8445</span>&#160;<span class="comment">             * several more. XXX</span></div><div class="line"><a name="l08446"></a><span class="lineno"> 8446</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l08447"></a><span class="lineno"> 8447</span>&#160;            <span class="keywordflow">while</span> ((receiver = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;extensions, list))) {</div><div class="line"><a name="l08448"></a><span class="lineno"> 8448</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(receiver);</div><div class="line"><a name="l08449"></a><span class="lineno"> 8449</span>&#160;            }</div><div class="line"><a name="l08450"></a><span class="lineno"> 8450</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;&#39;%s&#39; is not a valid mailbox\n&quot;</span>, mailbox_context);</div><div class="line"><a name="l08451"></a><span class="lineno"> 8451</span>&#160;            <span class="comment">/* &quot;I am sorry, that&#39;s not a valid extension.  Please try again.&quot; */</span></div><div class="line"><a name="l08452"></a><span class="lineno"> 8452</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;pbx-invalid&quot;</span>);</div><div class="line"><a name="l08453"></a><span class="lineno"> 8453</span>&#160;            valid_extensions = 0;</div><div class="line"><a name="l08454"></a><span class="lineno"> 8454</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08455"></a><span class="lineno"> 8455</span>&#160;         }</div><div class="line"><a name="l08456"></a><span class="lineno"> 8456</span>&#160;</div><div class="line"><a name="l08457"></a><span class="lineno"> 8457</span>&#160;         <span class="comment">/* play name if available, else play extension number */</span></div><div class="line"><a name="l08458"></a><span class="lineno"> 8458</span>&#160;         snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, s);</div><div class="line"><a name="l08459"></a><span class="lineno"> 8459</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(fn, -1, s, receiver-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l08460"></a><span class="lineno"> 8460</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l08461"></a><span class="lineno"> 8461</span>&#160;            res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, fn, ecodes);</div><div class="line"><a name="l08462"></a><span class="lineno"> 8462</span>&#160;            <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l08463"></a><span class="lineno"> 8463</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);</div><div class="line"><a name="l08464"></a><span class="lineno"> 8464</span>&#160;               <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08465"></a><span class="lineno"> 8465</span>&#160;            }</div><div class="line"><a name="l08466"></a><span class="lineno"> 8466</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08467"></a><span class="lineno"> 8467</span>&#160;            res = <a class="code" href="../../db/dce/say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce">ast_say_digit_str</a>(chan, s, ecodes, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08468"></a><span class="lineno"> 8468</span>&#160;         }</div><div class="line"><a name="l08469"></a><span class="lineno"> 8469</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);</div><div class="line"><a name="l08470"></a><span class="lineno"> 8470</span>&#160;</div><div class="line"><a name="l08471"></a><span class="lineno"> 8471</span>&#160;         s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;*&quot;</span>);</div><div class="line"><a name="l08472"></a><span class="lineno"> 8472</span>&#160;      }</div><div class="line"><a name="l08473"></a><span class="lineno"> 8473</span>&#160;      <span class="comment">/* break from the loop of reading the extensions */</span></div><div class="line"><a name="l08474"></a><span class="lineno"> 8474</span>&#160;      <span class="keywordflow">if</span> (valid_extensions)</div><div class="line"><a name="l08475"></a><span class="lineno"> 8475</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l08476"></a><span class="lineno"> 8476</span>&#160;   }</div><div class="line"><a name="l08477"></a><span class="lineno"> 8477</span>&#160;   <span class="comment">/* check if we&#39;re clear to proceed */</span></div><div class="line"><a name="l08478"></a><span class="lineno"> 8478</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/d90/linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05">AST_LIST_EMPTY</a>(&amp;extensions) || !valid_extensions)</div><div class="line"><a name="l08479"></a><span class="lineno"> 8479</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08480"></a><span class="lineno"> 8480</span>&#160;   <span class="keywordflow">if</span> (is_new_message == 1) {</div><div class="line"><a name="l08481"></a><span class="lineno"> 8481</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/df7/structleave__vm__options.html">leave_vm_options</a> leave_options;</div><div class="line"><a name="l08482"></a><span class="lineno"> 8482</span>&#160;      <span class="keywordtype">char</span> mailbox[<a class="code" href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a> * 2 + 2];</div><div class="line"><a name="l08483"></a><span class="lineno"> 8483</span>&#160;      snprintf(mailbox, <span class="keyword">sizeof</span>(mailbox), <span class="stringliteral">&quot;%s@%s&quot;</span>, username, context);</div><div class="line"><a name="l08484"></a><span class="lineno"> 8484</span>&#160;</div><div class="line"><a name="l08485"></a><span class="lineno"> 8485</span>&#160;      <span class="comment">/* Send VoiceMail */</span></div><div class="line"><a name="l08486"></a><span class="lineno"> 8486</span>&#160;      memset(&amp;leave_options, 0, <span class="keyword">sizeof</span>(leave_options));</div><div class="line"><a name="l08487"></a><span class="lineno"> 8487</span>&#160;      leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a> = <a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a>;</div><div class="line"><a name="l08488"></a><span class="lineno"> 8488</span>&#160;      leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a> = <span class="stringliteral">&quot;beep&quot;</span>;</div><div class="line"><a name="l08489"></a><span class="lineno"> 8489</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff">leave_voicemail</a>(chan, mailbox, &amp;leave_options);</div><div class="line"><a name="l08490"></a><span class="lineno"> 8490</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08491"></a><span class="lineno"> 8491</span>&#160;      <span class="comment">/* Forward VoiceMail */</span></div><div class="line"><a name="l08492"></a><span class="lineno"> 8492</span>&#160;      <span class="keywordtype">long</span> duration = 0;</div><div class="line"><a name="l08493"></a><span class="lineno"> 8493</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vmstmp;</div><div class="line"><a name="l08494"></a><span class="lineno"> 8494</span>&#160;      <span class="keywordtype">int</span> copy_msg_result = 0;</div><div class="line"><a name="l08495"></a><span class="lineno"> 8495</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08496"></a><span class="lineno"> 8496</span>&#160;      <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l08497"></a><span class="lineno"> 8497</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l08498"></a><span class="lineno"> 8498</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l08499"></a><span class="lineno"> 8499</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l08500"></a><span class="lineno"> 8500</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08501"></a><span class="lineno"> 8501</span>&#160;      memcpy(&amp;vmstmp, vms, <span class="keyword">sizeof</span>(vmstmp));</div><div class="line"><a name="l08502"></a><span class="lineno"> 8502</span>&#160;</div><div class="line"><a name="l08503"></a><span class="lineno"> 8503</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(dir, curmsg, sender-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, sender-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l08504"></a><span class="lineno"> 8504</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08505"></a><span class="lineno"> 8505</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(filename, <span class="keyword">sizeof</span>(filename), dir, curmsg);</div><div class="line"><a name="l08506"></a><span class="lineno"> 8506</span>&#160;      strncat(filename, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(filename) - strlen(filename) - 1);</div><div class="line"><a name="l08507"></a><span class="lineno"> 8507</span>&#160;      msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l08508"></a><span class="lineno"> 8508</span>&#160;      <span class="keywordflow">if</span> (msg_cfg &amp;&amp; msg_cfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l08509"></a><span class="lineno"> 8509</span>&#160;         msg_id = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;msg_id&quot;</span>));</div><div class="line"><a name="l08510"></a><span class="lineno"> 8510</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l08511"></a><span class="lineno"> 8511</span>&#160;      }</div><div class="line"><a name="l08512"></a><span class="lineno"> 8512</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08513"></a><span class="lineno"> 8513</span>&#160;</div><div class="line"><a name="l08514"></a><span class="lineno"> 8514</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273">vm_forwardoptions</a>(chan, sender, vmstmp.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, curmsg, vmfmts, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(context, <span class="stringliteral">&quot;default&quot;</span>), record_gain, &amp;duration, &amp;vmstmp, urgent_str);</div><div class="line"><a name="l08515"></a><span class="lineno"> 8515</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l08516"></a><span class="lineno"> 8516</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;extensions, vmtmp, list) {</div><div class="line"><a name="l08517"></a><span class="lineno"> 8517</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08518"></a><span class="lineno"> 8518</span>&#160;            <span class="keywordtype">int</span> attach_user_voicemail;</div><div class="line"><a name="l08519"></a><span class="lineno"> 8519</span>&#160;            <span class="keywordtype">char</span> *myserveremail = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;</div><div class="line"><a name="l08520"></a><span class="lineno"> 8520</span>&#160;</div><div class="line"><a name="l08521"></a><span class="lineno"> 8521</span>&#160;            <span class="comment">/* get destination mailbox */</span></div><div class="line"><a name="l08522"></a><span class="lineno"> 8522</span>&#160;            dstvms = get_vm_state_by_mailbox(vmtmp-&gt;mailbox, vmtmp-&gt;context, 0);</div><div class="line"><a name="l08523"></a><span class="lineno"> 8523</span>&#160;            <span class="keywordflow">if</span> (!dstvms) {</div><div class="line"><a name="l08524"></a><span class="lineno"> 8524</span>&#160;               dstvms = create_vm_state_from_user(vmtmp);</div><div class="line"><a name="l08525"></a><span class="lineno"> 8525</span>&#160;            }</div><div class="line"><a name="l08526"></a><span class="lineno"> 8526</span>&#160;            <span class="keywordflow">if</span> (dstvms) {</div><div class="line"><a name="l08527"></a><span class="lineno"> 8527</span>&#160;               init_mailstream(dstvms, 0);</div><div class="line"><a name="l08528"></a><span class="lineno"> 8528</span>&#160;               <span class="keywordflow">if</span> (!dstvms-&gt;mailstream) {</div><div class="line"><a name="l08529"></a><span class="lineno"> 8529</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream for %s is NULL\n&quot;</span>, vmtmp-&gt;mailbox);</div><div class="line"><a name="l08530"></a><span class="lineno"> 8530</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08531"></a><span class="lineno"> 8531</span>&#160;                  copy_msg_result = <a class="code" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a>(vmstmp.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vmtmp-&gt;mailbox, vmtmp-&gt;context, curmsg, chan, vmtmp, fmt, duration, dstvms, urgent_str, msg_id);</div><div class="line"><a name="l08532"></a><span class="lineno"> 8532</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a>(vmtmp-&gt;context, vmtmp-&gt;mailbox, urgent_str);</div><div class="line"><a name="l08533"></a><span class="lineno"> 8533</span>&#160;               }</div><div class="line"><a name="l08534"></a><span class="lineno"> 8534</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08535"></a><span class="lineno"> 8535</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not find state information for mailbox %s\n&quot;</span>, vmtmp-&gt;mailbox);</div><div class="line"><a name="l08536"></a><span class="lineno"> 8536</span>&#160;            }</div><div class="line"><a name="l08537"></a><span class="lineno"> 8537</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmtmp-&gt;serveremail))</div><div class="line"><a name="l08538"></a><span class="lineno"> 8538</span>&#160;               myserveremail = vmtmp-&gt;serveremail;</div><div class="line"><a name="l08539"></a><span class="lineno"> 8539</span>&#160;            attach_user_voicemail = <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmtmp, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);</div><div class="line"><a name="l08540"></a><span class="lineno"> 8540</span>&#160;            <span class="comment">/* NULL category for IMAP storage */</span></div><div class="line"><a name="l08541"></a><span class="lineno"> 8541</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3fd02e9399fad0b67dd0a7d6f4af464e">sendmail</a>(myserveremail, vmtmp, todircount, vmtmp-&gt;context, vmtmp-&gt;mailbox,</div><div class="line"><a name="l08542"></a><span class="lineno"> 8542</span>&#160;               dstvms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>,</div><div class="line"><a name="l08543"></a><span class="lineno"> 8543</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l08544"></a><span class="lineno"> 8544</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),</div><div class="line"><a name="l08545"></a><span class="lineno"> 8545</span>&#160;               vmstmp.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmstmp.introfn, fmt, duration, attach_user_voicemail, chan,</div><div class="line"><a name="l08546"></a><span class="lineno"> 8546</span>&#160;               <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, urgent_str, msg_id);</div><div class="line"><a name="l08547"></a><span class="lineno"> 8547</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l08548"></a><span class="lineno"> 8548</span>&#160;            copy_msg_result = <a class="code" href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039">copy_message</a>(chan, sender, 0, curmsg, duration, vmtmp, fmt, dir, urgent_str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08549"></a><span class="lineno"> 8549</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08550"></a><span class="lineno"> 8550</span>&#160;            saved_messages++;</div><div class="line"><a name="l08551"></a><span class="lineno"> 8551</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c">AST_LIST_REMOVE_CURRENT</a>(list);</div><div class="line"><a name="l08552"></a><span class="lineno"> 8552</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</div><div class="line"><a name="l08553"></a><span class="lineno"> 8553</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmtmp);</div><div class="line"><a name="l08554"></a><span class="lineno"> 8554</span>&#160;            <span class="keywordflow">if</span> (res)</div><div class="line"><a name="l08555"></a><span class="lineno"> 8555</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l08556"></a><span class="lineno"> 8556</span>&#160;         }</div><div class="line"><a name="l08557"></a><span class="lineno"> 8557</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a>;</div><div class="line"><a name="l08558"></a><span class="lineno"> 8558</span>&#160;         <span class="keywordflow">if</span> (saved_messages &gt; 0 &amp;&amp; !copy_msg_result) {</div><div class="line"><a name="l08559"></a><span class="lineno"> 8559</span>&#160;            <span class="comment">/* give confirmation that the message was saved */</span></div><div class="line"><a name="l08560"></a><span class="lineno"> 8560</span>&#160;            <span class="comment">/* commented out since we can&#39;t forward batches yet</span></div><div class="line"><a name="l08561"></a><span class="lineno"> 8561</span>&#160;<span class="comment">            if (saved_messages == 1)</span></div><div class="line"><a name="l08562"></a><span class="lineno"> 8562</span>&#160;<span class="comment">               res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span></div><div class="line"><a name="l08563"></a><span class="lineno"> 8563</span>&#160;<span class="comment">            else</span></div><div class="line"><a name="l08564"></a><span class="lineno"> 8564</span>&#160;<span class="comment">               res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span></div><div class="line"><a name="l08565"></a><span class="lineno"> 8565</span>&#160;<span class="comment">            if (!res)</span></div><div class="line"><a name="l08566"></a><span class="lineno"> 8566</span>&#160;<span class="comment">               res = ast_play_and_wait(chan, &quot;vm-saved&quot;); */</span></div><div class="line"><a name="l08567"></a><span class="lineno"> 8567</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgforwarded&quot;</span>);</div><div class="line"><a name="l08568"></a><span class="lineno"> 8568</span>&#160;         }</div><div class="line"><a name="l08569"></a><span class="lineno"> 8569</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l08570"></a><span class="lineno"> 8570</span>&#160;         <span class="keywordflow">else</span> {</div><div class="line"><a name="l08571"></a><span class="lineno"> 8571</span>&#160;            <span class="comment">/* with IMAP, mailbox full warning played by imap_check_limits */</span></div><div class="line"><a name="l08572"></a><span class="lineno"> 8572</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l08573"></a><span class="lineno"> 8573</span>&#160;         }</div><div class="line"><a name="l08574"></a><span class="lineno"> 8574</span>&#160;         <span class="comment">/* Restore original message without prepended message if backup exists */</span></div><div class="line"><a name="l08575"></a><span class="lineno"> 8575</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), dir, curmsg);</div><div class="line"><a name="l08576"></a><span class="lineno"> 8576</span>&#160;         strcpy(textfile, msgfile);</div><div class="line"><a name="l08577"></a><span class="lineno"> 8577</span>&#160;         strcpy(backup, msgfile);</div><div class="line"><a name="l08578"></a><span class="lineno"> 8578</span>&#160;         strcpy(backup_textfile, msgfile);</div><div class="line"><a name="l08579"></a><span class="lineno"> 8579</span>&#160;         strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - strlen(textfile) - 1);</div><div class="line"><a name="l08580"></a><span class="lineno"> 8580</span>&#160;         strncat(backup, <span class="stringliteral">&quot;-bak&quot;</span>, <span class="keyword">sizeof</span>(backup) - strlen(backup) - 1);</div><div class="line"><a name="l08581"></a><span class="lineno"> 8581</span>&#160;         strncat(backup_textfile, <span class="stringliteral">&quot;-bak.txt&quot;</span>, <span class="keyword">sizeof</span>(backup_textfile) - strlen(backup_textfile) - 1);</div><div class="line"><a name="l08582"></a><span class="lineno"> 8582</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(backup, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l08583"></a><span class="lineno"> 8583</span>&#160;            <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(backup, msgfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08584"></a><span class="lineno"> 8584</span>&#160;            rename(backup_textfile, textfile);</div><div class="line"><a name="l08585"></a><span class="lineno"> 8585</span>&#160;         }</div><div class="line"><a name="l08586"></a><span class="lineno"> 8586</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08587"></a><span class="lineno"> 8587</span>&#160;      }</div><div class="line"><a name="l08588"></a><span class="lineno"> 8588</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(dir, curmsg);</div><div class="line"><a name="l08589"></a><span class="lineno"> 8589</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l08590"></a><span class="lineno"> 8590</span>&#160;      <span class="keywordflow">if</span> (cmd) { <span class="comment">/* assuming hangup, cleanup backup file */</span></div><div class="line"><a name="l08591"></a><span class="lineno"> 8591</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), dir, curmsg);</div><div class="line"><a name="l08592"></a><span class="lineno"> 8592</span>&#160;         strcpy(textfile, msgfile);</div><div class="line"><a name="l08593"></a><span class="lineno"> 8593</span>&#160;         strcpy(backup_textfile, msgfile);</div><div class="line"><a name="l08594"></a><span class="lineno"> 8594</span>&#160;         strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - strlen(textfile) - 1);</div><div class="line"><a name="l08595"></a><span class="lineno"> 8595</span>&#160;         strncat(backup_textfile, <span class="stringliteral">&quot;-bak.txt&quot;</span>, <span class="keyword">sizeof</span>(backup_textfile) - strlen(backup_textfile) - 1);</div><div class="line"><a name="l08596"></a><span class="lineno"> 8596</span>&#160;         rename(backup_textfile, textfile);</div><div class="line"><a name="l08597"></a><span class="lineno"> 8597</span>&#160;      }</div><div class="line"><a name="l08598"></a><span class="lineno"> 8598</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08599"></a><span class="lineno"> 8599</span>&#160;   }</div><div class="line"><a name="l08600"></a><span class="lineno"> 8600</span>&#160;</div><div class="line"><a name="l08601"></a><span class="lineno"> 8601</span>&#160;   <span class="comment">/* If anything failed above, we still have this list to free */</span></div><div class="line"><a name="l08602"></a><span class="lineno"> 8602</span>&#160;   <span class="keywordflow">while</span> ((vmtmp = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;extensions, list))) {</div><div class="line"><a name="l08603"></a><span class="lineno"> 8603</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</div><div class="line"><a name="l08604"></a><span class="lineno"> 8604</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmtmp);</div><div class="line"><a name="l08605"></a><span class="lineno"> 8605</span>&#160;   }</div><div class="line"><a name="l08606"></a><span class="lineno"> 8606</span>&#160;   <span class="keywordflow">return</span> res ? res : cmd;</div><div class="line"><a name="l08607"></a><span class="lineno"> 8607</span>&#160;}</div><div class="line"><a name="l08608"></a><span class="lineno"> 8608</span>&#160;</div><div class="line"><a name="l08609"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188"> 8609</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *file)</div><div class="line"><a name="l08610"></a><span class="lineno"> 8610</span>&#160;{</div><div class="line"><a name="l08611"></a><span class="lineno"> 8611</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l08612"></a><span class="lineno"> 8612</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, file, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>)) &lt; 0)</div><div class="line"><a name="l08613"></a><span class="lineno"> 8613</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to play message %s\n&quot;</span>, file);</div><div class="line"><a name="l08614"></a><span class="lineno"> 8614</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08615"></a><span class="lineno"> 8615</span>&#160;}</div><div class="line"><a name="l08616"></a><span class="lineno"> 8616</span>&#160;</div><div class="line"><a name="l08617"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a"> 8617</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *file)</div><div class="line"><a name="l08618"></a><span class="lineno"> 8618</span>&#160;{</div><div class="line"><a name="l08619"></a><span class="lineno"> 8619</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYVOICE&quot;</span>, <span class="stringliteral">&quot;Message: Playing %s&quot;</span>, file);</div><div class="line"><a name="l08620"></a><span class="lineno"> 8620</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a3405b1282cefdceebba734b8e756c55d">ast_control_streamfile</a>(chan, file, listen_control_forward_key, listen_control_reverse_key, listen_control_stop_key, listen_control_pause_key, listen_control_restart_key, skipms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08621"></a><span class="lineno"> 8621</span>&#160;}</div><div class="line"><a name="l08622"></a><span class="lineno"> 8622</span>&#160;</div><div class="line"><a name="l08623"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7"> 8623</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7">play_message_category</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *category)</div><div class="line"><a name="l08624"></a><span class="lineno"> 8624</span>&#160;{</div><div class="line"><a name="l08625"></a><span class="lineno"> 8625</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l08626"></a><span class="lineno"> 8626</span>&#160;</div><div class="line"><a name="l08627"></a><span class="lineno"> 8627</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category))</div><div class="line"><a name="l08628"></a><span class="lineno"> 8628</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, category);</div><div class="line"><a name="l08629"></a><span class="lineno"> 8629</span>&#160;</div><div class="line"><a name="l08630"></a><span class="lineno"> 8630</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l08631"></a><span class="lineno"> 8631</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No sound file for category &#39;%s&#39; was found.\n&quot;</span>, category);</div><div class="line"><a name="l08632"></a><span class="lineno"> 8632</span>&#160;      res = 0;</div><div class="line"><a name="l08633"></a><span class="lineno"> 8633</span>&#160;   }</div><div class="line"><a name="l08634"></a><span class="lineno"> 8634</span>&#160;</div><div class="line"><a name="l08635"></a><span class="lineno"> 8635</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08636"></a><span class="lineno"> 8636</span>&#160;}</div><div class="line"><a name="l08637"></a><span class="lineno"> 8637</span>&#160;</div><div class="line"><a name="l08638"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220"> 8638</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename)</div><div class="line"><a name="l08639"></a><span class="lineno"> 8639</span>&#160;{</div><div class="line"><a name="l08640"></a><span class="lineno"> 8640</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l08641"></a><span class="lineno"> 8641</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *the_zone = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l08642"></a><span class="lineno"> 8642</span>&#160;   time_t t;</div><div class="line"><a name="l08643"></a><span class="lineno"> 8643</span>&#160;</div><div class="line"><a name="l08644"></a><span class="lineno"> 8644</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a3b5457e5f5679935093d94b0f788769e">ast_get_time_t</a>(origtime, &amp;t, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l08645"></a><span class="lineno"> 8645</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t find origtime in %s\n&quot;</span>, filename);</div><div class="line"><a name="l08646"></a><span class="lineno"> 8646</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l08647"></a><span class="lineno"> 8647</span>&#160;   }</div><div class="line"><a name="l08648"></a><span class="lineno"> 8648</span>&#160;</div><div class="line"><a name="l08649"></a><span class="lineno"> 8649</span>&#160;   <span class="comment">/* Does this user have a timezone specified? */</span></div><div class="line"><a name="l08650"></a><span class="lineno"> 8650</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>)) {</div><div class="line"><a name="l08651"></a><span class="lineno"> 8651</span>&#160;      <span class="comment">/* Find the zone in the list */</span></div><div class="line"><a name="l08652"></a><span class="lineno"> 8652</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *z;</div><div class="line"><a name="l08653"></a><span class="lineno"> 8653</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l08654"></a><span class="lineno"> 8654</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>, z, <a class="code" href="../../d7/d13/structvm__zone.html#a824b6fba3cdf05b72afb1e22ef25a38c">list</a>) {</div><div class="line"><a name="l08655"></a><span class="lineno"> 8655</span>&#160;         <span class="keywordflow">if</span> (!strcmp(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">name</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>)) {</div><div class="line"><a name="l08656"></a><span class="lineno"> 8656</span>&#160;            the_zone = z;</div><div class="line"><a name="l08657"></a><span class="lineno"> 8657</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08658"></a><span class="lineno"> 8658</span>&#160;         }</div><div class="line"><a name="l08659"></a><span class="lineno"> 8659</span>&#160;      }</div><div class="line"><a name="l08660"></a><span class="lineno"> 8660</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l08661"></a><span class="lineno"> 8661</span>&#160;   }</div><div class="line"><a name="l08662"></a><span class="lineno"> 8662</span>&#160;</div><div class="line"><a name="l08663"></a><span class="lineno"> 8663</span>&#160;<span class="comment">/* No internal variable parsing for now, so we&#39;ll comment it out for the time being */</span></div><div class="line"><a name="l08664"></a><span class="lineno"> 8664</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l08665"></a><span class="lineno"> 8665</span>&#160;   <span class="comment">/* Set the DIFF_* variables */</span></div><div class="line"><a name="l08666"></a><span class="lineno"> 8666</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a>(&amp;t, &amp;time_now, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08667"></a><span class="lineno"> 8667</span>&#160;   tv_now = <a class="code" href="../../de/df7/time_8h.html#ad3899efb6f0e348556ef69f5b16aa7f7">ast_tvnow</a>();</div><div class="line"><a name="l08668"></a><span class="lineno"> 8668</span>&#160;   <a class="code" href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a>(&amp;tv_now, &amp;time_then, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08669"></a><span class="lineno"> 8669</span>&#160;</div><div class="line"><a name="l08670"></a><span class="lineno"> 8670</span>&#160;   <span class="comment">/* Day difference */</span></div><div class="line"><a name="l08671"></a><span class="lineno"> 8671</span>&#160;   <span class="keywordflow">if</span> (time_now.tm_year == time_then.tm_year)</div><div class="line"><a name="l08672"></a><span class="lineno"> 8672</span>&#160;      snprintf(temp, <span class="keyword">sizeof</span>(temp), <span class="stringliteral">&quot;%d&quot;</span>, time_now.tm_yday);</div><div class="line"><a name="l08673"></a><span class="lineno"> 8673</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l08674"></a><span class="lineno"> 8674</span>&#160;      snprintf(temp, <span class="keyword">sizeof</span>(temp), <span class="stringliteral">&quot;%d&quot;</span>, (time_now.tm_year - time_then.tm_year) * 365 + (time_now.tm_yday - time_then.tm_yday));</div><div class="line"><a name="l08675"></a><span class="lineno"> 8675</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;DIFF_DAY&quot;</span>, temp);</div><div class="line"><a name="l08676"></a><span class="lineno"> 8676</span>&#160;</div><div class="line"><a name="l08677"></a><span class="lineno"> 8677</span>&#160;   <span class="comment">/* Can&#39;t think of how other diffs might be helpful, but I&#39;m sure somebody will think of something. */</span></div><div class="line"><a name="l08678"></a><span class="lineno"> 8678</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08679"></a><span class="lineno"> 8679</span>&#160;   <span class="keywordflow">if</span> (the_zone) {</div><div class="line"><a name="l08680"></a><span class="lineno"> 8680</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), the_zone-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">msg_format</a>, the_zone-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>);</div><div class="line"><a name="l08681"></a><span class="lineno"> 8681</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;de&quot;</span>, 2)) {     <span class="comment">/* GERMAN syntax */</span></div><div class="line"><a name="l08682"></a><span class="lineno"> 8682</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; Q &#39;digits/at&#39; HM&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08683"></a><span class="lineno"> 8683</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;gr&quot;</span>, 2)) {     <span class="comment">/* GREEK syntax */</span></div><div class="line"><a name="l08684"></a><span class="lineno"> 8684</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; q  H &#39;digits/kai&#39; M &quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08685"></a><span class="lineno"> 8685</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;is&quot;</span>, 2)) {     <span class="comment">/* ICELANDIC syntax */</span></div><div class="line"><a name="l08686"></a><span class="lineno"> 8686</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; Q &#39;digits/at&#39; HM&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08687"></a><span class="lineno"> 8687</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;it&quot;</span>, 2)) {     <span class="comment">/* ITALIAN syntax */</span></div><div class="line"><a name="l08688"></a><span class="lineno"> 8688</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; q &#39;digits/at&#39; &#39;digits/hours&#39; k &#39;digits/e&#39; M &#39;digits/minutes&#39;&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08689"></a><span class="lineno"> 8689</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan),<span class="stringliteral">&quot;ja&quot;</span>)) {     <span class="comment">/* Japanese syntax */</span></div><div class="line"><a name="l08690"></a><span class="lineno"> 8690</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;PHM q &#39;jp-ni&#39; &#39;vm-received&#39;&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08691"></a><span class="lineno"> 8691</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;nl&quot;</span>, 2)) {     <span class="comment">/* DUTCH syntax */</span></div><div class="line"><a name="l08692"></a><span class="lineno"> 8692</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; q &#39;digits/nl-om&#39; HM&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08693"></a><span class="lineno"> 8693</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;no&quot;</span>, 2)) {     <span class="comment">/* NORWEGIAN syntax */</span></div><div class="line"><a name="l08694"></a><span class="lineno"> 8694</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; Q &#39;digits/at&#39; HM&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08695"></a><span class="lineno"> 8695</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pl&quot;</span>, 2)) {     <span class="comment">/* POLISH syntax */</span></div><div class="line"><a name="l08696"></a><span class="lineno"> 8696</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; Q HM&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08697"></a><span class="lineno"> 8697</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pt_BR&quot;</span>, 5)) {  <span class="comment">/* Brazillian PORTUGUESE syntax */</span></div><div class="line"><a name="l08698"></a><span class="lineno"> 8698</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; Ad &#39;digits/pt-de&#39; B &#39;digits/pt-de&#39; Y &#39;digits/pt-as&#39; HM &quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08699"></a><span class="lineno"> 8699</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;se&quot;</span>, 2)) {     <span class="comment">/* SWEDISH syntax */</span></div><div class="line"><a name="l08700"></a><span class="lineno"> 8700</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; dB &#39;digits/at&#39; k &#39;and&#39; M&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08701"></a><span class="lineno"> 8701</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;zh&quot;</span>, 2)) {     <span class="comment">/* CHINESE (Taiwan) syntax */</span></div><div class="line"><a name="l08702"></a><span class="lineno"> 8702</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;qR &#39;vm-received&#39;&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08703"></a><span class="lineno"> 8703</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;vi&quot;</span>, 2)) {     <span class="comment">/* VIETNAMESE syntax */</span></div><div class="line"><a name="l08704"></a><span class="lineno"> 8704</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; A &#39;digits/day&#39; dB &#39;digits/year&#39; Y &#39;digits/at&#39; k &#39;hours&#39; M &#39;minutes&#39;&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08705"></a><span class="lineno"> 8705</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08706"></a><span class="lineno"> 8706</span>&#160;      res = <a class="code" href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a>(chan, t, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;&#39;vm-received&#39; q &#39;digits/at&#39; IMp&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08707"></a><span class="lineno"> 8707</span>&#160;   }</div><div class="line"><a name="l08708"></a><span class="lineno"> 8708</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l08709"></a><span class="lineno"> 8709</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;DIFF_DAY&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08710"></a><span class="lineno"> 8710</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08711"></a><span class="lineno"> 8711</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08712"></a><span class="lineno"> 8712</span>&#160;}</div><div class="line"><a name="l08713"></a><span class="lineno"> 8713</span>&#160;</div><div class="line"><a name="l08714"></a><span class="lineno"> 8714</span>&#160;</div><div class="line"><a name="l08715"></a><span class="lineno"> 8715</span>&#160;</div><div class="line"><a name="l08716"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5fe40961f76694db47fb14e7b19ade9b"> 8716</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fe40961f76694db47fb14e7b19ade9b">play_message_callerid</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *cid, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keywordtype">int</span> callback, <span class="keywordtype">int</span> saycidnumber)</div><div class="line"><a name="l08717"></a><span class="lineno"> 8717</span>&#160;{</div><div class="line"><a name="l08718"></a><span class="lineno"> 8718</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l08719"></a><span class="lineno"> 8719</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l08720"></a><span class="lineno"> 8720</span>&#160;   <span class="keywordtype">char</span> *callerid, *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>;</div><div class="line"><a name="l08721"></a><span class="lineno"> 8721</span>&#160;   <span class="keywordtype">char</span> prefile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l08722"></a><span class="lineno"> 8722</span>&#160;</div><div class="line"><a name="l08723"></a><span class="lineno"> 8723</span>&#160;   <span class="comment">/* If voicemail cid is not enabled, or we didn&#39;t get cid or context from</span></div><div class="line"><a name="l08724"></a><span class="lineno"> 8724</span>&#160;<span class="comment">    * the attribute file, leave now.</span></div><div class="line"><a name="l08725"></a><span class="lineno"> 8725</span>&#160;<span class="comment">    *</span></div><div class="line"><a name="l08726"></a><span class="lineno"> 8726</span>&#160;<span class="comment">    * TODO Still need to change this so that if this function is called by the</span></div><div class="line"><a name="l08727"></a><span class="lineno"> 8727</span>&#160;<span class="comment">    * message envelope (and someone is explicitly requesting to hear the CID),</span></div><div class="line"><a name="l08728"></a><span class="lineno"> 8728</span>&#160;<span class="comment">    * it does not check to see if CID is enabled in the config file.</span></div><div class="line"><a name="l08729"></a><span class="lineno"> 8729</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l08730"></a><span class="lineno"> 8730</span>&#160;   <span class="keywordflow">if</span> ((cid == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)||(context == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))</div><div class="line"><a name="l08731"></a><span class="lineno"> 8731</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08732"></a><span class="lineno"> 8732</span>&#160;</div><div class="line"><a name="l08733"></a><span class="lineno"> 8733</span>&#160;   <span class="comment">/* Strip off caller ID number from name */</span></div><div class="line"><a name="l08734"></a><span class="lineno"> 8734</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: composite caller ID received: %s, context: %s\n&quot;</span>, cid, context);</div><div class="line"><a name="l08735"></a><span class="lineno"> 8735</span>&#160;   <a class="code" href="../../de/d47/callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df">ast_callerid_parse</a>(cid, &amp;name, &amp;callerid);</div><div class="line"><a name="l08736"></a><span class="lineno"> 8736</span>&#160;   <span class="keywordflow">if</span> ((!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(callerid)) &amp;&amp; strcmp(callerid, <span class="stringliteral">&quot;Unknown&quot;</span>)) {</div><div class="line"><a name="l08737"></a><span class="lineno"> 8737</span>&#160;      <span class="comment">/* Check for internal contexts and only */</span></div><div class="line"><a name="l08738"></a><span class="lineno"> 8738</span>&#160;      <span class="comment">/* say extension when the call didn&#39;t come from an internal context in the list */</span></div><div class="line"><a name="l08739"></a><span class="lineno"> 8739</span>&#160;      <span class="keywordflow">for</span> (i = 0 ; i &lt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a> ; i++){</div><div class="line"><a name="l08740"></a><span class="lineno"> 8740</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: comparing internalcontext: %s\n&quot;</span>, cidinternalcontexts[i]);</div><div class="line"><a name="l08741"></a><span class="lineno"> 8741</span>&#160;         <span class="keywordflow">if</span> ((strcmp(cidinternalcontexts[i], context) == 0))</div><div class="line"><a name="l08742"></a><span class="lineno"> 8742</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l08743"></a><span class="lineno"> 8743</span>&#160;      }</div><div class="line"><a name="l08744"></a><span class="lineno"> 8744</span>&#160;      <span class="keywordflow">if</span> (i != MAX_NUM_CID_CONTEXTS){ <span class="comment">/* internal context? */</span></div><div class="line"><a name="l08745"></a><span class="lineno"> 8745</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08746"></a><span class="lineno"> 8746</span>&#160;            snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, context, callerid);</div><div class="line"><a name="l08747"></a><span class="lineno"> 8747</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(prefile)) {</div><div class="line"><a name="l08748"></a><span class="lineno"> 8748</span>&#160;               <span class="comment">/* See if we can find a recorded name for this callerid</span></div><div class="line"><a name="l08749"></a><span class="lineno"> 8749</span>&#160;<span class="comment">                * and if found, use that instead of saying number. */</span></div><div class="line"><a name="l08750"></a><span class="lineno"> 8750</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l08751"></a><span class="lineno"> 8751</span>&#160;                  <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing envelope info: CID number &#39;%s&#39; matches mailbox number, playing recorded name\n&quot;</span>, callerid);</div><div class="line"><a name="l08752"></a><span class="lineno"> 8752</span>&#160;                  <span class="keywordflow">if</span> (!callback)</div><div class="line"><a name="l08753"></a><span class="lineno"> 8753</span>&#160;                     res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from&quot;</span>);</div><div class="line"><a name="l08754"></a><span class="lineno"> 8754</span>&#160;                  res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, prefile, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l08755"></a><span class="lineno"> 8755</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08756"></a><span class="lineno"> 8756</span>&#160;                  <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing envelope info: message from &#39;%s&#39;\n&quot;</span>, callerid);</div><div class="line"><a name="l08757"></a><span class="lineno"> 8757</span>&#160;                  <span class="comment">/* Say &quot;from extension&quot; as one saying to sound smoother */</span></div><div class="line"><a name="l08758"></a><span class="lineno"> 8758</span>&#160;                  <span class="keywordflow">if</span> (!callback)</div><div class="line"><a name="l08759"></a><span class="lineno"> 8759</span>&#160;                     res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from-extension&quot;</span>);</div><div class="line"><a name="l08760"></a><span class="lineno"> 8760</span>&#160;                  res = <a class="code" href="../../db/dce/say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce">ast_say_digit_str</a>(chan, callerid, <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08761"></a><span class="lineno"> 8761</span>&#160;               }</div><div class="line"><a name="l08762"></a><span class="lineno"> 8762</span>&#160;            }</div><div class="line"><a name="l08763"></a><span class="lineno"> 8763</span>&#160;         }</div><div class="line"><a name="l08764"></a><span class="lineno"> 8764</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08765"></a><span class="lineno"> 8765</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: Numeric caller id: (%s)\n&quot;</span>, callerid);</div><div class="line"><a name="l08766"></a><span class="lineno"> 8766</span>&#160;         <span class="comment">/* If there is a recording for this numeric callerid then play that */</span></div><div class="line"><a name="l08767"></a><span class="lineno"> 8767</span>&#160;         <span class="keywordflow">if</span> (!callback) {</div><div class="line"><a name="l08768"></a><span class="lineno"> 8768</span>&#160;            <span class="comment">/* See if we can find a recorded name for this person instead of their extension number */</span></div><div class="line"><a name="l08769"></a><span class="lineno"> 8769</span>&#160;            snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s/recordings/callerids/%s&quot;</span>, <a class="code" href="../../dd/df2/paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>, callerid);</div><div class="line"><a name="l08770"></a><span class="lineno"> 8770</span>&#160;            <span class="keywordflow">if</span> (!saycidnumber &amp;&amp; <a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l08771"></a><span class="lineno"> 8771</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing recorded name for CID number &#39;%s&#39; - &#39;%s&#39;\n&quot;</span>, callerid,prefile);</div><div class="line"><a name="l08772"></a><span class="lineno"> 8772</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from&quot;</span>);</div><div class="line"><a name="l08773"></a><span class="lineno"> 8773</span>&#160;               res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, prefile, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l08774"></a><span class="lineno"> 8774</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Played recorded name result &#39;%d&#39;\n&quot;</span>, res);</div><div class="line"><a name="l08775"></a><span class="lineno"> 8775</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08776"></a><span class="lineno"> 8776</span>&#160;               <span class="comment">/* Since this is all nicely figured out, why not say &quot;from phone number&quot; in this case&quot; */</span></div><div class="line"><a name="l08777"></a><span class="lineno"> 8777</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from-phonenumber&quot;</span>);</div><div class="line"><a name="l08778"></a><span class="lineno"> 8778</span>&#160;               res = <a class="code" href="../../db/dce/say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce">ast_say_digit_str</a>(chan, callerid, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08779"></a><span class="lineno"> 8779</span>&#160;            }</div><div class="line"><a name="l08780"></a><span class="lineno"> 8780</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08781"></a><span class="lineno"> 8781</span>&#160;            res = <a class="code" href="../../db/dce/say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce">ast_say_digit_str</a>(chan, callerid, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08782"></a><span class="lineno"> 8782</span>&#160;         }</div><div class="line"><a name="l08783"></a><span class="lineno"> 8783</span>&#160;      }</div><div class="line"><a name="l08784"></a><span class="lineno"> 8784</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08785"></a><span class="lineno"> 8785</span>&#160;      <span class="comment">/* Number unknown */</span></div><div class="line"><a name="l08786"></a><span class="lineno"> 8786</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: From an unknown number\n&quot;</span>);</div><div class="line"><a name="l08787"></a><span class="lineno"> 8787</span>&#160;      <span class="comment">/* Say &quot;from an unknown caller&quot; as one phrase - it is already recorded by &quot;the voice&quot; anyhow */</span></div><div class="line"><a name="l08788"></a><span class="lineno"> 8788</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-unknown-caller&quot;</span>);</div><div class="line"><a name="l08789"></a><span class="lineno"> 8789</span>&#160;   }</div><div class="line"><a name="l08790"></a><span class="lineno"> 8790</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08791"></a><span class="lineno"> 8791</span>&#160;}</div><div class="line"><a name="l08792"></a><span class="lineno"> 8792</span>&#160;</div><div class="line"><a name="l08793"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a"> 8793</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a">play_message_duration</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *duration, <span class="keywordtype">int</span> minduration)</div><div class="line"><a name="l08794"></a><span class="lineno"> 8794</span>&#160;{</div><div class="line"><a name="l08795"></a><span class="lineno"> 8795</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l08796"></a><span class="lineno"> 8796</span>&#160;   <span class="keywordtype">int</span> durationm;</div><div class="line"><a name="l08797"></a><span class="lineno"> 8797</span>&#160;   <span class="keywordtype">int</span> durations;</div><div class="line"><a name="l08798"></a><span class="lineno"> 8798</span>&#160;   <span class="comment">/* Verify that we have a duration for the message */</span></div><div class="line"><a name="l08799"></a><span class="lineno"> 8799</span>&#160;   <span class="keywordflow">if</span> (duration == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line"><a name="l08800"></a><span class="lineno"> 8800</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08801"></a><span class="lineno"> 8801</span>&#160;</div><div class="line"><a name="l08802"></a><span class="lineno"> 8802</span>&#160;   <span class="comment">/* Convert from seconds to minutes */</span></div><div class="line"><a name="l08803"></a><span class="lineno"> 8803</span>&#160;   durations = atoi(duration);</div><div class="line"><a name="l08804"></a><span class="lineno"> 8804</span>&#160;   durationm = (durations / 60);</div><div class="line"><a name="l08805"></a><span class="lineno"> 8805</span>&#160;</div><div class="line"><a name="l08806"></a><span class="lineno"> 8806</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM-Duration: duration is: %d seconds converted to: %d minutes\n&quot;</span>, durations, durationm);</div><div class="line"><a name="l08807"></a><span class="lineno"> 8807</span>&#160;</div><div class="line"><a name="l08808"></a><span class="lineno"> 8808</span>&#160;   <span class="keywordflow">if</span> ((!res) &amp;&amp; (durationm &gt;= minduration)) {</div><div class="line"><a name="l08809"></a><span class="lineno"> 8809</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-duration&quot;</span>);</div><div class="line"><a name="l08810"></a><span class="lineno"> 8810</span>&#160;</div><div class="line"><a name="l08811"></a><span class="lineno"> 8811</span>&#160;      <span class="comment">/* POLISH syntax */</span></div><div class="line"><a name="l08812"></a><span class="lineno"> 8812</span>&#160;      <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pl&quot;</span>, 2)) {</div><div class="line"><a name="l08813"></a><span class="lineno"> 8813</span>&#160;         div_t num = div(durationm, 10);</div><div class="line"><a name="l08814"></a><span class="lineno"> 8814</span>&#160;</div><div class="line"><a name="l08815"></a><span class="lineno"> 8815</span>&#160;         <span class="keywordflow">if</span> (durationm == 1) {</div><div class="line"><a name="l08816"></a><span class="lineno"> 8816</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1z&quot;</span>);</div><div class="line"><a name="l08817"></a><span class="lineno"> 8817</span>&#160;            res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-minute-ta&quot;</span>);</div><div class="line"><a name="l08818"></a><span class="lineno"> 8818</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {</div><div class="line"><a name="l08819"></a><span class="lineno"> 8819</span>&#160;            <span class="keywordflow">if</span> (num.rem == 2) {</div><div class="line"><a name="l08820"></a><span class="lineno"> 8820</span>&#160;               <span class="keywordflow">if</span> (!num.quot) {</div><div class="line"><a name="l08821"></a><span class="lineno"> 8821</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);</div><div class="line"><a name="l08822"></a><span class="lineno"> 8822</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08823"></a><span class="lineno"> 8823</span>&#160;                  res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, durationm - 2 , <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08824"></a><span class="lineno"> 8824</span>&#160;                  res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);</div><div class="line"><a name="l08825"></a><span class="lineno"> 8825</span>&#160;               }</div><div class="line"><a name="l08826"></a><span class="lineno"> 8826</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08827"></a><span class="lineno"> 8827</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, durationm, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08828"></a><span class="lineno"> 8828</span>&#160;            }</div><div class="line"><a name="l08829"></a><span class="lineno"> 8829</span>&#160;            res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-minute-ty&quot;</span>);</div><div class="line"><a name="l08830"></a><span class="lineno"> 8830</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08831"></a><span class="lineno"> 8831</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, durationm, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l08832"></a><span class="lineno"> 8832</span>&#160;            res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-minute-t&quot;</span>);</div><div class="line"><a name="l08833"></a><span class="lineno"> 8833</span>&#160;         }</div><div class="line"><a name="l08834"></a><span class="lineno"> 8834</span>&#160;      <span class="comment">/* DEFAULT syntax */</span></div><div class="line"><a name="l08835"></a><span class="lineno"> 8835</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08836"></a><span class="lineno"> 8836</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, durationm, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08837"></a><span class="lineno"> 8837</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-minutes&quot;</span>);</div><div class="line"><a name="l08838"></a><span class="lineno"> 8838</span>&#160;      }</div><div class="line"><a name="l08839"></a><span class="lineno"> 8839</span>&#160;   }</div><div class="line"><a name="l08840"></a><span class="lineno"> 8840</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l08841"></a><span class="lineno"> 8841</span>&#160;}</div><div class="line"><a name="l08842"></a><span class="lineno"> 8842</span>&#160;</div><div class="line"><a name="l08843"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c"> 8843</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l08844"></a><span class="lineno"> 8844</span>&#160;{</div><div class="line"><a name="l08845"></a><span class="lineno"> 8845</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l08846"></a><span class="lineno"> 8846</span>&#160;   <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>], *cid;</div><div class="line"><a name="l08847"></a><span class="lineno"> 8847</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime, *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *category, *duration, *<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>;</div><div class="line"><a name="l08848"></a><span class="lineno"> 8848</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l08849"></a><span class="lineno"> 8849</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l08850"></a><span class="lineno"> 8850</span>&#160;</div><div class="line"><a name="l08851"></a><span class="lineno"> 8851</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 0;</div><div class="line"><a name="l08852"></a><span class="lineno"> 8852</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l08853"></a><span class="lineno"> 8853</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a>(chan, vms);</div><div class="line"><a name="l08854"></a><span class="lineno"> 8854</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l08855"></a><span class="lineno"> 8855</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-first&quot;</span>);  <span class="comment">/* &quot;First&quot; */</span></div><div class="line"><a name="l08856"></a><span class="lineno"> 8856</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> == vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l08857"></a><span class="lineno"> 8857</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-last&quot;</span>);      <span class="comment">/* &quot;last&quot; */</span></div><div class="line"><a name="l08858"></a><span class="lineno"> 8858</span>&#160;   }</div><div class="line"><a name="l08859"></a><span class="lineno"> 8859</span>&#160;</div><div class="line"><a name="l08860"></a><span class="lineno"> 8860</span>&#160;   snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l08861"></a><span class="lineno"> 8861</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l08862"></a><span class="lineno"> 8862</span>&#160;   msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l08863"></a><span class="lineno"> 8863</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg)) {</div><div class="line"><a name="l08864"></a><span class="lineno"> 8864</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No message attribute file?!! (%s)\n&quot;</span>, filename);</div><div class="line"><a name="l08865"></a><span class="lineno"> 8865</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l08866"></a><span class="lineno"> 8866</span>&#160;   }</div><div class="line"><a name="l08867"></a><span class="lineno"> 8867</span>&#160;   flag = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;flag&quot;</span>);</div><div class="line"><a name="l08868"></a><span class="lineno"> 8868</span>&#160;</div><div class="line"><a name="l08869"></a><span class="lineno"> 8869</span>&#160;   <span class="comment">/* Play the word urgent if we are listening to urgent messages */</span></div><div class="line"><a name="l08870"></a><span class="lineno"> 8870</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) {</div><div class="line"><a name="l08871"></a><span class="lineno"> 8871</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-Urgent&quot;</span>); <span class="comment">/* &quot;urgent&quot; */</span></div><div class="line"><a name="l08872"></a><span class="lineno"> 8872</span>&#160;   }</div><div class="line"><a name="l08873"></a><span class="lineno"> 8873</span>&#160;</div><div class="line"><a name="l08874"></a><span class="lineno"> 8874</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08875"></a><span class="lineno"> 8875</span>&#160;      <span class="comment">/* XXX Why are we playing messages above, and then playing the same language-specific stuff here? */</span></div><div class="line"><a name="l08876"></a><span class="lineno"> 8876</span>&#160;      <span class="comment">/* POLISH syntax */</span></div><div class="line"><a name="l08877"></a><span class="lineno"> 8877</span>&#160;      <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pl&quot;</span>, 2)) {</div><div class="line"><a name="l08878"></a><span class="lineno"> 8878</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)) {</div><div class="line"><a name="l08879"></a><span class="lineno"> 8879</span>&#160;            <span class="keywordtype">int</span> ten, one;</div><div class="line"><a name="l08880"></a><span class="lineno"> 8880</span>&#160;            <span class="keywordtype">char</span> nextmsg[256];</div><div class="line"><a name="l08881"></a><span class="lineno"> 8881</span>&#160;            ten = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1) / 10;</div><div class="line"><a name="l08882"></a><span class="lineno"> 8882</span>&#160;            one = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1) % 10;</div><div class="line"><a name="l08883"></a><span class="lineno"> 8883</span>&#160;</div><div class="line"><a name="l08884"></a><span class="lineno"> 8884</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; 20) {</div><div class="line"><a name="l08885"></a><span class="lineno"> 8885</span>&#160;               snprintf(nextmsg, <span class="keyword">sizeof</span>(nextmsg), <span class="stringliteral">&quot;digits/n-%d&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1);</div><div class="line"><a name="l08886"></a><span class="lineno"> 8886</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, nextmsg);</div><div class="line"><a name="l08887"></a><span class="lineno"> 8887</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08888"></a><span class="lineno"> 8888</span>&#160;               snprintf(nextmsg, <span class="keyword">sizeof</span>(nextmsg), <span class="stringliteral">&quot;digits/n-%d&quot;</span>, ten * 10);</div><div class="line"><a name="l08889"></a><span class="lineno"> 8889</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, nextmsg);</div><div class="line"><a name="l08890"></a><span class="lineno"> 8890</span>&#160;               <span class="keywordflow">if</span> (one &gt; 0) {</div><div class="line"><a name="l08891"></a><span class="lineno"> 8891</span>&#160;                  <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08892"></a><span class="lineno"> 8892</span>&#160;                     snprintf(nextmsg, <span class="keyword">sizeof</span>(nextmsg), <span class="stringliteral">&quot;digits/n-%d&quot;</span>, one);</div><div class="line"><a name="l08893"></a><span class="lineno"> 8893</span>&#160;                     res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, nextmsg);</div><div class="line"><a name="l08894"></a><span class="lineno"> 8894</span>&#160;                  }</div><div class="line"><a name="l08895"></a><span class="lineno"> 8895</span>&#160;               }</div><div class="line"><a name="l08896"></a><span class="lineno"> 8896</span>&#160;            }</div><div class="line"><a name="l08897"></a><span class="lineno"> 8897</span>&#160;         }</div><div class="line"><a name="l08898"></a><span class="lineno"> 8898</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l08899"></a><span class="lineno"> 8899</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08900"></a><span class="lineno"> 8900</span>&#160;      <span class="comment">/* HEBREW syntax */</span></div><div class="line"><a name="l08901"></a><span class="lineno"> 8901</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;he&quot;</span>, 2)) {</div><div class="line"><a name="l08902"></a><span class="lineno"> 8902</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l08903"></a><span class="lineno"> 8903</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08904"></a><span class="lineno"> 8904</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-first&quot;</span>);</div><div class="line"><a name="l08905"></a><span class="lineno"> 8905</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> == vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l08906"></a><span class="lineno"> 8906</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08907"></a><span class="lineno"> 8907</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-last&quot;</span>);</div><div class="line"><a name="l08908"></a><span class="lineno"> 8908</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08909"></a><span class="lineno"> 8909</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08910"></a><span class="lineno"> 8910</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-number&quot;</span>);</div><div class="line"><a name="l08911"></a><span class="lineno"> 8911</span>&#160;            res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l08912"></a><span class="lineno"> 8912</span>&#160;         }</div><div class="line"><a name="l08913"></a><span class="lineno"> 8913</span>&#160;      <span class="comment">/* ICELANDIC syntax */</span></div><div class="line"><a name="l08914"></a><span class="lineno"> 8914</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;is&quot;</span>, 2)) {</div><div class="line"><a name="l08915"></a><span class="lineno"> 8915</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08916"></a><span class="lineno"> 8916</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)) {</div><div class="line"><a name="l08917"></a><span class="lineno"> 8917</span>&#160;            res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;n&quot;</span>);</div><div class="line"><a name="l08918"></a><span class="lineno"> 8918</span>&#160;         }</div><div class="line"><a name="l08919"></a><span class="lineno"> 8919</span>&#160;      <span class="comment">/* VIETNAMESE syntax */</span></div><div class="line"><a name="l08920"></a><span class="lineno"> 8920</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;vi&quot;</span>, 2)) {</div><div class="line"><a name="l08921"></a><span class="lineno"> 8921</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {</div><div class="line"><a name="l08922"></a><span class="lineno"> 8922</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08923"></a><span class="lineno"> 8923</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-first&quot;</span>);</div><div class="line"><a name="l08924"></a><span class="lineno"> 8924</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> == vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l08925"></a><span class="lineno"> 8925</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08926"></a><span class="lineno"> 8926</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-last&quot;</span>);</div><div class="line"><a name="l08927"></a><span class="lineno"> 8927</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08928"></a><span class="lineno"> 8928</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08929"></a><span class="lineno"> 8929</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-number&quot;</span>);</div><div class="line"><a name="l08930"></a><span class="lineno"> 8930</span>&#160;            res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l08931"></a><span class="lineno"> 8931</span>&#160;         }</div><div class="line"><a name="l08932"></a><span class="lineno"> 8932</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l08933"></a><span class="lineno"> 8933</span>&#160;         <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;se&quot;</span>, 2)) { <span class="comment">/* SWEDISH syntax */</span></div><div class="line"><a name="l08934"></a><span class="lineno"> 8934</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-meddelandet&quot;</span>);  <span class="comment">/* &quot;message&quot; */</span></div><div class="line"><a name="l08935"></a><span class="lineno"> 8935</span>&#160;         } <span class="keywordflow">else</span> { <span class="comment">/* DEFAULT syntax */</span></div><div class="line"><a name="l08936"></a><span class="lineno"> 8936</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l08937"></a><span class="lineno"> 8937</span>&#160;         }</div><div class="line"><a name="l08938"></a><span class="lineno"> 8938</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)) {</div><div class="line"><a name="l08939"></a><span class="lineno"> 8939</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08940"></a><span class="lineno"> 8940</span>&#160;               <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>, <span class="stringliteral">&quot;Message: message number&quot;</span>);</div><div class="line"><a name="l08941"></a><span class="lineno"> 8941</span>&#160;               res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l08942"></a><span class="lineno"> 8942</span>&#160;            }</div><div class="line"><a name="l08943"></a><span class="lineno"> 8943</span>&#160;         }</div><div class="line"><a name="l08944"></a><span class="lineno"> 8944</span>&#160;      }</div><div class="line"><a name="l08945"></a><span class="lineno"> 8945</span>&#160;   }</div><div class="line"><a name="l08946"></a><span class="lineno"> 8946</span>&#160;</div><div class="line"><a name="l08947"></a><span class="lineno"> 8947</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg)) {</div><div class="line"><a name="l08948"></a><span class="lineno"> 8948</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No message attribute file?!! (%s)\n&quot;</span>, filename);</div><div class="line"><a name="l08949"></a><span class="lineno"> 8949</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l08950"></a><span class="lineno"> 8950</span>&#160;   }</div><div class="line"><a name="l08951"></a><span class="lineno"> 8951</span>&#160;</div><div class="line"><a name="l08952"></a><span class="lineno"> 8952</span>&#160;   <span class="keywordflow">if</span> (!(origtime = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {</div><div class="line"><a name="l08953"></a><span class="lineno"> 8953</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No origtime?!\n&quot;</span>);</div><div class="line"><a name="l08954"></a><span class="lineno"> 8954</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l08955"></a><span class="lineno"> 8955</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l08956"></a><span class="lineno"> 8956</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l08957"></a><span class="lineno"> 8957</span>&#160;   }</div><div class="line"><a name="l08958"></a><span class="lineno"> 8958</span>&#160;</div><div class="line"><a name="l08959"></a><span class="lineno"> 8959</span>&#160;   cid = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>));</div><div class="line"><a name="l08960"></a><span class="lineno"> 8960</span>&#160;   duration = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>);</div><div class="line"><a name="l08961"></a><span class="lineno"> 8961</span>&#160;   category = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;category&quot;</span>);</div><div class="line"><a name="l08962"></a><span class="lineno"> 8962</span>&#160;</div><div class="line"><a name="l08963"></a><span class="lineno"> 8963</span>&#160;   context = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>);</div><div class="line"><a name="l08964"></a><span class="lineno"> 8964</span>&#160;   <span class="keywordflow">if</span> (!strncasecmp(<span class="stringliteral">&quot;macro&quot;</span>, context, 5)) <span class="comment">/* Macro names in contexts are useless for our needs */</span></div><div class="line"><a name="l08965"></a><span class="lineno"> 8965</span>&#160;      context = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;macrocontext&quot;</span>);</div><div class="line"><a name="l08966"></a><span class="lineno"> 8966</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08967"></a><span class="lineno"> 8967</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7">play_message_category</a>(chan, category);</div><div class="line"><a name="l08968"></a><span class="lineno"> 8968</span>&#160;   }</div><div class="line"><a name="l08969"></a><span class="lineno"> 8969</span>&#160;   <span class="keywordflow">if</span> ((!res) &amp;&amp; (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>))) {</div><div class="line"><a name="l08970"></a><span class="lineno"> 8970</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a>(chan, vmu, origtime, filename);</div><div class="line"><a name="l08971"></a><span class="lineno"> 8971</span>&#160;   }</div><div class="line"><a name="l08972"></a><span class="lineno"> 8972</span>&#160;   <span class="keywordflow">if</span> ((!res) &amp;&amp; (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>))) {</div><div class="line"><a name="l08973"></a><span class="lineno"> 8973</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fe40961f76694db47fb14e7b19ade9b">play_message_callerid</a>(chan, vms, cid, context, 0, 0);</div><div class="line"><a name="l08974"></a><span class="lineno"> 8974</span>&#160;   }</div><div class="line"><a name="l08975"></a><span class="lineno"> 8975</span>&#160;   <span class="keywordflow">if</span> ((!res) &amp;&amp; (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>))) {</div><div class="line"><a name="l08976"></a><span class="lineno"> 8976</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a">play_message_duration</a>(chan, vms, duration, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a>);</div><div class="line"><a name="l08977"></a><span class="lineno"> 8977</span>&#160;   }</div><div class="line"><a name="l08978"></a><span class="lineno"> 8978</span>&#160;   <span class="comment">/* Allow pressing &#39;1&#39; to skip envelope / callerid */</span></div><div class="line"><a name="l08979"></a><span class="lineno"> 8979</span>&#160;   <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;1&#39;</span>) {</div><div class="line"><a name="l08980"></a><span class="lineno"> 8980</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>, res, res);</div><div class="line"><a name="l08981"></a><span class="lineno"> 8981</span>&#160;      res = 0;</div><div class="line"><a name="l08982"></a><span class="lineno"> 8982</span>&#160;   }</div><div class="line"><a name="l08983"></a><span class="lineno"> 8983</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l08984"></a><span class="lineno"> 8984</span>&#160;</div><div class="line"><a name="l08985"></a><span class="lineno"> 8985</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l08986"></a><span class="lineno"> 8986</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l08987"></a><span class="lineno"> 8987</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08988"></a><span class="lineno"> 8988</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l08989"></a><span class="lineno"> 8989</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l08990"></a><span class="lineno"> 8990</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 1;</div><div class="line"><a name="l08991"></a><span class="lineno"> 8991</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l08992"></a><span class="lineno"> 8992</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l08993"></a><span class="lineno"> 8993</span>&#160;      <span class="comment">/*IMAP storage stores any prepended message from a forward</span></div><div class="line"><a name="l08994"></a><span class="lineno"> 8994</span>&#160;<span class="comment">       * as a separate file from the rest of the message</span></div><div class="line"><a name="l08995"></a><span class="lineno"> 8995</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l08996"></a><span class="lineno"> 8996</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vms-&gt;introfn) &amp;&amp; <a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(vms-&gt;introfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l08997"></a><span class="lineno"> 8997</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;introfn);</div><div class="line"><a name="l08998"></a><span class="lineno"> 8998</span>&#160;      }</div><div class="line"><a name="l08999"></a><span class="lineno"> 8999</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l09000"></a><span class="lineno"> 9000</span>&#160;      <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>)) &lt; 0) {</div><div class="line"><a name="l09001"></a><span class="lineno"> 9001</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Playback of message %s failed\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l09002"></a><span class="lineno"> 9002</span>&#160;         res = 0;</div><div class="line"><a name="l09003"></a><span class="lineno"> 9003</span>&#160;      }</div><div class="line"><a name="l09004"></a><span class="lineno"> 9004</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l09005"></a><span class="lineno"> 9005</span>&#160;         isprint(res) ? res : <span class="charliteral">&#39;?&#39;</span>, isprint(res) ? res : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l09006"></a><span class="lineno"> 9006</span>&#160;   }</div><div class="line"><a name="l09007"></a><span class="lineno"> 9007</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l09008"></a><span class="lineno"> 9008</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09009"></a><span class="lineno"> 9009</span>&#160;}</div><div class="line"><a name="l09010"></a><span class="lineno"> 9010</span>&#160;</div><div class="line"><a name="l09011"></a><span class="lineno"> 9011</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l09012"></a><span class="lineno"> 9012</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_remove_file(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)</div><div class="line"><a name="l09013"></a><span class="lineno"> 9013</span>&#160;{</div><div class="line"><a name="l09014"></a><span class="lineno"> 9014</span>&#160;   <span class="keywordtype">char</span> fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l09015"></a><span class="lineno"> 9015</span>&#160;   <span class="keywordtype">char</span> full_fn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l09016"></a><span class="lineno"> 9016</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../dd/d27/res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">intro</a>[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = {0,};</div><div class="line"><a name="l09017"></a><span class="lineno"> 9017</span>&#160;</div><div class="line"><a name="l09018"></a><span class="lineno"> 9018</span>&#160;   <span class="keywordflow">if</span> (msgnum &gt; -1) {</div><div class="line"><a name="l09019"></a><span class="lineno"> 9019</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);</div><div class="line"><a name="l09020"></a><span class="lineno"> 9020</span>&#160;      snprintf(intro, <span class="keyword">sizeof</span>(intro), <span class="stringliteral">&quot;%sintro&quot;</span>, fn);</div><div class="line"><a name="l09021"></a><span class="lineno"> 9021</span>&#160;   } <span class="keywordflow">else</span></div><div class="line"><a name="l09022"></a><span class="lineno"> 9022</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));</div><div class="line"><a name="l09023"></a><span class="lineno"> 9023</span>&#160;</div><div class="line"><a name="l09024"></a><span class="lineno"> 9024</span>&#160;   <span class="keywordflow">if</span> ((msgnum &lt; 0 &amp;&amp; imapgreetings) || msgnum &gt; -1) {</div><div class="line"><a name="l09025"></a><span class="lineno"> 9025</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l09026"></a><span class="lineno"> 9026</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(intro)) {</div><div class="line"><a name="l09027"></a><span class="lineno"> 9027</span>&#160;         <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(intro, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l09028"></a><span class="lineno"> 9028</span>&#160;      }</div><div class="line"><a name="l09029"></a><span class="lineno"> 9029</span>&#160;      snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);</div><div class="line"><a name="l09030"></a><span class="lineno"> 9030</span>&#160;      unlink(full_fn);</div><div class="line"><a name="l09031"></a><span class="lineno"> 9031</span>&#160;   }</div><div class="line"><a name="l09032"></a><span class="lineno"> 9032</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l09033"></a><span class="lineno"> 9033</span>&#160;}</div><div class="line"><a name="l09034"></a><span class="lineno"> 9034</span>&#160;</div><div class="line"><a name="l09035"></a><span class="lineno"> 9035</span>&#160;</div><div class="line"><a name="l09036"></a><span class="lineno"> 9036</span>&#160;</div><div class="line"><a name="l09037"></a><span class="lineno"> 9037</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_delete_old_greeting (<span class="keywordtype">char</span> *dir, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09038"></a><span class="lineno"> 9038</span>&#160;{</div><div class="line"><a name="l09039"></a><span class="lineno"> 9039</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>, *filename;</div><div class="line"><a name="l09040"></a><span class="lineno"> 9040</span>&#160;   <span class="keywordtype">char</span> arg[11];</div><div class="line"><a name="l09041"></a><span class="lineno"> 9041</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l09042"></a><span class="lineno"> 9042</span>&#160;   BODY* body;</div><div class="line"><a name="l09043"></a><span class="lineno"> 9043</span>&#160;   <span class="keywordtype">int</span> curr_mbox;</div><div class="line"><a name="l09044"></a><span class="lineno"> 9044</span>&#160;</div><div class="line"><a name="l09045"></a><span class="lineno"> 9045</span>&#160;   file = strrchr(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(dir), <span class="charliteral">&#39;/&#39;</span>);</div><div class="line"><a name="l09046"></a><span class="lineno"> 9046</span>&#160;   <span class="keywordflow">if</span> (file) {</div><div class="line"><a name="l09047"></a><span class="lineno"> 9047</span>&#160;      *file++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l09048"></a><span class="lineno"> 9048</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09049"></a><span class="lineno"> 9049</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to procure file name from directory passed. You should never see this.\n&quot;</span>);</div><div class="line"><a name="l09050"></a><span class="lineno"> 9050</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l09051"></a><span class="lineno"> 9051</span>&#160;   }</div><div class="line"><a name="l09052"></a><span class="lineno"> 9052</span>&#160;</div><div class="line"><a name="l09053"></a><span class="lineno"> 9053</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l09054"></a><span class="lineno"> 9054</span>&#160;</div><div class="line"><a name="l09055"></a><span class="lineno"> 9055</span>&#160;   <span class="comment">/* get the current mailbox so that we can point the mailstream back to it later */</span></div><div class="line"><a name="l09056"></a><span class="lineno"> 9056</span>&#160;   curr_mbox = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l09057"></a><span class="lineno"> 9057</span>&#160;</div><div class="line"><a name="l09058"></a><span class="lineno"> 9058</span>&#160;   <span class="keywordflow">if</span> (init_mailstream(vms, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>) || !vms-&gt;mailstream) {</div><div class="line"><a name="l09059"></a><span class="lineno"> 9059</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream is NULL or can&#39;t init_mailstream\n&quot;</span>);</div><div class="line"><a name="l09060"></a><span class="lineno"> 9060</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l09061"></a><span class="lineno"> 9061</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l09062"></a><span class="lineno"> 9062</span>&#160;   }</div><div class="line"><a name="l09063"></a><span class="lineno"> 9063</span>&#160;</div><div class="line"><a name="l09064"></a><span class="lineno"> 9064</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; vms-&gt;mailstream-&gt;nmsgs; i++) {</div><div class="line"><a name="l09065"></a><span class="lineno"> 9065</span>&#160;      mail_fetchstructure(vms-&gt;mailstream, i + 1, &amp;body);</div><div class="line"><a name="l09066"></a><span class="lineno"> 9066</span>&#160;      <span class="comment">/* We have the body, now we extract the file name of the first attachment. */</span></div><div class="line"><a name="l09067"></a><span class="lineno"> 9067</span>&#160;      <span class="keywordflow">if</span> (body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {</div><div class="line"><a name="l09068"></a><span class="lineno"> 9068</span>&#160;         <span class="keywordtype">char</span> *attachment = body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value;</div><div class="line"><a name="l09069"></a><span class="lineno"> 9069</span>&#160;         <span class="keywordtype">char</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>[strlen(attachment) + 1];</div><div class="line"><a name="l09070"></a><span class="lineno"> 9070</span>&#160;</div><div class="line"><a name="l09071"></a><span class="lineno"> 9071</span>&#160;         strcpy(copy, attachment); <span class="comment">/* safe */</span></div><div class="line"><a name="l09072"></a><span class="lineno"> 9072</span>&#160;         attachment = <a class="code" href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a>;</div><div class="line"><a name="l09073"></a><span class="lineno"> 9073</span>&#160;</div><div class="line"><a name="l09074"></a><span class="lineno"> 9074</span>&#160;         filename = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;attachment, <span class="stringliteral">&quot;.&quot;</span>);</div><div class="line"><a name="l09075"></a><span class="lineno"> 9075</span>&#160;         <span class="keywordflow">if</span> (!strcmp(filename, file)) {</div><div class="line"><a name="l09076"></a><span class="lineno"> 9076</span>&#160;            snprintf(arg, <span class="keyword">sizeof</span>(arg), <span class="stringliteral">&quot;%d&quot;</span>, i + 1);</div><div class="line"><a name="l09077"></a><span class="lineno"> 9077</span>&#160;            mail_setflag(vms-&gt;mailstream, arg, <span class="stringliteral">&quot;\\DELETED&quot;</span>);</div><div class="line"><a name="l09078"></a><span class="lineno"> 9078</span>&#160;         }</div><div class="line"><a name="l09079"></a><span class="lineno"> 9079</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09080"></a><span class="lineno"> 9080</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;There is no file attached to this IMAP message.\n&quot;</span>);</div><div class="line"><a name="l09081"></a><span class="lineno"> 9081</span>&#160;         <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l09082"></a><span class="lineno"> 9082</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l09083"></a><span class="lineno"> 9083</span>&#160;      }</div><div class="line"><a name="l09084"></a><span class="lineno"> 9084</span>&#160;   }</div><div class="line"><a name="l09085"></a><span class="lineno"> 9085</span>&#160;   mail_expunge(vms-&gt;mailstream);</div><div class="line"><a name="l09086"></a><span class="lineno"> 9086</span>&#160;</div><div class="line"><a name="l09087"></a><span class="lineno"> 9087</span>&#160;   <span class="keywordflow">if</span> (curr_mbox != -1) {</div><div class="line"><a name="l09088"></a><span class="lineno"> 9088</span>&#160;      <span class="comment">/* restore previous mbox stream */</span></div><div class="line"><a name="l09089"></a><span class="lineno"> 9089</span>&#160;      <span class="keywordflow">if</span> (init_mailstream(vms, curr_mbox) || !vms-&gt;mailstream) {</div><div class="line"><a name="l09090"></a><span class="lineno"> 9090</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream is NULL or can&#39;t init_mailstream\n&quot;</span>);</div><div class="line"><a name="l09091"></a><span class="lineno"> 9091</span>&#160;      }</div><div class="line"><a name="l09092"></a><span class="lineno"> 9092</span>&#160;   }</div><div class="line"><a name="l09093"></a><span class="lineno"> 9093</span>&#160;</div><div class="line"><a name="l09094"></a><span class="lineno"> 9094</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l09095"></a><span class="lineno"> 9095</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l09096"></a><span class="lineno"> 9096</span>&#160;}</div><div class="line"><a name="l09097"></a><span class="lineno"> 9097</span>&#160;</div><div class="line"><a name="l09098"></a><span class="lineno"> 9098</span>&#160;<span class="preprocessor">#elif !defined(IMAP_STORAGE)</span></div><div class="line"><a name="l09099"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc"> 9099</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box)</div><div class="line"><a name="l09100"></a><span class="lineno"> 9100</span>&#160;{</div><div class="line"><a name="l09101"></a><span class="lineno"> 9101</span>&#160;   <span class="keywordtype">int</span> count_msg, last_msg;</div><div class="line"><a name="l09102"></a><span class="lineno"> 9102</span>&#160;</div><div class="line"><a name="l09103"></a><span class="lineno"> 9103</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box), <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));</div><div class="line"><a name="l09104"></a><span class="lineno"> 9104</span>&#160;</div><div class="line"><a name="l09105"></a><span class="lineno"> 9105</span>&#160;   <span class="comment">/* Rename the member vmbox HERE so that we don&#39;t try to return before</span></div><div class="line"><a name="l09106"></a><span class="lineno"> 9106</span>&#160;<span class="comment">    * we know what&#39;s going on.</span></div><div class="line"><a name="l09107"></a><span class="lineno"> 9107</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l09108"></a><span class="lineno"> 9108</span>&#160;   snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l09109"></a><span class="lineno"> 9109</span>&#160;</div><div class="line"><a name="l09110"></a><span class="lineno"> 9110</span>&#160;   <span class="comment">/* Faster to make the directory than to check if it exists. */</span></div><div class="line"><a name="l09111"></a><span class="lineno"> 9111</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l09112"></a><span class="lineno"> 9112</span>&#160;</div><div class="line"><a name="l09113"></a><span class="lineno"> 9113</span>&#160;   <span class="comment">/* traverses directory using readdir (or select query for ODBC) */</span></div><div class="line"><a name="l09114"></a><span class="lineno"> 9114</span>&#160;   count_msg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a>(vmu, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);</div><div class="line"><a name="l09115"></a><span class="lineno"> 9115</span>&#160;   <span class="keywordflow">if</span> (count_msg &lt; 0) {</div><div class="line"><a name="l09116"></a><span class="lineno"> 9116</span>&#160;      <span class="keywordflow">return</span> count_msg;</div><div class="line"><a name="l09117"></a><span class="lineno"> 9117</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09118"></a><span class="lineno"> 9118</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = count_msg - 1;</div><div class="line"><a name="l09119"></a><span class="lineno"> 9119</span>&#160;   }</div><div class="line"><a name="l09120"></a><span class="lineno"> 9120</span>&#160;</div><div class="line"><a name="l09121"></a><span class="lineno"> 9121</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a8c38a20df9d7ac0e6aa6e1d9e18e5356">vm_allocate_dh</a>(vms, vmu, count_msg)) {</div><div class="line"><a name="l09122"></a><span class="lineno"> 9122</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l09123"></a><span class="lineno"> 9123</span>&#160;   }</div><div class="line"><a name="l09124"></a><span class="lineno"> 9124</span>&#160;</div><div class="line"><a name="l09125"></a><span class="lineno"> 9125</span>&#160;   <span class="comment">/*</span></div><div class="line"><a name="l09126"></a><span class="lineno"> 9126</span>&#160;<span class="comment">   The following test is needed in case sequencing gets messed up.</span></div><div class="line"><a name="l09127"></a><span class="lineno"> 9127</span>&#160;<span class="comment">   There appears to be more than one way to mess up sequence, so</span></div><div class="line"><a name="l09128"></a><span class="lineno"> 9128</span>&#160;<span class="comment">   we will not try to find all of the root causes--just fix it when</span></div><div class="line"><a name="l09129"></a><span class="lineno"> 9129</span>&#160;<span class="comment">   detected.</span></div><div class="line"><a name="l09130"></a><span class="lineno"> 9130</span>&#160;<span class="comment">   */</span></div><div class="line"><a name="l09131"></a><span class="lineno"> 9131</span>&#160;</div><div class="line"><a name="l09132"></a><span class="lineno"> 9132</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>)) {</div><div class="line"><a name="l09133"></a><span class="lineno"> 9133</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not open mailbox %s:  mailbox is locked\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);</div><div class="line"><a name="l09134"></a><span class="lineno"> 9134</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;</div><div class="line"><a name="l09135"></a><span class="lineno"> 9135</span>&#160;   }</div><div class="line"><a name="l09136"></a><span class="lineno"> 9136</span>&#160;</div><div class="line"><a name="l09137"></a><span class="lineno"> 9137</span>&#160;   <span class="comment">/* for local storage, checks directory for messages up to maxmsg limit */</span></div><div class="line"><a name="l09138"></a><span class="lineno"> 9138</span>&#160;   last_msg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(vmu, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);</div><div class="line"><a name="l09139"></a><span class="lineno"> 9139</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);</div><div class="line"><a name="l09140"></a><span class="lineno"> 9140</span>&#160;</div><div class="line"><a name="l09141"></a><span class="lineno"> 9141</span>&#160;   <span class="keywordflow">if</span> (last_msg &lt; -1) {</div><div class="line"><a name="l09142"></a><span class="lineno"> 9142</span>&#160;      <span class="keywordflow">return</span> last_msg;</div><div class="line"><a name="l09143"></a><span class="lineno"> 9143</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> != last_msg) {</div><div class="line"><a name="l09144"></a><span class="lineno"> 9144</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Resequencing Mailbox: %s, expected %d but found %d message(s) in box with max threshold of %d.\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, last_msg + 1, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);</div><div class="line"><a name="l09145"></a><span class="lineno"> 9145</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#acda2b7f1e36ad72fc556cc67cb2004c0">resequence_mailbox</a>(vmu, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, count_msg);</div><div class="line"><a name="l09146"></a><span class="lineno"> 9146</span>&#160;   }</div><div class="line"><a name="l09147"></a><span class="lineno"> 9147</span>&#160;</div><div class="line"><a name="l09148"></a><span class="lineno"> 9148</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l09149"></a><span class="lineno"> 9149</span>&#160;}</div><div class="line"><a name="l09150"></a><span class="lineno"> 9150</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l09151"></a><span class="lineno"> 9151</span>&#160;</div><div class="line"><a name="l09152"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b"> 9152</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l09153"></a><span class="lineno"> 9153</span>&#160;{</div><div class="line"><a name="l09154"></a><span class="lineno"> 9154</span>&#160;   <span class="keywordtype">int</span> x = 0;</div><div class="line"><a name="l09155"></a><span class="lineno"> 9155</span>&#160;   <span class="keywordtype">int</span> last_msg_idx = 0;</div><div class="line"><a name="l09156"></a><span class="lineno"> 9156</span>&#160;</div><div class="line"><a name="l09157"></a><span class="lineno"> 9157</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l09158"></a><span class="lineno"> 9158</span>&#160;   <span class="keywordtype">int</span> res = 0, nummsg;</div><div class="line"><a name="l09159"></a><span class="lineno"> 9159</span>&#160;   <span class="keywordtype">char</span> fn2[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l09160"></a><span class="lineno"> 9160</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l09161"></a><span class="lineno"> 9161</span>&#160;</div><div class="line"><a name="l09162"></a><span class="lineno"> 9162</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt;= -1) {</div><div class="line"><a name="l09163"></a><span class="lineno"> 9163</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a>;</div><div class="line"><a name="l09164"></a><span class="lineno"> 9164</span>&#160;   }</div><div class="line"><a name="l09165"></a><span class="lineno"> 9165</span>&#160;</div><div class="line"><a name="l09166"></a><span class="lineno"> 9166</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;</div><div class="line"><a name="l09167"></a><span class="lineno"> 9167</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l09168"></a><span class="lineno"> 9168</span>&#160;   <span class="comment">/* Get the deleted messages fixed */</span></div><div class="line"><a name="l09169"></a><span class="lineno"> 9169</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>)) {</div><div class="line"><a name="l09170"></a><span class="lineno"> 9170</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;</div><div class="line"><a name="l09171"></a><span class="lineno"> 9171</span>&#160;   }</div><div class="line"><a name="l09172"></a><span class="lineno"> 9172</span>&#160;</div><div class="line"><a name="l09173"></a><span class="lineno"> 9173</span>&#160;   <span class="comment">/* update count as message may have arrived while we&#39;ve got mailbox open */</span></div><div class="line"><a name="l09174"></a><span class="lineno"> 9174</span>&#160;   last_msg_idx = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a>(vmu, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);</div><div class="line"><a name="l09175"></a><span class="lineno"> 9175</span>&#160;   <span class="keywordflow">if</span> (last_msg_idx != vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l09176"></a><span class="lineno"> 9176</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;%d messages received after mailbox opened.\n&quot;</span>, last_msg_idx - vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>);</div><div class="line"><a name="l09177"></a><span class="lineno"> 9177</span>&#160;   }</div><div class="line"><a name="l09178"></a><span class="lineno"> 9178</span>&#160;</div><div class="line"><a name="l09179"></a><span class="lineno"> 9179</span>&#160;   <span class="comment">/* must check up to last detected message, just in case it is erroneously greater than maxmsg */</span></div><div class="line"><a name="l09180"></a><span class="lineno"> 9180</span>&#160;   <span class="keywordflow">for</span> (x = 0; x &lt; last_msg_idx + 1; x++) {</div><div class="line"><a name="l09181"></a><span class="lineno"> 9181</span>&#160;      <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] &amp;&amp; ((strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) &amp;&amp; strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;Urgent&quot;</span>)) || !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] || (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] &amp;&amp; !<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>)))) {</div><div class="line"><a name="l09182"></a><span class="lineno"> 9182</span>&#160;         <span class="comment">/* Save this message.  It&#39;s not in INBOX or hasn&#39;t been heard */</span></div><div class="line"><a name="l09183"></a><span class="lineno"> 9183</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x);</div><div class="line"><a name="l09184"></a><span class="lineno"> 9184</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l09185"></a><span class="lineno"> 9185</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l09186"></a><span class="lineno"> 9186</span>&#160;         }</div><div class="line"><a name="l09187"></a><span class="lineno"> 9187</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;</div><div class="line"><a name="l09188"></a><span class="lineno"> 9188</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(fn2, <span class="keyword">sizeof</span>(fn2), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l09189"></a><span class="lineno"> 9189</span>&#160;         <span class="keywordflow">if</span> (strcmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, fn2)) {</div><div class="line"><a name="l09190"></a><span class="lineno"> 9190</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, fn2);</div><div class="line"><a name="l09191"></a><span class="lineno"> 9191</span>&#160;         }</div><div class="line"><a name="l09192"></a><span class="lineno"> 9192</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) || !strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;Urgent&quot;</span>)) &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] &amp;&amp; <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>) &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x]) {</div><div class="line"><a name="l09193"></a><span class="lineno"> 9193</span>&#160;         <span class="comment">/* Move to old folder before deleting */</span></div><div class="line"><a name="l09194"></a><span class="lineno"> 9194</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(vmu, vms, x, 1, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l09195"></a><span class="lineno"> 9195</span>&#160;         <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a> || res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5b8df477c0090cd6966ff1a60907a09">ERROR_MAX_MSGS</a>) {</div><div class="line"><a name="l09196"></a><span class="lineno"> 9196</span>&#160;            <span class="comment">/* If save failed do not delete the message */</span></div><div class="line"><a name="l09197"></a><span class="lineno"> 9197</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Save failed.  Not moving message: %s.\n&quot;</span>, res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a> ? <span class="stringliteral">&quot;unable to lock path&quot;</span> : <span class="stringliteral">&quot;destination folder full&quot;</span>);</div><div class="line"><a name="l09198"></a><span class="lineno"> 9198</span>&#160;            vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] = 0;</div><div class="line"><a name="l09199"></a><span class="lineno"> 9199</span>&#160;            vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] = 0;</div><div class="line"><a name="l09200"></a><span class="lineno"> 9200</span>&#160;            --x;</div><div class="line"><a name="l09201"></a><span class="lineno"> 9201</span>&#160;         }</div><div class="line"><a name="l09202"></a><span class="lineno"> 9202</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] &amp;&amp; vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>) {</div><div class="line"><a name="l09203"></a><span class="lineno"> 9203</span>&#160;         <span class="comment">/* Move to deleted folder */</span></div><div class="line"><a name="l09204"></a><span class="lineno"> 9204</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(vmu, vms, x, 10, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l09205"></a><span class="lineno"> 9205</span>&#160;         <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {</div><div class="line"><a name="l09206"></a><span class="lineno"> 9206</span>&#160;            <span class="comment">/* If save failed do not delete the message */</span></div><div class="line"><a name="l09207"></a><span class="lineno"> 9207</span>&#160;            vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] = 0;</div><div class="line"><a name="l09208"></a><span class="lineno"> 9208</span>&#160;            vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] = 0;</div><div class="line"><a name="l09209"></a><span class="lineno"> 9209</span>&#160;            --x;</div><div class="line"><a name="l09210"></a><span class="lineno"> 9210</span>&#160;         }</div><div class="line"><a name="l09211"></a><span class="lineno"> 9211</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] &amp;&amp; <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {</div><div class="line"><a name="l09212"></a><span class="lineno"> 9212</span>&#160;         <span class="comment">/* If realtime storage enabled - we should explicitly delete this message,</span></div><div class="line"><a name="l09213"></a><span class="lineno"> 9213</span>&#160;<span class="comment">         cause RENAME() will overwrite files, but will keep duplicate records in RT-storage */</span></div><div class="line"><a name="l09214"></a><span class="lineno"> 9214</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x);</div><div class="line"><a name="l09215"></a><span class="lineno"> 9215</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l09216"></a><span class="lineno"> 9216</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmu);</div><div class="line"><a name="l09217"></a><span class="lineno"> 9217</span>&#160;         }</div><div class="line"><a name="l09218"></a><span class="lineno"> 9218</span>&#160;      }</div><div class="line"><a name="l09219"></a><span class="lineno"> 9219</span>&#160;   }</div><div class="line"><a name="l09220"></a><span class="lineno"> 9220</span>&#160;</div><div class="line"><a name="l09221"></a><span class="lineno"> 9221</span>&#160;   <span class="comment">/* Delete ALL remaining messages */</span></div><div class="line"><a name="l09222"></a><span class="lineno"> 9222</span>&#160;   nummsg = x - 1;</div><div class="line"><a name="l09223"></a><span class="lineno"> 9223</span>&#160;   <span class="keywordflow">for</span> (x = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1; x &lt;= nummsg; x++) {</div><div class="line"><a name="l09224"></a><span class="lineno"> 9224</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x);</div><div class="line"><a name="l09225"></a><span class="lineno"> 9225</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l09226"></a><span class="lineno"> 9226</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmu);</div><div class="line"><a name="l09227"></a><span class="lineno"> 9227</span>&#160;      }</div><div class="line"><a name="l09228"></a><span class="lineno"> 9228</span>&#160;   }</div><div class="line"><a name="l09229"></a><span class="lineno"> 9229</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);</div><div class="line"><a name="l09230"></a><span class="lineno"> 9230</span>&#160;<span class="preprocessor">#else </span><span class="comment">/* defined(IMAP_STORAGE) */</span><span class="preprocessor"></span></div><div class="line"><a name="l09231"></a><span class="lineno"> 9231</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l09232"></a><span class="lineno"> 9232</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>) {</div><div class="line"><a name="l09233"></a><span class="lineno"> 9233</span>&#160;      <span class="comment">/* Since we now expunge after each delete, deleting in reverse order</span></div><div class="line"><a name="l09234"></a><span class="lineno"> 9234</span>&#160;<span class="comment">       * ensures that no reordering occurs between each step. */</span></div><div class="line"><a name="l09235"></a><span class="lineno"> 9235</span>&#160;      last_msg_idx = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">dh_arraysize</a>;</div><div class="line"><a name="l09236"></a><span class="lineno"> 9236</span>&#160;      <span class="keywordflow">for</span> (x = last_msg_idx - 1; x &gt;= 0; x--) {</div><div class="line"><a name="l09237"></a><span class="lineno"> 9237</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x]) {</div><div class="line"><a name="l09238"></a><span class="lineno"> 9238</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;IMAP delete of %d\n&quot;</span>, x);</div><div class="line"><a name="l09239"></a><span class="lineno"> 9239</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmu);</div><div class="line"><a name="l09240"></a><span class="lineno"> 9240</span>&#160;         }</div><div class="line"><a name="l09241"></a><span class="lineno"> 9241</span>&#160;      }</div><div class="line"><a name="l09242"></a><span class="lineno"> 9242</span>&#160;   }</div><div class="line"><a name="l09243"></a><span class="lineno"> 9243</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l09244"></a><span class="lineno"> 9244</span>&#160;</div><div class="line"><a name="l09245"></a><span class="lineno"> 9245</span>&#160;<a class="code" href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a>:</div><div class="line"><a name="l09246"></a><span class="lineno"> 9246</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>) {</div><div class="line"><a name="l09247"></a><span class="lineno"> 9247</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>);</div><div class="line"><a name="l09248"></a><span class="lineno"> 9248</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l09249"></a><span class="lineno"> 9249</span>&#160;   }</div><div class="line"><a name="l09250"></a><span class="lineno"> 9250</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>) {</div><div class="line"><a name="l09251"></a><span class="lineno"> 9251</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>);</div><div class="line"><a name="l09252"></a><span class="lineno"> 9252</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l09253"></a><span class="lineno"> 9253</span>&#160;   }</div><div class="line"><a name="l09254"></a><span class="lineno"> 9254</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">dh_arraysize</a> = 0;</div><div class="line"><a name="l09255"></a><span class="lineno"> 9255</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l09256"></a><span class="lineno"> 9256</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l09257"></a><span class="lineno"> 9257</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l09258"></a><span class="lineno"> 9258</span>&#160;</div><div class="line"><a name="l09259"></a><span class="lineno"> 9259</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l09260"></a><span class="lineno"> 9260</span>&#160;}</div><div class="line"><a name="l09261"></a><span class="lineno"> 9261</span>&#160;</div><div class="line"><a name="l09262"></a><span class="lineno"> 9262</span>&#160;<span class="comment">/* In Greek even though we CAN use a syntax like &quot;friends messages&quot;</span></div><div class="line"><a name="l09263"></a><span class="lineno"> 9263</span>&#160;<span class="comment"> * (&quot;filika mynhmata&quot;) it is not elegant. This also goes for &quot;work/family messages&quot;</span></div><div class="line"><a name="l09264"></a><span class="lineno"> 9264</span>&#160;<span class="comment"> * (&quot;ergasiaka/oikogeniaka mynhmata&quot;). Therefore it is better to use a reversed</span></div><div class="line"><a name="l09265"></a><span class="lineno"> 9265</span>&#160;<span class="comment"> * syntax for the above three categories which is more elegant.</span></div><div class="line"><a name="l09266"></a><span class="lineno"> 9266</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l09267"></a><span class="lineno"> 9267</span>&#160;</div><div class="line"><a name="l09268"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821"> 9268</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821">vm_play_folder_name_gr</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)</div><div class="line"><a name="l09269"></a><span class="lineno"> 9269</span>&#160;{</div><div class="line"><a name="l09270"></a><span class="lineno"> 9270</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l09271"></a><span class="lineno"> 9271</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"><a name="l09272"></a><span class="lineno"> 9272</span>&#160;</div><div class="line"><a name="l09273"></a><span class="lineno"> 9273</span>&#160;   buf = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(strlen(box) + 2);</div><div class="line"><a name="l09274"></a><span class="lineno"> 9274</span>&#160;   strcpy(buf, box);</div><div class="line"><a name="l09275"></a><span class="lineno"> 9275</span>&#160;   strcat(buf, <span class="stringliteral">&quot;s&quot;</span>);</div><div class="line"><a name="l09276"></a><span class="lineno"> 9276</span>&#160;</div><div class="line"><a name="l09277"></a><span class="lineno"> 9277</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Old&quot;</span>)){</div><div class="line"><a name="l09278"></a><span class="lineno"> 9278</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, buf); <span class="comment">/* &quot;NEA / PALIA&quot; */</span></div><div class="line"><a name="l09279"></a><span class="lineno"> 9279</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages&quot; -&gt; &quot;MYNHMATA&quot; */</span></div><div class="line"><a name="l09280"></a><span class="lineno"> 9280</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09281"></a><span class="lineno"> 9281</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages&quot; -&gt; &quot;MYNHMATA&quot; */</span></div><div class="line"><a name="l09282"></a><span class="lineno"> 9282</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box); <span class="comment">/* friends/family/work... -&gt; &quot;FILWN&quot;/&quot;OIKOGENIAS&quot;/&quot;DOULEIAS&quot;*/</span></div><div class="line"><a name="l09283"></a><span class="lineno"> 9283</span>&#160;   }</div><div class="line"><a name="l09284"></a><span class="lineno"> 9284</span>&#160;}</div><div class="line"><a name="l09285"></a><span class="lineno"> 9285</span>&#160;</div><div class="line"><a name="l09286"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af48017d2539aef7a0f2aaf3923fbbc2b"> 9286</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af48017d2539aef7a0f2aaf3923fbbc2b">vm_play_folder_name_ja</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)</div><div class="line"><a name="l09287"></a><span class="lineno"> 9287</span>&#160;{</div><div class="line"><a name="l09288"></a><span class="lineno"> 9288</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l09289"></a><span class="lineno"> 9289</span>&#160;</div><div class="line"><a name="l09290"></a><span class="lineno"> 9290</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Old&quot;</span>)) {</div><div class="line"><a name="l09291"></a><span class="lineno"> 9291</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09292"></a><span class="lineno"> 9292</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09293"></a><span class="lineno"> 9293</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09294"></a><span class="lineno"> 9294</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09295"></a><span class="lineno"> 9295</span>&#160;      <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l09296"></a><span class="lineno"> 9296</span>&#160;   }</div><div class="line"><a name="l09297"></a><span class="lineno"> 9297</span>&#160;}</div><div class="line"><a name="l09298"></a><span class="lineno"> 9298</span>&#160;</div><div class="line"><a name="l09299"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9"> 9299</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9">vm_play_folder_name_pl</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)</div><div class="line"><a name="l09300"></a><span class="lineno"> 9300</span>&#160;{</div><div class="line"><a name="l09301"></a><span class="lineno"> 9301</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l09302"></a><span class="lineno"> 9302</span>&#160;</div><div class="line"><a name="l09303"></a><span class="lineno"> 9303</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Old&quot;</span>)) {</div><div class="line"><a name="l09304"></a><span class="lineno"> 9304</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>))</div><div class="line"><a name="l09305"></a><span class="lineno"> 9305</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-e&quot;</span>);</div><div class="line"><a name="l09306"></a><span class="lineno"> 9306</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l09307"></a><span class="lineno"> 9307</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-e&quot;</span>);</div><div class="line"><a name="l09308"></a><span class="lineno"> 9308</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09309"></a><span class="lineno"> 9309</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09310"></a><span class="lineno"> 9310</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09311"></a><span class="lineno"> 9311</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09312"></a><span class="lineno"> 9312</span>&#160;   }</div><div class="line"><a name="l09313"></a><span class="lineno"> 9313</span>&#160;}</div><div class="line"><a name="l09314"></a><span class="lineno"> 9314</span>&#160;</div><div class="line"><a name="l09315"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9"> 9315</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9">vm_play_folder_name_ua</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)</div><div class="line"><a name="l09316"></a><span class="lineno"> 9316</span>&#160;{</div><div class="line"><a name="l09317"></a><span class="lineno"> 9317</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l09318"></a><span class="lineno"> 9318</span>&#160;</div><div class="line"><a name="l09319"></a><span class="lineno"> 9319</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-Family&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Friends&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Work&quot;</span>)){</div><div class="line"><a name="l09320"></a><span class="lineno"> 9320</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09321"></a><span class="lineno"> 9321</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09322"></a><span class="lineno"> 9322</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09323"></a><span class="lineno"> 9323</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09324"></a><span class="lineno"> 9324</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09325"></a><span class="lineno"> 9325</span>&#160;   }</div><div class="line"><a name="l09326"></a><span class="lineno"> 9326</span>&#160;}</div><div class="line"><a name="l09327"></a><span class="lineno"> 9327</span>&#160;</div><div class="line"><a name="l09328"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8"> 9328</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)</div><div class="line"><a name="l09329"></a><span class="lineno"> 9329</span>&#160;{</div><div class="line"><a name="l09330"></a><span class="lineno"> 9330</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l09331"></a><span class="lineno"> 9331</span>&#160;</div><div class="line"><a name="l09332"></a><span class="lineno"> 9332</span>&#160;   <span class="keywordflow">if</span> (  !strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;it&quot;</span>, 2) ||</div><div class="line"><a name="l09333"></a><span class="lineno"> 9333</span>&#160;        !strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;es&quot;</span>, 2) ||</div><div class="line"><a name="l09334"></a><span class="lineno"> 9334</span>&#160;        !strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pt&quot;</span>, 2)) { <span class="comment">/* Italian, Spanish, or Portuguese syntax */</span></div><div class="line"><a name="l09335"></a><span class="lineno"> 9335</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages */</span></div><div class="line"><a name="l09336"></a><span class="lineno"> 9336</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09337"></a><span class="lineno"> 9337</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;gr&quot;</span>, 2)) {</div><div class="line"><a name="l09338"></a><span class="lineno"> 9338</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821">vm_play_folder_name_gr</a>(chan, box);</div><div class="line"><a name="l09339"></a><span class="lineno"> 9339</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;he&quot;</span>, 2)) {  <span class="comment">/* Hebrew syntax */</span></div><div class="line"><a name="l09340"></a><span class="lineno"> 9340</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09341"></a><span class="lineno"> 9341</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ja&quot;</span>, 2)) {  <span class="comment">/* Japanese syntax */</span></div><div class="line"><a name="l09342"></a><span class="lineno"> 9342</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af48017d2539aef7a0f2aaf3923fbbc2b">vm_play_folder_name_ja</a>(chan, box);</div><div class="line"><a name="l09343"></a><span class="lineno"> 9343</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pl&quot;</span>, 2)) {</div><div class="line"><a name="l09344"></a><span class="lineno"> 9344</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9">vm_play_folder_name_pl</a>(chan, box);</div><div class="line"><a name="l09345"></a><span class="lineno"> 9345</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ua&quot;</span>, 2)) {  <span class="comment">/* Ukrainian syntax */</span></div><div class="line"><a name="l09346"></a><span class="lineno"> 9346</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9">vm_play_folder_name_ua</a>(chan, box);</div><div class="line"><a name="l09347"></a><span class="lineno"> 9347</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;vi&quot;</span>, 2)) {</div><div class="line"><a name="l09348"></a><span class="lineno"> 9348</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09349"></a><span class="lineno"> 9349</span>&#160;   } <span class="keywordflow">else</span> {  <span class="comment">/* Default English */</span></div><div class="line"><a name="l09350"></a><span class="lineno"> 9350</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, box);</div><div class="line"><a name="l09351"></a><span class="lineno"> 9351</span>&#160;      <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages */</span></div><div class="line"><a name="l09352"></a><span class="lineno"> 9352</span>&#160;   }</div><div class="line"><a name="l09353"></a><span class="lineno"> 9353</span>&#160;}</div><div class="line"><a name="l09354"></a><span class="lineno"> 9354</span>&#160;</div><div class="line"><a name="l09355"></a><span class="lineno"> 9355</span>&#160;<span class="comment">/* GREEK SYNTAX</span></div><div class="line"><a name="l09356"></a><span class="lineno"> 9356</span>&#160;<span class="comment">   In greek the plural for old/new is</span></div><div class="line"><a name="l09357"></a><span class="lineno"> 9357</span>&#160;<span class="comment">   different so we need the following files</span></div><div class="line"><a name="l09358"></a><span class="lineno"> 9358</span>&#160;<span class="comment">   We also need vm-denExeteMynhmata because</span></div><div class="line"><a name="l09359"></a><span class="lineno"> 9359</span>&#160;<span class="comment">   this syntax is different.</span></div><div class="line"><a name="l09360"></a><span class="lineno"> 9360</span>&#160;<span class="comment"></span></div><div class="line"><a name="l09361"></a><span class="lineno"> 9361</span>&#160;<span class="comment">   -&gt; vm-Olds.wav : &quot;Palia&quot;</span></div><div class="line"><a name="l09362"></a><span class="lineno"> 9362</span>&#160;<span class="comment">   -&gt; vm-INBOXs.wav : &quot;Nea&quot;</span></div><div class="line"><a name="l09363"></a><span class="lineno"> 9363</span>&#160;<span class="comment">   -&gt; vm-denExeteMynhmata : &quot;den exete mynhmata&quot;</span></div><div class="line"><a name="l09364"></a><span class="lineno"> 9364</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l09365"></a><span class="lineno"> 9365</span>&#160;</div><div class="line"><a name="l09366"></a><span class="lineno"> 9366</span>&#160;</div><div class="line"><a name="l09367"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c"> 9367</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c">vm_intro_gr</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09368"></a><span class="lineno"> 9368</span>&#160;{</div><div class="line"><a name="l09369"></a><span class="lineno"> 9369</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l09370"></a><span class="lineno"> 9370</span>&#160;</div><div class="line"><a name="l09371"></a><span class="lineno"> 9371</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09372"></a><span class="lineno"> 9372</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09373"></a><span class="lineno"> 9373</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09374"></a><span class="lineno"> 9374</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l09375"></a><span class="lineno"> 9375</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09376"></a><span class="lineno"> 9376</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l09377"></a><span class="lineno"> 9377</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l09378"></a><span class="lineno"> 9378</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09379"></a><span class="lineno"> 9379</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09380"></a><span class="lineno"> 9380</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09381"></a><span class="lineno"> 9381</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);</div><div class="line"><a name="l09382"></a><span class="lineno"> 9382</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09383"></a><span class="lineno"> 9383</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09384"></a><span class="lineno"> 9384</span>&#160;         }</div><div class="line"><a name="l09385"></a><span class="lineno"> 9385</span>&#160;      }</div><div class="line"><a name="l09386"></a><span class="lineno"> 9386</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>){</div><div class="line"><a name="l09387"></a><span class="lineno"> 9387</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09388"></a><span class="lineno"> 9388</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09389"></a><span class="lineno"> 9389</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l09390"></a><span class="lineno"> 9390</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1){</div><div class="line"><a name="l09391"></a><span class="lineno"> 9391</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09392"></a><span class="lineno"> 9392</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09393"></a><span class="lineno"> 9393</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09394"></a><span class="lineno"> 9394</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09395"></a><span class="lineno"> 9395</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);</div><div class="line"><a name="l09396"></a><span class="lineno"> 9396</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09397"></a><span class="lineno"> 9397</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09398"></a><span class="lineno"> 9398</span>&#160;      }</div><div class="line"><a name="l09399"></a><span class="lineno"> 9399</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>)</div><div class="line"><a name="l09400"></a><span class="lineno"> 9400</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-denExeteMynhmata&quot;</span>);</div><div class="line"><a name="l09401"></a><span class="lineno"> 9401</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09402"></a><span class="lineno"> 9402</span>&#160;}</div><div class="line"><a name="l09403"></a><span class="lineno"> 9403</span>&#160;</div><div class="line"><a name="l09404"></a><span class="lineno"> 9404</span>&#160;<span class="comment">/* Version of vm_intro() designed to work for many languages.</span></div><div class="line"><a name="l09405"></a><span class="lineno"> 9405</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09406"></a><span class="lineno"> 9406</span>&#160;<span class="comment"> * It is hoped that this function can prevent the proliferation of</span></div><div class="line"><a name="l09407"></a><span class="lineno"> 9407</span>&#160;<span class="comment"> * language-specific vm_intro() functions and in time replace the language-</span></div><div class="line"><a name="l09408"></a><span class="lineno"> 9408</span>&#160;<span class="comment"> * specific functions which already exist.  An examination of the language-</span></div><div class="line"><a name="l09409"></a><span class="lineno"> 9409</span>&#160;<span class="comment"> * specific functions revealed that they all corrected the same deficiencies</span></div><div class="line"><a name="l09410"></a><span class="lineno"> 9410</span>&#160;<span class="comment"> * in vm_intro_en() (which was the default function). Namely:</span></div><div class="line"><a name="l09411"></a><span class="lineno"> 9411</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09412"></a><span class="lineno"> 9412</span>&#160;<span class="comment"> *  1) The vm-Old and vm-INBOX sound files were overloaded.  The English</span></div><div class="line"><a name="l09413"></a><span class="lineno"> 9413</span>&#160;<span class="comment"> *     wording of the voicemail greeting hides this problem.  For example,</span></div><div class="line"><a name="l09414"></a><span class="lineno"> 9414</span>&#160;<span class="comment"> *     vm-INBOX contains only the word &quot;new&quot;.  This means that both of these</span></div><div class="line"><a name="l09415"></a><span class="lineno"> 9415</span>&#160;<span class="comment"> *     sequences produce valid utterances:</span></div><div class="line"><a name="l09416"></a><span class="lineno"> 9416</span>&#160;<span class="comment"> *      * vm-youhave digit/1 vm-INBOX vm-message (you have one new message)</span></div><div class="line"><a name="l09417"></a><span class="lineno"> 9417</span>&#160;<span class="comment"> *      * vm-press digit/1 vm-for vm-INBOX vm-messages (press 1 for new messages)</span></div><div class="line"><a name="l09418"></a><span class="lineno"> 9418</span>&#160;<span class="comment"> *     However, if we rerecord vm-INBOX to say &quot;the new&quot; (which is unavoidable</span></div><div class="line"><a name="l09419"></a><span class="lineno"> 9419</span>&#160;<span class="comment"> *     in many languages) the first utterance becomes &quot;you have 1 the new message&quot;.</span></div><div class="line"><a name="l09420"></a><span class="lineno"> 9420</span>&#160;<span class="comment"> *  2) The function contains hardcoded rules for pluralizing the word &quot;message&quot;.</span></div><div class="line"><a name="l09421"></a><span class="lineno"> 9421</span>&#160;<span class="comment"> *     These rules are correct for English, but not for many other languages.</span></div><div class="line"><a name="l09422"></a><span class="lineno"> 9422</span>&#160;<span class="comment"> *  3) No attempt is made to pluralize the adjectives (&quot;old&quot; and &quot;new&quot;) as</span></div><div class="line"><a name="l09423"></a><span class="lineno"> 9423</span>&#160;<span class="comment"> *     required in many languages.</span></div><div class="line"><a name="l09424"></a><span class="lineno"> 9424</span>&#160;<span class="comment"> *  4) The gender of the word for &quot;message&quot; is not specified. This is a problem</span></div><div class="line"><a name="l09425"></a><span class="lineno"> 9425</span>&#160;<span class="comment"> *     because in many languages the gender of the number in phrases such</span></div><div class="line"><a name="l09426"></a><span class="lineno"> 9426</span>&#160;<span class="comment"> *     as &quot;you have one new message&quot; must match the gender of the word</span></div><div class="line"><a name="l09427"></a><span class="lineno"> 9427</span>&#160;<span class="comment"> *     meaning &quot;message&quot;.</span></div><div class="line"><a name="l09428"></a><span class="lineno"> 9428</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09429"></a><span class="lineno"> 9429</span>&#160;<span class="comment"> * Fixing these problems for each new language has meant duplication of effort.</span></div><div class="line"><a name="l09430"></a><span class="lineno"> 9430</span>&#160;<span class="comment"> * This new function solves the problems in the following general ways:</span></div><div class="line"><a name="l09431"></a><span class="lineno"> 9431</span>&#160;<span class="comment"> *  1) Add new sound files vm-new and vm-old.  These can be linked to vm-INBOX</span></div><div class="line"><a name="l09432"></a><span class="lineno"> 9432</span>&#160;<span class="comment"> *     and vm-Old respectively for those languages where it makes sense.</span></div><div class="line"><a name="l09433"></a><span class="lineno"> 9433</span>&#160;<span class="comment"> *  2) Call ast_say_counted_noun() to put the proper gender and number prefix</span></div><div class="line"><a name="l09434"></a><span class="lineno"> 9434</span>&#160;<span class="comment"> *     on vm-message.</span></div><div class="line"><a name="l09435"></a><span class="lineno"> 9435</span>&#160;<span class="comment"> *  3) Call ast_say_counted_adjective() to put the proper gender and number</span></div><div class="line"><a name="l09436"></a><span class="lineno"> 9436</span>&#160;<span class="comment"> *     prefix on vm-new and vm-old (none for English).</span></div><div class="line"><a name="l09437"></a><span class="lineno"> 9437</span>&#160;<span class="comment"> *  4) Pass the gender of the language&#39;s word for &quot;message&quot; as an agument to</span></div><div class="line"><a name="l09438"></a><span class="lineno"> 9438</span>&#160;<span class="comment"> *     this function which is can in turn pass on to the functions which</span></div><div class="line"><a name="l09439"></a><span class="lineno"> 9439</span>&#160;<span class="comment"> *     say numbers and put endings on nounds and adjectives.</span></div><div class="line"><a name="l09440"></a><span class="lineno"> 9440</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09441"></a><span class="lineno"> 9441</span>&#160;<span class="comment"> * All languages require these messages:</span></div><div class="line"><a name="l09442"></a><span class="lineno"> 9442</span>&#160;<span class="comment"> *  vm-youhave    &quot;You have...&quot;</span></div><div class="line"><a name="l09443"></a><span class="lineno"> 9443</span>&#160;<span class="comment"> *  vm-and     &quot;and&quot;</span></div><div class="line"><a name="l09444"></a><span class="lineno"> 9444</span>&#160;<span class="comment"> *  vm-no      &quot;no&quot; (in the sense of &quot;none&quot;, as in &quot;you have no messages&quot;)</span></div><div class="line"><a name="l09445"></a><span class="lineno"> 9445</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09446"></a><span class="lineno"> 9446</span>&#160;<span class="comment"> * To use it for English, you will need these additional sound files:</span></div><div class="line"><a name="l09447"></a><span class="lineno"> 9447</span>&#160;<span class="comment"> *  vm-new     &quot;new&quot;</span></div><div class="line"><a name="l09448"></a><span class="lineno"> 9448</span>&#160;<span class="comment"> *  vm-message    &quot;message&quot;, singular</span></div><div class="line"><a name="l09449"></a><span class="lineno"> 9449</span>&#160;<span class="comment"> *  vm-messages      &quot;messages&quot;, plural</span></div><div class="line"><a name="l09450"></a><span class="lineno"> 9450</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09451"></a><span class="lineno"> 9451</span>&#160;<span class="comment"> * If you use it for Russian and other slavic languages, you will need these additional sound files:</span></div><div class="line"><a name="l09452"></a><span class="lineno"> 9452</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l09453"></a><span class="lineno"> 9453</span>&#160;<span class="comment"> *  vm-newn    &quot;novoye&quot; (singular, neuter)</span></div><div class="line"><a name="l09454"></a><span class="lineno"> 9454</span>&#160;<span class="comment"> *  vm-newx    &quot;novikh&quot; (counting plural form, genative plural)</span></div><div class="line"><a name="l09455"></a><span class="lineno"> 9455</span>&#160;<span class="comment"> *  vm-message    &quot;sobsheniye&quot; (singular form)</span></div><div class="line"><a name="l09456"></a><span class="lineno"> 9456</span>&#160;<span class="comment"> *  vm-messagex1  &quot;sobsheniya&quot; (first counting plural form, genative singular)</span></div><div class="line"><a name="l09457"></a><span class="lineno"> 9457</span>&#160;<span class="comment"> *  vm-messagex2  &quot;sobsheniy&quot; (second counting plural form, genative plural)</span></div><div class="line"><a name="l09458"></a><span class="lineno"> 9458</span>&#160;<span class="comment"> *  digits/1n     &quot;odno&quot; (neuter singular for phrases such as &quot;one message&quot; or &quot;thirty one messages&quot;)</span></div><div class="line"><a name="l09459"></a><span class="lineno"> 9459</span>&#160;<span class="comment"> *  digits/2n     &quot;dva&quot; (neuter singular)</span></div><div class="line"><a name="l09460"></a><span class="lineno"> 9460</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l09461"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22"> 9461</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> message_gender[])</div><div class="line"><a name="l09462"></a><span class="lineno"> 9462</span>&#160;{</div><div class="line"><a name="l09463"></a><span class="lineno"> 9463</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09464"></a><span class="lineno"> 9464</span>&#160;   <span class="keywordtype">int</span> lastnum = 0;</div><div class="line"><a name="l09465"></a><span class="lineno"> 9465</span>&#160;</div><div class="line"><a name="l09466"></a><span class="lineno"> 9466</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09467"></a><span class="lineno"> 9467</span>&#160;</div><div class="line"><a name="l09468"></a><span class="lineno"> 9468</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09469"></a><span class="lineno"> 9469</span>&#160;      lastnum = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;</div><div class="line"><a name="l09470"></a><span class="lineno"> 9470</span>&#160;</div><div class="line"><a name="l09471"></a><span class="lineno"> 9471</span>&#160;      <span class="keywordflow">if</span> (!(res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, lastnum, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), message_gender))) {</div><div class="line"><a name="l09472"></a><span class="lineno"> 9472</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#ac3420184b387e73718d56aa73aa16b25">ast_say_counted_adjective</a>(chan, lastnum, <span class="stringliteral">&quot;vm-new&quot;</span>, message_gender);</div><div class="line"><a name="l09473"></a><span class="lineno"> 9473</span>&#160;      }</div><div class="line"><a name="l09474"></a><span class="lineno"> 9474</span>&#160;</div><div class="line"><a name="l09475"></a><span class="lineno"> 9475</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09476"></a><span class="lineno"> 9476</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09477"></a><span class="lineno"> 9477</span>&#160;      }</div><div class="line"><a name="l09478"></a><span class="lineno"> 9478</span>&#160;   }</div><div class="line"><a name="l09479"></a><span class="lineno"> 9479</span>&#160;</div><div class="line"><a name="l09480"></a><span class="lineno"> 9480</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09481"></a><span class="lineno"> 9481</span>&#160;      lastnum = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;</div><div class="line"><a name="l09482"></a><span class="lineno"> 9482</span>&#160;</div><div class="line"><a name="l09483"></a><span class="lineno"> 9483</span>&#160;      <span class="keywordflow">if</span> (!(res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, lastnum, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), message_gender))) {</div><div class="line"><a name="l09484"></a><span class="lineno"> 9484</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#ac3420184b387e73718d56aa73aa16b25">ast_say_counted_adjective</a>(chan, lastnum, <span class="stringliteral">&quot;vm-old&quot;</span>, message_gender);</div><div class="line"><a name="l09485"></a><span class="lineno"> 9485</span>&#160;      }</div><div class="line"><a name="l09486"></a><span class="lineno"> 9486</span>&#160;   }</div><div class="line"><a name="l09487"></a><span class="lineno"> 9487</span>&#160;</div><div class="line"><a name="l09488"></a><span class="lineno"> 9488</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09489"></a><span class="lineno"> 9489</span>&#160;      <span class="keywordflow">if</span> (lastnum == 0) {</div><div class="line"><a name="l09490"></a><span class="lineno"> 9490</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09491"></a><span class="lineno"> 9491</span>&#160;      }</div><div class="line"><a name="l09492"></a><span class="lineno"> 9492</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09493"></a><span class="lineno"> 9493</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#aa8c3ccdaf588396ad33b5028e79aa1c4">ast_say_counted_noun</a>(chan, lastnum, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09494"></a><span class="lineno"> 9494</span>&#160;      }</div><div class="line"><a name="l09495"></a><span class="lineno"> 9495</span>&#160;   }</div><div class="line"><a name="l09496"></a><span class="lineno"> 9496</span>&#160;</div><div class="line"><a name="l09497"></a><span class="lineno"> 9497</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09498"></a><span class="lineno"> 9498</span>&#160;}</div><div class="line"><a name="l09499"></a><span class="lineno"> 9499</span>&#160;</div><div class="line"><a name="l09500"></a><span class="lineno"> 9500</span>&#160;<span class="comment">/* Default Hebrew syntax */</span></div><div class="line"><a name="l09501"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c"> 9501</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c">vm_intro_he</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09502"></a><span class="lineno"> 9502</span>&#160;{</div><div class="line"><a name="l09503"></a><span class="lineno"> 9503</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l09504"></a><span class="lineno"> 9504</span>&#160;</div><div class="line"><a name="l09505"></a><span class="lineno"> 9505</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09506"></a><span class="lineno"> 9506</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09507"></a><span class="lineno"> 9507</span>&#160;      <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) || (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)) {</div><div class="line"><a name="l09508"></a><span class="lineno"> 9508</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09509"></a><span class="lineno"> 9509</span>&#160;      }</div><div class="line"><a name="l09510"></a><span class="lineno"> 9510</span>&#160;      <span class="comment">/*</span></div><div class="line"><a name="l09511"></a><span class="lineno"> 9511</span>&#160;<span class="comment">       * The word &quot;shtei&quot; refers to the number 2 in hebrew when performing a count</span></div><div class="line"><a name="l09512"></a><span class="lineno"> 9512</span>&#160;<span class="comment">       * of elements. In Hebrew, there are 6 forms of enumerating the number 2 for</span></div><div class="line"><a name="l09513"></a><span class="lineno"> 9513</span>&#160;<span class="comment">       * an element, this is one of them.</span></div><div class="line"><a name="l09514"></a><span class="lineno"> 9514</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l09515"></a><span class="lineno"> 9515</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09516"></a><span class="lineno"> 9516</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09517"></a><span class="lineno"> 9517</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l09518"></a><span class="lineno"> 9518</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX1&quot;</span>);</div><div class="line"><a name="l09519"></a><span class="lineno"> 9519</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09520"></a><span class="lineno"> 9520</span>&#160;               <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 2) {</div><div class="line"><a name="l09521"></a><span class="lineno"> 9521</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-shtei&quot;</span>);</div><div class="line"><a name="l09522"></a><span class="lineno"> 9522</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09523"></a><span class="lineno"> 9523</span>&#160;                  res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l09524"></a><span class="lineno"> 9524</span>&#160;               }</div><div class="line"><a name="l09525"></a><span class="lineno"> 9525</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l09526"></a><span class="lineno"> 9526</span>&#160;            }</div><div class="line"><a name="l09527"></a><span class="lineno"> 9527</span>&#160;         }</div><div class="line"><a name="l09528"></a><span class="lineno"> 9528</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res) {</div><div class="line"><a name="l09529"></a><span class="lineno"> 9529</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09530"></a><span class="lineno"> 9530</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l09531"></a><span class="lineno"> 9531</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old1&quot;</span>);</div><div class="line"><a name="l09532"></a><span class="lineno"> 9532</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09533"></a><span class="lineno"> 9533</span>&#160;               <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 2) {</div><div class="line"><a name="l09534"></a><span class="lineno"> 9534</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-shtei&quot;</span>);</div><div class="line"><a name="l09535"></a><span class="lineno"> 9535</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09536"></a><span class="lineno"> 9536</span>&#160;                  res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l09537"></a><span class="lineno"> 9537</span>&#160;               }</div><div class="line"><a name="l09538"></a><span class="lineno"> 9538</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09539"></a><span class="lineno"> 9539</span>&#160;            }</div><div class="line"><a name="l09540"></a><span class="lineno"> 9540</span>&#160;         }</div><div class="line"><a name="l09541"></a><span class="lineno"> 9541</span>&#160;      }</div><div class="line"><a name="l09542"></a><span class="lineno"> 9542</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09543"></a><span class="lineno"> 9543</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09544"></a><span class="lineno"> 9544</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l09545"></a><span class="lineno"> 9545</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old1&quot;</span>);</div><div class="line"><a name="l09546"></a><span class="lineno"> 9546</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09547"></a><span class="lineno"> 9547</span>&#160;               <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 2) {</div><div class="line"><a name="l09548"></a><span class="lineno"> 9548</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-shtei&quot;</span>);</div><div class="line"><a name="l09549"></a><span class="lineno"> 9549</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09550"></a><span class="lineno"> 9550</span>&#160;                  res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l09551"></a><span class="lineno"> 9551</span>&#160;               }</div><div class="line"><a name="l09552"></a><span class="lineno"> 9552</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09553"></a><span class="lineno"> 9553</span>&#160;            }</div><div class="line"><a name="l09554"></a><span class="lineno"> 9554</span>&#160;         }</div><div class="line"><a name="l09555"></a><span class="lineno"> 9555</span>&#160;      }</div><div class="line"><a name="l09556"></a><span class="lineno"> 9556</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09557"></a><span class="lineno"> 9557</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09558"></a><span class="lineno"> 9558</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09559"></a><span class="lineno"> 9559</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomessages&quot;</span>);</div><div class="line"><a name="l09560"></a><span class="lineno"> 9560</span>&#160;            }</div><div class="line"><a name="l09561"></a><span class="lineno"> 9561</span>&#160;         }</div><div class="line"><a name="l09562"></a><span class="lineno"> 9562</span>&#160;      }</div><div class="line"><a name="l09563"></a><span class="lineno"> 9563</span>&#160;   }</div><div class="line"><a name="l09564"></a><span class="lineno"> 9564</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09565"></a><span class="lineno"> 9565</span>&#160;}</div><div class="line"><a name="l09566"></a><span class="lineno"> 9566</span>&#160;</div><div class="line"><a name="l09567"></a><span class="lineno"> 9567</span>&#160;<span class="comment">/* Japanese syntax */</span></div><div class="line"><a name="l09568"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae55c18b0e0a94a34580e1ac4edf96c04"> 9568</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae55c18b0e0a94a34580e1ac4edf96c04">vm_intro_ja</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09569"></a><span class="lineno"> 9569</span>&#160;{</div><div class="line"><a name="l09570"></a><span class="lineno"> 9570</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09571"></a><span class="lineno"> 9571</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09572"></a><span class="lineno"> 9572</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09573"></a><span class="lineno"> 9573</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l09574"></a><span class="lineno"> 9574</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09575"></a><span class="lineno"> 9575</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09576"></a><span class="lineno"> 9576</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09577"></a><span class="lineno"> 9577</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-ga&quot;</span>);</div><div class="line"><a name="l09578"></a><span class="lineno"> 9578</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09579"></a><span class="lineno"> 9579</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09580"></a><span class="lineno"> 9580</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l09581"></a><span class="lineno"> 9581</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;silence/1&quot;</span>);</div><div class="line"><a name="l09582"></a><span class="lineno"> 9582</span>&#160;</div><div class="line"><a name="l09583"></a><span class="lineno"> 9583</span>&#160;   }</div><div class="line"><a name="l09584"></a><span class="lineno"> 9584</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09585"></a><span class="lineno"> 9585</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09586"></a><span class="lineno"> 9586</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09587"></a><span class="lineno"> 9587</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09588"></a><span class="lineno"> 9588</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09589"></a><span class="lineno"> 9589</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-ga&quot;</span>);</div><div class="line"><a name="l09590"></a><span class="lineno"> 9590</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09591"></a><span class="lineno"> 9591</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09592"></a><span class="lineno"> 9592</span>&#160;   }</div><div class="line"><a name="l09593"></a><span class="lineno"> 9593</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09594"></a><span class="lineno"> 9594</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09595"></a><span class="lineno"> 9595</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09596"></a><span class="lineno"> 9596</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wa&quot;</span>);</div><div class="line"><a name="l09597"></a><span class="lineno"> 9597</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09598"></a><span class="lineno"> 9598</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-arimasen&quot;</span>);</div><div class="line"><a name="l09599"></a><span class="lineno"> 9599</span>&#160;   }</div><div class="line"><a name="l09600"></a><span class="lineno"> 9600</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l09601"></a><span class="lineno"> 9601</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-arimasu&quot;</span>);</div><div class="line"><a name="l09602"></a><span class="lineno"> 9602</span>&#160;   }</div><div class="line"><a name="l09603"></a><span class="lineno"> 9603</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09604"></a><span class="lineno"> 9604</span>&#160;} <span class="comment">/* Japanese */</span></div><div class="line"><a name="l09605"></a><span class="lineno"> 9605</span>&#160;</div><div class="line"><a name="l09606"></a><span class="lineno"> 9606</span>&#160;<span class="comment">/* Default English syntax */</span></div><div class="line"><a name="l09607"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f"> 9607</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f">vm_intro_en</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09608"></a><span class="lineno"> 9608</span>&#160;{</div><div class="line"><a name="l09609"></a><span class="lineno"> 9609</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09610"></a><span class="lineno"> 9610</span>&#160;</div><div class="line"><a name="l09611"></a><span class="lineno"> 9611</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09612"></a><span class="lineno"> 9612</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09613"></a><span class="lineno"> 9613</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09614"></a><span class="lineno"> 9614</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l09615"></a><span class="lineno"> 9615</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09616"></a><span class="lineno"> 9616</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09617"></a><span class="lineno"> 9617</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Urgent&quot;</span>);</div><div class="line"><a name="l09618"></a><span class="lineno"> 9618</span>&#160;         <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> || vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &amp;&amp; !res) {</div><div class="line"><a name="l09619"></a><span class="lineno"> 9619</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09620"></a><span class="lineno"> 9620</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09621"></a><span class="lineno"> 9621</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> == 1)</div><div class="line"><a name="l09622"></a><span class="lineno"> 9622</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09623"></a><span class="lineno"> 9623</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09624"></a><span class="lineno"> 9624</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09625"></a><span class="lineno"> 9625</span>&#160;         }</div><div class="line"><a name="l09626"></a><span class="lineno"> 9626</span>&#160;      }</div><div class="line"><a name="l09627"></a><span class="lineno"> 9627</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09628"></a><span class="lineno"> 9628</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09629"></a><span class="lineno"> 9629</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09630"></a><span class="lineno"> 9630</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l09631"></a><span class="lineno"> 9631</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l09632"></a><span class="lineno"> 9632</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09633"></a><span class="lineno"> 9633</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09634"></a><span class="lineno"> 9634</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l09635"></a><span class="lineno"> 9635</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09636"></a><span class="lineno"> 9636</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09637"></a><span class="lineno"> 9637</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09638"></a><span class="lineno"> 9638</span>&#160;         }</div><div class="line"><a name="l09639"></a><span class="lineno"> 9639</span>&#160;</div><div class="line"><a name="l09640"></a><span class="lineno"> 9640</span>&#160;      }</div><div class="line"><a name="l09641"></a><span class="lineno"> 9641</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09642"></a><span class="lineno"> 9642</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09643"></a><span class="lineno"> 9643</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09644"></a><span class="lineno"> 9644</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09645"></a><span class="lineno"> 9645</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09646"></a><span class="lineno"> 9646</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l09647"></a><span class="lineno"> 9647</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09648"></a><span class="lineno"> 9648</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09649"></a><span class="lineno"> 9649</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09650"></a><span class="lineno"> 9650</span>&#160;         }</div><div class="line"><a name="l09651"></a><span class="lineno"> 9651</span>&#160;      }</div><div class="line"><a name="l09652"></a><span class="lineno"> 9652</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09653"></a><span class="lineno"> 9653</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09654"></a><span class="lineno"> 9654</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09655"></a><span class="lineno"> 9655</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09656"></a><span class="lineno"> 9656</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09657"></a><span class="lineno"> 9657</span>&#160;         }</div><div class="line"><a name="l09658"></a><span class="lineno"> 9658</span>&#160;      }</div><div class="line"><a name="l09659"></a><span class="lineno"> 9659</span>&#160;   }</div><div class="line"><a name="l09660"></a><span class="lineno"> 9660</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09661"></a><span class="lineno"> 9661</span>&#160;}</div><div class="line"><a name="l09662"></a><span class="lineno"> 9662</span>&#160;</div><div class="line"><a name="l09663"></a><span class="lineno"> 9663</span>&#160;<span class="comment">/* ICELANDIC syntax */</span></div><div class="line"><a name="l09664"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acc1a27de6051bbf777a3770d49305c1b"> 9664</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acc1a27de6051bbf777a3770d49305c1b">vm_intro_is</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09665"></a><span class="lineno"> 9665</span>&#160;{</div><div class="line"><a name="l09666"></a><span class="lineno"> 9666</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09667"></a><span class="lineno"> 9667</span>&#160;</div><div class="line"><a name="l09668"></a><span class="lineno"> 9668</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09669"></a><span class="lineno"> 9669</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09670"></a><span class="lineno"> 9670</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09671"></a><span class="lineno"> 9671</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l09672"></a><span class="lineno"> 9672</span>&#160;         <span class="comment">/* Digits 1-4 are spoken in neutral and plural when talking about messages,</span></div><div class="line"><a name="l09673"></a><span class="lineno"> 9673</span>&#160;<span class="comment">            however, feminine is used for 1 as it is the same as the neutral for plural,</span></div><div class="line"><a name="l09674"></a><span class="lineno"> 9674</span>&#160;<span class="comment">            and singular neutral is the same after 1. */</span></div><div class="line"><a name="l09675"></a><span class="lineno"> 9675</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &lt; 5) {</div><div class="line"><a name="l09676"></a><span class="lineno"> 9676</span>&#160;            <span class="keywordtype">char</span> recname[16];</div><div class="line"><a name="l09677"></a><span class="lineno"> 9677</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> == 1)</div><div class="line"><a name="l09678"></a><span class="lineno"> 9678</span>&#160;               snprintf(recname, <span class="keyword">sizeof</span>(recname), <span class="stringliteral">&quot;digits/1kvk&quot;</span>);</div><div class="line"><a name="l09679"></a><span class="lineno"> 9679</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09680"></a><span class="lineno"> 9680</span>&#160;               snprintf(recname, <span class="keyword">sizeof</span>(recname), <span class="stringliteral">&quot;digits/%dhk&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>);</div><div class="line"><a name="l09681"></a><span class="lineno"> 9681</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, recname);</div><div class="line"><a name="l09682"></a><span class="lineno"> 9682</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09683"></a><span class="lineno"> 9683</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Urgent&quot;</span>);</div><div class="line"><a name="l09684"></a><span class="lineno"> 9684</span>&#160;         <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> || vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &amp;&amp; !res) {</div><div class="line"><a name="l09685"></a><span class="lineno"> 9685</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09686"></a><span class="lineno"> 9686</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09687"></a><span class="lineno"> 9687</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09688"></a><span class="lineno"> 9688</span>&#160;      }</div><div class="line"><a name="l09689"></a><span class="lineno"> 9689</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09690"></a><span class="lineno"> 9690</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &lt; 5) {</div><div class="line"><a name="l09691"></a><span class="lineno"> 9691</span>&#160;            <span class="keywordtype">char</span> recname[16];</div><div class="line"><a name="l09692"></a><span class="lineno"> 9692</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l09693"></a><span class="lineno"> 9693</span>&#160;               snprintf(recname, <span class="keyword">sizeof</span>(recname), <span class="stringliteral">&quot;digits/1kvk&quot;</span>);</div><div class="line"><a name="l09694"></a><span class="lineno"> 9694</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09695"></a><span class="lineno"> 9695</span>&#160;               snprintf(recname, <span class="keyword">sizeof</span>(recname), <span class="stringliteral">&quot;digits/%dhk&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>);</div><div class="line"><a name="l09696"></a><span class="lineno"> 9696</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, recname);</div><div class="line"><a name="l09697"></a><span class="lineno"> 9697</span>&#160;         } <span class="keywordflow">else</span></div><div class="line"><a name="l09698"></a><span class="lineno"> 9698</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09699"></a><span class="lineno"> 9699</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09700"></a><span class="lineno"> 9700</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l09701"></a><span class="lineno"> 9701</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l09702"></a><span class="lineno"> 9702</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09703"></a><span class="lineno"> 9703</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09704"></a><span class="lineno"> 9704</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09705"></a><span class="lineno"> 9705</span>&#160;      }</div><div class="line"><a name="l09706"></a><span class="lineno"> 9706</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09707"></a><span class="lineno"> 9707</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &lt; 5) {</div><div class="line"><a name="l09708"></a><span class="lineno"> 9708</span>&#160;            <span class="keywordtype">char</span> recname[16];</div><div class="line"><a name="l09709"></a><span class="lineno"> 9709</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l09710"></a><span class="lineno"> 9710</span>&#160;               snprintf(recname, <span class="keyword">sizeof</span>(recname), <span class="stringliteral">&quot;digits/1kvk&quot;</span>);</div><div class="line"><a name="l09711"></a><span class="lineno"> 9711</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09712"></a><span class="lineno"> 9712</span>&#160;               snprintf(recname, <span class="keyword">sizeof</span>(recname), <span class="stringliteral">&quot;digits/%dhk&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>);</div><div class="line"><a name="l09713"></a><span class="lineno"> 9713</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, recname);</div><div class="line"><a name="l09714"></a><span class="lineno"> 9714</span>&#160;         } <span class="keywordflow">else</span></div><div class="line"><a name="l09715"></a><span class="lineno"> 9715</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09716"></a><span class="lineno"> 9716</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09717"></a><span class="lineno"> 9717</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09718"></a><span class="lineno"> 9718</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09719"></a><span class="lineno"> 9719</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09720"></a><span class="lineno"> 9720</span>&#160;      }</div><div class="line"><a name="l09721"></a><span class="lineno"> 9721</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09722"></a><span class="lineno"> 9722</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09723"></a><span class="lineno"> 9723</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09724"></a><span class="lineno"> 9724</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09725"></a><span class="lineno"> 9725</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09726"></a><span class="lineno"> 9726</span>&#160;         }</div><div class="line"><a name="l09727"></a><span class="lineno"> 9727</span>&#160;      }</div><div class="line"><a name="l09728"></a><span class="lineno"> 9728</span>&#160;   }</div><div class="line"><a name="l09729"></a><span class="lineno"> 9729</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09730"></a><span class="lineno"> 9730</span>&#160;}</div><div class="line"><a name="l09731"></a><span class="lineno"> 9731</span>&#160;</div><div class="line"><a name="l09732"></a><span class="lineno"> 9732</span>&#160;<span class="comment">/* ITALIAN syntax */</span></div><div class="line"><a name="l09733"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c"> 9733</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c">vm_intro_it</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09734"></a><span class="lineno"> 9734</span>&#160;{</div><div class="line"><a name="l09735"></a><span class="lineno"> 9735</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09736"></a><span class="lineno"> 9736</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09737"></a><span class="lineno"> 9737</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp;!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>)</div><div class="line"><a name="l09738"></a><span class="lineno"> 9738</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>) ||</div><div class="line"><a name="l09739"></a><span class="lineno"> 9739</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09740"></a><span class="lineno"> 9740</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l09741"></a><span class="lineno"> 9741</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09742"></a><span class="lineno"> 9742</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09743"></a><span class="lineno"> 9743</span>&#160;      res = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) ?</div><div class="line"><a name="l09744"></a><span class="lineno"> 9744</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/un&quot;</span>) ||</div><div class="line"><a name="l09745"></a><span class="lineno"> 9745</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nuovo&quot;</span>) ||</div><div class="line"><a name="l09746"></a><span class="lineno"> 9746</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>) :</div><div class="line"><a name="l09747"></a><span class="lineno"> 9747</span>&#160;         <span class="comment">/* 2 or more new messages */</span></div><div class="line"><a name="l09748"></a><span class="lineno"> 9748</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan)) ||</div><div class="line"><a name="l09749"></a><span class="lineno"> 9749</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nuovi&quot;</span>) ||</div><div class="line"><a name="l09750"></a><span class="lineno"> 9750</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09751"></a><span class="lineno"> 9751</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)</div><div class="line"><a name="l09752"></a><span class="lineno"> 9752</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09753"></a><span class="lineno"> 9753</span>&#160;   }</div><div class="line"><a name="l09754"></a><span class="lineno"> 9754</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09755"></a><span class="lineno"> 9755</span>&#160;      res = (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) ?</div><div class="line"><a name="l09756"></a><span class="lineno"> 9756</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/un&quot;</span>) ||</div><div class="line"><a name="l09757"></a><span class="lineno"> 9757</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-vecchio&quot;</span>) ||</div><div class="line"><a name="l09758"></a><span class="lineno"> 9758</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>) :</div><div class="line"><a name="l09759"></a><span class="lineno"> 9759</span>&#160;         <span class="comment">/* 2 or more old messages */</span></div><div class="line"><a name="l09760"></a><span class="lineno"> 9760</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan)) ||</div><div class="line"><a name="l09761"></a><span class="lineno"> 9761</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-vecchi&quot;</span>) ||</div><div class="line"><a name="l09762"></a><span class="lineno"> 9762</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09763"></a><span class="lineno"> 9763</span>&#160;   }</div><div class="line"><a name="l09764"></a><span class="lineno"> 9764</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09765"></a><span class="lineno"> 9765</span>&#160;}</div><div class="line"><a name="l09766"></a><span class="lineno"> 9766</span>&#160;</div><div class="line"><a name="l09767"></a><span class="lineno"> 9767</span>&#160;<span class="comment">/* POLISH syntax */</span></div><div class="line"><a name="l09768"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7"> 9768</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7">vm_intro_pl</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09769"></a><span class="lineno"> 9769</span>&#160;{</div><div class="line"><a name="l09770"></a><span class="lineno"> 9770</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09771"></a><span class="lineno"> 9771</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09772"></a><span class="lineno"> 9772</span>&#160;   div_t num;</div><div class="line"><a name="l09773"></a><span class="lineno"> 9773</span>&#160;</div><div class="line"><a name="l09774"></a><span class="lineno"> 9774</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09775"></a><span class="lineno"> 9775</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09776"></a><span class="lineno"> 9776</span>&#160;      res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09777"></a><span class="lineno"> 9777</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09778"></a><span class="lineno"> 9778</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09779"></a><span class="lineno"> 9779</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09780"></a><span class="lineno"> 9780</span>&#160;   }</div><div class="line"><a name="l09781"></a><span class="lineno"> 9781</span>&#160;</div><div class="line"><a name="l09782"></a><span class="lineno"> 9782</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09783"></a><span class="lineno"> 9783</span>&#160;      num = div(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, 10);</div><div class="line"><a name="l09784"></a><span class="lineno"> 9784</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l09785"></a><span class="lineno"> 9785</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1-a&quot;</span>);</div><div class="line"><a name="l09786"></a><span class="lineno"> 9786</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-a&quot;</span>);</div><div class="line"><a name="l09787"></a><span class="lineno"> 9787</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09788"></a><span class="lineno"> 9788</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {</div><div class="line"><a name="l09789"></a><span class="lineno"> 9789</span>&#160;         <span class="keywordflow">if</span> (num.rem == 2) {</div><div class="line"><a name="l09790"></a><span class="lineno"> 9790</span>&#160;            <span class="keywordflow">if</span> (!num.quot) {</div><div class="line"><a name="l09791"></a><span class="lineno"> 9791</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);</div><div class="line"><a name="l09792"></a><span class="lineno"> 9792</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09793"></a><span class="lineno"> 9793</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> - 2 , <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09794"></a><span class="lineno"> 9794</span>&#160;               res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);</div><div class="line"><a name="l09795"></a><span class="lineno"> 9795</span>&#160;            }</div><div class="line"><a name="l09796"></a><span class="lineno"> 9796</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09797"></a><span class="lineno"> 9797</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09798"></a><span class="lineno"> 9798</span>&#160;         }</div><div class="line"><a name="l09799"></a><span class="lineno"> 9799</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-e&quot;</span>);</div><div class="line"><a name="l09800"></a><span class="lineno"> 9800</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09801"></a><span class="lineno"> 9801</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09802"></a><span class="lineno"> 9802</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09803"></a><span class="lineno"> 9803</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-ych&quot;</span>);</div><div class="line"><a name="l09804"></a><span class="lineno"> 9804</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09805"></a><span class="lineno"> 9805</span>&#160;      }</div><div class="line"><a name="l09806"></a><span class="lineno"> 9806</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)</div><div class="line"><a name="l09807"></a><span class="lineno"> 9807</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09808"></a><span class="lineno"> 9808</span>&#160;   }</div><div class="line"><a name="l09809"></a><span class="lineno"> 9809</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09810"></a><span class="lineno"> 9810</span>&#160;      num = div(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, 10);</div><div class="line"><a name="l09811"></a><span class="lineno"> 9811</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l09812"></a><span class="lineno"> 9812</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1-a&quot;</span>);</div><div class="line"><a name="l09813"></a><span class="lineno"> 9813</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-a&quot;</span>);</div><div class="line"><a name="l09814"></a><span class="lineno"> 9814</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09815"></a><span class="lineno"> 9815</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {</div><div class="line"><a name="l09816"></a><span class="lineno"> 9816</span>&#160;         <span class="keywordflow">if</span> (num.rem == 2) {</div><div class="line"><a name="l09817"></a><span class="lineno"> 9817</span>&#160;            <span class="keywordflow">if</span> (!num.quot) {</div><div class="line"><a name="l09818"></a><span class="lineno"> 9818</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);</div><div class="line"><a name="l09819"></a><span class="lineno"> 9819</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09820"></a><span class="lineno"> 9820</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> - 2 , <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09821"></a><span class="lineno"> 9821</span>&#160;               res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);</div><div class="line"><a name="l09822"></a><span class="lineno"> 9822</span>&#160;            }</div><div class="line"><a name="l09823"></a><span class="lineno"> 9823</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09824"></a><span class="lineno"> 9824</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09825"></a><span class="lineno"> 9825</span>&#160;         }</div><div class="line"><a name="l09826"></a><span class="lineno"> 9826</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-e&quot;</span>);</div><div class="line"><a name="l09827"></a><span class="lineno"> 9827</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09828"></a><span class="lineno"> 9828</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09829"></a><span class="lineno"> 9829</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09830"></a><span class="lineno"> 9830</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-ych&quot;</span>);</div><div class="line"><a name="l09831"></a><span class="lineno"> 9831</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09832"></a><span class="lineno"> 9832</span>&#160;      }</div><div class="line"><a name="l09833"></a><span class="lineno"> 9833</span>&#160;   }</div><div class="line"><a name="l09834"></a><span class="lineno"> 9834</span>&#160;</div><div class="line"><a name="l09835"></a><span class="lineno"> 9835</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09836"></a><span class="lineno"> 9836</span>&#160;}</div><div class="line"><a name="l09837"></a><span class="lineno"> 9837</span>&#160;</div><div class="line"><a name="l09838"></a><span class="lineno"> 9838</span>&#160;<span class="comment">/* SWEDISH syntax */</span></div><div class="line"><a name="l09839"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af54b6b5388c2838875f222a795850409"> 9839</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af54b6b5388c2838875f222a795850409">vm_intro_se</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09840"></a><span class="lineno"> 9840</span>&#160;{</div><div class="line"><a name="l09841"></a><span class="lineno"> 9841</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09842"></a><span class="lineno"> 9842</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09843"></a><span class="lineno"> 9843</span>&#160;</div><div class="line"><a name="l09844"></a><span class="lineno"> 9844</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09845"></a><span class="lineno"> 9845</span>&#160;   <span class="keywordflow">if</span> (res)</div><div class="line"><a name="l09846"></a><span class="lineno"> 9846</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09847"></a><span class="lineno"> 9847</span>&#160;</div><div class="line"><a name="l09848"></a><span class="lineno"> 9848</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l09849"></a><span class="lineno"> 9849</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09850"></a><span class="lineno"> 9850</span>&#160;      res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09851"></a><span class="lineno"> 9851</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09852"></a><span class="lineno"> 9852</span>&#160;   }</div><div class="line"><a name="l09853"></a><span class="lineno"> 9853</span>&#160;</div><div class="line"><a name="l09854"></a><span class="lineno"> 9854</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09855"></a><span class="lineno"> 9855</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l09856"></a><span class="lineno"> 9856</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/ett&quot;</span>);</div><div class="line"><a name="l09857"></a><span class="lineno"> 9857</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nytt&quot;</span>);</div><div class="line"><a name="l09858"></a><span class="lineno"> 9858</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09859"></a><span class="lineno"> 9859</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09860"></a><span class="lineno"> 9860</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09861"></a><span class="lineno"> 9861</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nya&quot;</span>);</div><div class="line"><a name="l09862"></a><span class="lineno"> 9862</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09863"></a><span class="lineno"> 9863</span>&#160;      }</div><div class="line"><a name="l09864"></a><span class="lineno"> 9864</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)</div><div class="line"><a name="l09865"></a><span class="lineno"> 9865</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09866"></a><span class="lineno"> 9866</span>&#160;   }</div><div class="line"><a name="l09867"></a><span class="lineno"> 9867</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09868"></a><span class="lineno"> 9868</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l09869"></a><span class="lineno"> 9869</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/ett&quot;</span>);</div><div class="line"><a name="l09870"></a><span class="lineno"> 9870</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gammalt&quot;</span>);</div><div class="line"><a name="l09871"></a><span class="lineno"> 9871</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09872"></a><span class="lineno"> 9872</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09873"></a><span class="lineno"> 9873</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09874"></a><span class="lineno"> 9874</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gamla&quot;</span>);</div><div class="line"><a name="l09875"></a><span class="lineno"> 9875</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09876"></a><span class="lineno"> 9876</span>&#160;      }</div><div class="line"><a name="l09877"></a><span class="lineno"> 9877</span>&#160;   }</div><div class="line"><a name="l09878"></a><span class="lineno"> 9878</span>&#160;</div><div class="line"><a name="l09879"></a><span class="lineno"> 9879</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09880"></a><span class="lineno"> 9880</span>&#160;}</div><div class="line"><a name="l09881"></a><span class="lineno"> 9881</span>&#160;</div><div class="line"><a name="l09882"></a><span class="lineno"> 9882</span>&#160;<span class="comment">/* NORWEGIAN syntax */</span></div><div class="line"><a name="l09883"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8"> 9883</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8">vm_intro_no</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09884"></a><span class="lineno"> 9884</span>&#160;{</div><div class="line"><a name="l09885"></a><span class="lineno"> 9885</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09886"></a><span class="lineno"> 9886</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09887"></a><span class="lineno"> 9887</span>&#160;</div><div class="line"><a name="l09888"></a><span class="lineno"> 9888</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09889"></a><span class="lineno"> 9889</span>&#160;   <span class="keywordflow">if</span> (res)</div><div class="line"><a name="l09890"></a><span class="lineno"> 9890</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09891"></a><span class="lineno"> 9891</span>&#160;</div><div class="line"><a name="l09892"></a><span class="lineno"> 9892</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l09893"></a><span class="lineno"> 9893</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09894"></a><span class="lineno"> 9894</span>&#160;      res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09895"></a><span class="lineno"> 9895</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09896"></a><span class="lineno"> 9896</span>&#160;   }</div><div class="line"><a name="l09897"></a><span class="lineno"> 9897</span>&#160;</div><div class="line"><a name="l09898"></a><span class="lineno"> 9898</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09899"></a><span class="lineno"> 9899</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l09900"></a><span class="lineno"> 9900</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);</div><div class="line"><a name="l09901"></a><span class="lineno"> 9901</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-ny&quot;</span>);</div><div class="line"><a name="l09902"></a><span class="lineno"> 9902</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09903"></a><span class="lineno"> 9903</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09904"></a><span class="lineno"> 9904</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09905"></a><span class="lineno"> 9905</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nye&quot;</span>);</div><div class="line"><a name="l09906"></a><span class="lineno"> 9906</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09907"></a><span class="lineno"> 9907</span>&#160;      }</div><div class="line"><a name="l09908"></a><span class="lineno"> 9908</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)</div><div class="line"><a name="l09909"></a><span class="lineno"> 9909</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09910"></a><span class="lineno"> 9910</span>&#160;   }</div><div class="line"><a name="l09911"></a><span class="lineno"> 9911</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09912"></a><span class="lineno"> 9912</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l09913"></a><span class="lineno"> 9913</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);</div><div class="line"><a name="l09914"></a><span class="lineno"> 9914</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gamel&quot;</span>);</div><div class="line"><a name="l09915"></a><span class="lineno"> 9915</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09916"></a><span class="lineno"> 9916</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09917"></a><span class="lineno"> 9917</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09918"></a><span class="lineno"> 9918</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gamle&quot;</span>);</div><div class="line"><a name="l09919"></a><span class="lineno"> 9919</span>&#160;         res = res ? res : <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09920"></a><span class="lineno"> 9920</span>&#160;      }</div><div class="line"><a name="l09921"></a><span class="lineno"> 9921</span>&#160;   }</div><div class="line"><a name="l09922"></a><span class="lineno"> 9922</span>&#160;</div><div class="line"><a name="l09923"></a><span class="lineno"> 9923</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09924"></a><span class="lineno"> 9924</span>&#160;}</div><div class="line"><a name="l09925"></a><span class="lineno"> 9925</span>&#160;</div><div class="line"><a name="l09926"></a><span class="lineno"> 9926</span>&#160;<span class="comment">/* GERMAN syntax */</span></div><div class="line"><a name="l09927"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a"> 9927</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a">vm_intro_de</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09928"></a><span class="lineno"> 9928</span>&#160;{</div><div class="line"><a name="l09929"></a><span class="lineno"> 9929</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09930"></a><span class="lineno"> 9930</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09931"></a><span class="lineno"> 9931</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09932"></a><span class="lineno"> 9932</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09933"></a><span class="lineno"> 9933</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09934"></a><span class="lineno"> 9934</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l09935"></a><span class="lineno"> 9935</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1F&quot;</span>);</div><div class="line"><a name="l09936"></a><span class="lineno"> 9936</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l09937"></a><span class="lineno"> 9937</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09938"></a><span class="lineno"> 9938</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09939"></a><span class="lineno"> 9939</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l09940"></a><span class="lineno"> 9940</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l09941"></a><span class="lineno"> 9941</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l09942"></a><span class="lineno"> 9942</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09943"></a><span class="lineno"> 9943</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l09944"></a><span class="lineno"> 9944</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09945"></a><span class="lineno"> 9945</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09946"></a><span class="lineno"> 9946</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09947"></a><span class="lineno"> 9947</span>&#160;         }</div><div class="line"><a name="l09948"></a><span class="lineno"> 9948</span>&#160;</div><div class="line"><a name="l09949"></a><span class="lineno"> 9949</span>&#160;      }</div><div class="line"><a name="l09950"></a><span class="lineno"> 9950</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l09951"></a><span class="lineno"> 9951</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l09952"></a><span class="lineno"> 9952</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1F&quot;</span>);</div><div class="line"><a name="l09953"></a><span class="lineno"> 9953</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l09954"></a><span class="lineno"> 9954</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09955"></a><span class="lineno"> 9955</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09956"></a><span class="lineno"> 9956</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l09957"></a><span class="lineno"> 9957</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09958"></a><span class="lineno"> 9958</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l09959"></a><span class="lineno"> 9959</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09960"></a><span class="lineno"> 9960</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l09961"></a><span class="lineno"> 9961</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09962"></a><span class="lineno"> 9962</span>&#160;         }</div><div class="line"><a name="l09963"></a><span class="lineno"> 9963</span>&#160;      }</div><div class="line"><a name="l09964"></a><span class="lineno"> 9964</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09965"></a><span class="lineno"> 9965</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l09966"></a><span class="lineno"> 9966</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l09967"></a><span class="lineno"> 9967</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09968"></a><span class="lineno"> 9968</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09969"></a><span class="lineno"> 9969</span>&#160;         }</div><div class="line"><a name="l09970"></a><span class="lineno"> 9970</span>&#160;      }</div><div class="line"><a name="l09971"></a><span class="lineno"> 9971</span>&#160;   }</div><div class="line"><a name="l09972"></a><span class="lineno"> 9972</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l09973"></a><span class="lineno"> 9973</span>&#160;}</div><div class="line"><a name="l09974"></a><span class="lineno"> 9974</span>&#160;</div><div class="line"><a name="l09975"></a><span class="lineno"> 9975</span>&#160;<span class="comment">/* SPANISH syntax */</span></div><div class="line"><a name="l09976"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae"> 9976</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae">vm_intro_es</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l09977"></a><span class="lineno"> 9977</span>&#160;{</div><div class="line"><a name="l09978"></a><span class="lineno"> 9978</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l09979"></a><span class="lineno"> 9979</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l09980"></a><span class="lineno"> 9980</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l09981"></a><span class="lineno"> 9981</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhaveno&quot;</span>);</div><div class="line"><a name="l09982"></a><span class="lineno"> 9982</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09983"></a><span class="lineno"> 9983</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l09984"></a><span class="lineno"> 9984</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09985"></a><span class="lineno"> 9985</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l09986"></a><span class="lineno"> 9986</span>&#160;   }</div><div class="line"><a name="l09987"></a><span class="lineno"> 9987</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09988"></a><span class="lineno"> 9988</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l09989"></a><span class="lineno"> 9989</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l09990"></a><span class="lineno"> 9990</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l09991"></a><span class="lineno"> 9991</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1M&quot;</span>);</div><div class="line"><a name="l09992"></a><span class="lineno"> 9992</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09993"></a><span class="lineno"> 9993</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l09994"></a><span class="lineno"> 9994</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09995"></a><span class="lineno"> 9995</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);</div><div class="line"><a name="l09996"></a><span class="lineno"> 9996</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l09997"></a><span class="lineno"> 9997</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l09998"></a><span class="lineno"> 9998</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l09999"></a><span class="lineno"> 9999</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10000"></a><span class="lineno">10000</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10001"></a><span class="lineno">10001</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10002"></a><span class="lineno">10002</span>&#160;            }</div><div class="line"><a name="l10003"></a><span class="lineno">10003</span>&#160;         }</div><div class="line"><a name="l10004"></a><span class="lineno">10004</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10005"></a><span class="lineno">10005</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10006"></a><span class="lineno">10006</span>&#160;      }</div><div class="line"><a name="l10007"></a><span class="lineno">10007</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10008"></a><span class="lineno">10008</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10009"></a><span class="lineno">10009</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l10010"></a><span class="lineno">10010</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1M&quot;</span>);</div><div class="line"><a name="l10011"></a><span class="lineno">10011</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10012"></a><span class="lineno">10012</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10013"></a><span class="lineno">10013</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10014"></a><span class="lineno">10014</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);</div><div class="line"><a name="l10015"></a><span class="lineno">10015</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10016"></a><span class="lineno">10016</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10017"></a><span class="lineno">10017</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10018"></a><span class="lineno">10018</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10019"></a><span class="lineno">10019</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10020"></a><span class="lineno">10020</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10021"></a><span class="lineno">10021</span>&#160;            }</div><div class="line"><a name="l10022"></a><span class="lineno">10022</span>&#160;         }</div><div class="line"><a name="l10023"></a><span class="lineno">10023</span>&#160;      }</div><div class="line"><a name="l10024"></a><span class="lineno">10024</span>&#160;   }</div><div class="line"><a name="l10025"></a><span class="lineno">10025</span>&#160;<span class="keywordflow">return</span> res;</div><div class="line"><a name="l10026"></a><span class="lineno">10026</span>&#160;}</div><div class="line"><a name="l10027"></a><span class="lineno">10027</span>&#160;</div><div class="line"><a name="l10028"></a><span class="lineno">10028</span>&#160;<span class="comment">/* BRAZILIAN PORTUGUESE syntax */</span></div><div class="line"><a name="l10029"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">10029</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">vm_intro_pt_BR</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms) {</div><div class="line"><a name="l10030"></a><span class="lineno">10030</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l10031"></a><span class="lineno">10031</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10032"></a><span class="lineno">10032</span>&#160;   <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l10033"></a><span class="lineno">10033</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomessages&quot;</span>);</div><div class="line"><a name="l10034"></a><span class="lineno">10034</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10035"></a><span class="lineno">10035</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10036"></a><span class="lineno">10036</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l10037"></a><span class="lineno">10037</span>&#160;   }</div><div class="line"><a name="l10038"></a><span class="lineno">10038</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10039"></a><span class="lineno">10039</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10040"></a><span class="lineno">10040</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l10041"></a><span class="lineno">10041</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l10042"></a><span class="lineno">10042</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10043"></a><span class="lineno">10043</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10044"></a><span class="lineno">10044</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10045"></a><span class="lineno">10045</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);</div><div class="line"><a name="l10046"></a><span class="lineno">10046</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10047"></a><span class="lineno">10047</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10048"></a><span class="lineno">10048</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10049"></a><span class="lineno">10049</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10050"></a><span class="lineno">10050</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10051"></a><span class="lineno">10051</span>&#160;      }</div><div class="line"><a name="l10052"></a><span class="lineno">10052</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10053"></a><span class="lineno">10053</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10054"></a><span class="lineno">10054</span>&#160;   }</div><div class="line"><a name="l10055"></a><span class="lineno">10055</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10056"></a><span class="lineno">10056</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10057"></a><span class="lineno">10057</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l10058"></a><span class="lineno">10058</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l10059"></a><span class="lineno">10059</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10060"></a><span class="lineno">10060</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10061"></a><span class="lineno">10061</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10062"></a><span class="lineno">10062</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);</div><div class="line"><a name="l10063"></a><span class="lineno">10063</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10064"></a><span class="lineno">10064</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10065"></a><span class="lineno">10065</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10066"></a><span class="lineno">10066</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10067"></a><span class="lineno">10067</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10068"></a><span class="lineno">10068</span>&#160;      }</div><div class="line"><a name="l10069"></a><span class="lineno">10069</span>&#160;   }</div><div class="line"><a name="l10070"></a><span class="lineno">10070</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10071"></a><span class="lineno">10071</span>&#160;}</div><div class="line"><a name="l10072"></a><span class="lineno">10072</span>&#160;</div><div class="line"><a name="l10073"></a><span class="lineno">10073</span>&#160;<span class="comment">/* FRENCH syntax */</span></div><div class="line"><a name="l10074"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">10074</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">vm_intro_fr</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10075"></a><span class="lineno">10075</span>&#160;{</div><div class="line"><a name="l10076"></a><span class="lineno">10076</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l10077"></a><span class="lineno">10077</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10078"></a><span class="lineno">10078</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l10079"></a><span class="lineno">10079</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10080"></a><span class="lineno">10080</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10081"></a><span class="lineno">10081</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10082"></a><span class="lineno">10082</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10083"></a><span class="lineno">10083</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10084"></a><span class="lineno">10084</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10085"></a><span class="lineno">10085</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10086"></a><span class="lineno">10086</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10087"></a><span class="lineno">10087</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l10088"></a><span class="lineno">10088</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10089"></a><span class="lineno">10089</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10090"></a><span class="lineno">10090</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10091"></a><span class="lineno">10091</span>&#160;         }</div><div class="line"><a name="l10092"></a><span class="lineno">10092</span>&#160;</div><div class="line"><a name="l10093"></a><span class="lineno">10093</span>&#160;      }</div><div class="line"><a name="l10094"></a><span class="lineno">10094</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10095"></a><span class="lineno">10095</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10096"></a><span class="lineno">10096</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10097"></a><span class="lineno">10097</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10098"></a><span class="lineno">10098</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10099"></a><span class="lineno">10099</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l10100"></a><span class="lineno">10100</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10101"></a><span class="lineno">10101</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10102"></a><span class="lineno">10102</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10103"></a><span class="lineno">10103</span>&#160;         }</div><div class="line"><a name="l10104"></a><span class="lineno">10104</span>&#160;      }</div><div class="line"><a name="l10105"></a><span class="lineno">10105</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10106"></a><span class="lineno">10106</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l10107"></a><span class="lineno">10107</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l10108"></a><span class="lineno">10108</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10109"></a><span class="lineno">10109</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10110"></a><span class="lineno">10110</span>&#160;         }</div><div class="line"><a name="l10111"></a><span class="lineno">10111</span>&#160;      }</div><div class="line"><a name="l10112"></a><span class="lineno">10112</span>&#160;   }</div><div class="line"><a name="l10113"></a><span class="lineno">10113</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10114"></a><span class="lineno">10114</span>&#160;}</div><div class="line"><a name="l10115"></a><span class="lineno">10115</span>&#160;</div><div class="line"><a name="l10116"></a><span class="lineno">10116</span>&#160;<span class="comment">/* DUTCH syntax */</span></div><div class="line"><a name="l10117"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">10117</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">vm_intro_nl</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10118"></a><span class="lineno">10118</span>&#160;{</div><div class="line"><a name="l10119"></a><span class="lineno">10119</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l10120"></a><span class="lineno">10120</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10121"></a><span class="lineno">10121</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l10122"></a><span class="lineno">10122</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10123"></a><span class="lineno">10123</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10124"></a><span class="lineno">10124</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10125"></a><span class="lineno">10125</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10126"></a><span class="lineno">10126</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l10127"></a><span class="lineno">10127</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);</div><div class="line"><a name="l10128"></a><span class="lineno">10128</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10129"></a><span class="lineno">10129</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10130"></a><span class="lineno">10130</span>&#160;         }</div><div class="line"><a name="l10131"></a><span class="lineno">10131</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10132"></a><span class="lineno">10132</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10133"></a><span class="lineno">10133</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10134"></a><span class="lineno">10134</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l10135"></a><span class="lineno">10135</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10136"></a><span class="lineno">10136</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10137"></a><span class="lineno">10137</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10138"></a><span class="lineno">10138</span>&#160;         }</div><div class="line"><a name="l10139"></a><span class="lineno">10139</span>&#160;</div><div class="line"><a name="l10140"></a><span class="lineno">10140</span>&#160;      }</div><div class="line"><a name="l10141"></a><span class="lineno">10141</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10142"></a><span class="lineno">10142</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10143"></a><span class="lineno">10143</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10144"></a><span class="lineno">10144</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l10145"></a><span class="lineno">10145</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);</div><div class="line"><a name="l10146"></a><span class="lineno">10146</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10147"></a><span class="lineno">10147</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10148"></a><span class="lineno">10148</span>&#160;         }</div><div class="line"><a name="l10149"></a><span class="lineno">10149</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10150"></a><span class="lineno">10150</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l10151"></a><span class="lineno">10151</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10152"></a><span class="lineno">10152</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10153"></a><span class="lineno">10153</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10154"></a><span class="lineno">10154</span>&#160;         }</div><div class="line"><a name="l10155"></a><span class="lineno">10155</span>&#160;      }</div><div class="line"><a name="l10156"></a><span class="lineno">10156</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10157"></a><span class="lineno">10157</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l10158"></a><span class="lineno">10158</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l10159"></a><span class="lineno">10159</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10160"></a><span class="lineno">10160</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10161"></a><span class="lineno">10161</span>&#160;         }</div><div class="line"><a name="l10162"></a><span class="lineno">10162</span>&#160;      }</div><div class="line"><a name="l10163"></a><span class="lineno">10163</span>&#160;   }</div><div class="line"><a name="l10164"></a><span class="lineno">10164</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10165"></a><span class="lineno">10165</span>&#160;}</div><div class="line"><a name="l10166"></a><span class="lineno">10166</span>&#160;</div><div class="line"><a name="l10167"></a><span class="lineno">10167</span>&#160;<span class="comment">/* PORTUGUESE syntax */</span></div><div class="line"><a name="l10168"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">10168</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">vm_intro_pt</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10169"></a><span class="lineno">10169</span>&#160;{</div><div class="line"><a name="l10170"></a><span class="lineno">10170</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l10171"></a><span class="lineno">10171</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10172"></a><span class="lineno">10172</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l10173"></a><span class="lineno">10173</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10174"></a><span class="lineno">10174</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10175"></a><span class="lineno">10175</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l10176"></a><span class="lineno">10176</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10177"></a><span class="lineno">10177</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l10178"></a><span class="lineno">10178</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10179"></a><span class="lineno">10179</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10180"></a><span class="lineno">10180</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);</div><div class="line"><a name="l10181"></a><span class="lineno">10181</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10182"></a><span class="lineno">10182</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10183"></a><span class="lineno">10183</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10184"></a><span class="lineno">10184</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10185"></a><span class="lineno">10185</span>&#160;            }</div><div class="line"><a name="l10186"></a><span class="lineno">10186</span>&#160;         }</div><div class="line"><a name="l10187"></a><span class="lineno">10187</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10188"></a><span class="lineno">10188</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10189"></a><span class="lineno">10189</span>&#160;      }</div><div class="line"><a name="l10190"></a><span class="lineno">10190</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10191"></a><span class="lineno">10191</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;f&quot;</span>);</div><div class="line"><a name="l10192"></a><span class="lineno">10192</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10193"></a><span class="lineno">10193</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {</div><div class="line"><a name="l10194"></a><span class="lineno">10194</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10195"></a><span class="lineno">10195</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10196"></a><span class="lineno">10196</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);</div><div class="line"><a name="l10197"></a><span class="lineno">10197</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10198"></a><span class="lineno">10198</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10199"></a><span class="lineno">10199</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10200"></a><span class="lineno">10200</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10201"></a><span class="lineno">10201</span>&#160;            }</div><div class="line"><a name="l10202"></a><span class="lineno">10202</span>&#160;         }</div><div class="line"><a name="l10203"></a><span class="lineno">10203</span>&#160;      }</div><div class="line"><a name="l10204"></a><span class="lineno">10204</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10205"></a><span class="lineno">10205</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l10206"></a><span class="lineno">10206</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l10207"></a><span class="lineno">10207</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10208"></a><span class="lineno">10208</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10209"></a><span class="lineno">10209</span>&#160;         }</div><div class="line"><a name="l10210"></a><span class="lineno">10210</span>&#160;      }</div><div class="line"><a name="l10211"></a><span class="lineno">10211</span>&#160;   }</div><div class="line"><a name="l10212"></a><span class="lineno">10212</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10213"></a><span class="lineno">10213</span>&#160;}</div><div class="line"><a name="l10214"></a><span class="lineno">10214</span>&#160;</div><div class="line"><a name="l10215"></a><span class="lineno">10215</span>&#160;</div><div class="line"><a name="l10216"></a><span class="lineno">10216</span>&#160;<span class="comment">/* CZECH syntax */</span></div><div class="line"><a name="l10217"></a><span class="lineno">10217</span>&#160;<span class="comment">/* in czech there must be declension of word new and message</span></div><div class="line"><a name="l10218"></a><span class="lineno">10218</span>&#160;<span class="comment"> * czech        : english        : czech      : english</span></div><div class="line"><a name="l10219"></a><span class="lineno">10219</span>&#160;<span class="comment"> * --------------------------------------------------------</span></div><div class="line"><a name="l10220"></a><span class="lineno">10220</span>&#160;<span class="comment"> * vm-youhave   : you have</span></div><div class="line"><a name="l10221"></a><span class="lineno">10221</span>&#160;<span class="comment"> * vm-novou     : one new        : vm-zpravu  : message</span></div><div class="line"><a name="l10222"></a><span class="lineno">10222</span>&#160;<span class="comment"> * vm-nove      : 2-4 new        : vm-zpravy  : messages</span></div><div class="line"><a name="l10223"></a><span class="lineno">10223</span>&#160;<span class="comment"> * vm-novych    : 5-infinite new : vm-zprav   : messages</span></div><div class="line"><a name="l10224"></a><span class="lineno">10224</span>&#160;<span class="comment"> * vm-starou   : one old</span></div><div class="line"><a name="l10225"></a><span class="lineno">10225</span>&#160;<span class="comment"> * vm-stare     : 2-4 old</span></div><div class="line"><a name="l10226"></a><span class="lineno">10226</span>&#160;<span class="comment"> * vm-starych   : 5-infinite old</span></div><div class="line"><a name="l10227"></a><span class="lineno">10227</span>&#160;<span class="comment"> * jednu        : one   - falling 4.</span></div><div class="line"><a name="l10228"></a><span class="lineno">10228</span>&#160;<span class="comment"> * vm-no        : no  ( no messages )</span></div><div class="line"><a name="l10229"></a><span class="lineno">10229</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l10230"></a><span class="lineno">10230</span>&#160;</div><div class="line"><a name="l10231"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">10231</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10232"></a><span class="lineno">10232</span>&#160;{</div><div class="line"><a name="l10233"></a><span class="lineno">10233</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10234"></a><span class="lineno">10234</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l10235"></a><span class="lineno">10235</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10236"></a><span class="lineno">10236</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10237"></a><span class="lineno">10237</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {</div><div class="line"><a name="l10238"></a><span class="lineno">10238</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/jednu&quot;</span>);</div><div class="line"><a name="l10239"></a><span class="lineno">10239</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10240"></a><span class="lineno">10240</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10241"></a><span class="lineno">10241</span>&#160;         }</div><div class="line"><a name="l10242"></a><span class="lineno">10242</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10243"></a><span class="lineno">10243</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l10244"></a><span class="lineno">10244</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-novou&quot;</span>);</div><div class="line"><a name="l10245"></a><span class="lineno">10245</span>&#160;            <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &lt; 5))</div><div class="line"><a name="l10246"></a><span class="lineno">10246</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nove&quot;</span>);</div><div class="line"><a name="l10247"></a><span class="lineno">10247</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 4)</div><div class="line"><a name="l10248"></a><span class="lineno">10248</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-novych&quot;</span>);</div><div class="line"><a name="l10249"></a><span class="lineno">10249</span>&#160;         }</div><div class="line"><a name="l10250"></a><span class="lineno">10250</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10251"></a><span class="lineno">10251</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10252"></a><span class="lineno">10252</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10253"></a><span class="lineno">10253</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)</div><div class="line"><a name="l10254"></a><span class="lineno">10254</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravu&quot;</span>);</div><div class="line"><a name="l10255"></a><span class="lineno">10255</span>&#160;            <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &lt; 5))</div><div class="line"><a name="l10256"></a><span class="lineno">10256</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravy&quot;</span>);</div><div class="line"><a name="l10257"></a><span class="lineno">10257</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 4)</div><div class="line"><a name="l10258"></a><span class="lineno">10258</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zprav&quot;</span>);</div><div class="line"><a name="l10259"></a><span class="lineno">10259</span>&#160;         }</div><div class="line"><a name="l10260"></a><span class="lineno">10260</span>&#160;      }</div><div class="line"><a name="l10261"></a><span class="lineno">10261</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10262"></a><span class="lineno">10262</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10263"></a><span class="lineno">10263</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10264"></a><span class="lineno">10264</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l10265"></a><span class="lineno">10265</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starou&quot;</span>);</div><div class="line"><a name="l10266"></a><span class="lineno">10266</span>&#160;            <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &lt; 5))</div><div class="line"><a name="l10267"></a><span class="lineno">10267</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-stare&quot;</span>);</div><div class="line"><a name="l10268"></a><span class="lineno">10268</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &gt; 4)</div><div class="line"><a name="l10269"></a><span class="lineno">10269</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starych&quot;</span>);</div><div class="line"><a name="l10270"></a><span class="lineno">10270</span>&#160;         }</div><div class="line"><a name="l10271"></a><span class="lineno">10271</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10272"></a><span class="lineno">10272</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)</div><div class="line"><a name="l10273"></a><span class="lineno">10273</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravu&quot;</span>);</div><div class="line"><a name="l10274"></a><span class="lineno">10274</span>&#160;            <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &lt; 5))</div><div class="line"><a name="l10275"></a><span class="lineno">10275</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravy&quot;</span>);</div><div class="line"><a name="l10276"></a><span class="lineno">10276</span>&#160;            <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &gt; 4)</div><div class="line"><a name="l10277"></a><span class="lineno">10277</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zprav&quot;</span>);</div><div class="line"><a name="l10278"></a><span class="lineno">10278</span>&#160;         }</div><div class="line"><a name="l10279"></a><span class="lineno">10279</span>&#160;      }</div><div class="line"><a name="l10280"></a><span class="lineno">10280</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10281"></a><span class="lineno">10281</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l10282"></a><span class="lineno">10282</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l10283"></a><span class="lineno">10283</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10284"></a><span class="lineno">10284</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravy&quot;</span>);</div><div class="line"><a name="l10285"></a><span class="lineno">10285</span>&#160;         }</div><div class="line"><a name="l10286"></a><span class="lineno">10286</span>&#160;      }</div><div class="line"><a name="l10287"></a><span class="lineno">10287</span>&#160;   }</div><div class="line"><a name="l10288"></a><span class="lineno">10288</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10289"></a><span class="lineno">10289</span>&#160;}</div><div class="line"><a name="l10290"></a><span class="lineno">10290</span>&#160;</div><div class="line"><a name="l10291"></a><span class="lineno">10291</span>&#160;<span class="comment">/* CHINESE (Taiwan) syntax */</span></div><div class="line"><a name="l10292"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">10292</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">vm_intro_zh</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10293"></a><span class="lineno">10293</span>&#160;{</div><div class="line"><a name="l10294"></a><span class="lineno">10294</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10295"></a><span class="lineno">10295</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l10296"></a><span class="lineno">10296</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-you&quot;</span>);</div><div class="line"><a name="l10297"></a><span class="lineno">10297</span>&#160;</div><div class="line"><a name="l10298"></a><span class="lineno">10298</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10299"></a><span class="lineno">10299</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-have&quot;</span>);</div><div class="line"><a name="l10300"></a><span class="lineno">10300</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10301"></a><span class="lineno">10301</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10302"></a><span class="lineno">10302</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10303"></a><span class="lineno">10303</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tong&quot;</span>);</div><div class="line"><a name="l10304"></a><span class="lineno">10304</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10305"></a><span class="lineno">10305</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10306"></a><span class="lineno">10306</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10307"></a><span class="lineno">10307</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10308"></a><span class="lineno">10308</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10309"></a><span class="lineno">10309</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10310"></a><span class="lineno">10310</span>&#160;   }</div><div class="line"><a name="l10311"></a><span class="lineno">10311</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10312"></a><span class="lineno">10312</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-have&quot;</span>);</div><div class="line"><a name="l10313"></a><span class="lineno">10313</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10314"></a><span class="lineno">10314</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10315"></a><span class="lineno">10315</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10316"></a><span class="lineno">10316</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tong&quot;</span>);</div><div class="line"><a name="l10317"></a><span class="lineno">10317</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10318"></a><span class="lineno">10318</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10319"></a><span class="lineno">10319</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10320"></a><span class="lineno">10320</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10321"></a><span class="lineno">10321</span>&#160;   }</div><div class="line"><a name="l10322"></a><span class="lineno">10322</span>&#160;   <span class="keywordflow">if</span> (!res &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10323"></a><span class="lineno">10323</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-haveno&quot;</span>);</div><div class="line"><a name="l10324"></a><span class="lineno">10324</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10325"></a><span class="lineno">10325</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10326"></a><span class="lineno">10326</span>&#160;   }</div><div class="line"><a name="l10327"></a><span class="lineno">10327</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10328"></a><span class="lineno">10328</span>&#160;}</div><div class="line"><a name="l10329"></a><span class="lineno">10329</span>&#160;</div><div class="line"><a name="l10330"></a><span class="lineno">10330</span>&#160;<span class="comment">/* Vietnamese syntax */</span></div><div class="line"><a name="l10331"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6b932796ecb15a8350a4bf3f9429045a">10331</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6b932796ecb15a8350a4bf3f9429045a">vm_intro_vi</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10332"></a><span class="lineno">10332</span>&#160;{</div><div class="line"><a name="l10333"></a><span class="lineno">10333</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l10334"></a><span class="lineno">10334</span>&#160;</div><div class="line"><a name="l10335"></a><span class="lineno">10335</span>&#160;   <span class="comment">/* Introduce messages they have */</span></div><div class="line"><a name="l10336"></a><span class="lineno">10336</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l10337"></a><span class="lineno">10337</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10338"></a><span class="lineno">10338</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10339"></a><span class="lineno">10339</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10340"></a><span class="lineno">10340</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10341"></a><span class="lineno">10341</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);</div><div class="line"><a name="l10342"></a><span class="lineno">10342</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)</div><div class="line"><a name="l10343"></a><span class="lineno">10343</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);</div><div class="line"><a name="l10344"></a><span class="lineno">10344</span>&#160;      }</div><div class="line"><a name="l10345"></a><span class="lineno">10345</span>&#160;      <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l10346"></a><span class="lineno">10346</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l10347"></a><span class="lineno">10347</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10348"></a><span class="lineno">10348</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);</div><div class="line"><a name="l10349"></a><span class="lineno">10349</span>&#160;      }</div><div class="line"><a name="l10350"></a><span class="lineno">10350</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10351"></a><span class="lineno">10351</span>&#160;         <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l10352"></a><span class="lineno">10352</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l10353"></a><span class="lineno">10353</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10354"></a><span class="lineno">10354</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l10355"></a><span class="lineno">10355</span>&#160;         }</div><div class="line"><a name="l10356"></a><span class="lineno">10356</span>&#160;      }</div><div class="line"><a name="l10357"></a><span class="lineno">10357</span>&#160;   }</div><div class="line"><a name="l10358"></a><span class="lineno">10358</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10359"></a><span class="lineno">10359</span>&#160;}</div><div class="line"><a name="l10360"></a><span class="lineno">10360</span>&#160;</div><div class="line"><a name="l10361"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">10361</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">vm_intro</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms)</div><div class="line"><a name="l10362"></a><span class="lineno">10362</span>&#160;{</div><div class="line"><a name="l10363"></a><span class="lineno">10363</span>&#160;   <span class="keywordtype">char</span> prefile[256];</div><div class="line"><a name="l10364"></a><span class="lineno">10364</span>&#160;</div><div class="line"><a name="l10365"></a><span class="lineno">10365</span>&#160;   <span class="comment">/* Notify the user that the temp greeting is set and give them the option to remove it */</span></div><div class="line"><a name="l10366"></a><span class="lineno">10366</span>&#160;   snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10367"></a><span class="lineno">10367</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>)) {</div><div class="line"><a name="l10368"></a><span class="lineno">10368</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l10369"></a><span class="lineno">10369</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l10370"></a><span class="lineno">10370</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tempgreetactive&quot;</span>);</div><div class="line"><a name="l10371"></a><span class="lineno">10371</span>&#160;      }</div><div class="line"><a name="l10372"></a><span class="lineno">10372</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);</div><div class="line"><a name="l10373"></a><span class="lineno">10373</span>&#160;   }</div><div class="line"><a name="l10374"></a><span class="lineno">10374</span>&#160;</div><div class="line"><a name="l10375"></a><span class="lineno">10375</span>&#160;   <span class="comment">/* Play voicemail intro - syntax is different for different languages */</span></div><div class="line"><a name="l10376"></a><span class="lineno">10376</span>&#160;   <span class="keywordflow">if</span> (0) {</div><div class="line"><a name="l10377"></a><span class="lineno">10377</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l10378"></a><span class="lineno">10378</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;cs&quot;</span>, 2)) {  <span class="comment">/* CZECH syntax */</span></div><div class="line"><a name="l10379"></a><span class="lineno">10379</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a>(chan, vms);</div><div class="line"><a name="l10380"></a><span class="lineno">10380</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;cz&quot;</span>, 2)) {  <span class="comment">/* deprecated CZECH syntax */</span></div><div class="line"><a name="l10381"></a><span class="lineno">10381</span>&#160;      <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;</div><div class="line"><a name="l10382"></a><span class="lineno">10382</span>&#160;      <span class="keywordflow">if</span> (deprecation_warning++ % 10 == 0) {</div><div class="line"><a name="l10383"></a><span class="lineno">10383</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;cz is not a standard language code.  Please switch to using cs instead.\n&quot;</span>);</div><div class="line"><a name="l10384"></a><span class="lineno">10384</span>&#160;      }</div><div class="line"><a name="l10385"></a><span class="lineno">10385</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a>(chan, vms);</div><div class="line"><a name="l10386"></a><span class="lineno">10386</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;de&quot;</span>, 2)) {  <span class="comment">/* GERMAN syntax */</span></div><div class="line"><a name="l10387"></a><span class="lineno">10387</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a">vm_intro_de</a>(chan, vms);</div><div class="line"><a name="l10388"></a><span class="lineno">10388</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;es&quot;</span>, 2)) {  <span class="comment">/* SPANISH syntax */</span></div><div class="line"><a name="l10389"></a><span class="lineno">10389</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae">vm_intro_es</a>(chan, vms);</div><div class="line"><a name="l10390"></a><span class="lineno">10390</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;fr&quot;</span>, 2)) {  <span class="comment">/* FRENCH syntax */</span></div><div class="line"><a name="l10391"></a><span class="lineno">10391</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">vm_intro_fr</a>(chan, vms);</div><div class="line"><a name="l10392"></a><span class="lineno">10392</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;gr&quot;</span>, 2)) {  <span class="comment">/* GREEK syntax */</span></div><div class="line"><a name="l10393"></a><span class="lineno">10393</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c">vm_intro_gr</a>(chan, vms);</div><div class="line"><a name="l10394"></a><span class="lineno">10394</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;he&quot;</span>, 2)) {  <span class="comment">/* HEBREW syntax */</span></div><div class="line"><a name="l10395"></a><span class="lineno">10395</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c">vm_intro_he</a>(chan, vms);</div><div class="line"><a name="l10396"></a><span class="lineno">10396</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;is&quot;</span>, 2)) {  <span class="comment">/* ICELANDIC syntax */</span></div><div class="line"><a name="l10397"></a><span class="lineno">10397</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#acc1a27de6051bbf777a3770d49305c1b">vm_intro_is</a>(chan, vms);</div><div class="line"><a name="l10398"></a><span class="lineno">10398</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;it&quot;</span>, 2)) {  <span class="comment">/* ITALIAN syntax */</span></div><div class="line"><a name="l10399"></a><span class="lineno">10399</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c">vm_intro_it</a>(chan, vms);</div><div class="line"><a name="l10400"></a><span class="lineno">10400</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ja&quot;</span>, 2)) {  <span class="comment">/* JAPANESE syntax */</span></div><div class="line"><a name="l10401"></a><span class="lineno">10401</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae55c18b0e0a94a34580e1ac4edf96c04">vm_intro_ja</a>(chan, vms);</div><div class="line"><a name="l10402"></a><span class="lineno">10402</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;nl&quot;</span>, 2)) {  <span class="comment">/* DUTCH syntax */</span></div><div class="line"><a name="l10403"></a><span class="lineno">10403</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">vm_intro_nl</a>(chan, vms);</div><div class="line"><a name="l10404"></a><span class="lineno">10404</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;no&quot;</span>, 2)) {  <span class="comment">/* NORWEGIAN syntax */</span></div><div class="line"><a name="l10405"></a><span class="lineno">10405</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8">vm_intro_no</a>(chan, vms);</div><div class="line"><a name="l10406"></a><span class="lineno">10406</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pl&quot;</span>, 2)) {  <span class="comment">/* POLISH syntax */</span></div><div class="line"><a name="l10407"></a><span class="lineno">10407</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7">vm_intro_pl</a>(chan, vms);</div><div class="line"><a name="l10408"></a><span class="lineno">10408</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pt_BR&quot;</span>, 5)) {  <span class="comment">/* BRAZILIAN PORTUGUESE syntax */</span></div><div class="line"><a name="l10409"></a><span class="lineno">10409</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">vm_intro_pt_BR</a>(chan, vms);</div><div class="line"><a name="l10410"></a><span class="lineno">10410</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pt&quot;</span>, 2)) {  <span class="comment">/* PORTUGUESE syntax */</span></div><div class="line"><a name="l10411"></a><span class="lineno">10411</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">vm_intro_pt</a>(chan, vms);</div><div class="line"><a name="l10412"></a><span class="lineno">10412</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ru&quot;</span>, 2)) {  <span class="comment">/* RUSSIAN syntax */</span></div><div class="line"><a name="l10413"></a><span class="lineno">10413</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a>(chan, vms, <span class="stringliteral">&quot;n&quot;</span>);</div><div class="line"><a name="l10414"></a><span class="lineno">10414</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;se&quot;</span>, 2)) {  <span class="comment">/* SWEDISH syntax */</span></div><div class="line"><a name="l10415"></a><span class="lineno">10415</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af54b6b5388c2838875f222a795850409">vm_intro_se</a>(chan, vms);</div><div class="line"><a name="l10416"></a><span class="lineno">10416</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ua&quot;</span>, 2)) {  <span class="comment">/* UKRAINIAN syntax */</span></div><div class="line"><a name="l10417"></a><span class="lineno">10417</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a>(chan, vms, <span class="stringliteral">&quot;n&quot;</span>);</div><div class="line"><a name="l10418"></a><span class="lineno">10418</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;vi&quot;</span>, 2)) { <span class="comment">/* VIETNAMESE syntax */</span></div><div class="line"><a name="l10419"></a><span class="lineno">10419</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6b932796ecb15a8350a4bf3f9429045a">vm_intro_vi</a>(chan, vms);</div><div class="line"><a name="l10420"></a><span class="lineno">10420</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;zh&quot;</span>, 2)) { <span class="comment">/* CHINESE (Taiwan) syntax */</span></div><div class="line"><a name="l10421"></a><span class="lineno">10421</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">vm_intro_zh</a>(chan, vms);</div><div class="line"><a name="l10422"></a><span class="lineno">10422</span>&#160;   } <span class="keywordflow">else</span> {                                             <span class="comment">/* Default to ENGLISH */</span></div><div class="line"><a name="l10423"></a><span class="lineno">10423</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f">vm_intro_en</a>(chan, vms);</div><div class="line"><a name="l10424"></a><span class="lineno">10424</span>&#160;   }</div><div class="line"><a name="l10425"></a><span class="lineno">10425</span>&#160;}</div><div class="line"><a name="l10426"></a><span class="lineno">10426</span>&#160;</div><div class="line"><a name="l10427"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">10427</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)</div><div class="line"><a name="l10428"></a><span class="lineno">10428</span>&#160;{</div><div class="line"><a name="l10429"></a><span class="lineno">10429</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l10430"></a><span class="lineno">10430</span>&#160;   <span class="comment">/* Play instructions and wait for new command */</span></div><div class="line"><a name="l10431"></a><span class="lineno">10431</span>&#160;   <span class="keywordflow">while</span> (!res) {</div><div class="line"><a name="l10432"></a><span class="lineno">10432</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l10433"></a><span class="lineno">10433</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l10434"></a><span class="lineno">10434</span>&#160;            <span class="keywordflow">if</span> (skipadvanced)</div><div class="line"><a name="l10435"></a><span class="lineno">10435</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor-full&quot;</span>);</div><div class="line"><a name="l10436"></a><span class="lineno">10436</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10437"></a><span class="lineno">10437</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor&quot;</span>);</div><div class="line"><a name="l10438"></a><span class="lineno">10438</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10439"></a><span class="lineno">10439</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l10440"></a><span class="lineno">10440</span>&#160;         }</div><div class="line"><a name="l10441"></a><span class="lineno">10441</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10442"></a><span class="lineno">10442</span>&#160;            <span class="keywordflow">if</span> (skipadvanced)</div><div class="line"><a name="l10443"></a><span class="lineno">10443</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts-full&quot;</span>);</div><div class="line"><a name="l10444"></a><span class="lineno">10444</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l10445"></a><span class="lineno">10445</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);</div><div class="line"><a name="l10446"></a><span class="lineno">10446</span>&#160;         }</div><div class="line"><a name="l10447"></a><span class="lineno">10447</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10448"></a><span class="lineno">10448</span>&#160;         <span class="comment">/* Added for additional help */</span></div><div class="line"><a name="l10449"></a><span class="lineno">10449</span>&#160;         <span class="keywordflow">if</span> (skipadvanced) {</div><div class="line"><a name="l10450"></a><span class="lineno">10450</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor-full&quot;</span>);</div><div class="line"><a name="l10451"></a><span class="lineno">10451</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10452"></a><span class="lineno">10452</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l10453"></a><span class="lineno">10453</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts-full&quot;</span>);</div><div class="line"><a name="l10454"></a><span class="lineno">10454</span>&#160;         }</div><div class="line"><a name="l10455"></a><span class="lineno">10455</span>&#160;         <span class="comment">/* Logic:</span></div><div class="line"><a name="l10456"></a><span class="lineno">10456</span>&#160;<span class="comment">          * If the current message is not the first OR</span></div><div class="line"><a name="l10457"></a><span class="lineno">10457</span>&#160;<span class="comment">          * if we&#39;re listening to the first new message and there are</span></div><div class="line"><a name="l10458"></a><span class="lineno">10458</span>&#160;<span class="comment">          * also urgent messages, then prompt for navigation to the</span></div><div class="line"><a name="l10459"></a><span class="lineno">10459</span>&#160;<span class="comment">          * previous message</span></div><div class="line"><a name="l10460"></a><span class="lineno">10460</span>&#160;<span class="comment">          */</span></div><div class="line"><a name="l10461"></a><span class="lineno">10461</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> || (!in_urgent &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &gt; 0) || (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0)) {</div><div class="line"><a name="l10462"></a><span class="lineno">10462</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-prev&quot;</span>);</div><div class="line"><a name="l10463"></a><span class="lineno">10463</span>&#160;         }</div><div class="line"><a name="l10464"></a><span class="lineno">10464</span>&#160;         <span class="keywordflow">if</span> (!res &amp;&amp; !skipadvanced)</div><div class="line"><a name="l10465"></a><span class="lineno">10465</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-advopts&quot;</span>);</div><div class="line"><a name="l10466"></a><span class="lineno">10466</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10467"></a><span class="lineno">10467</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-repeat&quot;</span>);</div><div class="line"><a name="l10468"></a><span class="lineno">10468</span>&#160;         <span class="comment">/* Logic:</span></div><div class="line"><a name="l10469"></a><span class="lineno">10469</span>&#160;<span class="comment">          * If we&#39;re not listening to the last message OR</span></div><div class="line"><a name="l10470"></a><span class="lineno">10470</span>&#160;<span class="comment">          * we&#39;re listening to the last urgent message and there are</span></div><div class="line"><a name="l10471"></a><span class="lineno">10471</span>&#160;<span class="comment">          * also new non-urgent messages, then prompt for navigation</span></div><div class="line"><a name="l10472"></a><span class="lineno">10472</span>&#160;<span class="comment">          * to the next message</span></div><div class="line"><a name="l10473"></a><span class="lineno">10473</span>&#160;<span class="comment">          */</span></div><div class="line"><a name="l10474"></a><span class="lineno">10474</span>&#160;         <span class="keywordflow">if</span> (!res &amp;&amp; ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) || (in_urgent &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) ||</div><div class="line"><a name="l10475"></a><span class="lineno">10475</span>&#160;            (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) )) {</div><div class="line"><a name="l10476"></a><span class="lineno">10476</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-next&quot;</span>);</div><div class="line"><a name="l10477"></a><span class="lineno">10477</span>&#160;         }</div><div class="line"><a name="l10478"></a><span class="lineno">10478</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10479"></a><span class="lineno">10479</span>&#160;            <span class="keywordtype">int</span> curmsg_deleted;</div><div class="line"><a name="l10480"></a><span class="lineno">10480</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l10481"></a><span class="lineno">10481</span>&#160;            <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l10482"></a><span class="lineno">10482</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l10483"></a><span class="lineno">10483</span>&#160;            curmsg_deleted = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>];</div><div class="line"><a name="l10484"></a><span class="lineno">10484</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l10485"></a><span class="lineno">10485</span>&#160;            <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l10486"></a><span class="lineno">10486</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l10487"></a><span class="lineno">10487</span>&#160;            <span class="keywordflow">if</span> (!curmsg_deleted) {</div><div class="line"><a name="l10488"></a><span class="lineno">10488</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-delete&quot;</span>);</div><div class="line"><a name="l10489"></a><span class="lineno">10489</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10490"></a><span class="lineno">10490</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-undelete&quot;</span>);</div><div class="line"><a name="l10491"></a><span class="lineno">10491</span>&#160;            }</div><div class="line"><a name="l10492"></a><span class="lineno">10492</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10493"></a><span class="lineno">10493</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toforward&quot;</span>);</div><div class="line"><a name="l10494"></a><span class="lineno">10494</span>&#160;            }</div><div class="line"><a name="l10495"></a><span class="lineno">10495</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10496"></a><span class="lineno">10496</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-savemessage&quot;</span>);</div><div class="line"><a name="l10497"></a><span class="lineno">10497</span>&#160;            }</div><div class="line"><a name="l10498"></a><span class="lineno">10498</span>&#160;         }</div><div class="line"><a name="l10499"></a><span class="lineno">10499</span>&#160;      }</div><div class="line"><a name="l10500"></a><span class="lineno">10500</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10501"></a><span class="lineno">10501</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-helpexit&quot;</span>);</div><div class="line"><a name="l10502"></a><span class="lineno">10502</span>&#160;      }</div><div class="line"><a name="l10503"></a><span class="lineno">10503</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10504"></a><span class="lineno">10504</span>&#160;         res = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l10505"></a><span class="lineno">10505</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10506"></a><span class="lineno">10506</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a>++;</div><div class="line"><a name="l10507"></a><span class="lineno">10507</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> &gt; 2) {</div><div class="line"><a name="l10508"></a><span class="lineno">10508</span>&#160;            res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10509"></a><span class="lineno">10509</span>&#160;         }</div><div class="line"><a name="l10510"></a><span class="lineno">10510</span>&#160;      }</div><div class="line"><a name="l10511"></a><span class="lineno">10511</span>&#160;   }</div><div class="line"><a name="l10512"></a><span class="lineno">10512</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10513"></a><span class="lineno">10513</span>&#160;}</div><div class="line"><a name="l10514"></a><span class="lineno">10514</span>&#160;</div><div class="line"><a name="l10515"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a75f701e2fe322710cb7110c5f349b46b">10515</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a75f701e2fe322710cb7110c5f349b46b">vm_instructions_ja</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms,  <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)</div><div class="line"><a name="l10516"></a><span class="lineno">10516</span>&#160;{</div><div class="line"><a name="l10517"></a><span class="lineno">10517</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l10518"></a><span class="lineno">10518</span>&#160;   <span class="comment">/* Play instructions and wait for new command */</span></div><div class="line"><a name="l10519"></a><span class="lineno">10519</span>&#160;   <span class="keywordflow">while</span> (!res) {</div><div class="line"><a name="l10520"></a><span class="lineno">10520</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l10521"></a><span class="lineno">10521</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l10522"></a><span class="lineno">10522</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l10523"></a><span class="lineno">10523</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10524"></a><span class="lineno">10524</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wa&quot;</span>);</div><div class="line"><a name="l10525"></a><span class="lineno">10525</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10526"></a><span class="lineno">10526</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);</div><div class="line"><a name="l10527"></a><span class="lineno">10527</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10528"></a><span class="lineno">10528</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wo&quot;</span>);</div><div class="line"><a name="l10529"></a><span class="lineno">10529</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10530"></a><span class="lineno">10530</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;silence/1&quot;</span>);</div><div class="line"><a name="l10531"></a><span class="lineno">10531</span>&#160;         }</div><div class="line"><a name="l10532"></a><span class="lineno">10532</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10533"></a><span class="lineno">10533</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);</div><div class="line"><a name="l10534"></a><span class="lineno">10534</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10535"></a><span class="lineno">10535</span>&#160;         <span class="comment">/* Added for additional help */</span></div><div class="line"><a name="l10536"></a><span class="lineno">10536</span>&#160;         <span class="keywordflow">if</span> (skipadvanced) {</div><div class="line"><a name="l10537"></a><span class="lineno">10537</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l10538"></a><span class="lineno">10538</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10539"></a><span class="lineno">10539</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wa&quot;</span>);</div><div class="line"><a name="l10540"></a><span class="lineno">10540</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10541"></a><span class="lineno">10541</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);</div><div class="line"><a name="l10542"></a><span class="lineno">10542</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10543"></a><span class="lineno">10543</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wo&quot;</span>);</div><div class="line"><a name="l10544"></a><span class="lineno">10544</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10545"></a><span class="lineno">10545</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;silence/1&quot;</span>);</div><div class="line"><a name="l10546"></a><span class="lineno">10546</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts-full&quot;</span>);</div><div class="line"><a name="l10547"></a><span class="lineno">10547</span>&#160;         }</div><div class="line"><a name="l10548"></a><span class="lineno">10548</span>&#160;         <span class="comment">/* Logic:</span></div><div class="line"><a name="l10549"></a><span class="lineno">10549</span>&#160;<span class="comment">          * If the current message is not the first OR</span></div><div class="line"><a name="l10550"></a><span class="lineno">10550</span>&#160;<span class="comment">          * if we&#39;re listening to the first new message and there are</span></div><div class="line"><a name="l10551"></a><span class="lineno">10551</span>&#160;<span class="comment">          * also urgent messages, then prompt for navigation to the</span></div><div class="line"><a name="l10552"></a><span class="lineno">10552</span>&#160;<span class="comment">          * previous message</span></div><div class="line"><a name="l10553"></a><span class="lineno">10553</span>&#160;<span class="comment">          */</span></div><div class="line"><a name="l10554"></a><span class="lineno">10554</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> || (!in_urgent &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &gt; 0) || (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0)) {</div><div class="line"><a name="l10555"></a><span class="lineno">10555</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-prev&quot;</span>);</div><div class="line"><a name="l10556"></a><span class="lineno">10556</span>&#160;         }</div><div class="line"><a name="l10557"></a><span class="lineno">10557</span>&#160;         <span class="keywordflow">if</span> (!res &amp;&amp; !skipadvanced)</div><div class="line"><a name="l10558"></a><span class="lineno">10558</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-advopts&quot;</span>);</div><div class="line"><a name="l10559"></a><span class="lineno">10559</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10560"></a><span class="lineno">10560</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-repeat&quot;</span>);</div><div class="line"><a name="l10561"></a><span class="lineno">10561</span>&#160;         <span class="comment">/* Logic:</span></div><div class="line"><a name="l10562"></a><span class="lineno">10562</span>&#160;<span class="comment">          * If we&#39;re not listening to the last message OR</span></div><div class="line"><a name="l10563"></a><span class="lineno">10563</span>&#160;<span class="comment">          * we&#39;re listening to the last urgent message and there are</span></div><div class="line"><a name="l10564"></a><span class="lineno">10564</span>&#160;<span class="comment">          * also new non-urgent messages, then prompt for navigation</span></div><div class="line"><a name="l10565"></a><span class="lineno">10565</span>&#160;<span class="comment">          * to the next message</span></div><div class="line"><a name="l10566"></a><span class="lineno">10566</span>&#160;<span class="comment">          */</span></div><div class="line"><a name="l10567"></a><span class="lineno">10567</span>&#160;         <span class="keywordflow">if</span> (!res &amp;&amp; ((vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) || (in_urgent &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) ||</div><div class="line"><a name="l10568"></a><span class="lineno">10568</span>&#160;            (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) )) {</div><div class="line"><a name="l10569"></a><span class="lineno">10569</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-next&quot;</span>);</div><div class="line"><a name="l10570"></a><span class="lineno">10570</span>&#160;         }</div><div class="line"><a name="l10571"></a><span class="lineno">10571</span>&#160;         <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10572"></a><span class="lineno">10572</span>&#160;            <span class="keywordtype">int</span> curmsg_deleted;</div><div class="line"><a name="l10573"></a><span class="lineno">10573</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l10574"></a><span class="lineno">10574</span>&#160;            <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l10575"></a><span class="lineno">10575</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l10576"></a><span class="lineno">10576</span>&#160;            curmsg_deleted = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>];</div><div class="line"><a name="l10577"></a><span class="lineno">10577</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l10578"></a><span class="lineno">10578</span>&#160;            <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l10579"></a><span class="lineno">10579</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l10580"></a><span class="lineno">10580</span>&#160;            <span class="keywordflow">if</span> (!curmsg_deleted) {</div><div class="line"><a name="l10581"></a><span class="lineno">10581</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-delete&quot;</span>);</div><div class="line"><a name="l10582"></a><span class="lineno">10582</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10583"></a><span class="lineno">10583</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-undelete&quot;</span>);</div><div class="line"><a name="l10584"></a><span class="lineno">10584</span>&#160;            }</div><div class="line"><a name="l10585"></a><span class="lineno">10585</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10586"></a><span class="lineno">10586</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toforward&quot;</span>);</div><div class="line"><a name="l10587"></a><span class="lineno">10587</span>&#160;            }</div><div class="line"><a name="l10588"></a><span class="lineno">10588</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10589"></a><span class="lineno">10589</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-savemessage&quot;</span>);</div><div class="line"><a name="l10590"></a><span class="lineno">10590</span>&#160;            }</div><div class="line"><a name="l10591"></a><span class="lineno">10591</span>&#160;         }</div><div class="line"><a name="l10592"></a><span class="lineno">10592</span>&#160;      }</div><div class="line"><a name="l10593"></a><span class="lineno">10593</span>&#160;</div><div class="line"><a name="l10594"></a><span class="lineno">10594</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10595"></a><span class="lineno">10595</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-helpexit&quot;</span>);</div><div class="line"><a name="l10596"></a><span class="lineno">10596</span>&#160;      }</div><div class="line"><a name="l10597"></a><span class="lineno">10597</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10598"></a><span class="lineno">10598</span>&#160;         res = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l10599"></a><span class="lineno">10599</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10600"></a><span class="lineno">10600</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a>++;</div><div class="line"><a name="l10601"></a><span class="lineno">10601</span>&#160;         <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> &gt; 2) {</div><div class="line"><a name="l10602"></a><span class="lineno">10602</span>&#160;            res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10603"></a><span class="lineno">10603</span>&#160;         }</div><div class="line"><a name="l10604"></a><span class="lineno">10604</span>&#160;      }</div><div class="line"><a name="l10605"></a><span class="lineno">10605</span>&#160;</div><div class="line"><a name="l10606"></a><span class="lineno">10606</span>&#160;   }</div><div class="line"><a name="l10607"></a><span class="lineno">10607</span>&#160;</div><div class="line"><a name="l10608"></a><span class="lineno">10608</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10609"></a><span class="lineno">10609</span>&#160;}</div><div class="line"><a name="l10610"></a><span class="lineno">10610</span>&#160;</div><div class="line"><a name="l10611"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">10611</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">vm_instructions_zh</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms,  <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)</div><div class="line"><a name="l10612"></a><span class="lineno">10612</span>&#160;{</div><div class="line"><a name="l10613"></a><span class="lineno">10613</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l10614"></a><span class="lineno">10614</span>&#160;   <span class="comment">/* Play instructions and wait for new command */</span></div><div class="line"><a name="l10615"></a><span class="lineno">10615</span>&#160;   <span class="keywordflow">while</span> (!res) {</div><div class="line"><a name="l10616"></a><span class="lineno">10616</span>&#160;      <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l10617"></a><span class="lineno">10617</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-listen&quot;</span>);</div><div class="line"><a name="l10618"></a><span class="lineno">10618</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10619"></a><span class="lineno">10619</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l10620"></a><span class="lineno">10620</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10621"></a><span class="lineno">10621</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;press&quot;</span>);</div><div class="line"><a name="l10622"></a><span class="lineno">10622</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10623"></a><span class="lineno">10623</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);</div><div class="line"><a name="l10624"></a><span class="lineno">10624</span>&#160;      }</div><div class="line"><a name="l10625"></a><span class="lineno">10625</span>&#160;      <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l10626"></a><span class="lineno">10626</span>&#160;         res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);</div><div class="line"><a name="l10627"></a><span class="lineno">10627</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l10628"></a><span class="lineno">10628</span>&#160;         vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 0;</div><div class="line"><a name="l10629"></a><span class="lineno">10629</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a>(chan, vmu, vms, skipadvanced, in_urgent);</div><div class="line"><a name="l10630"></a><span class="lineno">10630</span>&#160;      }</div><div class="line"><a name="l10631"></a><span class="lineno">10631</span>&#160;   }</div><div class="line"><a name="l10632"></a><span class="lineno">10632</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l10633"></a><span class="lineno">10633</span>&#160;}</div><div class="line"><a name="l10634"></a><span class="lineno">10634</span>&#160;</div><div class="line"><a name="l10635"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">10635</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)</div><div class="line"><a name="l10636"></a><span class="lineno">10636</span>&#160;{</div><div class="line"><a name="l10637"></a><span class="lineno">10637</span>&#160;   <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ja&quot;</span>, 2)) { <span class="comment">/* Japanese syntax */</span></div><div class="line"><a name="l10638"></a><span class="lineno">10638</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a75f701e2fe322710cb7110c5f349b46b">vm_instructions_ja</a>(chan, vmu, vms, skipadvanced, in_urgent);</div><div class="line"><a name="l10639"></a><span class="lineno">10639</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> &amp;&amp; !strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;zh&quot;</span>, 2)) { <span class="comment">/* CHINESE (Taiwan) syntax */</span></div><div class="line"><a name="l10640"></a><span class="lineno">10640</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">vm_instructions_zh</a>(chan, vmu, vms, skipadvanced, in_urgent);</div><div class="line"><a name="l10641"></a><span class="lineno">10641</span>&#160;   } <span class="keywordflow">else</span> {             <span class="comment">/* Default to ENGLISH */</span></div><div class="line"><a name="l10642"></a><span class="lineno">10642</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a>(chan, vmu, vms, skipadvanced, in_urgent);</div><div class="line"><a name="l10643"></a><span class="lineno">10643</span>&#160;   }</div><div class="line"><a name="l10644"></a><span class="lineno">10644</span>&#160;}</div><div class="line"><a name="l10645"></a><span class="lineno">10645</span>&#160;</div><div class="line"><a name="l10646"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5e97aad653c098e2ccb57d624fb7f373">10646</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e97aad653c098e2ccb57d624fb7f373">vm_newuser_setup</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)</div><div class="line"><a name="l10647"></a><span class="lineno">10647</span>&#160;{</div><div class="line"><a name="l10648"></a><span class="lineno">10648</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l10649"></a><span class="lineno">10649</span>&#160;   <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l10650"></a><span class="lineno">10650</span>&#160;   <span class="keywordtype">int</span> tries = 0;</div><div class="line"><a name="l10651"></a><span class="lineno">10651</span>&#160;   <span class="keywordtype">char</span> newpassword[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10652"></a><span class="lineno">10652</span>&#160;   <span class="keywordtype">char</span> newpassword2[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10653"></a><span class="lineno">10653</span>&#160;   <span class="keywordtype">char</span> prefile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10654"></a><span class="lineno">10654</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l10655"></a><span class="lineno">10655</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l10656"></a><span class="lineno">10656</span>&#160;</div><div class="line"><a name="l10657"></a><span class="lineno">10657</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;NEWUSER&quot;</span>, <span class="stringliteral">&quot;Message: entering new user state&quot;</span>);</div><div class="line"><a name="l10658"></a><span class="lineno">10658</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan)) {</div><div class="line"><a name="l10659"></a><span class="lineno">10659</span>&#160;      bytes += <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);</div><div class="line"><a name="l10660"></a><span class="lineno">10660</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;New User Setup&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l10661"></a><span class="lineno">10661</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Not Done&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l10662"></a><span class="lineno">10662</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l10663"></a><span class="lineno">10663</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l10664"></a><span class="lineno">10664</span>&#160;      <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l10665"></a><span class="lineno">10665</span>&#160;   }</div><div class="line"><a name="l10666"></a><span class="lineno">10666</span>&#160;</div><div class="line"><a name="l10667"></a><span class="lineno">10667</span>&#160;   <span class="comment">/* If forcename is set, have the user record their name */</span></div><div class="line"><a name="l10668"></a><span class="lineno">10668</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>)) {</div><div class="line"><a name="l10669"></a><span class="lineno">10669</span>&#160;      snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10670"></a><span class="lineno">10670</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &lt; 1) {</div><div class="line"><a name="l10671"></a><span class="lineno">10671</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-name&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10672"></a><span class="lineno">10672</span>&#160;         <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10673"></a><span class="lineno">10673</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10674"></a><span class="lineno">10674</span>&#160;      }</div><div class="line"><a name="l10675"></a><span class="lineno">10675</span>&#160;   }</div><div class="line"><a name="l10676"></a><span class="lineno">10676</span>&#160;</div><div class="line"><a name="l10677"></a><span class="lineno">10677</span>&#160;   <span class="comment">/* If forcegreetings is set, have the user record their greetings */</span></div><div class="line"><a name="l10678"></a><span class="lineno">10678</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>)) {</div><div class="line"><a name="l10679"></a><span class="lineno">10679</span>&#160;      snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/unavail&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10680"></a><span class="lineno">10680</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &lt; 1) {</div><div class="line"><a name="l10681"></a><span class="lineno">10681</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-unv&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10682"></a><span class="lineno">10682</span>&#160;         <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10683"></a><span class="lineno">10683</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10684"></a><span class="lineno">10684</span>&#160;      }</div><div class="line"><a name="l10685"></a><span class="lineno">10685</span>&#160;</div><div class="line"><a name="l10686"></a><span class="lineno">10686</span>&#160;      snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/busy&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10687"></a><span class="lineno">10687</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &lt; 1) {</div><div class="line"><a name="l10688"></a><span class="lineno">10688</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-busy&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10689"></a><span class="lineno">10689</span>&#160;         <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10690"></a><span class="lineno">10690</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10691"></a><span class="lineno">10691</span>&#160;      }</div><div class="line"><a name="l10692"></a><span class="lineno">10692</span>&#160;   }</div><div class="line"><a name="l10693"></a><span class="lineno">10693</span>&#160;</div><div class="line"><a name="l10694"></a><span class="lineno">10694</span>&#160;   <span class="comment">/*</span></div><div class="line"><a name="l10695"></a><span class="lineno">10695</span>&#160;<span class="comment">    * Change the password last since new users will be able to skip over any steps this one comes before</span></div><div class="line"><a name="l10696"></a><span class="lineno">10696</span>&#160;<span class="comment">    * by hanging up and calling back to voicemail main since the password is used to verify new user status.</span></div><div class="line"><a name="l10697"></a><span class="lineno">10697</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l10698"></a><span class="lineno">10698</span>&#160;   <span class="keywordflow">for</span> (;;) {</div><div class="line"><a name="l10699"></a><span class="lineno">10699</span>&#160;      newpassword[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10700"></a><span class="lineno">10700</span>&#160;      newpassword[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_newpassword);</div><div class="line"><a name="l10701"></a><span class="lineno">10701</span>&#160;      <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10702"></a><span class="lineno">10702</span>&#160;         newpassword[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10703"></a><span class="lineno">10703</span>&#160;      <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10704"></a><span class="lineno">10704</span>&#160;         <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10705"></a><span class="lineno">10705</span>&#160;      cmd = <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, newpassword + strlen(newpassword), <span class="keyword">sizeof</span>(newpassword) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>);</div><div class="line"><a name="l10706"></a><span class="lineno">10706</span>&#160;      <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10707"></a><span class="lineno">10707</span>&#160;         <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10708"></a><span class="lineno">10708</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc">check_password</a>(vmu, newpassword); <span class="comment">/* perform password validation */</span></div><div class="line"><a name="l10709"></a><span class="lineno">10709</span>&#160;      <span class="keywordflow">if</span> (cmd != 0) {</div><div class="line"><a name="l10710"></a><span class="lineno">10710</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid password for user %s (%s)\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword);</div><div class="line"><a name="l10711"></a><span class="lineno">10711</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_invalid_password);</div><div class="line"><a name="l10712"></a><span class="lineno">10712</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10713"></a><span class="lineno">10713</span>&#160;         newpassword2[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10714"></a><span class="lineno">10714</span>&#160;         newpassword2[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_reenterpassword);</div><div class="line"><a name="l10715"></a><span class="lineno">10715</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10716"></a><span class="lineno">10716</span>&#160;            newpassword2[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10717"></a><span class="lineno">10717</span>&#160;         <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10718"></a><span class="lineno">10718</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10719"></a><span class="lineno">10719</span>&#160;         cmd = <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, newpassword2 + strlen(newpassword2), <span class="keyword">sizeof</span>(newpassword2) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>);</div><div class="line"><a name="l10720"></a><span class="lineno">10720</span>&#160;         <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&#39;t&#39;</span> || cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10721"></a><span class="lineno">10721</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10722"></a><span class="lineno">10722</span>&#160;         <span class="keywordflow">if</span> (!strcmp(newpassword, newpassword2))</div><div class="line"><a name="l10723"></a><span class="lineno">10723</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10724"></a><span class="lineno">10724</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Password mismatch for user %s (%s != %s)\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword, newpassword2);</div><div class="line"><a name="l10725"></a><span class="lineno">10725</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_mismatch);</div><div class="line"><a name="l10726"></a><span class="lineno">10726</span>&#160;      }</div><div class="line"><a name="l10727"></a><span class="lineno">10727</span>&#160;      <span class="keywordflow">if</span> (++tries == 3)</div><div class="line"><a name="l10728"></a><span class="lineno">10728</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l10729"></a><span class="lineno">10729</span>&#160;      <span class="keywordflow">if</span> (cmd != 0) {</div><div class="line"><a name="l10730"></a><span class="lineno">10730</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_pls_try_again);</div><div class="line"><a name="l10731"></a><span class="lineno">10731</span>&#160;      }</div><div class="line"><a name="l10732"></a><span class="lineno">10732</span>&#160;   }</div><div class="line"><a name="l10733"></a><span class="lineno">10733</span>&#160;   <span class="keywordflow">if</span> (pwdchange &amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>)</div><div class="line"><a name="l10734"></a><span class="lineno">10734</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a778f09605f89f85529e369351472b174">vm_change_password</a>(vmu, newpassword);</div><div class="line"><a name="l10735"></a><span class="lineno">10735</span>&#160;   <span class="keywordflow">if</span> ((pwdchange &amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a>) &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(ext_pass_cmd))</div><div class="line"><a name="l10736"></a><span class="lineno">10736</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a>(vmu, newpassword);</div><div class="line"><a name="l10737"></a><span class="lineno">10737</span>&#160;</div><div class="line"><a name="l10738"></a><span class="lineno">10738</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;User %s set password to %s of length %d\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword, (<span class="keywordtype">int</span>) strlen(newpassword));</div><div class="line"><a name="l10739"></a><span class="lineno">10739</span>&#160;   cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_passchanged);</div><div class="line"><a name="l10740"></a><span class="lineno">10740</span>&#160;</div><div class="line"><a name="l10741"></a><span class="lineno">10741</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10742"></a><span class="lineno">10742</span>&#160;}</div><div class="line"><a name="l10743"></a><span class="lineno">10743</span>&#160;</div><div class="line"><a name="l10744"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">10744</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">vm_options</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)</div><div class="line"><a name="l10745"></a><span class="lineno">10745</span>&#160;{</div><div class="line"><a name="l10746"></a><span class="lineno">10746</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l10747"></a><span class="lineno">10747</span>&#160;   <span class="keywordtype">int</span> retries = 0;</div><div class="line"><a name="l10748"></a><span class="lineno">10748</span>&#160;   <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l10749"></a><span class="lineno">10749</span>&#160;   <span class="keywordtype">char</span> newpassword[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10750"></a><span class="lineno">10750</span>&#160;   <span class="keywordtype">char</span> newpassword2[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10751"></a><span class="lineno">10751</span>&#160;   <span class="keywordtype">char</span> prefile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10752"></a><span class="lineno">10752</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l10753"></a><span class="lineno">10753</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l10754"></a><span class="lineno">10754</span>&#160;</div><div class="line"><a name="l10755"></a><span class="lineno">10755</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;VMOPTIONS&quot;</span>, <span class="stringliteral">&quot;Message: entering mailbox options&quot;</span>);</div><div class="line"><a name="l10756"></a><span class="lineno">10756</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan)) {</div><div class="line"><a name="l10757"></a><span class="lineno">10757</span>&#160;      bytes += <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);</div><div class="line"><a name="l10758"></a><span class="lineno">10758</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Options Menu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l10759"></a><span class="lineno">10759</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Not Done&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l10760"></a><span class="lineno">10760</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l10761"></a><span class="lineno">10761</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l10762"></a><span class="lineno">10762</span>&#160;      <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l10763"></a><span class="lineno">10763</span>&#160;   }</div><div class="line"><a name="l10764"></a><span class="lineno">10764</span>&#160;   <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>)) {</div><div class="line"><a name="l10765"></a><span class="lineno">10765</span>&#160;      <span class="keywordflow">if</span> (cmd)</div><div class="line"><a name="l10766"></a><span class="lineno">10766</span>&#160;         retries = 0;</div><div class="line"><a name="l10767"></a><span class="lineno">10767</span>&#160;      <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l10768"></a><span class="lineno">10768</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>: <span class="comment">/* Record your unavailable message */</span></div><div class="line"><a name="l10769"></a><span class="lineno">10769</span>&#160;         snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/unavail&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10770"></a><span class="lineno">10770</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-unv&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10771"></a><span class="lineno">10771</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l10772"></a><span class="lineno">10772</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:  <span class="comment">/* Record your busy message */</span></div><div class="line"><a name="l10773"></a><span class="lineno">10773</span>&#160;         snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/busy&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10774"></a><span class="lineno">10774</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-busy&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10775"></a><span class="lineno">10775</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l10776"></a><span class="lineno">10776</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>: <span class="comment">/* Record greeting */</span></div><div class="line"><a name="l10777"></a><span class="lineno">10777</span>&#160;         snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10778"></a><span class="lineno">10778</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-name&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10779"></a><span class="lineno">10779</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l10780"></a><span class="lineno">10780</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;4&#39;</span>:  <span class="comment">/* manage the temporary greeting */</span></div><div class="line"><a name="l10781"></a><span class="lineno">10781</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650">vm_tempgreeting</a>(chan, vmu, vms, fmtc, record_gain);</div><div class="line"><a name="l10782"></a><span class="lineno">10782</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l10783"></a><span class="lineno">10783</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;5&#39;</span>: <span class="comment">/* change password */</span></div><div class="line"><a name="l10784"></a><span class="lineno">10784</span>&#160;         <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[0] == <span class="charliteral">&#39;-&#39;</span>) {</div><div class="line"><a name="l10785"></a><span class="lineno">10785</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l10786"></a><span class="lineno">10786</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10787"></a><span class="lineno">10787</span>&#160;         }</div><div class="line"><a name="l10788"></a><span class="lineno">10788</span>&#160;         newpassword[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10789"></a><span class="lineno">10789</span>&#160;         newpassword[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_newpassword);</div><div class="line"><a name="l10790"></a><span class="lineno">10790</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10791"></a><span class="lineno">10791</span>&#160;            newpassword[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10792"></a><span class="lineno">10792</span>&#160;         <span class="keywordflow">else</span> {</div><div class="line"><a name="l10793"></a><span class="lineno">10793</span>&#160;            <span class="keywordflow">if</span> (cmd &lt; 0)</div><div class="line"><a name="l10794"></a><span class="lineno">10794</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l10795"></a><span class="lineno">10795</span>&#160;            <span class="keywordflow">if</span> ((cmd = <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, newpassword + strlen(newpassword), <span class="keyword">sizeof</span>(newpassword) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>)) &lt; 0) {</div><div class="line"><a name="l10796"></a><span class="lineno">10796</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l10797"></a><span class="lineno">10797</span>&#160;            }</div><div class="line"><a name="l10798"></a><span class="lineno">10798</span>&#160;         }</div><div class="line"><a name="l10799"></a><span class="lineno">10799</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc">check_password</a>(vmu, newpassword); <span class="comment">/* perform password validation */</span></div><div class="line"><a name="l10800"></a><span class="lineno">10800</span>&#160;         <span class="keywordflow">if</span> (cmd != 0) {</div><div class="line"><a name="l10801"></a><span class="lineno">10801</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid password for user %s (%s)\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword);</div><div class="line"><a name="l10802"></a><span class="lineno">10802</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_invalid_password);</div><div class="line"><a name="l10803"></a><span class="lineno">10803</span>&#160;            <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10804"></a><span class="lineno">10804</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_pls_try_again);</div><div class="line"><a name="l10805"></a><span class="lineno">10805</span>&#160;            }</div><div class="line"><a name="l10806"></a><span class="lineno">10806</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10807"></a><span class="lineno">10807</span>&#160;         }</div><div class="line"><a name="l10808"></a><span class="lineno">10808</span>&#160;         newpassword2[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10809"></a><span class="lineno">10809</span>&#160;         newpassword2[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_reenterpassword);</div><div class="line"><a name="l10810"></a><span class="lineno">10810</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;#&#39;</span>)</div><div class="line"><a name="l10811"></a><span class="lineno">10811</span>&#160;            newpassword2[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l10812"></a><span class="lineno">10812</span>&#160;         <span class="keywordflow">else</span> {</div><div class="line"><a name="l10813"></a><span class="lineno">10813</span>&#160;            <span class="keywordflow">if</span> (cmd &lt; 0)</div><div class="line"><a name="l10814"></a><span class="lineno">10814</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l10815"></a><span class="lineno">10815</span>&#160;</div><div class="line"><a name="l10816"></a><span class="lineno">10816</span>&#160;            <span class="keywordflow">if</span> ((cmd = <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, newpassword2 + strlen(newpassword2), <span class="keyword">sizeof</span>(newpassword2) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>)) &lt; 0) {</div><div class="line"><a name="l10817"></a><span class="lineno">10817</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l10818"></a><span class="lineno">10818</span>&#160;            }</div><div class="line"><a name="l10819"></a><span class="lineno">10819</span>&#160;         }</div><div class="line"><a name="l10820"></a><span class="lineno">10820</span>&#160;         <span class="keywordflow">if</span> (strcmp(newpassword, newpassword2)) {</div><div class="line"><a name="l10821"></a><span class="lineno">10821</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Password mismatch for user %s (%s != %s)\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword, newpassword2);</div><div class="line"><a name="l10822"></a><span class="lineno">10822</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_mismatch);</div><div class="line"><a name="l10823"></a><span class="lineno">10823</span>&#160;            <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10824"></a><span class="lineno">10824</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_pls_try_again);</div><div class="line"><a name="l10825"></a><span class="lineno">10825</span>&#160;            }</div><div class="line"><a name="l10826"></a><span class="lineno">10826</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10827"></a><span class="lineno">10827</span>&#160;         }</div><div class="line"><a name="l10828"></a><span class="lineno">10828</span>&#160;</div><div class="line"><a name="l10829"></a><span class="lineno">10829</span>&#160;         <span class="keywordflow">if</span> (pwdchange &amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>) {</div><div class="line"><a name="l10830"></a><span class="lineno">10830</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a778f09605f89f85529e369351472b174">vm_change_password</a>(vmu, newpassword);</div><div class="line"><a name="l10831"></a><span class="lineno">10831</span>&#160;         }</div><div class="line"><a name="l10832"></a><span class="lineno">10832</span>&#160;         <span class="keywordflow">if</span> ((pwdchange &amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a>) &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(ext_pass_cmd)) {</div><div class="line"><a name="l10833"></a><span class="lineno">10833</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a>(vmu, newpassword);</div><div class="line"><a name="l10834"></a><span class="lineno">10834</span>&#160;         }</div><div class="line"><a name="l10835"></a><span class="lineno">10835</span>&#160;</div><div class="line"><a name="l10836"></a><span class="lineno">10836</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;User %s set password to %s of length %d\n&quot;</span>,</div><div class="line"><a name="l10837"></a><span class="lineno">10837</span>&#160;            vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword, (<span class="keywordtype">int</span>) strlen(newpassword));</div><div class="line"><a name="l10838"></a><span class="lineno">10838</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_passchanged);</div><div class="line"><a name="l10839"></a><span class="lineno">10839</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l10840"></a><span class="lineno">10840</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l10841"></a><span class="lineno">10841</span>&#160;         cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10842"></a><span class="lineno">10842</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l10843"></a><span class="lineno">10843</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l10844"></a><span class="lineno">10844</span>&#160;         cmd = 0;</div><div class="line"><a name="l10845"></a><span class="lineno">10845</span>&#160;         snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10846"></a><span class="lineno">10846</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l10847"></a><span class="lineno">10847</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l10848"></a><span class="lineno">10848</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tmpexists&quot;</span>);</div><div class="line"><a name="l10849"></a><span class="lineno">10849</span>&#160;         }</div><div class="line"><a name="l10850"></a><span class="lineno">10850</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);</div><div class="line"><a name="l10851"></a><span class="lineno">10851</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10852"></a><span class="lineno">10852</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-options&quot;</span>);</div><div class="line"><a name="l10853"></a><span class="lineno">10853</span>&#160;         }</div><div class="line"><a name="l10854"></a><span class="lineno">10854</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10855"></a><span class="lineno">10855</span>&#160;            cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l10856"></a><span class="lineno">10856</span>&#160;         }</div><div class="line"><a name="l10857"></a><span class="lineno">10857</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10858"></a><span class="lineno">10858</span>&#160;            retries++;</div><div class="line"><a name="l10859"></a><span class="lineno">10859</span>&#160;         }</div><div class="line"><a name="l10860"></a><span class="lineno">10860</span>&#160;         <span class="keywordflow">if</span> (retries &gt; 3) {</div><div class="line"><a name="l10861"></a><span class="lineno">10861</span>&#160;            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10862"></a><span class="lineno">10862</span>&#160;         }</div><div class="line"><a name="l10863"></a><span class="lineno">10863</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l10864"></a><span class="lineno">10864</span>&#160;            isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l10865"></a><span class="lineno">10865</span>&#160;      }</div><div class="line"><a name="l10866"></a><span class="lineno">10866</span>&#160;   }</div><div class="line"><a name="l10867"></a><span class="lineno">10867</span>&#160;   <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;t&#39;</span>)</div><div class="line"><a name="l10868"></a><span class="lineno">10868</span>&#160;      cmd = 0;</div><div class="line"><a name="l10869"></a><span class="lineno">10869</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10870"></a><span class="lineno">10870</span>&#160;}</div><div class="line"><a name="l10871"></a><span class="lineno">10871</span>&#160;<span class="comment"></span></div><div class="line"><a name="l10872"></a><span class="lineno">10872</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l10873"></a><span class="lineno">10873</span>&#160;<span class="comment"> * \brief The handler for &#39;record a temporary greeting&#39;.</span></div><div class="line"><a name="l10874"></a><span class="lineno">10874</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l10875"></a><span class="lineno">10875</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l10876"></a><span class="lineno">10876</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l10877"></a><span class="lineno">10877</span>&#160;<span class="comment"> * \param fmtc</span></div><div class="line"><a name="l10878"></a><span class="lineno">10878</span>&#160;<span class="comment"> * \param record_gain</span></div><div class="line"><a name="l10879"></a><span class="lineno">10879</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l10880"></a><span class="lineno">10880</span>&#160;<span class="comment"> * This is option 4 from the mailbox options menu.</span></div><div class="line"><a name="l10881"></a><span class="lineno">10881</span>&#160;<span class="comment"> * This function manages the following promptings:</span></div><div class="line"><a name="l10882"></a><span class="lineno">10882</span>&#160;<span class="comment"> * 1: play / record / review the temporary greeting. : invokes play_record_review().</span></div><div class="line"><a name="l10883"></a><span class="lineno">10883</span>&#160;<span class="comment"> * 2: remove (delete) the temporary greeting.</span></div><div class="line"><a name="l10884"></a><span class="lineno">10884</span>&#160;<span class="comment"> * *: return to the main menu.</span></div><div class="line"><a name="l10885"></a><span class="lineno">10885</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l10886"></a><span class="lineno">10886</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l10887"></a><span class="lineno">10887</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l10888"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650">10888</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650">vm_tempgreeting</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)</div><div class="line"><a name="l10889"></a><span class="lineno">10889</span>&#160;{</div><div class="line"><a name="l10890"></a><span class="lineno">10890</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l10891"></a><span class="lineno">10891</span>&#160;   <span class="keywordtype">int</span> retries = 0;</div><div class="line"><a name="l10892"></a><span class="lineno">10892</span>&#160;   <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l10893"></a><span class="lineno">10893</span>&#160;   <span class="keywordtype">char</span> prefile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l10894"></a><span class="lineno">10894</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l10895"></a><span class="lineno">10895</span>&#160;   <span class="keywordtype">int</span> bytes = 0;</div><div class="line"><a name="l10896"></a><span class="lineno">10896</span>&#160;</div><div class="line"><a name="l10897"></a><span class="lineno">10897</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a>(chan)) {</div><div class="line"><a name="l10898"></a><span class="lineno">10898</span>&#160;      bytes += <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);</div><div class="line"><a name="l10899"></a><span class="lineno">10899</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Temp Greeting Menu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l10900"></a><span class="lineno">10900</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Not Done&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l10901"></a><span class="lineno">10901</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);</div><div class="line"><a name="l10902"></a><span class="lineno">10902</span>&#160;      bytes += <a class="code" href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a>(buf + bytes, 0);</div><div class="line"><a name="l10903"></a><span class="lineno">10903</span>&#160;      <a class="code" href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);</div><div class="line"><a name="l10904"></a><span class="lineno">10904</span>&#160;   }</div><div class="line"><a name="l10905"></a><span class="lineno">10905</span>&#160;</div><div class="line"><a name="l10906"></a><span class="lineno">10906</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;TEMPGREETING&quot;</span>, <span class="stringliteral">&quot;Message: entering temp greeting options&quot;</span>);</div><div class="line"><a name="l10907"></a><span class="lineno">10907</span>&#160;   snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);</div><div class="line"><a name="l10908"></a><span class="lineno">10908</span>&#160;   <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>)) {</div><div class="line"><a name="l10909"></a><span class="lineno">10909</span>&#160;      <span class="keywordflow">if</span> (cmd)</div><div class="line"><a name="l10910"></a><span class="lineno">10910</span>&#160;         retries = 0;</div><div class="line"><a name="l10911"></a><span class="lineno">10911</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l10912"></a><span class="lineno">10912</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &lt;= 0) {</div><div class="line"><a name="l10913"></a><span class="lineno">10913</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-temp&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10914"></a><span class="lineno">10914</span>&#160;         <span class="keywordflow">if</span> (cmd == -1) {</div><div class="line"><a name="l10915"></a><span class="lineno">10915</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10916"></a><span class="lineno">10916</span>&#160;         }</div><div class="line"><a name="l10917"></a><span class="lineno">10917</span>&#160;         cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10918"></a><span class="lineno">10918</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10919"></a><span class="lineno">10919</span>&#160;         <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l10920"></a><span class="lineno">10920</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:</div><div class="line"><a name="l10921"></a><span class="lineno">10921</span>&#160;            cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-temp&quot;</span>, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, record_gain, vms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l10922"></a><span class="lineno">10922</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10923"></a><span class="lineno">10923</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:</div><div class="line"><a name="l10924"></a><span class="lineno">10924</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(prefile, -1, prefile, vmu);</div><div class="line"><a name="l10925"></a><span class="lineno">10925</span>&#160;            <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tempremoved&quot;</span>);</div><div class="line"><a name="l10926"></a><span class="lineno">10926</span>&#160;            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10927"></a><span class="lineno">10927</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10928"></a><span class="lineno">10928</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l10929"></a><span class="lineno">10929</span>&#160;            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10930"></a><span class="lineno">10930</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l10931"></a><span class="lineno">10931</span>&#160;         <span class="keywordflow">default</span>:</div><div class="line"><a name="l10932"></a><span class="lineno">10932</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan,</div><div class="line"><a name="l10933"></a><span class="lineno">10933</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(prefile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0 ? <span class="comment">/* XXX always true ? */</span></div><div class="line"><a name="l10934"></a><span class="lineno">10934</span>&#160;                  <span class="stringliteral">&quot;vm-tempgreeting2&quot;</span> : <span class="stringliteral">&quot;vm-tempgreeting&quot;</span>);</div><div class="line"><a name="l10935"></a><span class="lineno">10935</span>&#160;            <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10936"></a><span class="lineno">10936</span>&#160;               cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l10937"></a><span class="lineno">10937</span>&#160;            }</div><div class="line"><a name="l10938"></a><span class="lineno">10938</span>&#160;            <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10939"></a><span class="lineno">10939</span>&#160;               retries++;</div><div class="line"><a name="l10940"></a><span class="lineno">10940</span>&#160;            }</div><div class="line"><a name="l10941"></a><span class="lineno">10941</span>&#160;            <span class="keywordflow">if</span> (retries &gt; 3) {</div><div class="line"><a name="l10942"></a><span class="lineno">10942</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l10943"></a><span class="lineno">10943</span>&#160;            }</div><div class="line"><a name="l10944"></a><span class="lineno">10944</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l10945"></a><span class="lineno">10945</span>&#160;               isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l10946"></a><span class="lineno">10946</span>&#160;         }</div><div class="line"><a name="l10947"></a><span class="lineno">10947</span>&#160;      }</div><div class="line"><a name="l10948"></a><span class="lineno">10948</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);</div><div class="line"><a name="l10949"></a><span class="lineno">10949</span>&#160;   }</div><div class="line"><a name="l10950"></a><span class="lineno">10950</span>&#160;   <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;t&#39;</span>)</div><div class="line"><a name="l10951"></a><span class="lineno">10951</span>&#160;      cmd = 0;</div><div class="line"><a name="l10952"></a><span class="lineno">10952</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10953"></a><span class="lineno">10953</span>&#160;}</div><div class="line"><a name="l10954"></a><span class="lineno">10954</span>&#160;<span class="comment"></span></div><div class="line"><a name="l10955"></a><span class="lineno">10955</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l10956"></a><span class="lineno">10956</span>&#160;<span class="comment"> * \brief Greek syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l10957"></a><span class="lineno">10957</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l10958"></a><span class="lineno">10958</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l10959"></a><span class="lineno">10959</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l10960"></a><span class="lineno">10960</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l10961"></a><span class="lineno">10961</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l10962"></a><span class="lineno">10962</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l10963"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751">10963</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751">vm_browse_messages_gr</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l10964"></a><span class="lineno">10964</span>&#160;{</div><div class="line"><a name="l10965"></a><span class="lineno">10965</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l10966"></a><span class="lineno">10966</span>&#160;</div><div class="line"><a name="l10967"></a><span class="lineno">10967</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l10968"></a><span class="lineno">10968</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l10969"></a><span class="lineno">10969</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10970"></a><span class="lineno">10970</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhaveno&quot;</span>);</div><div class="line"><a name="l10971"></a><span class="lineno">10971</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) ||!strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="stringliteral">&quot;vm-Old&quot;</span>)){</div><div class="line"><a name="l10972"></a><span class="lineno">10972</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10973"></a><span class="lineno">10973</span>&#160;            snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%ss&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l10974"></a><span class="lineno">10974</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l10975"></a><span class="lineno">10975</span>&#160;         }</div><div class="line"><a name="l10976"></a><span class="lineno">10976</span>&#160;         <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l10977"></a><span class="lineno">10977</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10978"></a><span class="lineno">10978</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10979"></a><span class="lineno">10979</span>&#160;         <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l10980"></a><span class="lineno">10980</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l10981"></a><span class="lineno">10981</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l10982"></a><span class="lineno">10982</span>&#160;            snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l10983"></a><span class="lineno">10983</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l10984"></a><span class="lineno">10984</span>&#160;         }</div><div class="line"><a name="l10985"></a><span class="lineno">10985</span>&#160;      }</div><div class="line"><a name="l10986"></a><span class="lineno">10986</span>&#160;   }</div><div class="line"><a name="l10987"></a><span class="lineno">10987</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l10988"></a><span class="lineno">10988</span>&#160;}</div><div class="line"><a name="l10989"></a><span class="lineno">10989</span>&#160;</div><div class="line"><a name="l10990"></a><span class="lineno">10990</span>&#160;<span class="comment">/* Hebrew Syntax */</span></div><div class="line"><a name="l10991"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">10991</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">vm_browse_messages_he</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l10992"></a><span class="lineno">10992</span>&#160;{</div><div class="line"><a name="l10993"></a><span class="lineno">10993</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l10994"></a><span class="lineno">10994</span>&#160;</div><div class="line"><a name="l10995"></a><span class="lineno">10995</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l10996"></a><span class="lineno">10996</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l10997"></a><span class="lineno">10997</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l10998"></a><span class="lineno">10998</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="stringliteral">&quot;INBOX&quot;</span>)) {</div><div class="line"><a name="l10999"></a><span class="lineno">10999</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nonewmessages&quot;</span>);</div><div class="line"><a name="l11000"></a><span class="lineno">11000</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11001"></a><span class="lineno">11001</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomessages&quot;</span>);</div><div class="line"><a name="l11002"></a><span class="lineno">11002</span>&#160;      }</div><div class="line"><a name="l11003"></a><span class="lineno">11003</span>&#160;   }</div><div class="line"><a name="l11004"></a><span class="lineno">11004</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11005"></a><span class="lineno">11005</span>&#160;}</div><div class="line"><a name="l11006"></a><span class="lineno">11006</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11007"></a><span class="lineno">11007</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11008"></a><span class="lineno">11008</span>&#160;<span class="comment"> * \brief Default English syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11009"></a><span class="lineno">11009</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11010"></a><span class="lineno">11010</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11011"></a><span class="lineno">11011</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11012"></a><span class="lineno">11012</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11013"></a><span class="lineno">11013</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11014"></a><span class="lineno">11014</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11015"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14">11015</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14">vm_browse_messages_en</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11016"></a><span class="lineno">11016</span>&#160;{</div><div class="line"><a name="l11017"></a><span class="lineno">11017</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l11018"></a><span class="lineno">11018</span>&#160;</div><div class="line"><a name="l11019"></a><span class="lineno">11019</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11020"></a><span class="lineno">11020</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11021"></a><span class="lineno">11021</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11022"></a><span class="lineno">11022</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);</div><div class="line"><a name="l11023"></a><span class="lineno">11023</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11024"></a><span class="lineno">11024</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l11025"></a><span class="lineno">11025</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11026"></a><span class="lineno">11026</span>&#160;         snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11027"></a><span class="lineno">11027</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11028"></a><span class="lineno">11028</span>&#160;      }</div><div class="line"><a name="l11029"></a><span class="lineno">11029</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11030"></a><span class="lineno">11030</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l11031"></a><span class="lineno">11031</span>&#160;   }</div><div class="line"><a name="l11032"></a><span class="lineno">11032</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11033"></a><span class="lineno">11033</span>&#160;}</div><div class="line"><a name="l11034"></a><span class="lineno">11034</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11035"></a><span class="lineno">11035</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11036"></a><span class="lineno">11036</span>&#160;<span class="comment"> *\brief Italian syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11037"></a><span class="lineno">11037</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11038"></a><span class="lineno">11038</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11039"></a><span class="lineno">11039</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11040"></a><span class="lineno">11040</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11041"></a><span class="lineno">11041</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11042"></a><span class="lineno">11042</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11043"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108">11043</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108">vm_browse_messages_it</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11044"></a><span class="lineno">11044</span>&#160;{</div><div class="line"><a name="l11045"></a><span class="lineno">11045</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l11046"></a><span class="lineno">11046</span>&#160;</div><div class="line"><a name="l11047"></a><span class="lineno">11047</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11048"></a><span class="lineno">11048</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11049"></a><span class="lineno">11049</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11050"></a><span class="lineno">11050</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l11051"></a><span class="lineno">11051</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11052"></a><span class="lineno">11052</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l11053"></a><span class="lineno">11053</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11054"></a><span class="lineno">11054</span>&#160;         snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11055"></a><span class="lineno">11055</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11056"></a><span class="lineno">11056</span>&#160;      }</div><div class="line"><a name="l11057"></a><span class="lineno">11057</span>&#160;   }</div><div class="line"><a name="l11058"></a><span class="lineno">11058</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11059"></a><span class="lineno">11059</span>&#160;}</div><div class="line"><a name="l11060"></a><span class="lineno">11060</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11061"></a><span class="lineno">11061</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11062"></a><span class="lineno">11062</span>&#160;<span class="comment"> * \brief Japanese syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11063"></a><span class="lineno">11063</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11064"></a><span class="lineno">11064</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11065"></a><span class="lineno">11065</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11066"></a><span class="lineno">11066</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11067"></a><span class="lineno">11067</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11068"></a><span class="lineno">11068</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11069"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a73413880ef85ba50f1ad0087997a6d14">11069</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a73413880ef85ba50f1ad0087997a6d14">vm_browse_messages_ja</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11070"></a><span class="lineno">11070</span>&#160;{</div><div class="line"><a name="l11071"></a><span class="lineno">11071</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l11072"></a><span class="lineno">11072</span>&#160;</div><div class="line"><a name="l11073"></a><span class="lineno">11073</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11074"></a><span class="lineno">11074</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11075"></a><span class="lineno">11075</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11076"></a><span class="lineno">11076</span>&#160;      snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11077"></a><span class="lineno">11077</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11078"></a><span class="lineno">11078</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11079"></a><span class="lineno">11079</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l11080"></a><span class="lineno">11080</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11081"></a><span class="lineno">11081</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wa&quot;</span>);</div><div class="line"><a name="l11082"></a><span class="lineno">11082</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11083"></a><span class="lineno">11083</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-arimasen&quot;</span>);</div><div class="line"><a name="l11084"></a><span class="lineno">11084</span>&#160;   }</div><div class="line"><a name="l11085"></a><span class="lineno">11085</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11086"></a><span class="lineno">11086</span>&#160;}</div><div class="line"><a name="l11087"></a><span class="lineno">11087</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11088"></a><span class="lineno">11088</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11089"></a><span class="lineno">11089</span>&#160;<span class="comment"> * \brief Spanish syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11090"></a><span class="lineno">11090</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11091"></a><span class="lineno">11091</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11092"></a><span class="lineno">11092</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11093"></a><span class="lineno">11093</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11094"></a><span class="lineno">11094</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11095"></a><span class="lineno">11095</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11096"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a">11096</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a">vm_browse_messages_es</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11097"></a><span class="lineno">11097</span>&#160;{</div><div class="line"><a name="l11098"></a><span class="lineno">11098</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l11099"></a><span class="lineno">11099</span>&#160;</div><div class="line"><a name="l11100"></a><span class="lineno">11100</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11101"></a><span class="lineno">11101</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11102"></a><span class="lineno">11102</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11103"></a><span class="lineno">11103</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhaveno&quot;</span>);</div><div class="line"><a name="l11104"></a><span class="lineno">11104</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11105"></a><span class="lineno">11105</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l11106"></a><span class="lineno">11106</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11107"></a><span class="lineno">11107</span>&#160;         snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11108"></a><span class="lineno">11108</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11109"></a><span class="lineno">11109</span>&#160;      }</div><div class="line"><a name="l11110"></a><span class="lineno">11110</span>&#160;   }</div><div class="line"><a name="l11111"></a><span class="lineno">11111</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11112"></a><span class="lineno">11112</span>&#160;}</div><div class="line"><a name="l11113"></a><span class="lineno">11113</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11114"></a><span class="lineno">11114</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11115"></a><span class="lineno">11115</span>&#160;<span class="comment"> * \brief Portuguese syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11116"></a><span class="lineno">11116</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11117"></a><span class="lineno">11117</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11118"></a><span class="lineno">11118</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11119"></a><span class="lineno">11119</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11120"></a><span class="lineno">11120</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11121"></a><span class="lineno">11121</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11122"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739">11122</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739">vm_browse_messages_pt</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11123"></a><span class="lineno">11123</span>&#160;{</div><div class="line"><a name="l11124"></a><span class="lineno">11124</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l11125"></a><span class="lineno">11125</span>&#160;</div><div class="line"><a name="l11126"></a><span class="lineno">11126</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11127"></a><span class="lineno">11127</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11128"></a><span class="lineno">11128</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11129"></a><span class="lineno">11129</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l11130"></a><span class="lineno">11130</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11131"></a><span class="lineno">11131</span>&#160;         snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11132"></a><span class="lineno">11132</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11133"></a><span class="lineno">11133</span>&#160;      }</div><div class="line"><a name="l11134"></a><span class="lineno">11134</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11135"></a><span class="lineno">11135</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l11136"></a><span class="lineno">11136</span>&#160;   }</div><div class="line"><a name="l11137"></a><span class="lineno">11137</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11138"></a><span class="lineno">11138</span>&#160;}</div><div class="line"><a name="l11139"></a><span class="lineno">11139</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11140"></a><span class="lineno">11140</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11141"></a><span class="lineno">11141</span>&#160;<span class="comment"> * \brief Chinese (Taiwan)syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11142"></a><span class="lineno">11142</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11143"></a><span class="lineno">11143</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11144"></a><span class="lineno">11144</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11145"></a><span class="lineno">11145</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11146"></a><span class="lineno">11146</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11147"></a><span class="lineno">11147</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11148"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3">11148</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3">vm_browse_messages_zh</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11149"></a><span class="lineno">11149</span>&#160;{</div><div class="line"><a name="l11150"></a><span class="lineno">11150</span>&#160;   <span class="keywordtype">int</span> cmd;</div><div class="line"><a name="l11151"></a><span class="lineno">11151</span>&#160;</div><div class="line"><a name="l11152"></a><span class="lineno">11152</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11153"></a><span class="lineno">11153</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11154"></a><span class="lineno">11154</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11155"></a><span class="lineno">11155</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-you&quot;</span>);</div><div class="line"><a name="l11156"></a><span class="lineno">11156</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11157"></a><span class="lineno">11157</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-haveno&quot;</span>);</div><div class="line"><a name="l11158"></a><span class="lineno">11158</span>&#160;      <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l11159"></a><span class="lineno">11159</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);</div><div class="line"><a name="l11160"></a><span class="lineno">11160</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11161"></a><span class="lineno">11161</span>&#160;         snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11162"></a><span class="lineno">11162</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11163"></a><span class="lineno">11163</span>&#160;      }</div><div class="line"><a name="l11164"></a><span class="lineno">11164</span>&#160;   }</div><div class="line"><a name="l11165"></a><span class="lineno">11165</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11166"></a><span class="lineno">11166</span>&#160;}</div><div class="line"><a name="l11167"></a><span class="lineno">11167</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11168"></a><span class="lineno">11168</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11169"></a><span class="lineno">11169</span>&#160;<span class="comment"> * \brief Vietnamese syntax for &#39;You have N messages&#39; greeting.</span></div><div class="line"><a name="l11170"></a><span class="lineno">11170</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l11171"></a><span class="lineno">11171</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l11172"></a><span class="lineno">11172</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l11173"></a><span class="lineno">11173</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11174"></a><span class="lineno">11174</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11175"></a><span class="lineno">11175</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11176"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a00e09a896f748874c9efe4fd1237cb54">11176</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a00e09a896f748874c9efe4fd1237cb54">vm_browse_messages_vi</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11177"></a><span class="lineno">11177</span>&#160;{</div><div class="line"><a name="l11178"></a><span class="lineno">11178</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l11179"></a><span class="lineno">11179</span>&#160;</div><div class="line"><a name="l11180"></a><span class="lineno">11180</span>&#160;   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l11181"></a><span class="lineno">11181</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);</div><div class="line"><a name="l11182"></a><span class="lineno">11182</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11183"></a><span class="lineno">11183</span>&#160;      cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);</div><div class="line"><a name="l11184"></a><span class="lineno">11184</span>&#160;      <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11185"></a><span class="lineno">11185</span>&#160;         snprintf(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);</div><div class="line"><a name="l11186"></a><span class="lineno">11186</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11187"></a><span class="lineno">11187</span>&#160;      }</div><div class="line"><a name="l11188"></a><span class="lineno">11188</span>&#160;   }</div><div class="line"><a name="l11189"></a><span class="lineno">11189</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l11190"></a><span class="lineno">11190</span>&#160;}</div><div class="line"><a name="l11191"></a><span class="lineno">11191</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11192"></a><span class="lineno">11192</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11193"></a><span class="lineno">11193</span>&#160;<span class="comment"> * \brief Top level method to invoke the language variant vm_browse_messages_XX function.</span></div><div class="line"><a name="l11194"></a><span class="lineno">11194</span>&#160;<span class="comment"> * \param chan The channel for the current user. We read the language property from this.</span></div><div class="line"><a name="l11195"></a><span class="lineno">11195</span>&#160;<span class="comment"> * \param vms passed into the language-specific vm_browse_messages function.</span></div><div class="line"><a name="l11196"></a><span class="lineno">11196</span>&#160;<span class="comment"> * \param vmu passed into the language-specific vm_browse_messages function.</span></div><div class="line"><a name="l11197"></a><span class="lineno">11197</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11198"></a><span class="lineno">11198</span>&#160;<span class="comment"> * The method to be invoked is determined by the value of language code property in the user&#39;s channel.</span></div><div class="line"><a name="l11199"></a><span class="lineno">11199</span>&#160;<span class="comment"> * The default (when unable to match) is to use english.</span></div><div class="line"><a name="l11200"></a><span class="lineno">11200</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11201"></a><span class="lineno">11201</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l11202"></a><span class="lineno">11202</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11203"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7">11203</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7">vm_browse_messages</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l11204"></a><span class="lineno">11204</span>&#160;{</div><div class="line"><a name="l11205"></a><span class="lineno">11205</span>&#160;   <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;es&quot;</span>, 2)) {         <span class="comment">/* SPANISH */</span></div><div class="line"><a name="l11206"></a><span class="lineno">11206</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a">vm_browse_messages_es</a>(chan, vms, vmu);</div><div class="line"><a name="l11207"></a><span class="lineno">11207</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;gr&quot;</span>, 2)) {  <span class="comment">/* GREEK */</span></div><div class="line"><a name="l11208"></a><span class="lineno">11208</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751">vm_browse_messages_gr</a>(chan, vms, vmu);</div><div class="line"><a name="l11209"></a><span class="lineno">11209</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;he&quot;</span>, 2)) {  <span class="comment">/* HEBREW */</span></div><div class="line"><a name="l11210"></a><span class="lineno">11210</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">vm_browse_messages_he</a>(chan, vms, vmu);</div><div class="line"><a name="l11211"></a><span class="lineno">11211</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;it&quot;</span>, 2)) {  <span class="comment">/* ITALIAN */</span></div><div class="line"><a name="l11212"></a><span class="lineno">11212</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108">vm_browse_messages_it</a>(chan, vms, vmu);</div><div class="line"><a name="l11213"></a><span class="lineno">11213</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ja&quot;</span>, 2)) {  <span class="comment">/* JAPANESE */</span></div><div class="line"><a name="l11214"></a><span class="lineno">11214</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a73413880ef85ba50f1ad0087997a6d14">vm_browse_messages_ja</a>(chan, vms, vmu);</div><div class="line"><a name="l11215"></a><span class="lineno">11215</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;pt&quot;</span>, 2)) {  <span class="comment">/* PORTUGUESE */</span></div><div class="line"><a name="l11216"></a><span class="lineno">11216</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739">vm_browse_messages_pt</a>(chan, vms, vmu);</div><div class="line"><a name="l11217"></a><span class="lineno">11217</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;vi&quot;</span>, 2)) {  <span class="comment">/* VIETNAMESE */</span></div><div class="line"><a name="l11218"></a><span class="lineno">11218</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a00e09a896f748874c9efe4fd1237cb54">vm_browse_messages_vi</a>(chan, vms, vmu);</div><div class="line"><a name="l11219"></a><span class="lineno">11219</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;zh&quot;</span>, 2)) {  <span class="comment">/* CHINESE (Taiwan) */</span></div><div class="line"><a name="l11220"></a><span class="lineno">11220</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3">vm_browse_messages_zh</a>(chan, vms, vmu);</div><div class="line"><a name="l11221"></a><span class="lineno">11221</span>&#160;   } <span class="keywordflow">else</span> {                                             <span class="comment">/* Default to English syntax */</span></div><div class="line"><a name="l11222"></a><span class="lineno">11222</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14">vm_browse_messages_en</a>(chan, vms, vmu);</div><div class="line"><a name="l11223"></a><span class="lineno">11223</span>&#160;   }</div><div class="line"><a name="l11224"></a><span class="lineno">11224</span>&#160;}</div><div class="line"><a name="l11225"></a><span class="lineno">11225</span>&#160;</div><div class="line"><a name="l11226"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">11226</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> mailbox_size,</div><div class="line"><a name="l11227"></a><span class="lineno">11227</span>&#160;         <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *res_vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d43/http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>,</div><div class="line"><a name="l11228"></a><span class="lineno">11228</span>&#160;         <span class="keywordtype">int</span> skipuser, <span class="keywordtype">int</span> max_logins, <span class="keywordtype">int</span> silent)</div><div class="line"><a name="l11229"></a><span class="lineno">11229</span>&#160;{</div><div class="line"><a name="l11230"></a><span class="lineno">11230</span>&#160;   <span class="keywordtype">int</span> useadsi = 0, valid = 0, logretries = 0;</div><div class="line"><a name="l11231"></a><span class="lineno">11231</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>[<a class="code" href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>], *passptr = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l11232"></a><span class="lineno">11232</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> vmus, *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l11233"></a><span class="lineno">11233</span>&#160;</div><div class="line"><a name="l11234"></a><span class="lineno">11234</span>&#160;   <span class="comment">/* If ADSI is supported, setup login screen */</span></div><div class="line"><a name="l11235"></a><span class="lineno">11235</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a>(chan, &amp;useadsi);</div><div class="line"><a name="l11236"></a><span class="lineno">11236</span>&#160;   <span class="keywordflow">if</span> (!skipuser &amp;&amp; useadsi)</div><div class="line"><a name="l11237"></a><span class="lineno">11237</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a>(chan);</div><div class="line"><a name="l11238"></a><span class="lineno">11238</span>&#160;   <span class="keywordflow">if</span> (!silent &amp;&amp; !skipuser &amp;&amp; <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, vm_login, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan))) {</div><div class="line"><a name="l11239"></a><span class="lineno">11239</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t stream login file\n&quot;</span>);</div><div class="line"><a name="l11240"></a><span class="lineno">11240</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11241"></a><span class="lineno">11241</span>&#160;   }</div><div class="line"><a name="l11242"></a><span class="lineno">11242</span>&#160;</div><div class="line"><a name="l11243"></a><span class="lineno">11243</span>&#160;   <span class="comment">/* Authenticate them and get their mailbox/password */</span></div><div class="line"><a name="l11244"></a><span class="lineno">11244</span>&#160;</div><div class="line"><a name="l11245"></a><span class="lineno">11245</span>&#160;   <span class="keywordflow">while</span> (!valid &amp;&amp; (logretries &lt; max_logins)) {</div><div class="line"><a name="l11246"></a><span class="lineno">11246</span>&#160;      <span class="comment">/* Prompt for, and read in the username */</span></div><div class="line"><a name="l11247"></a><span class="lineno">11247</span>&#160;      <span class="keywordflow">if</span> (!skipuser &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, mailbox, mailbox_size - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>) &lt; 0) {</div><div class="line"><a name="l11248"></a><span class="lineno">11248</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t read username\n&quot;</span>);</div><div class="line"><a name="l11249"></a><span class="lineno">11249</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11250"></a><span class="lineno">11250</span>&#160;      }</div><div class="line"><a name="l11251"></a><span class="lineno">11251</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) {</div><div class="line"><a name="l11252"></a><span class="lineno">11252</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str) {</div><div class="line"><a name="l11253"></a><span class="lineno">11253</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(mailbox, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, mailbox_size);</div><div class="line"><a name="l11254"></a><span class="lineno">11254</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11255"></a><span class="lineno">11255</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Username not entered\n&quot;</span>);</div><div class="line"><a name="l11256"></a><span class="lineno">11256</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11257"></a><span class="lineno">11257</span>&#160;         }</div><div class="line"><a name="l11258"></a><span class="lineno">11258</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mailbox[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l11259"></a><span class="lineno">11259</span>&#160;         <span class="comment">/* user entered &#39;*&#39; */</span></div><div class="line"><a name="l11260"></a><span class="lineno">11260</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Mailbox begins with &#39;*&#39;, attempting jump to extension &#39;a&#39;\n&quot;</span>);</div><div class="line"><a name="l11261"></a><span class="lineno">11261</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan), <span class="stringliteral">&quot;a&quot;</span>, 1,</div><div class="line"><a name="l11262"></a><span class="lineno">11262</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l11263"></a><span class="lineno">11263</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11264"></a><span class="lineno">11264</span>&#160;         }</div><div class="line"><a name="l11265"></a><span class="lineno">11265</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Jump to extension &#39;a&#39; failed; setting mailbox to NULL\n&quot;</span>);</div><div class="line"><a name="l11266"></a><span class="lineno">11266</span>&#160;         mailbox[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l11267"></a><span class="lineno">11267</span>&#160;      }</div><div class="line"><a name="l11268"></a><span class="lineno">11268</span>&#160;</div><div class="line"><a name="l11269"></a><span class="lineno">11269</span>&#160;      <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l11270"></a><span class="lineno">11270</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47">adsi_password</a>(chan);</div><div class="line"><a name="l11271"></a><span class="lineno">11271</span>&#160;</div><div class="line"><a name="l11272"></a><span class="lineno">11272</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(prefix)) {</div><div class="line"><a name="l11273"></a><span class="lineno">11273</span>&#160;         <span class="keywordtype">char</span> fullusername[80];</div><div class="line"><a name="l11274"></a><span class="lineno">11274</span>&#160;</div><div class="line"><a name="l11275"></a><span class="lineno">11275</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fullusername, prefix, <span class="keyword">sizeof</span>(fullusername));</div><div class="line"><a name="l11276"></a><span class="lineno">11276</span>&#160;         strncat(fullusername, mailbox, <span class="keyword">sizeof</span>(fullusername) - 1 - strlen(fullusername));</div><div class="line"><a name="l11277"></a><span class="lineno">11277</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(mailbox, fullusername, mailbox_size);</div><div class="line"><a name="l11278"></a><span class="lineno">11278</span>&#160;      }</div><div class="line"><a name="l11279"></a><span class="lineno">11279</span>&#160;</div><div class="line"><a name="l11280"></a><span class="lineno">11280</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Before find user for mailbox %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l11281"></a><span class="lineno">11281</span>&#160;      memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l11282"></a><span class="lineno">11282</span>&#160;      vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox);</div><div class="line"><a name="l11283"></a><span class="lineno">11283</span>&#160;      <span class="keywordflow">if</span> (vmu &amp;&amp; (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[0] == <span class="charliteral">&#39;\0&#39;</span> || (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[0] == <span class="charliteral">&#39;-&#39;</span> &amp;&amp; vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[1] == <span class="charliteral">&#39;\0&#39;</span>))) {</div><div class="line"><a name="l11284"></a><span class="lineno">11284</span>&#160;         <span class="comment">/* saved password is blank, so don&#39;t bother asking */</span></div><div class="line"><a name="l11285"></a><span class="lineno">11285</span>&#160;         password[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l11286"></a><span class="lineno">11286</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11287"></a><span class="lineno">11287</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, vm_password, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan))) {</div><div class="line"><a name="l11288"></a><span class="lineno">11288</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stream password file\n&quot;</span>);</div><div class="line"><a name="l11289"></a><span class="lineno">11289</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11290"></a><span class="lineno">11290</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11291"></a><span class="lineno">11291</span>&#160;         }</div><div class="line"><a name="l11292"></a><span class="lineno">11292</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, password, <span class="keyword">sizeof</span>(password) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>) &lt; 0) {</div><div class="line"><a name="l11293"></a><span class="lineno">11293</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to read password\n&quot;</span>);</div><div class="line"><a name="l11294"></a><span class="lineno">11294</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11295"></a><span class="lineno">11295</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11296"></a><span class="lineno">11296</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (password[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l11297"></a><span class="lineno">11297</span>&#160;            <span class="comment">/* user entered &#39;*&#39; */</span></div><div class="line"><a name="l11298"></a><span class="lineno">11298</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Password begins with &#39;*&#39;, attempting jump to extension &#39;a&#39;\n&quot;</span>);</div><div class="line"><a name="l11299"></a><span class="lineno">11299</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan), <span class="stringliteral">&quot;a&quot;</span>, 1,</div><div class="line"><a name="l11300"></a><span class="lineno">11300</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.number.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l11301"></a><span class="lineno">11301</span>&#160;               mailbox[0] = <span class="charliteral">&#39;*&#39;</span>;</div><div class="line"><a name="l11302"></a><span class="lineno">11302</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11303"></a><span class="lineno">11303</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11304"></a><span class="lineno">11304</span>&#160;            }</div><div class="line"><a name="l11305"></a><span class="lineno">11305</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Jump to extension &#39;a&#39; failed; setting mailbox and user to NULL\n&quot;</span>);</div><div class="line"><a name="l11306"></a><span class="lineno">11306</span>&#160;            mailbox[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l11307"></a><span class="lineno">11307</span>&#160;            <span class="comment">/* if the password entered was &#39;*&#39;, do not let a user mailbox be created if the extension &#39;a&#39; is not defined */</span></div><div class="line"><a name="l11308"></a><span class="lineno">11308</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11309"></a><span class="lineno">11309</span>&#160;            vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l11310"></a><span class="lineno">11310</span>&#160;         }</div><div class="line"><a name="l11311"></a><span class="lineno">11311</span>&#160;      }</div><div class="line"><a name="l11312"></a><span class="lineno">11312</span>&#160;</div><div class="line"><a name="l11313"></a><span class="lineno">11313</span>&#160;      <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l11314"></a><span class="lineno">11314</span>&#160;         passptr = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>;</div><div class="line"><a name="l11315"></a><span class="lineno">11315</span>&#160;         <span class="keywordflow">if</span> (passptr[0] == <span class="charliteral">&#39;-&#39;</span>) passptr++;</div><div class="line"><a name="l11316"></a><span class="lineno">11316</span>&#160;      }</div><div class="line"><a name="l11317"></a><span class="lineno">11317</span>&#160;      <span class="keywordflow">if</span> (vmu &amp;&amp; !strcmp(passptr, password))</div><div class="line"><a name="l11318"></a><span class="lineno">11318</span>&#160;         valid++;</div><div class="line"><a name="l11319"></a><span class="lineno">11319</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l11320"></a><span class="lineno">11320</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Incorrect password &#39;%s&#39; for user &#39;%s&#39; (context = %s)\n&quot;</span>, password, mailbox, context ? context : <span class="stringliteral">&quot;default&quot;</span>);</div><div class="line"><a name="l11321"></a><span class="lineno">11321</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(prefix))</div><div class="line"><a name="l11322"></a><span class="lineno">11322</span>&#160;            mailbox[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l11323"></a><span class="lineno">11323</span>&#160;      }</div><div class="line"><a name="l11324"></a><span class="lineno">11324</span>&#160;      logretries++;</div><div class="line"><a name="l11325"></a><span class="lineno">11325</span>&#160;      <span class="keywordflow">if</span> (!valid) {</div><div class="line"><a name="l11326"></a><span class="lineno">11326</span>&#160;         <span class="keywordflow">if</span> (skipuser || logretries &gt;= max_logins) {</div><div class="line"><a name="l11327"></a><span class="lineno">11327</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-incorrect&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan))) {</div><div class="line"><a name="l11328"></a><span class="lineno">11328</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stream incorrect message\n&quot;</span>);</div><div class="line"><a name="l11329"></a><span class="lineno">11329</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11330"></a><span class="lineno">11330</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11331"></a><span class="lineno">11331</span>&#160;            }</div><div class="line"><a name="l11332"></a><span class="lineno">11332</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>)) {  <span class="comment">/* Channel is hung up */</span></div><div class="line"><a name="l11333"></a><span class="lineno">11333</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11334"></a><span class="lineno">11334</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11335"></a><span class="lineno">11335</span>&#160;            }</div><div class="line"><a name="l11336"></a><span class="lineno">11336</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11337"></a><span class="lineno">11337</span>&#160;            <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l11338"></a><span class="lineno">11338</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a>(chan);</div><div class="line"><a name="l11339"></a><span class="lineno">11339</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-incorrect-mailbox&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan))) {</div><div class="line"><a name="l11340"></a><span class="lineno">11340</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stream incorrect mailbox message\n&quot;</span>);</div><div class="line"><a name="l11341"></a><span class="lineno">11341</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11342"></a><span class="lineno">11342</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11343"></a><span class="lineno">11343</span>&#160;            }</div><div class="line"><a name="l11344"></a><span class="lineno">11344</span>&#160;         }</div><div class="line"><a name="l11345"></a><span class="lineno">11345</span>&#160;      }</div><div class="line"><a name="l11346"></a><span class="lineno">11346</span>&#160;   }</div><div class="line"><a name="l11347"></a><span class="lineno">11347</span>&#160;   <span class="keywordflow">if</span> (!valid &amp;&amp; (logretries &gt;= max_logins)) {</div><div class="line"><a name="l11348"></a><span class="lineno">11348</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line"><a name="l11349"></a><span class="lineno">11349</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);</div><div class="line"><a name="l11350"></a><span class="lineno">11350</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11351"></a><span class="lineno">11351</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11352"></a><span class="lineno">11352</span>&#160;   }</div><div class="line"><a name="l11353"></a><span class="lineno">11353</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; !skipuser) {</div><div class="line"><a name="l11354"></a><span class="lineno">11354</span>&#160;      *res_vmu = *vmu;</div><div class="line"><a name="l11355"></a><span class="lineno">11355</span>&#160;   }</div><div class="line"><a name="l11356"></a><span class="lineno">11356</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l11357"></a><span class="lineno">11357</span>&#160;}</div><div class="line"><a name="l11358"></a><span class="lineno">11358</span>&#160;</div><div class="line"><a name="l11359"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a878d95a3422bae307725f76c13fb62de">11359</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a878d95a3422bae307725f76c13fb62de">play_message_by_id_helper</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line"><a name="l11360"></a><span class="lineno">11360</span>&#160;   <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu,</div><div class="line"><a name="l11361"></a><span class="lineno">11361</span>&#160;   <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms,</div><div class="line"><a name="l11362"></a><span class="lineno">11362</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id)</div><div class="line"><a name="l11363"></a><span class="lineno">11363</span>&#160;{</div><div class="line"><a name="l11364"></a><span class="lineno">11364</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(vms, &amp;msg_id, 1, &amp;vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu)) {</div><div class="line"><a name="l11365"></a><span class="lineno">11365</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11366"></a><span class="lineno">11366</span>&#160;   }</div><div class="line"><a name="l11367"></a><span class="lineno">11367</span>&#160;   <span class="comment">/* Found the msg, so play it back */</span></div><div class="line"><a name="l11368"></a><span class="lineno">11368</span>&#160;</div><div class="line"><a name="l11369"></a><span class="lineno">11369</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l11370"></a><span class="lineno">11370</span>&#160;</div><div class="line"><a name="l11371"></a><span class="lineno">11371</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11372"></a><span class="lineno">11372</span>&#160;   <span class="comment">/*IMAP storage stores any prepended message from a forward</span></div><div class="line"><a name="l11373"></a><span class="lineno">11373</span>&#160;<span class="comment">    * as a separate file from the rest of the message</span></div><div class="line"><a name="l11374"></a><span class="lineno">11374</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l11375"></a><span class="lineno">11375</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vms-&gt;introfn) &amp;&amp; <a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(vms-&gt;introfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l11376"></a><span class="lineno">11376</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;introfn);</div><div class="line"><a name="l11377"></a><span class="lineno">11377</span>&#160;   }</div><div class="line"><a name="l11378"></a><span class="lineno">11378</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11379"></a><span class="lineno">11379</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>,vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>,vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l11380"></a><span class="lineno">11380</span>&#160;</div><div class="line"><a name="l11381"></a><span class="lineno">11381</span>&#160;   <span class="keywordflow">if</span> ((<a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>)) &lt; 0) {</div><div class="line"><a name="l11382"></a><span class="lineno">11382</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Playback of message %s failed\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l11383"></a><span class="lineno">11383</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11384"></a><span class="lineno">11384</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11385"></a><span class="lineno">11385</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l11386"></a><span class="lineno">11386</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11387"></a><span class="lineno">11387</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 1;</div><div class="line"><a name="l11388"></a><span class="lineno">11388</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11389"></a><span class="lineno">11389</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l11390"></a><span class="lineno">11390</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11391"></a><span class="lineno">11391</span>&#160;   }</div><div class="line"><a name="l11392"></a><span class="lineno">11392</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l11393"></a><span class="lineno">11393</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l11394"></a><span class="lineno">11394</span>&#160;}</div><div class="line"><a name="l11395"></a><span class="lineno">11395</span>&#160;<span class="comment"></span></div><div class="line"><a name="l11396"></a><span class="lineno">11396</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l11397"></a><span class="lineno">11397</span>&#160;<span class="comment"> * \brief Finds a message in a specific mailbox by msg_id and plays it to the channel</span></div><div class="line"><a name="l11398"></a><span class="lineno">11398</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l11399"></a><span class="lineno">11399</span>&#160;<span class="comment"> * \retval 0 Success</span></div><div class="line"><a name="l11400"></a><span class="lineno">11400</span>&#160;<span class="comment"> * \retval -1 Failure</span></div><div class="line"><a name="l11401"></a><span class="lineno">11401</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l11402"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa5c83ea260e72cddc8570b487f766dca">11402</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5c83ea260e72cddc8570b487f766dca">play_message_by_id</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id)</div><div class="line"><a name="l11403"></a><span class="lineno">11403</span>&#160;{</div><div class="line"><a name="l11404"></a><span class="lineno">11404</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms;</div><div class="line"><a name="l11405"></a><span class="lineno">11405</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus;</div><div class="line"><a name="l11406"></a><span class="lineno">11406</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l11407"></a><span class="lineno">11407</span>&#160;   <span class="keywordtype">int</span> open = 0;</div><div class="line"><a name="l11408"></a><span class="lineno">11408</span>&#160;   <span class="keywordtype">int</span> played = 0;</div><div class="line"><a name="l11409"></a><span class="lineno">11409</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l11410"></a><span class="lineno">11410</span>&#160;</div><div class="line"><a name="l11411"></a><span class="lineno">11411</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l11412"></a><span class="lineno">11412</span>&#160;   memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));</div><div class="line"><a name="l11413"></a><span class="lineno">11413</span>&#160;</div><div class="line"><a name="l11414"></a><span class="lineno">11414</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox))) {</div><div class="line"><a name="l11415"></a><span class="lineno">11415</span>&#160;      <span class="keywordflow">goto</span> play_msg_cleanup;</div><div class="line"><a name="l11416"></a><span class="lineno">11416</span>&#160;   }</div><div class="line"><a name="l11417"></a><span class="lineno">11417</span>&#160;</div><div class="line"><a name="l11418"></a><span class="lineno">11418</span>&#160;   <span class="comment">/* Iterate through every folder, find the msg, and play it */</span></div><div class="line"><a name="l11419"></a><span class="lineno">11419</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mailbox_folders) &amp;&amp; !played; i++) {</div><div class="line"><a name="l11420"></a><span class="lineno">11420</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, mailbox, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l11421"></a><span class="lineno">11421</span>&#160;      vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l11422"></a><span class="lineno">11422</span>&#160;</div><div class="line"><a name="l11423"></a><span class="lineno">11423</span>&#160;      <span class="comment">/* open the mailbox state */</span></div><div class="line"><a name="l11424"></a><span class="lineno">11424</span>&#160;      <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, i)) &lt; 0) {</div><div class="line"><a name="l11425"></a><span class="lineno">11425</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not open mailbox %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l11426"></a><span class="lineno">11426</span>&#160;         res = -1;</div><div class="line"><a name="l11427"></a><span class="lineno">11427</span>&#160;         <span class="keywordflow">goto</span> play_msg_cleanup;</div><div class="line"><a name="l11428"></a><span class="lineno">11428</span>&#160;      }</div><div class="line"><a name="l11429"></a><span class="lineno">11429</span>&#160;      open = 1;</div><div class="line"><a name="l11430"></a><span class="lineno">11430</span>&#160;</div><div class="line"><a name="l11431"></a><span class="lineno">11431</span>&#160;      <span class="comment">/* play msg if it exists in this mailbox */</span></div><div class="line"><a name="l11432"></a><span class="lineno">11432</span>&#160;      <span class="keywordflow">if</span> ((vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> != -1) &amp;&amp; !(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a878d95a3422bae307725f76c13fb62de">play_message_by_id_helper</a>(chan, vmu, &amp;vms, msg_id))) {</div><div class="line"><a name="l11433"></a><span class="lineno">11433</span>&#160;         played = 1;</div><div class="line"><a name="l11434"></a><span class="lineno">11434</span>&#160;      }</div><div class="line"><a name="l11435"></a><span class="lineno">11435</span>&#160;</div><div class="line"><a name="l11436"></a><span class="lineno">11436</span>&#160;      <span class="comment">/* close mailbox */</span></div><div class="line"><a name="l11437"></a><span class="lineno">11437</span>&#160;      <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu) == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)) {</div><div class="line"><a name="l11438"></a><span class="lineno">11438</span>&#160;         res = -1;</div><div class="line"><a name="l11439"></a><span class="lineno">11439</span>&#160;         <span class="keywordflow">goto</span> play_msg_cleanup;</div><div class="line"><a name="l11440"></a><span class="lineno">11440</span>&#160;      }</div><div class="line"><a name="l11441"></a><span class="lineno">11441</span>&#160;      open = 0;</div><div class="line"><a name="l11442"></a><span class="lineno">11442</span>&#160;   }</div><div class="line"><a name="l11443"></a><span class="lineno">11443</span>&#160;</div><div class="line"><a name="l11444"></a><span class="lineno">11444</span>&#160;play_msg_cleanup:</div><div class="line"><a name="l11445"></a><span class="lineno">11445</span>&#160;   <span class="keywordflow">if</span> (!played) {</div><div class="line"><a name="l11446"></a><span class="lineno">11446</span>&#160;      res = -1;</div><div class="line"><a name="l11447"></a><span class="lineno">11447</span>&#160;   }</div><div class="line"><a name="l11448"></a><span class="lineno">11448</span>&#160;</div><div class="line"><a name="l11449"></a><span class="lineno">11449</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; open) {</div><div class="line"><a name="l11450"></a><span class="lineno">11450</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l11451"></a><span class="lineno">11451</span>&#160;   }</div><div class="line"><a name="l11452"></a><span class="lineno">11452</span>&#160;</div><div class="line"><a name="l11453"></a><span class="lineno">11453</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11454"></a><span class="lineno">11454</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l11455"></a><span class="lineno">11455</span>&#160;      vmstate_delete(&amp;vms);</div><div class="line"><a name="l11456"></a><span class="lineno">11456</span>&#160;   }</div><div class="line"><a name="l11457"></a><span class="lineno">11457</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11458"></a><span class="lineno">11458</span>&#160;</div><div class="line"><a name="l11459"></a><span class="lineno">11459</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l11460"></a><span class="lineno">11460</span>&#160;</div><div class="line"><a name="l11461"></a><span class="lineno">11461</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l11462"></a><span class="lineno">11462</span>&#160;}</div><div class="line"><a name="l11463"></a><span class="lineno">11463</span>&#160;</div><div class="line"><a name="l11464"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a54a9f8be551279c23e515e58a2bfee68">11464</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a54a9f8be551279c23e515e58a2bfee68">vm_playmsgexec</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line"><a name="l11465"></a><span class="lineno">11465</span>&#160;{</div><div class="line"><a name="l11466"></a><span class="lineno">11466</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;</div><div class="line"><a name="l11467"></a><span class="lineno">11467</span>&#160;   <span class="keywordtype">char</span> *mailbox = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l11468"></a><span class="lineno">11468</span>&#160;   <span class="keywordtype">char</span> *context = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l11469"></a><span class="lineno">11469</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l11470"></a><span class="lineno">11470</span>&#160;</div><div class="line"><a name="l11471"></a><span class="lineno">11471</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2">AST_DECLARE_APP_ARGS</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>,</div><div class="line"><a name="l11472"></a><span class="lineno">11472</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(mailbox);</div><div class="line"><a name="l11473"></a><span class="lineno">11473</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(msg_id);</div><div class="line"><a name="l11474"></a><span class="lineno">11474</span>&#160;   );</div><div class="line"><a name="l11475"></a><span class="lineno">11475</span>&#160;</div><div class="line"><a name="l11476"></a><span class="lineno">11476</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660">ast_channel_state</a>(chan) != <a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {</div><div class="line"><a name="l11477"></a><span class="lineno">11477</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Before ast_answer\n&quot;</span>);</div><div class="line"><a name="l11478"></a><span class="lineno">11478</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#aec583a3e25358ee552a4f3df53914cd0">ast_answer</a>(chan);</div><div class="line"><a name="l11479"></a><span class="lineno">11479</span>&#160;   }</div><div class="line"><a name="l11480"></a><span class="lineno">11480</span>&#160;</div><div class="line"><a name="l11481"></a><span class="lineno">11481</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(data)) {</div><div class="line"><a name="l11482"></a><span class="lineno">11482</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11483"></a><span class="lineno">11483</span>&#160;   }</div><div class="line"><a name="l11484"></a><span class="lineno">11484</span>&#160;</div><div class="line"><a name="l11485"></a><span class="lineno">11485</span>&#160;   parse = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(data);</div><div class="line"><a name="l11486"></a><span class="lineno">11486</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8">AST_STANDARD_APP_ARGS</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>, parse);</div><div class="line"><a name="l11487"></a><span class="lineno">11487</span>&#160;</div><div class="line"><a name="l11488"></a><span class="lineno">11488</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.mailbox) || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.msg_id)) {</div><div class="line"><a name="l11489"></a><span class="lineno">11489</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11490"></a><span class="lineno">11490</span>&#160;   }</div><div class="line"><a name="l11491"></a><span class="lineno">11491</span>&#160;</div><div class="line"><a name="l11492"></a><span class="lineno">11492</span>&#160;   <span class="keywordflow">if</span> ((context = strchr(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.mailbox, <span class="charliteral">&#39;@&#39;</span>))) {</div><div class="line"><a name="l11493"></a><span class="lineno">11493</span>&#160;      *context++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l11494"></a><span class="lineno">11494</span>&#160;   }</div><div class="line"><a name="l11495"></a><span class="lineno">11495</span>&#160;   mailbox = <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.mailbox;</div><div class="line"><a name="l11496"></a><span class="lineno">11496</span>&#160;</div><div class="line"><a name="l11497"></a><span class="lineno">11497</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5c83ea260e72cddc8570b487f766dca">play_message_by_id</a>(chan, mailbox, context, <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.msg_id);</div><div class="line"><a name="l11498"></a><span class="lineno">11498</span>&#160;   <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VOICEMAIL_PLAYBACKSTATUS&quot;</span>, res ? <span class="stringliteral">&quot;FAILED&quot;</span> : <span class="stringliteral">&quot;SUCCESS&quot;</span>);</div><div class="line"><a name="l11499"></a><span class="lineno">11499</span>&#160;</div><div class="line"><a name="l11500"></a><span class="lineno">11500</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l11501"></a><span class="lineno">11501</span>&#160;}</div><div class="line"><a name="l11502"></a><span class="lineno">11502</span>&#160;</div><div class="line"><a name="l11503"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a31a8413227dec93cd93ebd54bc3b42c7">11503</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a31a8413227dec93cd93ebd54bc3b42c7">vm_execmain</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line"><a name="l11504"></a><span class="lineno">11504</span>&#160;{</div><div class="line"><a name="l11505"></a><span class="lineno">11505</span>&#160;   <span class="comment">/* XXX This is, admittedly, some pretty horrendous code.  For some</span></div><div class="line"><a name="l11506"></a><span class="lineno">11506</span>&#160;<span class="comment">      reason it just seemed a lot easier to do with GOTO&#39;s.  I feel</span></div><div class="line"><a name="l11507"></a><span class="lineno">11507</span>&#160;<span class="comment">      like I&#39;m back in my GWBASIC days. XXX */</span></div><div class="line"><a name="l11508"></a><span class="lineno">11508</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l11509"></a><span class="lineno">11509</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l11510"></a><span class="lineno">11510</span>&#160;   <span class="keywordtype">int</span> valid = 0;</div><div class="line"><a name="l11511"></a><span class="lineno">11511</span>&#160;   <span class="keywordtype">char</span> prefixstr[80] =<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l11512"></a><span class="lineno">11512</span>&#160;   <span class="keywordtype">char</span> ext_context[256]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l11513"></a><span class="lineno">11513</span>&#160;   <span class="keywordtype">int</span> box;</div><div class="line"><a name="l11514"></a><span class="lineno">11514</span>&#160;   <span class="keywordtype">int</span> useadsi = 0;</div><div class="line"><a name="l11515"></a><span class="lineno">11515</span>&#160;   <span class="keywordtype">int</span> skipuser = 0;</div><div class="line"><a name="l11516"></a><span class="lineno">11516</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms = {{0}};</div><div class="line"><a name="l11517"></a><span class="lineno">11517</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus = {{0}};</div><div class="line"><a name="l11518"></a><span class="lineno">11518</span>&#160;   <span class="keywordtype">char</span> *context = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l11519"></a><span class="lineno">11519</span>&#160;   <span class="keywordtype">int</span> silentexit = 0;</div><div class="line"><a name="l11520"></a><span class="lineno">11520</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> flags = { 0 };</div><div class="line"><a name="l11521"></a><span class="lineno">11521</span>&#160;   <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain = 0;</div><div class="line"><a name="l11522"></a><span class="lineno">11522</span>&#160;   <span class="keywordtype">int</span> play_auto = 0;</div><div class="line"><a name="l11523"></a><span class="lineno">11523</span>&#160;   <span class="keywordtype">int</span> play_folder = 0;</div><div class="line"><a name="l11524"></a><span class="lineno">11524</span>&#160;   <span class="keywordtype">int</span> in_urgent = 0;</div><div class="line"><a name="l11525"></a><span class="lineno">11525</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11526"></a><span class="lineno">11526</span>&#160;   <span class="keywordtype">int</span> deleted = 0;</div><div class="line"><a name="l11527"></a><span class="lineno">11527</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11528"></a><span class="lineno">11528</span>&#160;</div><div class="line"><a name="l11529"></a><span class="lineno">11529</span>&#160;   <span class="comment">/* Add the vm_state to the active list and keep it active */</span></div><div class="line"><a name="l11530"></a><span class="lineno">11530</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l11531"></a><span class="lineno">11531</span>&#160;</div><div class="line"><a name="l11532"></a><span class="lineno">11532</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;START&quot;</span>, <span class="stringliteral">&quot;Message: vm_execmain started&quot;</span>);</div><div class="line"><a name="l11533"></a><span class="lineno">11533</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660">ast_channel_state</a>(chan) != <a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {</div><div class="line"><a name="l11534"></a><span class="lineno">11534</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Before ast_answer\n&quot;</span>);</div><div class="line"><a name="l11535"></a><span class="lineno">11535</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#aec583a3e25358ee552a4f3df53914cd0">ast_answer</a>(chan);</div><div class="line"><a name="l11536"></a><span class="lineno">11536</span>&#160;   }</div><div class="line"><a name="l11537"></a><span class="lineno">11537</span>&#160;</div><div class="line"><a name="l11538"></a><span class="lineno">11538</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(data)) {</div><div class="line"><a name="l11539"></a><span class="lineno">11539</span>&#160;      <span class="keywordtype">char</span> *opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>];</div><div class="line"><a name="l11540"></a><span class="lineno">11540</span>&#160;      <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;</div><div class="line"><a name="l11541"></a><span class="lineno">11541</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2">AST_DECLARE_APP_ARGS</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>,</div><div class="line"><a name="l11542"></a><span class="lineno">11542</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(argv0);</div><div class="line"><a name="l11543"></a><span class="lineno">11543</span>&#160;         <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(argv1);</div><div class="line"><a name="l11544"></a><span class="lineno">11544</span>&#160;      );</div><div class="line"><a name="l11545"></a><span class="lineno">11545</span>&#160;</div><div class="line"><a name="l11546"></a><span class="lineno">11546</span>&#160;      parse = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(data);</div><div class="line"><a name="l11547"></a><span class="lineno">11547</span>&#160;</div><div class="line"><a name="l11548"></a><span class="lineno">11548</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8">AST_STANDARD_APP_ARGS</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>, parse);</div><div class="line"><a name="l11549"></a><span class="lineno">11549</span>&#160;</div><div class="line"><a name="l11550"></a><span class="lineno">11550</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argc == 2) {</div><div class="line"><a name="l11551"></a><span class="lineno">11551</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb">ast_app_parse_options</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a59fa4e60d6824425c6874fa59b1dd56a">vm_app_options</a>, &amp;flags, opts, <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv1))</div><div class="line"><a name="l11552"></a><span class="lineno">11552</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11553"></a><span class="lineno">11553</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a>)) {</div><div class="line"><a name="l11554"></a><span class="lineno">11554</span>&#160;            <span class="keywordtype">int</span> gain;</div><div class="line"><a name="l11555"></a><span class="lineno">11555</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a>])) {</div><div class="line"><a name="l11556"></a><span class="lineno">11556</span>&#160;               <span class="keywordflow">if</span> (sscanf(opts[OPT_ARG_RECORDGAIN], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;gain) != 1) {</div><div class="line"><a name="l11557"></a><span class="lineno">11557</span>&#160;                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &#39;%s&#39; provided for record gain option\n&quot;</span>, opts[OPT_ARG_RECORDGAIN]);</div><div class="line"><a name="l11558"></a><span class="lineno">11558</span>&#160;                  <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l11559"></a><span class="lineno">11559</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11560"></a><span class="lineno">11560</span>&#160;                  record_gain = (<span class="keywordtype">signed</span> char) gain;</div><div class="line"><a name="l11561"></a><span class="lineno">11561</span>&#160;               }</div><div class="line"><a name="l11562"></a><span class="lineno">11562</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11563"></a><span class="lineno">11563</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid Gain level set with option g\n&quot;</span>);</div><div class="line"><a name="l11564"></a><span class="lineno">11564</span>&#160;            }</div><div class="line"><a name="l11565"></a><span class="lineno">11565</span>&#160;         }</div><div class="line"><a name="l11566"></a><span class="lineno">11566</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a>) ) {</div><div class="line"><a name="l11567"></a><span class="lineno">11567</span>&#160;            play_auto = 1;</div><div class="line"><a name="l11568"></a><span class="lineno">11568</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a>])) {</div><div class="line"><a name="l11569"></a><span class="lineno">11569</span>&#160;               <span class="comment">/* See if it is a folder name first */</span></div><div class="line"><a name="l11570"></a><span class="lineno">11570</span>&#160;               <span class="keywordflow">if</span> (isdigit(opts[OPT_ARG_PLAYFOLDER][0])) {</div><div class="line"><a name="l11571"></a><span class="lineno">11571</span>&#160;                  <span class="keywordflow">if</span> (sscanf(opts[OPT_ARG_PLAYFOLDER], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;play_folder) != 1) {</div><div class="line"><a name="l11572"></a><span class="lineno">11572</span>&#160;                     play_folder = -1;</div><div class="line"><a name="l11573"></a><span class="lineno">11573</span>&#160;                  }</div><div class="line"><a name="l11574"></a><span class="lineno">11574</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11575"></a><span class="lineno">11575</span>&#160;                  play_folder = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(opts[OPT_ARG_PLAYFOLDER]);</div><div class="line"><a name="l11576"></a><span class="lineno">11576</span>&#160;               }</div><div class="line"><a name="l11577"></a><span class="lineno">11577</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11578"></a><span class="lineno">11578</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid folder set with option a\n&quot;</span>);</div><div class="line"><a name="l11579"></a><span class="lineno">11579</span>&#160;            }</div><div class="line"><a name="l11580"></a><span class="lineno">11580</span>&#160;            <span class="keywordflow">if</span> (play_folder &gt; 9 || play_folder &lt; 0) {</div><div class="line"><a name="l11581"></a><span class="lineno">11581</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>,</div><div class="line"><a name="l11582"></a><span class="lineno">11582</span>&#160;                  <span class="stringliteral">&quot;Invalid value &#39;%s&#39; provided for folder autoplay option. Defaulting to &#39;INBOX&#39;\n&quot;</span>,</div><div class="line"><a name="l11583"></a><span class="lineno">11583</span>&#160;                  opts[OPT_ARG_PLAYFOLDER]);</div><div class="line"><a name="l11584"></a><span class="lineno">11584</span>&#160;               play_folder = 0;</div><div class="line"><a name="l11585"></a><span class="lineno">11585</span>&#160;            }</div><div class="line"><a name="l11586"></a><span class="lineno">11586</span>&#160;         }</div><div class="line"><a name="l11587"></a><span class="lineno">11587</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11588"></a><span class="lineno">11588</span>&#160;         <span class="comment">/* old style options parsing */</span></div><div class="line"><a name="l11589"></a><span class="lineno">11589</span>&#160;         <span class="keywordflow">while</span> (*(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0)) {</div><div class="line"><a name="l11590"></a><span class="lineno">11590</span>&#160;            <span class="keywordflow">if</span> (*(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0) == <span class="charliteral">&#39;s&#39;</span>)</div><div class="line"><a name="l11591"></a><span class="lineno">11591</span>&#160;               <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);</div><div class="line"><a name="l11592"></a><span class="lineno">11592</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0) == <span class="charliteral">&#39;p&#39;</span>)</div><div class="line"><a name="l11593"></a><span class="lineno">11593</span>&#160;               <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a>);</div><div class="line"><a name="l11594"></a><span class="lineno">11594</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l11595"></a><span class="lineno">11595</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11596"></a><span class="lineno">11596</span>&#160;            (<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0)++;</div><div class="line"><a name="l11597"></a><span class="lineno">11597</span>&#160;         }</div><div class="line"><a name="l11598"></a><span class="lineno">11598</span>&#160;</div><div class="line"><a name="l11599"></a><span class="lineno">11599</span>&#160;      }</div><div class="line"><a name="l11600"></a><span class="lineno">11600</span>&#160;</div><div class="line"><a name="l11601"></a><span class="lineno">11601</span>&#160;      valid = <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);</div><div class="line"><a name="l11602"></a><span class="lineno">11602</span>&#160;</div><div class="line"><a name="l11603"></a><span class="lineno">11603</span>&#160;      <span class="keywordflow">if</span> ((context = strchr(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0, <span class="charliteral">&#39;@&#39;</span>)))</div><div class="line"><a name="l11604"></a><span class="lineno">11604</span>&#160;         *context++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l11605"></a><span class="lineno">11605</span>&#160;</div><div class="line"><a name="l11606"></a><span class="lineno">11606</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a>))</div><div class="line"><a name="l11607"></a><span class="lineno">11607</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(prefixstr, <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0, <span class="keyword">sizeof</span>(prefixstr));</div><div class="line"><a name="l11608"></a><span class="lineno">11608</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l11609"></a><span class="lineno">11609</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l11610"></a><span class="lineno">11610</span>&#160;</div><div class="line"><a name="l11611"></a><span class="lineno">11611</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>) &amp;&amp; (vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context ,vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>)))</div><div class="line"><a name="l11612"></a><span class="lineno">11612</span>&#160;         skipuser++;</div><div class="line"><a name="l11613"></a><span class="lineno">11613</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l11614"></a><span class="lineno">11614</span>&#160;         valid = 0;</div><div class="line"><a name="l11615"></a><span class="lineno">11615</span>&#160;   }</div><div class="line"><a name="l11616"></a><span class="lineno">11616</span>&#160;</div><div class="line"><a name="l11617"></a><span class="lineno">11617</span>&#160;   <span class="keywordflow">if</span> (!valid)</div><div class="line"><a name="l11618"></a><span class="lineno">11618</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a>(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>), &amp;vmus, context, prefixstr, skipuser, maxlogins, 0);</div><div class="line"><a name="l11619"></a><span class="lineno">11619</span>&#160;</div><div class="line"><a name="l11620"></a><span class="lineno">11620</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;After vm_authenticate\n&quot;</span>);</div><div class="line"><a name="l11621"></a><span class="lineno">11621</span>&#160;</div><div class="line"><a name="l11622"></a><span class="lineno">11622</span>&#160;   <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l11623"></a><span class="lineno">11623</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;user pressed * in context &#39;%s&#39;\n&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan));</div><div class="line"><a name="l11624"></a><span class="lineno">11624</span>&#160;</div><div class="line"><a name="l11625"></a><span class="lineno">11625</span>&#160;      <span class="comment">/* user entered &#39;*&#39; */</span></div><div class="line"><a name="l11626"></a><span class="lineno">11626</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../db/de0/pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan), <span class="stringliteral">&quot;a&quot;</span>, 1)) {</div><div class="line"><a name="l11627"></a><span class="lineno">11627</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;REDIRECT&quot;</span>, <span class="stringliteral">&quot;Message: redirecting user to &#39;a&#39; extension&quot;</span>);</div><div class="line"><a name="l11628"></a><span class="lineno">11628</span>&#160;         res = 0; <span class="comment">/* prevent hangup */</span></div><div class="line"><a name="l11629"></a><span class="lineno">11629</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11630"></a><span class="lineno">11630</span>&#160;      }</div><div class="line"><a name="l11631"></a><span class="lineno">11631</span>&#160;   }</div><div class="line"><a name="l11632"></a><span class="lineno">11632</span>&#160;</div><div class="line"><a name="l11633"></a><span class="lineno">11633</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l11634"></a><span class="lineno">11634</span>&#160;      valid = 1;</div><div class="line"><a name="l11635"></a><span class="lineno">11635</span>&#160;      <span class="keywordflow">if</span> (!skipuser)</div><div class="line"><a name="l11636"></a><span class="lineno">11636</span>&#160;         vmu = &amp;vmus;</div><div class="line"><a name="l11637"></a><span class="lineno">11637</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11638"></a><span class="lineno">11638</span>&#160;      res = 0;</div><div class="line"><a name="l11639"></a><span class="lineno">11639</span>&#160;   }</div><div class="line"><a name="l11640"></a><span class="lineno">11640</span>&#160;</div><div class="line"><a name="l11641"></a><span class="lineno">11641</span>&#160;   <span class="comment">/* If ADSI is supported, setup login screen */</span></div><div class="line"><a name="l11642"></a><span class="lineno">11642</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a>(chan, &amp;useadsi);</div><div class="line"><a name="l11643"></a><span class="lineno">11643</span>&#160;</div><div class="line"><a name="l11644"></a><span class="lineno">11644</span>&#160;   <span class="keywordflow">if</span> (!valid) {</div><div class="line"><a name="l11645"></a><span class="lineno">11645</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11646"></a><span class="lineno">11646</span>&#160;   }</div><div class="line"><a name="l11647"></a><span class="lineno">11647</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;AUTHENTICATED&quot;</span>, <span class="stringliteral">&quot;Message: vm_user authenticated&quot;</span>);</div><div class="line"><a name="l11648"></a><span class="lineno">11648</span>&#160;</div><div class="line"><a name="l11649"></a><span class="lineno">11649</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11650"></a><span class="lineno">11650</span>&#160;   pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);</div><div class="line"><a name="l11651"></a><span class="lineno">11651</span>&#160;   pthread_setspecific(ts_vmstate.key, &amp;vms);</div><div class="line"><a name="l11652"></a><span class="lineno">11652</span>&#160;</div><div class="line"><a name="l11653"></a><span class="lineno">11653</span>&#160;   vms.interactive = 1;</div><div class="line"><a name="l11654"></a><span class="lineno">11654</span>&#160;   vms.updated = 1;</div><div class="line"><a name="l11655"></a><span class="lineno">11655</span>&#160;   <span class="keywordflow">if</span> (vmu)</div><div class="line"><a name="l11656"></a><span class="lineno">11656</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>));</div><div class="line"><a name="l11657"></a><span class="lineno">11657</span>&#160;   vmstate_insert(&amp;vms);</div><div class="line"><a name="l11658"></a><span class="lineno">11658</span>&#160;   init_vm_state(&amp;vms);</div><div class="line"><a name="l11659"></a><span class="lineno">11659</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11660"></a><span class="lineno">11660</span>&#160;</div><div class="line"><a name="l11661"></a><span class="lineno">11661</span>&#160;   <span class="comment">/* Set language from config to override channel language */</span></div><div class="line"><a name="l11662"></a><span class="lineno">11662</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>)) {</div><div class="line"><a name="l11663"></a><span class="lineno">11663</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#a493bdebe876caafb8ee535853310364a">ast_channel_lock</a>(chan);</div><div class="line"><a name="l11664"></a><span class="lineno">11664</span>&#160;      ast_channel_language_set(chan, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);</div><div class="line"><a name="l11665"></a><span class="lineno">11665</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#af476c537b29be3f29240489032f9db39">ast_channel_unlock</a>(chan);</div><div class="line"><a name="l11666"></a><span class="lineno">11666</span>&#160;   }</div><div class="line"><a name="l11667"></a><span class="lineno">11667</span>&#160;</div><div class="line"><a name="l11668"></a><span class="lineno">11668</span>&#160;   <span class="comment">/* Retrieve urgent, old and new message counts */</span></div><div class="line"><a name="l11669"></a><span class="lineno">11669</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Before open_mailbox\n&quot;</span>);</div><div class="line"><a name="l11670"></a><span class="lineno">11670</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>); <span class="comment">/* Count all messages, even Urgent */</span></div><div class="line"><a name="l11671"></a><span class="lineno">11671</span>&#160;   <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11672"></a><span class="lineno">11672</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11673"></a><span class="lineno">11673</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1;</div><div class="line"><a name="l11674"></a><span class="lineno">11674</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Number of old messages: %d\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>);</div><div class="line"><a name="l11675"></a><span class="lineno">11675</span>&#160;   <span class="comment">/* check INBOX */</span></div><div class="line"><a name="l11676"></a><span class="lineno">11676</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);</div><div class="line"><a name="l11677"></a><span class="lineno">11677</span>&#160;   <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11678"></a><span class="lineno">11678</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11679"></a><span class="lineno">11679</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1;</div><div class="line"><a name="l11680"></a><span class="lineno">11680</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Number of new messages: %d\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>);</div><div class="line"><a name="l11681"></a><span class="lineno">11681</span>&#160;   <span class="comment">/* Start in Urgent */</span></div><div class="line"><a name="l11682"></a><span class="lineno">11682</span>&#160;   in_urgent = 1;</div><div class="line"><a name="l11683"></a><span class="lineno">11683</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, 11); <span class="comment">/*11 is the Urgent folder */</span></div><div class="line"><a name="l11684"></a><span class="lineno">11684</span>&#160;   <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11685"></a><span class="lineno">11685</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11686"></a><span class="lineno">11686</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> = vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1;</div><div class="line"><a name="l11687"></a><span class="lineno">11687</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Number of urgent messages: %d\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>);</div><div class="line"><a name="l11688"></a><span class="lineno">11688</span>&#160;</div><div class="line"><a name="l11689"></a><span class="lineno">11689</span>&#160;   <span class="comment">/* Select proper mailbox FIRST!! */</span></div><div class="line"><a name="l11690"></a><span class="lineno">11690</span>&#160;   <span class="keywordflow">if</span> (play_auto) {</div><div class="line"><a name="l11691"></a><span class="lineno">11691</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;AUTOPLAY&quot;</span>, <span class="stringliteral">&quot;Message: auto-playing messages&quot;</span>);</div><div class="line"><a name="l11692"></a><span class="lineno">11692</span>&#160;      <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {</div><div class="line"><a name="l11693"></a><span class="lineno">11693</span>&#160;         in_urgent = 1;</div><div class="line"><a name="l11694"></a><span class="lineno">11694</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, 11);</div><div class="line"><a name="l11695"></a><span class="lineno">11695</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11696"></a><span class="lineno">11696</span>&#160;         in_urgent = 0;</div><div class="line"><a name="l11697"></a><span class="lineno">11697</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, play_folder);</div><div class="line"><a name="l11698"></a><span class="lineno">11698</span>&#160;      }</div><div class="line"><a name="l11699"></a><span class="lineno">11699</span>&#160;      <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11700"></a><span class="lineno">11700</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11701"></a><span class="lineno">11701</span>&#160;</div><div class="line"><a name="l11702"></a><span class="lineno">11702</span>&#160;      <span class="comment">/* If there are no new messages, inform the user and hangup */</span></div><div class="line"><a name="l11703"></a><span class="lineno">11703</span>&#160;      <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> == -1) {</div><div class="line"><a name="l11704"></a><span class="lineno">11704</span>&#160;         in_urgent = 0;</div><div class="line"><a name="l11705"></a><span class="lineno">11705</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7">vm_browse_messages</a>(chan, &amp;vms, vmu);</div><div class="line"><a name="l11706"></a><span class="lineno">11706</span>&#160;         res = 0;</div><div class="line"><a name="l11707"></a><span class="lineno">11707</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11708"></a><span class="lineno">11708</span>&#160;      }</div><div class="line"><a name="l11709"></a><span class="lineno">11709</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11710"></a><span class="lineno">11710</span>&#160;      <span class="keywordflow">if</span> (!vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {</div><div class="line"><a name="l11711"></a><span class="lineno">11711</span>&#160;         <span class="comment">/* If we only have old messages start here */</span></div><div class="line"><a name="l11712"></a><span class="lineno">11712</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>); <span class="comment">/* Count all messages, even Urgent */</span></div><div class="line"><a name="l11713"></a><span class="lineno">11713</span>&#160;         in_urgent = 0;</div><div class="line"><a name="l11714"></a><span class="lineno">11714</span>&#160;         play_folder = 1;</div><div class="line"><a name="l11715"></a><span class="lineno">11715</span>&#160;         <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11716"></a><span class="lineno">11716</span>&#160;            <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11717"></a><span class="lineno">11717</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {</div><div class="line"><a name="l11718"></a><span class="lineno">11718</span>&#160;         <span class="comment">/* If we have new messages but none are urgent */</span></div><div class="line"><a name="l11719"></a><span class="lineno">11719</span>&#160;         in_urgent = 0;</div><div class="line"><a name="l11720"></a><span class="lineno">11720</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);</div><div class="line"><a name="l11721"></a><span class="lineno">11721</span>&#160;         <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11722"></a><span class="lineno">11722</span>&#160;            <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11723"></a><span class="lineno">11723</span>&#160;      }</div><div class="line"><a name="l11724"></a><span class="lineno">11724</span>&#160;   }</div><div class="line"><a name="l11725"></a><span class="lineno">11725</span>&#160;</div><div class="line"><a name="l11726"></a><span class="lineno">11726</span>&#160;   <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l11727"></a><span class="lineno">11727</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a>(chan, &amp;vms);</div><div class="line"><a name="l11728"></a><span class="lineno">11728</span>&#160;   res = 0;</div><div class="line"><a name="l11729"></a><span class="lineno">11729</span>&#160;</div><div class="line"><a name="l11730"></a><span class="lineno">11730</span>&#160;   <span class="comment">/* Check to see if this is a new user */</span></div><div class="line"><a name="l11731"></a><span class="lineno">11731</span>&#160;   <span class="keywordflow">if</span> (!strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>) &amp;&amp;</div><div class="line"><a name="l11732"></a><span class="lineno">11732</span>&#160;      (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>))) {</div><div class="line"><a name="l11733"></a><span class="lineno">11733</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, vm_newuser) == -1)</div><div class="line"><a name="l11734"></a><span class="lineno">11734</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&#39;t stream new user file\n&quot;</span>);</div><div class="line"><a name="l11735"></a><span class="lineno">11735</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e97aad653c098e2ccb57d624fb7f373">vm_newuser_setup</a>(chan, vmu, &amp;vms, vmfmts, record_gain);</div><div class="line"><a name="l11736"></a><span class="lineno">11736</span>&#160;      <span class="keywordflow">if</span> ((cmd == <span class="charliteral">&#39;t&#39;</span>) || (cmd == <span class="charliteral">&#39;#&#39;</span>)) {</div><div class="line"><a name="l11737"></a><span class="lineno">11737</span>&#160;         <span class="comment">/* Timeout */</span></div><div class="line"><a name="l11738"></a><span class="lineno">11738</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;TIMEOUT&quot;</span>, <span class="stringliteral">&quot;Message: response from user timed out&quot;</span>);</div><div class="line"><a name="l11739"></a><span class="lineno">11739</span>&#160;         res = 0;</div><div class="line"><a name="l11740"></a><span class="lineno">11740</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11741"></a><span class="lineno">11741</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &lt; 0) {</div><div class="line"><a name="l11742"></a><span class="lineno">11742</span>&#160;         <span class="comment">/* Hangup */</span></div><div class="line"><a name="l11743"></a><span class="lineno">11743</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;HANGUP&quot;</span>, <span class="stringliteral">&quot;Message: hangup detected&quot;</span>);</div><div class="line"><a name="l11744"></a><span class="lineno">11744</span>&#160;         res = -1;</div><div class="line"><a name="l11745"></a><span class="lineno">11745</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11746"></a><span class="lineno">11746</span>&#160;      }</div><div class="line"><a name="l11747"></a><span class="lineno">11747</span>&#160;   }</div><div class="line"><a name="l11748"></a><span class="lineno">11748</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l11749"></a><span class="lineno">11749</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Checking quotas: comparing %u to %u\n&quot;</span>, vms.quota_usage, vms.quota_limit);</div><div class="line"><a name="l11750"></a><span class="lineno">11750</span>&#160;      <span class="keywordflow">if</span> (vms.quota_limit &amp;&amp; vms.quota_usage &gt;= vms.quota_limit) {</div><div class="line"><a name="l11751"></a><span class="lineno">11751</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;*** QUOTA EXCEEDED!!\n&quot;</span>);</div><div class="line"><a name="l11752"></a><span class="lineno">11752</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l11753"></a><span class="lineno">11753</span>&#160;      }</div><div class="line"><a name="l11754"></a><span class="lineno">11754</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Checking quotas: User has %d messages and limit is %d.\n&quot;</span>, (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> + vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);</div><div class="line"><a name="l11755"></a><span class="lineno">11755</span>&#160;      <span class="keywordflow">if</span> ((vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> + vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) &gt;= vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>) {</div><div class="line"><a name="l11756"></a><span class="lineno">11756</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No more messages possible.  User has %d messages and limit is %d.\n&quot;</span>, (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> + vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>), vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);</div><div class="line"><a name="l11757"></a><span class="lineno">11757</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l11758"></a><span class="lineno">11758</span>&#160;      }</div><div class="line"><a name="l11759"></a><span class="lineno">11759</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l11760"></a><span class="lineno">11760</span>&#160;</div><div class="line"><a name="l11761"></a><span class="lineno">11761</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;INTRO&quot;</span>, <span class="stringliteral">&quot;Message: playing intro menu&quot;</span>);</div><div class="line"><a name="l11762"></a><span class="lineno">11762</span>&#160;   <span class="keywordflow">if</span> (play_auto) {</div><div class="line"><a name="l11763"></a><span class="lineno">11763</span>&#160;      cmd = <span class="charliteral">&#39;1&#39;</span>;</div><div class="line"><a name="l11764"></a><span class="lineno">11764</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11765"></a><span class="lineno">11765</span>&#160;      cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">vm_intro</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l11766"></a><span class="lineno">11766</span>&#160;   }</div><div class="line"><a name="l11767"></a><span class="lineno">11767</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l11768"></a><span class="lineno">11768</span>&#160;      isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l11769"></a><span class="lineno">11769</span>&#160;</div><div class="line"><a name="l11770"></a><span class="lineno">11770</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> = 0;</div><div class="line"><a name="l11771"></a><span class="lineno">11771</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 1;</div><div class="line"><a name="l11772"></a><span class="lineno">11772</span>&#160;   <span class="keywordflow">while</span> ((cmd &gt; -1) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>) &amp;&amp; (cmd != <span class="charliteral">&#39;#&#39;</span>)) {</div><div class="line"><a name="l11773"></a><span class="lineno">11773</span>&#160;      <span class="comment">/* Run main menu */</span></div><div class="line"><a name="l11774"></a><span class="lineno">11774</span>&#160;      <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l11775"></a><span class="lineno">11775</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>: <span class="comment">/* First message */</span></div><div class="line"><a name="l11776"></a><span class="lineno">11776</span>&#160;         vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;</div><div class="line"><a name="l11777"></a><span class="lineno">11777</span>&#160;         <span class="comment">/* Fall through */</span></div><div class="line"><a name="l11778"></a><span class="lineno">11778</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;5&#39;</span>: <span class="comment">/* Play current message */</span></div><div class="line"><a name="l11779"></a><span class="lineno">11779</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;BROWSE&quot;</span>, <span class="stringliteral">&quot;Message: browsing message %d\r\nVoicemail: %d&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l11780"></a><span class="lineno">11780</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7">vm_browse_messages</a>(chan, &amp;vms, vmu);</div><div class="line"><a name="l11781"></a><span class="lineno">11781</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l11782"></a><span class="lineno">11782</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>: <span class="comment">/* Change folders */</span></div><div class="line"><a name="l11783"></a><span class="lineno">11783</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;CHANGEFOLDER&quot;</span>, <span class="stringliteral">&quot;Message: browsing to a different folder&quot;</span>);</div><div class="line"><a name="l11784"></a><span class="lineno">11784</span>&#160;         <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l11785"></a><span class="lineno">11785</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a>(chan, 0, <span class="stringliteral">&quot;Change to folder...&quot;</span>);</div><div class="line"><a name="l11786"></a><span class="lineno">11786</span>&#160;</div><div class="line"><a name="l11787"></a><span class="lineno">11787</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6">get_folder2</a>(chan, <span class="stringliteral">&quot;vm-changeto&quot;</span>, 0);</div><div class="line"><a name="l11788"></a><span class="lineno">11788</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l11789"></a><span class="lineno">11789</span>&#160;            isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l11790"></a><span class="lineno">11790</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;#&#39;</span>) {</div><div class="line"><a name="l11791"></a><span class="lineno">11791</span>&#160;            cmd = 0;</div><div class="line"><a name="l11792"></a><span class="lineno">11792</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &gt; 0) {</div><div class="line"><a name="l11793"></a><span class="lineno">11793</span>&#160;            cmd = cmd - <span class="charliteral">&#39;0&#39;</span>;</div><div class="line"><a name="l11794"></a><span class="lineno">11794</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l11795"></a><span class="lineno">11795</span>&#160;            <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)</div><div class="line"><a name="l11796"></a><span class="lineno">11796</span>&#160;               <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11797"></a><span class="lineno">11797</span>&#160;            <span class="comment">/* If folder is not urgent, set in_urgent to zero! */</span></div><div class="line"><a name="l11798"></a><span class="lineno">11798</span>&#160;            <span class="keywordflow">if</span> (cmd != 11) in_urgent = 0;</div><div class="line"><a name="l11799"></a><span class="lineno">11799</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, cmd);</div><div class="line"><a name="l11800"></a><span class="lineno">11800</span>&#160;            <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11801"></a><span class="lineno">11801</span>&#160;               <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11802"></a><span class="lineno">11802</span>&#160;            play_folder = cmd;</div><div class="line"><a name="l11803"></a><span class="lineno">11803</span>&#160;            cmd = 0;</div><div class="line"><a name="l11804"></a><span class="lineno">11804</span>&#160;         }</div><div class="line"><a name="l11805"></a><span class="lineno">11805</span>&#160;         <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l11806"></a><span class="lineno">11806</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353">adsi_status2</a>(chan, &amp;vms);</div><div class="line"><a name="l11807"></a><span class="lineno">11807</span>&#160;</div><div class="line"><a name="l11808"></a><span class="lineno">11808</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11809"></a><span class="lineno">11809</span>&#160;            cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l11810"></a><span class="lineno">11810</span>&#160;         }</div><div class="line"><a name="l11811"></a><span class="lineno">11811</span>&#160;</div><div class="line"><a name="l11812"></a><span class="lineno">11812</span>&#160;         vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 1;</div><div class="line"><a name="l11813"></a><span class="lineno">11813</span>&#160;         vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;</div><div class="line"><a name="l11814"></a><span class="lineno">11814</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l11815"></a><span class="lineno">11815</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>: <span class="comment">/* Advanced options */</span></div><div class="line"><a name="l11816"></a><span class="lineno">11816</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;ADVOPTIONS&quot;</span>, <span class="stringliteral">&quot;Message: entering advanced options menu&quot;</span>);</div><div class="line"><a name="l11817"></a><span class="lineno">11817</span>&#160;         cmd = 0;</div><div class="line"><a name="l11818"></a><span class="lineno">11818</span>&#160;         vms.<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> = 0;</div><div class="line"><a name="l11819"></a><span class="lineno">11819</span>&#160;         <span class="keywordflow">while</span> ((cmd &gt; -1) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>) &amp;&amp; (cmd != <span class="charliteral">&#39;#&#39;</span>)) {</div><div class="line"><a name="l11820"></a><span class="lineno">11820</span>&#160;            <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l11821"></a><span class="lineno">11821</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>: <span class="comment">/* Reply */</span></div><div class="line"><a name="l11822"></a><span class="lineno">11822</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1 &amp;&amp; !vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l11823"></a><span class="lineno">11823</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">advanced_options</a>(chan, vmu, &amp;vms, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, 1, record_gain);</div><div class="line"><a name="l11824"></a><span class="lineno">11824</span>&#160;                  <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a> || cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a>) {</div><div class="line"><a name="l11825"></a><span class="lineno">11825</span>&#160;                     res = cmd;</div><div class="line"><a name="l11826"></a><span class="lineno">11826</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11827"></a><span class="lineno">11827</span>&#160;                  }</div><div class="line"><a name="l11828"></a><span class="lineno">11828</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11829"></a><span class="lineno">11829</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l11830"></a><span class="lineno">11830</span>&#160;               }</div><div class="line"><a name="l11831"></a><span class="lineno">11831</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11832"></a><span class="lineno">11832</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11833"></a><span class="lineno">11833</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>: <span class="comment">/* Callback */</span></div><div class="line"><a name="l11834"></a><span class="lineno">11834</span>&#160;               <span class="keywordflow">if</span> (!vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>)</div><div class="line"><a name="l11835"></a><span class="lineno">11835</span>&#160;                  <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Callback Requested\n&quot;</span>);</div><div class="line"><a name="l11836"></a><span class="lineno">11836</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>) &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1 &amp;&amp; !vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l11837"></a><span class="lineno">11837</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">advanced_options</a>(chan, vmu, &amp;vms, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, 2, record_gain);</div><div class="line"><a name="l11838"></a><span class="lineno">11838</span>&#160;                  <span class="keywordflow">if</span> (cmd == 9) {</div><div class="line"><a name="l11839"></a><span class="lineno">11839</span>&#160;                     silentexit = 1;</div><div class="line"><a name="l11840"></a><span class="lineno">11840</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11841"></a><span class="lineno">11841</span>&#160;                  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {</div><div class="line"><a name="l11842"></a><span class="lineno">11842</span>&#160;                     res = cmd;</div><div class="line"><a name="l11843"></a><span class="lineno">11843</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11844"></a><span class="lineno">11844</span>&#160;                  }</div><div class="line"><a name="l11845"></a><span class="lineno">11845</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11846"></a><span class="lineno">11846</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l11847"></a><span class="lineno">11847</span>&#160;               }</div><div class="line"><a name="l11848"></a><span class="lineno">11848</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11849"></a><span class="lineno">11849</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11850"></a><span class="lineno">11850</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>: <span class="comment">/* Envelope */</span></div><div class="line"><a name="l11851"></a><span class="lineno">11851</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1 &amp;&amp; !vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l11852"></a><span class="lineno">11852</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">advanced_options</a>(chan, vmu, &amp;vms, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, 3, record_gain);</div><div class="line"><a name="l11853"></a><span class="lineno">11853</span>&#160;                  <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {</div><div class="line"><a name="l11854"></a><span class="lineno">11854</span>&#160;                     res = cmd;</div><div class="line"><a name="l11855"></a><span class="lineno">11855</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11856"></a><span class="lineno">11856</span>&#160;                  }</div><div class="line"><a name="l11857"></a><span class="lineno">11857</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11858"></a><span class="lineno">11858</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l11859"></a><span class="lineno">11859</span>&#160;               }</div><div class="line"><a name="l11860"></a><span class="lineno">11860</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11861"></a><span class="lineno">11861</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11862"></a><span class="lineno">11862</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;4&#39;</span>: <span class="comment">/* Dialout */</span></div><div class="line"><a name="l11863"></a><span class="lineno">11863</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {</div><div class="line"><a name="l11864"></a><span class="lineno">11864</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(chan, vmu, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>);</div><div class="line"><a name="l11865"></a><span class="lineno">11865</span>&#160;                  <span class="keywordflow">if</span> (cmd == 9) {</div><div class="line"><a name="l11866"></a><span class="lineno">11866</span>&#160;                     silentexit = 1;</div><div class="line"><a name="l11867"></a><span class="lineno">11867</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11868"></a><span class="lineno">11868</span>&#160;                  }</div><div class="line"><a name="l11869"></a><span class="lineno">11869</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11870"></a><span class="lineno">11870</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l11871"></a><span class="lineno">11871</span>&#160;               }</div><div class="line"><a name="l11872"></a><span class="lineno">11872</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11873"></a><span class="lineno">11873</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11874"></a><span class="lineno">11874</span>&#160;</div><div class="line"><a name="l11875"></a><span class="lineno">11875</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;5&#39;</span>: <span class="comment">/* Leave VoiceMail */</span></div><div class="line"><a name="l11876"></a><span class="lineno">11876</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>)) {</div><div class="line"><a name="l11877"></a><span class="lineno">11877</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c">forward_message</a>(chan, context, &amp;vms, vmu, vmfmts, 1, record_gain, 0);</div><div class="line"><a name="l11878"></a><span class="lineno">11878</span>&#160;                  <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a> || cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a>) {</div><div class="line"><a name="l11879"></a><span class="lineno">11879</span>&#160;                     res = cmd;</div><div class="line"><a name="l11880"></a><span class="lineno">11880</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11881"></a><span class="lineno">11881</span>&#160;                  }</div><div class="line"><a name="l11882"></a><span class="lineno">11882</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11883"></a><span class="lineno">11883</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l11884"></a><span class="lineno">11884</span>&#160;               }</div><div class="line"><a name="l11885"></a><span class="lineno">11885</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11886"></a><span class="lineno">11886</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11887"></a><span class="lineno">11887</span>&#160;</div><div class="line"><a name="l11888"></a><span class="lineno">11888</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>: <span class="comment">/* Return to main menu */</span></div><div class="line"><a name="l11889"></a><span class="lineno">11889</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11890"></a><span class="lineno">11890</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l11891"></a><span class="lineno">11891</span>&#160;</div><div class="line"><a name="l11892"></a><span class="lineno">11892</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l11893"></a><span class="lineno">11893</span>&#160;               cmd = 0;</div><div class="line"><a name="l11894"></a><span class="lineno">11894</span>&#160;               <span class="keywordflow">if</span> (!vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l11895"></a><span class="lineno">11895</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toreply&quot;</span>);</div><div class="line"><a name="l11896"></a><span class="lineno">11896</span>&#160;               }</div><div class="line"><a name="l11897"></a><span class="lineno">11897</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>) &amp;&amp; !vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> &amp;&amp; !cmd) {</div><div class="line"><a name="l11898"></a><span class="lineno">11898</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocallback&quot;</span>);</div><div class="line"><a name="l11899"></a><span class="lineno">11899</span>&#160;               }</div><div class="line"><a name="l11900"></a><span class="lineno">11900</span>&#160;               <span class="keywordflow">if</span> (!cmd &amp;&amp; !vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l11901"></a><span class="lineno">11901</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tohearenv&quot;</span>);</div><div class="line"><a name="l11902"></a><span class="lineno">11902</span>&#160;               }</div><div class="line"><a name="l11903"></a><span class="lineno">11903</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>) &amp;&amp; !cmd) {</div><div class="line"><a name="l11904"></a><span class="lineno">11904</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tomakecall&quot;</span>);</div><div class="line"><a name="l11905"></a><span class="lineno">11905</span>&#160;               }</div><div class="line"><a name="l11906"></a><span class="lineno">11906</span>&#160;               <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>) &amp;&amp; !cmd) {</div><div class="line"><a name="l11907"></a><span class="lineno">11907</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-leavemsg&quot;</span>);</div><div class="line"><a name="l11908"></a><span class="lineno">11908</span>&#160;               }</div><div class="line"><a name="l11909"></a><span class="lineno">11909</span>&#160;               <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11910"></a><span class="lineno">11910</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starmain&quot;</span>);</div><div class="line"><a name="l11911"></a><span class="lineno">11911</span>&#160;               }</div><div class="line"><a name="l11912"></a><span class="lineno">11912</span>&#160;               <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11913"></a><span class="lineno">11913</span>&#160;                  cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l11914"></a><span class="lineno">11914</span>&#160;               }</div><div class="line"><a name="l11915"></a><span class="lineno">11915</span>&#160;               <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l11916"></a><span class="lineno">11916</span>&#160;                  vms.<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a>++;</div><div class="line"><a name="l11917"></a><span class="lineno">11917</span>&#160;               }</div><div class="line"><a name="l11918"></a><span class="lineno">11918</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> &gt; 3) {</div><div class="line"><a name="l11919"></a><span class="lineno">11919</span>&#160;                  cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l11920"></a><span class="lineno">11920</span>&#160;               }</div><div class="line"><a name="l11921"></a><span class="lineno">11921</span>&#160;               <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l11922"></a><span class="lineno">11922</span>&#160;                  isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l11923"></a><span class="lineno">11923</span>&#160;            }</div><div class="line"><a name="l11924"></a><span class="lineno">11924</span>&#160;         }</div><div class="line"><a name="l11925"></a><span class="lineno">11925</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;t&#39;</span>) {</div><div class="line"><a name="l11926"></a><span class="lineno">11926</span>&#160;            cmd = 0;</div><div class="line"><a name="l11927"></a><span class="lineno">11927</span>&#160;            vms.<a class="code" href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> = 0;</div><div class="line"><a name="l11928"></a><span class="lineno">11928</span>&#160;         }</div><div class="line"><a name="l11929"></a><span class="lineno">11929</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l11930"></a><span class="lineno">11930</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;4&#39;</span>: <span class="comment">/* Go to the previous message */</span></div><div class="line"><a name="l11931"></a><span class="lineno">11931</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PREVMSG&quot;</span>, <span class="stringliteral">&quot;Message: browsing message %d\r\nVoicemail: %d&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> - 1, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> - 1);</div><div class="line"><a name="l11932"></a><span class="lineno">11932</span>&#160;         <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt; 0) {</div><div class="line"><a name="l11933"></a><span class="lineno">11933</span>&#160;            vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>--;</div><div class="line"><a name="l11934"></a><span class="lineno">11934</span>&#160;            cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l11935"></a><span class="lineno">11935</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11936"></a><span class="lineno">11936</span>&#160;            <span class="comment">/* Check if we were listening to new</span></div><div class="line"><a name="l11937"></a><span class="lineno">11937</span>&#160;<span class="comment">               messages.  If so, go to Urgent messages</span></div><div class="line"><a name="l11938"></a><span class="lineno">11938</span>&#160;<span class="comment">               instead of saying &quot;no more messages&quot;</span></div><div class="line"><a name="l11939"></a><span class="lineno">11939</span>&#160;<span class="comment">            */</span></div><div class="line"><a name="l11940"></a><span class="lineno">11940</span>&#160;            <span class="keywordflow">if</span> (in_urgent == 0 &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &gt; 0) {</div><div class="line"><a name="l11941"></a><span class="lineno">11941</span>&#160;               <span class="comment">/* Check for Urgent messages */</span></div><div class="line"><a name="l11942"></a><span class="lineno">11942</span>&#160;               in_urgent = 1;</div><div class="line"><a name="l11943"></a><span class="lineno">11943</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l11944"></a><span class="lineno">11944</span>&#160;               <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)</div><div class="line"><a name="l11945"></a><span class="lineno">11945</span>&#160;                  <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11946"></a><span class="lineno">11946</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, 11);  <span class="comment">/* Open Urgent folder */</span></div><div class="line"><a name="l11947"></a><span class="lineno">11947</span>&#160;               <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11948"></a><span class="lineno">11948</span>&#160;                  <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11949"></a><span class="lineno">11949</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;No more new messages, opened INBOX and got %d Urgent messages\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);</div><div class="line"><a name="l11950"></a><span class="lineno">11950</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;</div><div class="line"><a name="l11951"></a><span class="lineno">11951</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0) {</div><div class="line"><a name="l11952"></a><span class="lineno">11952</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l11953"></a><span class="lineno">11953</span>&#160;               }</div><div class="line"><a name="l11954"></a><span class="lineno">11954</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {</div><div class="line"><a name="l11955"></a><span class="lineno">11955</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;</div><div class="line"><a name="l11956"></a><span class="lineno">11956</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l11957"></a><span class="lineno">11957</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11958"></a><span class="lineno">11958</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l11959"></a><span class="lineno">11959</span>&#160;            }</div><div class="line"><a name="l11960"></a><span class="lineno">11960</span>&#160;         }</div><div class="line"><a name="l11961"></a><span class="lineno">11961</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l11962"></a><span class="lineno">11962</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;6&#39;</span>: <span class="comment">/* Go to the next message */</span></div><div class="line"><a name="l11963"></a><span class="lineno">11963</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PREVMSG&quot;</span>, <span class="stringliteral">&quot;Message: browsing message %d\r\nVoicemail: %d&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1);</div><div class="line"><a name="l11964"></a><span class="lineno">11964</span>&#160;         <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l11965"></a><span class="lineno">11965</span>&#160;            vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;</div><div class="line"><a name="l11966"></a><span class="lineno">11966</span>&#160;            cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l11967"></a><span class="lineno">11967</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11968"></a><span class="lineno">11968</span>&#160;            <span class="keywordflow">if</span> (in_urgent &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) {</div><div class="line"><a name="l11969"></a><span class="lineno">11969</span>&#160;               <span class="comment">/* Check if we were listening to urgent</span></div><div class="line"><a name="l11970"></a><span class="lineno">11970</span>&#160;<span class="comment">                * messages.  If so, go to regular new messages</span></div><div class="line"><a name="l11971"></a><span class="lineno">11971</span>&#160;<span class="comment">                * instead of saying &quot;no more messages&quot;</span></div><div class="line"><a name="l11972"></a><span class="lineno">11972</span>&#160;<span class="comment">                */</span></div><div class="line"><a name="l11973"></a><span class="lineno">11973</span>&#160;               in_urgent = 0;</div><div class="line"><a name="l11974"></a><span class="lineno">11974</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l11975"></a><span class="lineno">11975</span>&#160;               <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)</div><div class="line"><a name="l11976"></a><span class="lineno">11976</span>&#160;                  <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11977"></a><span class="lineno">11977</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);</div><div class="line"><a name="l11978"></a><span class="lineno">11978</span>&#160;               <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l11979"></a><span class="lineno">11979</span>&#160;                  <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l11980"></a><span class="lineno">11980</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);</div><div class="line"><a name="l11981"></a><span class="lineno">11981</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;</div><div class="line"><a name="l11982"></a><span class="lineno">11982</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0) {</div><div class="line"><a name="l11983"></a><span class="lineno">11983</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l11984"></a><span class="lineno">11984</span>&#160;               }</div><div class="line"><a name="l11985"></a><span class="lineno">11985</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {</div><div class="line"><a name="l11986"></a><span class="lineno">11986</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;</div><div class="line"><a name="l11987"></a><span class="lineno">11987</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l11988"></a><span class="lineno">11988</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l11989"></a><span class="lineno">11989</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l11990"></a><span class="lineno">11990</span>&#160;            }</div><div class="line"><a name="l11991"></a><span class="lineno">11991</span>&#160;         }</div><div class="line"><a name="l11992"></a><span class="lineno">11992</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l11993"></a><span class="lineno">11993</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;7&#39;</span>: <span class="comment">/* Delete the current message */</span></div><div class="line"><a name="l11994"></a><span class="lineno">11994</span>&#160;         <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt;= 0 &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt;= vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l11995"></a><span class="lineno">11995</span>&#160;            vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = !vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>];</div><div class="line"><a name="l11996"></a><span class="lineno">11996</span>&#160;            <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l11997"></a><span class="lineno">11997</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4">adsi_delete</a>(chan, &amp;vms);</div><div class="line"><a name="l11998"></a><span class="lineno">11998</span>&#160;            <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>]) {</div><div class="line"><a name="l11999"></a><span class="lineno">11999</span>&#160;               <span class="keywordflow">if</span> (play_folder == 0) {</div><div class="line"><a name="l12000"></a><span class="lineno">12000</span>&#160;                  <span class="keywordflow">if</span> (in_urgent) {</div><div class="line"><a name="l12001"></a><span class="lineno">12001</span>&#160;                     vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>--;</div><div class="line"><a name="l12002"></a><span class="lineno">12002</span>&#160;                  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12003"></a><span class="lineno">12003</span>&#160;                     vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>--;</div><div class="line"><a name="l12004"></a><span class="lineno">12004</span>&#160;                  }</div><div class="line"><a name="l12005"></a><span class="lineno">12005</span>&#160;               }</div><div class="line"><a name="l12006"></a><span class="lineno">12006</span>&#160;               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (play_folder == 1)</div><div class="line"><a name="l12007"></a><span class="lineno">12007</span>&#160;                  vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>--;</div><div class="line"><a name="l12008"></a><span class="lineno">12008</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-deleted&quot;</span>);</div><div class="line"><a name="l12009"></a><span class="lineno">12009</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12010"></a><span class="lineno">12010</span>&#160;               <span class="keywordflow">if</span> (play_folder == 0) {</div><div class="line"><a name="l12011"></a><span class="lineno">12011</span>&#160;                  <span class="keywordflow">if</span> (in_urgent) {</div><div class="line"><a name="l12012"></a><span class="lineno">12012</span>&#160;                     vms.<a class="code" href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>++;</div><div class="line"><a name="l12013"></a><span class="lineno">12013</span>&#160;                  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12014"></a><span class="lineno">12014</span>&#160;                     vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>++;</div><div class="line"><a name="l12015"></a><span class="lineno">12015</span>&#160;                  }</div><div class="line"><a name="l12016"></a><span class="lineno">12016</span>&#160;               }</div><div class="line"><a name="l12017"></a><span class="lineno">12017</span>&#160;               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (play_folder == 1)</div><div class="line"><a name="l12018"></a><span class="lineno">12018</span>&#160;                  vms.<a class="code" href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>++;</div><div class="line"><a name="l12019"></a><span class="lineno">12019</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-undeleted&quot;</span>);</div><div class="line"><a name="l12020"></a><span class="lineno">12020</span>&#160;            }</div><div class="line"><a name="l12021"></a><span class="lineno">12021</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>)) {</div><div class="line"><a name="l12022"></a><span class="lineno">12022</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l12023"></a><span class="lineno">12023</span>&#160;                  vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;</div><div class="line"><a name="l12024"></a><span class="lineno">12024</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l12025"></a><span class="lineno">12025</span>&#160;               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {</div><div class="line"><a name="l12026"></a><span class="lineno">12026</span>&#160;                  vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;</div><div class="line"><a name="l12027"></a><span class="lineno">12027</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l12028"></a><span class="lineno">12028</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12029"></a><span class="lineno">12029</span>&#160;                  <span class="comment">/* Check if we were listening to urgent</span></div><div class="line"><a name="l12030"></a><span class="lineno">12030</span>&#160;<span class="comment">                     messages.  If so, go to regular new messages</span></div><div class="line"><a name="l12031"></a><span class="lineno">12031</span>&#160;<span class="comment">                     instead of saying &quot;no more messages&quot;</span></div><div class="line"><a name="l12032"></a><span class="lineno">12032</span>&#160;<span class="comment">                  */</span></div><div class="line"><a name="l12033"></a><span class="lineno">12033</span>&#160;                  <span class="keywordflow">if</span> (in_urgent == 1) {</div><div class="line"><a name="l12034"></a><span class="lineno">12034</span>&#160;                     <span class="comment">/* Check for new messages */</span></div><div class="line"><a name="l12035"></a><span class="lineno">12035</span>&#160;                     in_urgent = 0;</div><div class="line"><a name="l12036"></a><span class="lineno">12036</span>&#160;                     res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l12037"></a><span class="lineno">12037</span>&#160;                     <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)</div><div class="line"><a name="l12038"></a><span class="lineno">12038</span>&#160;                        <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12039"></a><span class="lineno">12039</span>&#160;                     res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);</div><div class="line"><a name="l12040"></a><span class="lineno">12040</span>&#160;                     <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l12041"></a><span class="lineno">12041</span>&#160;                        <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12042"></a><span class="lineno">12042</span>&#160;                     <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);</div><div class="line"><a name="l12043"></a><span class="lineno">12043</span>&#160;                     vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;</div><div class="line"><a name="l12044"></a><span class="lineno">12044</span>&#160;                     <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0) {</div><div class="line"><a name="l12045"></a><span class="lineno">12045</span>&#160;                        cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l12046"></a><span class="lineno">12046</span>&#160;                     }</div><div class="line"><a name="l12047"></a><span class="lineno">12047</span>&#160;                  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12048"></a><span class="lineno">12048</span>&#160;                     cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l12049"></a><span class="lineno">12049</span>&#160;                  }</div><div class="line"><a name="l12050"></a><span class="lineno">12050</span>&#160;               }</div><div class="line"><a name="l12051"></a><span class="lineno">12051</span>&#160;            }</div><div class="line"><a name="l12052"></a><span class="lineno">12052</span>&#160;         } <span class="keywordflow">else</span> <span class="comment">/* Delete not valid if we haven&#39;t selected a message */</span></div><div class="line"><a name="l12053"></a><span class="lineno">12053</span>&#160;            cmd = 0;</div><div class="line"><a name="l12054"></a><span class="lineno">12054</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l12055"></a><span class="lineno">12055</span>&#160;         deleted = 1;</div><div class="line"><a name="l12056"></a><span class="lineno">12056</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12057"></a><span class="lineno">12057</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l12058"></a><span class="lineno">12058</span>&#160;</div><div class="line"><a name="l12059"></a><span class="lineno">12059</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;8&#39;</span>: <span class="comment">/* Forward the current message */</span></div><div class="line"><a name="l12060"></a><span class="lineno">12060</span>&#160;         <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {</div><div class="line"><a name="l12061"></a><span class="lineno">12061</span>&#160;            cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c">forward_message</a>(chan, context, &amp;vms, vmu, vmfmts, 0, record_gain, in_urgent);</div><div class="line"><a name="l12062"></a><span class="lineno">12062</span>&#160;            <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {</div><div class="line"><a name="l12063"></a><span class="lineno">12063</span>&#160;               res = cmd;</div><div class="line"><a name="l12064"></a><span class="lineno">12064</span>&#160;               <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12065"></a><span class="lineno">12065</span>&#160;            }</div><div class="line"><a name="l12066"></a><span class="lineno">12066</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12067"></a><span class="lineno">12067</span>&#160;            <span class="comment">/* Check if we were listening to urgent</span></div><div class="line"><a name="l12068"></a><span class="lineno">12068</span>&#160;<span class="comment">               messages.  If so, go to regular new messages</span></div><div class="line"><a name="l12069"></a><span class="lineno">12069</span>&#160;<span class="comment">               instead of saying &quot;no more messages&quot;</span></div><div class="line"><a name="l12070"></a><span class="lineno">12070</span>&#160;<span class="comment">            */</span></div><div class="line"><a name="l12071"></a><span class="lineno">12071</span>&#160;            <span class="keywordflow">if</span> (in_urgent == 1 &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) {</div><div class="line"><a name="l12072"></a><span class="lineno">12072</span>&#160;               <span class="comment">/* Check for new messages */</span></div><div class="line"><a name="l12073"></a><span class="lineno">12073</span>&#160;               in_urgent = 0;</div><div class="line"><a name="l12074"></a><span class="lineno">12074</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l12075"></a><span class="lineno">12075</span>&#160;               <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)</div><div class="line"><a name="l12076"></a><span class="lineno">12076</span>&#160;                  <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12077"></a><span class="lineno">12077</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);</div><div class="line"><a name="l12078"></a><span class="lineno">12078</span>&#160;               <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l12079"></a><span class="lineno">12079</span>&#160;                  <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12080"></a><span class="lineno">12080</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);</div><div class="line"><a name="l12081"></a><span class="lineno">12081</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;</div><div class="line"><a name="l12082"></a><span class="lineno">12082</span>&#160;               <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0) {</div><div class="line"><a name="l12083"></a><span class="lineno">12083</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l12084"></a><span class="lineno">12084</span>&#160;               }</div><div class="line"><a name="l12085"></a><span class="lineno">12085</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12086"></a><span class="lineno">12086</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l12087"></a><span class="lineno">12087</span>&#160;            }</div><div class="line"><a name="l12088"></a><span class="lineno">12088</span>&#160;         }</div><div class="line"><a name="l12089"></a><span class="lineno">12089</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l12090"></a><span class="lineno">12090</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;9&#39;</span>: <span class="comment">/* Save message to folder */</span></div><div class="line"><a name="l12091"></a><span class="lineno">12091</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;SAVEMSG&quot;</span>, <span class="stringliteral">&quot;Message: saving message %d\r\nVoicemail: %d&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l12092"></a><span class="lineno">12092</span>&#160;         <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; 0 || vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l12093"></a><span class="lineno">12093</span>&#160;            <span class="comment">/* No message selected */</span></div><div class="line"><a name="l12094"></a><span class="lineno">12094</span>&#160;            cmd = 0;</div><div class="line"><a name="l12095"></a><span class="lineno">12095</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l12096"></a><span class="lineno">12096</span>&#160;         }</div><div class="line"><a name="l12097"></a><span class="lineno">12097</span>&#160;         <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l12098"></a><span class="lineno">12098</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a>(chan, 1, <span class="stringliteral">&quot;Save to folder...&quot;</span>);</div><div class="line"><a name="l12099"></a><span class="lineno">12099</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6">get_folder2</a>(chan, <span class="stringliteral">&quot;vm-savefolder&quot;</span>, 1);</div><div class="line"><a name="l12100"></a><span class="lineno">12100</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l12101"></a><span class="lineno">12101</span>&#160;            isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l12102"></a><span class="lineno">12102</span>&#160;         box = 0; <span class="comment">/* Shut up compiler */</span></div><div class="line"><a name="l12103"></a><span class="lineno">12103</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;#&#39;</span>) {</div><div class="line"><a name="l12104"></a><span class="lineno">12104</span>&#160;            cmd = 0;</div><div class="line"><a name="l12105"></a><span class="lineno">12105</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l12106"></a><span class="lineno">12106</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &gt; 0) {</div><div class="line"><a name="l12107"></a><span class="lineno">12107</span>&#160;            box = cmd = cmd - <span class="charliteral">&#39;0&#39;</span>;</div><div class="line"><a name="l12108"></a><span class="lineno">12108</span>&#160;            cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(vmu, &amp;vms, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, cmd, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line"><a name="l12109"></a><span class="lineno">12109</span>&#160;            <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {</div><div class="line"><a name="l12110"></a><span class="lineno">12110</span>&#160;               res = cmd;</div><div class="line"><a name="l12111"></a><span class="lineno">12111</span>&#160;               <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12112"></a><span class="lineno">12112</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l12113"></a><span class="lineno">12113</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l12114"></a><span class="lineno">12114</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 1;</div><div class="line"><a name="l12115"></a><span class="lineno">12115</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12116"></a><span class="lineno">12116</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12117"></a><span class="lineno">12117</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 0;</div><div class="line"><a name="l12118"></a><span class="lineno">12118</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 0;</div><div class="line"><a name="l12119"></a><span class="lineno">12119</span>&#160;            }</div><div class="line"><a name="l12120"></a><span class="lineno">12120</span>&#160;         }</div><div class="line"><a name="l12121"></a><span class="lineno">12121</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l12122"></a><span class="lineno">12122</span>&#160;         <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l12123"></a><span class="lineno">12123</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a>(chan, &amp;vms);</div><div class="line"><a name="l12124"></a><span class="lineno">12124</span>&#160;         snprintf(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a>(vmu, box));</div><div class="line"><a name="l12125"></a><span class="lineno">12125</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l12126"></a><span class="lineno">12126</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);</div><div class="line"><a name="l12127"></a><span class="lineno">12127</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12128"></a><span class="lineno">12128</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan));</div><div class="line"><a name="l12129"></a><span class="lineno">12129</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12130"></a><span class="lineno">12130</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-savedto&quot;</span>);</div><div class="line"><a name="l12131"></a><span class="lineno">12131</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12132"></a><span class="lineno">12132</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l12133"></a><span class="lineno">12133</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12134"></a><span class="lineno">12134</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);</div><div class="line"><a name="l12135"></a><span class="lineno">12135</span>&#160;         }</div><div class="line"><a name="l12136"></a><span class="lineno">12136</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>)) {</div><div class="line"><a name="l12137"></a><span class="lineno">12137</span>&#160;            <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {</div><div class="line"><a name="l12138"></a><span class="lineno">12138</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;</div><div class="line"><a name="l12139"></a><span class="lineno">12139</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l12140"></a><span class="lineno">12140</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {</div><div class="line"><a name="l12141"></a><span class="lineno">12141</span>&#160;               vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;</div><div class="line"><a name="l12142"></a><span class="lineno">12142</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);</div><div class="line"><a name="l12143"></a><span class="lineno">12143</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12144"></a><span class="lineno">12144</span>&#160;               <span class="comment">/* Check if we were listening to urgent</span></div><div class="line"><a name="l12145"></a><span class="lineno">12145</span>&#160;<span class="comment">                  messages.  If so, go to regular new messages</span></div><div class="line"><a name="l12146"></a><span class="lineno">12146</span>&#160;<span class="comment">                  instead of saying &quot;no more messages&quot;</span></div><div class="line"><a name="l12147"></a><span class="lineno">12147</span>&#160;<span class="comment">               */</span></div><div class="line"><a name="l12148"></a><span class="lineno">12148</span>&#160;               <span class="keywordflow">if</span> (in_urgent == 1 &amp;&amp; vms.<a class="code" href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) {</div><div class="line"><a name="l12149"></a><span class="lineno">12149</span>&#160;                  <span class="comment">/* Check for new messages */</span></div><div class="line"><a name="l12150"></a><span class="lineno">12150</span>&#160;                  in_urgent = 0;</div><div class="line"><a name="l12151"></a><span class="lineno">12151</span>&#160;                  res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l12152"></a><span class="lineno">12152</span>&#160;                  <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)</div><div class="line"><a name="l12153"></a><span class="lineno">12153</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12154"></a><span class="lineno">12154</span>&#160;                  res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);</div><div class="line"><a name="l12155"></a><span class="lineno">12155</span>&#160;                  <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l12156"></a><span class="lineno">12156</span>&#160;                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12157"></a><span class="lineno">12157</span>&#160;                  <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);</div><div class="line"><a name="l12158"></a><span class="lineno">12158</span>&#160;                  vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;</div><div class="line"><a name="l12159"></a><span class="lineno">12159</span>&#160;                  <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0) {</div><div class="line"><a name="l12160"></a><span class="lineno">12160</span>&#160;                     cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l12161"></a><span class="lineno">12161</span>&#160;                  }</div><div class="line"><a name="l12162"></a><span class="lineno">12162</span>&#160;               } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12163"></a><span class="lineno">12163</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);</div><div class="line"><a name="l12164"></a><span class="lineno">12164</span>&#160;               }</div><div class="line"><a name="l12165"></a><span class="lineno">12165</span>&#160;            }</div><div class="line"><a name="l12166"></a><span class="lineno">12166</span>&#160;         }</div><div class="line"><a name="l12167"></a><span class="lineno">12167</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l12168"></a><span class="lineno">12168</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>: <span class="comment">/* Help */</span></div><div class="line"><a name="l12169"></a><span class="lineno">12169</span>&#160;         <span class="keywordflow">if</span> (!vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {</div><div class="line"><a name="l12170"></a><span class="lineno">12170</span>&#160;            <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;ja&quot;</span>, 2)) {</div><div class="line"><a name="l12171"></a><span class="lineno">12171</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l12172"></a><span class="lineno">12172</span>&#160;               <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12173"></a><span class="lineno">12173</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wa&quot;</span>);</div><div class="line"><a name="l12174"></a><span class="lineno">12174</span>&#160;               <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12175"></a><span class="lineno">12175</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);</div><div class="line"><a name="l12176"></a><span class="lineno">12176</span>&#160;               <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12177"></a><span class="lineno">12177</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;jp-wo&quot;</span>);</div><div class="line"><a name="l12178"></a><span class="lineno">12178</span>&#160;               <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12179"></a><span class="lineno">12179</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;silence/1&quot;</span>);</div><div class="line"><a name="l12180"></a><span class="lineno">12180</span>&#160;               <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12181"></a><span class="lineno">12181</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);</div><div class="line"><a name="l12182"></a><span class="lineno">12182</span>&#160;               <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12183"></a><span class="lineno">12183</span>&#160;                  cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(chan, vmu, &amp;vms, 1, in_urgent);</div><div class="line"><a name="l12184"></a><span class="lineno">12184</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l12185"></a><span class="lineno">12185</span>&#160;            }</div><div class="line"><a name="l12186"></a><span class="lineno">12186</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor&quot;</span>);</div><div class="line"><a name="l12187"></a><span class="lineno">12187</span>&#160;            <span class="keywordflow">if</span> (!strncasecmp(<a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <span class="stringliteral">&quot;he&quot;</span>, 2)) {</div><div class="line"><a name="l12188"></a><span class="lineno">12188</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-for&quot;</span>);</div><div class="line"><a name="l12189"></a><span class="lineno">12189</span>&#160;            }</div><div class="line"><a name="l12190"></a><span class="lineno">12190</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12191"></a><span class="lineno">12191</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);</div><div class="line"><a name="l12192"></a><span class="lineno">12192</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12193"></a><span class="lineno">12193</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);</div><div class="line"><a name="l12194"></a><span class="lineno">12194</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l12195"></a><span class="lineno">12195</span>&#160;               cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(chan, vmu, &amp;vms, 1, in_urgent);</div><div class="line"><a name="l12196"></a><span class="lineno">12196</span>&#160;         } <span class="keywordflow">else</span></div><div class="line"><a name="l12197"></a><span class="lineno">12197</span>&#160;            cmd = 0;</div><div class="line"><a name="l12198"></a><span class="lineno">12198</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l12199"></a><span class="lineno">12199</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;0&#39;</span>: <span class="comment">/* Mailbox options */</span></div><div class="line"><a name="l12200"></a><span class="lineno">12200</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">vm_options</a>(chan, vmu, &amp;vms, vmfmts, record_gain);</div><div class="line"><a name="l12201"></a><span class="lineno">12201</span>&#160;         <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l12202"></a><span class="lineno">12202</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a>(chan, &amp;vms);</div><div class="line"><a name="l12203"></a><span class="lineno">12203</span>&#160;         <span class="comment">/* Reopen play_folder */</span></div><div class="line"><a name="l12204"></a><span class="lineno">12204</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, play_folder);</div><div class="line"><a name="l12205"></a><span class="lineno">12205</span>&#160;         <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line"><a name="l12206"></a><span class="lineno">12206</span>&#160;            <span class="keywordflow">goto</span> <a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>;</div><div class="line"><a name="l12207"></a><span class="lineno">12207</span>&#160;         }</div><div class="line"><a name="l12208"></a><span class="lineno">12208</span>&#160;         vms.<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 1;</div><div class="line"><a name="l12209"></a><span class="lineno">12209</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l12210"></a><span class="lineno">12210</span>&#160;      <span class="keywordflow">default</span>: <span class="comment">/* Nothing */</span></div><div class="line"><a name="l12211"></a><span class="lineno">12211</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>, <span class="stringliteral">&quot;Message: instructions&quot;</span>);</div><div class="line"><a name="l12212"></a><span class="lineno">12212</span>&#160;         cmd = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(chan, vmu, &amp;vms, 0, in_urgent);</div><div class="line"><a name="l12213"></a><span class="lineno">12213</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l12214"></a><span class="lineno">12214</span>&#160;      }</div><div class="line"><a name="l12215"></a><span class="lineno">12215</span>&#160;   }</div><div class="line"><a name="l12216"></a><span class="lineno">12216</span>&#160;   <span class="keywordflow">if</span> ((cmd == <span class="charliteral">&#39;t&#39;</span>) || (cmd == <span class="charliteral">&#39;#&#39;</span>)) {</div><div class="line"><a name="l12217"></a><span class="lineno">12217</span>&#160;      <span class="comment">/* Timeout */</span></div><div class="line"><a name="l12218"></a><span class="lineno">12218</span>&#160;      res = 0;</div><div class="line"><a name="l12219"></a><span class="lineno">12219</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12220"></a><span class="lineno">12220</span>&#160;      <span class="comment">/* Hangup */</span></div><div class="line"><a name="l12221"></a><span class="lineno">12221</span>&#160;      res = -1;</div><div class="line"><a name="l12222"></a><span class="lineno">12222</span>&#160;   }</div><div class="line"><a name="l12223"></a><span class="lineno">12223</span>&#160;</div><div class="line"><a name="l12224"></a><span class="lineno">12224</span>&#160;<a class="code" href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a>:</div><div class="line"><a name="l12225"></a><span class="lineno">12225</span>&#160;   <span class="keywordflow">if</span> (res &gt; -1) {</div><div class="line"><a name="l12226"></a><span class="lineno">12226</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line"><a name="l12227"></a><span class="lineno">12227</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa">adsi_goodbye</a>(chan);</div><div class="line"><a name="l12228"></a><span class="lineno">12228</span>&#160;      <span class="keywordflow">if</span> (valid &amp;&amp; res != <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a>) {</div><div class="line"><a name="l12229"></a><span class="lineno">12229</span>&#160;         <span class="keywordflow">if</span> (silentexit)</div><div class="line"><a name="l12230"></a><span class="lineno">12230</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-dialout&quot;</span>);</div><div class="line"><a name="l12231"></a><span class="lineno">12231</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l12232"></a><span class="lineno">12232</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);</div><div class="line"><a name="l12233"></a><span class="lineno">12233</span>&#160;      }</div><div class="line"><a name="l12234"></a><span class="lineno">12234</span>&#160;      <span class="keywordflow">if</span> ((valid &amp;&amp; res &gt; 0) || res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a>) {</div><div class="line"><a name="l12235"></a><span class="lineno">12235</span>&#160;         res = 0;</div><div class="line"><a name="l12236"></a><span class="lineno">12236</span>&#160;      }</div><div class="line"><a name="l12237"></a><span class="lineno">12237</span>&#160;      <span class="keywordflow">if</span> (useadsi)</div><div class="line"><a name="l12238"></a><span class="lineno">12238</span>&#160;         <a class="code" href="../../df/de2/adsi_8h.html#a4cd092c7df03685491cb6f7c145654cd">ast_adsi_unload_session</a>(chan);</div><div class="line"><a name="l12239"></a><span class="lineno">12239</span>&#160;   }</div><div class="line"><a name="l12240"></a><span class="lineno">12240</span>&#160;   <span class="keywordflow">if</span> (vmu)</div><div class="line"><a name="l12241"></a><span class="lineno">12241</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l12242"></a><span class="lineno">12242</span>&#160;   <span class="keywordflow">if</span> (valid) {</div><div class="line"><a name="l12243"></a><span class="lineno">12243</span>&#160;      <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;</div><div class="line"><a name="l12244"></a><span class="lineno">12244</span>&#160;      snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l12245"></a><span class="lineno">12245</span>&#160;      <span class="comment">/* Urgent flag not passwd to externnotify here */</span></div><div class="line"><a name="l12246"></a><span class="lineno">12246</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l12247"></a><span class="lineno">12247</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ace2a3d783f4f79818e14265ae719f06c">ast_app_inboxcount2</a>(ext_context, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);</div><div class="line"><a name="l12248"></a><span class="lineno">12248</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a3b6254f6d3832ef928f0a727113b1c63">ast_channel_uniqueid</a>(chan), ext_context, urgent, <span class="keyword">new</span>, old);</div><div class="line"><a name="l12249"></a><span class="lineno">12249</span>&#160;   }</div><div class="line"><a name="l12250"></a><span class="lineno">12250</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l12251"></a><span class="lineno">12251</span>&#160;   <span class="comment">/* expunge message - use UID Expunge if supported on IMAP server*/</span></div><div class="line"><a name="l12252"></a><span class="lineno">12252</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;*** Checking if we can expunge, deleted set to %d, expungeonhangup set to %d\n&quot;</span>, deleted, expungeonhangup);</div><div class="line"><a name="l12253"></a><span class="lineno">12253</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; deleted == 1 &amp;&amp; expungeonhangup == 1 &amp;&amp; vms.mailstream != <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line"><a name="l12254"></a><span class="lineno">12254</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms.lock);</div><div class="line"><a name="l12255"></a><span class="lineno">12255</span>&#160;<span class="preprocessor">#ifdef HAVE_IMAP_TK2006</span></div><div class="line"><a name="l12256"></a><span class="lineno">12256</span>&#160;      <span class="keywordflow">if</span> (LEVELUIDPLUS (vms.mailstream)) {</div><div class="line"><a name="l12257"></a><span class="lineno">12257</span>&#160;         mail_expunge_full(vms.mailstream, NIL, EX_UID);</div><div class="line"><a name="l12258"></a><span class="lineno">12258</span>&#160;      } <span class="keywordflow">else</span></div><div class="line"><a name="l12259"></a><span class="lineno">12259</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12260"></a><span class="lineno">12260</span>&#160;         mail_expunge(vms.mailstream);</div><div class="line"><a name="l12261"></a><span class="lineno">12261</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms.lock);</div><div class="line"><a name="l12262"></a><span class="lineno">12262</span>&#160;   }</div><div class="line"><a name="l12263"></a><span class="lineno">12263</span>&#160;   <span class="comment">/*  before we delete the state, we should copy pertinent info</span></div><div class="line"><a name="l12264"></a><span class="lineno">12264</span>&#160;<span class="comment">    *  back to the persistent model */</span></div><div class="line"><a name="l12265"></a><span class="lineno">12265</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l12266"></a><span class="lineno">12266</span>&#160;      vmstate_delete(&amp;vms);</div><div class="line"><a name="l12267"></a><span class="lineno">12267</span>&#160;   }</div><div class="line"><a name="l12268"></a><span class="lineno">12268</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12269"></a><span class="lineno">12269</span>&#160;   <span class="keywordflow">if</span> (vmu)</div><div class="line"><a name="l12270"></a><span class="lineno">12270</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l12271"></a><span class="lineno">12271</span>&#160;</div><div class="line"><a name="l12272"></a><span class="lineno">12272</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l12273"></a><span class="lineno">12273</span>&#160;   pthread_setspecific(ts_vmstate.key, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l12274"></a><span class="lineno">12274</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12275"></a><span class="lineno">12275</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l12276"></a><span class="lineno">12276</span>&#160;}</div><div class="line"><a name="l12277"></a><span class="lineno">12277</span>&#160;</div><div class="line"><a name="l12278"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4ace316d9392f91668365780d1c2d020">12278</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4ace316d9392f91668365780d1c2d020">vm_exec</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line"><a name="l12279"></a><span class="lineno">12279</span>&#160;{</div><div class="line"><a name="l12280"></a><span class="lineno">12280</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l12281"></a><span class="lineno">12281</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l12282"></a><span class="lineno">12282</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/df7/structleave__vm__options.html">leave_vm_options</a> leave_options;</div><div class="line"><a name="l12283"></a><span class="lineno">12283</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> flags = { 0 };</div><div class="line"><a name="l12284"></a><span class="lineno">12284</span>&#160;   <span class="keywordtype">char</span> *opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>];</div><div class="line"><a name="l12285"></a><span class="lineno">12285</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2">AST_DECLARE_APP_ARGS</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>,</div><div class="line"><a name="l12286"></a><span class="lineno">12286</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(argv0);</div><div class="line"><a name="l12287"></a><span class="lineno">12287</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(argv1);</div><div class="line"><a name="l12288"></a><span class="lineno">12288</span>&#160;   );</div><div class="line"><a name="l12289"></a><span class="lineno">12289</span>&#160;</div><div class="line"><a name="l12290"></a><span class="lineno">12290</span>&#160;   memset(&amp;leave_options, 0, <span class="keyword">sizeof</span>(leave_options));</div><div class="line"><a name="l12291"></a><span class="lineno">12291</span>&#160;</div><div class="line"><a name="l12292"></a><span class="lineno">12292</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(data)) {</div><div class="line"><a name="l12293"></a><span class="lineno">12293</span>&#160;      tmp = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(data);</div><div class="line"><a name="l12294"></a><span class="lineno">12294</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8">AST_STANDARD_APP_ARGS</a>(<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>, tmp);</div><div class="line"><a name="l12295"></a><span class="lineno">12295</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argc == 2) {</div><div class="line"><a name="l12296"></a><span class="lineno">12296</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb">ast_app_parse_options</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a59fa4e60d6824425c6874fa59b1dd56a">vm_app_options</a>, &amp;flags, opts, <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv1))</div><div class="line"><a name="l12297"></a><span class="lineno">12297</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12298"></a><span class="lineno">12298</span>&#160;         <a class="code" href="../../d5/d60/utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;leave_options, &amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>);</div><div class="line"><a name="l12299"></a><span class="lineno">12299</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a>)) {</div><div class="line"><a name="l12300"></a><span class="lineno">12300</span>&#160;            <span class="keywordtype">int</span> gain;</div><div class="line"><a name="l12301"></a><span class="lineno">12301</span>&#160;</div><div class="line"><a name="l12302"></a><span class="lineno">12302</span>&#160;            <span class="keywordflow">if</span> (sscanf(opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a>], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;gain) != 1) {</div><div class="line"><a name="l12303"></a><span class="lineno">12303</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &#39;%s&#39; provided for record gain option\n&quot;</span>, opts[OPT_ARG_RECORDGAIN]);</div><div class="line"><a name="l12304"></a><span class="lineno">12304</span>&#160;               <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12305"></a><span class="lineno">12305</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12306"></a><span class="lineno">12306</span>&#160;               leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a> = (<span class="keywordtype">signed</span> char) gain;</div><div class="line"><a name="l12307"></a><span class="lineno">12307</span>&#160;            }</div><div class="line"><a name="l12308"></a><span class="lineno">12308</span>&#160;         }</div><div class="line"><a name="l12309"></a><span class="lineno">12309</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>)) {</div><div class="line"><a name="l12310"></a><span class="lineno">12310</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1af287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a>]))</div><div class="line"><a name="l12311"></a><span class="lineno">12311</span>&#160;               leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a> = opts[OPT_ARG_DTMFEXIT];</div><div class="line"><a name="l12312"></a><span class="lineno">12312</span>&#160;         }</div><div class="line"><a name="l12313"></a><span class="lineno">12313</span>&#160;      }</div><div class="line"><a name="l12314"></a><span class="lineno">12314</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea53daa71cf2e363ddf352934ca66b60ee">OPT_BEEP</a>)) { <span class="comment">/* Use custom beep (or none at all) */</span></div><div class="line"><a name="l12315"></a><span class="lineno">12315</span>&#160;         leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a> = opts[<a class="code" href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ace0cd0142789f22dc002e491bba8db66">OPT_ARG_BEEP_TONE</a>];</div><div class="line"><a name="l12316"></a><span class="lineno">12316</span>&#160;      } <span class="keywordflow">else</span> { <span class="comment">/* Use default beep */</span></div><div class="line"><a name="l12317"></a><span class="lineno">12317</span>&#160;         leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a> = <span class="stringliteral">&quot;beep&quot;</span>;</div><div class="line"><a name="l12318"></a><span class="lineno">12318</span>&#160;      }</div><div class="line"><a name="l12319"></a><span class="lineno">12319</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12320"></a><span class="lineno">12320</span>&#160;      <span class="keywordtype">char</span> temp[256];</div><div class="line"><a name="l12321"></a><span class="lineno">12321</span>&#160;      res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af3f76858d4dd513e59dbe5e67bc46220">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;vm-whichbox&quot;</span>, temp, <span class="keyword">sizeof</span>(temp) - 1, 0);</div><div class="line"><a name="l12322"></a><span class="lineno">12322</span>&#160;      <span class="keywordflow">if</span> (res &lt; 0)</div><div class="line"><a name="l12323"></a><span class="lineno">12323</span>&#160;         <span class="keywordflow">return</span> res;</div><div class="line"><a name="l12324"></a><span class="lineno">12324</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(temp))</div><div class="line"><a name="l12325"></a><span class="lineno">12325</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l12326"></a><span class="lineno">12326</span>&#160;      <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0 = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(temp);</div><div class="line"><a name="l12327"></a><span class="lineno">12327</span>&#160;   }</div><div class="line"><a name="l12328"></a><span class="lineno">12328</span>&#160;</div><div class="line"><a name="l12329"></a><span class="lineno">12329</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660">ast_channel_state</a>(chan) != <a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {</div><div class="line"><a name="l12330"></a><span class="lineno">12330</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea839b6e6f240aa580e222e9a21bcea333">OPT_EARLYM_GREETING</a>)) {</div><div class="line"><a name="l12331"></a><span class="lineno">12331</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#aef2af15a597c948e97628da6c5c84f28">ast_indicate</a>(chan, <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd">AST_CONTROL_PROGRESS</a>);</div><div class="line"><a name="l12332"></a><span class="lineno">12332</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12333"></a><span class="lineno">12333</span>&#160;         <a class="code" href="../../d5/d7b/channel_8h.html#aec583a3e25358ee552a4f3df53914cd0">ast_answer</a>(chan);</div><div class="line"><a name="l12334"></a><span class="lineno">12334</span>&#160;      }</div><div class="line"><a name="l12335"></a><span class="lineno">12335</span>&#160;   }</div><div class="line"><a name="l12336"></a><span class="lineno">12336</span>&#160;</div><div class="line"><a name="l12337"></a><span class="lineno">12337</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff">leave_voicemail</a>(chan, <a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>.argv0, &amp;leave_options);</div><div class="line"><a name="l12338"></a><span class="lineno">12338</span>&#160;   <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;t&#39;</span>) {</div><div class="line"><a name="l12339"></a><span class="lineno">12339</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);</div><div class="line"><a name="l12340"></a><span class="lineno">12340</span>&#160;      res = 0;</div><div class="line"><a name="l12341"></a><span class="lineno">12341</span>&#160;   }</div><div class="line"><a name="l12342"></a><span class="lineno">12342</span>&#160;</div><div class="line"><a name="l12343"></a><span class="lineno">12343</span>&#160;   <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a>) {</div><div class="line"><a name="l12344"></a><span class="lineno">12344</span>&#160;      res = 0;</div><div class="line"><a name="l12345"></a><span class="lineno">12345</span>&#160;   }</div><div class="line"><a name="l12346"></a><span class="lineno">12346</span>&#160;</div><div class="line"><a name="l12347"></a><span class="lineno">12347</span>&#160;   <span class="keywordflow">if</span> (res == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {</div><div class="line"><a name="l12348"></a><span class="lineno">12348</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not leave voicemail. The path is already locked.\n&quot;</span>);</div><div class="line"><a name="l12349"></a><span class="lineno">12349</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);</div><div class="line"><a name="l12350"></a><span class="lineno">12350</span>&#160;      res = 0;</div><div class="line"><a name="l12351"></a><span class="lineno">12351</span>&#160;   }</div><div class="line"><a name="l12352"></a><span class="lineno">12352</span>&#160;</div><div class="line"><a name="l12353"></a><span class="lineno">12353</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l12354"></a><span class="lineno">12354</span>&#160;}</div><div class="line"><a name="l12355"></a><span class="lineno">12355</span>&#160;</div><div class="line"><a name="l12356"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa57da8ecdd64dee4836a96e86dbd7687">12356</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa57da8ecdd64dee4836a96e86dbd7687">add_message_id</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg, <span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msg, <span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keywordtype">size_t</span> id_size, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> folder)</div><div class="line"><a name="l12357"></a><span class="lineno">12357</span>&#160;{</div><div class="line"><a name="l12358"></a><span class="lineno">12358</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l12359"></a><span class="lineno">12359</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d7/db2/structast__category.html">ast_category</a> *cat;</div><div class="line"><a name="l12360"></a><span class="lineno">12360</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a>(<span class="keywordtype">id</span>);</div><div class="line"><a name="l12361"></a><span class="lineno">12361</span>&#160;</div><div class="line"><a name="l12362"></a><span class="lineno">12362</span>&#160;   var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66581086d34dfe7ea86b0644bacef239">ast_variable_new</a>(<span class="stringliteral">&quot;msg_id&quot;</span>, <span class="keywordtype">id</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l12363"></a><span class="lineno">12363</span>&#160;   <span class="keywordflow">if</span> (!var) {</div><div class="line"><a name="l12364"></a><span class="lineno">12364</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12365"></a><span class="lineno">12365</span>&#160;   }</div><div class="line"><a name="l12366"></a><span class="lineno">12366</span>&#160;</div><div class="line"><a name="l12367"></a><span class="lineno">12367</span>&#160;   cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a976052ba6bdad7e94e60cd4bc1c3f3b2">ast_category_get</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l12368"></a><span class="lineno">12368</span>&#160;   <span class="keywordflow">if</span> (!cat) {</div><div class="line"><a name="l12369"></a><span class="lineno">12369</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Voicemail data file %s/%d.txt has no [message] category?\n&quot;</span>, dir, msg);</div><div class="line"><a name="l12370"></a><span class="lineno">12370</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#adea5390496e5477192d86f340d512d04">ast_variables_destroy</a>(var);</div><div class="line"><a name="l12371"></a><span class="lineno">12371</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12372"></a><span class="lineno">12372</span>&#160;   }</div><div class="line"><a name="l12373"></a><span class="lineno">12373</span>&#160;</div><div class="line"><a name="l12374"></a><span class="lineno">12374</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a57a3200e5b440d7135eaf0450ea559fe">ast_variable_append</a>(cat, var);</div><div class="line"><a name="l12375"></a><span class="lineno">12375</span>&#160;</div><div class="line"><a name="l12376"></a><span class="lineno">12376</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(filename, msg_cfg, <span class="stringliteral">&quot;app_voicemail&quot;</span>)) {</div><div class="line"><a name="l12377"></a><span class="lineno">12377</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to update %s to have a message ID\n&quot;</span>, filename);</div><div class="line"><a name="l12378"></a><span class="lineno">12378</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12379"></a><span class="lineno">12379</span>&#160;   }</div><div class="line"><a name="l12380"></a><span class="lineno">12380</span>&#160;</div><div class="line"><a name="l12381"></a><span class="lineno">12381</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a368cc0cb8f1c6fa742a6c6741ceb874e">UPDATE_MSG_ID</a>(dir, msg, <span class="keywordtype">id</span>, vmu, msg_cfg, folder);</div><div class="line"><a name="l12382"></a><span class="lineno">12382</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l12383"></a><span class="lineno">12383</span>&#160;}</div><div class="line"><a name="l12384"></a><span class="lineno">12384</span>&#160;</div><div class="line"><a name="l12385"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">12385</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *box)</div><div class="line"><a name="l12386"></a><span class="lineno">12386</span>&#160;{</div><div class="line"><a name="l12387"></a><span class="lineno">12387</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l12388"></a><span class="lineno">12388</span>&#160;</div><div class="line"><a name="l12389"></a><span class="lineno">12389</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(box) &amp;&amp; box[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l12390"></a><span class="lineno">12390</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Mailbox %s in context %s begins with &#39;*&#39; character.  The &#39;*&#39; character,&quot;</span></div><div class="line"><a name="l12391"></a><span class="lineno">12391</span>&#160;            <span class="stringliteral">&quot;\n\twhen it is the first character in a mailbox or password, is used to jump to a&quot;</span></div><div class="line"><a name="l12392"></a><span class="lineno">12392</span>&#160;            <span class="stringliteral">&quot;\n\tpredefined extension &#39;a&#39;.  A mailbox or password beginning with &#39;*&#39; is not valid&quot;</span></div><div class="line"><a name="l12393"></a><span class="lineno">12393</span>&#160;            <span class="stringliteral">&quot;\n\tand will be ignored.\n&quot;</span>, box, context);</div><div class="line"><a name="l12394"></a><span class="lineno">12394</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12395"></a><span class="lineno">12395</span>&#160;   }</div><div class="line"><a name="l12396"></a><span class="lineno">12396</span>&#160;</div><div class="line"><a name="l12397"></a><span class="lineno">12397</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l12398"></a><span class="lineno">12398</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>) &amp;&amp; !strcasecmp(box, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) {</div><div class="line"><a name="l12399"></a><span class="lineno">12399</span>&#160;         <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, context)) {</div><div class="line"><a name="l12400"></a><span class="lineno">12400</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;\nIt has been detected that you have defined mailbox &#39;%s&#39; in separate\</span></div><div class="line"><a name="l12401"></a><span class="lineno">12401</span>&#160;<span class="stringliteral">                  \n\tcontexts and that you have the &#39;searchcontexts&#39; option on. This type of\</span></div><div class="line"><a name="l12402"></a><span class="lineno">12402</span>&#160;<span class="stringliteral">                  \n\tconfiguration creates an ambiguity that you likely do not want. Please\</span></div><div class="line"><a name="l12403"></a><span class="lineno">12403</span>&#160;<span class="stringliteral">                  \n\tamend your voicemail.conf file to avoid this situation.\n&quot;</span>, box);</div><div class="line"><a name="l12404"></a><span class="lineno">12404</span>&#160;         }</div><div class="line"><a name="l12405"></a><span class="lineno">12405</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring duplicated mailbox %s\n&quot;</span>, box);</div><div class="line"><a name="l12406"></a><span class="lineno">12406</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12407"></a><span class="lineno">12407</span>&#160;      }</div><div class="line"><a name="l12408"></a><span class="lineno">12408</span>&#160;      <span class="keywordflow">if</span> (!strcasecmp(context, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>) &amp;&amp; !strcasecmp(box, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) {</div><div class="line"><a name="l12409"></a><span class="lineno">12409</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring duplicated mailbox %s in context %s\n&quot;</span>, box, context);</div><div class="line"><a name="l12410"></a><span class="lineno">12410</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12411"></a><span class="lineno">12411</span>&#160;      }</div><div class="line"><a name="l12412"></a><span class="lineno">12412</span>&#160;   }</div><div class="line"><a name="l12413"></a><span class="lineno">12413</span>&#160;</div><div class="line"><a name="l12414"></a><span class="lineno">12414</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*vmu))))</div><div class="line"><a name="l12415"></a><span class="lineno">12415</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12416"></a><span class="lineno">12416</span>&#160;</div><div class="line"><a name="l12417"></a><span class="lineno">12417</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, context, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>));</div><div class="line"><a name="l12418"></a><span class="lineno">12418</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, box, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>));</div><div class="line"><a name="l12419"></a><span class="lineno">12419</span>&#160;</div><div class="line"><a name="l12420"></a><span class="lineno">12420</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>);</div><div class="line"><a name="l12421"></a><span class="lineno">12421</span>&#160;</div><div class="line"><a name="l12422"></a><span class="lineno">12422</span>&#160;   <span class="keywordflow">return</span> vmu;</div><div class="line"><a name="l12423"></a><span class="lineno">12423</span>&#160;}</div><div class="line"><a name="l12424"></a><span class="lineno">12424</span>&#160;</div><div class="line"><a name="l12425"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">12425</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">append_mailbox</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *box, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line"><a name="l12426"></a><span class="lineno">12426</span>&#160;{</div><div class="line"><a name="l12427"></a><span class="lineno">12427</span>&#160;   <span class="comment">/* Assumes lock is already held */</span></div><div class="line"><a name="l12428"></a><span class="lineno">12428</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l12429"></a><span class="lineno">12429</span>&#160;   <span class="keywordtype">char</span> *stringp;</div><div class="line"><a name="l12430"></a><span class="lineno">12430</span>&#160;   <span class="keywordtype">char</span> *s;</div><div class="line"><a name="l12431"></a><span class="lineno">12431</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l12432"></a><span class="lineno">12432</span>&#160;   <span class="keywordtype">char</span> mailbox_full[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a>];</div><div class="line"><a name="l12433"></a><span class="lineno">12433</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;</div><div class="line"><a name="l12434"></a><span class="lineno">12434</span>&#160;   <span class="keywordtype">char</span> secretfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l12435"></a><span class="lineno">12435</span>&#160;</div><div class="line"><a name="l12436"></a><span class="lineno">12436</span>&#160;   tmp = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(data);</div><div class="line"><a name="l12437"></a><span class="lineno">12437</span>&#160;</div><div class="line"><a name="l12438"></a><span class="lineno">12438</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(context, box)))</div><div class="line"><a name="l12439"></a><span class="lineno">12439</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12440"></a><span class="lineno">12440</span>&#160;</div><div class="line"><a name="l12441"></a><span class="lineno">12441</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l12442"></a><span class="lineno">12442</span>&#160;</div><div class="line"><a name="l12443"></a><span class="lineno">12443</span>&#160;   stringp = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l12444"></a><span class="lineno">12444</span>&#160;   <span class="keywordflow">if</span> ((s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) {</div><div class="line"><a name="l12445"></a><span class="lineno">12445</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(s) &amp;&amp; s[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l12446"></a><span class="lineno">12446</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid password detected for mailbox %s.  The password&quot;</span></div><div class="line"><a name="l12447"></a><span class="lineno">12447</span>&#160;            <span class="stringliteral">&quot;\n\tmust be reset in voicemail.conf.\n&quot;</span>, box);</div><div class="line"><a name="l12448"></a><span class="lineno">12448</span>&#160;      }</div><div class="line"><a name="l12449"></a><span class="lineno">12449</span>&#160;      <span class="comment">/* assign password regardless of validity to prevent NULL password from being assigned */</span></div><div class="line"><a name="l12450"></a><span class="lineno">12450</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l12451"></a><span class="lineno">12451</span>&#160;   }</div><div class="line"><a name="l12452"></a><span class="lineno">12452</span>&#160;   <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) {</div><div class="line"><a name="l12453"></a><span class="lineno">12453</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>));</div><div class="line"><a name="l12454"></a><span class="lineno">12454</span>&#160;   }</div><div class="line"><a name="l12455"></a><span class="lineno">12455</span>&#160;   <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) {</div><div class="line"><a name="l12456"></a><span class="lineno">12456</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(s);</div><div class="line"><a name="l12457"></a><span class="lineno">12457</span>&#160;   }</div><div class="line"><a name="l12458"></a><span class="lineno">12458</span>&#160;   <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) {</div><div class="line"><a name="l12459"></a><span class="lineno">12459</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>));</div><div class="line"><a name="l12460"></a><span class="lineno">12460</span>&#160;   }</div><div class="line"><a name="l12461"></a><span class="lineno">12461</span>&#160;   <span class="keywordflow">if</span> (stringp) {</div><div class="line"><a name="l12462"></a><span class="lineno">12462</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a>(vmu, stringp);</div><div class="line"><a name="l12463"></a><span class="lineno">12463</span>&#160;   }</div><div class="line"><a name="l12464"></a><span class="lineno">12464</span>&#160;</div><div class="line"><a name="l12465"></a><span class="lineno">12465</span>&#160;   <span class="keywordflow">switch</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a>) {</div><div class="line"><a name="l12466"></a><span class="lineno">12466</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>:</div><div class="line"><a name="l12467"></a><span class="lineno">12467</span>&#160;      snprintf(secretfn, <span class="keyword">sizeof</span>(secretfn), <span class="stringliteral">&quot;%s%s/%s/secret.conf&quot;</span>, VM_SPOOL_DIR, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l12468"></a><span class="lineno">12468</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a27203edbc5e249fcac868c0488271b29">read_password_from_file</a>(secretfn, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l12469"></a><span class="lineno">12469</span>&#160;   }</div><div class="line"><a name="l12470"></a><span class="lineno">12470</span>&#160;</div><div class="line"><a name="l12471"></a><span class="lineno">12471</span>&#160;   snprintf(mailbox_full, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a>, <span class="stringliteral">&quot;%s%s%s&quot;</span>,</div><div class="line"><a name="l12472"></a><span class="lineno">12472</span>&#160;      box,</div><div class="line"><a name="l12473"></a><span class="lineno">12473</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;@&quot;</span>,</div><div class="line"><a name="l12474"></a><span class="lineno">12474</span>&#160;      context);</div><div class="line"><a name="l12475"></a><span class="lineno">12475</span>&#160;</div><div class="line"><a name="l12476"></a><span class="lineno">12476</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(mailbox_full, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);</div><div class="line"><a name="l12477"></a><span class="lineno">12477</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l12478"></a><span class="lineno">12478</span>&#160;   imap_logout(mailbox_full);</div><div class="line"><a name="l12479"></a><span class="lineno">12479</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12480"></a><span class="lineno">12480</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mailbox_full, urgent, <span class="keyword">new</span>, old);</div><div class="line"><a name="l12481"></a><span class="lineno">12481</span>&#160;</div><div class="line"><a name="l12482"></a><span class="lineno">12482</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l12483"></a><span class="lineno">12483</span>&#160;}</div><div class="line"><a name="l12484"></a><span class="lineno">12484</span>&#160;</div><div class="line"><a name="l12485"></a><span class="lineno">12485</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l12486"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">12486</a></span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a>(test_voicemail_vmuser)</div><div class="line"><a name="l12487"></a><span class="lineno">12487</span>&#160;{</div><div class="line"><a name="l12488"></a><span class="lineno">12488</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l12489"></a><span class="lineno">12489</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l12490"></a><span class="lineno">12490</span>&#160;   <span class="comment">/* language parameter seems to only be used for display in manager action */</span></div><div class="line"><a name="l12491"></a><span class="lineno">12491</span>&#160;   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> options_string[] = <span class="stringliteral">&quot;attach=yes|attachfmt=wav49|&quot;</span></div><div class="line"><a name="l12492"></a><span class="lineno">12492</span>&#160;      <span class="stringliteral">&quot;serveremail=someguy@digium.com|fromstring=Voicemail System|tz=central|delete=yes|saycid=yes|&quot;</span></div><div class="line"><a name="l12493"></a><span class="lineno">12493</span>&#160;      <span class="stringliteral">&quot;sendvoicemail=yes|review=yes|tempgreetwarn=yes|messagewrap=yes|operator=yes|&quot;</span></div><div class="line"><a name="l12494"></a><span class="lineno">12494</span>&#160;      <span class="stringliteral">&quot;envelope=yes|moveheard=yes|sayduration=yes|saydurationm=5|forcename=yes|&quot;</span></div><div class="line"><a name="l12495"></a><span class="lineno">12495</span>&#160;      <span class="stringliteral">&quot;forcegreetings=yes|callback=somecontext|dialout=somecontext2|&quot;</span></div><div class="line"><a name="l12496"></a><span class="lineno">12496</span>&#160;      <span class="stringliteral">&quot;exitcontext=somecontext3|minsecs=10|maxsecs=100|nextaftercmd=yes|&quot;</span></div><div class="line"><a name="l12497"></a><span class="lineno">12497</span>&#160;      <span class="stringliteral">&quot;backupdeleted=50|volgain=1.3|passwordlocation=spooldir|emailbody=&quot;</span></div><div class="line"><a name="l12498"></a><span class="lineno">12498</span>&#160;      <span class="stringliteral">&quot;Dear ${VM_NAME}:\n\n\tYou were just left a ${VM_DUR} long message|emailsubject=&quot;</span></div><div class="line"><a name="l12499"></a><span class="lineno">12499</span>&#160;      <span class="stringliteral">&quot;[PBX]: New message \\\\${VM_MSGNUM}\\\\ in mailbox ${VM_MAILBOX}&quot;</span>;</div><div class="line"><a name="l12500"></a><span class="lineno">12500</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l12501"></a><span class="lineno">12501</span>&#160;   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> option_string2[] = <span class="stringliteral">&quot;imapuser=imapuser|imappassword=imappasswd|&quot;</span></div><div class="line"><a name="l12502"></a><span class="lineno">12502</span>&#160;      <span class="stringliteral">&quot;imapfolder=INBOX|imapvmshareid=6000|imapserver=imapserver|imapport=1234|imapflags=flagged&quot;</span>;</div><div class="line"><a name="l12503"></a><span class="lineno">12503</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12504"></a><span class="lineno">12504</span>&#160;</div><div class="line"><a name="l12505"></a><span class="lineno">12505</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l12506"></a><span class="lineno">12506</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a>:</div><div class="line"><a name="l12507"></a><span class="lineno">12507</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;name = <span class="stringliteral">&quot;vmuser&quot;</span>;</div><div class="line"><a name="l12508"></a><span class="lineno">12508</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;category = <span class="stringliteral">&quot;/apps/app_voicemail/&quot;</span>;</div><div class="line"><a name="l12509"></a><span class="lineno">12509</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;summary = <span class="stringliteral">&quot;Vmuser unit test&quot;</span>;</div><div class="line"><a name="l12510"></a><span class="lineno">12510</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;description =</div><div class="line"><a name="l12511"></a><span class="lineno">12511</span>&#160;         <span class="stringliteral">&quot;This tests passing all supported parameters to apply_options, the voicemail user config parser&quot;</span>;</div><div class="line"><a name="l12512"></a><span class="lineno">12512</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l12513"></a><span class="lineno">12513</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a>:</div><div class="line"><a name="l12514"></a><span class="lineno">12514</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l12515"></a><span class="lineno">12515</span>&#160;   }</div><div class="line"><a name="l12516"></a><span class="lineno">12516</span>&#160;</div><div class="line"><a name="l12517"></a><span class="lineno">12517</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*vmu)))) {</div><div class="line"><a name="l12518"></a><span class="lineno">12518</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l12519"></a><span class="lineno">12519</span>&#160;   }</div><div class="line"><a name="l12520"></a><span class="lineno">12520</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l12521"></a><span class="lineno">12521</span>&#160;   <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);</div><div class="line"><a name="l12522"></a><span class="lineno">12522</span>&#160;</div><div class="line"><a name="l12523"></a><span class="lineno">12523</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a>(vmu, options_string);</div><div class="line"><a name="l12524"></a><span class="lineno">12524</span>&#160;</div><div class="line"><a name="l12525"></a><span class="lineno">12525</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>)) {</div><div class="line"><a name="l12526"></a><span class="lineno">12526</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for attach option\n&quot;</span>);</div><div class="line"><a name="l12527"></a><span class="lineno">12527</span>&#160;      res = 1;</div><div class="line"><a name="l12528"></a><span class="lineno">12528</span>&#160;   }</div><div class="line"><a name="l12529"></a><span class="lineno">12529</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>, <span class="stringliteral">&quot;wav49&quot;</span>)) {</div><div class="line"><a name="l12530"></a><span class="lineno">12530</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for attachftm option\n&quot;</span>);</div><div class="line"><a name="l12531"></a><span class="lineno">12531</span>&#160;      res = 1;</div><div class="line"><a name="l12532"></a><span class="lineno">12532</span>&#160;   }</div><div class="line"><a name="l12533"></a><span class="lineno">12533</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>, <span class="stringliteral">&quot;Voicemail System&quot;</span>)) {</div><div class="line"><a name="l12534"></a><span class="lineno">12534</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for fromstring option\n&quot;</span>);</div><div class="line"><a name="l12535"></a><span class="lineno">12535</span>&#160;      res = 1;</div><div class="line"><a name="l12536"></a><span class="lineno">12536</span>&#160;   }</div><div class="line"><a name="l12537"></a><span class="lineno">12537</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>, <span class="stringliteral">&quot;someguy@digium.com&quot;</span>)) {</div><div class="line"><a name="l12538"></a><span class="lineno">12538</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for serveremail option\n&quot;</span>);</div><div class="line"><a name="l12539"></a><span class="lineno">12539</span>&#160;      res = 1;</div><div class="line"><a name="l12540"></a><span class="lineno">12540</span>&#160;   }</div><div class="line"><a name="l12541"></a><span class="lineno">12541</span>&#160;   <span class="keywordflow">if</span> (!vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> || strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>, <span class="stringliteral">&quot;[PBX]: New message \\${VM_MSGNUM}\\ in mailbox ${VM_MAILBOX}&quot;</span>)) {</div><div class="line"><a name="l12542"></a><span class="lineno">12542</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for emailsubject option\n&quot;</span>);</div><div class="line"><a name="l12543"></a><span class="lineno">12543</span>&#160;      res = 1;</div><div class="line"><a name="l12544"></a><span class="lineno">12544</span>&#160;   }</div><div class="line"><a name="l12545"></a><span class="lineno">12545</span>&#160;   <span class="keywordflow">if</span> (!vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> || strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>, <span class="stringliteral">&quot;Dear ${VM_NAME}:\n\n\tYou were just left a ${VM_DUR} long message&quot;</span>)) {</div><div class="line"><a name="l12546"></a><span class="lineno">12546</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for emailbody option\n&quot;</span>);</div><div class="line"><a name="l12547"></a><span class="lineno">12547</span>&#160;      res = 1;</div><div class="line"><a name="l12548"></a><span class="lineno">12548</span>&#160;   }</div><div class="line"><a name="l12549"></a><span class="lineno">12549</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, <span class="stringliteral">&quot;central&quot;</span>)) {</div><div class="line"><a name="l12550"></a><span class="lineno">12550</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for tz option\n&quot;</span>);</div><div class="line"><a name="l12551"></a><span class="lineno">12551</span>&#160;      res = 1;</div><div class="line"><a name="l12552"></a><span class="lineno">12552</span>&#160;   }</div><div class="line"><a name="l12553"></a><span class="lineno">12553</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>)) {</div><div class="line"><a name="l12554"></a><span class="lineno">12554</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for delete option\n&quot;</span>);</div><div class="line"><a name="l12555"></a><span class="lineno">12555</span>&#160;      res = 1;</div><div class="line"><a name="l12556"></a><span class="lineno">12556</span>&#160;   }</div><div class="line"><a name="l12557"></a><span class="lineno">12557</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>)) {</div><div class="line"><a name="l12558"></a><span class="lineno">12558</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for saycid option\n&quot;</span>);</div><div class="line"><a name="l12559"></a><span class="lineno">12559</span>&#160;      res = 1;</div><div class="line"><a name="l12560"></a><span class="lineno">12560</span>&#160;   }</div><div class="line"><a name="l12561"></a><span class="lineno">12561</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>)) {</div><div class="line"><a name="l12562"></a><span class="lineno">12562</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for sendvoicemail option\n&quot;</span>);</div><div class="line"><a name="l12563"></a><span class="lineno">12563</span>&#160;      res = 1;</div><div class="line"><a name="l12564"></a><span class="lineno">12564</span>&#160;   }</div><div class="line"><a name="l12565"></a><span class="lineno">12565</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>)) {</div><div class="line"><a name="l12566"></a><span class="lineno">12566</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for review option\n&quot;</span>);</div><div class="line"><a name="l12567"></a><span class="lineno">12567</span>&#160;      res = 1;</div><div class="line"><a name="l12568"></a><span class="lineno">12568</span>&#160;   }</div><div class="line"><a name="l12569"></a><span class="lineno">12569</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>)) {</div><div class="line"><a name="l12570"></a><span class="lineno">12570</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for tempgreetwarm option\n&quot;</span>);</div><div class="line"><a name="l12571"></a><span class="lineno">12571</span>&#160;      res = 1;</div><div class="line"><a name="l12572"></a><span class="lineno">12572</span>&#160;   }</div><div class="line"><a name="l12573"></a><span class="lineno">12573</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>)) {</div><div class="line"><a name="l12574"></a><span class="lineno">12574</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for messagewrap option\n&quot;</span>);</div><div class="line"><a name="l12575"></a><span class="lineno">12575</span>&#160;      res = 1;</div><div class="line"><a name="l12576"></a><span class="lineno">12576</span>&#160;   }</div><div class="line"><a name="l12577"></a><span class="lineno">12577</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>)) {</div><div class="line"><a name="l12578"></a><span class="lineno">12578</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for operator option\n&quot;</span>);</div><div class="line"><a name="l12579"></a><span class="lineno">12579</span>&#160;      res = 1;</div><div class="line"><a name="l12580"></a><span class="lineno">12580</span>&#160;   }</div><div class="line"><a name="l12581"></a><span class="lineno">12581</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>)) {</div><div class="line"><a name="l12582"></a><span class="lineno">12582</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for envelope option\n&quot;</span>);</div><div class="line"><a name="l12583"></a><span class="lineno">12583</span>&#160;      res = 1;</div><div class="line"><a name="l12584"></a><span class="lineno">12584</span>&#160;   }</div><div class="line"><a name="l12585"></a><span class="lineno">12585</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>)) {</div><div class="line"><a name="l12586"></a><span class="lineno">12586</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for moveheard option\n&quot;</span>);</div><div class="line"><a name="l12587"></a><span class="lineno">12587</span>&#160;      res = 1;</div><div class="line"><a name="l12588"></a><span class="lineno">12588</span>&#160;   }</div><div class="line"><a name="l12589"></a><span class="lineno">12589</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>)) {</div><div class="line"><a name="l12590"></a><span class="lineno">12590</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for sayduration option\n&quot;</span>);</div><div class="line"><a name="l12591"></a><span class="lineno">12591</span>&#160;      res = 1;</div><div class="line"><a name="l12592"></a><span class="lineno">12592</span>&#160;   }</div><div class="line"><a name="l12593"></a><span class="lineno">12593</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a> != 5) {</div><div class="line"><a name="l12594"></a><span class="lineno">12594</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for saydurationm option\n&quot;</span>);</div><div class="line"><a name="l12595"></a><span class="lineno">12595</span>&#160;      res = 1;</div><div class="line"><a name="l12596"></a><span class="lineno">12596</span>&#160;   }</div><div class="line"><a name="l12597"></a><span class="lineno">12597</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>)) {</div><div class="line"><a name="l12598"></a><span class="lineno">12598</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for forcename option\n&quot;</span>);</div><div class="line"><a name="l12599"></a><span class="lineno">12599</span>&#160;      res = 1;</div><div class="line"><a name="l12600"></a><span class="lineno">12600</span>&#160;   }</div><div class="line"><a name="l12601"></a><span class="lineno">12601</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>)) {</div><div class="line"><a name="l12602"></a><span class="lineno">12602</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for forcegreetings option\n&quot;</span>);</div><div class="line"><a name="l12603"></a><span class="lineno">12603</span>&#160;      res = 1;</div><div class="line"><a name="l12604"></a><span class="lineno">12604</span>&#160;   }</div><div class="line"><a name="l12605"></a><span class="lineno">12605</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>, <span class="stringliteral">&quot;somecontext&quot;</span>)) {</div><div class="line"><a name="l12606"></a><span class="lineno">12606</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for callbacks option\n&quot;</span>);</div><div class="line"><a name="l12607"></a><span class="lineno">12607</span>&#160;      res = 1;</div><div class="line"><a name="l12608"></a><span class="lineno">12608</span>&#160;   }</div><div class="line"><a name="l12609"></a><span class="lineno">12609</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>, <span class="stringliteral">&quot;somecontext2&quot;</span>)) {</div><div class="line"><a name="l12610"></a><span class="lineno">12610</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for dialout option\n&quot;</span>);</div><div class="line"><a name="l12611"></a><span class="lineno">12611</span>&#160;      res = 1;</div><div class="line"><a name="l12612"></a><span class="lineno">12612</span>&#160;   }</div><div class="line"><a name="l12613"></a><span class="lineno">12613</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="stringliteral">&quot;somecontext3&quot;</span>)) {</div><div class="line"><a name="l12614"></a><span class="lineno">12614</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for exitcontext option\n&quot;</span>);</div><div class="line"><a name="l12615"></a><span class="lineno">12615</span>&#160;      res = 1;</div><div class="line"><a name="l12616"></a><span class="lineno">12616</span>&#160;   }</div><div class="line"><a name="l12617"></a><span class="lineno">12617</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">minsecs</a> != 10) {</div><div class="line"><a name="l12618"></a><span class="lineno">12618</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for minsecs option\n&quot;</span>);</div><div class="line"><a name="l12619"></a><span class="lineno">12619</span>&#160;      res = 1;</div><div class="line"><a name="l12620"></a><span class="lineno">12620</span>&#160;   }</div><div class="line"><a name="l12621"></a><span class="lineno">12621</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> != 100) {</div><div class="line"><a name="l12622"></a><span class="lineno">12622</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for maxsecs option\n&quot;</span>);</div><div class="line"><a name="l12623"></a><span class="lineno">12623</span>&#160;      res = 1;</div><div class="line"><a name="l12624"></a><span class="lineno">12624</span>&#160;   }</div><div class="line"><a name="l12625"></a><span class="lineno">12625</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>)) {</div><div class="line"><a name="l12626"></a><span class="lineno">12626</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for nextaftercmd option\n&quot;</span>);</div><div class="line"><a name="l12627"></a><span class="lineno">12627</span>&#160;      res = 1;</div><div class="line"><a name="l12628"></a><span class="lineno">12628</span>&#160;   }</div><div class="line"><a name="l12629"></a><span class="lineno">12629</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> != 50) {</div><div class="line"><a name="l12630"></a><span class="lineno">12630</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for backupdeleted option\n&quot;</span>);</div><div class="line"><a name="l12631"></a><span class="lineno">12631</span>&#160;      res = 1;</div><div class="line"><a name="l12632"></a><span class="lineno">12632</span>&#160;   }</div><div class="line"><a name="l12633"></a><span class="lineno">12633</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> != 1.3) {</div><div class="line"><a name="l12634"></a><span class="lineno">12634</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for volgain option\n&quot;</span>);</div><div class="line"><a name="l12635"></a><span class="lineno">12635</span>&#160;      res = 1;</div><div class="line"><a name="l12636"></a><span class="lineno">12636</span>&#160;   }</div><div class="line"><a name="l12637"></a><span class="lineno">12637</span>&#160;   <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a> != <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>) {</div><div class="line"><a name="l12638"></a><span class="lineno">12638</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for passwordlocation option\n&quot;</span>);</div><div class="line"><a name="l12639"></a><span class="lineno">12639</span>&#160;      res = 1;</div><div class="line"><a name="l12640"></a><span class="lineno">12640</span>&#160;   }</div><div class="line"><a name="l12641"></a><span class="lineno">12641</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l12642"></a><span class="lineno">12642</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a>(vmu, option_string2);</div><div class="line"><a name="l12643"></a><span class="lineno">12643</span>&#160;</div><div class="line"><a name="l12644"></a><span class="lineno">12644</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imapuser, <span class="stringliteral">&quot;imapuser&quot;</span>)) {</div><div class="line"><a name="l12645"></a><span class="lineno">12645</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imapuser option\n&quot;</span>);</div><div class="line"><a name="l12646"></a><span class="lineno">12646</span>&#160;      res = 1;</div><div class="line"><a name="l12647"></a><span class="lineno">12647</span>&#160;   }</div><div class="line"><a name="l12648"></a><span class="lineno">12648</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imappassword, <span class="stringliteral">&quot;imappasswd&quot;</span>)) {</div><div class="line"><a name="l12649"></a><span class="lineno">12649</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imappasswd option\n&quot;</span>);</div><div class="line"><a name="l12650"></a><span class="lineno">12650</span>&#160;      res = 1;</div><div class="line"><a name="l12651"></a><span class="lineno">12651</span>&#160;   }</div><div class="line"><a name="l12652"></a><span class="lineno">12652</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imapfolder, <span class="stringliteral">&quot;INBOX&quot;</span>)) {</div><div class="line"><a name="l12653"></a><span class="lineno">12653</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imapfolder option\n&quot;</span>);</div><div class="line"><a name="l12654"></a><span class="lineno">12654</span>&#160;      res = 1;</div><div class="line"><a name="l12655"></a><span class="lineno">12655</span>&#160;   }</div><div class="line"><a name="l12656"></a><span class="lineno">12656</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imapvmshareid, <span class="stringliteral">&quot;6000&quot;</span>)) {</div><div class="line"><a name="l12657"></a><span class="lineno">12657</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imapvmshareid option\n&quot;</span>);</div><div class="line"><a name="l12658"></a><span class="lineno">12658</span>&#160;      res = 1;</div><div class="line"><a name="l12659"></a><span class="lineno">12659</span>&#160;   }</div><div class="line"><a name="l12660"></a><span class="lineno">12660</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imapserver, <span class="stringliteral">&quot;imapserver&quot;</span>)) {</div><div class="line"><a name="l12661"></a><span class="lineno">12661</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imapserver option\n&quot;</span>);</div><div class="line"><a name="l12662"></a><span class="lineno">12662</span>&#160;      res = 1;</div><div class="line"><a name="l12663"></a><span class="lineno">12663</span>&#160;   }</div><div class="line"><a name="l12664"></a><span class="lineno">12664</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imapport, <span class="stringliteral">&quot;1234&quot;</span>)) {</div><div class="line"><a name="l12665"></a><span class="lineno">12665</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imapport option\n&quot;</span>);</div><div class="line"><a name="l12666"></a><span class="lineno">12666</span>&#160;      res = 1;</div><div class="line"><a name="l12667"></a><span class="lineno">12667</span>&#160;   }</div><div class="line"><a name="l12668"></a><span class="lineno">12668</span>&#160;   <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;imapflags, <span class="stringliteral">&quot;flagged&quot;</span>)) {</div><div class="line"><a name="l12669"></a><span class="lineno">12669</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Parse failure for imapflags option\n&quot;</span>);</div><div class="line"><a name="l12670"></a><span class="lineno">12670</span>&#160;      res = 1;</div><div class="line"><a name="l12671"></a><span class="lineno">12671</span>&#160;   }</div><div class="line"><a name="l12672"></a><span class="lineno">12672</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12673"></a><span class="lineno">12673</span>&#160;</div><div class="line"><a name="l12674"></a><span class="lineno">12674</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l12675"></a><span class="lineno">12675</span>&#160;   <span class="keywordflow">return</span> res ? <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a> : <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a>;</div><div class="line"><a name="l12676"></a><span class="lineno">12676</span>&#160;}</div><div class="line"><a name="l12677"></a><span class="lineno">12677</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l12678"></a><span class="lineno">12678</span>&#160;</div><div class="line"><a name="l12679"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7f75e8f7c2c64f3b17397c3117fe2799">12679</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7f75e8f7c2c64f3b17397c3117fe2799">acf_vm_info</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *<a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len)</div><div class="line"><a name="l12680"></a><span class="lineno">12680</span>&#160;{</div><div class="line"><a name="l12681"></a><span class="lineno">12681</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> svm;</div><div class="line"><a name="l12682"></a><span class="lineno">12682</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12683"></a><span class="lineno">12683</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;</div><div class="line"><a name="l12684"></a><span class="lineno">12684</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l12685"></a><span class="lineno">12685</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l12686"></a><span class="lineno">12686</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l12687"></a><span class="lineno">12687</span>&#160;</div><div class="line"><a name="l12688"></a><span class="lineno">12688</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2">AST_DECLARE_APP_ARGS</a>(arg,</div><div class="line"><a name="l12689"></a><span class="lineno">12689</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(mailbox_context);</div><div class="line"><a name="l12690"></a><span class="lineno">12690</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(attribute);</div><div class="line"><a name="l12691"></a><span class="lineno">12691</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a>(folder);</div><div class="line"><a name="l12692"></a><span class="lineno">12692</span>&#160;   );</div><div class="line"><a name="l12693"></a><span class="lineno">12693</span>&#160;</div><div class="line"><a name="l12694"></a><span class="lineno">12694</span>&#160;   buf[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l12695"></a><span class="lineno">12695</span>&#160;</div><div class="line"><a name="l12696"></a><span class="lineno">12696</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(args)) {</div><div class="line"><a name="l12697"></a><span class="lineno">12697</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;VM_INFO requires an argument (&lt;mailbox&gt;[@&lt;context&gt;],attribute[,folder])\n&quot;</span>);</div><div class="line"><a name="l12698"></a><span class="lineno">12698</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12699"></a><span class="lineno">12699</span>&#160;   }</div><div class="line"><a name="l12700"></a><span class="lineno">12700</span>&#160;</div><div class="line"><a name="l12701"></a><span class="lineno">12701</span>&#160;   parse = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(args);</div><div class="line"><a name="l12702"></a><span class="lineno">12702</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8">AST_STANDARD_APP_ARGS</a>(arg, parse);</div><div class="line"><a name="l12703"></a><span class="lineno">12703</span>&#160;</div><div class="line"><a name="l12704"></a><span class="lineno">12704</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(arg.mailbox_context)</div><div class="line"><a name="l12705"></a><span class="lineno">12705</span>&#160;      || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(arg.attribute)</div><div class="line"><a name="l12706"></a><span class="lineno">12706</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(arg.mailbox_context), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l12707"></a><span class="lineno">12707</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;VM_INFO requires an argument (&lt;mailbox&gt;[@&lt;context&gt;],attribute[,folder])\n&quot;</span>);</div><div class="line"><a name="l12708"></a><span class="lineno">12708</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12709"></a><span class="lineno">12709</span>&#160;   }</div><div class="line"><a name="l12710"></a><span class="lineno">12710</span>&#160;</div><div class="line"><a name="l12711"></a><span class="lineno">12711</span>&#160;   memset(&amp;svm, 0, <span class="keyword">sizeof</span>(svm));</div><div class="line"><a name="l12712"></a><span class="lineno">12712</span>&#160;   vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;svm, context, mailbox);</div><div class="line"><a name="l12713"></a><span class="lineno">12713</span>&#160;</div><div class="line"><a name="l12714"></a><span class="lineno">12714</span>&#160;   <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;exists&quot;</span>, 5)) {</div><div class="line"><a name="l12715"></a><span class="lineno">12715</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span>, len);</div><div class="line"><a name="l12716"></a><span class="lineno">12716</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l12717"></a><span class="lineno">12717</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l12718"></a><span class="lineno">12718</span>&#160;   }</div><div class="line"><a name="l12719"></a><span class="lineno">12719</span>&#160;</div><div class="line"><a name="l12720"></a><span class="lineno">12720</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l12721"></a><span class="lineno">12721</span>&#160;      <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;password&quot;</span>, 8)) {</div><div class="line"><a name="l12722"></a><span class="lineno">12722</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, len);</div><div class="line"><a name="l12723"></a><span class="lineno">12723</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;fullname&quot;</span>, 8)) {</div><div class="line"><a name="l12724"></a><span class="lineno">12724</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, len);</div><div class="line"><a name="l12725"></a><span class="lineno">12725</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;email&quot;</span>, 5)) {</div><div class="line"><a name="l12726"></a><span class="lineno">12726</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>, len);</div><div class="line"><a name="l12727"></a><span class="lineno">12727</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;pager&quot;</span>, 5)) {</div><div class="line"><a name="l12728"></a><span class="lineno">12728</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, len);</div><div class="line"><a name="l12729"></a><span class="lineno">12729</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;language&quot;</span>, 8)) {</div><div class="line"><a name="l12730"></a><span class="lineno">12730</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan)), len);</div><div class="line"><a name="l12731"></a><span class="lineno">12731</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;locale&quot;</span>, 6)) {</div><div class="line"><a name="l12732"></a><span class="lineno">12732</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, len);</div><div class="line"><a name="l12733"></a><span class="lineno">12733</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;tz&quot;</span>, 2)) {</div><div class="line"><a name="l12734"></a><span class="lineno">12734</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(buf, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, len);</div><div class="line"><a name="l12735"></a><span class="lineno">12735</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(arg.attribute, <span class="stringliteral">&quot;count&quot;</span>, 5)) {</div><div class="line"><a name="l12736"></a><span class="lineno">12736</span>&#160;         <span class="keywordtype">char</span> *mailbox_id;</div><div class="line"><a name="l12737"></a><span class="lineno">12737</span>&#160;</div><div class="line"><a name="l12738"></a><span class="lineno">12738</span>&#160;         mailbox_id = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(strlen(mailbox) + strlen(context) + 2);</div><div class="line"><a name="l12739"></a><span class="lineno">12739</span>&#160;         sprintf(mailbox_id, <span class="stringliteral">&quot;%s@%s&quot;</span>, mailbox, context);<span class="comment">/* Safe */</span></div><div class="line"><a name="l12740"></a><span class="lineno">12740</span>&#160;</div><div class="line"><a name="l12741"></a><span class="lineno">12741</span>&#160;         <span class="comment">/* If mbxfolder is empty messagecount will default to INBOX */</span></div><div class="line"><a name="l12742"></a><span class="lineno">12742</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>(mailbox_id, arg.folder);</div><div class="line"><a name="l12743"></a><span class="lineno">12743</span>&#160;         <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line"><a name="l12744"></a><span class="lineno">12744</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to retrieve message count for mailbox %s\n&quot;</span>, arg.mailbox_context);</div><div class="line"><a name="l12745"></a><span class="lineno">12745</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l12746"></a><span class="lineno">12746</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12747"></a><span class="lineno">12747</span>&#160;         }</div><div class="line"><a name="l12748"></a><span class="lineno">12748</span>&#160;         snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, res);</div><div class="line"><a name="l12749"></a><span class="lineno">12749</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12750"></a><span class="lineno">12750</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unknown attribute &#39;%s&#39; for VM_INFO\n&quot;</span>, arg.attribute);</div><div class="line"><a name="l12751"></a><span class="lineno">12751</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l12752"></a><span class="lineno">12752</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l12753"></a><span class="lineno">12753</span>&#160;      }</div><div class="line"><a name="l12754"></a><span class="lineno">12754</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l12755"></a><span class="lineno">12755</span>&#160;   }</div><div class="line"><a name="l12756"></a><span class="lineno">12756</span>&#160;</div><div class="line"><a name="l12757"></a><span class="lineno">12757</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l12758"></a><span class="lineno">12758</span>&#160;}</div><div class="line"><a name="l12759"></a><span class="lineno">12759</span>&#160;</div><div class="line"><a name="l12760"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a18febf331f4093f15f5d7f62dae4efd6">12760</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../db/dc0/structast__custom__function.html">ast_custom_function</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a18febf331f4093f15f5d7f62dae4efd6">vm_info_acf</a> = {</div><div class="line"><a name="l12761"></a><span class="lineno">12761</span>&#160;   .<a class="code" href="../../db/dc0/structast__custom__function.html#afcd1706c9144e6d6eee6127661ae3be2">name</a> = <span class="stringliteral">&quot;VM_INFO&quot;</span>,</div><div class="line"><a name="l12762"></a><span class="lineno">12762</span>&#160;   .read = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7f75e8f7c2c64f3b17397c3117fe2799">acf_vm_info</a>,</div><div class="line"><a name="l12763"></a><span class="lineno">12763</span>&#160;};</div><div class="line"><a name="l12764"></a><span class="lineno">12764</span>&#160;</div><div class="line"><a name="l12765"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3b021ce22e11ba21591a3907cbbc12d8">12765</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3b021ce22e11ba21591a3907cbbc12d8">vmauthenticate</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line"><a name="l12766"></a><span class="lineno">12766</span>&#160;{</div><div class="line"><a name="l12767"></a><span class="lineno">12767</span>&#160;   <span class="keywordtype">char</span> *s, *user = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *context = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mailbox[<a class="code" href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l12768"></a><span class="lineno">12768</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> vmus = {{0}};</div><div class="line"><a name="l12769"></a><span class="lineno">12769</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d4/d45/test__http__media__cache_8c.html#a80c8e3ae5087d90d422675d034eeebc7">options</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12770"></a><span class="lineno">12770</span>&#160;   <span class="keywordtype">int</span> silent = 0, skipuser = 0;</div><div class="line"><a name="l12771"></a><span class="lineno">12771</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l12772"></a><span class="lineno">12772</span>&#160;</div><div class="line"><a name="l12773"></a><span class="lineno">12773</span>&#160;   <span class="keywordflow">if</span> (data) {</div><div class="line"><a name="l12774"></a><span class="lineno">12774</span>&#160;      s = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(data);</div><div class="line"><a name="l12775"></a><span class="lineno">12775</span>&#160;      user = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l12776"></a><span class="lineno">12776</span>&#160;      options = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l12777"></a><span class="lineno">12777</span>&#160;      <span class="keywordflow">if</span> (user) {</div><div class="line"><a name="l12778"></a><span class="lineno">12778</span>&#160;         s = <a class="code" href="../../dc/d12/res__config__ldap_8c.html#a930c15eddfe0826ff30e658c9d50b9b4">user</a>;</div><div class="line"><a name="l12779"></a><span class="lineno">12779</span>&#160;         user = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;@&quot;</span>);</div><div class="line"><a name="l12780"></a><span class="lineno">12780</span>&#160;         context = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l12781"></a><span class="lineno">12781</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(user))</div><div class="line"><a name="l12782"></a><span class="lineno">12782</span>&#160;            skipuser++;</div><div class="line"><a name="l12783"></a><span class="lineno">12783</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(mailbox, user, <span class="keyword">sizeof</span>(mailbox));</div><div class="line"><a name="l12784"></a><span class="lineno">12784</span>&#160;      }</div><div class="line"><a name="l12785"></a><span class="lineno">12785</span>&#160;   }</div><div class="line"><a name="l12786"></a><span class="lineno">12786</span>&#160;</div><div class="line"><a name="l12787"></a><span class="lineno">12787</span>&#160;   <span class="keywordflow">if</span> (options) {</div><div class="line"><a name="l12788"></a><span class="lineno">12788</span>&#160;      silent = (strchr(options, <span class="charliteral">&#39;s&#39;</span>)) != <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12789"></a><span class="lineno">12789</span>&#160;   }</div><div class="line"><a name="l12790"></a><span class="lineno">12790</span>&#160;</div><div class="line"><a name="l12791"></a><span class="lineno">12791</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a>(chan, mailbox, <span class="keyword">sizeof</span>(mailbox), &amp;vmus, context, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, skipuser, 3, silent)) {</div><div class="line"><a name="l12792"></a><span class="lineno">12792</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AUTH_MAILBOX&quot;</span>, mailbox);</div><div class="line"><a name="l12793"></a><span class="lineno">12793</span>&#160;      <a class="code" href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AUTH_CONTEXT&quot;</span>, vmus.<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l12794"></a><span class="lineno">12794</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;auth-thankyou&quot;</span>);</div><div class="line"><a name="l12795"></a><span class="lineno">12795</span>&#160;      res = 0;</div><div class="line"><a name="l12796"></a><span class="lineno">12796</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mailbox[0] == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l12797"></a><span class="lineno">12797</span>&#160;      <span class="comment">/* user entered &#39;*&#39; */</span></div><div class="line"><a name="l12798"></a><span class="lineno">12798</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../db/de0/pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan), <span class="stringliteral">&quot;a&quot;</span>, 1)) {</div><div class="line"><a name="l12799"></a><span class="lineno">12799</span>&#160;         res = 0; <span class="comment">/* prevent hangup */</span></div><div class="line"><a name="l12800"></a><span class="lineno">12800</span>&#160;      }</div><div class="line"><a name="l12801"></a><span class="lineno">12801</span>&#160;   }</div><div class="line"><a name="l12802"></a><span class="lineno">12802</span>&#160;</div><div class="line"><a name="l12803"></a><span class="lineno">12803</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l12804"></a><span class="lineno">12804</span>&#160;}</div><div class="line"><a name="l12805"></a><span class="lineno">12805</span>&#160;</div><div class="line"><a name="l12806"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">12806</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">show_users_realtime</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *context)</div><div class="line"><a name="l12807"></a><span class="lineno">12807</span>&#160;{</div><div class="line"><a name="l12808"></a><span class="lineno">12808</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg;</div><div class="line"><a name="l12809"></a><span class="lineno">12809</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *cat = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12810"></a><span class="lineno">12810</span>&#160;</div><div class="line"><a name="l12811"></a><span class="lineno">12811</span>&#160;   <span class="keywordflow">if</span> (!(cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a29ff8cd717c0c0bac60abbd827fec409">ast_load_realtime_multientry</a>(<span class="stringliteral">&quot;voicemail&quot;</span>,</div><div class="line"><a name="l12812"></a><span class="lineno">12812</span>&#160;      <span class="stringliteral">&quot;context&quot;</span>, context, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>))) {</div><div class="line"><a name="l12813"></a><span class="lineno">12813</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;</div><div class="line"><a name="l12814"></a><span class="lineno">12814</span>&#160;   }</div><div class="line"><a name="l12815"></a><span class="lineno">12815</span>&#160;</div><div class="line"><a name="l12816"></a><span class="lineno">12816</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,</div><div class="line"><a name="l12817"></a><span class="lineno">12817</span>&#160;      <span class="stringliteral">&quot;\n&quot;</span></div><div class="line"><a name="l12818"></a><span class="lineno">12818</span>&#160;      <span class="stringliteral">&quot;=============================================================\n&quot;</span></div><div class="line"><a name="l12819"></a><span class="lineno">12819</span>&#160;      <span class="stringliteral">&quot;=== Configured Voicemail Users ==============================\n&quot;</span></div><div class="line"><a name="l12820"></a><span class="lineno">12820</span>&#160;      <span class="stringliteral">&quot;=============================================================\n&quot;</span></div><div class="line"><a name="l12821"></a><span class="lineno">12821</span>&#160;      <span class="stringliteral">&quot;===\n&quot;</span>);</div><div class="line"><a name="l12822"></a><span class="lineno">12822</span>&#160;</div><div class="line"><a name="l12823"></a><span class="lineno">12823</span>&#160;   <span class="keywordflow">while</span> ((cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(cfg, cat))) {</div><div class="line"><a name="l12824"></a><span class="lineno">12824</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12825"></a><span class="lineno">12825</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,</div><div class="line"><a name="l12826"></a><span class="lineno">12826</span>&#160;         <span class="stringliteral">&quot;=== Mailbox ...\n&quot;</span></div><div class="line"><a name="l12827"></a><span class="lineno">12827</span>&#160;         <span class="stringliteral">&quot;===\n&quot;</span>);</div><div class="line"><a name="l12828"></a><span class="lineno">12828</span>&#160;      <span class="keywordflow">for</span> (var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#aef636ed2f3d33f4c7a1ba67eb7c4d052">ast_variable_browse</a>(cfg, cat); <a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>; var = var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">next</a>)</div><div class="line"><a name="l12829"></a><span class="lineno">12829</span>&#160;         <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;=== ==&gt; %s: %s\n&quot;</span>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);</div><div class="line"><a name="l12830"></a><span class="lineno">12830</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,</div><div class="line"><a name="l12831"></a><span class="lineno">12831</span>&#160;         <span class="stringliteral">&quot;===\n&quot;</span></div><div class="line"><a name="l12832"></a><span class="lineno">12832</span>&#160;         <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span></div><div class="line"><a name="l12833"></a><span class="lineno">12833</span>&#160;         <span class="stringliteral">&quot;===\n&quot;</span>);</div><div class="line"><a name="l12834"></a><span class="lineno">12834</span>&#160;   }</div><div class="line"><a name="l12835"></a><span class="lineno">12835</span>&#160;</div><div class="line"><a name="l12836"></a><span class="lineno">12836</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,</div><div class="line"><a name="l12837"></a><span class="lineno">12837</span>&#160;      <span class="stringliteral">&quot;=============================================================\n&quot;</span></div><div class="line"><a name="l12838"></a><span class="lineno">12838</span>&#160;      <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"><a name="l12839"></a><span class="lineno">12839</span>&#160;</div><div class="line"><a name="l12840"></a><span class="lineno">12840</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l12841"></a><span class="lineno">12841</span>&#160;</div><div class="line"><a name="l12842"></a><span class="lineno">12842</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;</div><div class="line"><a name="l12843"></a><span class="lineno">12843</span>&#160;}</div><div class="line"><a name="l12844"></a><span class="lineno">12844</span>&#160;</div><div class="line"><a name="l12845"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">12845</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">complete_voicemail_show_users</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/codecs_2gsm_2inc_2private_8h.html#a0b023cbb2bf7d034c2269d58d7455ac8">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="../../d4/d88/structstate.html">state</a>)</div><div class="line"><a name="l12846"></a><span class="lineno">12846</span>&#160;{</div><div class="line"><a name="l12847"></a><span class="lineno">12847</span>&#160;   <span class="keywordtype">int</span> which = 0;</div><div class="line"><a name="l12848"></a><span class="lineno">12848</span>&#160;   <span class="keywordtype">int</span> wordlen;</div><div class="line"><a name="l12849"></a><span class="lineno">12849</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l12850"></a><span class="lineno">12850</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l12851"></a><span class="lineno">12851</span>&#160;</div><div class="line"><a name="l12852"></a><span class="lineno">12852</span>&#160;   <span class="comment">/* 0 - voicemail; 1 - show; 2 - users; 3 - for; 4 - &lt;context&gt; */</span></div><div class="line"><a name="l12853"></a><span class="lineno">12853</span>&#160;   <span class="keywordflow">if</span> (pos &gt; 4)</div><div class="line"><a name="l12854"></a><span class="lineno">12854</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12855"></a><span class="lineno">12855</span>&#160;   wordlen = strlen(word);</div><div class="line"><a name="l12856"></a><span class="lineno">12856</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l12857"></a><span class="lineno">12857</span>&#160;      <span class="keywordflow">if</span> (!strncasecmp(word, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, wordlen)) {</div><div class="line"><a name="l12858"></a><span class="lineno">12858</span>&#160;         <span class="keywordflow">if</span> (context &amp;&amp; strcmp(context, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>) &amp;&amp; ++which &gt; state)</div><div class="line"><a name="l12859"></a><span class="lineno">12859</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l12860"></a><span class="lineno">12860</span>&#160;         <span class="comment">/* ignore repeated contexts ? */</span></div><div class="line"><a name="l12861"></a><span class="lineno">12861</span>&#160;         context = vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>;</div><div class="line"><a name="l12862"></a><span class="lineno">12862</span>&#160;      }</div><div class="line"><a name="l12863"></a><span class="lineno">12863</span>&#160;   }</div><div class="line"><a name="l12864"></a><span class="lineno">12864</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12865"></a><span class="lineno">12865</span>&#160;}</div><div class="line"><a name="l12866"></a><span class="lineno">12866</span>&#160;<span class="comment"></span></div><div class="line"><a name="l12867"></a><span class="lineno">12867</span>&#160;<span class="comment">/*! \brief Show a list of voicemail users in the CLI */</span></div><div class="line"><a name="l12868"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a">12868</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a">handle_voicemail_show_users</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d07/structast__cli__entry.html">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="../../d3/dad/structast__cli__args.html">ast_cli_args</a> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a13dd15487fee89a002d17ef3aff62d02">a</a>)</div><div class="line"><a name="l12869"></a><span class="lineno">12869</span>&#160;{</div><div class="line"><a name="l12870"></a><span class="lineno">12870</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l12871"></a><span class="lineno">12871</span>&#160;<span class="preprocessor">#define HVSU_OUTPUT_FORMAT &quot;%-10s %-5s %-25s %-10s %6s\n&quot;</span></div><div class="line"><a name="l12872"></a><span class="lineno">12872</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12873"></a><span class="lineno">12873</span>&#160;   <span class="keywordtype">int</span> users_counter = 0;</div><div class="line"><a name="l12874"></a><span class="lineno">12874</span>&#160;</div><div class="line"><a name="l12875"></a><span class="lineno">12875</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l12876"></a><span class="lineno">12876</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:</div><div class="line"><a name="l12877"></a><span class="lineno">12877</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail show users [for]&quot;</span>;</div><div class="line"><a name="l12878"></a><span class="lineno">12878</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =</div><div class="line"><a name="l12879"></a><span class="lineno">12879</span>&#160;         <span class="stringliteral">&quot;Usage: voicemail show users [for &lt;context&gt;]\n&quot;</span></div><div class="line"><a name="l12880"></a><span class="lineno">12880</span>&#160;         <span class="stringliteral">&quot;       Lists all mailboxes currently set up\n&quot;</span>;</div><div class="line"><a name="l12881"></a><span class="lineno">12881</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12882"></a><span class="lineno">12882</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:</div><div class="line"><a name="l12883"></a><span class="lineno">12883</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">complete_voicemail_show_users</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a4b911d12699acbbb5a8b62355b35bae8">pos</a>, a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acfc02ec89670db29251fda6a66602ce2">n</a>);</div><div class="line"><a name="l12884"></a><span class="lineno">12884</span>&#160;   }</div><div class="line"><a name="l12885"></a><span class="lineno">12885</span>&#160;</div><div class="line"><a name="l12886"></a><span class="lineno">12886</span>&#160;   <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> &lt; 3) || (a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> &gt; 5) || (a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> == 4))</div><div class="line"><a name="l12887"></a><span class="lineno">12887</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;</div><div class="line"><a name="l12888"></a><span class="lineno">12888</span>&#160;   <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> == 5) {</div><div class="line"><a name="l12889"></a><span class="lineno">12889</span>&#160;      <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#ad0a19c4d63698f9e9cfd5653e8851452">argv</a>[3],<span class="stringliteral">&quot;for&quot;</span>))</div><div class="line"><a name="l12890"></a><span class="lineno">12890</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;</div><div class="line"><a name="l12891"></a><span class="lineno">12891</span>&#160;      context = a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#ad0a19c4d63698f9e9cfd5653e8851452">argv</a>[4];</div><div class="line"><a name="l12892"></a><span class="lineno">12892</span>&#160;   }</div><div class="line"><a name="l12893"></a><span class="lineno">12893</span>&#160;</div><div class="line"><a name="l12894"></a><span class="lineno">12894</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>)) {</div><div class="line"><a name="l12895"></a><span class="lineno">12895</span>&#160;      <span class="keywordflow">if</span> (!context) {</div><div class="line"><a name="l12896"></a><span class="lineno">12896</span>&#160;         <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;You must specify a specific context to show users from realtime!\n&quot;</span>);</div><div class="line"><a name="l12897"></a><span class="lineno">12897</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;</div><div class="line"><a name="l12898"></a><span class="lineno">12898</span>&#160;      }</div><div class="line"><a name="l12899"></a><span class="lineno">12899</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">show_users_realtime</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, context);</div><div class="line"><a name="l12900"></a><span class="lineno">12900</span>&#160;   }</div><div class="line"><a name="l12901"></a><span class="lineno">12901</span>&#160;</div><div class="line"><a name="l12902"></a><span class="lineno">12902</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l12903"></a><span class="lineno">12903</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/d90/linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05">AST_LIST_EMPTY</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>)) {</div><div class="line"><a name="l12904"></a><span class="lineno">12904</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;There are no voicemail users currently defined\n&quot;</span>);</div><div class="line"><a name="l12905"></a><span class="lineno">12905</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l12906"></a><span class="lineno">12906</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;</div><div class="line"><a name="l12907"></a><span class="lineno">12907</span>&#160;   }</div><div class="line"><a name="l12908"></a><span class="lineno">12908</span>&#160;   <span class="keywordflow">if</span> (!context) {</div><div class="line"><a name="l12909"></a><span class="lineno">12909</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Context&quot;</span>, <span class="stringliteral">&quot;Mbox&quot;</span>, <span class="stringliteral">&quot;User&quot;</span>, <span class="stringliteral">&quot;Zone&quot;</span>, <span class="stringliteral">&quot;NewMsg&quot;</span>);</div><div class="line"><a name="l12910"></a><span class="lineno">12910</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12911"></a><span class="lineno">12911</span>&#160;      <span class="keywordtype">int</span> count = 0;</div><div class="line"><a name="l12912"></a><span class="lineno">12912</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l12913"></a><span class="lineno">12913</span>&#160;         <span class="keywordflow">if</span> (!strcmp(context, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>)) {</div><div class="line"><a name="l12914"></a><span class="lineno">12914</span>&#160;            count++;</div><div class="line"><a name="l12915"></a><span class="lineno">12915</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l12916"></a><span class="lineno">12916</span>&#160;         }</div><div class="line"><a name="l12917"></a><span class="lineno">12917</span>&#160;      }</div><div class="line"><a name="l12918"></a><span class="lineno">12918</span>&#160;      <span class="keywordflow">if</span> (count) {</div><div class="line"><a name="l12919"></a><span class="lineno">12919</span>&#160;         <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Context&quot;</span>, <span class="stringliteral">&quot;Mbox&quot;</span>, <span class="stringliteral">&quot;User&quot;</span>, <span class="stringliteral">&quot;Zone&quot;</span>, <span class="stringliteral">&quot;NewMsg&quot;</span>);</div><div class="line"><a name="l12920"></a><span class="lineno">12920</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12921"></a><span class="lineno">12921</span>&#160;         <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;No such voicemail context \&quot;%s\&quot;\n&quot;</span>, context);</div><div class="line"><a name="l12922"></a><span class="lineno">12922</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l12923"></a><span class="lineno">12923</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;</div><div class="line"><a name="l12924"></a><span class="lineno">12924</span>&#160;      }</div><div class="line"><a name="l12925"></a><span class="lineno">12925</span>&#160;   }</div><div class="line"><a name="l12926"></a><span class="lineno">12926</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l12927"></a><span class="lineno">12927</span>&#160;      <span class="keywordtype">int</span> newmsgs = 0, oldmsgs = 0;</div><div class="line"><a name="l12928"></a><span class="lineno">12928</span>&#160;      <span class="keywordtype">char</span> count[12], tmp[256] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l12929"></a><span class="lineno">12929</span>&#160;</div><div class="line"><a name="l12930"></a><span class="lineno">12930</span>&#160;      <span class="keywordflow">if</span> (!context || !strcmp(context, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>)) {</div><div class="line"><a name="l12931"></a><span class="lineno">12931</span>&#160;         snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>) ? <span class="stringliteral">&quot;default&quot;</span> : vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l12932"></a><span class="lineno">12932</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(tmp, &amp;newmsgs, &amp;oldmsgs);</div><div class="line"><a name="l12933"></a><span class="lineno">12933</span>&#160;         snprintf(count, <span class="keyword">sizeof</span>(count), <span class="stringliteral">&quot;%d&quot;</span>, newmsgs);</div><div class="line"><a name="l12934"></a><span class="lineno">12934</span>&#160;         <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, count);</div><div class="line"><a name="l12935"></a><span class="lineno">12935</span>&#160;         users_counter++;</div><div class="line"><a name="l12936"></a><span class="lineno">12936</span>&#160;      }</div><div class="line"><a name="l12937"></a><span class="lineno">12937</span>&#160;   }</div><div class="line"><a name="l12938"></a><span class="lineno">12938</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l12939"></a><span class="lineno">12939</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;%d voicemail users configured.\n&quot;</span>, users_counter);</div><div class="line"><a name="l12940"></a><span class="lineno">12940</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;</div><div class="line"><a name="l12941"></a><span class="lineno">12941</span>&#160;}</div><div class="line"><a name="l12942"></a><span class="lineno">12942</span>&#160;<span class="comment"></span></div><div class="line"><a name="l12943"></a><span class="lineno">12943</span>&#160;<span class="comment">/*! \brief Show a list of voicemail zones in the CLI */</span></div><div class="line"><a name="l12944"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6">12944</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6">handle_voicemail_show_zones</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d07/structast__cli__entry.html">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="../../d3/dad/structast__cli__args.html">ast_cli_args</a> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a13dd15487fee89a002d17ef3aff62d02">a</a>)</div><div class="line"><a name="l12945"></a><span class="lineno">12945</span>&#160;{</div><div class="line"><a name="l12946"></a><span class="lineno">12946</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *zone;</div><div class="line"><a name="l12947"></a><span class="lineno">12947</span>&#160;<span class="preprocessor">#define HVSZ_OUTPUT_FORMAT &quot;%-15s %-20s %-45s\n&quot;</span></div><div class="line"><a name="l12948"></a><span class="lineno">12948</span>&#160;   <span class="keywordtype">char</span> *res = <a class="code" href="../../dc/db0/cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;</div><div class="line"><a name="l12949"></a><span class="lineno">12949</span>&#160;</div><div class="line"><a name="l12950"></a><span class="lineno">12950</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l12951"></a><span class="lineno">12951</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:</div><div class="line"><a name="l12952"></a><span class="lineno">12952</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail show zones&quot;</span>;</div><div class="line"><a name="l12953"></a><span class="lineno">12953</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =</div><div class="line"><a name="l12954"></a><span class="lineno">12954</span>&#160;         <span class="stringliteral">&quot;Usage: voicemail show zones\n&quot;</span></div><div class="line"><a name="l12955"></a><span class="lineno">12955</span>&#160;         <span class="stringliteral">&quot;       Lists zone message formats\n&quot;</span>;</div><div class="line"><a name="l12956"></a><span class="lineno">12956</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12957"></a><span class="lineno">12957</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:</div><div class="line"><a name="l12958"></a><span class="lineno">12958</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12959"></a><span class="lineno">12959</span>&#160;   }</div><div class="line"><a name="l12960"></a><span class="lineno">12960</span>&#160;</div><div class="line"><a name="l12961"></a><span class="lineno">12961</span>&#160;   <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> != 3)</div><div class="line"><a name="l12962"></a><span class="lineno">12962</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;</div><div class="line"><a name="l12963"></a><span class="lineno">12963</span>&#160;</div><div class="line"><a name="l12964"></a><span class="lineno">12964</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l12965"></a><span class="lineno">12965</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../df/d90/linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05">AST_LIST_EMPTY</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>)) {</div><div class="line"><a name="l12966"></a><span class="lineno">12966</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9b7212bac1c90a7a89c6e8c87792c3db">HVSZ_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Zone&quot;</span>, <span class="stringliteral">&quot;Timezone&quot;</span>, <span class="stringliteral">&quot;Message Format&quot;</span>);</div><div class="line"><a name="l12967"></a><span class="lineno">12967</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>, zone, <a class="code" href="../../d7/d13/structvm__zone.html#a824b6fba3cdf05b72afb1e22ef25a38c">list</a>) {</div><div class="line"><a name="l12968"></a><span class="lineno">12968</span>&#160;         <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9b7212bac1c90a7a89c6e8c87792c3db">HVSZ_OUTPUT_FORMAT</a>, zone-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">name</a>, zone-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>, zone-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">msg_format</a>);</div><div class="line"><a name="l12969"></a><span class="lineno">12969</span>&#160;      }</div><div class="line"><a name="l12970"></a><span class="lineno">12970</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l12971"></a><span class="lineno">12971</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;There are no voicemail zones currently defined\n&quot;</span>);</div><div class="line"><a name="l12972"></a><span class="lineno">12972</span>&#160;      res = <a class="code" href="../../dc/db0/cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;</div><div class="line"><a name="l12973"></a><span class="lineno">12973</span>&#160;   }</div><div class="line"><a name="l12974"></a><span class="lineno">12974</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l12975"></a><span class="lineno">12975</span>&#160;</div><div class="line"><a name="l12976"></a><span class="lineno">12976</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l12977"></a><span class="lineno">12977</span>&#160;}</div><div class="line"><a name="l12978"></a><span class="lineno">12978</span>&#160;<span class="comment"></span></div><div class="line"><a name="l12979"></a><span class="lineno">12979</span>&#160;<span class="comment">/*! \brief Show a list of voicemail zones in the CLI */</span></div><div class="line"><a name="l12980"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abd7ac3d7cb5ea27916252d4b9f045834">12980</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#abd7ac3d7cb5ea27916252d4b9f045834">handle_voicemail_show_aliases</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d07/structast__cli__entry.html">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="../../d3/dad/structast__cli__args.html">ast_cli_args</a> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a13dd15487fee89a002d17ef3aff62d02">a</a>)</div><div class="line"><a name="l12981"></a><span class="lineno">12981</span>&#160;{</div><div class="line"><a name="l12982"></a><span class="lineno">12982</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d9/d97/structao2__iterator.html">ao2_iterator</a> aliases;</div><div class="line"><a name="l12983"></a><span class="lineno">12983</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *mapping;</div><div class="line"><a name="l12984"></a><span class="lineno">12984</span>&#160;<span class="preprocessor">#define ALIASES_OUTPUT_FORMAT &quot;%-32s %-32s\n&quot;</span></div><div class="line"><a name="l12985"></a><span class="lineno">12985</span>&#160;   <span class="keywordtype">char</span> *res = <a class="code" href="../../dc/db0/cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;</div><div class="line"><a name="l12986"></a><span class="lineno">12986</span>&#160;</div><div class="line"><a name="l12987"></a><span class="lineno">12987</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l12988"></a><span class="lineno">12988</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:</div><div class="line"><a name="l12989"></a><span class="lineno">12989</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail show aliases&quot;</span>;</div><div class="line"><a name="l12990"></a><span class="lineno">12990</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =</div><div class="line"><a name="l12991"></a><span class="lineno">12991</span>&#160;         <span class="stringliteral">&quot;Usage: voicemail show aliases\n&quot;</span></div><div class="line"><a name="l12992"></a><span class="lineno">12992</span>&#160;         <span class="stringliteral">&quot;       Lists mailbox aliases\n&quot;</span>;</div><div class="line"><a name="l12993"></a><span class="lineno">12993</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12994"></a><span class="lineno">12994</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:</div><div class="line"><a name="l12995"></a><span class="lineno">12995</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l12996"></a><span class="lineno">12996</span>&#160;   }</div><div class="line"><a name="l12997"></a><span class="lineno">12997</span>&#160;</div><div class="line"><a name="l12998"></a><span class="lineno">12998</span>&#160;   <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> != 3)</div><div class="line"><a name="l12999"></a><span class="lineno">12999</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;</div><div class="line"><a name="l13000"></a><span class="lineno">13000</span>&#160;</div><div class="line"><a name="l13001"></a><span class="lineno">13001</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(aliasescontext)) {</div><div class="line"><a name="l13002"></a><span class="lineno">13002</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;Aliases are not enabled\n&quot;</span>);</div><div class="line"><a name="l13003"></a><span class="lineno">13003</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l13004"></a><span class="lineno">13004</span>&#160;   }</div><div class="line"><a name="l13005"></a><span class="lineno">13005</span>&#160;</div><div class="line"><a name="l13006"></a><span class="lineno">13006</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;Aliases context: %s\n&quot;</span>, aliasescontext);</div><div class="line"><a name="l13007"></a><span class="lineno">13007</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af86b40ad4c23d3535cc73c85d6830bf0">ALIASES_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Alias&quot;</span>, <span class="stringliteral">&quot;Mailbox&quot;</span>);</div><div class="line"><a name="l13008"></a><span class="lineno">13008</span>&#160;</div><div class="line"><a name="l13009"></a><span class="lineno">13009</span>&#160;   aliases = <a class="code" href="../../d5/da5/astobj2_8h.html#a91d5d37d00874ae7a92d1a15c0a3b3a6">ao2_iterator_init</a>(alias_mailbox_mappings, 0);</div><div class="line"><a name="l13010"></a><span class="lineno">13010</span>&#160;   <span class="keywordflow">while</span> ((mapping = <a class="code" href="../../d5/da5/astobj2_8h.html#a17990ea630db7dbd1252ef0132133a2b">ao2_iterator_next</a>(&amp;aliases))) {</div><div class="line"><a name="l13011"></a><span class="lineno">13011</span>&#160;      <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af86b40ad4c23d3535cc73c85d6830bf0">ALIASES_OUTPUT_FORMAT</a>, mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias</a>, mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>);</div><div class="line"><a name="l13012"></a><span class="lineno">13012</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mapping, -1);</div><div class="line"><a name="l13013"></a><span class="lineno">13013</span>&#160;   }</div><div class="line"><a name="l13014"></a><span class="lineno">13014</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#ad36841ab6daa3997f7ca7047ad2d033a">ao2_iterator_destroy</a>(&amp;aliases);</div><div class="line"><a name="l13015"></a><span class="lineno">13015</span>&#160;</div><div class="line"><a name="l13016"></a><span class="lineno">13016</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l13017"></a><span class="lineno">13017</span>&#160;}</div><div class="line"><a name="l13018"></a><span class="lineno">13018</span>&#160;<span class="comment"></span></div><div class="line"><a name="l13019"></a><span class="lineno">13019</span>&#160;<span class="comment">/*! \brief Reload voicemail configuration from the CLI */</span></div><div class="line"><a name="l13020"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba">13020</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba">handle_voicemail_reload</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d07/structast__cli__entry.html">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="../../d3/dad/structast__cli__args.html">ast_cli_args</a> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a13dd15487fee89a002d17ef3aff62d02">a</a>)</div><div class="line"><a name="l13021"></a><span class="lineno">13021</span>&#160;{</div><div class="line"><a name="l13022"></a><span class="lineno">13022</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l13023"></a><span class="lineno">13023</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:</div><div class="line"><a name="l13024"></a><span class="lineno">13024</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail reload&quot;</span>;</div><div class="line"><a name="l13025"></a><span class="lineno">13025</span>&#160;      e-&gt;<a class="code" href="../../d8/d07/structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =</div><div class="line"><a name="l13026"></a><span class="lineno">13026</span>&#160;         <span class="stringliteral">&quot;Usage: voicemail reload\n&quot;</span></div><div class="line"><a name="l13027"></a><span class="lineno">13027</span>&#160;         <span class="stringliteral">&quot;       Reload voicemail configuration\n&quot;</span>;</div><div class="line"><a name="l13028"></a><span class="lineno">13028</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13029"></a><span class="lineno">13029</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:</div><div class="line"><a name="l13030"></a><span class="lineno">13030</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13031"></a><span class="lineno">13031</span>&#160;   }</div><div class="line"><a name="l13032"></a><span class="lineno">13032</span>&#160;</div><div class="line"><a name="l13033"></a><span class="lineno">13033</span>&#160;   <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">argc</a> != 2)</div><div class="line"><a name="l13034"></a><span class="lineno">13034</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;</div><div class="line"><a name="l13035"></a><span class="lineno">13035</span>&#160;</div><div class="line"><a name="l13036"></a><span class="lineno">13036</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">fd</a>, <span class="stringliteral">&quot;Reloading voicemail configuration...\n&quot;</span>);</div><div class="line"><a name="l13037"></a><span class="lineno">13037</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(1);</div><div class="line"><a name="l13038"></a><span class="lineno">13038</span>&#160;</div><div class="line"><a name="l13039"></a><span class="lineno">13039</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;</div><div class="line"><a name="l13040"></a><span class="lineno">13040</span>&#160;}</div><div class="line"><a name="l13041"></a><span class="lineno">13041</span>&#160;</div><div class="line"><a name="l13042"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">13042</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d8/d07/structast__cli__entry.html">ast_cli_entry</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a>[] = {</div><div class="line"><a name="l13043"></a><span class="lineno">13043</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a">handle_voicemail_show_users</a>, <span class="stringliteral">&quot;List defined voicemail boxes&quot;</span>),</div><div class="line"><a name="l13044"></a><span class="lineno">13044</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6">handle_voicemail_show_zones</a>, <span class="stringliteral">&quot;List zone message formats&quot;</span>),</div><div class="line"><a name="l13045"></a><span class="lineno">13045</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#abd7ac3d7cb5ea27916252d4b9f045834">handle_voicemail_show_aliases</a>, <span class="stringliteral">&quot;List mailbox aliases&quot;</span>),</div><div class="line"><a name="l13046"></a><span class="lineno">13046</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba">handle_voicemail_reload</a>, <span class="stringliteral">&quot;Reload voicemail configuration&quot;</span>),</div><div class="line"><a name="l13047"></a><span class="lineno">13047</span>&#160;};</div><div class="line"><a name="l13048"></a><span class="lineno">13048</span>&#160;</div><div class="line"><a name="l13049"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac963b5fb03d8e52621fde667f8a76e43">13049</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac963b5fb03d8e52621fde667f8a76e43">poll_subscribed_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d45/structast__mwi__state.html">ast_mwi_state</a> *mwi_state, <span class="keywordtype">void</span> *data)</div><div class="line"><a name="l13050"></a><span class="lineno">13050</span>&#160;{</div><div class="line"><a name="l13051"></a><span class="lineno">13051</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;</div><div class="line"><a name="l13052"></a><span class="lineno">13052</span>&#160;</div><div class="line"><a name="l13053"></a><span class="lineno">13053</span>&#160;   <span class="keywordflow">if</span> (!mwi_state) {</div><div class="line"><a name="l13054"></a><span class="lineno">13054</span>&#160;      <span class="comment">/* This should only occur due to allocation failure of a default mwi state object */</span></div><div class="line"><a name="l13055"></a><span class="lineno">13055</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13056"></a><span class="lineno">13056</span>&#160;   }</div><div class="line"><a name="l13057"></a><span class="lineno">13057</span>&#160;</div><div class="line"><a name="l13058"></a><span class="lineno">13058</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);</div><div class="line"><a name="l13059"></a><span class="lineno">13059</span>&#160;</div><div class="line"><a name="l13060"></a><span class="lineno">13060</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13061"></a><span class="lineno">13061</span>&#160;   <span class="keywordflow">if</span> (imap_poll_logout) {</div><div class="line"><a name="l13062"></a><span class="lineno">13062</span>&#160;      imap_logout(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>);</div><div class="line"><a name="l13063"></a><span class="lineno">13063</span>&#160;   }</div><div class="line"><a name="l13064"></a><span class="lineno">13064</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13065"></a><span class="lineno">13065</span>&#160;</div><div class="line"><a name="l13066"></a><span class="lineno">13066</span>&#160;   <span class="keywordflow">if</span> (urgent != mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga0c3f093f91cee667b6ab2d5dfa4f760e">urgent_msgs</a> || <span class="keyword">new</span> != mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga70de9f16a229e2c5bf1a973372949d3e">new_msgs</a> || old != mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga4369ae7c984aba22ce6d0e92718f2b29">old_msgs</a>) {</div><div class="line"><a name="l13067"></a><span class="lineno">13067</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, urgent, <span class="keyword">new</span>, old);</div><div class="line"><a name="l13068"></a><span class="lineno">13068</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13069"></a><span class="lineno">13069</span>&#160;   }</div><div class="line"><a name="l13070"></a><span class="lineno">13070</span>&#160;</div><div class="line"><a name="l13071"></a><span class="lineno">13071</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13072"></a><span class="lineno">13072</span>&#160;}</div><div class="line"><a name="l13073"></a><span class="lineno">13073</span>&#160;</div><div class="line"><a name="l13074"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">13074</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">mb_poll_thread</a>(<span class="keywordtype">void</span> *data)</div><div class="line"><a name="l13075"></a><span class="lineno">13075</span>&#160;{</div><div class="line"><a name="l13076"></a><span class="lineno">13076</span>&#160;   <span class="keywordflow">while</span> (poll_thread_run) {</div><div class="line"><a name="l13077"></a><span class="lineno">13077</span>&#160;      <span class="keyword">struct </span>timespec ts = { 0, };</div><div class="line"><a name="l13078"></a><span class="lineno">13078</span>&#160;      <span class="keyword">struct </span>timeval wait;</div><div class="line"><a name="l13079"></a><span class="lineno">13079</span>&#160;</div><div class="line"><a name="l13080"></a><span class="lineno">13080</span>&#160;      <a class="code" href="../../dc/d33/mwi_8h.html#aa878bb71532040c72e88ffa2f107d7b4">ast_mwi_state_callback_subscribed</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#ac963b5fb03d8e52621fde667f8a76e43">poll_subscribed_mailbox</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13081"></a><span class="lineno">13081</span>&#160;</div><div class="line"><a name="l13082"></a><span class="lineno">13082</span>&#160;      <span class="keywordflow">if</span> (!poll_thread_run) {</div><div class="line"><a name="l13083"></a><span class="lineno">13083</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l13084"></a><span class="lineno">13084</span>&#160;      }</div><div class="line"><a name="l13085"></a><span class="lineno">13085</span>&#160;</div><div class="line"><a name="l13086"></a><span class="lineno">13086</span>&#160;      wait = <a class="code" href="../../de/df7/time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073">ast_tvadd</a>(<a class="code" href="../../de/df7/time_8h.html#ad3899efb6f0e348556ef69f5b16aa7f7">ast_tvnow</a>(), <a class="code" href="../../de/df7/time_8h.html#a1d774df72e3dbb623475783e06ce4f61">ast_samp2tv</a>(poll_freq, 1));</div><div class="line"><a name="l13087"></a><span class="lineno">13087</span>&#160;      ts.tv_sec = wait.tv_sec;</div><div class="line"><a name="l13088"></a><span class="lineno">13088</span>&#160;      ts.tv_nsec = wait.tv_usec * 1000;</div><div class="line"><a name="l13089"></a><span class="lineno">13089</span>&#160;</div><div class="line"><a name="l13090"></a><span class="lineno">13090</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a>);</div><div class="line"><a name="l13091"></a><span class="lineno">13091</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a6add1f30b2d53ca9384b15529a6f126e">ast_cond_timedwait</a>(&amp;poll_cond, &amp;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a>, &amp;ts);</div><div class="line"><a name="l13092"></a><span class="lineno">13092</span>&#160;      <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a>);</div><div class="line"><a name="l13093"></a><span class="lineno">13093</span>&#160;   }</div><div class="line"><a name="l13094"></a><span class="lineno">13094</span>&#160;</div><div class="line"><a name="l13095"></a><span class="lineno">13095</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13096"></a><span class="lineno">13096</span>&#160;}</div><div class="line"><a name="l13097"></a><span class="lineno">13097</span>&#160;</div><div class="line"><a name="l13098"></a><span class="lineno">13098</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13099"></a><span class="lineno">13099</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> imap_logout(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id)</div><div class="line"><a name="l13100"></a><span class="lineno">13100</span>&#160;{</div><div class="line"><a name="l13101"></a><span class="lineno">13101</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l13102"></a><span class="lineno">13102</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l13103"></a><span class="lineno">13103</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> vmus;</div><div class="line"><a name="l13104"></a><span class="lineno">13104</span>&#160;   <a class="code" href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *, vmu, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>);</div><div class="line"><a name="l13105"></a><span class="lineno">13105</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13106"></a><span class="lineno">13106</span>&#160;</div><div class="line"><a name="l13107"></a><span class="lineno">13107</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_id)</div><div class="line"><a name="l13108"></a><span class="lineno">13108</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mailbox_id), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l13109"></a><span class="lineno">13109</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l13110"></a><span class="lineno">13110</span>&#160;   }</div><div class="line"><a name="l13111"></a><span class="lineno">13111</span>&#160;</div><div class="line"><a name="l13112"></a><span class="lineno">13112</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l13113"></a><span class="lineno">13113</span>&#160;</div><div class="line"><a name="l13114"></a><span class="lineno">13114</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox)) || vmu-&gt;imapuser[0] == <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l13115"></a><span class="lineno">13115</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l13116"></a><span class="lineno">13116</span>&#160;   }</div><div class="line"><a name="l13117"></a><span class="lineno">13117</span>&#160;</div><div class="line"><a name="l13118"></a><span class="lineno">13118</span>&#160;   vms = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0);</div><div class="line"><a name="l13119"></a><span class="lineno">13119</span>&#160;   <span class="keywordflow">if</span> (!vms) {</div><div class="line"><a name="l13120"></a><span class="lineno">13120</span>&#160;      vms = get_vm_state_by_mailbox(mailbox, context, 0);</div><div class="line"><a name="l13121"></a><span class="lineno">13121</span>&#160;   }</div><div class="line"><a name="l13122"></a><span class="lineno">13122</span>&#160;   <span class="keywordflow">if</span> (!vms) {</div><div class="line"><a name="l13123"></a><span class="lineno">13123</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l13124"></a><span class="lineno">13124</span>&#160;   }</div><div class="line"><a name="l13125"></a><span class="lineno">13125</span>&#160;</div><div class="line"><a name="l13126"></a><span class="lineno">13126</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l13127"></a><span class="lineno">13127</span>&#160;   vms-&gt;mailstream = mail_close(vms-&gt;mailstream);</div><div class="line"><a name="l13128"></a><span class="lineno">13128</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;vms-&gt;lock);</div><div class="line"><a name="l13129"></a><span class="lineno">13129</span>&#160;</div><div class="line"><a name="l13130"></a><span class="lineno">13130</span>&#160;   vmstate_delete(vms);</div><div class="line"><a name="l13131"></a><span class="lineno">13131</span>&#160;}</div><div class="line"><a name="l13132"></a><span class="lineno">13132</span>&#160;</div><div class="line"><a name="l13133"></a><span class="lineno">13133</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> imap_close_subscribed_mailbox(<span class="keyword">struct</span> <a class="code" href="../../d6/d45/structast__mwi__state.html">ast_mwi_state</a> *mwi_state, <span class="keywordtype">void</span> *data)</div><div class="line"><a name="l13134"></a><span class="lineno">13134</span>&#160;{</div><div class="line"><a name="l13135"></a><span class="lineno">13135</span>&#160;   <span class="keywordflow">if</span> (mwi_state &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>)) {</div><div class="line"><a name="l13136"></a><span class="lineno">13136</span>&#160;      imap_logout(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>);</div><div class="line"><a name="l13137"></a><span class="lineno">13137</span>&#160;   }</div><div class="line"><a name="l13138"></a><span class="lineno">13138</span>&#160;</div><div class="line"><a name="l13139"></a><span class="lineno">13139</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13140"></a><span class="lineno">13140</span>&#160;}</div><div class="line"><a name="l13141"></a><span class="lineno">13141</span>&#160;</div><div class="line"><a name="l13142"></a><span class="lineno">13142</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13143"></a><span class="lineno">13143</span>&#160;</div><div class="line"><a name="l13144"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a151aa2b14d2de12714ed26b49b535e62">13144</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a151aa2b14d2de12714ed26b49b535e62">mwi_handle_unsubscribe2</a>(<span class="keywordtype">void</span> *data)</div><div class="line"><a name="l13145"></a><span class="lineno">13145</span>&#160;{</div><div class="line"><a name="l13146"></a><span class="lineno">13146</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d6/d45/structast__mwi__state.html">ast_mwi_state</a> *mwi_state = data;</div><div class="line"><a name="l13147"></a><span class="lineno">13147</span>&#160;</div><div class="line"><a name="l13148"></a><span class="lineno">13148</span>&#160;   <span class="comment">/*</span></div><div class="line"><a name="l13149"></a><span class="lineno">13149</span>&#160;<span class="comment">    * Go ahead and clear the implicit MWI publisher here to avoid a leak. If a backing</span></div><div class="line"><a name="l13150"></a><span class="lineno">13150</span>&#160;<span class="comment">    * configuration is available it&#39;ll re-initialize (reset the cached state) on its</span></div><div class="line"><a name="l13151"></a><span class="lineno">13151</span>&#160;<span class="comment">    * next publish.</span></div><div class="line"><a name="l13152"></a><span class="lineno">13152</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l13153"></a><span class="lineno">13153</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#ab6397dc158885461fdc0a21138dda6f9">ast_delete_mwi_state_full</a>(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13154"></a><span class="lineno">13154</span>&#160;</div><div class="line"><a name="l13155"></a><span class="lineno">13155</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13156"></a><span class="lineno">13156</span>&#160;   imap_close_subscribed_mailbox(mwi_state, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13157"></a><span class="lineno">13157</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13158"></a><span class="lineno">13158</span>&#160;</div><div class="line"><a name="l13159"></a><span class="lineno">13159</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mwi_state, -1);</div><div class="line"><a name="l13160"></a><span class="lineno">13160</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13161"></a><span class="lineno">13161</span>&#160;}</div><div class="line"><a name="l13162"></a><span class="lineno">13162</span>&#160;</div><div class="line"><a name="l13163"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a76ac04f58d94b23ce7ef0fd5c4b99de7">13163</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a76ac04f58d94b23ce7ef0fd5c4b99de7">mwi_handle_unsubscribe</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">struct</span> <a class="code" href="../../de/d41/structast__mwi__subscriber.html">ast_mwi_subscriber</a> *<a class="code" href="../../d1/da4/res__corosync_8c.html#a8e51289dd0fc7415cee40e7a57b49fdf">sub</a>)</div><div class="line"><a name="l13164"></a><span class="lineno">13164</span>&#160;{</div><div class="line"><a name="l13165"></a><span class="lineno">13165</span>&#160;   <span class="keywordtype">void</span> *data = <a class="code" href="../../dc/d33/mwi_8h.html#ae56e2e8831cc3919b5d92bad99786572">ast_mwi_subscriber_data</a>(sub);</div><div class="line"><a name="l13166"></a><span class="lineno">13166</span>&#160;</div><div class="line"><a name="l13167"></a><span class="lineno">13167</span>&#160;   <span class="comment">/* Don&#39;t bump data&#39;s reference. We&#39;ll just use the one returned above */</span></div><div class="line"><a name="l13168"></a><span class="lineno">13168</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1e/taskprocessor_8h.html#a6b2508ba0a6b8f43ae6d3963f3189585">ast_taskprocessor_push</a>(mwi_subscription_tps, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a151aa2b14d2de12714ed26b49b535e62">mwi_handle_unsubscribe2</a>, data) &lt; 0) {</div><div class="line"><a name="l13169"></a><span class="lineno">13169</span>&#160;      <span class="comment">/* A reference was returned for data when retrieving, so remove it on error */</span></div><div class="line"><a name="l13170"></a><span class="lineno">13170</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(data, -1);</div><div class="line"><a name="l13171"></a><span class="lineno">13171</span>&#160;   }</div><div class="line"><a name="l13172"></a><span class="lineno">13172</span>&#160;}</div><div class="line"><a name="l13173"></a><span class="lineno">13173</span>&#160;</div><div class="line"><a name="l13174"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad1a6f2e97555fbf7ccd23e3228e331ec">13174</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1a6f2e97555fbf7ccd23e3228e331ec">mwi_handle_subscribe2</a>(<span class="keywordtype">void</span> *data)</div><div class="line"><a name="l13175"></a><span class="lineno">13175</span>&#160;{</div><div class="line"><a name="l13176"></a><span class="lineno">13176</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac963b5fb03d8e52621fde667f8a76e43">poll_subscribed_mailbox</a>(data, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13177"></a><span class="lineno">13177</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(data, -1);</div><div class="line"><a name="l13178"></a><span class="lineno">13178</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13179"></a><span class="lineno">13179</span>&#160;}</div><div class="line"><a name="l13180"></a><span class="lineno">13180</span>&#160;</div><div class="line"><a name="l13181"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ab5a51d8e382db73c64233a82ee99a4ef">13181</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab5a51d8e382db73c64233a82ee99a4ef">mwi_handle_subscribe</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">struct</span> <a class="code" href="../../de/d41/structast__mwi__subscriber.html">ast_mwi_subscriber</a> *<a class="code" href="../../d1/da4/res__corosync_8c.html#a8e51289dd0fc7415cee40e7a57b49fdf">sub</a>)</div><div class="line"><a name="l13182"></a><span class="lineno">13182</span>&#160;{</div><div class="line"><a name="l13183"></a><span class="lineno">13183</span>&#160;   <span class="keywordtype">void</span> *data = <a class="code" href="../../dc/d33/mwi_8h.html#ae56e2e8831cc3919b5d92bad99786572">ast_mwi_subscriber_data</a>(sub);</div><div class="line"><a name="l13184"></a><span class="lineno">13184</span>&#160;</div><div class="line"><a name="l13185"></a><span class="lineno">13185</span>&#160;   <span class="comment">/* Don&#39;t bump data&#39;s reference. We&#39;ll just use the one returned above */</span></div><div class="line"><a name="l13186"></a><span class="lineno">13186</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1e/taskprocessor_8h.html#a6b2508ba0a6b8f43ae6d3963f3189585">ast_taskprocessor_push</a>(mwi_subscription_tps, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1a6f2e97555fbf7ccd23e3228e331ec">mwi_handle_subscribe2</a>, data) &lt; 0) {</div><div class="line"><a name="l13187"></a><span class="lineno">13187</span>&#160;      <span class="comment">/* A reference was returned for data when retrieving, so remove it on error */</span></div><div class="line"><a name="l13188"></a><span class="lineno">13188</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(data, -1);</div><div class="line"><a name="l13189"></a><span class="lineno">13189</span>&#160;   }</div><div class="line"><a name="l13190"></a><span class="lineno">13190</span>&#160;}</div><div class="line"><a name="l13191"></a><span class="lineno">13191</span>&#160;</div><div class="line"><a name="l13192"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a65bc5b2d2cc590500653759b41108ac4">13192</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d1/dbb/structast__mwi__observer.html">ast_mwi_observer</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a65bc5b2d2cc590500653759b41108ac4">mwi_observer</a> = {</div><div class="line"><a name="l13193"></a><span class="lineno">13193</span>&#160;   .<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga26e335fc4e4c1e8d0023ae9c987ccb4b">on_subscribe</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab5a51d8e382db73c64233a82ee99a4ef">mwi_handle_subscribe</a>,</div><div class="line"><a name="l13194"></a><span class="lineno">13194</span>&#160;   .on_unsubscribe = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a76ac04f58d94b23ce7ef0fd5c4b99de7">mwi_handle_unsubscribe</a>,</div><div class="line"><a name="l13195"></a><span class="lineno">13195</span>&#160;};</div><div class="line"><a name="l13196"></a><span class="lineno">13196</span>&#160;</div><div class="line"><a name="l13197"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">13197</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">start_poll_thread</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l13198"></a><span class="lineno">13198</span>&#160;{</div><div class="line"><a name="l13199"></a><span class="lineno">13199</span>&#160;   <span class="keywordtype">int</span> errcode;</div><div class="line"><a name="l13200"></a><span class="lineno">13200</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#ab2d839cf1f63bd9a19f5d6dff8484bcf">ast_mwi_add_observer</a>(&amp;mwi_observer);</div><div class="line"><a name="l13201"></a><span class="lineno">13201</span>&#160;</div><div class="line"><a name="l13202"></a><span class="lineno">13202</span>&#160;   poll_thread_run = 1;</div><div class="line"><a name="l13203"></a><span class="lineno">13203</span>&#160;</div><div class="line"><a name="l13204"></a><span class="lineno">13204</span>&#160;   <span class="keywordflow">if</span> ((errcode = <a class="code" href="../../d5/d60/utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;poll_thread, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">mb_poll_thread</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line"><a name="l13205"></a><span class="lineno">13205</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not create thread: %s\n&quot;</span>, strerror(errcode));</div><div class="line"><a name="l13206"></a><span class="lineno">13206</span>&#160;   }</div><div class="line"><a name="l13207"></a><span class="lineno">13207</span>&#160;}</div><div class="line"><a name="l13208"></a><span class="lineno">13208</span>&#160;</div><div class="line"><a name="l13209"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">13209</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l13210"></a><span class="lineno">13210</span>&#160;{</div><div class="line"><a name="l13211"></a><span class="lineno">13211</span>&#160;   poll_thread_run = 0;</div><div class="line"><a name="l13212"></a><span class="lineno">13212</span>&#160;</div><div class="line"><a name="l13213"></a><span class="lineno">13213</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a>(&amp;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a>);</div><div class="line"><a name="l13214"></a><span class="lineno">13214</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#ae2cdf274a5da241c3ad7324d82bf6af0">ast_cond_signal</a>(&amp;poll_cond);</div><div class="line"><a name="l13215"></a><span class="lineno">13215</span>&#160;   <a class="code" href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a>(&amp;<a class="code" href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a>);</div><div class="line"><a name="l13216"></a><span class="lineno">13216</span>&#160;</div><div class="line"><a name="l13217"></a><span class="lineno">13217</span>&#160;   pthread_join(poll_thread, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13218"></a><span class="lineno">13218</span>&#160;   poll_thread = <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;</div><div class="line"><a name="l13219"></a><span class="lineno">13219</span>&#160;</div><div class="line"><a name="l13220"></a><span class="lineno">13220</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#ad200df5870ce5a601381c4e37f8a2197">ast_mwi_remove_observer</a>(&amp;mwi_observer);</div><div class="line"><a name="l13221"></a><span class="lineno">13221</span>&#160;}</div><div class="line"><a name="l13222"></a><span class="lineno">13222</span>&#160;<span class="comment"></span></div><div class="line"><a name="l13223"></a><span class="lineno">13223</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l13224"></a><span class="lineno">13224</span>&#160;<span class="comment"> * \brief Append vmu info string into given astman with event_name.</span></div><div class="line"><a name="l13225"></a><span class="lineno">13225</span>&#160;<span class="comment"> * \return 0 failed. 1 otherwise.</span></div><div class="line"><a name="l13226"></a><span class="lineno">13226</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l13227"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6850fa64e511b2de06fd2dd36a267883">13227</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6850fa64e511b2de06fd2dd36a267883">append_vmu_info_astman</a>(</div><div class="line"><a name="l13228"></a><span class="lineno">13228</span>&#160;      <span class="keyword">struct</span> <a class="code" href="../../d2/d8a/structmansession.html">mansession</a> *s,</div><div class="line"><a name="l13229"></a><span class="lineno">13229</span>&#160;      <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu,</div><div class="line"><a name="l13230"></a><span class="lineno">13230</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span>* event_name,</div><div class="line"><a name="l13231"></a><span class="lineno">13231</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span>* actionid</div><div class="line"><a name="l13232"></a><span class="lineno">13232</span>&#160;      )</div><div class="line"><a name="l13233"></a><span class="lineno">13233</span>&#160;{</div><div class="line"><a name="l13234"></a><span class="lineno">13234</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">new</span>;</div><div class="line"><a name="l13235"></a><span class="lineno">13235</span>&#160;   <span class="keywordtype">int</span> old;</div><div class="line"><a name="l13236"></a><span class="lineno">13236</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l13237"></a><span class="lineno">13237</span>&#160;   <span class="keywordtype">int</span> ret;</div><div class="line"><a name="l13238"></a><span class="lineno">13238</span>&#160;</div><div class="line"><a name="l13239"></a><span class="lineno">13239</span>&#160;   <span class="keywordflow">if</span>((s == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (vmu == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (event_name == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (actionid == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l13240"></a><span class="lineno">13240</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Wrong input parameter.&quot;</span>);</div><div class="line"><a name="l13241"></a><span class="lineno">13241</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13242"></a><span class="lineno">13242</span>&#160;   }</div><div class="line"><a name="l13243"></a><span class="lineno">13243</span>&#160;</div><div class="line"><a name="l13244"></a><span class="lineno">13244</span>&#160;   <span class="comment">/* create mailbox string */</span></div><div class="line"><a name="l13245"></a><span class="lineno">13245</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>)) {</div><div class="line"><a name="l13246"></a><span class="lineno">13246</span>&#160;      ret = <a class="code" href="../../d8/d8a/astmm_8h.html#ada667b6f84a08e6848cb37c5ffb94a5f">ast_asprintf</a>(&amp;mailbox, <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l13247"></a><span class="lineno">13247</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13248"></a><span class="lineno">13248</span>&#160;      ret = <a class="code" href="../../d8/d8a/astmm_8h.html#ada667b6f84a08e6848cb37c5ffb94a5f">ast_asprintf</a>(&amp;mailbox, <span class="stringliteral">&quot;%s&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l13249"></a><span class="lineno">13249</span>&#160;   }</div><div class="line"><a name="l13250"></a><span class="lineno">13250</span>&#160;   <span class="keywordflow">if</span> (ret == -1) {</div><div class="line"><a name="l13251"></a><span class="lineno">13251</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not create mailbox string. err[%s]\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l13252"></a><span class="lineno">13252</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13253"></a><span class="lineno">13253</span>&#160;   }</div><div class="line"><a name="l13254"></a><span class="lineno">13254</span>&#160;</div><div class="line"><a name="l13255"></a><span class="lineno">13255</span>&#160;   <span class="comment">/* get mailbox count */</span></div><div class="line"><a name="l13256"></a><span class="lineno">13256</span>&#160;   ret = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(mailbox, &amp;<span class="keyword">new</span>, &amp;old);</div><div class="line"><a name="l13257"></a><span class="lineno">13257</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mailbox);</div><div class="line"><a name="l13258"></a><span class="lineno">13258</span>&#160;   <span class="keywordflow">if</span> (ret == -1) {</div><div class="line"><a name="l13259"></a><span class="lineno">13259</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not get mailbox count. user[%s], context[%s]\n&quot;</span>,</div><div class="line"><a name="l13260"></a><span class="lineno">13260</span>&#160;         vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a> ?: <span class="stringliteral">&quot;&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a> ?: <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l13261"></a><span class="lineno">13261</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13262"></a><span class="lineno">13262</span>&#160;   }</div><div class="line"><a name="l13263"></a><span class="lineno">13263</span>&#160;</div><div class="line"><a name="l13264"></a><span class="lineno">13264</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,</div><div class="line"><a name="l13265"></a><span class="lineno">13265</span>&#160;      <span class="stringliteral">&quot;Event: %s\r\n&quot;</span></div><div class="line"><a name="l13266"></a><span class="lineno">13266</span>&#160;      <span class="stringliteral">&quot;%s&quot;</span></div><div class="line"><a name="l13267"></a><span class="lineno">13267</span>&#160;      <span class="stringliteral">&quot;VMContext: %s\r\n&quot;</span></div><div class="line"><a name="l13268"></a><span class="lineno">13268</span>&#160;      <span class="stringliteral">&quot;VoiceMailbox: %s\r\n&quot;</span></div><div class="line"><a name="l13269"></a><span class="lineno">13269</span>&#160;      <span class="stringliteral">&quot;Fullname: %s\r\n&quot;</span></div><div class="line"><a name="l13270"></a><span class="lineno">13270</span>&#160;      <span class="stringliteral">&quot;Email: %s\r\n&quot;</span></div><div class="line"><a name="l13271"></a><span class="lineno">13271</span>&#160;      <span class="stringliteral">&quot;Pager: %s\r\n&quot;</span></div><div class="line"><a name="l13272"></a><span class="lineno">13272</span>&#160;      <span class="stringliteral">&quot;ServerEmail: %s\r\n&quot;</span></div><div class="line"><a name="l13273"></a><span class="lineno">13273</span>&#160;      <span class="stringliteral">&quot;FromString: %s\r\n&quot;</span></div><div class="line"><a name="l13274"></a><span class="lineno">13274</span>&#160;      <span class="stringliteral">&quot;MailCommand: %s\r\n&quot;</span></div><div class="line"><a name="l13275"></a><span class="lineno">13275</span>&#160;      <span class="stringliteral">&quot;Language: %s\r\n&quot;</span></div><div class="line"><a name="l13276"></a><span class="lineno">13276</span>&#160;      <span class="stringliteral">&quot;TimeZone: %s\r\n&quot;</span></div><div class="line"><a name="l13277"></a><span class="lineno">13277</span>&#160;      <span class="stringliteral">&quot;Callback: %s\r\n&quot;</span></div><div class="line"><a name="l13278"></a><span class="lineno">13278</span>&#160;      <span class="stringliteral">&quot;Dialout: %s\r\n&quot;</span></div><div class="line"><a name="l13279"></a><span class="lineno">13279</span>&#160;      <span class="stringliteral">&quot;UniqueID: %s\r\n&quot;</span></div><div class="line"><a name="l13280"></a><span class="lineno">13280</span>&#160;      <span class="stringliteral">&quot;ExitContext: %s\r\n&quot;</span></div><div class="line"><a name="l13281"></a><span class="lineno">13281</span>&#160;      <span class="stringliteral">&quot;SayDurationMinimum: %d\r\n&quot;</span></div><div class="line"><a name="l13282"></a><span class="lineno">13282</span>&#160;      <span class="stringliteral">&quot;SayEnvelope: %s\r\n&quot;</span></div><div class="line"><a name="l13283"></a><span class="lineno">13283</span>&#160;      <span class="stringliteral">&quot;SayCID: %s\r\n&quot;</span></div><div class="line"><a name="l13284"></a><span class="lineno">13284</span>&#160;      <span class="stringliteral">&quot;AttachMessage: %s\r\n&quot;</span></div><div class="line"><a name="l13285"></a><span class="lineno">13285</span>&#160;      <span class="stringliteral">&quot;AttachmentFormat: %s\r\n&quot;</span></div><div class="line"><a name="l13286"></a><span class="lineno">13286</span>&#160;      <span class="stringliteral">&quot;DeleteMessage: %s\r\n&quot;</span></div><div class="line"><a name="l13287"></a><span class="lineno">13287</span>&#160;      <span class="stringliteral">&quot;VolumeGain: %.2f\r\n&quot;</span></div><div class="line"><a name="l13288"></a><span class="lineno">13288</span>&#160;      <span class="stringliteral">&quot;CanReview: %s\r\n&quot;</span></div><div class="line"><a name="l13289"></a><span class="lineno">13289</span>&#160;      <span class="stringliteral">&quot;CallOperator: %s\r\n&quot;</span></div><div class="line"><a name="l13290"></a><span class="lineno">13290</span>&#160;      <span class="stringliteral">&quot;MaxMessageCount: %d\r\n&quot;</span></div><div class="line"><a name="l13291"></a><span class="lineno">13291</span>&#160;      <span class="stringliteral">&quot;MaxMessageLength: %d\r\n&quot;</span></div><div class="line"><a name="l13292"></a><span class="lineno">13292</span>&#160;      <span class="stringliteral">&quot;NewMessageCount: %d\r\n&quot;</span></div><div class="line"><a name="l13293"></a><span class="lineno">13293</span>&#160;      <span class="stringliteral">&quot;OldMessageCount: %d\r\n&quot;</span></div><div class="line"><a name="l13294"></a><span class="lineno">13294</span>&#160;#ifdef IMAP_STORAGE</div><div class="line"><a name="l13295"></a><span class="lineno">13295</span>&#160;      <span class="stringliteral">&quot;IMAPUser: %s\r\n&quot;</span></div><div class="line"><a name="l13296"></a><span class="lineno">13296</span>&#160;      <span class="stringliteral">&quot;IMAPServer: %s\r\n&quot;</span></div><div class="line"><a name="l13297"></a><span class="lineno">13297</span>&#160;      <span class="stringliteral">&quot;IMAPPort: %s\r\n&quot;</span></div><div class="line"><a name="l13298"></a><span class="lineno">13298</span>&#160;      <span class="stringliteral">&quot;IMAPFlags: %s\r\n&quot;</span></div><div class="line"><a name="l13299"></a><span class="lineno">13299</span>&#160;#endif</div><div class="line"><a name="l13300"></a><span class="lineno">13300</span>&#160;      <span class="stringliteral">&quot;\r\n&quot;</span>,</div><div class="line"><a name="l13301"></a><span class="lineno">13301</span>&#160;</div><div class="line"><a name="l13302"></a><span class="lineno">13302</span>&#160;      event_name,</div><div class="line"><a name="l13303"></a><span class="lineno">13303</span>&#160;      actionid,</div><div class="line"><a name="l13304"></a><span class="lineno">13304</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>,</div><div class="line"><a name="l13305"></a><span class="lineno">13305</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>,</div><div class="line"><a name="l13306"></a><span class="lineno">13306</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>,</div><div class="line"><a name="l13307"></a><span class="lineno">13307</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a>,</div><div class="line"><a name="l13308"></a><span class="lineno">13308</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>,</div><div class="line"><a name="l13309"></a><span class="lineno">13309</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>) ? serveremail : vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>,</div><div class="line"><a name="l13310"></a><span class="lineno">13310</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>) ? fromstring : vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>,</div><div class="line"><a name="l13311"></a><span class="lineno">13311</span>&#160;      mailcmd,</div><div class="line"><a name="l13312"></a><span class="lineno">13312</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>,</div><div class="line"><a name="l13313"></a><span class="lineno">13313</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>,</div><div class="line"><a name="l13314"></a><span class="lineno">13314</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>,</div><div class="line"><a name="l13315"></a><span class="lineno">13315</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>,</div><div class="line"><a name="l13316"></a><span class="lineno">13316</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">uniqueid</a>,</div><div class="line"><a name="l13317"></a><span class="lineno">13317</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>,</div><div class="line"><a name="l13318"></a><span class="lineno">13318</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a>,</div><div class="line"><a name="l13319"></a><span class="lineno">13319</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div><div class="line"><a name="l13320"></a><span class="lineno">13320</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div><div class="line"><a name="l13321"></a><span class="lineno">13321</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div><div class="line"><a name="l13322"></a><span class="lineno">13322</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>,</div><div class="line"><a name="l13323"></a><span class="lineno">13323</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div><div class="line"><a name="l13324"></a><span class="lineno">13324</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>,</div><div class="line"><a name="l13325"></a><span class="lineno">13325</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div><div class="line"><a name="l13326"></a><span class="lineno">13326</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div><div class="line"><a name="l13327"></a><span class="lineno">13327</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>,</div><div class="line"><a name="l13328"></a><span class="lineno">13328</span>&#160;      vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>,</div><div class="line"><a name="l13329"></a><span class="lineno">13329</span>&#160;      <span class="keyword">new</span>,</div><div class="line"><a name="l13330"></a><span class="lineno">13330</span>&#160;      old</div><div class="line"><a name="l13331"></a><span class="lineno">13331</span>&#160;#ifdef IMAP_STORAGE</div><div class="line"><a name="l13332"></a><span class="lineno">13332</span>&#160;      ,</div><div class="line"><a name="l13333"></a><span class="lineno">13333</span>&#160;      vmu-&gt;imapuser,</div><div class="line"><a name="l13334"></a><span class="lineno">13334</span>&#160;      vmu-&gt;imapserver,</div><div class="line"><a name="l13335"></a><span class="lineno">13335</span>&#160;      vmu-&gt;imapport,</div><div class="line"><a name="l13336"></a><span class="lineno">13336</span>&#160;      vmu-&gt;imapflags</div><div class="line"><a name="l13337"></a><span class="lineno">13337</span>&#160;#endif</div><div class="line"><a name="l13338"></a><span class="lineno">13338</span>&#160;      );</div><div class="line"><a name="l13339"></a><span class="lineno">13339</span>&#160;</div><div class="line"><a name="l13340"></a><span class="lineno">13340</span>&#160;   <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l13341"></a><span class="lineno">13341</span>&#160;</div><div class="line"><a name="l13342"></a><span class="lineno">13342</span>&#160;}</div><div class="line"><a name="l13343"></a><span class="lineno">13343</span>&#160;</div><div class="line"><a name="l13344"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae521e9b8082a7c9591e1a8dea8963a95">13344</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae521e9b8082a7c9591e1a8dea8963a95">manager_match_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d45/structast__mwi__state.html">ast_mwi_state</a> *mwi_state, <span class="keywordtype">void</span> *data)</div><div class="line"><a name="l13345"></a><span class="lineno">13345</span>&#160;{</div><div class="line"><a name="l13346"></a><span class="lineno">13346</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context = <a class="code" href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a>(data, <span class="stringliteral">&quot;Context&quot;</span>);</div><div class="line"><a name="l13347"></a><span class="lineno">13347</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox = <a class="code" href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a>(data, <span class="stringliteral">&quot;Mailbox&quot;</span>);</div><div class="line"><a name="l13348"></a><span class="lineno">13348</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *at;</div><div class="line"><a name="l13349"></a><span class="lineno">13349</span>&#160;</div><div class="line"><a name="l13350"></a><span class="lineno">13350</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>)) {</div><div class="line"><a name="l13351"></a><span class="lineno">13351</span>&#160;      <span class="keywordflow">if</span> (</div><div class="line"><a name="l13352"></a><span class="lineno">13352</span>&#160;         <span class="comment">/* First case: everything matches */</span></div><div class="line"><a name="l13353"></a><span class="lineno">13353</span>&#160;         (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) ||</div><div class="line"><a name="l13354"></a><span class="lineno">13354</span>&#160;         <span class="comment">/* Second case: match the mailbox only */</span></div><div class="line"><a name="l13355"></a><span class="lineno">13355</span>&#160;         (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox) &amp;&amp;</div><div class="line"><a name="l13356"></a><span class="lineno">13356</span>&#160;          (at = strchr(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, <span class="charliteral">&#39;@&#39;</span>)) &amp;&amp;</div><div class="line"><a name="l13357"></a><span class="lineno">13357</span>&#160;          strncmp(mailbox, mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, at - mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>) == 0) ||</div><div class="line"><a name="l13358"></a><span class="lineno">13358</span>&#160;         <span class="comment">/* Third case: match the context only */</span></div><div class="line"><a name="l13359"></a><span class="lineno">13359</span>&#160;         (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox) &amp;&amp;</div><div class="line"><a name="l13360"></a><span class="lineno">13360</span>&#160;          (at = strchr(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, <span class="charliteral">&#39;@&#39;</span>)) &amp;&amp;</div><div class="line"><a name="l13361"></a><span class="lineno">13361</span>&#160;          strcmp(context, at + 1) == 0) ||</div><div class="line"><a name="l13362"></a><span class="lineno">13362</span>&#160;         <span class="comment">/* Final case: match an exact specified mailbox */</span></div><div class="line"><a name="l13363"></a><span class="lineno">13363</span>&#160;         (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) &amp;&amp; !<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox) &amp;&amp;</div><div class="line"><a name="l13364"></a><span class="lineno">13364</span>&#160;          (at = strchr(mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, <span class="charliteral">&#39;@&#39;</span>)) &amp;&amp;</div><div class="line"><a name="l13365"></a><span class="lineno">13365</span>&#160;          strncmp(mailbox, mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>, at - mwi_state-&gt;<a class="code" href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">uniqueid</a>) == 0 &amp;&amp;</div><div class="line"><a name="l13366"></a><span class="lineno">13366</span>&#160;          strcmp(context, at + 1) == 0)</div><div class="line"><a name="l13367"></a><span class="lineno">13367</span>&#160;         ) {</div><div class="line"><a name="l13368"></a><span class="lineno">13368</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac963b5fb03d8e52621fde667f8a76e43">poll_subscribed_mailbox</a>(mwi_state, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13369"></a><span class="lineno">13369</span>&#160;      }</div><div class="line"><a name="l13370"></a><span class="lineno">13370</span>&#160;   }</div><div class="line"><a name="l13371"></a><span class="lineno">13371</span>&#160;</div><div class="line"><a name="l13372"></a><span class="lineno">13372</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13373"></a><span class="lineno">13373</span>&#160;}</div><div class="line"><a name="l13374"></a><span class="lineno">13374</span>&#160;</div><div class="line"><a name="l13375"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1663f2d08dd7c882b4eda7a725bbf275">13375</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1663f2d08dd7c882b4eda7a725bbf275">manager_voicemail_refresh</a>(<span class="keyword">struct</span> <a class="code" href="../../d2/d8a/structmansession.html">mansession</a> *s, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d8/d9e/structmessage.html">message</a> *m)</div><div class="line"><a name="l13376"></a><span class="lineno">13376</span>&#160;{</div><div class="line"><a name="l13377"></a><span class="lineno">13377</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#aa7789090f6f6177b5033d240bba65b93">ast_mwi_state_callback_all</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae521e9b8082a7c9591e1a8dea8963a95">manager_match_mailbox</a>, (<span class="keywordtype">void</span> *)m);</div><div class="line"><a name="l13378"></a><span class="lineno">13378</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Refresh sent&quot;</span>);</div><div class="line"><a name="l13379"></a><span class="lineno">13379</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;</div><div class="line"><a name="l13380"></a><span class="lineno">13380</span>&#160;}</div><div class="line"><a name="l13381"></a><span class="lineno">13381</span>&#160;</div><div class="line"><a name="l13382"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad6fa7eabdb6693aa433127102cd7abcd">13382</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad6fa7eabdb6693aa433127102cd7abcd">manager_status_voicemail_user</a>(<span class="keyword">struct</span> <a class="code" href="../../d2/d8a/structmansession.html">mansession</a> *s, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d8/d9e/structmessage.html">message</a> *m)</div><div class="line"><a name="l13383"></a><span class="lineno">13383</span>&#160;{</div><div class="line"><a name="l13384"></a><span class="lineno">13384</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13385"></a><span class="lineno">13385</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);</div><div class="line"><a name="l13386"></a><span class="lineno">13386</span>&#160;   <span class="keywordtype">char</span> actionid[128];</div><div class="line"><a name="l13387"></a><span class="lineno">13387</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> svm;</div><div class="line"><a name="l13388"></a><span class="lineno">13388</span>&#160;   <span class="keywordtype">int</span> ret;</div><div class="line"><a name="l13389"></a><span class="lineno">13389</span>&#160;</div><div class="line"><a name="l13390"></a><span class="lineno">13390</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context = <a class="code" href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a>(m, <span class="stringliteral">&quot;Context&quot;</span>);</div><div class="line"><a name="l13391"></a><span class="lineno">13391</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox = <a class="code" href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a>(m, <span class="stringliteral">&quot;Mailbox&quot;</span>);</div><div class="line"><a name="l13392"></a><span class="lineno">13392</span>&#160;</div><div class="line"><a name="l13393"></a><span class="lineno">13393</span>&#160;   <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context) || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox))) {</div><div class="line"><a name="l13394"></a><span class="lineno">13394</span>&#160;      <a class="code" href="../../df/d72/group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Need &#39;Context&#39; and &#39;Mailbox&#39; parameters.&quot;</span>);</div><div class="line"><a name="l13395"></a><span class="lineno">13395</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;</div><div class="line"><a name="l13396"></a><span class="lineno">13396</span>&#160;   }</div><div class="line"><a name="l13397"></a><span class="lineno">13397</span>&#160;</div><div class="line"><a name="l13398"></a><span class="lineno">13398</span>&#160;   actionid[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l13399"></a><span class="lineno">13399</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<span class="keywordtype">id</span>)) {</div><div class="line"><a name="l13400"></a><span class="lineno">13400</span>&#160;      snprintf(actionid, <span class="keyword">sizeof</span>(actionid), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);</div><div class="line"><a name="l13401"></a><span class="lineno">13401</span>&#160;   }</div><div class="line"><a name="l13402"></a><span class="lineno">13402</span>&#160;</div><div class="line"><a name="l13403"></a><span class="lineno">13403</span>&#160;   <span class="comment">/* find user */</span></div><div class="line"><a name="l13404"></a><span class="lineno">13404</span>&#160;   memset(&amp;svm, 0, <span class="keyword">sizeof</span>(svm));</div><div class="line"><a name="l13405"></a><span class="lineno">13405</span>&#160;   vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;svm, context, mailbox);</div><div class="line"><a name="l13406"></a><span class="lineno">13406</span>&#160;   <span class="keywordflow">if</span> (!vmu) {</div><div class="line"><a name="l13407"></a><span class="lineno">13407</span>&#160;      <span class="comment">/* could not find it */</span></div><div class="line"><a name="l13408"></a><span class="lineno">13408</span>&#160;      <a class="code" href="../../df/d72/group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;There is no voicemail user of the given info.&quot;</span>);</div><div class="line"><a name="l13409"></a><span class="lineno">13409</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;</div><div class="line"><a name="l13410"></a><span class="lineno">13410</span>&#160;   }</div><div class="line"><a name="l13411"></a><span class="lineno">13411</span>&#160;</div><div class="line"><a name="l13412"></a><span class="lineno">13412</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#ga0ee6ee1f4d200f711e2983bffe770a72">astman_send_listack</a>(s, m, <span class="stringliteral">&quot;Voicemail user detail will follow&quot;</span>, <span class="stringliteral">&quot;start&quot;</span>);</div><div class="line"><a name="l13413"></a><span class="lineno">13413</span>&#160;</div><div class="line"><a name="l13414"></a><span class="lineno">13414</span>&#160;   <span class="comment">/* append vmu info event */</span></div><div class="line"><a name="l13415"></a><span class="lineno">13415</span>&#160;   ret = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6850fa64e511b2de06fd2dd36a267883">append_vmu_info_astman</a>(s, vmu, <span class="stringliteral">&quot;VoicemailUserDetail&quot;</span>, actionid);</div><div class="line"><a name="l13416"></a><span class="lineno">13416</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l13417"></a><span class="lineno">13417</span>&#160;   <span class="keywordflow">if</span>(ret == 0) {</div><div class="line"><a name="l13418"></a><span class="lineno">13418</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not append voicemail user info.&quot;</span>);</div><div class="line"><a name="l13419"></a><span class="lineno">13419</span>&#160;   }</div><div class="line"><a name="l13420"></a><span class="lineno">13420</span>&#160;</div><div class="line"><a name="l13421"></a><span class="lineno">13421</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#ga58c3e3da5d31739cafaee1df6ddf9342">astman_send_list_complete_start</a>(s, m, <span class="stringliteral">&quot;VoicemailUserDetailComplete&quot;</span>, 1);</div><div class="line"><a name="l13422"></a><span class="lineno">13422</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#gabf7c909efbfc26d0d9c66786c83b8f69">astman_send_list_complete_end</a>(s);</div><div class="line"><a name="l13423"></a><span class="lineno">13423</span>&#160;</div><div class="line"><a name="l13424"></a><span class="lineno">13424</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;</div><div class="line"><a name="l13425"></a><span class="lineno">13425</span>&#160;}</div><div class="line"><a name="l13426"></a><span class="lineno">13426</span>&#160;<span class="comment"></span></div><div class="line"><a name="l13427"></a><span class="lineno">13427</span>&#160;<span class="comment">/*! \brief Manager list voicemail users command */</span></div><div class="line"><a name="l13428"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752">13428</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752">manager_list_voicemail_users</a>(<span class="keyword">struct</span> <a class="code" href="../../d2/d8a/structmansession.html">mansession</a> *s, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d8/d9e/structmessage.html">message</a> *m)</div><div class="line"><a name="l13429"></a><span class="lineno">13429</span>&#160;{</div><div class="line"><a name="l13430"></a><span class="lineno">13430</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13431"></a><span class="lineno">13431</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);</div><div class="line"><a name="l13432"></a><span class="lineno">13432</span>&#160;   <span class="keywordtype">char</span> actionid[128];</div><div class="line"><a name="l13433"></a><span class="lineno">13433</span>&#160;   <span class="keywordtype">int</span> num_users = 0;</div><div class="line"><a name="l13434"></a><span class="lineno">13434</span>&#160;   <span class="keywordtype">int</span> ret;</div><div class="line"><a name="l13435"></a><span class="lineno">13435</span>&#160;</div><div class="line"><a name="l13436"></a><span class="lineno">13436</span>&#160;   actionid[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l13437"></a><span class="lineno">13437</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(<span class="keywordtype">id</span>)) {</div><div class="line"><a name="l13438"></a><span class="lineno">13438</span>&#160;      snprintf(actionid, <span class="keyword">sizeof</span>(actionid), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);</div><div class="line"><a name="l13439"></a><span class="lineno">13439</span>&#160;   }</div><div class="line"><a name="l13440"></a><span class="lineno">13440</span>&#160;</div><div class="line"><a name="l13441"></a><span class="lineno">13441</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l13442"></a><span class="lineno">13442</span>&#160;</div><div class="line"><a name="l13443"></a><span class="lineno">13443</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../df/d90/linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05">AST_LIST_EMPTY</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>)) {</div><div class="line"><a name="l13444"></a><span class="lineno">13444</span>&#160;      <a class="code" href="../../df/d72/group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;There are no voicemail users currently defined.&quot;</span>);</div><div class="line"><a name="l13445"></a><span class="lineno">13445</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l13446"></a><span class="lineno">13446</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;</div><div class="line"><a name="l13447"></a><span class="lineno">13447</span>&#160;   }</div><div class="line"><a name="l13448"></a><span class="lineno">13448</span>&#160;</div><div class="line"><a name="l13449"></a><span class="lineno">13449</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#ga0ee6ee1f4d200f711e2983bffe770a72">astman_send_listack</a>(s, m, <span class="stringliteral">&quot;Voicemail user list will follow&quot;</span>, <span class="stringliteral">&quot;start&quot;</span>);</div><div class="line"><a name="l13450"></a><span class="lineno">13450</span>&#160;</div><div class="line"><a name="l13451"></a><span class="lineno">13451</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l13452"></a><span class="lineno">13452</span>&#160;      <span class="comment">/* append vmu info event */</span></div><div class="line"><a name="l13453"></a><span class="lineno">13453</span>&#160;      ret = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6850fa64e511b2de06fd2dd36a267883">append_vmu_info_astman</a>(s, vmu, <span class="stringliteral">&quot;VoicemailUserEntry&quot;</span>, actionid);</div><div class="line"><a name="l13454"></a><span class="lineno">13454</span>&#160;      <span class="keywordflow">if</span>(ret == 0) {</div><div class="line"><a name="l13455"></a><span class="lineno">13455</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not append voicemail user info.&quot;</span>);</div><div class="line"><a name="l13456"></a><span class="lineno">13456</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l13457"></a><span class="lineno">13457</span>&#160;      }</div><div class="line"><a name="l13458"></a><span class="lineno">13458</span>&#160;      ++num_users;</div><div class="line"><a name="l13459"></a><span class="lineno">13459</span>&#160;   }</div><div class="line"><a name="l13460"></a><span class="lineno">13460</span>&#160;</div><div class="line"><a name="l13461"></a><span class="lineno">13461</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#ga58c3e3da5d31739cafaee1df6ddf9342">astman_send_list_complete_start</a>(s, m, <span class="stringliteral">&quot;VoicemailUserEntryComplete&quot;</span>, num_users);</div><div class="line"><a name="l13462"></a><span class="lineno">13462</span>&#160;   <a class="code" href="../../df/d72/group__Group__AMI.html#gabf7c909efbfc26d0d9c66786c83b8f69">astman_send_list_complete_end</a>(s);</div><div class="line"><a name="l13463"></a><span class="lineno">13463</span>&#160;</div><div class="line"><a name="l13464"></a><span class="lineno">13464</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l13465"></a><span class="lineno">13465</span>&#160;</div><div class="line"><a name="l13466"></a><span class="lineno">13466</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;</div><div class="line"><a name="l13467"></a><span class="lineno">13467</span>&#160;}</div><div class="line"><a name="l13468"></a><span class="lineno">13468</span>&#160;<span class="comment"></span></div><div class="line"><a name="l13469"></a><span class="lineno">13469</span>&#160;<span class="comment">/*! \brief Free the users structure. */</span></div><div class="line"><a name="l13470"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101">13470</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101">free_vm_users</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l13471"></a><span class="lineno">13471</span>&#160;{</div><div class="line"><a name="l13472"></a><span class="lineno">13472</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *current;</div><div class="line"><a name="l13473"></a><span class="lineno">13473</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l13474"></a><span class="lineno">13474</span>&#160;   <span class="keywordflow">while</span> ((current = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>))) {</div><div class="line"><a name="l13475"></a><span class="lineno">13475</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(current, <a class="code" href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);</div><div class="line"><a name="l13476"></a><span class="lineno">13476</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8dd478366d9ea311c99d0e564bfb1cee">free_user_final</a>(current);</div><div class="line"><a name="l13477"></a><span class="lineno">13477</span>&#160;   }</div><div class="line"><a name="l13478"></a><span class="lineno">13478</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l13479"></a><span class="lineno">13479</span>&#160;}</div><div class="line"><a name="l13480"></a><span class="lineno">13480</span>&#160;<span class="comment"></span></div><div class="line"><a name="l13481"></a><span class="lineno">13481</span>&#160;<span class="comment">/*! \brief Free the zones structure. */</span></div><div class="line"><a name="l13482"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473">13482</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473">free_vm_zones</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l13483"></a><span class="lineno">13483</span>&#160;{</div><div class="line"><a name="l13484"></a><span class="lineno">13484</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *zcur;</div><div class="line"><a name="l13485"></a><span class="lineno">13485</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l13486"></a><span class="lineno">13486</span>&#160;   <span class="keywordflow">while</span> ((zcur = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>, <a class="code" href="../../d7/d13/structvm__zone.html#a824b6fba3cdf05b72afb1e22ef25a38c">list</a>)))</div><div class="line"><a name="l13487"></a><span class="lineno">13487</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2">free_zone</a>(zcur);</div><div class="line"><a name="l13488"></a><span class="lineno">13488</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l13489"></a><span class="lineno">13489</span>&#160;}</div><div class="line"><a name="l13490"></a><span class="lineno">13490</span>&#160;</div><div class="line"><a name="l13491"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">13491</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>)</div><div class="line"><a name="l13492"></a><span class="lineno">13492</span>&#160;{</div><div class="line"><a name="l13493"></a><span class="lineno">13493</span>&#160;   <span class="keywordtype">char</span> *current;</div><div class="line"><a name="l13494"></a><span class="lineno">13494</span>&#160;</div><div class="line"><a name="l13495"></a><span class="lineno">13495</span>&#160;   <span class="comment">/* Add 16 for fudge factor */</span></div><div class="line"><a name="l13496"></a><span class="lineno">13496</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> *<a class="code" href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a> = <a class="code" href="../../d6/d90/strings_8h.html#afe8f5f844f2fd5f5bd5d0be5ef671481">ast_str_thread_get</a>(&amp;ast_str_thread_global_buf, strlen(value) + 16);</div><div class="line"><a name="l13497"></a><span class="lineno">13497</span>&#160;</div><div class="line"><a name="l13498"></a><span class="lineno">13498</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#a8239b9ad10367bfc936e9b60ff7706a8">ast_str_reset</a>(str);</div><div class="line"><a name="l13499"></a><span class="lineno">13499</span>&#160;</div><div class="line"><a name="l13500"></a><span class="lineno">13500</span>&#160;   <span class="comment">/* Substitute strings \r, \n, and \t into the appropriate characters */</span></div><div class="line"><a name="l13501"></a><span class="lineno">13501</span>&#160;   <span class="keywordflow">for</span> (current = (<span class="keywordtype">char</span> *) value; *current; current++) {</div><div class="line"><a name="l13502"></a><span class="lineno">13502</span>&#160;      <span class="keywordflow">if</span> (*current == <span class="charliteral">&#39;\\&#39;</span>) {</div><div class="line"><a name="l13503"></a><span class="lineno">13503</span>&#160;         current++;</div><div class="line"><a name="l13504"></a><span class="lineno">13504</span>&#160;         <span class="keywordflow">if</span> (!*current) {</div><div class="line"><a name="l13505"></a><span class="lineno">13505</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Incomplete escape at end of value.\n&quot;</span>);</div><div class="line"><a name="l13506"></a><span class="lineno">13506</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l13507"></a><span class="lineno">13507</span>&#160;         }</div><div class="line"><a name="l13508"></a><span class="lineno">13508</span>&#160;         <span class="keywordflow">switch</span> (*current) {</div><div class="line"><a name="l13509"></a><span class="lineno">13509</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;\\&#39;</span>:</div><div class="line"><a name="l13510"></a><span class="lineno">13510</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\\&quot;</span>);</div><div class="line"><a name="l13511"></a><span class="lineno">13511</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l13512"></a><span class="lineno">13512</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div><div class="line"><a name="l13513"></a><span class="lineno">13513</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\r&quot;</span>);</div><div class="line"><a name="l13514"></a><span class="lineno">13514</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l13515"></a><span class="lineno">13515</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div><div class="line"><a name="l13516"></a><span class="lineno">13516</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13517"></a><span class="lineno">13517</span>&#160;            <span class="keywordflow">if</span> (!str-&gt;used || str-&gt;str[str-&gt;used - 1] != <span class="charliteral">&#39;\r&#39;</span>) {</div><div class="line"><a name="l13518"></a><span class="lineno">13518</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\r&quot;</span>);</div><div class="line"><a name="l13519"></a><span class="lineno">13519</span>&#160;            }</div><div class="line"><a name="l13520"></a><span class="lineno">13520</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13521"></a><span class="lineno">13521</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"><a name="l13522"></a><span class="lineno">13522</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l13523"></a><span class="lineno">13523</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div><div class="line"><a name="l13524"></a><span class="lineno">13524</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\t&quot;</span>);</div><div class="line"><a name="l13525"></a><span class="lineno">13525</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l13526"></a><span class="lineno">13526</span>&#160;         <span class="keywordflow">default</span>:</div><div class="line"><a name="l13527"></a><span class="lineno">13527</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Substitution routine does not support this character: \\%c\n&quot;</span>, *current);</div><div class="line"><a name="l13528"></a><span class="lineno">13528</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l13529"></a><span class="lineno">13529</span>&#160;         }</div><div class="line"><a name="l13530"></a><span class="lineno">13530</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13531"></a><span class="lineno">13531</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;%c&quot;</span>, *current);</div><div class="line"><a name="l13532"></a><span class="lineno">13532</span>&#160;      }</div><div class="line"><a name="l13533"></a><span class="lineno">13533</span>&#160;   }</div><div class="line"><a name="l13534"></a><span class="lineno">13534</span>&#160;</div><div class="line"><a name="l13535"></a><span class="lineno">13535</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(str);</div><div class="line"><a name="l13536"></a><span class="lineno">13536</span>&#160;}</div><div class="line"><a name="l13537"></a><span class="lineno">13537</span>&#160;</div><div class="line"><a name="l13538"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">13538</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(<span class="keywordtype">int</span> reload)</div><div class="line"><a name="l13539"></a><span class="lineno">13539</span>&#160;{</div><div class="line"><a name="l13540"></a><span class="lineno">13540</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg, *ucfg;</div><div class="line"><a name="l13541"></a><span class="lineno">13541</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { reload ? <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fafa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };</div><div class="line"><a name="l13542"></a><span class="lineno">13542</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l13543"></a><span class="lineno">13543</span>&#160;</div><div class="line"><a name="l13544"></a><span class="lineno">13544</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>);</div><div class="line"><a name="l13545"></a><span class="lineno">13545</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>);</div><div class="line"><a name="l13546"></a><span class="lineno">13546</span>&#160;</div><div class="line"><a name="l13547"></a><span class="lineno">13547</span>&#160;   <span class="keywordflow">if</span> ((cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, config_flags)) == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {</div><div class="line"><a name="l13548"></a><span class="lineno">13548</span>&#160;      <span class="keywordflow">if</span> ((ucfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {</div><div class="line"><a name="l13549"></a><span class="lineno">13549</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13550"></a><span class="lineno">13550</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ucfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l13551"></a><span class="lineno">13551</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file users.conf is in an invalid format.  Avoiding.\n&quot;</span>);</div><div class="line"><a name="l13552"></a><span class="lineno">13552</span>&#160;         ucfg = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13553"></a><span class="lineno">13553</span>&#160;      }</div><div class="line"><a name="l13554"></a><span class="lineno">13554</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;config_flags, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fafa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a>);</div><div class="line"><a name="l13555"></a><span class="lineno">13555</span>&#160;      <span class="keywordflow">if</span> ((cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, config_flags)) == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l13556"></a><span class="lineno">13556</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(ucfg);</div><div class="line"><a name="l13557"></a><span class="lineno">13557</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);</div><div class="line"><a name="l13558"></a><span class="lineno">13558</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13559"></a><span class="lineno">13559</span>&#160;      }</div><div class="line"><a name="l13560"></a><span class="lineno">13560</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l13561"></a><span class="lineno">13561</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);</div><div class="line"><a name="l13562"></a><span class="lineno">13562</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l13563"></a><span class="lineno">13563</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13564"></a><span class="lineno">13564</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;config_flags, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fafa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a>);</div><div class="line"><a name="l13565"></a><span class="lineno">13565</span>&#160;      <span class="keywordflow">if</span> ((ucfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l13566"></a><span class="lineno">13566</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file users.conf is in an invalid format.  Avoiding.\n&quot;</span>);</div><div class="line"><a name="l13567"></a><span class="lineno">13567</span>&#160;         ucfg = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13568"></a><span class="lineno">13568</span>&#160;      }</div><div class="line"><a name="l13569"></a><span class="lineno">13569</span>&#160;   }</div><div class="line"><a name="l13570"></a><span class="lineno">13570</span>&#160;</div><div class="line"><a name="l13571"></a><span class="lineno">13571</span>&#160;   res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98a361868421e789787246003ce2844f">actual_load_config</a>(reload, cfg, ucfg);</div><div class="line"><a name="l13572"></a><span class="lineno">13572</span>&#160;</div><div class="line"><a name="l13573"></a><span class="lineno">13573</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l13574"></a><span class="lineno">13574</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(ucfg);</div><div class="line"><a name="l13575"></a><span class="lineno">13575</span>&#160;</div><div class="line"><a name="l13576"></a><span class="lineno">13576</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l13577"></a><span class="lineno">13577</span>&#160;}</div><div class="line"><a name="l13578"></a><span class="lineno">13578</span>&#160;</div><div class="line"><a name="l13579"></a><span class="lineno">13579</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l13580"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6e97699b892f61cc208de9f991cfb293">13580</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e97699b892f61cc208de9f991cfb293">load_config_from_memory</a>(<span class="keywordtype">int</span> reload, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *ucfg)</div><div class="line"><a name="l13581"></a><span class="lineno">13581</span>&#160;{</div><div class="line"><a name="l13582"></a><span class="lineno">13582</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>);</div><div class="line"><a name="l13583"></a><span class="lineno">13583</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>);</div><div class="line"><a name="l13584"></a><span class="lineno">13584</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98a361868421e789787246003ce2844f">actual_load_config</a>(reload, cfg, ucfg);</div><div class="line"><a name="l13585"></a><span class="lineno">13585</span>&#160;}</div><div class="line"><a name="l13586"></a><span class="lineno">13586</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13587"></a><span class="lineno">13587</span>&#160;</div><div class="line"><a name="l13588"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a26fee1cad75593ff650106610fa528ae">13588</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a26fee1cad75593ff650106610fa528ae">alias_mailbox_mapping_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line"><a name="l13589"></a><span class="lineno">13589</span>&#160;{</div><div class="line"><a name="l13590"></a><span class="lineno">13590</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *mapping;</div><div class="line"><a name="l13591"></a><span class="lineno">13591</span>&#160;   <span class="keywordtype">size_t</span> from_len = strlen(alias) + 1;</div><div class="line"><a name="l13592"></a><span class="lineno">13592</span>&#160;   <span class="keywordtype">size_t</span> to_len = strlen(mailbox) + 1;</div><div class="line"><a name="l13593"></a><span class="lineno">13593</span>&#160;</div><div class="line"><a name="l13594"></a><span class="lineno">13594</span>&#160;   mapping = <a class="code" href="../../d5/da5/astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*mapping) + from_len + to_len, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13595"></a><span class="lineno">13595</span>&#160;   <span class="keywordflow">if</span> (!mapping) {</div><div class="line"><a name="l13596"></a><span class="lineno">13596</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13597"></a><span class="lineno">13597</span>&#160;   }</div><div class="line"><a name="l13598"></a><span class="lineno">13598</span>&#160;   mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias</a> = mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a103a957b017f6b717767bba130a02694">buf</a>;</div><div class="line"><a name="l13599"></a><span class="lineno">13599</span>&#160;   mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a> = mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a103a957b017f6b717767bba130a02694">buf</a> + from_len;</div><div class="line"><a name="l13600"></a><span class="lineno">13600</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias</a>, alias, from_len); <span class="comment">/* Safe */</span></div><div class="line"><a name="l13601"></a><span class="lineno">13601</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>, mailbox, to_len); <span class="comment">/* Safe */</span></div><div class="line"><a name="l13602"></a><span class="lineno">13602</span>&#160;</div><div class="line"><a name="l13603"></a><span class="lineno">13603</span>&#160;   <span class="keywordflow">return</span> mapping;</div><div class="line"><a name="l13604"></a><span class="lineno">13604</span>&#160;}</div><div class="line"><a name="l13605"></a><span class="lineno">13605</span>&#160;</div><div class="line"><a name="l13606"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#adab3ddaecf532e431905b714748fce1f">13606</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#adab3ddaecf532e431905b714748fce1f">load_aliases</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg)</div><div class="line"><a name="l13607"></a><span class="lineno">13607</span>&#160;{</div><div class="line"><a name="l13608"></a><span class="lineno">13608</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l13609"></a><span class="lineno">13609</span>&#160;</div><div class="line"><a name="l13610"></a><span class="lineno">13610</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(aliasescontext)) {</div><div class="line"><a name="l13611"></a><span class="lineno">13611</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l13612"></a><span class="lineno">13612</span>&#160;   }</div><div class="line"><a name="l13613"></a><span class="lineno">13613</span>&#160;   var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#aef636ed2f3d33f4c7a1ba67eb7c4d052">ast_variable_browse</a>(cfg, aliasescontext);</div><div class="line"><a name="l13614"></a><span class="lineno">13614</span>&#160;   <span class="keywordflow">while</span> (var) {</div><div class="line"><a name="l13615"></a><span class="lineno">13615</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *mapping = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a26fee1cad75593ff650106610fa528ae">alias_mailbox_mapping_create</a>(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);</div><div class="line"><a name="l13616"></a><span class="lineno">13616</span>&#160;      <span class="keywordflow">if</span> (mapping) {</div><div class="line"><a name="l13617"></a><span class="lineno">13617</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#a1ad9f122bcae95a470639402faa3d2ee">ao2_link</a>(alias_mailbox_mappings, mapping);</div><div class="line"><a name="l13618"></a><span class="lineno">13618</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#a1ad9f122bcae95a470639402faa3d2ee">ao2_link</a>(mailbox_alias_mappings, mapping);</div><div class="line"><a name="l13619"></a><span class="lineno">13619</span>&#160;         <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(mapping, -1);</div><div class="line"><a name="l13620"></a><span class="lineno">13620</span>&#160;      }</div><div class="line"><a name="l13621"></a><span class="lineno">13621</span>&#160;      var = var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">next</a>;</div><div class="line"><a name="l13622"></a><span class="lineno">13622</span>&#160;   }</div><div class="line"><a name="l13623"></a><span class="lineno">13623</span>&#160;}</div><div class="line"><a name="l13624"></a><span class="lineno">13624</span>&#160;</div><div class="line"><a name="l13625"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5112d228e43a8e9393b797c45eba9adb">13625</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5112d228e43a8e9393b797c45eba9adb">load_zonemessages</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg)</div><div class="line"><a name="l13626"></a><span class="lineno">13626</span>&#160;{</div><div class="line"><a name="l13627"></a><span class="lineno">13627</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l13628"></a><span class="lineno">13628</span>&#160;</div><div class="line"><a name="l13629"></a><span class="lineno">13629</span>&#160;   var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#aef636ed2f3d33f4c7a1ba67eb7c4d052">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;zonemessages&quot;</span>);</div><div class="line"><a name="l13630"></a><span class="lineno">13630</span>&#160;   <span class="keywordflow">while</span> (var) {</div><div class="line"><a name="l13631"></a><span class="lineno">13631</span>&#160;      <span class="keywordflow">if</span> (var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) {</div><div class="line"><a name="l13632"></a><span class="lineno">13632</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../d7/d13/structvm__zone.html">vm_zone</a> *z;</div><div class="line"><a name="l13633"></a><span class="lineno">13633</span>&#160;         <span class="keywordtype">char</span> *<a class="code" href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">msg_format</a>, *tzone;</div><div class="line"><a name="l13634"></a><span class="lineno">13634</span>&#160;         <span class="keywordtype">char</span> storage[strlen(var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) + 1];</div><div class="line"><a name="l13635"></a><span class="lineno">13635</span>&#160;</div><div class="line"><a name="l13636"></a><span class="lineno">13636</span>&#160;         z = <a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>(<span class="keyword">sizeof</span>(*z));</div><div class="line"><a name="l13637"></a><span class="lineno">13637</span>&#160;         <span class="keywordflow">if</span> (!z) {</div><div class="line"><a name="l13638"></a><span class="lineno">13638</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l13639"></a><span class="lineno">13639</span>&#160;         }</div><div class="line"><a name="l13640"></a><span class="lineno">13640</span>&#160;</div><div class="line"><a name="l13641"></a><span class="lineno">13641</span>&#160;         strcpy(storage, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>); <span class="comment">/* safe */</span></div><div class="line"><a name="l13642"></a><span class="lineno">13642</span>&#160;         msg_format = storage;</div><div class="line"><a name="l13643"></a><span class="lineno">13643</span>&#160;         tzone = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;msg_format, <span class="stringliteral">&quot;|,&quot;</span>);</div><div class="line"><a name="l13644"></a><span class="lineno">13644</span>&#160;         <span class="keywordflow">if</span> (msg_format) {</div><div class="line"><a name="l13645"></a><span class="lineno">13645</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">name</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keyword">sizeof</span>(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">name</a>));</div><div class="line"><a name="l13646"></a><span class="lineno">13646</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>, tzone, <span class="keyword">sizeof</span>(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>));</div><div class="line"><a name="l13647"></a><span class="lineno">13647</span>&#160;            <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">msg_format</a>, msg_format, <span class="keyword">sizeof</span>(z-&gt;<a class="code" href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">msg_format</a>));</div><div class="line"><a name="l13648"></a><span class="lineno">13648</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l13649"></a><span class="lineno">13649</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307">AST_LIST_INSERT_HEAD</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>, z, <a class="code" href="../../d7/d13/structvm__zone.html#a824b6fba3cdf05b72afb1e22ef25a38c">list</a>);</div><div class="line"><a name="l13650"></a><span class="lineno">13650</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d5/dd3/structzones.html">zones</a>);</div><div class="line"><a name="l13651"></a><span class="lineno">13651</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13652"></a><span class="lineno">13652</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid timezone definition at line %d\n&quot;</span>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);</div><div class="line"><a name="l13653"></a><span class="lineno">13653</span>&#160;            <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(z);</div><div class="line"><a name="l13654"></a><span class="lineno">13654</span>&#160;         }</div><div class="line"><a name="l13655"></a><span class="lineno">13655</span>&#160;      }</div><div class="line"><a name="l13656"></a><span class="lineno">13656</span>&#160;      var = var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">next</a>;</div><div class="line"><a name="l13657"></a><span class="lineno">13657</span>&#160;   }</div><div class="line"><a name="l13658"></a><span class="lineno">13658</span>&#160;}</div><div class="line"><a name="l13659"></a><span class="lineno">13659</span>&#160;</div><div class="line"><a name="l13660"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8ee3d871c12c0ea00ab335527784d1ef">13660</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8ee3d871c12c0ea00ab335527784d1ef">load_users</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg)</div><div class="line"><a name="l13661"></a><span class="lineno">13661</span>&#160;{</div><div class="line"><a name="l13662"></a><span class="lineno">13662</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l13663"></a><span class="lineno">13663</span>&#160;   <span class="keywordtype">char</span> *cat = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l13664"></a><span class="lineno">13664</span>&#160;</div><div class="line"><a name="l13665"></a><span class="lineno">13665</span>&#160;   <span class="keywordflow">while</span> ((cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(cfg, cat))) {</div><div class="line"><a name="l13666"></a><span class="lineno">13666</span>&#160;      <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>) == 0</div><div class="line"><a name="l13667"></a><span class="lineno">13667</span>&#160;         || strcasecmp(cat, aliasescontext) == 0</div><div class="line"><a name="l13668"></a><span class="lineno">13668</span>&#160;         || strcasecmp(cat, <span class="stringliteral">&quot;zonemessages&quot;</span>) == 0) {</div><div class="line"><a name="l13669"></a><span class="lineno">13669</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l13670"></a><span class="lineno">13670</span>&#160;      }</div><div class="line"><a name="l13671"></a><span class="lineno">13671</span>&#160;</div><div class="line"><a name="l13672"></a><span class="lineno">13672</span>&#160;      var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#aef636ed2f3d33f4c7a1ba67eb7c4d052">ast_variable_browse</a>(cfg, cat);</div><div class="line"><a name="l13673"></a><span class="lineno">13673</span>&#160;      <span class="keywordflow">while</span> (var) {</div><div class="line"><a name="l13674"></a><span class="lineno">13674</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">append_mailbox</a>(cat, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);</div><div class="line"><a name="l13675"></a><span class="lineno">13675</span>&#160;         var = var-&gt;<a class="code" href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">next</a>;</div><div class="line"><a name="l13676"></a><span class="lineno">13676</span>&#160;      }</div><div class="line"><a name="l13677"></a><span class="lineno">13677</span>&#160;   }</div><div class="line"><a name="l13678"></a><span class="lineno">13678</span>&#160;}</div><div class="line"><a name="l13679"></a><span class="lineno">13679</span>&#160;</div><div class="line"><a name="l13680"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a98a361868421e789787246003ce2844f">13680</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98a361868421e789787246003ce2844f">actual_load_config</a>(<span class="keywordtype">int</span> reload, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *ucfg)</div><div class="line"><a name="l13681"></a><span class="lineno">13681</span>&#160;{</div><div class="line"><a name="l13682"></a><span class="lineno">13682</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *current;</div><div class="line"><a name="l13683"></a><span class="lineno">13683</span>&#160;   <span class="keywordtype">char</span> *cat;</div><div class="line"><a name="l13684"></a><span class="lineno">13684</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/d85/structval.html">val</a>;</div><div class="line"><a name="l13685"></a><span class="lineno">13685</span>&#160;   <span class="keywordtype">char</span> *q, *stringp, *<a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line"><a name="l13686"></a><span class="lineno">13686</span>&#160;   <span class="keywordtype">int</span> x;</div><div class="line"><a name="l13687"></a><span class="lineno">13687</span>&#160;   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tmpadsi[4];</div><div class="line"><a name="l13688"></a><span class="lineno">13688</span>&#160;   <span class="keywordtype">char</span> secretfn[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l13689"></a><span class="lineno">13689</span>&#160;   <span class="keywordtype">long</span> tps_queue_low;</div><div class="line"><a name="l13690"></a><span class="lineno">13690</span>&#160;   <span class="keywordtype">long</span> tps_queue_high;</div><div class="line"><a name="l13691"></a><span class="lineno">13691</span>&#160;</div><div class="line"><a name="l13692"></a><span class="lineno">13692</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13693"></a><span class="lineno">13693</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapparentfolder, <span class="stringliteral">&quot;\0&quot;</span>, <span class="keyword">sizeof</span>(imapparentfolder));</div><div class="line"><a name="l13694"></a><span class="lineno">13694</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13695"></a><span class="lineno">13695</span>&#160;   <span class="comment">/* set audio control prompts */</span></div><div class="line"><a name="l13696"></a><span class="lineno">13696</span>&#160;   strcpy(listen_control_forward_key, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1eb1e0cbaef35879c60c6afd79dcc6af">DEFAULT_LISTEN_CONTROL_FORWARD_KEY</a>);</div><div class="line"><a name="l13697"></a><span class="lineno">13697</span>&#160;   strcpy(listen_control_reverse_key, <a class="code" href="../../dc/df4/app__voicemail_8c.html#adf398fc1e24857033174482891adab4a">DEFAULT_LISTEN_CONTROL_REVERSE_KEY</a>);</div><div class="line"><a name="l13698"></a><span class="lineno">13698</span>&#160;   strcpy(listen_control_pause_key, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aab009b1bd02c3b2580f86581c9fa2c70">DEFAULT_LISTEN_CONTROL_PAUSE_KEY</a>);</div><div class="line"><a name="l13699"></a><span class="lineno">13699</span>&#160;   strcpy(listen_control_restart_key, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a724057a0c369a6b5dd798ccc31cf53f2">DEFAULT_LISTEN_CONTROL_RESTART_KEY</a>);</div><div class="line"><a name="l13700"></a><span class="lineno">13700</span>&#160;   strcpy(listen_control_stop_key, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7decd8d5e42401e22d0d86d150e70a04">DEFAULT_LISTEN_CONTROL_STOP_KEY</a>);</div><div class="line"><a name="l13701"></a><span class="lineno">13701</span>&#160;</div><div class="line"><a name="l13702"></a><span class="lineno">13702</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13703"></a><span class="lineno">13703</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#aa7789090f6f6177b5033d240bba65b93">ast_mwi_state_callback_all</a>(imap_close_subscribed_mailbox, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13704"></a><span class="lineno">13704</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13705"></a><span class="lineno">13705</span>&#160;</div><div class="line"><a name="l13706"></a><span class="lineno">13706</span>&#160;   <span class="comment">/* Free all the users structure */</span></div><div class="line"><a name="l13707"></a><span class="lineno">13707</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101">free_vm_users</a>();</div><div class="line"><a name="l13708"></a><span class="lineno">13708</span>&#160;</div><div class="line"><a name="l13709"></a><span class="lineno">13709</span>&#160;   <span class="comment">/* Free all the zones structure */</span></div><div class="line"><a name="l13710"></a><span class="lineno">13710</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473">free_vm_zones</a>();</div><div class="line"><a name="l13711"></a><span class="lineno">13711</span>&#160;</div><div class="line"><a name="l13712"></a><span class="lineno">13712</span>&#160;   <span class="comment">/* Remove all aliases */</span></div><div class="line"><a name="l13713"></a><span class="lineno">13713</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(alias_mailbox_mappings, <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13714"></a><span class="lineno">13714</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(mailbox_alias_mappings, <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l13715"></a><span class="lineno">13715</span>&#160;</div><div class="line"><a name="l13716"></a><span class="lineno">13716</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l13717"></a><span class="lineno">13717</span>&#160;</div><div class="line"><a name="l13718"></a><span class="lineno">13718</span>&#160;   memset(ext_pass_cmd, 0, <span class="keyword">sizeof</span>(ext_pass_cmd));</div><div class="line"><a name="l13719"></a><span class="lineno">13719</span>&#160;   memset(ext_pass_check_cmd, 0, <span class="keyword">sizeof</span>(ext_pass_check_cmd));</div><div class="line"><a name="l13720"></a><span class="lineno">13720</span>&#160;</div><div class="line"><a name="l13721"></a><span class="lineno">13721</span>&#160;   <span class="keywordflow">if</span> (cfg) {</div><div class="line"><a name="l13722"></a><span class="lineno">13722</span>&#160;      <span class="comment">/* General settings */</span></div><div class="line"><a name="l13723"></a><span class="lineno">13723</span>&#160;</div><div class="line"><a name="l13724"></a><span class="lineno">13724</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;userscontext&quot;</span>)))</div><div class="line"><a name="l13725"></a><span class="lineno">13725</span>&#160;         val = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l13726"></a><span class="lineno">13726</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(userscontext, val, <span class="keyword">sizeof</span>(userscontext));</div><div class="line"><a name="l13727"></a><span class="lineno">13727</span>&#160;</div><div class="line"><a name="l13728"></a><span class="lineno">13728</span>&#160;      aliasescontext[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l13729"></a><span class="lineno">13729</span>&#160;      val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;aliasescontext&quot;</span>);</div><div class="line"><a name="l13730"></a><span class="lineno">13730</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(aliasescontext, <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(val, <span class="stringliteral">&quot;&quot;</span>), <span class="keyword">sizeof</span>(aliasescontext));</div><div class="line"><a name="l13731"></a><span class="lineno">13731</span>&#160;</div><div class="line"><a name="l13732"></a><span class="lineno">13732</span>&#160;      <span class="comment">/* Attach voice message to mail message ? */</span></div><div class="line"><a name="l13733"></a><span class="lineno">13733</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;attach&quot;</span>)))</div><div class="line"><a name="l13734"></a><span class="lineno">13734</span>&#160;         val = <span class="stringliteral">&quot;yes&quot;</span>;</div><div class="line"><a name="l13735"></a><span class="lineno">13735</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);</div><div class="line"><a name="l13736"></a><span class="lineno">13736</span>&#160;</div><div class="line"><a name="l13737"></a><span class="lineno">13737</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;searchcontexts&quot;</span>)))</div><div class="line"><a name="l13738"></a><span class="lineno">13738</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l13739"></a><span class="lineno">13739</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>);</div><div class="line"><a name="l13740"></a><span class="lineno">13740</span>&#160;</div><div class="line"><a name="l13741"></a><span class="lineno">13741</span>&#160;      volgain = 0.0;</div><div class="line"><a name="l13742"></a><span class="lineno">13742</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;volgain&quot;</span>)))</div><div class="line"><a name="l13743"></a><span class="lineno">13743</span>&#160;         sscanf(val, <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;volgain);</div><div class="line"><a name="l13744"></a><span class="lineno">13744</span>&#160;</div><div class="line"><a name="l13745"></a><span class="lineno">13745</span>&#160;<span class="preprocessor">#ifdef ODBC_STORAGE</span></div><div class="line"><a name="l13746"></a><span class="lineno">13746</span>&#160;      strcpy(odbc_database, <span class="stringliteral">&quot;asterisk&quot;</span>);</div><div class="line"><a name="l13747"></a><span class="lineno">13747</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;odbcstorage&quot;</span>))) {</div><div class="line"><a name="l13748"></a><span class="lineno">13748</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(odbc_database, val, <span class="keyword">sizeof</span>(odbc_database));</div><div class="line"><a name="l13749"></a><span class="lineno">13749</span>&#160;      }</div><div class="line"><a name="l13750"></a><span class="lineno">13750</span>&#160;      strcpy(odbc_table, <span class="stringliteral">&quot;voicemessages&quot;</span>);</div><div class="line"><a name="l13751"></a><span class="lineno">13751</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;odbctable&quot;</span>))) {</div><div class="line"><a name="l13752"></a><span class="lineno">13752</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(odbc_table, val, <span class="keyword">sizeof</span>(odbc_table));</div><div class="line"><a name="l13753"></a><span class="lineno">13753</span>&#160;      }</div><div class="line"><a name="l13754"></a><span class="lineno">13754</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13755"></a><span class="lineno">13755</span>&#160;      <span class="comment">/* Mail command */</span></div><div class="line"><a name="l13756"></a><span class="lineno">13756</span>&#160;      strcpy(mailcmd, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a92d8fb2d08cf9220d520ae9691b5e6c4">SENDMAIL</a>);</div><div class="line"><a name="l13757"></a><span class="lineno">13757</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;mailcmd&quot;</span>)))</div><div class="line"><a name="l13758"></a><span class="lineno">13758</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(mailcmd, val, <span class="keyword">sizeof</span>(mailcmd)); <span class="comment">/* User setting */</span></div><div class="line"><a name="l13759"></a><span class="lineno">13759</span>&#160;</div><div class="line"><a name="l13760"></a><span class="lineno">13760</span>&#160;      maxsilence = 0;</div><div class="line"><a name="l13761"></a><span class="lineno">13761</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxsilence&quot;</span>))) {</div><div class="line"><a name="l13762"></a><span class="lineno">13762</span>&#160;         maxsilence = atoi(val);</div><div class="line"><a name="l13763"></a><span class="lineno">13763</span>&#160;         <span class="keywordflow">if</span> (maxsilence &gt; 0)</div><div class="line"><a name="l13764"></a><span class="lineno">13764</span>&#160;            maxsilence *= 1000;</div><div class="line"><a name="l13765"></a><span class="lineno">13765</span>&#160;      }</div><div class="line"><a name="l13766"></a><span class="lineno">13766</span>&#160;</div><div class="line"><a name="l13767"></a><span class="lineno">13767</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxmsg&quot;</span>))) {</div><div class="line"><a name="l13768"></a><span class="lineno">13768</span>&#160;         maxmsg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l13769"></a><span class="lineno">13769</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13770"></a><span class="lineno">13770</span>&#160;         maxmsg = atoi(val);</div><div class="line"><a name="l13771"></a><span class="lineno">13771</span>&#160;         <span class="keywordflow">if</span> (maxmsg &lt; 0) {</div><div class="line"><a name="l13772"></a><span class="lineno">13772</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages per folder &#39;%s&#39;. Using default value %i\n&quot;</span>, val, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);</div><div class="line"><a name="l13773"></a><span class="lineno">13773</span>&#160;            maxmsg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l13774"></a><span class="lineno">13774</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (maxmsg &gt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {</div><div class="line"><a name="l13775"></a><span class="lineno">13775</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of messages per folder is %i. Cannot accept value &#39;%s&#39;\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, val);</div><div class="line"><a name="l13776"></a><span class="lineno">13776</span>&#160;            maxmsg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;</div><div class="line"><a name="l13777"></a><span class="lineno">13777</span>&#160;         }</div><div class="line"><a name="l13778"></a><span class="lineno">13778</span>&#160;      }</div><div class="line"><a name="l13779"></a><span class="lineno">13779</span>&#160;</div><div class="line"><a name="l13780"></a><span class="lineno">13780</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;backupdeleted&quot;</span>))) {</div><div class="line"><a name="l13781"></a><span class="lineno">13781</span>&#160;         maxdeletedmsg = 0;</div><div class="line"><a name="l13782"></a><span class="lineno">13782</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13783"></a><span class="lineno">13783</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1)</div><div class="line"><a name="l13784"></a><span class="lineno">13784</span>&#160;            maxdeletedmsg = x;</div><div class="line"><a name="l13785"></a><span class="lineno">13785</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val))</div><div class="line"><a name="l13786"></a><span class="lineno">13786</span>&#160;            maxdeletedmsg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l13787"></a><span class="lineno">13787</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l13788"></a><span class="lineno">13788</span>&#160;            maxdeletedmsg = 0;</div><div class="line"><a name="l13789"></a><span class="lineno">13789</span>&#160;</div><div class="line"><a name="l13790"></a><span class="lineno">13790</span>&#160;         <span class="keywordflow">if</span> (maxdeletedmsg &lt; 0) {</div><div class="line"><a name="l13791"></a><span class="lineno">13791</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of deleted messages saved per mailbox &#39;%s&#39;. Using default value %i\n&quot;</span>, val, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);</div><div class="line"><a name="l13792"></a><span class="lineno">13792</span>&#160;            maxdeletedmsg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;</div><div class="line"><a name="l13793"></a><span class="lineno">13793</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (maxdeletedmsg &gt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {</div><div class="line"><a name="l13794"></a><span class="lineno">13794</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of deleted messages saved per mailbox is %i. Cannot accept value &#39;%s&#39;\n&quot;</span>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, val);</div><div class="line"><a name="l13795"></a><span class="lineno">13795</span>&#160;            maxdeletedmsg = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;</div><div class="line"><a name="l13796"></a><span class="lineno">13796</span>&#160;         }</div><div class="line"><a name="l13797"></a><span class="lineno">13797</span>&#160;      }</div><div class="line"><a name="l13798"></a><span class="lineno">13798</span>&#160;</div><div class="line"><a name="l13799"></a><span class="lineno">13799</span>&#160;      <span class="comment">/* Load date format config for voicemail mail */</span></div><div class="line"><a name="l13800"></a><span class="lineno">13800</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;emaildateformat&quot;</span>))) {</div><div class="line"><a name="l13801"></a><span class="lineno">13801</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(emaildateformat, val, <span class="keyword">sizeof</span>(emaildateformat));</div><div class="line"><a name="l13802"></a><span class="lineno">13802</span>&#160;      }</div><div class="line"><a name="l13803"></a><span class="lineno">13803</span>&#160;</div><div class="line"><a name="l13804"></a><span class="lineno">13804</span>&#160;      <span class="comment">/* Load date format config for voicemail pager mail */</span></div><div class="line"><a name="l13805"></a><span class="lineno">13805</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagerdateformat&quot;</span>))) {</div><div class="line"><a name="l13806"></a><span class="lineno">13806</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(pagerdateformat, val, <span class="keyword">sizeof</span>(pagerdateformat));</div><div class="line"><a name="l13807"></a><span class="lineno">13807</span>&#160;      }</div><div class="line"><a name="l13808"></a><span class="lineno">13808</span>&#160;</div><div class="line"><a name="l13809"></a><span class="lineno">13809</span>&#160;      <span class="comment">/* External password changing command */</span></div><div class="line"><a name="l13810"></a><span class="lineno">13810</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externpass&quot;</span>))) {</div><div class="line"><a name="l13811"></a><span class="lineno">13811</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(ext_pass_cmd, val, <span class="keyword">sizeof</span>(ext_pass_cmd));</div><div class="line"><a name="l13812"></a><span class="lineno">13812</span>&#160;         pwdchange = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a>;</div><div class="line"><a name="l13813"></a><span class="lineno">13813</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externpassnotify&quot;</span>))) {</div><div class="line"><a name="l13814"></a><span class="lineno">13814</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(ext_pass_cmd, val, <span class="keyword">sizeof</span>(ext_pass_cmd));</div><div class="line"><a name="l13815"></a><span class="lineno">13815</span>&#160;         pwdchange = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a> | <a class="code" href="../../dc/df4/app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>;</div><div class="line"><a name="l13816"></a><span class="lineno">13816</span>&#160;      }</div><div class="line"><a name="l13817"></a><span class="lineno">13817</span>&#160;</div><div class="line"><a name="l13818"></a><span class="lineno">13818</span>&#160;      <span class="comment">/* External password validation command */</span></div><div class="line"><a name="l13819"></a><span class="lineno">13819</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externpasscheck&quot;</span>))) {</div><div class="line"><a name="l13820"></a><span class="lineno">13820</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(ext_pass_check_cmd, val, <span class="keyword">sizeof</span>(ext_pass_check_cmd));</div><div class="line"><a name="l13821"></a><span class="lineno">13821</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;found externpasscheck: %s\n&quot;</span>, ext_pass_check_cmd);</div><div class="line"><a name="l13822"></a><span class="lineno">13822</span>&#160;      }</div><div class="line"><a name="l13823"></a><span class="lineno">13823</span>&#160;</div><div class="line"><a name="l13824"></a><span class="lineno">13824</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l13825"></a><span class="lineno">13825</span>&#160;      <span class="comment">/* IMAP server address */</span></div><div class="line"><a name="l13826"></a><span class="lineno">13826</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapserver&quot;</span>))) {</div><div class="line"><a name="l13827"></a><span class="lineno">13827</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapserver, val, <span class="keyword">sizeof</span>(imapserver));</div><div class="line"><a name="l13828"></a><span class="lineno">13828</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13829"></a><span class="lineno">13829</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapserver, <span class="stringliteral">&quot;localhost&quot;</span>, <span class="keyword">sizeof</span>(imapserver));</div><div class="line"><a name="l13830"></a><span class="lineno">13830</span>&#160;      }</div><div class="line"><a name="l13831"></a><span class="lineno">13831</span>&#160;      <span class="comment">/* IMAP server port */</span></div><div class="line"><a name="l13832"></a><span class="lineno">13832</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapport&quot;</span>))) {</div><div class="line"><a name="l13833"></a><span class="lineno">13833</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapport, val, <span class="keyword">sizeof</span>(imapport));</div><div class="line"><a name="l13834"></a><span class="lineno">13834</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13835"></a><span class="lineno">13835</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapport, <span class="stringliteral">&quot;143&quot;</span>, <span class="keyword">sizeof</span>(imapport));</div><div class="line"><a name="l13836"></a><span class="lineno">13836</span>&#160;      }</div><div class="line"><a name="l13837"></a><span class="lineno">13837</span>&#160;      <span class="comment">/* IMAP server flags */</span></div><div class="line"><a name="l13838"></a><span class="lineno">13838</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapflags&quot;</span>))) {</div><div class="line"><a name="l13839"></a><span class="lineno">13839</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapflags, val, <span class="keyword">sizeof</span>(imapflags));</div><div class="line"><a name="l13840"></a><span class="lineno">13840</span>&#160;      }</div><div class="line"><a name="l13841"></a><span class="lineno">13841</span>&#160;      <span class="comment">/* IMAP server master username */</span></div><div class="line"><a name="l13842"></a><span class="lineno">13842</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;authuser&quot;</span>))) {</div><div class="line"><a name="l13843"></a><span class="lineno">13843</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(authuser, val, <span class="keyword">sizeof</span>(authuser));</div><div class="line"><a name="l13844"></a><span class="lineno">13844</span>&#160;      }</div><div class="line"><a name="l13845"></a><span class="lineno">13845</span>&#160;      <span class="comment">/* IMAP server master password */</span></div><div class="line"><a name="l13846"></a><span class="lineno">13846</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;authpassword&quot;</span>))) {</div><div class="line"><a name="l13847"></a><span class="lineno">13847</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(authpassword, val, <span class="keyword">sizeof</span>(authpassword));</div><div class="line"><a name="l13848"></a><span class="lineno">13848</span>&#160;      }</div><div class="line"><a name="l13849"></a><span class="lineno">13849</span>&#160;      <span class="comment">/* Expunge on exit */</span></div><div class="line"><a name="l13850"></a><span class="lineno">13850</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;expungeonhangup&quot;</span>))) {</div><div class="line"><a name="l13851"></a><span class="lineno">13851</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38">ast_false</a>(val))</div><div class="line"><a name="l13852"></a><span class="lineno">13852</span>&#160;            expungeonhangup = 0;</div><div class="line"><a name="l13853"></a><span class="lineno">13853</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l13854"></a><span class="lineno">13854</span>&#160;            expungeonhangup = 1;</div><div class="line"><a name="l13855"></a><span class="lineno">13855</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13856"></a><span class="lineno">13856</span>&#160;         expungeonhangup = 1;</div><div class="line"><a name="l13857"></a><span class="lineno">13857</span>&#160;      }</div><div class="line"><a name="l13858"></a><span class="lineno">13858</span>&#160;      <span class="comment">/* IMAP voicemail folder */</span></div><div class="line"><a name="l13859"></a><span class="lineno">13859</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapfolder&quot;</span>))) {</div><div class="line"><a name="l13860"></a><span class="lineno">13860</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapfolder, val, <span class="keyword">sizeof</span>(imapfolder));</div><div class="line"><a name="l13861"></a><span class="lineno">13861</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13862"></a><span class="lineno">13862</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapfolder, <span class="stringliteral">&quot;INBOX&quot;</span>, <span class="keyword">sizeof</span>(imapfolder));</div><div class="line"><a name="l13863"></a><span class="lineno">13863</span>&#160;      }</div><div class="line"><a name="l13864"></a><span class="lineno">13864</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapparentfolder&quot;</span>))) {</div><div class="line"><a name="l13865"></a><span class="lineno">13865</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(imapparentfolder, val, <span class="keyword">sizeof</span>(imapparentfolder));</div><div class="line"><a name="l13866"></a><span class="lineno">13866</span>&#160;      }</div><div class="line"><a name="l13867"></a><span class="lineno">13867</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapgreetings&quot;</span>))) {</div><div class="line"><a name="l13868"></a><span class="lineno">13868</span>&#160;         imapgreetings = <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val);</div><div class="line"><a name="l13869"></a><span class="lineno">13869</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13870"></a><span class="lineno">13870</span>&#160;         imapgreetings = 0;</div><div class="line"><a name="l13871"></a><span class="lineno">13871</span>&#160;      }</div><div class="line"><a name="l13872"></a><span class="lineno">13872</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;greetingfolder&quot;</span>))) {</div><div class="line"><a name="l13873"></a><span class="lineno">13873</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(greetingfolder, val, <span class="keyword">sizeof</span>(greetingfolder));</div><div class="line"><a name="l13874"></a><span class="lineno">13874</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;greetingsfolder&quot;</span>))) {</div><div class="line"><a name="l13875"></a><span class="lineno">13875</span>&#160;         <span class="comment">/* Also support greetingsfolder as documented in voicemail.conf.sample */</span></div><div class="line"><a name="l13876"></a><span class="lineno">13876</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(greetingfolder, val, <span class="keyword">sizeof</span>(greetingfolder));</div><div class="line"><a name="l13877"></a><span class="lineno">13877</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13878"></a><span class="lineno">13878</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(greetingfolder, imapfolder, <span class="keyword">sizeof</span>(greetingfolder));</div><div class="line"><a name="l13879"></a><span class="lineno">13879</span>&#160;      }</div><div class="line"><a name="l13880"></a><span class="lineno">13880</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imap_poll_logout&quot;</span>))) {</div><div class="line"><a name="l13881"></a><span class="lineno">13881</span>&#160;         imap_poll_logout = <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val);</div><div class="line"><a name="l13882"></a><span class="lineno">13882</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13883"></a><span class="lineno">13883</span>&#160;         imap_poll_logout = 0;</div><div class="line"><a name="l13884"></a><span class="lineno">13884</span>&#160;      }</div><div class="line"><a name="l13885"></a><span class="lineno">13885</span>&#160;</div><div class="line"><a name="l13886"></a><span class="lineno">13886</span>&#160;      <span class="comment">/* There is some very unorthodox casting done here. This is due</span></div><div class="line"><a name="l13887"></a><span class="lineno">13887</span>&#160;<span class="comment">       * to the way c-client handles the argument passed in. It expects a</span></div><div class="line"><a name="l13888"></a><span class="lineno">13888</span>&#160;<span class="comment">       * void pointer and casts the pointer directly to a long without</span></div><div class="line"><a name="l13889"></a><span class="lineno">13889</span>&#160;<span class="comment">       * first dereferencing it. */</span></div><div class="line"><a name="l13890"></a><span class="lineno">13890</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapreadtimeout&quot;</span>))) {</div><div class="line"><a name="l13891"></a><span class="lineno">13891</span>&#160;         mail_parameters(NIL, SET_READTIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));</div><div class="line"><a name="l13892"></a><span class="lineno">13892</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13893"></a><span class="lineno">13893</span>&#160;         mail_parameters(NIL, SET_READTIMEOUT, (<span class="keywordtype">void</span> *) 60L);</div><div class="line"><a name="l13894"></a><span class="lineno">13894</span>&#160;      }</div><div class="line"><a name="l13895"></a><span class="lineno">13895</span>&#160;</div><div class="line"><a name="l13896"></a><span class="lineno">13896</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapwritetimeout&quot;</span>))) {</div><div class="line"><a name="l13897"></a><span class="lineno">13897</span>&#160;         mail_parameters(NIL, SET_WRITETIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));</div><div class="line"><a name="l13898"></a><span class="lineno">13898</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13899"></a><span class="lineno">13899</span>&#160;         mail_parameters(NIL, SET_WRITETIMEOUT, (<span class="keywordtype">void</span> *) 60L);</div><div class="line"><a name="l13900"></a><span class="lineno">13900</span>&#160;      }</div><div class="line"><a name="l13901"></a><span class="lineno">13901</span>&#160;</div><div class="line"><a name="l13902"></a><span class="lineno">13902</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapopentimeout&quot;</span>))) {</div><div class="line"><a name="l13903"></a><span class="lineno">13903</span>&#160;         mail_parameters(NIL, SET_OPENTIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));</div><div class="line"><a name="l13904"></a><span class="lineno">13904</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13905"></a><span class="lineno">13905</span>&#160;         mail_parameters(NIL, SET_OPENTIMEOUT, (<span class="keywordtype">void</span> *) 60L);</div><div class="line"><a name="l13906"></a><span class="lineno">13906</span>&#160;      }</div><div class="line"><a name="l13907"></a><span class="lineno">13907</span>&#160;</div><div class="line"><a name="l13908"></a><span class="lineno">13908</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapclosetimeout&quot;</span>))) {</div><div class="line"><a name="l13909"></a><span class="lineno">13909</span>&#160;         mail_parameters(NIL, SET_CLOSETIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));</div><div class="line"><a name="l13910"></a><span class="lineno">13910</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13911"></a><span class="lineno">13911</span>&#160;         mail_parameters(NIL, SET_CLOSETIMEOUT, (<span class="keywordtype">void</span> *) 60L);</div><div class="line"><a name="l13912"></a><span class="lineno">13912</span>&#160;      }</div><div class="line"><a name="l13913"></a><span class="lineno">13913</span>&#160;</div><div class="line"><a name="l13914"></a><span class="lineno">13914</span>&#160;      <span class="comment">/* Increment configuration version */</span></div><div class="line"><a name="l13915"></a><span class="lineno">13915</span>&#160;      imapversion++;</div><div class="line"><a name="l13916"></a><span class="lineno">13916</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l13917"></a><span class="lineno">13917</span>&#160;      <span class="comment">/* External voicemail notify application */</span></div><div class="line"><a name="l13918"></a><span class="lineno">13918</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externnotify&quot;</span>))) {</div><div class="line"><a name="l13919"></a><span class="lineno">13919</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(externnotify, val, <span class="keyword">sizeof</span>(externnotify));</div><div class="line"><a name="l13920"></a><span class="lineno">13920</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;found externnotify: %s\n&quot;</span>, externnotify);</div><div class="line"><a name="l13921"></a><span class="lineno">13921</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13922"></a><span class="lineno">13922</span>&#160;         externnotify[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l13923"></a><span class="lineno">13923</span>&#160;      }</div><div class="line"><a name="l13924"></a><span class="lineno">13924</span>&#160;</div><div class="line"><a name="l13925"></a><span class="lineno">13925</span>&#160;      <span class="comment">/* SMDI voicemail notification */</span></div><div class="line"><a name="l13926"></a><span class="lineno">13926</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;smdienable&quot;</span>)) &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val)) {</div><div class="line"><a name="l13927"></a><span class="lineno">13927</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Enabled SMDI voicemail notification\n&quot;</span>);</div><div class="line"><a name="l13928"></a><span class="lineno">13928</span>&#160;         <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;smdiport&quot;</span>))) {</div><div class="line"><a name="l13929"></a><span class="lineno">13929</span>&#160;            smdi_iface = <a class="code" href="../../dc/dca/smdi_8h.html#ac5e5c2f622f22084f67a01e8f12eab8d">ast_smdi_interface_find</a>(val);</div><div class="line"><a name="l13930"></a><span class="lineno">13930</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13931"></a><span class="lineno">13931</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;No SMDI interface set, trying default (/dev/ttyS0)\n&quot;</span>);</div><div class="line"><a name="l13932"></a><span class="lineno">13932</span>&#160;            smdi_iface = <a class="code" href="../../dc/dca/smdi_8h.html#ac5e5c2f622f22084f67a01e8f12eab8d">ast_smdi_interface_find</a>(<span class="stringliteral">&quot;/dev/ttyS0&quot;</span>);</div><div class="line"><a name="l13933"></a><span class="lineno">13933</span>&#160;         }</div><div class="line"><a name="l13934"></a><span class="lineno">13934</span>&#160;         <span class="keywordflow">if</span> (!smdi_iface) {</div><div class="line"><a name="l13935"></a><span class="lineno">13935</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;No valid SMDI interface specfied, disabling SMDI voicemail notification\n&quot;</span>);</div><div class="line"><a name="l13936"></a><span class="lineno">13936</span>&#160;         }</div><div class="line"><a name="l13937"></a><span class="lineno">13937</span>&#160;      }</div><div class="line"><a name="l13938"></a><span class="lineno">13938</span>&#160;</div><div class="line"><a name="l13939"></a><span class="lineno">13939</span>&#160;      <span class="comment">/* Silence treshold */</span></div><div class="line"><a name="l13940"></a><span class="lineno">13940</span>&#160;      silencethreshold = <a class="code" href="../../d3/d08/dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca">ast_dsp_get_threshold_from_settings</a>(<a class="code" href="../../d3/d08/dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a>);</div><div class="line"><a name="l13941"></a><span class="lineno">13941</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;silencethreshold&quot;</span>)))</div><div class="line"><a name="l13942"></a><span class="lineno">13942</span>&#160;         silencethreshold = atoi(val);</div><div class="line"><a name="l13943"></a><span class="lineno">13943</span>&#160;</div><div class="line"><a name="l13944"></a><span class="lineno">13944</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;serveremail&quot;</span>)))</div><div class="line"><a name="l13945"></a><span class="lineno">13945</span>&#160;         val = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5e790f0ee1dbde79705c49bf33a1060d">ASTERISK_USERNAME</a>;</div><div class="line"><a name="l13946"></a><span class="lineno">13946</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(serveremail, val, <span class="keyword">sizeof</span>(serveremail));</div><div class="line"><a name="l13947"></a><span class="lineno">13947</span>&#160;</div><div class="line"><a name="l13948"></a><span class="lineno">13948</span>&#160;      vmmaxsecs = 0;</div><div class="line"><a name="l13949"></a><span class="lineno">13949</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxsecs&quot;</span>))) {</div><div class="line"><a name="l13950"></a><span class="lineno">13950</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l13951"></a><span class="lineno">13951</span>&#160;            vmmaxsecs = x;</div><div class="line"><a name="l13952"></a><span class="lineno">13952</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13953"></a><span class="lineno">13953</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message time length\n&quot;</span>);</div><div class="line"><a name="l13954"></a><span class="lineno">13954</span>&#160;         }</div><div class="line"><a name="l13955"></a><span class="lineno">13955</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxmessage&quot;</span>))) {</div><div class="line"><a name="l13956"></a><span class="lineno">13956</span>&#160;         <span class="keyword">static</span> <span class="keywordtype">int</span> maxmessage_deprecate = 0;</div><div class="line"><a name="l13957"></a><span class="lineno">13957</span>&#160;         <span class="keywordflow">if</span> (maxmessage_deprecate == 0) {</div><div class="line"><a name="l13958"></a><span class="lineno">13958</span>&#160;            maxmessage_deprecate = 1;</div><div class="line"><a name="l13959"></a><span class="lineno">13959</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Setting &#39;maxmessage&#39; has been deprecated in favor of &#39;maxsecs&#39;.\n&quot;</span>);</div><div class="line"><a name="l13960"></a><span class="lineno">13960</span>&#160;         }</div><div class="line"><a name="l13961"></a><span class="lineno">13961</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l13962"></a><span class="lineno">13962</span>&#160;            vmmaxsecs = x;</div><div class="line"><a name="l13963"></a><span class="lineno">13963</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13964"></a><span class="lineno">13964</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message time length\n&quot;</span>);</div><div class="line"><a name="l13965"></a><span class="lineno">13965</span>&#160;         }</div><div class="line"><a name="l13966"></a><span class="lineno">13966</span>&#160;      }</div><div class="line"><a name="l13967"></a><span class="lineno">13967</span>&#160;</div><div class="line"><a name="l13968"></a><span class="lineno">13968</span>&#160;      vmminsecs = 0;</div><div class="line"><a name="l13969"></a><span class="lineno">13969</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;minsecs&quot;</span>))) {</div><div class="line"><a name="l13970"></a><span class="lineno">13970</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l13971"></a><span class="lineno">13971</span>&#160;            vmminsecs = x;</div><div class="line"><a name="l13972"></a><span class="lineno">13972</span>&#160;            <span class="keywordflow">if</span> (maxsilence / 1000 &gt;= vmminsecs) {</div><div class="line"><a name="l13973"></a><span class="lineno">13973</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;maxsilence should be less than minsecs or you may get empty messages\n&quot;</span>);</div><div class="line"><a name="l13974"></a><span class="lineno">13974</span>&#160;            }</div><div class="line"><a name="l13975"></a><span class="lineno">13975</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13976"></a><span class="lineno">13976</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min message time length\n&quot;</span>);</div><div class="line"><a name="l13977"></a><span class="lineno">13977</span>&#160;         }</div><div class="line"><a name="l13978"></a><span class="lineno">13978</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;minmessage&quot;</span>))) {</div><div class="line"><a name="l13979"></a><span class="lineno">13979</span>&#160;         <span class="keyword">static</span> <span class="keywordtype">int</span> maxmessage_deprecate = 0;</div><div class="line"><a name="l13980"></a><span class="lineno">13980</span>&#160;         <span class="keywordflow">if</span> (maxmessage_deprecate == 0) {</div><div class="line"><a name="l13981"></a><span class="lineno">13981</span>&#160;            maxmessage_deprecate = 1;</div><div class="line"><a name="l13982"></a><span class="lineno">13982</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Setting &#39;minmessage&#39; has been deprecated in favor of &#39;minsecs&#39;.\n&quot;</span>);</div><div class="line"><a name="l13983"></a><span class="lineno">13983</span>&#160;         }</div><div class="line"><a name="l13984"></a><span class="lineno">13984</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l13985"></a><span class="lineno">13985</span>&#160;            vmminsecs = x;</div><div class="line"><a name="l13986"></a><span class="lineno">13986</span>&#160;            <span class="keywordflow">if</span> (maxsilence / 1000 &gt;= vmminsecs) {</div><div class="line"><a name="l13987"></a><span class="lineno">13987</span>&#160;               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;maxsilence should be less than minmessage or you may get empty messages\n&quot;</span>);</div><div class="line"><a name="l13988"></a><span class="lineno">13988</span>&#160;            }</div><div class="line"><a name="l13989"></a><span class="lineno">13989</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13990"></a><span class="lineno">13990</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min message time length\n&quot;</span>);</div><div class="line"><a name="l13991"></a><span class="lineno">13991</span>&#160;         }</div><div class="line"><a name="l13992"></a><span class="lineno">13992</span>&#160;      }</div><div class="line"><a name="l13993"></a><span class="lineno">13993</span>&#160;</div><div class="line"><a name="l13994"></a><span class="lineno">13994</span>&#160;      val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;format&quot;</span>);</div><div class="line"><a name="l13995"></a><span class="lineno">13995</span>&#160;      <span class="keywordflow">if</span> (!val) {</div><div class="line"><a name="l13996"></a><span class="lineno">13996</span>&#160;         val = <span class="stringliteral">&quot;wav&quot;</span>;</div><div class="line"><a name="l13997"></a><span class="lineno">13997</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l13998"></a><span class="lineno">13998</span>&#160;         tmp = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(val);</div><div class="line"><a name="l13999"></a><span class="lineno">13999</span>&#160;         val = <a class="code" href="../../d2/d4d/file_8h.html#aa526fd9bb57d7d9afac2113c30d236f8">ast_format_str_reduce</a>(tmp);</div><div class="line"><a name="l14000"></a><span class="lineno">14000</span>&#160;         <span class="keywordflow">if</span> (!val) {</div><div class="line"><a name="l14001"></a><span class="lineno">14001</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error processing format string, defaulting to format &#39;wav&#39;\n&quot;</span>);</div><div class="line"><a name="l14002"></a><span class="lineno">14002</span>&#160;            val = <span class="stringliteral">&quot;wav&quot;</span>;</div><div class="line"><a name="l14003"></a><span class="lineno">14003</span>&#160;         }</div><div class="line"><a name="l14004"></a><span class="lineno">14004</span>&#160;      }</div><div class="line"><a name="l14005"></a><span class="lineno">14005</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmfmts, val, <span class="keyword">sizeof</span>(vmfmts));</div><div class="line"><a name="l14006"></a><span class="lineno">14006</span>&#160;</div><div class="line"><a name="l14007"></a><span class="lineno">14007</span>&#160;      skipms = 3000;</div><div class="line"><a name="l14008"></a><span class="lineno">14008</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxgreet&quot;</span>))) {</div><div class="line"><a name="l14009"></a><span class="lineno">14009</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l14010"></a><span class="lineno">14010</span>&#160;            maxgreet = x;</div><div class="line"><a name="l14011"></a><span class="lineno">14011</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14012"></a><span class="lineno">14012</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message greeting length\n&quot;</span>);</div><div class="line"><a name="l14013"></a><span class="lineno">14013</span>&#160;         }</div><div class="line"><a name="l14014"></a><span class="lineno">14014</span>&#160;      }</div><div class="line"><a name="l14015"></a><span class="lineno">14015</span>&#160;</div><div class="line"><a name="l14016"></a><span class="lineno">14016</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;skipms&quot;</span>))) {</div><div class="line"><a name="l14017"></a><span class="lineno">14017</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l14018"></a><span class="lineno">14018</span>&#160;            skipms = x;</div><div class="line"><a name="l14019"></a><span class="lineno">14019</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14020"></a><span class="lineno">14020</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid skipms value\n&quot;</span>);</div><div class="line"><a name="l14021"></a><span class="lineno">14021</span>&#160;         }</div><div class="line"><a name="l14022"></a><span class="lineno">14022</span>&#160;      }</div><div class="line"><a name="l14023"></a><span class="lineno">14023</span>&#160;</div><div class="line"><a name="l14024"></a><span class="lineno">14024</span>&#160;      maxlogins = 3;</div><div class="line"><a name="l14025"></a><span class="lineno">14025</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxlogins&quot;</span>))) {</div><div class="line"><a name="l14026"></a><span class="lineno">14026</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l14027"></a><span class="lineno">14027</span>&#160;            maxlogins = x;</div><div class="line"><a name="l14028"></a><span class="lineno">14028</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14029"></a><span class="lineno">14029</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max failed login attempts\n&quot;</span>);</div><div class="line"><a name="l14030"></a><span class="lineno">14030</span>&#160;         }</div><div class="line"><a name="l14031"></a><span class="lineno">14031</span>&#160;      }</div><div class="line"><a name="l14032"></a><span class="lineno">14032</span>&#160;</div><div class="line"><a name="l14033"></a><span class="lineno">14033</span>&#160;      minpassword = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aca7150caac3749421acc40d7bc3483f1">MINPASSWORD</a>;</div><div class="line"><a name="l14034"></a><span class="lineno">14034</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;minpassword&quot;</span>))) {</div><div class="line"><a name="l14035"></a><span class="lineno">14035</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l14036"></a><span class="lineno">14036</span>&#160;            minpassword = x;</div><div class="line"><a name="l14037"></a><span class="lineno">14037</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14038"></a><span class="lineno">14038</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid minimum password length.  Default to %d\n&quot;</span>, minpassword);</div><div class="line"><a name="l14039"></a><span class="lineno">14039</span>&#160;         }</div><div class="line"><a name="l14040"></a><span class="lineno">14040</span>&#160;      }</div><div class="line"><a name="l14041"></a><span class="lineno">14041</span>&#160;</div><div class="line"><a name="l14042"></a><span class="lineno">14042</span>&#160;      <span class="comment">/* Force new user to record name ? */</span></div><div class="line"><a name="l14043"></a><span class="lineno">14043</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;forcename&quot;</span>)))</div><div class="line"><a name="l14044"></a><span class="lineno">14044</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14045"></a><span class="lineno">14045</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>);</div><div class="line"><a name="l14046"></a><span class="lineno">14046</span>&#160;</div><div class="line"><a name="l14047"></a><span class="lineno">14047</span>&#160;      <span class="comment">/* Force new user to record greetings ? */</span></div><div class="line"><a name="l14048"></a><span class="lineno">14048</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;forcegreetings&quot;</span>)))</div><div class="line"><a name="l14049"></a><span class="lineno">14049</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14050"></a><span class="lineno">14050</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>);</div><div class="line"><a name="l14051"></a><span class="lineno">14051</span>&#160;</div><div class="line"><a name="l14052"></a><span class="lineno">14052</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;cidinternalcontexts&quot;</span>))) {</div><div class="line"><a name="l14053"></a><span class="lineno">14053</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM_CID Internal context string: %s\n&quot;</span>, val);</div><div class="line"><a name="l14054"></a><span class="lineno">14054</span>&#160;         stringp = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(val);</div><div class="line"><a name="l14055"></a><span class="lineno">14055</span>&#160;         <span class="keywordflow">for</span> (x = 0 ; x &lt; <a class="code" href="../../dc/df4/app__voicemail_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a> ; x++){</div><div class="line"><a name="l14056"></a><span class="lineno">14056</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(stringp)) {</div><div class="line"><a name="l14057"></a><span class="lineno">14057</span>&#160;               q = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l14058"></a><span class="lineno">14058</span>&#160;               <span class="keywordflow">while</span> ((*q == <span class="charliteral">&#39; &#39;</span>)||(*q == <span class="charliteral">&#39;\t&#39;</span>)) <span class="comment">/* Eat white space between contexts */</span></div><div class="line"><a name="l14059"></a><span class="lineno">14059</span>&#160;                  q++;</div><div class="line"><a name="l14060"></a><span class="lineno">14060</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(cidinternalcontexts[x], q, <span class="keyword">sizeof</span>(cidinternalcontexts[x]));</div><div class="line"><a name="l14061"></a><span class="lineno">14061</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM_CID Internal context %d: %s\n&quot;</span>, x, cidinternalcontexts[x]);</div><div class="line"><a name="l14062"></a><span class="lineno">14062</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14063"></a><span class="lineno">14063</span>&#160;               cidinternalcontexts[x][0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l14064"></a><span class="lineno">14064</span>&#160;            }</div><div class="line"><a name="l14065"></a><span class="lineno">14065</span>&#160;         }</div><div class="line"><a name="l14066"></a><span class="lineno">14066</span>&#160;      }</div><div class="line"><a name="l14067"></a><span class="lineno">14067</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;review&quot;</span>))){</div><div class="line"><a name="l14068"></a><span class="lineno">14068</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM Review Option disabled globally\n&quot;</span>);</div><div class="line"><a name="l14069"></a><span class="lineno">14069</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14070"></a><span class="lineno">14070</span>&#160;      }</div><div class="line"><a name="l14071"></a><span class="lineno">14071</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>);</div><div class="line"><a name="l14072"></a><span class="lineno">14072</span>&#160;</div><div class="line"><a name="l14073"></a><span class="lineno">14073</span>&#160;      <span class="comment">/* Temporary greeting reminder */</span></div><div class="line"><a name="l14074"></a><span class="lineno">14074</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tempgreetwarn&quot;</span>))) {</div><div class="line"><a name="l14075"></a><span class="lineno">14075</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM Temporary Greeting Reminder Option disabled globally\n&quot;</span>);</div><div class="line"><a name="l14076"></a><span class="lineno">14076</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14077"></a><span class="lineno">14077</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14078"></a><span class="lineno">14078</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM Temporary Greeting Reminder Option enabled globally\n&quot;</span>);</div><div class="line"><a name="l14079"></a><span class="lineno">14079</span>&#160;      }</div><div class="line"><a name="l14080"></a><span class="lineno">14080</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>);</div><div class="line"><a name="l14081"></a><span class="lineno">14081</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;messagewrap&quot;</span>))){</div><div class="line"><a name="l14082"></a><span class="lineno">14082</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM next message wrap disabled globally\n&quot;</span>);</div><div class="line"><a name="l14083"></a><span class="lineno">14083</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14084"></a><span class="lineno">14084</span>&#160;      }</div><div class="line"><a name="l14085"></a><span class="lineno">14085</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>);</div><div class="line"><a name="l14086"></a><span class="lineno">14086</span>&#160;</div><div class="line"><a name="l14087"></a><span class="lineno">14087</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;operator&quot;</span>))){</div><div class="line"><a name="l14088"></a><span class="lineno">14088</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM Operator break disabled globally\n&quot;</span>);</div><div class="line"><a name="l14089"></a><span class="lineno">14089</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14090"></a><span class="lineno">14090</span>&#160;      }</div><div class="line"><a name="l14091"></a><span class="lineno">14091</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>);</div><div class="line"><a name="l14092"></a><span class="lineno">14092</span>&#160;</div><div class="line"><a name="l14093"></a><span class="lineno">14093</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;saycid&quot;</span>))) {</div><div class="line"><a name="l14094"></a><span class="lineno">14094</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;VM CID Info before msg disabled globally\n&quot;</span>);</div><div class="line"><a name="l14095"></a><span class="lineno">14095</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14096"></a><span class="lineno">14096</span>&#160;      }</div><div class="line"><a name="l14097"></a><span class="lineno">14097</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>);</div><div class="line"><a name="l14098"></a><span class="lineno">14098</span>&#160;</div><div class="line"><a name="l14099"></a><span class="lineno">14099</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;sendvoicemail&quot;</span>))){</div><div class="line"><a name="l14100"></a><span class="lineno">14100</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Send Voicemail msg disabled globally\n&quot;</span>);</div><div class="line"><a name="l14101"></a><span class="lineno">14101</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14102"></a><span class="lineno">14102</span>&#160;      }</div><div class="line"><a name="l14103"></a><span class="lineno">14103</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>);</div><div class="line"><a name="l14104"></a><span class="lineno">14104</span>&#160;</div><div class="line"><a name="l14105"></a><span class="lineno">14105</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;envelope&quot;</span>))) {</div><div class="line"><a name="l14106"></a><span class="lineno">14106</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;ENVELOPE before msg enabled globally\n&quot;</span>);</div><div class="line"><a name="l14107"></a><span class="lineno">14107</span>&#160;         val = <span class="stringliteral">&quot;yes&quot;</span>;</div><div class="line"><a name="l14108"></a><span class="lineno">14108</span>&#160;      }</div><div class="line"><a name="l14109"></a><span class="lineno">14109</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>);</div><div class="line"><a name="l14110"></a><span class="lineno">14110</span>&#160;</div><div class="line"><a name="l14111"></a><span class="lineno">14111</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;moveheard&quot;</span>))) {</div><div class="line"><a name="l14112"></a><span class="lineno">14112</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Move Heard enabled globally\n&quot;</span>);</div><div class="line"><a name="l14113"></a><span class="lineno">14113</span>&#160;         val = <span class="stringliteral">&quot;yes&quot;</span>;</div><div class="line"><a name="l14114"></a><span class="lineno">14114</span>&#160;      }</div><div class="line"><a name="l14115"></a><span class="lineno">14115</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>);</div><div class="line"><a name="l14116"></a><span class="lineno">14116</span>&#160;</div><div class="line"><a name="l14117"></a><span class="lineno">14117</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;forward_urgent_auto&quot;</span>))) {</div><div class="line"><a name="l14118"></a><span class="lineno">14118</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Autoset of Urgent flag on forwarded Urgent messages disabled globally\n&quot;</span>);</div><div class="line"><a name="l14119"></a><span class="lineno">14119</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14120"></a><span class="lineno">14120</span>&#160;      }</div><div class="line"><a name="l14121"></a><span class="lineno">14121</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">VM_FWDURGAUTO</a>);</div><div class="line"><a name="l14122"></a><span class="lineno">14122</span>&#160;</div><div class="line"><a name="l14123"></a><span class="lineno">14123</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;sayduration&quot;</span>))) {</div><div class="line"><a name="l14124"></a><span class="lineno">14124</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Duration info before msg enabled globally\n&quot;</span>);</div><div class="line"><a name="l14125"></a><span class="lineno">14125</span>&#160;         val = <span class="stringliteral">&quot;yes&quot;</span>;</div><div class="line"><a name="l14126"></a><span class="lineno">14126</span>&#160;      }</div><div class="line"><a name="l14127"></a><span class="lineno">14127</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>);</div><div class="line"><a name="l14128"></a><span class="lineno">14128</span>&#160;</div><div class="line"><a name="l14129"></a><span class="lineno">14129</span>&#160;      saydurationminfo = 2;</div><div class="line"><a name="l14130"></a><span class="lineno">14130</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;saydurationm&quot;</span>))) {</div><div class="line"><a name="l14131"></a><span class="lineno">14131</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {</div><div class="line"><a name="l14132"></a><span class="lineno">14132</span>&#160;            saydurationminfo = x;</div><div class="line"><a name="l14133"></a><span class="lineno">14133</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14134"></a><span class="lineno">14134</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min duration for say duration\n&quot;</span>);</div><div class="line"><a name="l14135"></a><span class="lineno">14135</span>&#160;         }</div><div class="line"><a name="l14136"></a><span class="lineno">14136</span>&#160;      }</div><div class="line"><a name="l14137"></a><span class="lineno">14137</span>&#160;</div><div class="line"><a name="l14138"></a><span class="lineno">14138</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;nextaftercmd&quot;</span>))) {</div><div class="line"><a name="l14139"></a><span class="lineno">14139</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;We are not going to skip to the next msg after save/delete\n&quot;</span>);</div><div class="line"><a name="l14140"></a><span class="lineno">14140</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14141"></a><span class="lineno">14141</span>&#160;      }</div><div class="line"><a name="l14142"></a><span class="lineno">14142</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>);</div><div class="line"><a name="l14143"></a><span class="lineno">14143</span>&#160;</div><div class="line"><a name="l14144"></a><span class="lineno">14144</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dialout&quot;</span>))) {</div><div class="line"><a name="l14145"></a><span class="lineno">14145</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(dialcontext, val, <span class="keyword">sizeof</span>(dialcontext));</div><div class="line"><a name="l14146"></a><span class="lineno">14146</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;found dialout context: %s\n&quot;</span>, dialcontext);</div><div class="line"><a name="l14147"></a><span class="lineno">14147</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14148"></a><span class="lineno">14148</span>&#160;         dialcontext[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l14149"></a><span class="lineno">14149</span>&#160;      }</div><div class="line"><a name="l14150"></a><span class="lineno">14150</span>&#160;</div><div class="line"><a name="l14151"></a><span class="lineno">14151</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;callback&quot;</span>))) {</div><div class="line"><a name="l14152"></a><span class="lineno">14152</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(callcontext, val, <span class="keyword">sizeof</span>(callcontext));</div><div class="line"><a name="l14153"></a><span class="lineno">14153</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;found callback context: %s\n&quot;</span>, callcontext);</div><div class="line"><a name="l14154"></a><span class="lineno">14154</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14155"></a><span class="lineno">14155</span>&#160;         callcontext[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l14156"></a><span class="lineno">14156</span>&#160;      }</div><div class="line"><a name="l14157"></a><span class="lineno">14157</span>&#160;</div><div class="line"><a name="l14158"></a><span class="lineno">14158</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;exitcontext&quot;</span>))) {</div><div class="line"><a name="l14159"></a><span class="lineno">14159</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(exitcontext, val, <span class="keyword">sizeof</span>(exitcontext));</div><div class="line"><a name="l14160"></a><span class="lineno">14160</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;found operator context: %s\n&quot;</span>, exitcontext);</div><div class="line"><a name="l14161"></a><span class="lineno">14161</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14162"></a><span class="lineno">14162</span>&#160;         exitcontext[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l14163"></a><span class="lineno">14163</span>&#160;      }</div><div class="line"><a name="l14164"></a><span class="lineno">14164</span>&#160;</div><div class="line"><a name="l14165"></a><span class="lineno">14165</span>&#160;      <span class="comment">/* load password sounds configuration */</span></div><div class="line"><a name="l14166"></a><span class="lineno">14166</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-login&quot;</span>)))</div><div class="line"><a name="l14167"></a><span class="lineno">14167</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_login, val, <span class="keyword">sizeof</span>(vm_login));</div><div class="line"><a name="l14168"></a><span class="lineno">14168</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-newuser&quot;</span>)))</div><div class="line"><a name="l14169"></a><span class="lineno">14169</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_newuser, val, <span class="keyword">sizeof</span>(vm_newuser));</div><div class="line"><a name="l14170"></a><span class="lineno">14170</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-password&quot;</span>)))</div><div class="line"><a name="l14171"></a><span class="lineno">14171</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_password, val, <span class="keyword">sizeof</span>(vm_password));</div><div class="line"><a name="l14172"></a><span class="lineno">14172</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-newpassword&quot;</span>)))</div><div class="line"><a name="l14173"></a><span class="lineno">14173</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_newpassword, val, <span class="keyword">sizeof</span>(vm_newpassword));</div><div class="line"><a name="l14174"></a><span class="lineno">14174</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-invalid-password&quot;</span>)))</div><div class="line"><a name="l14175"></a><span class="lineno">14175</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_invalid_password, val, <span class="keyword">sizeof</span>(vm_invalid_password));</div><div class="line"><a name="l14176"></a><span class="lineno">14176</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-passchanged&quot;</span>)))</div><div class="line"><a name="l14177"></a><span class="lineno">14177</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_passchanged, val, <span class="keyword">sizeof</span>(vm_passchanged));</div><div class="line"><a name="l14178"></a><span class="lineno">14178</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-reenterpassword&quot;</span>)))</div><div class="line"><a name="l14179"></a><span class="lineno">14179</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_reenterpassword, val, <span class="keyword">sizeof</span>(vm_reenterpassword));</div><div class="line"><a name="l14180"></a><span class="lineno">14180</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-mismatch&quot;</span>)))</div><div class="line"><a name="l14181"></a><span class="lineno">14181</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_mismatch, val, <span class="keyword">sizeof</span>(vm_mismatch));</div><div class="line"><a name="l14182"></a><span class="lineno">14182</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-pls-try-again&quot;</span>))) {</div><div class="line"><a name="l14183"></a><span class="lineno">14183</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_pls_try_again, val, <span class="keyword">sizeof</span>(vm_pls_try_again));</div><div class="line"><a name="l14184"></a><span class="lineno">14184</span>&#160;      }</div><div class="line"><a name="l14185"></a><span class="lineno">14185</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-prepend-timeout&quot;</span>))) {</div><div class="line"><a name="l14186"></a><span class="lineno">14186</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vm_prepend_timeout, val, <span class="keyword">sizeof</span>(vm_prepend_timeout));</div><div class="line"><a name="l14187"></a><span class="lineno">14187</span>&#160;      }</div><div class="line"><a name="l14188"></a><span class="lineno">14188</span>&#160;      <span class="comment">/* load configurable audio prompts */</span></div><div class="line"><a name="l14189"></a><span class="lineno">14189</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-forward-key&quot;</span>)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(val))</div><div class="line"><a name="l14190"></a><span class="lineno">14190</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(listen_control_forward_key, val, <span class="keyword">sizeof</span>(listen_control_forward_key));</div><div class="line"><a name="l14191"></a><span class="lineno">14191</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-reverse-key&quot;</span>)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(val))</div><div class="line"><a name="l14192"></a><span class="lineno">14192</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(listen_control_reverse_key, val, <span class="keyword">sizeof</span>(listen_control_reverse_key));</div><div class="line"><a name="l14193"></a><span class="lineno">14193</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-pause-key&quot;</span>)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(val))</div><div class="line"><a name="l14194"></a><span class="lineno">14194</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(listen_control_pause_key, val, <span class="keyword">sizeof</span>(listen_control_pause_key));</div><div class="line"><a name="l14195"></a><span class="lineno">14195</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-restart-key&quot;</span>)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(val))</div><div class="line"><a name="l14196"></a><span class="lineno">14196</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(listen_control_restart_key, val, <span class="keyword">sizeof</span>(listen_control_restart_key));</div><div class="line"><a name="l14197"></a><span class="lineno">14197</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-stop-key&quot;</span>)) &amp;&amp; <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a>(val))</div><div class="line"><a name="l14198"></a><span class="lineno">14198</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(listen_control_stop_key, val, <span class="keyword">sizeof</span>(listen_control_stop_key));</div><div class="line"><a name="l14199"></a><span class="lineno">14199</span>&#160;</div><div class="line"><a name="l14200"></a><span class="lineno">14200</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;usedirectory&quot;</span>)))</div><div class="line"><a name="l14201"></a><span class="lineno">14201</span>&#160;         val = <span class="stringliteral">&quot;no&quot;</span>;</div><div class="line"><a name="l14202"></a><span class="lineno">14202</span>&#160;      <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a>);</div><div class="line"><a name="l14203"></a><span class="lineno">14203</span>&#160;</div><div class="line"><a name="l14204"></a><span class="lineno">14204</span>&#160;      <span class="keywordflow">if</span> (!(val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;passwordlocation&quot;</span>))) {</div><div class="line"><a name="l14205"></a><span class="lineno">14205</span>&#160;         val = <span class="stringliteral">&quot;voicemail.conf&quot;</span>;</div><div class="line"><a name="l14206"></a><span class="lineno">14206</span>&#160;      }</div><div class="line"><a name="l14207"></a><span class="lineno">14207</span>&#160;      <span class="keywordflow">if</span> (!(strcmp(val, <span class="stringliteral">&quot;spooldir&quot;</span>))) {</div><div class="line"><a name="l14208"></a><span class="lineno">14208</span>&#160;         passwordlocation = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>;</div><div class="line"><a name="l14209"></a><span class="lineno">14209</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14210"></a><span class="lineno">14210</span>&#160;         passwordlocation = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">OPT_PWLOC_VOICEMAILCONF</a>;</div><div class="line"><a name="l14211"></a><span class="lineno">14211</span>&#160;      }</div><div class="line"><a name="l14212"></a><span class="lineno">14212</span>&#160;</div><div class="line"><a name="l14213"></a><span class="lineno">14213</span>&#160;      poll_freq = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">DEFAULT_POLL_FREQ</a>;</div><div class="line"><a name="l14214"></a><span class="lineno">14214</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pollfreq&quot;</span>))) {</div><div class="line"><a name="l14215"></a><span class="lineno">14215</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;poll_freq) != 1) {</div><div class="line"><a name="l14216"></a><span class="lineno">14216</span>&#160;            poll_freq = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">DEFAULT_POLL_FREQ</a>;</div><div class="line"><a name="l14217"></a><span class="lineno">14217</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;&#39;%s&#39; is not a valid value for the pollfreq option!\n&quot;</span>, val);</div><div class="line"><a name="l14218"></a><span class="lineno">14218</span>&#160;         }</div><div class="line"><a name="l14219"></a><span class="lineno">14219</span>&#160;      }</div><div class="line"><a name="l14220"></a><span class="lineno">14220</span>&#160;</div><div class="line"><a name="l14221"></a><span class="lineno">14221</span>&#160;      poll_mailboxes = 0;</div><div class="line"><a name="l14222"></a><span class="lineno">14222</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pollmailboxes&quot;</span>)))</div><div class="line"><a name="l14223"></a><span class="lineno">14223</span>&#160;         poll_mailboxes = <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val);</div><div class="line"><a name="l14224"></a><span class="lineno">14224</span>&#160;</div><div class="line"><a name="l14225"></a><span class="lineno">14225</span>&#160;      memset(fromstring, 0, <span class="keyword">sizeof</span>(fromstring));</div><div class="line"><a name="l14226"></a><span class="lineno">14226</span>&#160;      memset(pagerfromstring, 0, <span class="keyword">sizeof</span>(pagerfromstring));</div><div class="line"><a name="l14227"></a><span class="lineno">14227</span>&#160;      strcpy(charset, <span class="stringliteral">&quot;ISO-8859-1&quot;</span>);</div><div class="line"><a name="l14228"></a><span class="lineno">14228</span>&#160;      <span class="keywordflow">if</span> (emailbody) {</div><div class="line"><a name="l14229"></a><span class="lineno">14229</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(emailbody);</div><div class="line"><a name="l14230"></a><span class="lineno">14230</span>&#160;         emailbody = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14231"></a><span class="lineno">14231</span>&#160;      }</div><div class="line"><a name="l14232"></a><span class="lineno">14232</span>&#160;      <span class="keywordflow">if</span> (emailsubject) {</div><div class="line"><a name="l14233"></a><span class="lineno">14233</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(emailsubject);</div><div class="line"><a name="l14234"></a><span class="lineno">14234</span>&#160;         emailsubject = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14235"></a><span class="lineno">14235</span>&#160;      }</div><div class="line"><a name="l14236"></a><span class="lineno">14236</span>&#160;      <span class="keywordflow">if</span> (pagerbody) {</div><div class="line"><a name="l14237"></a><span class="lineno">14237</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pagerbody);</div><div class="line"><a name="l14238"></a><span class="lineno">14238</span>&#160;         pagerbody = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14239"></a><span class="lineno">14239</span>&#160;      }</div><div class="line"><a name="l14240"></a><span class="lineno">14240</span>&#160;      <span class="keywordflow">if</span> (pagersubject) {</div><div class="line"><a name="l14241"></a><span class="lineno">14241</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pagersubject);</div><div class="line"><a name="l14242"></a><span class="lineno">14242</span>&#160;         pagersubject = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14243"></a><span class="lineno">14243</span>&#160;      }</div><div class="line"><a name="l14244"></a><span class="lineno">14244</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pbxskip&quot;</span>)))</div><div class="line"><a name="l14245"></a><span class="lineno">14245</span>&#160;         <a class="code" href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(val), <a class="code" href="../../dc/df4/app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">VM_PBXSKIP</a>);</div><div class="line"><a name="l14246"></a><span class="lineno">14246</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;fromstring&quot;</span>)))</div><div class="line"><a name="l14247"></a><span class="lineno">14247</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(fromstring, val, <span class="keyword">sizeof</span>(fromstring));</div><div class="line"><a name="l14248"></a><span class="lineno">14248</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagerfromstring&quot;</span>)))</div><div class="line"><a name="l14249"></a><span class="lineno">14249</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(pagerfromstring, val, <span class="keyword">sizeof</span>(pagerfromstring));</div><div class="line"><a name="l14250"></a><span class="lineno">14250</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;charset&quot;</span>)))</div><div class="line"><a name="l14251"></a><span class="lineno">14251</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(charset, val, <span class="keyword">sizeof</span>(charset));</div><div class="line"><a name="l14252"></a><span class="lineno">14252</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;adsifdn&quot;</span>))) {</div><div class="line"><a name="l14253"></a><span class="lineno">14253</span>&#160;         sscanf(val, <span class="stringliteral">&quot;%2x%2x%2x%2x&quot;</span>, &amp;tmpadsi[0], &amp;tmpadsi[1], &amp;tmpadsi[2], &amp;tmpadsi[3]);</div><div class="line"><a name="l14254"></a><span class="lineno">14254</span>&#160;         <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++) {</div><div class="line"><a name="l14255"></a><span class="lineno">14255</span>&#160;            memcpy(&amp;adsifdn[x], &amp;tmpadsi[x], 1);</div><div class="line"><a name="l14256"></a><span class="lineno">14256</span>&#160;         }</div><div class="line"><a name="l14257"></a><span class="lineno">14257</span>&#160;      }</div><div class="line"><a name="l14258"></a><span class="lineno">14258</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;adsisec&quot;</span>))) {</div><div class="line"><a name="l14259"></a><span class="lineno">14259</span>&#160;         sscanf(val, <span class="stringliteral">&quot;%2x%2x%2x%2x&quot;</span>, &amp;tmpadsi[0], &amp;tmpadsi[1], &amp;tmpadsi[2], &amp;tmpadsi[3]);</div><div class="line"><a name="l14260"></a><span class="lineno">14260</span>&#160;         <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++) {</div><div class="line"><a name="l14261"></a><span class="lineno">14261</span>&#160;            memcpy(&amp;adsisec[x], &amp;tmpadsi[x], 1);</div><div class="line"><a name="l14262"></a><span class="lineno">14262</span>&#160;         }</div><div class="line"><a name="l14263"></a><span class="lineno">14263</span>&#160;      }</div><div class="line"><a name="l14264"></a><span class="lineno">14264</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;adsiver&quot;</span>))) {</div><div class="line"><a name="l14265"></a><span class="lineno">14265</span>&#160;         <span class="keywordflow">if</span> (atoi(val)) {</div><div class="line"><a name="l14266"></a><span class="lineno">14266</span>&#160;            adsiver = atoi(val);</div><div class="line"><a name="l14267"></a><span class="lineno">14267</span>&#160;         }</div><div class="line"><a name="l14268"></a><span class="lineno">14268</span>&#160;      }</div><div class="line"><a name="l14269"></a><span class="lineno">14269</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tz&quot;</span>))) {</div><div class="line"><a name="l14270"></a><span class="lineno">14270</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(zonetag, val, <span class="keyword">sizeof</span>(zonetag));</div><div class="line"><a name="l14271"></a><span class="lineno">14271</span>&#160;      }</div><div class="line"><a name="l14272"></a><span class="lineno">14272</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;locale&quot;</span>))) {</div><div class="line"><a name="l14273"></a><span class="lineno">14273</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(locale, val, <span class="keyword">sizeof</span>(locale));</div><div class="line"><a name="l14274"></a><span class="lineno">14274</span>&#160;      }</div><div class="line"><a name="l14275"></a><span class="lineno">14275</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;emailsubject&quot;</span>))) {</div><div class="line"><a name="l14276"></a><span class="lineno">14276</span>&#160;         emailsubject = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(val));</div><div class="line"><a name="l14277"></a><span class="lineno">14277</span>&#160;      }</div><div class="line"><a name="l14278"></a><span class="lineno">14278</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;emailbody&quot;</span>))) {</div><div class="line"><a name="l14279"></a><span class="lineno">14279</span>&#160;         emailbody = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(val));</div><div class="line"><a name="l14280"></a><span class="lineno">14280</span>&#160;      }</div><div class="line"><a name="l14281"></a><span class="lineno">14281</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagersubject&quot;</span>))) {</div><div class="line"><a name="l14282"></a><span class="lineno">14282</span>&#160;         pagersubject = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(val));</div><div class="line"><a name="l14283"></a><span class="lineno">14283</span>&#160;      }</div><div class="line"><a name="l14284"></a><span class="lineno">14284</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagerbody&quot;</span>))) {</div><div class="line"><a name="l14285"></a><span class="lineno">14285</span>&#160;         pagerbody = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a>(val));</div><div class="line"><a name="l14286"></a><span class="lineno">14286</span>&#160;      }</div><div class="line"><a name="l14287"></a><span class="lineno">14287</span>&#160;</div><div class="line"><a name="l14288"></a><span class="lineno">14288</span>&#160;      tps_queue_high = <a class="code" href="../../d0/d1e/taskprocessor_8h.html#ad4a3db2b08877779bd481a649318be7d">AST_TASKPROCESSOR_HIGH_WATER_LEVEL</a>;</div><div class="line"><a name="l14289"></a><span class="lineno">14289</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tps_queue_high&quot;</span>))) {</div><div class="line"><a name="l14290"></a><span class="lineno">14290</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;tps_queue_high) != 1 || tps_queue_high &lt;= 0) {</div><div class="line"><a name="l14291"></a><span class="lineno">14291</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid the taskprocessor high water alert trigger level &#39;%s&#39;\n&quot;</span>, val);</div><div class="line"><a name="l14292"></a><span class="lineno">14292</span>&#160;            tps_queue_high = <a class="code" href="../../d0/d1e/taskprocessor_8h.html#ad4a3db2b08877779bd481a649318be7d">AST_TASKPROCESSOR_HIGH_WATER_LEVEL</a>;</div><div class="line"><a name="l14293"></a><span class="lineno">14293</span>&#160;         }</div><div class="line"><a name="l14294"></a><span class="lineno">14294</span>&#160;      }</div><div class="line"><a name="l14295"></a><span class="lineno">14295</span>&#160;      tps_queue_low = -1;</div><div class="line"><a name="l14296"></a><span class="lineno">14296</span>&#160;      <span class="keywordflow">if</span> ((val = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tps_queue_low&quot;</span>))) {</div><div class="line"><a name="l14297"></a><span class="lineno">14297</span>&#160;         <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;tps_queue_low) != 1 ||</div><div class="line"><a name="l14298"></a><span class="lineno">14298</span>&#160;            tps_queue_low &lt; -1 || tps_queue_high &lt; tps_queue_low) {</div><div class="line"><a name="l14299"></a><span class="lineno">14299</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid the taskprocessor low water clear alert level &#39;%s&#39;\n&quot;</span>, val);</div><div class="line"><a name="l14300"></a><span class="lineno">14300</span>&#160;            tps_queue_low = -1;</div><div class="line"><a name="l14301"></a><span class="lineno">14301</span>&#160;         }</div><div class="line"><a name="l14302"></a><span class="lineno">14302</span>&#160;      }</div><div class="line"><a name="l14303"></a><span class="lineno">14303</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1e/taskprocessor_8h.html#ad4d9150df7126ae11064d38c755d0813">ast_taskprocessor_alert_set_levels</a>(mwi_subscription_tps, tps_queue_low, tps_queue_high)) {</div><div class="line"><a name="l14304"></a><span class="lineno">14304</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to set alert levels for voicemail taskprocessor.\n&quot;</span>);</div><div class="line"><a name="l14305"></a><span class="lineno">14305</span>&#160;      }</div><div class="line"><a name="l14306"></a><span class="lineno">14306</span>&#160;</div><div class="line"><a name="l14307"></a><span class="lineno">14307</span>&#160;      <span class="comment">/* load mailboxes from users.conf */</span></div><div class="line"><a name="l14308"></a><span class="lineno">14308</span>&#160;      <span class="keywordflow">if</span> (ucfg) {</div><div class="line"><a name="l14309"></a><span class="lineno">14309</span>&#160;         <span class="keywordflow">for</span> (cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(ucfg, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); cat ; cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a>(ucfg, cat)) {</div><div class="line"><a name="l14310"></a><span class="lineno">14310</span>&#160;            <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {</div><div class="line"><a name="l14311"></a><span class="lineno">14311</span>&#160;               <span class="keywordflow">continue</span>;</div><div class="line"><a name="l14312"></a><span class="lineno">14312</span>&#160;            }</div><div class="line"><a name="l14313"></a><span class="lineno">14313</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a>(<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#ad9fd2625614158b152434e45acf1d78b">ast_config_option</a>(ucfg, cat, <span class="stringliteral">&quot;hasvoicemail&quot;</span>)))</div><div class="line"><a name="l14314"></a><span class="lineno">14314</span>&#160;               <span class="keywordflow">continue</span>;</div><div class="line"><a name="l14315"></a><span class="lineno">14315</span>&#160;            <span class="keywordflow">if</span> ((current = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(userscontext, cat))) {</div><div class="line"><a name="l14316"></a><span class="lineno">14316</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(current);</div><div class="line"><a name="l14317"></a><span class="lineno">14317</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f">apply_options_full</a>(current, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#aef636ed2f3d33f4c7a1ba67eb7c4d052">ast_variable_browse</a>(ucfg, cat));</div><div class="line"><a name="l14318"></a><span class="lineno">14318</span>&#160;               <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, userscontext, <span class="keyword">sizeof</span>(current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>));</div><div class="line"><a name="l14319"></a><span class="lineno">14319</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>) &amp;&amp; current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a> == <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">OPT_PWLOC_VOICEMAILCONF</a>) {</div><div class="line"><a name="l14320"></a><span class="lineno">14320</span>&#160;                  current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53a4ea71034662c0e0c184ccfbd68c9e519">OPT_PWLOC_USERSCONF</a>;</div><div class="line"><a name="l14321"></a><span class="lineno">14321</span>&#160;               }</div><div class="line"><a name="l14322"></a><span class="lineno">14322</span>&#160;</div><div class="line"><a name="l14323"></a><span class="lineno">14323</span>&#160;               <span class="keywordflow">switch</span> (current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a>) {</div><div class="line"><a name="l14324"></a><span class="lineno">14324</span>&#160;               <span class="keywordflow">case</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a>:</div><div class="line"><a name="l14325"></a><span class="lineno">14325</span>&#160;                  snprintf(secretfn, <span class="keyword">sizeof</span>(secretfn), <span class="stringliteral">&quot;%s%s/%s/secret.conf&quot;</span>, VM_SPOOL_DIR, current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>);</div><div class="line"><a name="l14326"></a><span class="lineno">14326</span>&#160;                  <a class="code" href="../../dc/df4/app__voicemail_8c.html#a27203edbc5e249fcac868c0488271b29">read_password_from_file</a>(secretfn, current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, <span class="keyword">sizeof</span>(current-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l14327"></a><span class="lineno">14327</span>&#160;               }</div><div class="line"><a name="l14328"></a><span class="lineno">14328</span>&#160;            }</div><div class="line"><a name="l14329"></a><span class="lineno">14329</span>&#160;         }</div><div class="line"><a name="l14330"></a><span class="lineno">14330</span>&#160;      }</div><div class="line"><a name="l14331"></a><span class="lineno">14331</span>&#160;</div><div class="line"><a name="l14332"></a><span class="lineno">14332</span>&#160;      <span class="comment">/* load mailboxes from voicemail.conf */</span></div><div class="line"><a name="l14333"></a><span class="lineno">14333</span>&#160;</div><div class="line"><a name="l14334"></a><span class="lineno">14334</span>&#160;      <span class="comment">/*</span></div><div class="line"><a name="l14335"></a><span class="lineno">14335</span>&#160;<span class="comment">       * Aliases must be loaded before users or the aliases won&#39;t be notified</span></div><div class="line"><a name="l14336"></a><span class="lineno">14336</span>&#160;<span class="comment">       * if there&#39;s existing voicemail in the user mailbox.</span></div><div class="line"><a name="l14337"></a><span class="lineno">14337</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l14338"></a><span class="lineno">14338</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#adab3ddaecf532e431905b714748fce1f">load_aliases</a>(cfg);</div><div class="line"><a name="l14339"></a><span class="lineno">14339</span>&#160;</div><div class="line"><a name="l14340"></a><span class="lineno">14340</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5112d228e43a8e9393b797c45eba9adb">load_zonemessages</a>(cfg);</div><div class="line"><a name="l14341"></a><span class="lineno">14341</span>&#160;</div><div class="line"><a name="l14342"></a><span class="lineno">14342</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8ee3d871c12c0ea00ab335527784d1ef">load_users</a>(cfg);</div><div class="line"><a name="l14343"></a><span class="lineno">14343</span>&#160;</div><div class="line"><a name="l14344"></a><span class="lineno">14344</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l14345"></a><span class="lineno">14345</span>&#160;</div><div class="line"><a name="l14346"></a><span class="lineno">14346</span>&#160;      <span class="keywordflow">if</span> (poll_mailboxes &amp;&amp; poll_thread == <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)</div><div class="line"><a name="l14347"></a><span class="lineno">14347</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">start_poll_thread</a>();</div><div class="line"><a name="l14348"></a><span class="lineno">14348</span>&#160;      <span class="keywordflow">if</span> (!poll_mailboxes &amp;&amp; poll_thread != <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)</div><div class="line"><a name="l14349"></a><span class="lineno">14349</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a>();;</div><div class="line"><a name="l14350"></a><span class="lineno">14350</span>&#160;</div><div class="line"><a name="l14351"></a><span class="lineno">14351</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l14352"></a><span class="lineno">14352</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14353"></a><span class="lineno">14353</span>&#160;      <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l14354"></a><span class="lineno">14354</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to load configuration file.\n&quot;</span>);</div><div class="line"><a name="l14355"></a><span class="lineno">14355</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l14356"></a><span class="lineno">14356</span>&#160;   }</div><div class="line"><a name="l14357"></a><span class="lineno">14357</span>&#160;}</div><div class="line"><a name="l14358"></a><span class="lineno">14358</span>&#160;</div><div class="line"><a name="l14359"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">14359</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context)</div><div class="line"><a name="l14360"></a><span class="lineno">14360</span>&#160;{</div><div class="line"><a name="l14361"></a><span class="lineno">14361</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l14362"></a><span class="lineno">14362</span>&#160;   <span class="keywordtype">char</span> dir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l14363"></a><span class="lineno">14363</span>&#160;   snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, context, mailbox);</div><div class="line"><a name="l14364"></a><span class="lineno">14364</span>&#160;   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(2, <span class="stringliteral">&quot;About to try retrieving name file %s\n&quot;</span>, dir);</div><div class="line"><a name="l14365"></a><span class="lineno">14365</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(dir, -1, mailbox, context);</div><div class="line"><a name="l14366"></a><span class="lineno">14366</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(dir, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l14367"></a><span class="lineno">14367</span>&#160;      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, dir, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);</div><div class="line"><a name="l14368"></a><span class="lineno">14368</span>&#160;   }</div><div class="line"><a name="l14369"></a><span class="lineno">14369</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(dir, -1);</div><div class="line"><a name="l14370"></a><span class="lineno">14370</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14371"></a><span class="lineno">14371</span>&#160;}</div><div class="line"><a name="l14372"></a><span class="lineno">14372</span>&#160;<span class="comment"></span></div><div class="line"><a name="l14373"></a><span class="lineno">14373</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l14374"></a><span class="lineno">14374</span>&#160;<span class="comment"> * \internal</span></div><div class="line"><a name="l14375"></a><span class="lineno">14375</span>&#160;<span class="comment"> * \brief Play a recorded user name for the mailbox to the specified channel.</span></div><div class="line"><a name="l14376"></a><span class="lineno">14376</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l14377"></a><span class="lineno">14377</span>&#160;<span class="comment"> * \param chan Where to play the recorded name file.</span></div><div class="line"><a name="l14378"></a><span class="lineno">14378</span>&#160;<span class="comment"> * \param mailbox_id The mailbox name.</span></div><div class="line"><a name="l14379"></a><span class="lineno">14379</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l14380"></a><span class="lineno">14380</span>&#160;<span class="comment"> * \retval 0 Name played without interruption</span></div><div class="line"><a name="l14381"></a><span class="lineno">14381</span>&#160;<span class="comment"> * \retval dtmf ASCII value of the DTMF which interrupted playback.</span></div><div class="line"><a name="l14382"></a><span class="lineno">14382</span>&#160;<span class="comment"> * \retval -1 Unable to locate mailbox or hangup occurred.</span></div><div class="line"><a name="l14383"></a><span class="lineno">14383</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l14384"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6f391f861982d42d13e6c08e00207abb">14384</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f391f861982d42d13e6c08e00207abb">vm_sayname</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id)</div><div class="line"><a name="l14385"></a><span class="lineno">14385</span>&#160;{</div><div class="line"><a name="l14386"></a><span class="lineno">14386</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l14387"></a><span class="lineno">14387</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l14388"></a><span class="lineno">14388</span>&#160;</div><div class="line"><a name="l14389"></a><span class="lineno">14389</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox_id)</div><div class="line"><a name="l14390"></a><span class="lineno">14390</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(mailbox_id), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l14391"></a><span class="lineno">14391</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l14392"></a><span class="lineno">14392</span>&#160;   }</div><div class="line"><a name="l14393"></a><span class="lineno">14393</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a>(chan, mailbox, context);</div><div class="line"><a name="l14394"></a><span class="lineno">14394</span>&#160;}</div><div class="line"><a name="l14395"></a><span class="lineno">14395</span>&#160;</div><div class="line"><a name="l14396"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a27203edbc5e249fcac868c0488271b29">14396</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a27203edbc5e249fcac868c0488271b29">read_password_from_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *secretfn, <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>, <span class="keywordtype">int</span> passwordlen) {</div><div class="line"><a name="l14397"></a><span class="lineno">14397</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *pwconf;</div><div class="line"><a name="l14398"></a><span class="lineno">14398</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { 0 };</div><div class="line"><a name="l14399"></a><span class="lineno">14399</span>&#160;</div><div class="line"><a name="l14400"></a><span class="lineno">14400</span>&#160;   pwconf = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(secretfn, config_flags);</div><div class="line"><a name="l14401"></a><span class="lineno">14401</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(pwconf)) {</div><div class="line"><a name="l14402"></a><span class="lineno">14402</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/d85/structval.html">val</a> = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(pwconf, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;password&quot;</span>);</div><div class="line"><a name="l14403"></a><span class="lineno">14403</span>&#160;      <span class="keywordflow">if</span> (val) {</div><div class="line"><a name="l14404"></a><span class="lineno">14404</span>&#160;         <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(password, val, passwordlen);</div><div class="line"><a name="l14405"></a><span class="lineno">14405</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(pwconf);</div><div class="line"><a name="l14406"></a><span class="lineno">14406</span>&#160;         <span class="keywordflow">return</span>;</div><div class="line"><a name="l14407"></a><span class="lineno">14407</span>&#160;      }</div><div class="line"><a name="l14408"></a><span class="lineno">14408</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(pwconf);</div><div class="line"><a name="l14409"></a><span class="lineno">14409</span>&#160;   }</div><div class="line"><a name="l14410"></a><span class="lineno">14410</span>&#160;   <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Failed reading voicemail password from %s, using secret from config file\n&quot;</span>, secretfn);</div><div class="line"><a name="l14411"></a><span class="lineno">14411</span>&#160;}</div><div class="line"><a name="l14412"></a><span class="lineno">14412</span>&#160;</div><div class="line"><a name="l14413"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a616064b374d2f44d6fdab04f8509b138">14413</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a616064b374d2f44d6fdab04f8509b138">write_password_to_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *secretfn, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a>) {</div><div class="line"><a name="l14414"></a><span class="lineno">14414</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *<a class="code" href="../../d6/de8/structconf.html">conf</a>;</div><div class="line"><a name="l14415"></a><span class="lineno">14415</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d7/db2/structast__category.html">ast_category</a> *cat;</div><div class="line"><a name="l14416"></a><span class="lineno">14416</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d02/structast__variable.html">ast_variable</a> *<a class="code" href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;</div><div class="line"><a name="l14417"></a><span class="lineno">14417</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l14418"></a><span class="lineno">14418</span>&#160;</div><div class="line"><a name="l14419"></a><span class="lineno">14419</span>&#160;   <span class="keywordflow">if</span> (!(conf = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a3aac6b809a257df6ea7c3d2a9d22b9f5">ast_config_new</a>())) {</div><div class="line"><a name="l14420"></a><span class="lineno">14420</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error creating new config structure\n&quot;</span>);</div><div class="line"><a name="l14421"></a><span class="lineno">14421</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14422"></a><span class="lineno">14422</span>&#160;   }</div><div class="line"><a name="l14423"></a><span class="lineno">14423</span>&#160;   <span class="keywordflow">if</span> (!(cat = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a662135d8d43ad08325882645dc5f8df3">ast_category_new</a>(<span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 1))) {</div><div class="line"><a name="l14424"></a><span class="lineno">14424</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error creating new category structure\n&quot;</span>);</div><div class="line"><a name="l14425"></a><span class="lineno">14425</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(conf);</div><div class="line"><a name="l14426"></a><span class="lineno">14426</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14427"></a><span class="lineno">14427</span>&#160;   }</div><div class="line"><a name="l14428"></a><span class="lineno">14428</span>&#160;   <span class="keywordflow">if</span> (!(var = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66581086d34dfe7ea86b0644bacef239">ast_variable_new</a>(<span class="stringliteral">&quot;password&quot;</span>, password, <span class="stringliteral">&quot;&quot;</span>))) {</div><div class="line"><a name="l14429"></a><span class="lineno">14429</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error creating new variable structure\n&quot;</span>);</div><div class="line"><a name="l14430"></a><span class="lineno">14430</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(conf);</div><div class="line"><a name="l14431"></a><span class="lineno">14431</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a94ba5ab9fffe6dd755ee95db7ff2432f">ast_category_destroy</a>(cat);</div><div class="line"><a name="l14432"></a><span class="lineno">14432</span>&#160;      <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14433"></a><span class="lineno">14433</span>&#160;   }</div><div class="line"><a name="l14434"></a><span class="lineno">14434</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#aa422e1cc73c1ac4db7ed8cd1a0e36e1a">ast_category_append</a>(conf, cat);</div><div class="line"><a name="l14435"></a><span class="lineno">14435</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a57a3200e5b440d7135eaf0450ea559fe">ast_variable_append</a>(cat, var);</div><div class="line"><a name="l14436"></a><span class="lineno">14436</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(secretfn, conf, <span class="stringliteral">&quot;app_voicemail&quot;</span>)) {</div><div class="line"><a name="l14437"></a><span class="lineno">14437</span>&#160;      res = 0;</div><div class="line"><a name="l14438"></a><span class="lineno">14438</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14439"></a><span class="lineno">14439</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error writing voicemail password to %s\n&quot;</span>, secretfn);</div><div class="line"><a name="l14440"></a><span class="lineno">14440</span>&#160;   }</div><div class="line"><a name="l14441"></a><span class="lineno">14441</span>&#160;</div><div class="line"><a name="l14442"></a><span class="lineno">14442</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(conf);</div><div class="line"><a name="l14443"></a><span class="lineno">14443</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14444"></a><span class="lineno">14444</span>&#160;}</div><div class="line"><a name="l14445"></a><span class="lineno">14445</span>&#160;</div><div class="line"><a name="l14446"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6a1f2d69e0b6037e9ecd403ec97c0867">14446</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6a1f2d69e0b6037e9ecd403ec97c0867">vmsayname_exec</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line"><a name="l14447"></a><span class="lineno">14447</span>&#160;{</div><div class="line"><a name="l14448"></a><span class="lineno">14448</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l14449"></a><span class="lineno">14449</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>;</div><div class="line"><a name="l14450"></a><span class="lineno">14450</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l14451"></a><span class="lineno">14451</span>&#160;</div><div class="line"><a name="l14452"></a><span class="lineno">14452</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(data)</div><div class="line"><a name="l14453"></a><span class="lineno">14453</span>&#160;      || <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a>(<a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(data), &amp;mailbox, &amp;context)) {</div><div class="line"><a name="l14454"></a><span class="lineno">14454</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;VMSayName requires argument mailbox@context\n&quot;</span>);</div><div class="line"><a name="l14455"></a><span class="lineno">14455</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l14456"></a><span class="lineno">14456</span>&#160;   }</div><div class="line"><a name="l14457"></a><span class="lineno">14457</span>&#160;</div><div class="line"><a name="l14458"></a><span class="lineno">14458</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a>(chan, mailbox, context)) &lt; 0) {</div><div class="line"><a name="l14459"></a><span class="lineno">14459</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(3, <span class="stringliteral">&quot;Greeting not found for &#39;%s@%s&#39;, falling back to mailbox number.\n&quot;</span>, mailbox, context);</div><div class="line"><a name="l14460"></a><span class="lineno">14460</span>&#160;      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-extension&quot;</span>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);</div><div class="line"><a name="l14461"></a><span class="lineno">14461</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l14462"></a><span class="lineno">14462</span>&#160;         res = <a class="code" href="../../db/dce/say_8h.html#a65e01efc9619fe3156d3f04068f99612">ast_say_character_str</a>(chan, mailbox, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan), <a class="code" href="../../db/dce/say_8h.html#ab73ba7bbfc3824448a2cd4f0c6d050c6ade020c4d50637c2dd5eeb9dc7905a04f">AST_SAY_CASE_NONE</a>);</div><div class="line"><a name="l14463"></a><span class="lineno">14463</span>&#160;      }</div><div class="line"><a name="l14464"></a><span class="lineno">14464</span>&#160;   }</div><div class="line"><a name="l14465"></a><span class="lineno">14465</span>&#160;</div><div class="line"><a name="l14466"></a><span class="lineno">14466</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14467"></a><span class="lineno">14467</span>&#160;}</div><div class="line"><a name="l14468"></a><span class="lineno">14468</span>&#160;</div><div class="line"><a name="l14469"></a><span class="lineno">14469</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l14470"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a6482df0b3a3887ad75f789f701d296da">14470</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6482df0b3a3887ad75f789f701d296da">fake_write</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *frame)</div><div class="line"><a name="l14471"></a><span class="lineno">14471</span>&#160;{</div><div class="line"><a name="l14472"></a><span class="lineno">14472</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l14473"></a><span class="lineno">14473</span>&#160;}</div><div class="line"><a name="l14474"></a><span class="lineno">14474</span>&#160;</div><div class="line"><a name="l14475"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4828365cfe2e6c17f8c6371761cdb990">14475</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a4828365cfe2e6c17f8c6371761cdb990">fake_read</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *ast)</div><div class="line"><a name="l14476"></a><span class="lineno">14476</span>&#160;{</div><div class="line"><a name="l14477"></a><span class="lineno">14477</span>&#160;   <span class="keywordflow">return</span> &amp;<a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;</div><div class="line"><a name="l14478"></a><span class="lineno">14478</span>&#160;}</div><div class="line"><a name="l14479"></a><span class="lineno">14479</span>&#160;</div><div class="line"><a name="l14480"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a49e81fc21b91b32575867b31e925e0e4">14480</a></span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a>(test_voicemail_vmsayname)</div><div class="line"><a name="l14481"></a><span class="lineno">14481</span>&#160;{</div><div class="line"><a name="l14482"></a><span class="lineno">14482</span>&#160;   <span class="keywordtype">char</span> dir[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l14483"></a><span class="lineno">14483</span>&#160;   <span class="keywordtype">char</span> dir2[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l14484"></a><span class="lineno">14484</span>&#160;   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d9/d7a/test__message_8c.html#ab8bcb9d3707a8934e7e925895847b0f6">TEST_CONTEXT</a>[] = <span class="stringliteral">&quot;very_long_unique_context_so_that_nobody_will_ever_have_the_same_one_configured_3141592653&quot;</span>;</div><div class="line"><a name="l14485"></a><span class="lineno">14485</span>&#160;   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d9/d7a/test__message_8c.html#a1fcdae79eb8b5dba56f672c597d577ae">TEST_EXTENSION</a>[] = <span class="stringliteral">&quot;1234&quot;</span>;</div><div class="line"><a name="l14486"></a><span class="lineno">14486</span>&#160;</div><div class="line"><a name="l14487"></a><span class="lineno">14487</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *test_channel1 = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14488"></a><span class="lineno">14488</span>&#160;   <span class="keywordtype">int</span> res = -1;</div><div class="line"><a name="l14489"></a><span class="lineno">14489</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d8/d69/structast__format__cap.html">ast_format_cap</a> *capabilities;</div><div class="line"><a name="l14490"></a><span class="lineno">14490</span>&#160;</div><div class="line"><a name="l14491"></a><span class="lineno">14491</span>&#160;   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d4/d85/structast__channel__tech.html">ast_channel_tech</a> fake_tech = {</div><div class="line"><a name="l14492"></a><span class="lineno">14492</span>&#160;      .<a class="code" href="../../d4/d85/structast__channel__tech.html#a00128f99123ef7844d506e8939bb1786">write</a> = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6482df0b3a3887ad75f789f701d296da">fake_write</a>,</div><div class="line"><a name="l14493"></a><span class="lineno">14493</span>&#160;      .read = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4828365cfe2e6c17f8c6371761cdb990">fake_read</a>,</div><div class="line"><a name="l14494"></a><span class="lineno">14494</span>&#160;   };</div><div class="line"><a name="l14495"></a><span class="lineno">14495</span>&#160;</div><div class="line"><a name="l14496"></a><span class="lineno">14496</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l14497"></a><span class="lineno">14497</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a>:</div><div class="line"><a name="l14498"></a><span class="lineno">14498</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;name = <span class="stringliteral">&quot;vmsayname_exec&quot;</span>;</div><div class="line"><a name="l14499"></a><span class="lineno">14499</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;category = <span class="stringliteral">&quot;/apps/app_voicemail/&quot;</span>;</div><div class="line"><a name="l14500"></a><span class="lineno">14500</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;summary = <span class="stringliteral">&quot;Vmsayname unit test&quot;</span>;</div><div class="line"><a name="l14501"></a><span class="lineno">14501</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;description =</div><div class="line"><a name="l14502"></a><span class="lineno">14502</span>&#160;         <span class="stringliteral">&quot;This tests passing various parameters to vmsayname&quot;</span>;</div><div class="line"><a name="l14503"></a><span class="lineno">14503</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14504"></a><span class="lineno">14504</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a>:</div><div class="line"><a name="l14505"></a><span class="lineno">14505</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l14506"></a><span class="lineno">14506</span>&#160;   }</div><div class="line"><a name="l14507"></a><span class="lineno">14507</span>&#160;</div><div class="line"><a name="l14508"></a><span class="lineno">14508</span>&#160;   <span class="keywordflow">if</span> (!(test_channel1 = <a class="code" href="../../d5/d7b/channel_8h.html#a2f18aafad0442206e71033ac6676dbb5">ast_channel_alloc</a>(0, <a class="code" href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line"><a name="l14509"></a><span class="lineno">14509</span>&#160;        <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, <span class="stringliteral">&quot;TestChannel1&quot;</span>))) {</div><div class="line"><a name="l14510"></a><span class="lineno">14510</span>&#160;      <span class="keywordflow">goto</span> exit_vmsayname_test;</div><div class="line"><a name="l14511"></a><span class="lineno">14511</span>&#160;   }</div><div class="line"><a name="l14512"></a><span class="lineno">14512</span>&#160;</div><div class="line"><a name="l14513"></a><span class="lineno">14513</span>&#160;   <span class="comment">/* normally this is done in the channel driver */</span></div><div class="line"><a name="l14514"></a><span class="lineno">14514</span>&#160;   capabilities = <a class="code" href="../../d0/d3c/format__cap_8h.html#aeb38ee3bdc8594745a707c0927146fdb">ast_format_cap_alloc</a>(<a class="code" href="../../d0/d3c/format__cap_8h.html#a51f3293ae7b01a8353bf4aa1204abba5ad111d20686641a6f0fc5efd33c82e97a">AST_FORMAT_CAP_FLAG_DEFAULT</a>);</div><div class="line"><a name="l14515"></a><span class="lineno">14515</span>&#160;   <span class="keywordflow">if</span> (!capabilities) {</div><div class="line"><a name="l14516"></a><span class="lineno">14516</span>&#160;      <span class="keywordflow">goto</span> exit_vmsayname_test;</div><div class="line"><a name="l14517"></a><span class="lineno">14517</span>&#160;   }</div><div class="line"><a name="l14518"></a><span class="lineno">14518</span>&#160;   <a class="code" href="../../d0/d3c/format__cap_8h.html#ab4d69f2179ed5ca138c9b3d85334217f">ast_format_cap_append</a>(capabilities, <a class="code" href="../../db/d1c/format__cache_8h.html#a3c4c5f669f55befda69aa08699545ec7">ast_format_gsm</a>, 0);</div><div class="line"><a name="l14519"></a><span class="lineno">14519</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#a3c9c29fb2bc2b715fee335c1ffa50449">ast_channel_nativeformats_set</a>(test_channel1, capabilities);</div><div class="line"><a name="l14520"></a><span class="lineno">14520</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(capabilities, -1);</div><div class="line"><a name="l14521"></a><span class="lineno">14521</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#afac6d7d115c1edfe3ad8a8c7fa5d59d1">ast_channel_set_writeformat</a>(test_channel1, <a class="code" href="../../db/d1c/format__cache_8h.html#a3c4c5f669f55befda69aa08699545ec7">ast_format_gsm</a>);</div><div class="line"><a name="l14522"></a><span class="lineno">14522</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#aa2df58e77751b741b6891afe210b5b8c">ast_channel_set_rawwriteformat</a>(test_channel1, <a class="code" href="../../db/d1c/format__cache_8h.html#a3c4c5f669f55befda69aa08699545ec7">ast_format_gsm</a>);</div><div class="line"><a name="l14523"></a><span class="lineno">14523</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#ab3786cbbff7a03241fc75dafa0c8a1c1">ast_channel_set_readformat</a>(test_channel1, <a class="code" href="../../db/d1c/format__cache_8h.html#a3c4c5f669f55befda69aa08699545ec7">ast_format_gsm</a>);</div><div class="line"><a name="l14524"></a><span class="lineno">14524</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#a921a2d48faa9ed99a59d33e7aefa7888">ast_channel_set_rawreadformat</a>(test_channel1, <a class="code" href="../../db/d1c/format__cache_8h.html#a3c4c5f669f55befda69aa08699545ec7">ast_format_gsm</a>);</div><div class="line"><a name="l14525"></a><span class="lineno">14525</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#af0566a4937a5bb1323825e4ef89c0e5a">ast_channel_tech_set</a>(test_channel1, &amp;fake_tech);</div><div class="line"><a name="l14526"></a><span class="lineno">14526</span>&#160;</div><div class="line"><a name="l14527"></a><span class="lineno">14527</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#af476c537b29be3f29240489032f9db39">ast_channel_unlock</a>(test_channel1);</div><div class="line"><a name="l14528"></a><span class="lineno">14528</span>&#160;</div><div class="line"><a name="l14529"></a><span class="lineno">14529</span>&#160;   <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Test playing of extension when greeting is not available...\n&quot;</span>);</div><div class="line"><a name="l14530"></a><span class="lineno">14530</span>&#160;   snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s@%s&quot;</span>, TEST_EXTENSION, TEST_CONTEXT); <span class="comment">/* not a dir, don&#39;t get confused */</span></div><div class="line"><a name="l14531"></a><span class="lineno">14531</span>&#160;   <span class="keywordflow">if</span> (!(res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6a1f2d69e0b6037e9ecd403ec97c0867">vmsayname_exec</a>(test_channel1, dir))) {</div><div class="line"><a name="l14532"></a><span class="lineno">14532</span>&#160;      snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, VM_SPOOL_DIR, TEST_CONTEXT, TEST_EXTENSION);</div><div class="line"><a name="l14533"></a><span class="lineno">14533</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(dir, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l14534"></a><span class="lineno">14534</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;This should not happen, most likely means clean up from previous test failed\n&quot;</span>);</div><div class="line"><a name="l14535"></a><span class="lineno">14535</span>&#160;         res = -1;</div><div class="line"><a name="l14536"></a><span class="lineno">14536</span>&#160;         <span class="keywordflow">goto</span> exit_vmsayname_test;</div><div class="line"><a name="l14537"></a><span class="lineno">14537</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14538"></a><span class="lineno">14538</span>&#160;         <span class="comment">/* no greeting already exists as expected, let&#39;s create one to fully test sayname */</span></div><div class="line"><a name="l14539"></a><span class="lineno">14539</span>&#160;         <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(dir, <span class="keyword">sizeof</span>(dir), TEST_CONTEXT, TEST_EXTENSION, <span class="stringliteral">&quot;&quot;</span>))) {</div><div class="line"><a name="l14540"></a><span class="lineno">14540</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to make test directory\n&quot;</span>);</div><div class="line"><a name="l14541"></a><span class="lineno">14541</span>&#160;            <span class="keywordflow">goto</span> exit_vmsayname_test;</div><div class="line"><a name="l14542"></a><span class="lineno">14542</span>&#160;         }</div><div class="line"><a name="l14543"></a><span class="lineno">14543</span>&#160;         snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s/sounds/beep.gsm&quot;</span>, <a class="code" href="../../dd/df2/paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>);</div><div class="line"><a name="l14544"></a><span class="lineno">14544</span>&#160;         snprintf(dir2, <span class="keyword">sizeof</span>(dir2), <span class="stringliteral">&quot;%s%s/%s/greet.gsm&quot;</span>, VM_SPOOL_DIR, TEST_CONTEXT, TEST_EXTENSION);</div><div class="line"><a name="l14545"></a><span class="lineno">14545</span>&#160;         <span class="comment">/* we&#39;re not going to hear the sound anyway, just use a valid gsm audio file */</span></div><div class="line"><a name="l14546"></a><span class="lineno">14546</span>&#160;         <span class="keywordflow">if</span> ((res = symlink(dir, dir2))) {</div><div class="line"><a name="l14547"></a><span class="lineno">14547</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Symlink reported %s\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l14548"></a><span class="lineno">14548</span>&#160;            <span class="keywordflow">goto</span> exit_vmsayname_test;</div><div class="line"><a name="l14549"></a><span class="lineno">14549</span>&#160;         }</div><div class="line"><a name="l14550"></a><span class="lineno">14550</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Test playing created mailbox greeting...\n&quot;</span>);</div><div class="line"><a name="l14551"></a><span class="lineno">14551</span>&#160;         snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s@%s&quot;</span>, TEST_EXTENSION, TEST_CONTEXT); <span class="comment">/* not a dir, don&#39;t get confused */</span></div><div class="line"><a name="l14552"></a><span class="lineno">14552</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6a1f2d69e0b6037e9ecd403ec97c0867">vmsayname_exec</a>(test_channel1, dir);</div><div class="line"><a name="l14553"></a><span class="lineno">14553</span>&#160;</div><div class="line"><a name="l14554"></a><span class="lineno">14554</span>&#160;         <span class="comment">/* TODO: there may be a better way to do this */</span></div><div class="line"><a name="l14555"></a><span class="lineno">14555</span>&#160;         unlink(dir2);</div><div class="line"><a name="l14556"></a><span class="lineno">14556</span>&#160;         snprintf(dir2, <span class="keyword">sizeof</span>(dir2), <span class="stringliteral">&quot;%s%s/%s&quot;</span>, VM_SPOOL_DIR, TEST_CONTEXT, TEST_EXTENSION);</div><div class="line"><a name="l14557"></a><span class="lineno">14557</span>&#160;         rmdir(dir2);</div><div class="line"><a name="l14558"></a><span class="lineno">14558</span>&#160;         snprintf(dir2, <span class="keyword">sizeof</span>(dir2), <span class="stringliteral">&quot;%s%s&quot;</span>, VM_SPOOL_DIR, TEST_CONTEXT);</div><div class="line"><a name="l14559"></a><span class="lineno">14559</span>&#160;         rmdir(dir2);</div><div class="line"><a name="l14560"></a><span class="lineno">14560</span>&#160;      }</div><div class="line"><a name="l14561"></a><span class="lineno">14561</span>&#160;   }</div><div class="line"><a name="l14562"></a><span class="lineno">14562</span>&#160;</div><div class="line"><a name="l14563"></a><span class="lineno">14563</span>&#160;exit_vmsayname_test:</div><div class="line"><a name="l14564"></a><span class="lineno">14564</span>&#160;</div><div class="line"><a name="l14565"></a><span class="lineno">14565</span>&#160;   <a class="code" href="../../d5/d7b/channel_8h.html#a29557c4823f5e9c02519a01daf6a289c">ast_hangup</a>(test_channel1);</div><div class="line"><a name="l14566"></a><span class="lineno">14566</span>&#160;</div><div class="line"><a name="l14567"></a><span class="lineno">14567</span>&#160;   <span class="keywordflow">return</span> res ? <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a> : <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a>;</div><div class="line"><a name="l14568"></a><span class="lineno">14568</span>&#160;}</div><div class="line"><a name="l14569"></a><span class="lineno">14569</span>&#160;</div><div class="line"><a name="l14570"></a><span class="lineno"><a class="line" href="../../d9/d1d/structtest__files.html">14570</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d9/d1d/structtest__files.html">test_files</a> {</div><div class="line"><a name="l14571"></a><span class="lineno"><a class="line" href="../../d9/d1d/structtest__files.html#a4a55f3eac855c94cd30d3f16c3f83fb7">14571</a></span>&#160;   <span class="keywordtype">char</span> dir[256];</div><div class="line"><a name="l14572"></a><span class="lineno"><a class="line" href="../../d9/d1d/structtest__files.html#a5c94c82d589acad192df2d3c263126a5">14572</a></span>&#160;   <span class="keywordtype">char</span> file[256];</div><div class="line"><a name="l14573"></a><span class="lineno"><a class="line" href="../../d9/d1d/structtest__files.html#a9423e07ce9563b09e3058fbd8c0e1e59">14573</a></span>&#160;   <span class="keywordtype">char</span> txtfile[256];</div><div class="line"><a name="l14574"></a><span class="lineno">14574</span>&#160;};</div><div class="line"><a name="l14575"></a><span class="lineno">14575</span>&#160;</div><div class="line"><a name="l14576"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a8d79bcf8b1f26587592d74a2fc5b0b39">14576</a></span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a>(test_voicemail_msgcount)</div><div class="line"><a name="l14577"></a><span class="lineno">14577</span>&#160;{</div><div class="line"><a name="l14578"></a><span class="lineno">14578</span>&#160;   <span class="keywordtype">int</span> i, j, res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a>, syserr;</div><div class="line"><a name="l14579"></a><span class="lineno">14579</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l14580"></a><span class="lineno">14580</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> svm;</div><div class="line"><a name="l14581"></a><span class="lineno">14581</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms;</div><div class="line"><a name="l14582"></a><span class="lineno">14582</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l14583"></a><span class="lineno">14583</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14584"></a><span class="lineno">14584</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l14585"></a><span class="lineno">14585</span>&#160;   <span class="comment">/* Using ast_alloca instead of just declaring tmp as an array is a workaround for a GCC 10 issue with -Wrestrict */</span></div><div class="line"><a name="l14586"></a><span class="lineno">14586</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d9/d1d/structtest__files.html">test_files</a> *tmp = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d9/d1d/structtest__files.html">test_files</a>) * 3);</div><div class="line"><a name="l14587"></a><span class="lineno">14587</span>&#160;   <span class="keywordtype">char</span> syscmd[256];</div><div class="line"><a name="l14588"></a><span class="lineno">14588</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> origweasels[] = <span class="stringliteral">&quot;tt-weasels&quot;</span>;</div><div class="line"><a name="l14589"></a><span class="lineno">14589</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> testcontext[] = <span class="stringliteral">&quot;test&quot;</span>;</div><div class="line"><a name="l14590"></a><span class="lineno">14590</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> testmailbox[] = <span class="stringliteral">&quot;00000000&quot;</span>;</div><div class="line"><a name="l14591"></a><span class="lineno">14591</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> testspec[] = <span class="stringliteral">&quot;00000000@test&quot;</span>;</div><div class="line"><a name="l14592"></a><span class="lineno">14592</span>&#160;   FILE *txt;</div><div class="line"><a name="l14593"></a><span class="lineno">14593</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">new</span>, old, urgent;</div><div class="line"><a name="l14594"></a><span class="lineno">14594</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *folders[3] = { <span class="stringliteral">&quot;Old&quot;</span>, <span class="stringliteral">&quot;Urgent&quot;</span>, <span class="stringliteral">&quot;INBOX&quot;</span> };</div><div class="line"><a name="l14595"></a><span class="lineno">14595</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">int</span> folder2mbox[3] = { 1, 11, 0 };</div><div class="line"><a name="l14596"></a><span class="lineno">14596</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">int</span> expected_results[3][12] = {</div><div class="line"><a name="l14597"></a><span class="lineno">14597</span>&#160;      <span class="comment">/* hasvm-old, hasvm-urgent, hasvm-new, ic-old, ic-urgent, ic-new, ic2-old, ic2-urgent, ic2-new, mc-old, mc-urgent, mc-new */</span></div><div class="line"><a name="l14598"></a><span class="lineno">14598</span>&#160;      {          1,            0,         0,      1,         0,      0,       1,          0,       0,      1,         0,      0 },</div><div class="line"><a name="l14599"></a><span class="lineno">14599</span>&#160;      {          1,            1,         1,      1,         0,      1,       1,          1,       0,      1,         1,      1 },</div><div class="line"><a name="l14600"></a><span class="lineno">14600</span>&#160;      {          1,            1,         1,      1,         0,      2,       1,          1,       1,      1,         1,      2 },</div><div class="line"><a name="l14601"></a><span class="lineno">14601</span>&#160;   };</div><div class="line"><a name="l14602"></a><span class="lineno">14602</span>&#160;</div><div class="line"><a name="l14603"></a><span class="lineno">14603</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l14604"></a><span class="lineno">14604</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a>:</div><div class="line"><a name="l14605"></a><span class="lineno">14605</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;name = <span class="stringliteral">&quot;test_voicemail_msgcount&quot;</span>;</div><div class="line"><a name="l14606"></a><span class="lineno">14606</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;category = <span class="stringliteral">&quot;/apps/app_voicemail/&quot;</span>;</div><div class="line"><a name="l14607"></a><span class="lineno">14607</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;summary = <span class="stringliteral">&quot;Test Voicemail status checks&quot;</span>;</div><div class="line"><a name="l14608"></a><span class="lineno">14608</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;description =</div><div class="line"><a name="l14609"></a><span class="lineno">14609</span>&#160;         <span class="stringliteral">&quot;Verify that message counts are correct when retrieved through the public API&quot;</span>;</div><div class="line"><a name="l14610"></a><span class="lineno">14610</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14611"></a><span class="lineno">14611</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a>:</div><div class="line"><a name="l14612"></a><span class="lineno">14612</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l14613"></a><span class="lineno">14613</span>&#160;   }</div><div class="line"><a name="l14614"></a><span class="lineno">14614</span>&#160;</div><div class="line"><a name="l14615"></a><span class="lineno">14615</span>&#160;   <span class="comment">/* Make sure the original path was completely empty */</span></div><div class="line"><a name="l14616"></a><span class="lineno">14616</span>&#160;   snprintf(syscmd, <span class="keyword">sizeof</span>(syscmd), <span class="stringliteral">&quot;rm -rf \&quot;%s%s/%s\&quot;&quot;</span>, VM_SPOOL_DIR, testcontext, testmailbox);</div><div class="line"><a name="l14617"></a><span class="lineno">14617</span>&#160;   <span class="keywordflow">if</span> ((syserr = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(syscmd))) {</div><div class="line"><a name="l14618"></a><span class="lineno">14618</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Unable to clear test directory: %s\n&quot;</span>,</div><div class="line"><a name="l14619"></a><span class="lineno">14619</span>&#160;         syserr &gt; 0 ? strerror(syserr) : <span class="stringliteral">&quot;unable to fork()&quot;</span>);</div><div class="line"><a name="l14620"></a><span class="lineno">14620</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14621"></a><span class="lineno">14621</span>&#160;   }</div><div class="line"><a name="l14622"></a><span class="lineno">14622</span>&#160;</div><div class="line"><a name="l14623"></a><span class="lineno">14623</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l14624"></a><span class="lineno">14624</span>&#160;   <span class="keywordflow">if</span> (!(chan = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l14625"></a><span class="lineno">14625</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Unable to create dummy channel\n&quot;</span>);</div><div class="line"><a name="l14626"></a><span class="lineno">14626</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14627"></a><span class="lineno">14627</span>&#160;   }</div><div class="line"><a name="l14628"></a><span class="lineno">14628</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l14629"></a><span class="lineno">14629</span>&#160;</div><div class="line"><a name="l14630"></a><span class="lineno">14630</span>&#160;   memset(&amp;svm, 0, <span class="keyword">sizeof</span>(svm));</div><div class="line"><a name="l14631"></a><span class="lineno">14631</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;svm, testcontext, testmailbox)) &amp;&amp;</div><div class="line"><a name="l14632"></a><span class="lineno">14632</span>&#160;      !(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(testcontext, testmailbox))) {</div><div class="line"><a name="l14633"></a><span class="lineno">14633</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Cannot create vmu structure\n&quot;</span>);</div><div class="line"><a name="l14634"></a><span class="lineno">14634</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad7c2a7da4125347c06d9719580731228">ast_unreplace_sigchld</a>();</div><div class="line"><a name="l14635"></a><span class="lineno">14635</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l14636"></a><span class="lineno">14636</span>&#160;      chan = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(chan);</div><div class="line"><a name="l14637"></a><span class="lineno">14637</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l14638"></a><span class="lineno">14638</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14639"></a><span class="lineno">14639</span>&#160;   }</div><div class="line"><a name="l14640"></a><span class="lineno">14640</span>&#160;</div><div class="line"><a name="l14641"></a><span class="lineno">14641</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l14642"></a><span class="lineno">14642</span>&#160;   memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));</div><div class="line"><a name="l14643"></a><span class="lineno">14643</span>&#160;</div><div class="line"><a name="l14644"></a><span class="lineno">14644</span>&#160;   <span class="comment">/* Create temporary voicemail */</span></div><div class="line"><a name="l14645"></a><span class="lineno">14645</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {</div><div class="line"><a name="l14646"></a><span class="lineno">14646</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a>(tmp[i].dir, <span class="keyword">sizeof</span>(tmp[i].dir), testcontext, testmailbox, folders[i]);</div><div class="line"><a name="l14647"></a><span class="lineno">14647</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(tmp[i].file, <span class="keyword">sizeof</span>(tmp[i].file), tmp[i].dir, 0);</div><div class="line"><a name="l14648"></a><span class="lineno">14648</span>&#160;      snprintf(tmp[i].<a class="code" href="../../d9/d1d/structtest__files.html#a9423e07ce9563b09e3058fbd8c0e1e59">txtfile</a>, <span class="keyword">sizeof</span>(tmp[i].txtfile), <span class="stringliteral">&quot;%s.txt&quot;</span>, tmp[i].file);</div><div class="line"><a name="l14649"></a><span class="lineno">14649</span>&#160;</div><div class="line"><a name="l14650"></a><span class="lineno">14650</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(origweasels, <span class="stringliteral">&quot;gsm&quot;</span>, <span class="stringliteral">&quot;en&quot;</span>) &gt; 0) {</div><div class="line"><a name="l14651"></a><span class="lineno">14651</span>&#160;         snprintf(syscmd, <span class="keyword">sizeof</span>(syscmd), <span class="stringliteral">&quot;cp \&quot;%s/sounds/en/%s.gsm\&quot; \&quot;%s/%s/%s/%s/msg0000.gsm\&quot;&quot;</span>, <a class="code" href="../../dd/df2/paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>, origweasels,</div><div class="line"><a name="l14652"></a><span class="lineno">14652</span>&#160;            VM_SPOOL_DIR, testcontext, testmailbox, folders[i]);</div><div class="line"><a name="l14653"></a><span class="lineno">14653</span>&#160;         <span class="keywordflow">if</span> ((syserr = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(syscmd))) {</div><div class="line"><a name="l14654"></a><span class="lineno">14654</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Unable to create test voicemail: %s\n&quot;</span>,</div><div class="line"><a name="l14655"></a><span class="lineno">14655</span>&#160;               syserr &gt; 0 ? strerror(syserr) : <span class="stringliteral">&quot;unable to fork()&quot;</span>);</div><div class="line"><a name="l14656"></a><span class="lineno">14656</span>&#160;            <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad7c2a7da4125347c06d9719580731228">ast_unreplace_sigchld</a>();</div><div class="line"><a name="l14657"></a><span class="lineno">14657</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l14658"></a><span class="lineno">14658</span>&#160;            chan = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(chan);</div><div class="line"><a name="l14659"></a><span class="lineno">14659</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l14660"></a><span class="lineno">14660</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l14661"></a><span class="lineno">14661</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14662"></a><span class="lineno">14662</span>&#160;         }</div><div class="line"><a name="l14663"></a><span class="lineno">14663</span>&#160;      }</div><div class="line"><a name="l14664"></a><span class="lineno">14664</span>&#160;</div><div class="line"><a name="l14665"></a><span class="lineno">14665</span>&#160;      <span class="keywordflow">if</span> ((txt = fopen(tmp[i].txtfile, <span class="stringliteral">&quot;w+&quot;</span>))) {</div><div class="line"><a name="l14666"></a><span class="lineno">14666</span>&#160;         fprintf(txt, <span class="stringliteral">&quot;; just a stub\n[message]\nflag=%s\n&quot;</span>, strcmp(folders[i], <span class="stringliteral">&quot;Urgent&quot;</span>) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;Urgent&quot;</span>);</div><div class="line"><a name="l14667"></a><span class="lineno">14667</span>&#160;         fclose(txt);</div><div class="line"><a name="l14668"></a><span class="lineno">14668</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14669"></a><span class="lineno">14669</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Unable to write message file &#39;%s&#39;\n&quot;</span>, tmp[i].txtfile);</div><div class="line"><a name="l14670"></a><span class="lineno">14670</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14671"></a><span class="lineno">14671</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l14672"></a><span class="lineno">14672</span>&#160;      }</div><div class="line"><a name="l14673"></a><span class="lineno">14673</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, folder2mbox[i]);</div><div class="line"><a name="l14674"></a><span class="lineno">14674</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a>(tmp[i].dir, testmailbox, testcontext, 0, chan, vmu, <span class="stringliteral">&quot;gsm&quot;</span>, 600, &amp;vms, strcmp(folders[i], <span class="stringliteral">&quot;Urgent&quot;</span>) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;Urgent&quot;</span>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l14675"></a><span class="lineno">14675</span>&#160;</div><div class="line"><a name="l14676"></a><span class="lineno">14676</span>&#160;      <span class="comment">/* hasvm-old, hasvm-urgent, hasvm-new, ic-old, ic-urgent, ic-new, ic2-old, ic2-urgent, ic2-new, mc-old, mc-urgent, mc-new */</span></div><div class="line"><a name="l14677"></a><span class="lineno">14677</span>&#160;      <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++) {</div><div class="line"><a name="l14678"></a><span class="lineno">14678</span>&#160;         <span class="comment">/* folder[2] is INBOX, __has_voicemail will default back to INBOX */</span></div><div class="line"><a name="l14679"></a><span class="lineno">14679</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a76b4d3927cacd1bcd5da9ca8fe375cb6">ast_app_has_voicemail</a>(testspec, (j==2 ? <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : folders[j])) != expected_results[i][0 + j]) {</div><div class="line"><a name="l14680"></a><span class="lineno">14680</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;has_voicemail(%s, %s) returned %d and we expected %d\n&quot;</span>,</div><div class="line"><a name="l14681"></a><span class="lineno">14681</span>&#160;               testspec, folders[j], <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a76b4d3927cacd1bcd5da9ca8fe375cb6">ast_app_has_voicemail</a>(testspec, folders[j]), expected_results[i][0 + j]);</div><div class="line"><a name="l14682"></a><span class="lineno">14682</span>&#160;            res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14683"></a><span class="lineno">14683</span>&#160;         }</div><div class="line"><a name="l14684"></a><span class="lineno">14684</span>&#160;      }</div><div class="line"><a name="l14685"></a><span class="lineno">14685</span>&#160;</div><div class="line"><a name="l14686"></a><span class="lineno">14686</span>&#160;      <span class="keyword">new</span> = old = urgent = 0;</div><div class="line"><a name="l14687"></a><span class="lineno">14687</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ab45a61007ccd8ca2ea062f42b83b18ff">ast_app_inboxcount</a>(testspec, &amp;<span class="keyword">new</span>, &amp;old)) {</div><div class="line"><a name="l14688"></a><span class="lineno">14688</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;inboxcount returned failure\n&quot;</span>);</div><div class="line"><a name="l14689"></a><span class="lineno">14689</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14690"></a><span class="lineno">14690</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (old != expected_results[i][3 + 0] || <span class="keyword">new</span> != expected_results[i][3 + 2]) {</div><div class="line"><a name="l14691"></a><span class="lineno">14691</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;inboxcount(%s) returned old=%d (expected %d) and new=%d (expected %d)\n&quot;</span>,</div><div class="line"><a name="l14692"></a><span class="lineno">14692</span>&#160;            testspec, old, expected_results[i][3 + 0], <span class="keyword">new</span>, expected_results[i][3 + 2]);</div><div class="line"><a name="l14693"></a><span class="lineno">14693</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14694"></a><span class="lineno">14694</span>&#160;      }</div><div class="line"><a name="l14695"></a><span class="lineno">14695</span>&#160;</div><div class="line"><a name="l14696"></a><span class="lineno">14696</span>&#160;      <span class="keyword">new</span> = old = urgent = 0;</div><div class="line"><a name="l14697"></a><span class="lineno">14697</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ace2a3d783f4f79818e14265ae719f06c">ast_app_inboxcount2</a>(testspec, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old)) {</div><div class="line"><a name="l14698"></a><span class="lineno">14698</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;inboxcount2 returned failure\n&quot;</span>);</div><div class="line"><a name="l14699"></a><span class="lineno">14699</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14700"></a><span class="lineno">14700</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (old != expected_results[i][6 + 0] ||</div><div class="line"><a name="l14701"></a><span class="lineno">14701</span>&#160;            urgent != expected_results[i][6 + 1] ||</div><div class="line"><a name="l14702"></a><span class="lineno">14702</span>&#160;               <span class="keyword">new</span> != expected_results[i][6 + 2]    ) {</div><div class="line"><a name="l14703"></a><span class="lineno">14703</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;inboxcount2(%s) returned old=%d (expected %d), urgent=%d (expected %d), and new=%d (expected %d)\n&quot;</span>,</div><div class="line"><a name="l14704"></a><span class="lineno">14704</span>&#160;            testspec, old, expected_results[i][6 + 0], urgent, expected_results[i][6 + 1], <span class="keyword">new</span>, expected_results[i][6 + 2]);</div><div class="line"><a name="l14705"></a><span class="lineno">14705</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14706"></a><span class="lineno">14706</span>&#160;      }</div><div class="line"><a name="l14707"></a><span class="lineno">14707</span>&#160;</div><div class="line"><a name="l14708"></a><span class="lineno">14708</span>&#160;      <span class="keyword">new</span> = old = urgent = 0;</div><div class="line"><a name="l14709"></a><span class="lineno">14709</span>&#160;      <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++) {</div><div class="line"><a name="l14710"></a><span class="lineno">14710</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a16254e1237610f11047a7558bbe1f207">ast_app_messagecount</a>(testspec, folders[j]) != expected_results[i][9 + j]) {</div><div class="line"><a name="l14711"></a><span class="lineno">14711</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;messagecount(%s, %s) returned %d and we expected %d\n&quot;</span>,</div><div class="line"><a name="l14712"></a><span class="lineno">14712</span>&#160;               testspec, folders[j], <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a16254e1237610f11047a7558bbe1f207">ast_app_messagecount</a>(testspec, folders[j]), expected_results[i][9 + j]);</div><div class="line"><a name="l14713"></a><span class="lineno">14713</span>&#160;            res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14714"></a><span class="lineno">14714</span>&#160;         }</div><div class="line"><a name="l14715"></a><span class="lineno">14715</span>&#160;      }</div><div class="line"><a name="l14716"></a><span class="lineno">14716</span>&#160;   }</div><div class="line"><a name="l14717"></a><span class="lineno">14717</span>&#160;</div><div class="line"><a name="l14718"></a><span class="lineno">14718</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {</div><div class="line"><a name="l14719"></a><span class="lineno">14719</span>&#160;      <span class="comment">/* This is necessary if the voicemails are stored on an ODBC/IMAP</span></div><div class="line"><a name="l14720"></a><span class="lineno">14720</span>&#160;<span class="comment">       * server, in which case, the rm below will not affect the</span></div><div class="line"><a name="l14721"></a><span class="lineno">14721</span>&#160;<span class="comment">       * voicemails. */</span></div><div class="line"><a name="l14722"></a><span class="lineno">14722</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(tmp[i].dir, 0, tmp[i].file, vmu);</div><div class="line"><a name="l14723"></a><span class="lineno">14723</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(tmp[i].dir, 0);</div><div class="line"><a name="l14724"></a><span class="lineno">14724</span>&#160;   }</div><div class="line"><a name="l14725"></a><span class="lineno">14725</span>&#160;</div><div class="line"><a name="l14726"></a><span class="lineno">14726</span>&#160;   <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>) {</div><div class="line"><a name="l14727"></a><span class="lineno">14727</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>);</div><div class="line"><a name="l14728"></a><span class="lineno">14728</span>&#160;   }</div><div class="line"><a name="l14729"></a><span class="lineno">14729</span>&#160;   <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>) {</div><div class="line"><a name="l14730"></a><span class="lineno">14730</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>);</div><div class="line"><a name="l14731"></a><span class="lineno">14731</span>&#160;   }</div><div class="line"><a name="l14732"></a><span class="lineno">14732</span>&#160;</div><div class="line"><a name="l14733"></a><span class="lineno">14733</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l14734"></a><span class="lineno">14734</span>&#160;   chan = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(chan);</div><div class="line"><a name="l14735"></a><span class="lineno">14735</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l14736"></a><span class="lineno">14736</span>&#160;</div><div class="line"><a name="l14737"></a><span class="lineno">14737</span>&#160;   <span class="comment">/* And remove test directory */</span></div><div class="line"><a name="l14738"></a><span class="lineno">14738</span>&#160;   snprintf(syscmd, <span class="keyword">sizeof</span>(syscmd), <span class="stringliteral">&quot;rm -rf \&quot;%s%s/%s\&quot;&quot;</span>, VM_SPOOL_DIR, testcontext, testmailbox);</div><div class="line"><a name="l14739"></a><span class="lineno">14739</span>&#160;   <span class="keywordflow">if</span> ((syserr = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a>(syscmd))) {</div><div class="line"><a name="l14740"></a><span class="lineno">14740</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Unable to clear test directory: %s\n&quot;</span>,</div><div class="line"><a name="l14741"></a><span class="lineno">14741</span>&#160;         syserr &gt; 0 ? strerror(syserr) : <span class="stringliteral">&quot;unable to fork()&quot;</span>);</div><div class="line"><a name="l14742"></a><span class="lineno">14742</span>&#160;   }</div><div class="line"><a name="l14743"></a><span class="lineno">14743</span>&#160;</div><div class="line"><a name="l14744"></a><span class="lineno">14744</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l14745"></a><span class="lineno">14745</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14746"></a><span class="lineno">14746</span>&#160;}</div><div class="line"><a name="l14747"></a><span class="lineno">14747</span>&#160;</div><div class="line"><a name="l14748"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#acab51ef034d31b23bc896518b0c0246f">14748</a></span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a>(test_voicemail_notify_endl)</div><div class="line"><a name="l14749"></a><span class="lineno">14749</span>&#160;{</div><div class="line"><a name="l14750"></a><span class="lineno">14750</span>&#160;   <span class="keywordtype">int</span> res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a>;</div><div class="line"><a name="l14751"></a><span class="lineno">14751</span>&#160;   <span class="keywordtype">char</span> testcontext[] = <span class="stringliteral">&quot;test&quot;</span>;</div><div class="line"><a name="l14752"></a><span class="lineno">14752</span>&#160;   <span class="keywordtype">char</span> testmailbox[] = <span class="stringliteral">&quot;00000000&quot;</span>;</div><div class="line"><a name="l14753"></a><span class="lineno">14753</span>&#160;   <span class="keywordtype">char</span> from[] = <span class="stringliteral">&quot;test@example.net&quot;</span>, cidnum[] = <span class="stringliteral">&quot;1234&quot;</span>, cidname[] = <span class="stringliteral">&quot;Mark Spencer&quot;</span>, format[] = <span class="stringliteral">&quot;gsm&quot;</span>;</div><div class="line"><a name="l14754"></a><span class="lineno">14754</span>&#160;   <span class="keywordtype">char</span> attach[256], attach2[256];</div><div class="line"><a name="l14755"></a><span class="lineno">14755</span>&#160;   <span class="keywordtype">char</span> buf[256] = <span class="stringliteral">&quot;&quot;</span>; <span class="comment">/* No line should actually be longer than 80 */</span></div><div class="line"><a name="l14756"></a><span class="lineno">14756</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14757"></a><span class="lineno">14757</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, vmus = {</div><div class="line"><a name="l14758"></a><span class="lineno">14758</span>&#160;      .<a class="code" href="../../da/df6/structast__vm__user.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = 0,</div><div class="line"><a name="l14759"></a><span class="lineno">14759</span>&#160;   };</div><div class="line"><a name="l14760"></a><span class="lineno">14760</span>&#160;   FILE *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>;</div><div class="line"><a name="l14761"></a><span class="lineno">14761</span>&#160;   <span class="keyword">struct </span>{</div><div class="line"><a name="l14762"></a><span class="lineno">14762</span>&#160;      <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>;</div><div class="line"><a name="l14763"></a><span class="lineno">14763</span>&#160;      <span class="keyword">enum</span> { INT, FLAGVAL, STATIC, STRPTR } <a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a>;</div><div class="line"><a name="l14764"></a><span class="lineno">14764</span>&#160;      <span class="keywordtype">void</span> *location;</div><div class="line"><a name="l14765"></a><span class="lineno">14765</span>&#160;      <span class="keyword">union </span>{</div><div class="line"><a name="l14766"></a><span class="lineno">14766</span>&#160;         <span class="keywordtype">int</span> intval;</div><div class="line"><a name="l14767"></a><span class="lineno">14767</span>&#160;         <span class="keywordtype">char</span> *strval;</div><div class="line"><a name="l14768"></a><span class="lineno">14768</span>&#160;      } u;</div><div class="line"><a name="l14769"></a><span class="lineno">14769</span>&#160;   } test_items[] = {</div><div class="line"><a name="l14770"></a><span class="lineno">14770</span>&#160;      { <span class="stringliteral">&quot;plain jane config&quot;</span>, STATIC, vmus.<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, .u.strval = <span class="stringliteral">&quot;1234&quot;</span> }, <span class="comment">/* No, this doesn&#39;t change this test any. */</span></div><div class="line"><a name="l14771"></a><span class="lineno">14771</span>&#160;      { <span class="stringliteral">&quot;emailsubject&quot;</span>, STRPTR, vmus.<a class="code" href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>, .u.strval = <span class="stringliteral">&quot;Oogly boogly\xf8koogly with what appears to be UTF-8&quot;</span> },</div><div class="line"><a name="l14772"></a><span class="lineno">14772</span>&#160;      { <span class="stringliteral">&quot;emailbody&quot;</span>, STRPTR, vmus.<a class="code" href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>, .u.strval = <span class="stringliteral">&quot;This is a test\n\twith multiple\nlines\nwithin\n&quot;</span> },</div><div class="line"><a name="l14773"></a><span class="lineno">14773</span>&#160;      { <span class="stringliteral">&quot;serveremail&quot;</span>, STATIC, vmus.<a class="code" href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>, .u.strval = <span class="stringliteral">&quot;\&quot;\xf8Something\xe8that\xd8seems to have UTF-8 chars\&quot; &lt;test@example.net&gt;&quot;</span> },</div><div class="line"><a name="l14774"></a><span class="lineno">14774</span>&#160;      { <span class="stringliteral">&quot;attachment flag&quot;</span>, FLAGVAL, &amp;vmus.<a class="code" href="../../da/df6/structast__vm__user.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, .u.intval = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a> },</div><div class="line"><a name="l14775"></a><span class="lineno">14775</span>&#160;      { <span class="stringliteral">&quot;attach2&quot;</span>, STRPTR, attach2, .u.strval = <span class="stringliteral">&quot;&quot;</span> },</div><div class="line"><a name="l14776"></a><span class="lineno">14776</span>&#160;      { <span class="stringliteral">&quot;attach&quot;</span>, STRPTR, attach, .u.strval = <span class="stringliteral">&quot;&quot;</span> },</div><div class="line"><a name="l14777"></a><span class="lineno">14777</span>&#160;   };</div><div class="line"><a name="l14778"></a><span class="lineno">14778</span>&#160;   <span class="keywordtype">int</span> which;</div><div class="line"><a name="l14779"></a><span class="lineno">14779</span>&#160;</div><div class="line"><a name="l14780"></a><span class="lineno">14780</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l14781"></a><span class="lineno">14781</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a>:</div><div class="line"><a name="l14782"></a><span class="lineno">14782</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;name = <span class="stringliteral">&quot;test_voicemail_notify_endl&quot;</span>;</div><div class="line"><a name="l14783"></a><span class="lineno">14783</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;category = <span class="stringliteral">&quot;/apps/app_voicemail/&quot;</span>;</div><div class="line"><a name="l14784"></a><span class="lineno">14784</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;summary = <span class="stringliteral">&quot;Test Voicemail notification end-of-line&quot;</span>;</div><div class="line"><a name="l14785"></a><span class="lineno">14785</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;description =</div><div class="line"><a name="l14786"></a><span class="lineno">14786</span>&#160;         <span class="stringliteral">&quot;Verify that notification emails use a consistent end-of-line character&quot;</span>;</div><div class="line"><a name="l14787"></a><span class="lineno">14787</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14788"></a><span class="lineno">14788</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a>:</div><div class="line"><a name="l14789"></a><span class="lineno">14789</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l14790"></a><span class="lineno">14790</span>&#160;   }</div><div class="line"><a name="l14791"></a><span class="lineno">14791</span>&#160;</div><div class="line"><a name="l14792"></a><span class="lineno">14792</span>&#160;   snprintf(attach, <span class="keyword">sizeof</span>(attach), <span class="stringliteral">&quot;%s/sounds/en/tt-weasels&quot;</span>, <a class="code" href="../../dd/df2/paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>);</div><div class="line"><a name="l14793"></a><span class="lineno">14793</span>&#160;   snprintf(attach2, <span class="keyword">sizeof</span>(attach2), <span class="stringliteral">&quot;%s/sounds/en/tt-somethingwrong&quot;</span>, <a class="code" href="../../dd/df2/paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>);</div><div class="line"><a name="l14794"></a><span class="lineno">14794</span>&#160;</div><div class="line"><a name="l14795"></a><span class="lineno">14795</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, testcontext, testmailbox)) &amp;&amp;</div><div class="line"><a name="l14796"></a><span class="lineno">14796</span>&#160;      !(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(testcontext, testmailbox))) {</div><div class="line"><a name="l14797"></a><span class="lineno">14797</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Cannot create vmu structure\n&quot;</span>);</div><div class="line"><a name="l14798"></a><span class="lineno">14798</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14799"></a><span class="lineno">14799</span>&#160;   }</div><div class="line"><a name="l14800"></a><span class="lineno">14800</span>&#160;</div><div class="line"><a name="l14801"></a><span class="lineno">14801</span>&#160;   <span class="keywordflow">if</span> (vmu != &amp;vmus &amp;&amp; !(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, testcontext, testmailbox))) {</div><div class="line"><a name="l14802"></a><span class="lineno">14802</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Cannot find vmu structure?!!\n&quot;</span>);</div><div class="line"><a name="l14803"></a><span class="lineno">14803</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14804"></a><span class="lineno">14804</span>&#160;   }</div><div class="line"><a name="l14805"></a><span class="lineno">14805</span>&#160;</div><div class="line"><a name="l14806"></a><span class="lineno">14806</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l14807"></a><span class="lineno">14807</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<span class="stringliteral">&quot;test2@example.net&quot;</span>);</div><div class="line"><a name="l14808"></a><span class="lineno">14808</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l14809"></a><span class="lineno">14809</span>&#160;   <span class="comment">/* TODO When we set up the IMAP server test, we&#39;ll need to have credentials for the VMU structure added here */</span></div><div class="line"><a name="l14810"></a><span class="lineno">14810</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l14811"></a><span class="lineno">14811</span>&#160;</div><div class="line"><a name="l14812"></a><span class="lineno">14812</span>&#160;   file = tmpfile();</div><div class="line"><a name="l14813"></a><span class="lineno">14813</span>&#160;   <span class="keywordflow">for</span> (which = 0; which &lt; <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(test_items); which++) {</div><div class="line"><a name="l14814"></a><span class="lineno">14814</span>&#160;      <span class="comment">/* Kill previous test, if any */</span></div><div class="line"><a name="l14815"></a><span class="lineno">14815</span>&#160;      rewind(file);</div><div class="line"><a name="l14816"></a><span class="lineno">14816</span>&#160;      <span class="keywordflow">if</span> (ftruncate(fileno(file), 0)) {</div><div class="line"><a name="l14817"></a><span class="lineno">14817</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Cannot truncate test output file: %s\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line"><a name="l14818"></a><span class="lineno">14818</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14819"></a><span class="lineno">14819</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l14820"></a><span class="lineno">14820</span>&#160;      }</div><div class="line"><a name="l14821"></a><span class="lineno">14821</span>&#160;</div><div class="line"><a name="l14822"></a><span class="lineno">14822</span>&#160;      <span class="comment">/* Make each change, in order, to the test mailbox */</span></div><div class="line"><a name="l14823"></a><span class="lineno">14823</span>&#160;      <span class="keywordflow">if</span> (test_items[which].<a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a> == INT) {</div><div class="line"><a name="l14824"></a><span class="lineno">14824</span>&#160;         *((<span class="keywordtype">int</span> *) test_items[which].location) = test_items[which].u.intval;</div><div class="line"><a name="l14825"></a><span class="lineno">14825</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (test_items[which].<a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a> == FLAGVAL) {</div><div class="line"><a name="l14826"></a><span class="lineno">14826</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, test_items[which].u.intval)) {</div><div class="line"><a name="l14827"></a><span class="lineno">14827</span>&#160;            <a class="code" href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(vmu, test_items[which].u.intval);</div><div class="line"><a name="l14828"></a><span class="lineno">14828</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l14829"></a><span class="lineno">14829</span>&#160;            <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(vmu, test_items[which].u.intval);</div><div class="line"><a name="l14830"></a><span class="lineno">14830</span>&#160;         }</div><div class="line"><a name="l14831"></a><span class="lineno">14831</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (test_items[which].<a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a> == STATIC) {</div><div class="line"><a name="l14832"></a><span class="lineno">14832</span>&#160;         strcpy(test_items[which].location, test_items[which].u.strval);</div><div class="line"><a name="l14833"></a><span class="lineno">14833</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (test_items[which].<a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a> == STRPTR) {</div><div class="line"><a name="l14834"></a><span class="lineno">14834</span>&#160;         test_items[which].location = test_items[which].u.strval;</div><div class="line"><a name="l14835"></a><span class="lineno">14835</span>&#160;      }</div><div class="line"><a name="l14836"></a><span class="lineno">14836</span>&#160;</div><div class="line"><a name="l14837"></a><span class="lineno">14837</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0">make_email_file</a>(file, from, vmu, 0, testcontext, testmailbox, <span class="stringliteral">&quot;INBOX&quot;</span>, cidnum, cidname, attach, attach2, format, 999, 1, chan, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l14838"></a><span class="lineno">14838</span>&#160;      rewind(file);</div><div class="line"><a name="l14839"></a><span class="lineno">14839</span>&#160;      <span class="keywordflow">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), file)) {</div><div class="line"><a name="l14840"></a><span class="lineno">14840</span>&#160;         <span class="keywordflow">if</span> (</div><div class="line"><a name="l14841"></a><span class="lineno">14841</span>&#160;         (strlen(buf) &gt; 1 &amp;&amp;</div><div class="line"><a name="l14842"></a><span class="lineno">14842</span>&#160;#ifdef IMAP_STORAGE</div><div class="line"><a name="l14843"></a><span class="lineno">14843</span>&#160;         buf[strlen(buf) - 2] != <span class="charliteral">&#39;\r&#39;</span></div><div class="line"><a name="l14844"></a><span class="lineno">14844</span>&#160;#<span class="keywordflow">else</span></div><div class="line"><a name="l14845"></a><span class="lineno">14845</span>&#160;         buf[strlen(buf) - 2] == <span class="charliteral">&#39;\r&#39;</span></div><div class="line"><a name="l14846"></a><span class="lineno">14846</span>&#160;#endif</div><div class="line"><a name="l14847"></a><span class="lineno">14847</span>&#160;         )</div><div class="line"><a name="l14848"></a><span class="lineno">14848</span>&#160;         || buf[strlen(buf) - 1] != <span class="charliteral">&#39;\n&#39;</span>) {</div><div class="line"><a name="l14849"></a><span class="lineno">14849</span>&#160;            res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14850"></a><span class="lineno">14850</span>&#160;         }</div><div class="line"><a name="l14851"></a><span class="lineno">14851</span>&#160;      }</div><div class="line"><a name="l14852"></a><span class="lineno">14852</span>&#160;   }</div><div class="line"><a name="l14853"></a><span class="lineno">14853</span>&#160;   fclose(file);</div><div class="line"><a name="l14854"></a><span class="lineno">14854</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l14855"></a><span class="lineno">14855</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14856"></a><span class="lineno">14856</span>&#160;}</div><div class="line"><a name="l14857"></a><span class="lineno">14857</span>&#160;</div><div class="line"><a name="l14858"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a903dd6d5a2beb43f68407296c53570f6">14858</a></span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a>(test_voicemail_load_config)</div><div class="line"><a name="l14859"></a><span class="lineno">14859</span>&#160;{</div><div class="line"><a name="l14860"></a><span class="lineno">14860</span>&#160;   <span class="keywordtype">int</span> res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a>;</div><div class="line"><a name="l14861"></a><span class="lineno">14861</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l14862"></a><span class="lineno">14862</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *cfg;</div><div class="line"><a name="l14863"></a><span class="lineno">14863</span>&#160;   <span class="keywordtype">char</span> <a class="code" href="../../d4/dc5/extconf_8c.html#ae4c618117458ec0ed99d972e34964cfb">config_filename</a>[32] = <span class="stringliteral">&quot;/tmp/voicemail.conf.XXXXXX&quot;</span>;</div><div class="line"><a name="l14864"></a><span class="lineno">14864</span>&#160;   <span class="keywordtype">int</span> fd;</div><div class="line"><a name="l14865"></a><span class="lineno">14865</span>&#160;   FILE *<a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>;</div><div class="line"><a name="l14866"></a><span class="lineno">14866</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l14867"></a><span class="lineno">14867</span>&#160;</div><div class="line"><a name="l14868"></a><span class="lineno">14868</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l14869"></a><span class="lineno">14869</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a>:</div><div class="line"><a name="l14870"></a><span class="lineno">14870</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;name = <span class="stringliteral">&quot;test_voicemail_load_config&quot;</span>;</div><div class="line"><a name="l14871"></a><span class="lineno">14871</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;category = <span class="stringliteral">&quot;/apps/app_voicemail/&quot;</span>;</div><div class="line"><a name="l14872"></a><span class="lineno">14872</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;summary = <span class="stringliteral">&quot;Test loading Voicemail config&quot;</span>;</div><div class="line"><a name="l14873"></a><span class="lineno">14873</span>&#160;      <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;description =</div><div class="line"><a name="l14874"></a><span class="lineno">14874</span>&#160;         <span class="stringliteral">&quot;Verify that configuration is loaded consistently. &quot;</span></div><div class="line"><a name="l14875"></a><span class="lineno">14875</span>&#160;         <span class="stringliteral">&quot;This is to test regressions of ASTERISK-18838 where it was noticed that &quot;</span></div><div class="line"><a name="l14876"></a><span class="lineno">14876</span>&#160;         <span class="stringliteral">&quot;some options were loaded after the mailboxes were instantiated, causing &quot;</span></div><div class="line"><a name="l14877"></a><span class="lineno">14877</span>&#160;         <span class="stringliteral">&quot;those options not to be set correctly.&quot;</span>;</div><div class="line"><a name="l14878"></a><span class="lineno">14878</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14879"></a><span class="lineno">14879</span>&#160;   <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a>:</div><div class="line"><a name="l14880"></a><span class="lineno">14880</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l14881"></a><span class="lineno">14881</span>&#160;   }</div><div class="line"><a name="l14882"></a><span class="lineno">14882</span>&#160;</div><div class="line"><a name="l14883"></a><span class="lineno">14883</span>&#160;   <span class="comment">/* build a config file by hand... */</span></div><div class="line"><a name="l14884"></a><span class="lineno">14884</span>&#160;   <span class="keywordflow">if</span> ((fd = mkstemp(config_filename)) &lt; 0) {</div><div class="line"><a name="l14885"></a><span class="lineno">14885</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14886"></a><span class="lineno">14886</span>&#160;   }</div><div class="line"><a name="l14887"></a><span class="lineno">14887</span>&#160;   <span class="keywordflow">if</span> (!(file = fdopen(fd, <span class="stringliteral">&quot;w&quot;</span>))) {</div><div class="line"><a name="l14888"></a><span class="lineno">14888</span>&#160;      close(fd);</div><div class="line"><a name="l14889"></a><span class="lineno">14889</span>&#160;      unlink(config_filename);</div><div class="line"><a name="l14890"></a><span class="lineno">14890</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14891"></a><span class="lineno">14891</span>&#160;   }</div><div class="line"><a name="l14892"></a><span class="lineno">14892</span>&#160;   fputs(<span class="stringliteral">&quot;[general]\ncallback=somecontext\nlocale=de_DE.UTF-8\ntz=european\n[test]&quot;</span>, file);</div><div class="line"><a name="l14893"></a><span class="lineno">14893</span>&#160;   fputs(<span class="stringliteral">&quot;00000001 =&gt; 9999,Mr. Test,,,callback=othercontext|locale=nl_NL.UTF-8|tz=central\n&quot;</span>, file);</div><div class="line"><a name="l14894"></a><span class="lineno">14894</span>&#160;   fputs(<span class="stringliteral">&quot;00000002 =&gt; 9999,Mrs. Test\n&quot;</span>, file);</div><div class="line"><a name="l14895"></a><span class="lineno">14895</span>&#160;   fclose(file);</div><div class="line"><a name="l14896"></a><span class="lineno">14896</span>&#160;</div><div class="line"><a name="l14897"></a><span class="lineno">14897</span>&#160;   <span class="keywordflow">if</span> (!(cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config_filename, config_flags)) || !<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(cfg)) {</div><div class="line"><a name="l14898"></a><span class="lineno">14898</span>&#160;      res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14899"></a><span class="lineno">14899</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../d2/d2c/pbx__realtime_8c.html#a10b51e1931bd03dd172cbfb9d3d67efb">cleanup</a>;</div><div class="line"><a name="l14900"></a><span class="lineno">14900</span>&#160;   }</div><div class="line"><a name="l14901"></a><span class="lineno">14901</span>&#160;</div><div class="line"><a name="l14902"></a><span class="lineno">14902</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6e97699b892f61cc208de9f991cfb293">load_config_from_memory</a>(1, cfg, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l14903"></a><span class="lineno">14903</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(cfg);</div><div class="line"><a name="l14904"></a><span class="lineno">14904</span>&#160;</div><div class="line"><a name="l14905"></a><span class="lineno">14905</span>&#160;<span class="preprocessor">#define CHECK(u, attr, value) else if (strcmp(u-&gt;attr, value)) { \</span></div><div class="line"><a name="l14906"></a><span class="lineno">14906</span>&#160;<span class="preprocessor">   ast_test_status_update(test, &quot;mailbox %s should have %s &#39;%s&#39;, but has &#39;%s&#39;\n&quot;, \</span></div><div class="line"><a name="l14907"></a><span class="lineno">14907</span>&#160;<span class="preprocessor">   u-&gt;mailbox, #attr, value, u-&gt;attr); res = AST_TEST_FAIL; break; }</span></div><div class="line"><a name="l14908"></a><span class="lineno">14908</span>&#160;</div><div class="line"><a name="l14909"></a><span class="lineno">14909</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l14910"></a><span class="lineno">14910</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, list) {</div><div class="line"><a name="l14911"></a><span class="lineno">14911</span>&#160;      <span class="keywordflow">if</span> (!strcmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="stringliteral">&quot;00000001&quot;</span>)) {</div><div class="line"><a name="l14912"></a><span class="lineno">14912</span>&#160;         <span class="keywordflow">if</span> (0); <span class="comment">/* trick to get CHECK to work */</span></div><div class="line"><a name="l14913"></a><span class="lineno">14913</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a>(vmu, callback, <span class="stringliteral">&quot;othercontext&quot;</span>)</div><div class="line"><a name="l14914"></a><span class="lineno">14914</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a>(vmu, locale, <span class="stringliteral">&quot;nl_NL.UTF-8&quot;</span>)</div><div class="line"><a name="l14915"></a><span class="lineno">14915</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a>(vmu, zonetag, <span class="stringliteral">&quot;central&quot;</span>)</div><div class="line"><a name="l14916"></a><span class="lineno">14916</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <span class="stringliteral">&quot;00000002&quot;</span>)) {</div><div class="line"><a name="l14917"></a><span class="lineno">14917</span>&#160;         <span class="keywordflow">if</span> (0); <span class="comment">/* trick to get CHECK to work */</span></div><div class="line"><a name="l14918"></a><span class="lineno">14918</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a>(vmu, callback, <span class="stringliteral">&quot;somecontext&quot;</span>)</div><div class="line"><a name="l14919"></a><span class="lineno">14919</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a>(vmu, locale, <span class="stringliteral">&quot;de_DE.UTF-8&quot;</span>)</div><div class="line"><a name="l14920"></a><span class="lineno">14920</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a>(vmu, zonetag, <span class="stringliteral">&quot;european&quot;</span>)</div><div class="line"><a name="l14921"></a><span class="lineno">14921</span>&#160;      }</div><div class="line"><a name="l14922"></a><span class="lineno">14922</span>&#160;   }</div><div class="line"><a name="l14923"></a><span class="lineno">14923</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l14924"></a><span class="lineno">14924</span>&#160;</div><div class="line"><a name="l14925"></a><span class="lineno">14925</span>&#160;<span class="preprocessor">#undef CHECK</span></div><div class="line"><a name="l14926"></a><span class="lineno">14926</span>&#160;</div><div class="line"><a name="l14927"></a><span class="lineno">14927</span>&#160;   <span class="comment">/* restore config */</span></div><div class="line"><a name="l14928"></a><span class="lineno">14928</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(1); <span class="comment">/* this might say &quot;Failed to load configuration file.&quot; */</span></div><div class="line"><a name="l14929"></a><span class="lineno">14929</span>&#160;</div><div class="line"><a name="l14930"></a><span class="lineno">14930</span>&#160;<a class="code" href="../../d2/d2c/pbx__realtime_8c.html#a10b51e1931bd03dd172cbfb9d3d67efb">cleanup</a>:</div><div class="line"><a name="l14931"></a><span class="lineno">14931</span>&#160;   unlink(config_filename);</div><div class="line"><a name="l14932"></a><span class="lineno">14932</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l14933"></a><span class="lineno">14933</span>&#160;}</div><div class="line"><a name="l14934"></a><span class="lineno">14934</span>&#160;</div><div class="line"><a name="l14935"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad6c782fa10d73a3aeaf3c568e002ebb7">14935</a></span>&#160;<a class="code" href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a>(test_voicemail_vm_info)</div><div class="line"><a name="l14936"></a><span class="lineno">14936</span>&#160;{</div><div class="line"><a name="l14937"></a><span class="lineno">14937</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l14938"></a><span class="lineno">14938</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l14939"></a><span class="lineno">14939</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> testcontext[] = <span class="stringliteral">&quot;test&quot;</span>;</div><div class="line"><a name="l14940"></a><span class="lineno">14940</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> testmailbox[] = <span class="stringliteral">&quot;00000000&quot;</span>;</div><div class="line"><a name="l14941"></a><span class="lineno">14941</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> vminfo_cmd[] = <span class="stringliteral">&quot;VM_INFO&quot;</span>;</div><div class="line"><a name="l14942"></a><span class="lineno">14942</span>&#160;   <span class="keywordtype">char</span> vminfo_buf[256], vminfo_args[256];</div><div class="line"><a name="l14943"></a><span class="lineno">14943</span>&#160;   <span class="keywordtype">int</span> res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a>;</div><div class="line"><a name="l14944"></a><span class="lineno">14944</span>&#160;   <span class="keywordtype">int</span> test_ret = 0;</div><div class="line"><a name="l14945"></a><span class="lineno">14945</span>&#160;   <span class="keywordtype">int</span> test_counter = 0;</div><div class="line"><a name="l14946"></a><span class="lineno">14946</span>&#160;</div><div class="line"><a name="l14947"></a><span class="lineno">14947</span>&#160;   <span class="keyword">struct </span>{</div><div class="line"><a name="l14948"></a><span class="lineno">14948</span>&#160;      <span class="keywordtype">char</span> *vminfo_test_args;</div><div class="line"><a name="l14949"></a><span class="lineno">14949</span>&#160;      <span class="keywordtype">char</span> *vminfo_expected;</div><div class="line"><a name="l14950"></a><span class="lineno">14950</span>&#160;      <span class="keywordtype">int</span> vminfo_ret;</div><div class="line"><a name="l14951"></a><span class="lineno">14951</span>&#160;   } test_items[] = {</div><div class="line"><a name="l14952"></a><span class="lineno">14952</span>&#160;      { <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, -1 },            <span class="comment">/* Missing argument */</span></div><div class="line"><a name="l14953"></a><span class="lineno">14953</span>&#160;      { <span class="stringliteral">&quot;00000000@test,badparam&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, -1 },  <span class="comment">/* Wrong argument */</span></div><div class="line"><a name="l14954"></a><span class="lineno">14954</span>&#160;      { <span class="stringliteral">&quot;00000000@test&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, -1 },     <span class="comment">/* Missing argument */</span></div><div class="line"><a name="l14955"></a><span class="lineno">14955</span>&#160;      { <span class="stringliteral">&quot;00000000@test,exists&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, 0 },</div><div class="line"><a name="l14956"></a><span class="lineno">14956</span>&#160;      { <span class="stringliteral">&quot;11111111@test,exists&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, 0 }, <span class="comment">/* Invalid mailbox */</span></div><div class="line"><a name="l14957"></a><span class="lineno">14957</span>&#160;      { <span class="stringliteral">&quot;00000000@test,email&quot;</span>, <span class="stringliteral">&quot;vm-info-test@example.net&quot;</span>, 0 },</div><div class="line"><a name="l14958"></a><span class="lineno">14958</span>&#160;      { <span class="stringliteral">&quot;11111111@test,email&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0 },   <span class="comment">/* Invalid mailbox */</span></div><div class="line"><a name="l14959"></a><span class="lineno">14959</span>&#160;      { <span class="stringliteral">&quot;00000000@test,fullname&quot;</span>, <span class="stringliteral">&quot;Test Framework Mailbox&quot;</span>, 0 },</div><div class="line"><a name="l14960"></a><span class="lineno">14960</span>&#160;      { <span class="stringliteral">&quot;00000000@test,pager&quot;</span>, <span class="stringliteral">&quot;vm-info-pager-test@example.net&quot;</span>, 0 },</div><div class="line"><a name="l14961"></a><span class="lineno">14961</span>&#160;      { <span class="stringliteral">&quot;00000000@test,locale&quot;</span>, <span class="stringliteral">&quot;en_US&quot;</span>, 0 },</div><div class="line"><a name="l14962"></a><span class="lineno">14962</span>&#160;      { <span class="stringliteral">&quot;00000000@test,tz&quot;</span>, <span class="stringliteral">&quot;central&quot;</span>, 0 },</div><div class="line"><a name="l14963"></a><span class="lineno">14963</span>&#160;      { <span class="stringliteral">&quot;00000000@test,language&quot;</span>, <span class="stringliteral">&quot;en&quot;</span>, 0 },</div><div class="line"><a name="l14964"></a><span class="lineno">14964</span>&#160;      { <span class="stringliteral">&quot;00000000@test,password&quot;</span>, <span class="stringliteral">&quot;9876&quot;</span>, 0 },</div><div class="line"><a name="l14965"></a><span class="lineno">14965</span>&#160;   };</div><div class="line"><a name="l14966"></a><span class="lineno">14966</span>&#160;</div><div class="line"><a name="l14967"></a><span class="lineno">14967</span>&#160;   <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l14968"></a><span class="lineno">14968</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a>:</div><div class="line"><a name="l14969"></a><span class="lineno">14969</span>&#160;         <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;name = <span class="stringliteral">&quot;test_voicemail_vm_info&quot;</span>;</div><div class="line"><a name="l14970"></a><span class="lineno">14970</span>&#160;         <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;category = <span class="stringliteral">&quot;/apps/app_voicemail/&quot;</span>;</div><div class="line"><a name="l14971"></a><span class="lineno">14971</span>&#160;         <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;summary = <span class="stringliteral">&quot;VM_INFO unit test&quot;</span>;</div><div class="line"><a name="l14972"></a><span class="lineno">14972</span>&#160;         <a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">info</a>-&gt;description =</div><div class="line"><a name="l14973"></a><span class="lineno">14973</span>&#160;            <span class="stringliteral">&quot;This tests passing various parameters to VM_INFO&quot;</span>;</div><div class="line"><a name="l14974"></a><span class="lineno">14974</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a>;</div><div class="line"><a name="l14975"></a><span class="lineno">14975</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a>:</div><div class="line"><a name="l14976"></a><span class="lineno">14976</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l14977"></a><span class="lineno">14977</span>&#160;   }</div><div class="line"><a name="l14978"></a><span class="lineno">14978</span>&#160;</div><div class="line"><a name="l14979"></a><span class="lineno">14979</span>&#160;   <span class="keywordflow">if</span> (!(chan = <a class="code" href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a>())) {</div><div class="line"><a name="l14980"></a><span class="lineno">14980</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Unable to create dummy channel\n&quot;</span>);</div><div class="line"><a name="l14981"></a><span class="lineno">14981</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14982"></a><span class="lineno">14982</span>&#160;   }</div><div class="line"><a name="l14983"></a><span class="lineno">14983</span>&#160;</div><div class="line"><a name="l14984"></a><span class="lineno">14984</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, testcontext, testmailbox)) &amp;&amp;</div><div class="line"><a name="l14985"></a><span class="lineno">14985</span>&#160;         !(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(testcontext, testmailbox))) {</div><div class="line"><a name="l14986"></a><span class="lineno">14986</span>&#160;      <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;Cannot create vmu structure\n&quot;</span>);</div><div class="line"><a name="l14987"></a><span class="lineno">14987</span>&#160;      chan = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(chan);</div><div class="line"><a name="l14988"></a><span class="lineno">14988</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l14989"></a><span class="lineno">14989</span>&#160;   }</div><div class="line"><a name="l14990"></a><span class="lineno">14990</span>&#160;</div><div class="line"><a name="l14991"></a><span class="lineno">14991</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l14992"></a><span class="lineno">14992</span>&#160;</div><div class="line"><a name="l14993"></a><span class="lineno">14993</span>&#160;   vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">email</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(<span class="stringliteral">&quot;vm-info-test@example.net&quot;</span>);</div><div class="line"><a name="l14994"></a><span class="lineno">14994</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, <span class="stringliteral">&quot;Test Framework Mailbox&quot;</span>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>));</div><div class="line"><a name="l14995"></a><span class="lineno">14995</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, <span class="stringliteral">&quot;vm-info-pager-test@example.net&quot;</span>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>));</div><div class="line"><a name="l14996"></a><span class="lineno">14996</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, <span class="stringliteral">&quot;en&quot;</span>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>));</div><div class="line"><a name="l14997"></a><span class="lineno">14997</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, <span class="stringliteral">&quot;central&quot;</span>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));</div><div class="line"><a name="l14998"></a><span class="lineno">14998</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">locale</a>, <span class="stringliteral">&quot;en_US&quot;</span>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));</div><div class="line"><a name="l14999"></a><span class="lineno">14999</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, <span class="stringliteral">&quot;9876&quot;</span>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));</div><div class="line"><a name="l15000"></a><span class="lineno">15000</span>&#160;</div><div class="line"><a name="l15001"></a><span class="lineno">15001</span>&#160;   <span class="keywordflow">for</span> (test_counter = 0; test_counter &lt; <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(test_items); test_counter++) {</div><div class="line"><a name="l15002"></a><span class="lineno">15002</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vminfo_args, test_items[test_counter].vminfo_test_args, <span class="keyword">sizeof</span>(vminfo_args));</div><div class="line"><a name="l15003"></a><span class="lineno">15003</span>&#160;      test_ret = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7f75e8f7c2c64f3b17397c3117fe2799">acf_vm_info</a>(chan, vminfo_cmd, vminfo_args, vminfo_buf, <span class="keyword">sizeof</span>(vminfo_buf));</div><div class="line"><a name="l15004"></a><span class="lineno">15004</span>&#160;      <span class="keywordflow">if</span> (strcmp(vminfo_buf, test_items[test_counter].vminfo_expected)) {</div><div class="line"><a name="l15005"></a><span class="lineno">15005</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;VM_INFO respose was: &#39;%s&#39;, but expected: &#39;%s&#39;\n&quot;</span>, vminfo_buf, test_items[test_counter].vminfo_expected);</div><div class="line"><a name="l15006"></a><span class="lineno">15006</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l15007"></a><span class="lineno">15007</span>&#160;      }</div><div class="line"><a name="l15008"></a><span class="lineno">15008</span>&#160;      <span class="keywordflow">if</span> (!(test_ret == test_items[test_counter].vminfo_ret)) {</div><div class="line"><a name="l15009"></a><span class="lineno">15009</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a>(<a class="code" href="../../d8/d89/structtest.html">test</a>, <span class="stringliteral">&quot;VM_INFO return code was: &#39;%i&#39;, but expected &#39;%i&#39;\n&quot;</span>, test_ret, test_items[test_counter].vminfo_ret);</div><div class="line"><a name="l15010"></a><span class="lineno">15010</span>&#160;         res = <a class="code" href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a>;</div><div class="line"><a name="l15011"></a><span class="lineno">15011</span>&#160;      }</div><div class="line"><a name="l15012"></a><span class="lineno">15012</span>&#160;   }</div><div class="line"><a name="l15013"></a><span class="lineno">15013</span>&#160;</div><div class="line"><a name="l15014"></a><span class="lineno">15014</span>&#160;   chan = <a class="code" href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a>(chan);</div><div class="line"><a name="l15015"></a><span class="lineno">15015</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l15016"></a><span class="lineno">15016</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15017"></a><span class="lineno">15017</span>&#160;}</div><div class="line"><a name="l15018"></a><span class="lineno">15018</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(TEST_FRAMEWORK) */</span><span class="preprocessor"></span></div><div class="line"><a name="l15019"></a><span class="lineno">15019</span>&#160;</div><div class="line"><a name="l15020"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">15020</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">vm_table</a> = {</div><div class="line"><a name="l15021"></a><span class="lineno">15021</span>&#160;   .<a class="code" href="../../df/d7c/structast__vm__functions.html#a19dd3d3916fd1aa9a70c45c43d24b6f5">module_version</a> = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a846b39f5cdf1508035ac658f26a5e933">VM_MODULE_VERSION</a>,</div><div class="line"><a name="l15022"></a><span class="lineno">15022</span>&#160;   .module_name = <a class="code" href="../../d9/daa/app__audiosocket_8c.html#aec23fc5034c3bb08140fc021f4955877">AST_MODULE</a>,</div><div class="line"><a name="l15023"></a><span class="lineno">15023</span>&#160;</div><div class="line"><a name="l15024"></a><span class="lineno">15024</span>&#160;   .has_voicemail = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a>,</div><div class="line"><a name="l15025"></a><span class="lineno">15025</span>&#160;   .inboxcount = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>,</div><div class="line"><a name="l15026"></a><span class="lineno">15026</span>&#160;   .inboxcount2 = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>,</div><div class="line"><a name="l15027"></a><span class="lineno">15027</span>&#160;   .messagecount = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>,</div><div class="line"><a name="l15028"></a><span class="lineno">15028</span>&#160;   .copy_recording_to_vm = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6261648db5348c63c5a399887cdc7bcb">msg_create_from_file</a>,</div><div class="line"><a name="l15029"></a><span class="lineno">15029</span>&#160;   .index_to_foldername = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6039669cd57ff47a2df5e25685b660c4">vm_index_to_foldername</a>,</div><div class="line"><a name="l15030"></a><span class="lineno">15030</span>&#160;   .mailbox_snapshot_create = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae48d2d40fd20f61d2324906383df2d6e">vm_mailbox_snapshot_create</a>,</div><div class="line"><a name="l15031"></a><span class="lineno">15031</span>&#160;   .mailbox_snapshot_destroy = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a654bcd2aee84a0c6d2f90e01f9b5acb8">vm_mailbox_snapshot_destroy</a>,</div><div class="line"><a name="l15032"></a><span class="lineno">15032</span>&#160;   .msg_move = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aea7a0b8f32697c42dd05115e26a114d8">vm_msg_move</a>,</div><div class="line"><a name="l15033"></a><span class="lineno">15033</span>&#160;   .msg_remove = <a class="code" href="../../dc/df4/app__voicemail_8c.html#abc03cd67e3d9bff7bde30ff5877c317f">vm_msg_remove</a>,</div><div class="line"><a name="l15034"></a><span class="lineno">15034</span>&#160;   .msg_forward = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90b1b36a3d0c11b8b335f20efe172552">vm_msg_forward</a>,</div><div class="line"><a name="l15035"></a><span class="lineno">15035</span>&#160;   .msg_play = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1a4393102d360b132fa006873ad4435c">vm_msg_play</a>,</div><div class="line"><a name="l15036"></a><span class="lineno">15036</span>&#160;};</div><div class="line"><a name="l15037"></a><span class="lineno">15037</span>&#160;</div><div class="line"><a name="l15038"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a63158d120e779bf4b9e4e9fc1f70553b">15038</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html">ast_vm_greeter_functions</a> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a63158d120e779bf4b9e4e9fc1f70553b">vm_greeter_table</a> = {</div><div class="line"><a name="l15039"></a><span class="lineno">15039</span>&#160;   .<a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a19dd3d3916fd1aa9a70c45c43d24b6f5">module_version</a> = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a789b147df36d769c1c0d55051f655c7f">VM_GREETER_MODULE_VERSION</a>,</div><div class="line"><a name="l15040"></a><span class="lineno">15040</span>&#160;   .module_name = <a class="code" href="../../d9/daa/app__audiosocket_8c.html#aec23fc5034c3bb08140fc021f4955877">AST_MODULE</a>,</div><div class="line"><a name="l15041"></a><span class="lineno">15041</span>&#160;</div><div class="line"><a name="l15042"></a><span class="lineno">15042</span>&#160;   .sayname = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f391f861982d42d13e6c08e00207abb">vm_sayname</a>,</div><div class="line"><a name="l15043"></a><span class="lineno">15043</span>&#160;};</div><div class="line"><a name="l15044"></a><span class="lineno">15044</span>&#160;</div><div class="line"><a name="l15045"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">15045</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l15046"></a><span class="lineno">15046</span>&#160;{</div><div class="line"><a name="l15047"></a><span class="lineno">15047</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(1);</div><div class="line"><a name="l15048"></a><span class="lineno">15048</span>&#160;}</div><div class="line"><a name="l15049"></a><span class="lineno">15049</span>&#160;</div><div class="line"><a name="l15050"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">15050</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l15051"></a><span class="lineno">15051</span>&#160;{</div><div class="line"><a name="l15052"></a><span class="lineno">15052</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l15053"></a><span class="lineno">15053</span>&#160;</div><div class="line"><a name="l15054"></a><span class="lineno">15054</span>&#160;   res = <a class="code" href="../../d5/d16/module_8h.html#ad2ca15621101154f29748cf1dac3c3cf">ast_unregister_application</a>(voicemail_app);</div><div class="line"><a name="l15055"></a><span class="lineno">15055</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#ad2ca15621101154f29748cf1dac3c3cf">ast_unregister_application</a>(voicemailmain_app);</div><div class="line"><a name="l15056"></a><span class="lineno">15056</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#ad2ca15621101154f29748cf1dac3c3cf">ast_unregister_application</a>(vmauthenticate_app);</div><div class="line"><a name="l15057"></a><span class="lineno">15057</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#ad2ca15621101154f29748cf1dac3c3cf">ast_unregister_application</a>(playmsg_app);</div><div class="line"><a name="l15058"></a><span class="lineno">15058</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#ad2ca15621101154f29748cf1dac3c3cf">ast_unregister_application</a>(sayname_app);</div><div class="line"><a name="l15059"></a><span class="lineno">15059</span>&#160;   res |= <a class="code" href="../../db/de0/pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1">ast_custom_function_unregister</a>(&amp;vm_info_acf);</div><div class="line"><a name="l15060"></a><span class="lineno">15060</span>&#160;   res |= <a class="code" href="../../df/d72/group__Group__AMI.html#gafadf012f66a9fd7ecf985ec5b9dee101">ast_manager_unregister</a>(<span class="stringliteral">&quot;VoicemailUsersList&quot;</span>);</div><div class="line"><a name="l15061"></a><span class="lineno">15061</span>&#160;   res |= <a class="code" href="../../df/d72/group__Group__AMI.html#gafadf012f66a9fd7ecf985ec5b9dee101">ast_manager_unregister</a>(<span class="stringliteral">&quot;VoicemailUserStatus&quot;</span>);</div><div class="line"><a name="l15062"></a><span class="lineno">15062</span>&#160;   res |= <a class="code" href="../../df/d72/group__Group__AMI.html#gafadf012f66a9fd7ecf985ec5b9dee101">ast_manager_unregister</a>(<span class="stringliteral">&quot;VoicemailRefresh&quot;</span>);</div><div class="line"><a name="l15063"></a><span class="lineno">15063</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l15064"></a><span class="lineno">15064</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a>(test_voicemail_vmsayname);</div><div class="line"><a name="l15065"></a><span class="lineno">15065</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a>(test_voicemail_msgcount);</div><div class="line"><a name="l15066"></a><span class="lineno">15066</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a>(test_voicemail_vmuser);</div><div class="line"><a name="l15067"></a><span class="lineno">15067</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a>(test_voicemail_notify_endl);</div><div class="line"><a name="l15068"></a><span class="lineno">15068</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a>(test_voicemail_load_config);</div><div class="line"><a name="l15069"></a><span class="lineno">15069</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a>(test_voicemail_vm_info);</div><div class="line"><a name="l15070"></a><span class="lineno">15070</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15071"></a><span class="lineno">15071</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09">ast_cli_unregister_multiple</a>(cli_voicemail, <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_voicemail));</div><div class="line"><a name="l15072"></a><span class="lineno">15072</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aab65d2013da7fcbb28da422712bac5e8">ast_vm_unregister</a>(vm_table.<a class="code" href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>);</div><div class="line"><a name="l15073"></a><span class="lineno">15073</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a50ae61db871bd4f0e0b8caa6c3e56810">ast_vm_greeter_unregister</a>(vm_greeter_table.<a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>);</div><div class="line"><a name="l15074"></a><span class="lineno">15074</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l15075"></a><span class="lineno">15075</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aec0281ec0a6743121492b2194649922f">ast_uninstall_vm_test_functions</a>();</div><div class="line"><a name="l15076"></a><span class="lineno">15076</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15077"></a><span class="lineno">15077</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(inprocess_container, -1);</div><div class="line"><a name="l15078"></a><span class="lineno">15078</span>&#160;</div><div class="line"><a name="l15079"></a><span class="lineno">15079</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a4b8c1cca9dace1cf1bbadc5039f3dedf">ao2_container_unregister</a>(<span class="stringliteral">&quot;voicemail_alias_mailbox_mappings&quot;</span>);</div><div class="line"><a name="l15080"></a><span class="lineno">15080</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(alias_mailbox_mappings);</div><div class="line"><a name="l15081"></a><span class="lineno">15081</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a4b8c1cca9dace1cf1bbadc5039f3dedf">ao2_container_unregister</a>(<span class="stringliteral">&quot;voicemail_mailbox_alias_mappings&quot;</span>);</div><div class="line"><a name="l15082"></a><span class="lineno">15082</span>&#160;   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(mailbox_alias_mappings);</div><div class="line"><a name="l15083"></a><span class="lineno">15083</span>&#160;</div><div class="line"><a name="l15084"></a><span class="lineno">15084</span>&#160;   <span class="keywordflow">if</span> (poll_thread != <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)</div><div class="line"><a name="l15085"></a><span class="lineno">15085</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a>();</div><div class="line"><a name="l15086"></a><span class="lineno">15086</span>&#160;</div><div class="line"><a name="l15087"></a><span class="lineno">15087</span>&#160;   mwi_subscription_tps = <a class="code" href="../../d0/d1e/taskprocessor_8h.html#a32492eb2480cb8c46ad669622cff8556">ast_taskprocessor_unreference</a>(mwi_subscription_tps);</div><div class="line"><a name="l15088"></a><span class="lineno">15088</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>);</div><div class="line"><a name="l15089"></a><span class="lineno">15089</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>);</div><div class="line"><a name="l15090"></a><span class="lineno">15090</span>&#160;</div><div class="line"><a name="l15091"></a><span class="lineno">15091</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l15092"></a><span class="lineno">15092</span>&#160;   <a class="code" href="../../dc/d33/mwi_8h.html#aa7789090f6f6177b5033d240bba65b93">ast_mwi_state_callback_all</a>(imap_close_subscribed_mailbox, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15093"></a><span class="lineno">15093</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15094"></a><span class="lineno">15094</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101">free_vm_users</a>();</div><div class="line"><a name="l15095"></a><span class="lineno">15095</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473">free_vm_zones</a>();</div><div class="line"><a name="l15096"></a><span class="lineno">15096</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15097"></a><span class="lineno">15097</span>&#160;}</div><div class="line"><a name="l15098"></a><span class="lineno">15098</span>&#160;</div><div class="line"><a name="l15099"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a70050c138d17b318c0677ec4218064d3">15099</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a70050c138d17b318c0677ec4218064d3">print_mappings</a>(<span class="keywordtype">void</span> *v_obj, <span class="keywordtype">void</span> *where, <a class="code" href="../../d5/da5/astobj2_8h.html#af236ed10cd1eddcbad0579ed0cf9f4c5">ao2_prnt_fn</a> *prnt)</div><div class="line"><a name="l15100"></a><span class="lineno">15100</span>&#160;{</div><div class="line"><a name="l15101"></a><span class="lineno">15101</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a> *mapping = v_obj;</div><div class="line"><a name="l15102"></a><span class="lineno">15102</span>&#160;</div><div class="line"><a name="l15103"></a><span class="lineno">15103</span>&#160;   <span class="keywordflow">if</span> (!mapping) {</div><div class="line"><a name="l15104"></a><span class="lineno">15104</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l15105"></a><span class="lineno">15105</span>&#160;   }</div><div class="line"><a name="l15106"></a><span class="lineno">15106</span>&#160;   prnt(where, <span class="stringliteral">&quot;Alias: %s Mailbox: %s&quot;</span>, mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias</a>, mapping-&gt;<a class="code" href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox</a>);</div><div class="line"><a name="l15107"></a><span class="lineno">15107</span>&#160;}</div><div class="line"><a name="l15108"></a><span class="lineno">15108</span>&#160;<span class="comment"></span></div><div class="line"><a name="l15109"></a><span class="lineno">15109</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l15110"></a><span class="lineno">15110</span>&#160;<span class="comment"> * \brief Load the module</span></div><div class="line"><a name="l15111"></a><span class="lineno">15111</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15112"></a><span class="lineno">15112</span>&#160;<span class="comment"> * Module loading including tests for configuration or dependencies.</span></div><div class="line"><a name="l15113"></a><span class="lineno">15113</span>&#160;<span class="comment"> * This function can return AST_MODULE_LOAD_FAILURE, AST_MODULE_LOAD_DECLINE,</span></div><div class="line"><a name="l15114"></a><span class="lineno">15114</span>&#160;<span class="comment"> * or AST_MODULE_LOAD_SUCCESS.</span></div><div class="line"><a name="l15115"></a><span class="lineno">15115</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15116"></a><span class="lineno">15116</span>&#160;<span class="comment"> * If a dependency, allocation or environment variable fails tests, return AST_MODULE_LOAD_FAILURE.</span></div><div class="line"><a name="l15117"></a><span class="lineno">15117</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15118"></a><span class="lineno">15118</span>&#160;<span class="comment"> * If the module can&#39;t load the configuration file, can&#39;t register as a provider or</span></div><div class="line"><a name="l15119"></a><span class="lineno">15119</span>&#160;<span class="comment"> * has another issue not fatal to Asterisk itself, return AST_MODULE_LOAD_DECLINE.</span></div><div class="line"><a name="l15120"></a><span class="lineno">15120</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15121"></a><span class="lineno">15121</span>&#160;<span class="comment"> * On success return AST_MODULE_LOAD_SUCCESS.</span></div><div class="line"><a name="l15122"></a><span class="lineno">15122</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l15123"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">15123</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l15124"></a><span class="lineno">15124</span>&#160;{</div><div class="line"><a name="l15125"></a><span class="lineno">15125</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l15126"></a><span class="lineno">15126</span>&#160;   my_umask = umask(0);</div><div class="line"><a name="l15127"></a><span class="lineno">15127</span>&#160;   umask(my_umask);</div><div class="line"><a name="l15128"></a><span class="lineno">15128</span>&#160;</div><div class="line"><a name="l15129"></a><span class="lineno">15129</span>&#160;   inprocess_container = <a class="code" href="../../d5/da5/astobj2_8h.html#aefc16f8aa9087cbc5c55c70cf1dd41b2">ao2_container_alloc_hash</a>(<a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a8ccf751bd6749d062999469f0694e7ad">AO2_ALLOC_OPT_LOCK_MUTEX</a>, 0, 573,</div><div class="line"><a name="l15130"></a><span class="lineno">15130</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039">inprocess_hash_fn</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90">inprocess_cmp_fn</a>);</div><div class="line"><a name="l15131"></a><span class="lineno">15131</span>&#160;   <span class="keywordflow">if</span> (!inprocess_container) {</div><div class="line"><a name="l15132"></a><span class="lineno">15132</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15133"></a><span class="lineno">15133</span>&#160;   }</div><div class="line"><a name="l15134"></a><span class="lineno">15134</span>&#160;</div><div class="line"><a name="l15135"></a><span class="lineno">15135</span>&#160;   alias_mailbox_mappings = <a class="code" href="../../d5/da5/astobj2_8h.html#aefc16f8aa9087cbc5c55c70cf1dd41b2">ao2_container_alloc_hash</a>(<a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a8ccf751bd6749d062999469f0694e7ad">AO2_ALLOC_OPT_LOCK_MUTEX</a>, 0, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384d700a5c87a2551e5ee6ed5ab6b548">MAPPING_BUCKETS</a>,</div><div class="line"><a name="l15136"></a><span class="lineno">15136</span>&#160;      alias_mailbox_mapping_hash_fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, alias_mailbox_mapping_cmp_fn);</div><div class="line"><a name="l15137"></a><span class="lineno">15137</span>&#160;   <span class="keywordflow">if</span> (!alias_mailbox_mappings) {</div><div class="line"><a name="l15138"></a><span class="lineno">15138</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create alias_mailbox_mappings container\n&quot;</span>);</div><div class="line"><a name="l15139"></a><span class="lineno">15139</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(inprocess_container);</div><div class="line"><a name="l15140"></a><span class="lineno">15140</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15141"></a><span class="lineno">15141</span>&#160;   }</div><div class="line"><a name="l15142"></a><span class="lineno">15142</span>&#160;   res = <a class="code" href="../../d5/da5/astobj2_8h.html#abdb952d2373503555d96f02f130c5770">ao2_container_register</a>(<span class="stringliteral">&quot;voicemail_alias_mailbox_mappings&quot;</span>, alias_mailbox_mappings, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a70050c138d17b318c0677ec4218064d3">print_mappings</a>);</div><div class="line"><a name="l15143"></a><span class="lineno">15143</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15144"></a><span class="lineno">15144</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register alias_mailbox_mappings container\n&quot;</span>);</div><div class="line"><a name="l15145"></a><span class="lineno">15145</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(inprocess_container);</div><div class="line"><a name="l15146"></a><span class="lineno">15146</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(alias_mailbox_mappings);</div><div class="line"><a name="l15147"></a><span class="lineno">15147</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15148"></a><span class="lineno">15148</span>&#160;   }</div><div class="line"><a name="l15149"></a><span class="lineno">15149</span>&#160;</div><div class="line"><a name="l15150"></a><span class="lineno">15150</span>&#160;   mailbox_alias_mappings = <a class="code" href="../../d5/da5/astobj2_8h.html#aefc16f8aa9087cbc5c55c70cf1dd41b2">ao2_container_alloc_hash</a>(<a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a8ccf751bd6749d062999469f0694e7ad">AO2_ALLOC_OPT_LOCK_MUTEX</a>, 0, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a384d700a5c87a2551e5ee6ed5ab6b548">MAPPING_BUCKETS</a>,</div><div class="line"><a name="l15151"></a><span class="lineno">15151</span>&#160;      mailbox_alias_mapping_hash_fn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mailbox_alias_mapping_cmp_fn);</div><div class="line"><a name="l15152"></a><span class="lineno">15152</span>&#160;   <span class="keywordflow">if</span> (!mailbox_alias_mappings) {</div><div class="line"><a name="l15153"></a><span class="lineno">15153</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create mailbox_alias_mappings container\n&quot;</span>);</div><div class="line"><a name="l15154"></a><span class="lineno">15154</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(inprocess_container);</div><div class="line"><a name="l15155"></a><span class="lineno">15155</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a4b8c1cca9dace1cf1bbadc5039f3dedf">ao2_container_unregister</a>(<span class="stringliteral">&quot;voicemail_alias_mailbox_mappings&quot;</span>);</div><div class="line"><a name="l15156"></a><span class="lineno">15156</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(alias_mailbox_mappings);</div><div class="line"><a name="l15157"></a><span class="lineno">15157</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15158"></a><span class="lineno">15158</span>&#160;   }</div><div class="line"><a name="l15159"></a><span class="lineno">15159</span>&#160;   res = <a class="code" href="../../d5/da5/astobj2_8h.html#abdb952d2373503555d96f02f130c5770">ao2_container_register</a>(<span class="stringliteral">&quot;voicemail_mailbox_alias_mappings&quot;</span>, mailbox_alias_mappings, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a70050c138d17b318c0677ec4218064d3">print_mappings</a>);</div><div class="line"><a name="l15160"></a><span class="lineno">15160</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15161"></a><span class="lineno">15161</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register mailbox_alias_mappings container\n&quot;</span>);</div><div class="line"><a name="l15162"></a><span class="lineno">15162</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(inprocess_container);</div><div class="line"><a name="l15163"></a><span class="lineno">15163</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a4b8c1cca9dace1cf1bbadc5039f3dedf">ao2_container_unregister</a>(<span class="stringliteral">&quot;voicemail_alias_mailbox_mappings&quot;</span>);</div><div class="line"><a name="l15164"></a><span class="lineno">15164</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(alias_mailbox_mappings);</div><div class="line"><a name="l15165"></a><span class="lineno">15165</span>&#160;      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(mailbox_alias_mappings);</div><div class="line"><a name="l15166"></a><span class="lineno">15166</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15167"></a><span class="lineno">15167</span>&#160;   }</div><div class="line"><a name="l15168"></a><span class="lineno">15168</span>&#160;</div><div class="line"><a name="l15169"></a><span class="lineno">15169</span>&#160;   <span class="comment">/* compute the location of the voicemail spool directory */</span></div><div class="line"><a name="l15170"></a><span class="lineno">15170</span>&#160;   snprintf(VM_SPOOL_DIR, <span class="keyword">sizeof</span>(VM_SPOOL_DIR), <span class="stringliteral">&quot;%s/voicemail/&quot;</span>, <a class="code" href="../../dd/df2/paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>);</div><div class="line"><a name="l15171"></a><span class="lineno">15171</span>&#160;</div><div class="line"><a name="l15172"></a><span class="lineno">15172</span>&#160;   <span class="keywordflow">if</span> (!(mwi_subscription_tps = <a class="code" href="../../d0/d1e/taskprocessor_8h.html#ac999cc9523590a29dff6acbd9cad24a9">ast_taskprocessor_get</a>(<span class="stringliteral">&quot;app_voicemail&quot;</span>, 0))) {</div><div class="line"><a name="l15173"></a><span class="lineno">15173</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;failed to reference mwi subscription taskprocessor.  MWI will not work\n&quot;</span>);</div><div class="line"><a name="l15174"></a><span class="lineno">15174</span>&#160;   }</div><div class="line"><a name="l15175"></a><span class="lineno">15175</span>&#160;</div><div class="line"><a name="l15176"></a><span class="lineno">15176</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(0))) {</div><div class="line"><a name="l15177"></a><span class="lineno">15177</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a>();</div><div class="line"><a name="l15178"></a><span class="lineno">15178</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15179"></a><span class="lineno">15179</span>&#160;   }</div><div class="line"><a name="l15180"></a><span class="lineno">15180</span>&#160;</div><div class="line"><a name="l15181"></a><span class="lineno">15181</span>&#160;   res = <a class="code" href="../../d5/d16/module_8h.html#afba4eb7a910b10969041ae4cd488729d">ast_register_application_xml</a>(voicemail_app, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4ace316d9392f91668365780d1c2d020">vm_exec</a>);</div><div class="line"><a name="l15182"></a><span class="lineno">15182</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#afba4eb7a910b10969041ae4cd488729d">ast_register_application_xml</a>(voicemailmain_app, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a31a8413227dec93cd93ebd54bc3b42c7">vm_execmain</a>);</div><div class="line"><a name="l15183"></a><span class="lineno">15183</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#afba4eb7a910b10969041ae4cd488729d">ast_register_application_xml</a>(vmauthenticate_app, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3b021ce22e11ba21591a3907cbbc12d8">vmauthenticate</a>);</div><div class="line"><a name="l15184"></a><span class="lineno">15184</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#afba4eb7a910b10969041ae4cd488729d">ast_register_application_xml</a>(playmsg_app, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a54a9f8be551279c23e515e58a2bfee68">vm_playmsgexec</a>);</div><div class="line"><a name="l15185"></a><span class="lineno">15185</span>&#160;   res |= <a class="code" href="../../d5/d16/module_8h.html#afba4eb7a910b10969041ae4cd488729d">ast_register_application_xml</a>(sayname_app, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6a1f2d69e0b6037e9ecd403ec97c0867">vmsayname_exec</a>);</div><div class="line"><a name="l15186"></a><span class="lineno">15186</span>&#160;   res |= <a class="code" href="../../db/de0/pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b">ast_custom_function_register</a>(&amp;vm_info_acf);</div><div class="line"><a name="l15187"></a><span class="lineno">15187</span>&#160;   res |= <a class="code" href="../../db/d45/manager_8h.html#a5b63b8a8faede2d852e071e1f7b31c11">ast_manager_register_xml</a>(<span class="stringliteral">&quot;VoicemailUsersList&quot;</span>, <a class="code" href="../../db/d45/manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a> | <a class="code" href="../../db/d45/manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752">manager_list_voicemail_users</a>);</div><div class="line"><a name="l15188"></a><span class="lineno">15188</span>&#160;   res |= <a class="code" href="../../db/d45/manager_8h.html#a5b63b8a8faede2d852e071e1f7b31c11">ast_manager_register_xml</a>(<span class="stringliteral">&quot;VoicemailUserStatus&quot;</span>, <a class="code" href="../../db/d45/manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a> | <a class="code" href="../../db/d45/manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad6fa7eabdb6693aa433127102cd7abcd">manager_status_voicemail_user</a>);</div><div class="line"><a name="l15189"></a><span class="lineno">15189</span>&#160;   res |= <a class="code" href="../../db/d45/manager_8h.html#a5b63b8a8faede2d852e071e1f7b31c11">ast_manager_register_xml</a>(<span class="stringliteral">&quot;VoicemailRefresh&quot;</span>, <a class="code" href="../../db/d45/manager_8h.html#acc12c2bc03dce67ddd1590d67ab11f4d">EVENT_FLAG_USER</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1663f2d08dd7c882b4eda7a725bbf275">manager_voicemail_refresh</a>);</div><div class="line"><a name="l15190"></a><span class="lineno">15190</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l15191"></a><span class="lineno">15191</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a>(test_voicemail_vmsayname);</div><div class="line"><a name="l15192"></a><span class="lineno">15192</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a>(test_voicemail_msgcount);</div><div class="line"><a name="l15193"></a><span class="lineno">15193</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a>(test_voicemail_vmuser);</div><div class="line"><a name="l15194"></a><span class="lineno">15194</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a>(test_voicemail_notify_endl);</div><div class="line"><a name="l15195"></a><span class="lineno">15195</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a>(test_voicemail_load_config);</div><div class="line"><a name="l15196"></a><span class="lineno">15196</span>&#160;   res |= <a class="code" href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a>(test_voicemail_vm_info);</div><div class="line"><a name="l15197"></a><span class="lineno">15197</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15198"></a><span class="lineno">15198</span>&#160;</div><div class="line"><a name="l15199"></a><span class="lineno">15199</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15200"></a><span class="lineno">15200</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failure registering applications, functions or tests\n&quot;</span>);</div><div class="line"><a name="l15201"></a><span class="lineno">15201</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a>();</div><div class="line"><a name="l15202"></a><span class="lineno">15202</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15203"></a><span class="lineno">15203</span>&#160;   }</div><div class="line"><a name="l15204"></a><span class="lineno">15204</span>&#160;</div><div class="line"><a name="l15205"></a><span class="lineno">15205</span>&#160;   <span class="comment">/* ast_vm_register may return DECLINE if another module registered for vm */</span></div><div class="line"><a name="l15206"></a><span class="lineno">15206</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ab0f11affd99d055b676f1b883fb486a8">ast_vm_register</a>(&amp;vm_table);</div><div class="line"><a name="l15207"></a><span class="lineno">15207</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15208"></a><span class="lineno">15208</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failure registering as a voicemail provider\n&quot;</span>);</div><div class="line"><a name="l15209"></a><span class="lineno">15209</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a>();</div><div class="line"><a name="l15210"></a><span class="lineno">15210</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15211"></a><span class="lineno">15211</span>&#160;   }</div><div class="line"><a name="l15212"></a><span class="lineno">15212</span>&#160;</div><div class="line"><a name="l15213"></a><span class="lineno">15213</span>&#160;   <span class="comment">/* ast_vm_greeter_register may return DECLINE if another module registered as a greeter */</span></div><div class="line"><a name="l15214"></a><span class="lineno">15214</span>&#160;   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ae574544d8785072b67887b3aaff45af0">ast_vm_greeter_register</a>(&amp;vm_greeter_table);</div><div class="line"><a name="l15215"></a><span class="lineno">15215</span>&#160;   <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15216"></a><span class="lineno">15216</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failure registering as a greeter provider\n&quot;</span>);</div><div class="line"><a name="l15217"></a><span class="lineno">15217</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a>();</div><div class="line"><a name="l15218"></a><span class="lineno">15218</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line"><a name="l15219"></a><span class="lineno">15219</span>&#160;   }</div><div class="line"><a name="l15220"></a><span class="lineno">15220</span>&#160;</div><div class="line"><a name="l15221"></a><span class="lineno">15221</span>&#160;   <a class="code" href="../../dc/db0/cli_8h.html#aea8910ed9e301e7f741f87942c244eac">ast_cli_register_multiple</a>(cli_voicemail, <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_voicemail));</div><div class="line"><a name="l15222"></a><span class="lineno">15222</span>&#160;</div><div class="line"><a name="l15223"></a><span class="lineno">15223</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l15224"></a><span class="lineno">15224</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a479e9d3cae1218f0f55e27d874a07a96">ast_install_vm_test_functions</a>(<a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3dbfac8e2b5d54afabfa52585d42873">vm_test_create_user</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a07c88336f106270f57593724e39f0604">vm_test_destroy_user</a>);</div><div class="line"><a name="l15225"></a><span class="lineno">15225</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15226"></a><span class="lineno">15226</span>&#160;</div><div class="line"><a name="l15227"></a><span class="lineno">15227</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4">ast_realtime_require_field</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;uniqueid&quot;</span>, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a>, 11, <span class="stringliteral">&quot;password&quot;</span>, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, 10, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l15228"></a><span class="lineno">15228</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4">ast_realtime_require_field</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, 30, <span class="stringliteral">&quot;duration&quot;</span>, <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a>, 5, <a class="code" href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);</div><div class="line"><a name="l15229"></a><span class="lineno">15229</span>&#160;</div><div class="line"><a name="l15230"></a><span class="lineno">15230</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;</div><div class="line"><a name="l15231"></a><span class="lineno">15231</span>&#160;}</div><div class="line"><a name="l15232"></a><span class="lineno">15232</span>&#160;</div><div class="line"><a name="l15233"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">15233</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *num, <span class="keywordtype">char</span> *outgoing_context)</div><div class="line"><a name="l15234"></a><span class="lineno">15234</span>&#160;{</div><div class="line"><a name="l15235"></a><span class="lineno">15235</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l15236"></a><span class="lineno">15236</span>&#160;   <span class="keywordtype">char</span> destination[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l15237"></a><span class="lineno">15237</span>&#160;   <span class="keywordtype">int</span> retries = 0;</div><div class="line"><a name="l15238"></a><span class="lineno">15238</span>&#160;</div><div class="line"><a name="l15239"></a><span class="lineno">15239</span>&#160;   <span class="keywordflow">if</span> (!num) {</div><div class="line"><a name="l15240"></a><span class="lineno">15240</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Destination number will be entered manually\n&quot;</span>);</div><div class="line"><a name="l15241"></a><span class="lineno">15241</span>&#160;      <span class="keywordflow">while</span> (retries &lt; 3 &amp;&amp; cmd != <span class="charliteral">&#39;t&#39;</span>) {</div><div class="line"><a name="l15242"></a><span class="lineno">15242</span>&#160;         destination[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l15243"></a><span class="lineno">15243</span>&#160;         destination[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-enter-num-to-call&quot;</span>);</div><div class="line"><a name="l15244"></a><span class="lineno">15244</span>&#160;         <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15245"></a><span class="lineno">15245</span>&#160;            destination[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-then-pound&quot;</span>);</div><div class="line"><a name="l15246"></a><span class="lineno">15246</span>&#160;         <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15247"></a><span class="lineno">15247</span>&#160;            destination[0] = cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-star-cancel&quot;</span>);</div><div class="line"><a name="l15248"></a><span class="lineno">15248</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l15249"></a><span class="lineno">15249</span>&#160;            cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l15250"></a><span class="lineno">15250</span>&#160;            <span class="keywordflow">if</span> (cmd)</div><div class="line"><a name="l15251"></a><span class="lineno">15251</span>&#160;               destination[0] = cmd;</div><div class="line"><a name="l15252"></a><span class="lineno">15252</span>&#160;         }</div><div class="line"><a name="l15253"></a><span class="lineno">15253</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l15254"></a><span class="lineno">15254</span>&#160;            retries++;</div><div class="line"><a name="l15255"></a><span class="lineno">15255</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15256"></a><span class="lineno">15256</span>&#160;</div><div class="line"><a name="l15257"></a><span class="lineno">15257</span>&#160;            <span class="keywordflow">if</span> (cmd &lt; 0)</div><div class="line"><a name="l15258"></a><span class="lineno">15258</span>&#160;               <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15259"></a><span class="lineno">15259</span>&#160;            <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l15260"></a><span class="lineno">15260</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hit &#39;*&#39; to cancel outgoing call\n&quot;</span>);</div><div class="line"><a name="l15261"></a><span class="lineno">15261</span>&#160;               <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15262"></a><span class="lineno">15262</span>&#160;            }</div><div class="line"><a name="l15263"></a><span class="lineno">15263</span>&#160;            <span class="keywordflow">if</span> ((cmd = <a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, destination + strlen(destination), <span class="keyword">sizeof</span>(destination) - 1, 6000, 10000, <span class="stringliteral">&quot;#&quot;</span>)) &lt; 0)</div><div class="line"><a name="l15264"></a><span class="lineno">15264</span>&#160;               retries++;</div><div class="line"><a name="l15265"></a><span class="lineno">15265</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l15266"></a><span class="lineno">15266</span>&#160;               cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15267"></a><span class="lineno">15267</span>&#160;         }</div><div class="line"><a name="l15268"></a><span class="lineno">15268</span>&#160;         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l15269"></a><span class="lineno">15269</span>&#160;            isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>, isprint(cmd) ? cmd : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l15270"></a><span class="lineno">15270</span>&#160;      }</div><div class="line"><a name="l15271"></a><span class="lineno">15271</span>&#160;      <span class="keywordflow">if</span> (retries &gt;= 3) {</div><div class="line"><a name="l15272"></a><span class="lineno">15272</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15273"></a><span class="lineno">15273</span>&#160;      }</div><div class="line"><a name="l15274"></a><span class="lineno">15274</span>&#160;</div><div class="line"><a name="l15275"></a><span class="lineno">15275</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15276"></a><span class="lineno">15276</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Destination number is CID number &#39;%s&#39;\n&quot;</span>, num);</div><div class="line"><a name="l15277"></a><span class="lineno">15277</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(destination, num, <span class="keyword">sizeof</span>(destination));</div><div class="line"><a name="l15278"></a><span class="lineno">15278</span>&#160;   }</div><div class="line"><a name="l15279"></a><span class="lineno">15279</span>&#160;</div><div class="line"><a name="l15280"></a><span class="lineno">15280</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(destination)) {</div><div class="line"><a name="l15281"></a><span class="lineno">15281</span>&#160;      <span class="keywordflow">if</span> (destination[strlen(destination) -1 ] == <span class="charliteral">&#39;*&#39;</span>)</div><div class="line"><a name="l15282"></a><span class="lineno">15282</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15283"></a><span class="lineno">15283</span>&#160;      <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Placing outgoing call to extension &#39;%s&#39; in context &#39;%s&#39; from context &#39;%s&#39;\n&quot;</span>, destination, outgoing_context, <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(chan));</div><div class="line"><a name="l15284"></a><span class="lineno">15284</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#a018b7a29cef2d62074dc46e9aaad0d1a">ast_channel_exten_set</a>(chan, destination);</div><div class="line"><a name="l15285"></a><span class="lineno">15285</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a>(chan, outgoing_context);</div><div class="line"><a name="l15286"></a><span class="lineno">15286</span>&#160;      <a class="code" href="../../d5/d7b/channel_8h.html#ae56cab679c0cda6436b930bc74297895">ast_channel_priority_set</a>(chan, 0);</div><div class="line"><a name="l15287"></a><span class="lineno">15287</span>&#160;      <span class="keywordflow">return</span> 9;</div><div class="line"><a name="l15288"></a><span class="lineno">15288</span>&#160;   }</div><div class="line"><a name="l15289"></a><span class="lineno">15289</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15290"></a><span class="lineno">15290</span>&#160;}</div><div class="line"><a name="l15291"></a><span class="lineno">15291</span>&#160;<span class="comment"></span></div><div class="line"><a name="l15292"></a><span class="lineno">15292</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l15293"></a><span class="lineno">15293</span>&#160;<span class="comment"> * \brief The advanced options within a message.</span></div><div class="line"><a name="l15294"></a><span class="lineno">15294</span>&#160;<span class="comment"> * \param chan</span></div><div class="line"><a name="l15295"></a><span class="lineno">15295</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l15296"></a><span class="lineno">15296</span>&#160;<span class="comment"> * \param vms</span></div><div class="line"><a name="l15297"></a><span class="lineno">15297</span>&#160;<span class="comment"> * \param msg</span></div><div class="line"><a name="l15298"></a><span class="lineno">15298</span>&#160;<span class="comment"> * \param option</span></div><div class="line"><a name="l15299"></a><span class="lineno">15299</span>&#160;<span class="comment"> * \param record_gain</span></div><div class="line"><a name="l15300"></a><span class="lineno">15300</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15301"></a><span class="lineno">15301</span>&#160;<span class="comment"> * Provides handling for the play message envelope, call the person back, or reply to message.</span></div><div class="line"><a name="l15302"></a><span class="lineno">15302</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15303"></a><span class="lineno">15303</span>&#160;<span class="comment"> * \return zero on success, -1 on error.</span></div><div class="line"><a name="l15304"></a><span class="lineno">15304</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l15305"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">15305</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">advanced_options</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msg, <span class="keywordtype">int</span> option, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)</div><div class="line"><a name="l15306"></a><span class="lineno">15306</span>&#160;{</div><div class="line"><a name="l15307"></a><span class="lineno">15307</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l15308"></a><span class="lineno">15308</span>&#160;   <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l15309"></a><span class="lineno">15309</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15310"></a><span class="lineno">15310</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime, *<a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;</div><div class="line"><a name="l15311"></a><span class="lineno">15311</span>&#160;   <span class="keywordtype">char</span> *<a class="code" href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a>, *num;</div><div class="line"><a name="l15312"></a><span class="lineno">15312</span>&#160;   <span class="keywordtype">int</span> retries = 0;</div><div class="line"><a name="l15313"></a><span class="lineno">15313</span>&#160;   <span class="keywordtype">char</span> *cid;</div><div class="line"><a name="l15314"></a><span class="lineno">15314</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a>, };</div><div class="line"><a name="l15315"></a><span class="lineno">15315</span>&#160;</div><div class="line"><a name="l15316"></a><span class="lineno">15316</span>&#160;   vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 0;</div><div class="line"><a name="l15317"></a><span class="lineno">15317</span>&#160;</div><div class="line"><a name="l15318"></a><span class="lineno">15318</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, msg);</div><div class="line"><a name="l15319"></a><span class="lineno">15319</span>&#160;</div><div class="line"><a name="l15320"></a><span class="lineno">15320</span>&#160;   <span class="comment">/* Retrieve info from VM attribute file */</span></div><div class="line"><a name="l15321"></a><span class="lineno">15321</span>&#160;   snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l15322"></a><span class="lineno">15322</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l15323"></a><span class="lineno">15323</span>&#160;   msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l15324"></a><span class="lineno">15324</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l15325"></a><span class="lineno">15325</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a>(msg_cfg)) {</div><div class="line"><a name="l15326"></a><span class="lineno">15326</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No message attribute file?!! (%s)\n&quot;</span>, filename);</div><div class="line"><a name="l15327"></a><span class="lineno">15327</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15328"></a><span class="lineno">15328</span>&#160;   }</div><div class="line"><a name="l15329"></a><span class="lineno">15329</span>&#160;</div><div class="line"><a name="l15330"></a><span class="lineno">15330</span>&#160;   <span class="keywordflow">if</span> (!(origtime = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {</div><div class="line"><a name="l15331"></a><span class="lineno">15331</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15332"></a><span class="lineno">15332</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15333"></a><span class="lineno">15333</span>&#160;   }</div><div class="line"><a name="l15334"></a><span class="lineno">15334</span>&#160;</div><div class="line"><a name="l15335"></a><span class="lineno">15335</span>&#160;   cid = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(<a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>));</div><div class="line"><a name="l15336"></a><span class="lineno">15336</span>&#160;</div><div class="line"><a name="l15337"></a><span class="lineno">15337</span>&#160;   context = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>);</div><div class="line"><a name="l15338"></a><span class="lineno">15338</span>&#160;   <span class="keywordflow">if</span> (!strncasecmp(<span class="stringliteral">&quot;macro&quot;</span>, context, 5)) <span class="comment">/* Macro names in contexts are useless for our needs */</span></div><div class="line"><a name="l15339"></a><span class="lineno">15339</span>&#160;      context = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;macrocontext&quot;</span>);</div><div class="line"><a name="l15340"></a><span class="lineno">15340</span>&#160;   <span class="keywordflow">switch</span> (option) {</div><div class="line"><a name="l15341"></a><span class="lineno">15341</span>&#160;   <span class="keywordflow">case</span> 3: <span class="comment">/* Play message envelope */</span></div><div class="line"><a name="l15342"></a><span class="lineno">15342</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l15343"></a><span class="lineno">15343</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a>(chan, vmu, origtime, filename);</div><div class="line"><a name="l15344"></a><span class="lineno">15344</span>&#160;      }</div><div class="line"><a name="l15345"></a><span class="lineno">15345</span>&#160;      <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l15346"></a><span class="lineno">15346</span>&#160;         res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fe40961f76694db47fb14e7b19ade9b">play_message_callerid</a>(chan, vms, cid, context, 0, 1);</div><div class="line"><a name="l15347"></a><span class="lineno">15347</span>&#160;      }</div><div class="line"><a name="l15348"></a><span class="lineno">15348</span>&#160;</div><div class="line"><a name="l15349"></a><span class="lineno">15349</span>&#160;      res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15350"></a><span class="lineno">15350</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l15351"></a><span class="lineno">15351</span>&#160;</div><div class="line"><a name="l15352"></a><span class="lineno">15352</span>&#160;   <span class="keywordflow">case</span> 2:  <span class="comment">/* Call back */</span></div><div class="line"><a name="l15353"></a><span class="lineno">15353</span>&#160;</div><div class="line"><a name="l15354"></a><span class="lineno">15354</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cid))</div><div class="line"><a name="l15355"></a><span class="lineno">15355</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15356"></a><span class="lineno">15356</span>&#160;</div><div class="line"><a name="l15357"></a><span class="lineno">15357</span>&#160;      <a class="code" href="../../de/d47/callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df">ast_callerid_parse</a>(cid, &amp;name, &amp;num);</div><div class="line"><a name="l15358"></a><span class="lineno">15358</span>&#160;      <span class="keywordflow">while</span> ((res &gt; -1) &amp;&amp; (res != <span class="charliteral">&#39;t&#39;</span>)) {</div><div class="line"><a name="l15359"></a><span class="lineno">15359</span>&#160;         <span class="keywordflow">switch</span> (res) {</div><div class="line"><a name="l15360"></a><span class="lineno">15360</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:</div><div class="line"><a name="l15361"></a><span class="lineno">15361</span>&#160;            <span class="keywordflow">if</span> (num) {</div><div class="line"><a name="l15362"></a><span class="lineno">15362</span>&#160;               <span class="comment">/* Dial the CID number */</span></div><div class="line"><a name="l15363"></a><span class="lineno">15363</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(chan, vmu, num, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>);</div><div class="line"><a name="l15364"></a><span class="lineno">15364</span>&#160;               <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15365"></a><span class="lineno">15365</span>&#160;                  <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15366"></a><span class="lineno">15366</span>&#160;                  <span class="keywordflow">return</span> 9;</div><div class="line"><a name="l15367"></a><span class="lineno">15367</span>&#160;               }</div><div class="line"><a name="l15368"></a><span class="lineno">15368</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15369"></a><span class="lineno">15369</span>&#160;               res = <span class="charliteral">&#39;2&#39;</span>;</div><div class="line"><a name="l15370"></a><span class="lineno">15370</span>&#160;            }</div><div class="line"><a name="l15371"></a><span class="lineno">15371</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15372"></a><span class="lineno">15372</span>&#160;</div><div class="line"><a name="l15373"></a><span class="lineno">15373</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:</div><div class="line"><a name="l15374"></a><span class="lineno">15374</span>&#160;            <span class="comment">/* Want to enter a different number, can only do this if there&#39;s a dialout context for this user */</span></div><div class="line"><a name="l15375"></a><span class="lineno">15375</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {</div><div class="line"><a name="l15376"></a><span class="lineno">15376</span>&#160;               res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(chan, vmu, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>);</div><div class="line"><a name="l15377"></a><span class="lineno">15377</span>&#160;               <span class="keywordflow">if</span> (res) {</div><div class="line"><a name="l15378"></a><span class="lineno">15378</span>&#160;                  <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15379"></a><span class="lineno">15379</span>&#160;                  <span class="keywordflow">return</span> 9;</div><div class="line"><a name="l15380"></a><span class="lineno">15380</span>&#160;               }</div><div class="line"><a name="l15381"></a><span class="lineno">15381</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15382"></a><span class="lineno">15382</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Caller can not specify callback number - no dialout context available\n&quot;</span>);</div><div class="line"><a name="l15383"></a><span class="lineno">15383</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l15384"></a><span class="lineno">15384</span>&#160;            }</div><div class="line"><a name="l15385"></a><span class="lineno">15385</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15386"></a><span class="lineno">15386</span>&#160;            <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15387"></a><span class="lineno">15387</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l15388"></a><span class="lineno">15388</span>&#160;            res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15389"></a><span class="lineno">15389</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15390"></a><span class="lineno">15390</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>:</div><div class="line"><a name="l15391"></a><span class="lineno">15391</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;4&#39;</span>:</div><div class="line"><a name="l15392"></a><span class="lineno">15392</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;5&#39;</span>:</div><div class="line"><a name="l15393"></a><span class="lineno">15393</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;6&#39;</span>:</div><div class="line"><a name="l15394"></a><span class="lineno">15394</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;7&#39;</span>:</div><div class="line"><a name="l15395"></a><span class="lineno">15395</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;8&#39;</span>:</div><div class="line"><a name="l15396"></a><span class="lineno">15396</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;9&#39;</span>:</div><div class="line"><a name="l15397"></a><span class="lineno">15397</span>&#160;         <span class="keywordflow">case</span> <span class="charliteral">&#39;0&#39;</span>:</div><div class="line"><a name="l15398"></a><span class="lineno">15398</span>&#160;</div><div class="line"><a name="l15399"></a><span class="lineno">15399</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l15400"></a><span class="lineno">15400</span>&#160;            retries++;</div><div class="line"><a name="l15401"></a><span class="lineno">15401</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15402"></a><span class="lineno">15402</span>&#160;         <span class="keywordflow">default</span>:</div><div class="line"><a name="l15403"></a><span class="lineno">15403</span>&#160;            <span class="keywordflow">if</span> (num) {</div><div class="line"><a name="l15404"></a><span class="lineno">15404</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Confirm CID number &#39;%s&#39; is number to use for callback\n&quot;</span>, num);</div><div class="line"><a name="l15405"></a><span class="lineno">15405</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-num-i-have&quot;</span>);</div><div class="line"><a name="l15406"></a><span class="lineno">15406</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l15407"></a><span class="lineno">15407</span>&#160;                  res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5fe40961f76694db47fb14e7b19ade9b">play_message_callerid</a>(chan, vms, num, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, 1, 1);</div><div class="line"><a name="l15408"></a><span class="lineno">15408</span>&#160;               <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l15409"></a><span class="lineno">15409</span>&#160;                  res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocallnum&quot;</span>);</div><div class="line"><a name="l15410"></a><span class="lineno">15410</span>&#160;               <span class="comment">/* Only prompt for a caller-specified number if there is a dialout context specified */</span></div><div class="line"><a name="l15411"></a><span class="lineno">15411</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {</div><div class="line"><a name="l15412"></a><span class="lineno">15412</span>&#160;                  <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l15413"></a><span class="lineno">15413</span>&#160;                     res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-calldiffnum&quot;</span>);</div><div class="line"><a name="l15414"></a><span class="lineno">15414</span>&#160;               }</div><div class="line"><a name="l15415"></a><span class="lineno">15415</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15416"></a><span class="lineno">15416</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nonumber&quot;</span>);</div><div class="line"><a name="l15417"></a><span class="lineno">15417</span>&#160;               <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {</div><div class="line"><a name="l15418"></a><span class="lineno">15418</span>&#160;                  <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l15419"></a><span class="lineno">15419</span>&#160;                     res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toenternumber&quot;</span>);</div><div class="line"><a name="l15420"></a><span class="lineno">15420</span>&#160;               }</div><div class="line"><a name="l15421"></a><span class="lineno">15421</span>&#160;            }</div><div class="line"><a name="l15422"></a><span class="lineno">15422</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l15423"></a><span class="lineno">15423</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-star-cancel&quot;</span>);</div><div class="line"><a name="l15424"></a><span class="lineno">15424</span>&#160;            }</div><div class="line"><a name="l15425"></a><span class="lineno">15425</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l15426"></a><span class="lineno">15426</span>&#160;               res = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l15427"></a><span class="lineno">15427</span>&#160;            }</div><div class="line"><a name="l15428"></a><span class="lineno">15428</span>&#160;            <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l15429"></a><span class="lineno">15429</span>&#160;               retries++;</div><div class="line"><a name="l15430"></a><span class="lineno">15430</span>&#160;               <span class="keywordflow">if</span> (retries &gt; 3) {</div><div class="line"><a name="l15431"></a><span class="lineno">15431</span>&#160;                  res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15432"></a><span class="lineno">15432</span>&#160;               }</div><div class="line"><a name="l15433"></a><span class="lineno">15433</span>&#160;            }</div><div class="line"><a name="l15434"></a><span class="lineno">15434</span>&#160;            <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;USERPRESS&quot;</span>, <span class="stringliteral">&quot;Message: User pressed %c\r\nDTMF: %c&quot;</span>,</div><div class="line"><a name="l15435"></a><span class="lineno">15435</span>&#160;               isprint(res) ? res : <span class="charliteral">&#39;?&#39;</span>, isprint(res) ? res : <span class="charliteral">&#39;?&#39;</span>);</div><div class="line"><a name="l15436"></a><span class="lineno">15436</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15437"></a><span class="lineno">15437</span>&#160;</div><div class="line"><a name="l15438"></a><span class="lineno">15438</span>&#160;         }</div><div class="line"><a name="l15439"></a><span class="lineno">15439</span>&#160;         <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;t&#39;</span>)</div><div class="line"><a name="l15440"></a><span class="lineno">15440</span>&#160;            res = 0;</div><div class="line"><a name="l15441"></a><span class="lineno">15441</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;*&#39;</span>)</div><div class="line"><a name="l15442"></a><span class="lineno">15442</span>&#160;            res = -1;</div><div class="line"><a name="l15443"></a><span class="lineno">15443</span>&#160;      }</div><div class="line"><a name="l15444"></a><span class="lineno">15444</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l15445"></a><span class="lineno">15445</span>&#160;</div><div class="line"><a name="l15446"></a><span class="lineno">15446</span>&#160;   <span class="keywordflow">case</span> 1:  <span class="comment">/* Reply */</span></div><div class="line"><a name="l15447"></a><span class="lineno">15447</span>&#160;      <span class="comment">/* Send reply directly to sender */</span></div><div class="line"><a name="l15448"></a><span class="lineno">15448</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cid))</div><div class="line"><a name="l15449"></a><span class="lineno">15449</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15450"></a><span class="lineno">15450</span>&#160;</div><div class="line"><a name="l15451"></a><span class="lineno">15451</span>&#160;      <a class="code" href="../../de/d47/callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df">ast_callerid_parse</a>(cid, &amp;name, &amp;num);</div><div class="line"><a name="l15452"></a><span class="lineno">15452</span>&#160;      <span class="keywordflow">if</span> (!num) {</div><div class="line"><a name="l15453"></a><span class="lineno">15453</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;No CID number available, no reply sent\n&quot;</span>);</div><div class="line"><a name="l15454"></a><span class="lineno">15454</span>&#160;         <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l15455"></a><span class="lineno">15455</span>&#160;            res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nonumber&quot;</span>);</div><div class="line"><a name="l15456"></a><span class="lineno">15456</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15457"></a><span class="lineno">15457</span>&#160;         <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15458"></a><span class="lineno">15458</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15459"></a><span class="lineno">15459</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> vmu2, *vmu3;</div><div class="line"><a name="l15460"></a><span class="lineno">15460</span>&#160;         memset(&amp;vmu2, 0, <span class="keyword">sizeof</span>(vmu2));</div><div class="line"><a name="l15461"></a><span class="lineno">15461</span>&#160;         vmu3 = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmu2, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, num);</div><div class="line"><a name="l15462"></a><span class="lineno">15462</span>&#160;         <span class="keywordflow">if</span> (vmu3) {</div><div class="line"><a name="l15463"></a><span class="lineno">15463</span>&#160;            <span class="keyword">struct </span><a class="code" href="../../dd/df7/structleave__vm__options.html">leave_vm_options</a> leave_options;</div><div class="line"><a name="l15464"></a><span class="lineno">15464</span>&#160;            <span class="keywordtype">char</span> mailbox[<a class="code" href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a> * 2 + 2];</div><div class="line"><a name="l15465"></a><span class="lineno">15465</span>&#160;            snprintf(mailbox, <span class="keyword">sizeof</span>(mailbox), <span class="stringliteral">&quot;%s@%s&quot;</span>, num, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l15466"></a><span class="lineno">15466</span>&#160;</div><div class="line"><a name="l15467"></a><span class="lineno">15467</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Leaving voicemail for &#39;%s&#39; in context &#39;%s&#39;\n&quot;</span>, num, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l15468"></a><span class="lineno">15468</span>&#160;</div><div class="line"><a name="l15469"></a><span class="lineno">15469</span>&#160;            memset(&amp;leave_options, 0, <span class="keyword">sizeof</span>(leave_options));</div><div class="line"><a name="l15470"></a><span class="lineno">15470</span>&#160;            leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a> = <a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a>;</div><div class="line"><a name="l15471"></a><span class="lineno">15471</span>&#160;            leave_options.<a class="code" href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">beeptone</a> = <span class="stringliteral">&quot;beep&quot;</span>;</div><div class="line"><a name="l15472"></a><span class="lineno">15472</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff">leave_voicemail</a>(chan, mailbox, &amp;leave_options);</div><div class="line"><a name="l15473"></a><span class="lineno">15473</span>&#160;            <span class="keywordflow">if</span> (!res)</div><div class="line"><a name="l15474"></a><span class="lineno">15474</span>&#160;               res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15475"></a><span class="lineno">15475</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15476"></a><span class="lineno">15476</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu3);</div><div class="line"><a name="l15477"></a><span class="lineno">15477</span>&#160;            <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15478"></a><span class="lineno">15478</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15479"></a><span class="lineno">15479</span>&#160;            <span class="comment">/* Sender has no mailbox, can&#39;t reply */</span></div><div class="line"><a name="l15480"></a><span class="lineno">15480</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;No mailbox number &#39;%s&#39; in context &#39;%s&#39;, no reply sent\n&quot;</span>, num, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l15481"></a><span class="lineno">15481</span>&#160;            <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nobox&quot;</span>);</div><div class="line"><a name="l15482"></a><span class="lineno">15482</span>&#160;            res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15483"></a><span class="lineno">15483</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15484"></a><span class="lineno">15484</span>&#160;            <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15485"></a><span class="lineno">15485</span>&#160;         }</div><div class="line"><a name="l15486"></a><span class="lineno">15486</span>&#160;      }</div><div class="line"><a name="l15487"></a><span class="lineno">15487</span>&#160;      res = 0;</div><div class="line"><a name="l15488"></a><span class="lineno">15488</span>&#160;</div><div class="line"><a name="l15489"></a><span class="lineno">15489</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l15490"></a><span class="lineno">15490</span>&#160;   }</div><div class="line"><a name="l15491"></a><span class="lineno">15491</span>&#160;</div><div class="line"><a name="l15492"></a><span class="lineno">15492</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15493"></a><span class="lineno">15493</span>&#160;</div><div class="line"><a name="l15494"></a><span class="lineno">15494</span>&#160;<span class="preprocessor">#ifndef IMAP_STORAGE</span></div><div class="line"><a name="l15495"></a><span class="lineno">15495</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l15496"></a><span class="lineno">15496</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, msg);</div><div class="line"><a name="l15497"></a><span class="lineno">15497</span>&#160;      vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[msg] = 1;</div><div class="line"><a name="l15498"></a><span class="lineno">15498</span>&#160;      res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l15499"></a><span class="lineno">15499</span>&#160;   }</div><div class="line"><a name="l15500"></a><span class="lineno">15500</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15501"></a><span class="lineno">15501</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15502"></a><span class="lineno">15502</span>&#160;}</div><div class="line"><a name="l15503"></a><span class="lineno">15503</span>&#160;</div><div class="line"><a name="l15504"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">15504</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *playfile, <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keywordtype">char</span> *fmt,</div><div class="line"><a name="l15505"></a><span class="lineno">15505</span>&#160;         <span class="keywordtype">int</span> outsidecaller, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> *sound_duration, <span class="keyword">const</span> <span class="keywordtype">char</span> *unlockdir,</div><div class="line"><a name="l15506"></a><span class="lineno">15506</span>&#160;         <span class="keywordtype">signed</span> <span class="keywordtype">char</span> <a class="code" href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a>, <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *flag, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id, <span class="keywordtype">int</span> forwardintro)</div><div class="line"><a name="l15507"></a><span class="lineno">15507</span>&#160;{</div><div class="line"><a name="l15508"></a><span class="lineno">15508</span>&#160;   <span class="comment">/* Record message &amp; let caller review or re-record it, or set options if applicable */</span></div><div class="line"><a name="l15509"></a><span class="lineno">15509</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l15510"></a><span class="lineno">15510</span>&#160;   <span class="keywordtype">int</span> cmd = 0;</div><div class="line"><a name="l15511"></a><span class="lineno">15511</span>&#160;   <span class="keywordtype">int</span> max_attempts = 3;</div><div class="line"><a name="l15512"></a><span class="lineno">15512</span>&#160;   <span class="keywordtype">int</span> attempts = 0;</div><div class="line"><a name="l15513"></a><span class="lineno">15513</span>&#160;   <span class="keywordtype">int</span> recorded = 0;</div><div class="line"><a name="l15514"></a><span class="lineno">15514</span>&#160;   <span class="keywordtype">int</span> msg_exists = 0;</div><div class="line"><a name="l15515"></a><span class="lineno">15515</span>&#160;   <span class="keywordtype">signed</span> <span class="keywordtype">char</span> zero_gain = 0;</div><div class="line"><a name="l15516"></a><span class="lineno">15516</span>&#160;   <span class="keywordtype">char</span> tempfile[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l15517"></a><span class="lineno">15517</span>&#160;   <span class="keywordtype">char</span> *acceptdtmf = <span class="stringliteral">&quot;#&quot;</span>;</div><div class="line"><a name="l15518"></a><span class="lineno">15518</span>&#160;   <span class="keywordtype">char</span> *canceldtmf = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l15519"></a><span class="lineno">15519</span>&#160;   <span class="keywordtype">int</span> canceleddtmf = 0;</div><div class="line"><a name="l15520"></a><span class="lineno">15520</span>&#160;</div><div class="line"><a name="l15521"></a><span class="lineno">15521</span>&#160;   <span class="comment">/* Note that urgent and private are for flagging messages as such in the future */</span></div><div class="line"><a name="l15522"></a><span class="lineno">15522</span>&#160;</div><div class="line"><a name="l15523"></a><span class="lineno">15523</span>&#160;   <span class="comment">/* barf if no pointer passed to store duration in */</span></div><div class="line"><a name="l15524"></a><span class="lineno">15524</span>&#160;   <span class="keywordflow">if</span> (duration == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line"><a name="l15525"></a><span class="lineno">15525</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Error play_record_review called without duration pointer\n&quot;</span>);</div><div class="line"><a name="l15526"></a><span class="lineno">15526</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l15527"></a><span class="lineno">15527</span>&#160;   }</div><div class="line"><a name="l15528"></a><span class="lineno">15528</span>&#160;</div><div class="line"><a name="l15529"></a><span class="lineno">15529</span>&#160;   <span class="keywordflow">if</span> (!outsidecaller)</div><div class="line"><a name="l15530"></a><span class="lineno">15530</span>&#160;      snprintf(tempfile, <span class="keyword">sizeof</span>(tempfile), <span class="stringliteral">&quot;%s.tmp&quot;</span>, recordfile);</div><div class="line"><a name="l15531"></a><span class="lineno">15531</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l15532"></a><span class="lineno">15532</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tempfile, recordfile, <span class="keyword">sizeof</span>(tempfile));</div><div class="line"><a name="l15533"></a><span class="lineno">15533</span>&#160;</div><div class="line"><a name="l15534"></a><span class="lineno">15534</span>&#160;   cmd = <span class="charliteral">&#39;3&#39;</span>;  <span class="comment">/* Want to start by recording */</span></div><div class="line"><a name="l15535"></a><span class="lineno">15535</span>&#160;</div><div class="line"><a name="l15536"></a><span class="lineno">15536</span>&#160;   <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>)) {</div><div class="line"><a name="l15537"></a><span class="lineno">15537</span>&#160;      <span class="keywordflow">switch</span> (cmd) {</div><div class="line"><a name="l15538"></a><span class="lineno">15538</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:</div><div class="line"><a name="l15539"></a><span class="lineno">15539</span>&#160;         <span class="keywordflow">if</span> (!msg_exists) {</div><div class="line"><a name="l15540"></a><span class="lineno">15540</span>&#160;            <span class="comment">/* In this case, 1 is to record a message */</span></div><div class="line"><a name="l15541"></a><span class="lineno">15541</span>&#160;            cmd = <span class="charliteral">&#39;3&#39;</span>;</div><div class="line"><a name="l15542"></a><span class="lineno">15542</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15543"></a><span class="lineno">15543</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15544"></a><span class="lineno">15544</span>&#160;            <span class="comment">/* Otherwise 1 is to save the existing message */</span></div><div class="line"><a name="l15545"></a><span class="lineno">15545</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saving message as is\n&quot;</span>);</div><div class="line"><a name="l15546"></a><span class="lineno">15546</span>&#160;            <span class="keywordflow">if</span> (!outsidecaller)</div><div class="line"><a name="l15547"></a><span class="lineno">15547</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(tempfile, recordfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15548"></a><span class="lineno">15548</span>&#160;            <span class="keywordflow">if</span> (!forwardintro) {</div><div class="line"><a name="l15549"></a><span class="lineno">15549</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l15550"></a><span class="lineno">15550</span>&#160;            }</div><div class="line"><a name="l15551"></a><span class="lineno">15551</span>&#160;            <span class="keywordflow">if</span> (!outsidecaller) {</div><div class="line"><a name="l15552"></a><span class="lineno">15552</span>&#160;               <span class="comment">/* Saves to IMAP server only if imapgreeting=yes */</span></div><div class="line"><a name="l15553"></a><span class="lineno">15553</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a>(recordfile, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, -1, chan, vmu, fmt, *duration, vms, flag, msg_id);</div><div class="line"><a name="l15554"></a><span class="lineno">15554</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(recordfile, -1);</div><div class="line"><a name="l15555"></a><span class="lineno">15555</span>&#160;            }</div><div class="line"><a name="l15556"></a><span class="lineno">15556</span>&#160;            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15557"></a><span class="lineno">15557</span>&#160;            <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15558"></a><span class="lineno">15558</span>&#160;         }</div><div class="line"><a name="l15559"></a><span class="lineno">15559</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:</div><div class="line"><a name="l15560"></a><span class="lineno">15560</span>&#160;         <span class="comment">/* Review */</span></div><div class="line"><a name="l15561"></a><span class="lineno">15561</span>&#160;         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Reviewing the message\n&quot;</span>);</div><div class="line"><a name="l15562"></a><span class="lineno">15562</span>&#160;         cmd = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, tempfile, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);</div><div class="line"><a name="l15563"></a><span class="lineno">15563</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15564"></a><span class="lineno">15564</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>:</div><div class="line"><a name="l15565"></a><span class="lineno">15565</span>&#160;         msg_exists = 0;</div><div class="line"><a name="l15566"></a><span class="lineno">15566</span>&#160;         <span class="comment">/* Record */</span></div><div class="line"><a name="l15567"></a><span class="lineno">15567</span>&#160;         <span class="keywordflow">if</span> (recorded == 1)</div><div class="line"><a name="l15568"></a><span class="lineno">15568</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Re-recording the message\n&quot;</span>);</div><div class="line"><a name="l15569"></a><span class="lineno">15569</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l15570"></a><span class="lineno">15570</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Recording the message\n&quot;</span>);</div><div class="line"><a name="l15571"></a><span class="lineno">15571</span>&#160;</div><div class="line"><a name="l15572"></a><span class="lineno">15572</span>&#160;         <span class="keywordflow">if</span> (recorded &amp;&amp; outsidecaller) {</div><div class="line"><a name="l15573"></a><span class="lineno">15573</span>&#160;            <span class="keywordflow">if</span> (forwardintro) {</div><div class="line"><a name="l15574"></a><span class="lineno">15574</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-record-prepend&quot;</span>);</div><div class="line"><a name="l15575"></a><span class="lineno">15575</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15576"></a><span class="lineno">15576</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">INTRO</a>);</div><div class="line"><a name="l15577"></a><span class="lineno">15577</span>&#160;            }</div><div class="line"><a name="l15578"></a><span class="lineno">15578</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>);</div><div class="line"><a name="l15579"></a><span class="lineno">15579</span>&#160;         }</div><div class="line"><a name="l15580"></a><span class="lineno">15580</span>&#160;         recorded = 1;</div><div class="line"><a name="l15581"></a><span class="lineno">15581</span>&#160;         <span class="comment">/* After an attempt has been made to record message, we have to take care of INTRO and beep for incoming messages, but not for greetings */</span></div><div class="line"><a name="l15582"></a><span class="lineno">15582</span>&#160;         <span class="keywordflow">if</span> (record_gain)</div><div class="line"><a name="l15583"></a><span class="lineno">15583</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#adcfd8d241b6de48068ead143ac29978d">ast_channel_setoption</a>(chan, <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;record_gain, <span class="keyword">sizeof</span>(record_gain), 0);</div><div class="line"><a name="l15584"></a><span class="lineno">15584</span>&#160;         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>))</div><div class="line"><a name="l15585"></a><span class="lineno">15585</span>&#160;            canceldtmf = <span class="stringliteral">&quot;0&quot;</span>;</div><div class="line"><a name="l15586"></a><span class="lineno">15586</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a13a3ff0da2d7d40198b3eafbde0464a0">ast_play_and_record_full</a>(chan, playfile, tempfile, maxtime, fmt, duration, sound_duration, 0, silencethreshold, maxsilence, unlockdir, acceptdtmf, canceldtmf, 0, <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da8022c0ca0ab8535428aed27423a40e2c">AST_RECORD_IF_EXISTS_OVERWRITE</a>);</div><div class="line"><a name="l15587"></a><span class="lineno">15587</span>&#160;         <span class="keywordflow">if</span> (strchr(canceldtmf, cmd)) {</div><div class="line"><a name="l15588"></a><span class="lineno">15588</span>&#160;         <span class="comment">/* need this flag here to distinguish between pressing &#39;0&#39; during message recording or after */</span></div><div class="line"><a name="l15589"></a><span class="lineno">15589</span>&#160;            canceleddtmf = 1;</div><div class="line"><a name="l15590"></a><span class="lineno">15590</span>&#160;         }</div><div class="line"><a name="l15591"></a><span class="lineno">15591</span>&#160;         <span class="keywordflow">if</span> (record_gain)</div><div class="line"><a name="l15592"></a><span class="lineno">15592</span>&#160;            <a class="code" href="../../d5/d7b/channel_8h.html#adcfd8d241b6de48068ead143ac29978d">ast_channel_setoption</a>(chan, <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;zero_gain, <span class="keyword">sizeof</span>(zero_gain), 0);</div><div class="line"><a name="l15593"></a><span class="lineno">15593</span>&#160;         <span class="keywordflow">if</span> (cmd == -1) {</div><div class="line"><a name="l15594"></a><span class="lineno">15594</span>&#160;            <span class="comment">/* User has hung up, no options to give */</span></div><div class="line"><a name="l15595"></a><span class="lineno">15595</span>&#160;            <span class="keywordflow">if</span> (!outsidecaller) {</div><div class="line"><a name="l15596"></a><span class="lineno">15596</span>&#160;               <span class="comment">/* user was recording a greeting and they hung up, so let&#39;s delete the recording. */</span></div><div class="line"><a name="l15597"></a><span class="lineno">15597</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tempfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15598"></a><span class="lineno">15598</span>&#160;            }</div><div class="line"><a name="l15599"></a><span class="lineno">15599</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l15600"></a><span class="lineno">15600</span>&#160;         }</div><div class="line"><a name="l15601"></a><span class="lineno">15601</span>&#160;         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;0&#39;</span>) {</div><div class="line"><a name="l15602"></a><span class="lineno">15602</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15603"></a><span class="lineno">15603</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line"><a name="l15604"></a><span class="lineno">15604</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15605"></a><span class="lineno">15605</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l15606"></a><span class="lineno">15606</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;review &amp;&amp; sound_duration &amp;&amp; (*sound_duration &lt; 5)) {</div><div class="line"><a name="l15607"></a><span class="lineno">15607</span>&#160;            <span class="comment">/* Message is too short */</span></div><div class="line"><a name="l15608"></a><span class="lineno">15608</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message too short\n&quot;</span>);</div><div class="line"><a name="l15609"></a><span class="lineno">15609</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tooshort&quot;</span>);</div><div class="line"><a name="l15610"></a><span class="lineno">15610</span>&#160;            cmd = <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tempfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15611"></a><span class="lineno">15611</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15612"></a><span class="lineno">15612</span>&#160;         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;review &amp;&amp; (cmd == 2 &amp;&amp; sound_duration &amp;&amp; *sound_duration &lt; (maxsilence + 3))) {</div><div class="line"><a name="l15613"></a><span class="lineno">15613</span>&#160;            <span class="comment">/* Message is all silence */</span></div><div class="line"><a name="l15614"></a><span class="lineno">15614</span>&#160;            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Nothing recorded\n&quot;</span>);</div><div class="line"><a name="l15615"></a><span class="lineno">15615</span>&#160;            cmd = <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tempfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15616"></a><span class="lineno">15616</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nothingrecorded&quot;</span>);</div><div class="line"><a name="l15617"></a><span class="lineno">15617</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15618"></a><span class="lineno">15618</span>&#160;               cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-speakup&quot;</span>);</div><div class="line"><a name="l15619"></a><span class="lineno">15619</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15620"></a><span class="lineno">15620</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15621"></a><span class="lineno">15621</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15622"></a><span class="lineno">15622</span>&#160;            <span class="comment">/* If all is well, a message exists */</span></div><div class="line"><a name="l15623"></a><span class="lineno">15623</span>&#160;            msg_exists = 1;</div><div class="line"><a name="l15624"></a><span class="lineno">15624</span>&#160;            cmd = 0;</div><div class="line"><a name="l15625"></a><span class="lineno">15625</span>&#160;         }</div><div class="line"><a name="l15626"></a><span class="lineno">15626</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15627"></a><span class="lineno">15627</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;4&#39;</span>:</div><div class="line"><a name="l15628"></a><span class="lineno">15628</span>&#160;         <span class="keywordflow">if</span> (outsidecaller) {  <span class="comment">/* only mark vm messages */</span></div><div class="line"><a name="l15629"></a><span class="lineno">15629</span>&#160;            <span class="comment">/* Mark Urgent */</span></div><div class="line"><a name="l15630"></a><span class="lineno">15630</span>&#160;            <span class="keywordflow">if</span> ((flag &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag)) || (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag) &amp;&amp; strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>))) {</div><div class="line"><a name="l15631"></a><span class="lineno">15631</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;marking message as Urgent\n&quot;</span>);</div><div class="line"><a name="l15632"></a><span class="lineno">15632</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-marked-urgent&quot;</span>);</div><div class="line"><a name="l15633"></a><span class="lineno">15633</span>&#160;               strcpy(flag, <span class="stringliteral">&quot;Urgent&quot;</span>);</div><div class="line"><a name="l15634"></a><span class="lineno">15634</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag) {</div><div class="line"><a name="l15635"></a><span class="lineno">15635</span>&#160;               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;UNmarking message as Urgent\n&quot;</span>);</div><div class="line"><a name="l15636"></a><span class="lineno">15636</span>&#160;               res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-marked-nonurgent&quot;</span>);</div><div class="line"><a name="l15637"></a><span class="lineno">15637</span>&#160;               strcpy(flag, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l15638"></a><span class="lineno">15638</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15639"></a><span class="lineno">15639</span>&#160;               <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l15640"></a><span class="lineno">15640</span>&#160;            }</div><div class="line"><a name="l15641"></a><span class="lineno">15641</span>&#160;            cmd = 0;</div><div class="line"><a name="l15642"></a><span class="lineno">15642</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15643"></a><span class="lineno">15643</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l15644"></a><span class="lineno">15644</span>&#160;         }</div><div class="line"><a name="l15645"></a><span class="lineno">15645</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15646"></a><span class="lineno">15646</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;5&#39;</span>:</div><div class="line"><a name="l15647"></a><span class="lineno">15647</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;6&#39;</span>:</div><div class="line"><a name="l15648"></a><span class="lineno">15648</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;7&#39;</span>:</div><div class="line"><a name="l15649"></a><span class="lineno">15649</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;8&#39;</span>:</div><div class="line"><a name="l15650"></a><span class="lineno">15650</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;9&#39;</span>:</div><div class="line"><a name="l15651"></a><span class="lineno">15651</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l15652"></a><span class="lineno">15652</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;#&#39;</span>:</div><div class="line"><a name="l15653"></a><span class="lineno">15653</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l15654"></a><span class="lineno">15654</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15655"></a><span class="lineno">15655</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l15656"></a><span class="lineno">15656</span>&#160;<span class="comment">/*  XXX Commented out for the moment because of the dangers of deleting</span></div><div class="line"><a name="l15657"></a><span class="lineno">15657</span>&#160;<span class="comment">    a message while recording (can put the message numbers out of sync) */</span></div><div class="line"><a name="l15658"></a><span class="lineno">15658</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line"><a name="l15659"></a><span class="lineno">15659</span>&#160;         <span class="comment">/* Cancel recording, delete message, offer to take another message*/</span></div><div class="line"><a name="l15660"></a><span class="lineno">15660</span>&#160;         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-deleted&quot;</span>);</div><div class="line"><a name="l15661"></a><span class="lineno">15661</span>&#160;         cmd = <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tempfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15662"></a><span class="lineno">15662</span>&#160;         <span class="keywordflow">if</span> (outsidecaller) {</div><div class="line"><a name="l15663"></a><span class="lineno">15663</span>&#160;            res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a4ace316d9392f91668365780d1c2d020">vm_exec</a>(chan, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15664"></a><span class="lineno">15664</span>&#160;            <span class="keywordflow">return</span> res;</div><div class="line"><a name="l15665"></a><span class="lineno">15665</span>&#160;         }</div><div class="line"><a name="l15666"></a><span class="lineno">15666</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l15667"></a><span class="lineno">15667</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l15668"></a><span class="lineno">15668</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15669"></a><span class="lineno">15669</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;0&#39;</span>:</div><div class="line"><a name="l15670"></a><span class="lineno">15670</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>) || (!canceleddtmf &amp;&amp; !outsidecaller)) {</div><div class="line"><a name="l15671"></a><span class="lineno">15671</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line"><a name="l15672"></a><span class="lineno">15672</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15673"></a><span class="lineno">15673</span>&#160;         }</div><div class="line"><a name="l15674"></a><span class="lineno">15674</span>&#160;         <span class="keywordflow">if</span> (msg_exists || recorded) {</div><div class="line"><a name="l15675"></a><span class="lineno">15675</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-saveoper&quot;</span>);</div><div class="line"><a name="l15676"></a><span class="lineno">15676</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15677"></a><span class="lineno">15677</span>&#160;               cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 3000);</div><div class="line"><a name="l15678"></a><span class="lineno">15678</span>&#160;            <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;1&#39;</span>) {</div><div class="line"><a name="l15679"></a><span class="lineno">15679</span>&#160;               <a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(tempfile, recordfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15680"></a><span class="lineno">15680</span>&#160;               <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>);</div><div class="line"><a name="l15681"></a><span class="lineno">15681</span>&#160;               cmd = <span class="charliteral">&#39;0&#39;</span>;</div><div class="line"><a name="l15682"></a><span class="lineno">15682</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;4&#39;</span>) {</div><div class="line"><a name="l15683"></a><span class="lineno">15683</span>&#160;               <span class="keywordflow">if</span> (flag) {</div><div class="line"><a name="l15684"></a><span class="lineno">15684</span>&#160;                  <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-marked-urgent&quot;</span>);</div><div class="line"><a name="l15685"></a><span class="lineno">15685</span>&#160;                  strcpy(flag, <span class="stringliteral">&quot;Urgent&quot;</span>);</div><div class="line"><a name="l15686"></a><span class="lineno">15686</span>&#160;               }</div><div class="line"><a name="l15687"></a><span class="lineno">15687</span>&#160;               <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>);</div><div class="line"><a name="l15688"></a><span class="lineno">15688</span>&#160;               cmd = <span class="charliteral">&#39;0&#39;</span>;</div><div class="line"><a name="l15689"></a><span class="lineno">15689</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15690"></a><span class="lineno">15690</span>&#160;               <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-deleted&quot;</span>);</div><div class="line"><a name="l15691"></a><span class="lineno">15691</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(tempfile, -1, tempfile, vmu);</div><div class="line"><a name="l15692"></a><span class="lineno">15692</span>&#160;               <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(tempfile, -1);</div><div class="line"><a name="l15693"></a><span class="lineno">15693</span>&#160;               cmd = <span class="charliteral">&#39;0&#39;</span>;</div><div class="line"><a name="l15694"></a><span class="lineno">15694</span>&#160;            }</div><div class="line"><a name="l15695"></a><span class="lineno">15695</span>&#160;         }</div><div class="line"><a name="l15696"></a><span class="lineno">15696</span>&#160;         <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l15697"></a><span class="lineno">15697</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l15698"></a><span class="lineno">15698</span>&#160;         <span class="comment">/* If the caller is an ouside caller and the review option is enabled or it&#39;s forward intro</span></div><div class="line"><a name="l15699"></a><span class="lineno">15699</span>&#160;<span class="comment">            allow them to review the message, but let the owner of the box review</span></div><div class="line"><a name="l15700"></a><span class="lineno">15700</span>&#160;<span class="comment">            their OGM&#39;s */</span></div><div class="line"><a name="l15701"></a><span class="lineno">15701</span>&#160;         <span class="keywordflow">if</span> (outsidecaller &amp;&amp; !<a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>) &amp;&amp; !forwardintro)</div><div class="line"><a name="l15702"></a><span class="lineno">15702</span>&#160;            <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l15703"></a><span class="lineno">15703</span>&#160;         <span class="keywordflow">if</span> (msg_exists) {</div><div class="line"><a name="l15704"></a><span class="lineno">15704</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review&quot;</span>);</div><div class="line"><a name="l15705"></a><span class="lineno">15705</span>&#160;            <span class="keywordflow">if</span> (!cmd &amp;&amp; outsidecaller) {</div><div class="line"><a name="l15706"></a><span class="lineno">15706</span>&#160;               <span class="keywordflow">if</span> ((flag &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag)) || (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(flag) &amp;&amp; strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>))) {</div><div class="line"><a name="l15707"></a><span class="lineno">15707</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review-urgent&quot;</span>);</div><div class="line"><a name="l15708"></a><span class="lineno">15708</span>&#160;               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag) {</div><div class="line"><a name="l15709"></a><span class="lineno">15709</span>&#160;                  cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review-nonurgent&quot;</span>);</div><div class="line"><a name="l15710"></a><span class="lineno">15710</span>&#160;               }</div><div class="line"><a name="l15711"></a><span class="lineno">15711</span>&#160;            }</div><div class="line"><a name="l15712"></a><span class="lineno">15712</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15713"></a><span class="lineno">15713</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-torerecord&quot;</span>);</div><div class="line"><a name="l15714"></a><span class="lineno">15714</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15715"></a><span class="lineno">15715</span>&#160;               cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 600);</div><div class="line"><a name="l15716"></a><span class="lineno">15716</span>&#160;         }</div><div class="line"><a name="l15717"></a><span class="lineno">15717</span>&#160;</div><div class="line"><a name="l15718"></a><span class="lineno">15718</span>&#160;         <span class="keywordflow">if</span> (!cmd &amp;&amp; outsidecaller &amp;&amp; <a class="code" href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>)) {</div><div class="line"><a name="l15719"></a><span class="lineno">15719</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-reachoper&quot;</span>);</div><div class="line"><a name="l15720"></a><span class="lineno">15720</span>&#160;            <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15721"></a><span class="lineno">15721</span>&#160;               cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 600);</div><div class="line"><a name="l15722"></a><span class="lineno">15722</span>&#160;         }</div><div class="line"><a name="l15723"></a><span class="lineno">15723</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l15724"></a><span class="lineno">15724</span>&#160;         <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15725"></a><span class="lineno">15725</span>&#160;            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocancelmsg&quot;</span>);</div><div class="line"><a name="l15726"></a><span class="lineno">15726</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15727"></a><span class="lineno">15727</span>&#160;         <span class="keywordflow">if</span> (!cmd)</div><div class="line"><a name="l15728"></a><span class="lineno">15728</span>&#160;            cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line"><a name="l15729"></a><span class="lineno">15729</span>&#160;         <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l15730"></a><span class="lineno">15730</span>&#160;            attempts++;</div><div class="line"><a name="l15731"></a><span class="lineno">15731</span>&#160;         }</div><div class="line"><a name="l15732"></a><span class="lineno">15732</span>&#160;         <span class="keywordflow">if</span> (attempts &gt; max_attempts) {</div><div class="line"><a name="l15733"></a><span class="lineno">15733</span>&#160;            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line"><a name="l15734"></a><span class="lineno">15734</span>&#160;         }</div><div class="line"><a name="l15735"></a><span class="lineno">15735</span>&#160;      }</div><div class="line"><a name="l15736"></a><span class="lineno">15736</span>&#160;   }</div><div class="line"><a name="l15737"></a><span class="lineno">15737</span>&#160;   <span class="keywordflow">if</span> (!outsidecaller &amp;&amp; (cmd == -1 || cmd == <span class="charliteral">&#39;t&#39;</span>)) {</div><div class="line"><a name="l15738"></a><span class="lineno">15738</span>&#160;      <span class="comment">/* Hang up or timeout, so delete the recording. */</span></div><div class="line"><a name="l15739"></a><span class="lineno">15739</span>&#160;      <a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(tempfile, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l15740"></a><span class="lineno">15740</span>&#160;   }</div><div class="line"><a name="l15741"></a><span class="lineno">15741</span>&#160;</div><div class="line"><a name="l15742"></a><span class="lineno">15742</span>&#160;   <span class="keywordflow">if</span> (cmd != <span class="charliteral">&#39;t&#39;</span> &amp;&amp; outsidecaller)</div><div class="line"><a name="l15743"></a><span class="lineno">15743</span>&#160;      <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);</div><div class="line"><a name="l15744"></a><span class="lineno">15744</span>&#160;</div><div class="line"><a name="l15745"></a><span class="lineno">15745</span>&#160;   <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l15746"></a><span class="lineno">15746</span>&#160;}</div><div class="line"><a name="l15747"></a><span class="lineno">15747</span>&#160;</div><div class="line"><a name="l15748"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a9286e529100ea42afa05db24311cf965">15748</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a9286e529100ea42afa05db24311cf965">vm_msg_snapshot_alloc</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l15749"></a><span class="lineno">15749</span>&#160;{</div><div class="line"><a name="l15750"></a><span class="lineno">15750</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *msg_snapshot;</div><div class="line"><a name="l15751"></a><span class="lineno">15751</span>&#160;</div><div class="line"><a name="l15752"></a><span class="lineno">15752</span>&#160;   <span class="keywordflow">if</span> (!(msg_snapshot = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*msg_snapshot)))) {</div><div class="line"><a name="l15753"></a><span class="lineno">15753</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15754"></a><span class="lineno">15754</span>&#160;   }</div><div class="line"><a name="l15755"></a><span class="lineno">15755</span>&#160;</div><div class="line"><a name="l15756"></a><span class="lineno">15756</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0f/stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665">ast_string_field_init</a>(msg_snapshot, 512)) {</div><div class="line"><a name="l15757"></a><span class="lineno">15757</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg_snapshot);</div><div class="line"><a name="l15758"></a><span class="lineno">15758</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15759"></a><span class="lineno">15759</span>&#160;   }</div><div class="line"><a name="l15760"></a><span class="lineno">15760</span>&#160;</div><div class="line"><a name="l15761"></a><span class="lineno">15761</span>&#160;   <span class="keywordflow">return</span> msg_snapshot;</div><div class="line"><a name="l15762"></a><span class="lineno">15762</span>&#160;}</div><div class="line"><a name="l15763"></a><span class="lineno">15763</span>&#160;</div><div class="line"><a name="l15764"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a2b120ac4209e9e13a383f706787249cf">15764</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a2b120ac4209e9e13a383f706787249cf">vm_msg_snapshot_destroy</a>(<span class="keyword">struct</span> <a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *msg_snapshot)</div><div class="line"><a name="l15765"></a><span class="lineno">15765</span>&#160;{</div><div class="line"><a name="l15766"></a><span class="lineno">15766</span>&#160;   <a class="code" href="../../d1/d0f/stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de">ast_string_field_free_memory</a>(msg_snapshot);</div><div class="line"><a name="l15767"></a><span class="lineno">15767</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(msg_snapshot);</div><div class="line"><a name="l15768"></a><span class="lineno">15768</span>&#160;</div><div class="line"><a name="l15769"></a><span class="lineno">15769</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15770"></a><span class="lineno">15770</span>&#160;}</div><div class="line"><a name="l15771"></a><span class="lineno">15771</span>&#160;</div><div class="line"><a name="l15772"></a><span class="lineno">15772</span>&#160;<span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><a name="l15773"></a><span class="lineno">15773</span>&#160;</div><div class="line"><a name="l15774"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a07c88336f106270f57593724e39f0604">15774</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a07c88336f106270f57593724e39f0604">vm_test_destroy_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line"><a name="l15775"></a><span class="lineno">15775</span>&#160;{</div><div class="line"><a name="l15776"></a><span class="lineno">15776</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l15777"></a><span class="lineno">15777</span>&#160;</div><div class="line"><a name="l15778"></a><span class="lineno">15778</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l15779"></a><span class="lineno">15779</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>, vmu, <a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>) {</div><div class="line"><a name="l15780"></a><span class="lineno">15780</span>&#160;      <span class="keywordflow">if</span> (!strcmp(context, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>)</div><div class="line"><a name="l15781"></a><span class="lineno">15781</span>&#160;         &amp;&amp; !strcmp(mailbox, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>)) {</div><div class="line"><a name="l15782"></a><span class="lineno">15782</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c">AST_LIST_REMOVE_CURRENT</a>(<a class="code" href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">list</a>);</div><div class="line"><a name="l15783"></a><span class="lineno">15783</span>&#160;         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu);</div><div class="line"><a name="l15784"></a><span class="lineno">15784</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15785"></a><span class="lineno">15785</span>&#160;      }</div><div class="line"><a name="l15786"></a><span class="lineno">15786</span>&#160;   }</div><div class="line"><a name="l15787"></a><span class="lineno">15787</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a></div><div class="line"><a name="l15788"></a><span class="lineno">15788</span>&#160;   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d8/d63/structusers.html">users</a>);</div><div class="line"><a name="l15789"></a><span class="lineno">15789</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15790"></a><span class="lineno">15790</span>&#160;}</div><div class="line"><a name="l15791"></a><span class="lineno">15791</span>&#160;</div><div class="line"><a name="l15792"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aa3dbfac8e2b5d54afabfa52585d42873">15792</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aa3dbfac8e2b5d54afabfa52585d42873">vm_test_create_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line"><a name="l15793"></a><span class="lineno">15793</span>&#160;{</div><div class="line"><a name="l15794"></a><span class="lineno">15794</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu;</div><div class="line"><a name="l15795"></a><span class="lineno">15795</span>&#160;</div><div class="line"><a name="l15796"></a><span class="lineno">15796</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(context, mailbox))) {</div><div class="line"><a name="l15797"></a><span class="lineno">15797</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l15798"></a><span class="lineno">15798</span>&#160;   }</div><div class="line"><a name="l15799"></a><span class="lineno">15799</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a>(vmu);</div><div class="line"><a name="l15800"></a><span class="lineno">15800</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15801"></a><span class="lineno">15801</span>&#160;}</div><div class="line"><a name="l15802"></a><span class="lineno">15802</span>&#160;</div><div class="line"><a name="l15803"></a><span class="lineno">15803</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l15804"></a><span class="lineno">15804</span>&#160;<span class="comment"></span></div><div class="line"><a name="l15805"></a><span class="lineno">15805</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l15806"></a><span class="lineno">15806</span>&#160;<span class="comment"> * \brief Create and store off all the msgs in an open mailbox</span></div><div class="line"><a name="l15807"></a><span class="lineno">15807</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l15808"></a><span class="lineno">15808</span>&#160;<span class="comment"> * \note TODO XXX This function should work properly for all</span></div><div class="line"><a name="l15809"></a><span class="lineno">15809</span>&#160;<span class="comment"> *       voicemail storage options, but is far more expensive for</span></div><div class="line"><a name="l15810"></a><span class="lineno">15810</span>&#160;<span class="comment"> *       ODBC at the moment.  This is because the RETRIEVE macro</span></div><div class="line"><a name="l15811"></a><span class="lineno">15811</span>&#160;<span class="comment"> *       not only pulls out the message&#39;s meta data file from the</span></div><div class="line"><a name="l15812"></a><span class="lineno">15812</span>&#160;<span class="comment"> *       database, but also the actual audio for each message, temporarily</span></div><div class="line"><a name="l15813"></a><span class="lineno">15813</span>&#160;<span class="comment"> *       writing it to the file system.  This is an area that needs</span></div><div class="line"><a name="l15814"></a><span class="lineno">15814</span>&#160;<span class="comment"> *       to be made more efficient.</span></div><div class="line"><a name="l15815"></a><span class="lineno">15815</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l15816"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a690d04bb2d7fc3e5bbe62641861aa435">15816</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a690d04bb2d7fc3e5bbe62641861aa435">vm_msg_snapshot_create</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu,</div><div class="line"><a name="l15817"></a><span class="lineno">15817</span>&#160;   <span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms,</div><div class="line"><a name="l15818"></a><span class="lineno">15818</span>&#160;   <span class="keyword">struct</span> <a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *mailbox_snapshot,</div><div class="line"><a name="l15819"></a><span class="lineno">15819</span>&#160;   <span class="keywordtype">int</span> snapshot_index,</div><div class="line"><a name="l15820"></a><span class="lineno">15820</span>&#160;   <span class="keywordtype">int</span> mailbox_index,</div><div class="line"><a name="l15821"></a><span class="lineno">15821</span>&#160;   <span class="keywordtype">int</span> descending,</div><div class="line"><a name="l15822"></a><span class="lineno">15822</span>&#160;   <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491">ast_vm_snapshot_sort_val</a> sort_val)</div><div class="line"><a name="l15823"></a><span class="lineno">15823</span>&#160;{</div><div class="line"><a name="l15824"></a><span class="lineno">15824</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *msg_snapshot;</div><div class="line"><a name="l15825"></a><span class="lineno">15825</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *msg_snapshot_tmp;</div><div class="line"><a name="l15826"></a><span class="lineno">15826</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l15827"></a><span class="lineno">15827</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l15828"></a><span class="lineno">15828</span>&#160;   <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l15829"></a><span class="lineno">15829</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;</div><div class="line"><a name="l15830"></a><span class="lineno">15830</span>&#160;</div><div class="line"><a name="l15831"></a><span class="lineno">15831</span>&#160;   <span class="keywordflow">for</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt;= vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++) {</div><div class="line"><a name="l15832"></a><span class="lineno">15832</span>&#160;      <span class="keywordtype">int</span> inserted = 0;</div><div class="line"><a name="l15833"></a><span class="lineno">15833</span>&#160;      <span class="comment">/* Find the msg */</span></div><div class="line"><a name="l15834"></a><span class="lineno">15834</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l15835"></a><span class="lineno">15835</span>&#160;      snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l15836"></a><span class="lineno">15836</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l15837"></a><span class="lineno">15837</span>&#160;      msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l15838"></a><span class="lineno">15838</span>&#160;      <span class="keywordflow">if</span> (!msg_cfg || msg_cfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l15839"></a><span class="lineno">15839</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l15840"></a><span class="lineno">15840</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l15841"></a><span class="lineno">15841</span>&#160;      }</div><div class="line"><a name="l15842"></a><span class="lineno">15842</span>&#160;</div><div class="line"><a name="l15843"></a><span class="lineno">15843</span>&#160;      <span class="comment">/* Create the snapshot object */</span></div><div class="line"><a name="l15844"></a><span class="lineno">15844</span>&#160;      <span class="keywordflow">if</span> (!(msg_snapshot = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a9286e529100ea42afa05db24311cf965">vm_msg_snapshot_alloc</a>())) {</div><div class="line"><a name="l15845"></a><span class="lineno">15845</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15846"></a><span class="lineno">15846</span>&#160;         <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l15847"></a><span class="lineno">15847</span>&#160;      }</div><div class="line"><a name="l15848"></a><span class="lineno">15848</span>&#160;</div><div class="line"><a name="l15849"></a><span class="lineno">15849</span>&#160;      <span class="comment">/* Fill in the snapshot object */</span></div><div class="line"><a name="l15850"></a><span class="lineno">15850</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;msg_id&quot;</span>))) {</div><div class="line"><a name="l15851"></a><span class="lineno">15851</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, msg_id, value);</div><div class="line"><a name="l15852"></a><span class="lineno">15852</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15853"></a><span class="lineno">15853</span>&#160;         <span class="comment">/* Message snapshots *really* should have a</span></div><div class="line"><a name="l15854"></a><span class="lineno">15854</span>&#160;<span class="comment">          * message ID. Add one to the message config</span></div><div class="line"><a name="l15855"></a><span class="lineno">15855</span>&#160;<span class="comment">          * if it does not already exist</span></div><div class="line"><a name="l15856"></a><span class="lineno">15856</span>&#160;<span class="comment">          */</span></div><div class="line"><a name="l15857"></a><span class="lineno">15857</span>&#160;         <span class="keywordtype">char</span> <span class="keywordtype">id</span>[<a class="code" href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a>];</div><div class="line"><a name="l15858"></a><span class="lineno">15858</span>&#160;         <span class="keywordflow">if</span> (!(<a class="code" href="../../dc/df4/app__voicemail_8c.html#aa57da8ecdd64dee4836a96e86dbd7687">add_message_id</a>(msg_cfg, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>,</div><div class="line"><a name="l15859"></a><span class="lineno">15859</span>&#160;                     filename, <span class="keywordtype">id</span>, <span class="keyword">sizeof</span>(<span class="keywordtype">id</span>), vmu, mailbox_index))) {</div><div class="line"><a name="l15860"></a><span class="lineno">15860</span>&#160;            <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, msg_id, <span class="keywordtype">id</span>);</div><div class="line"><a name="l15861"></a><span class="lineno">15861</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15862"></a><span class="lineno">15862</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create a message ID for message %s/%d\n&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l15863"></a><span class="lineno">15863</span>&#160;         }</div><div class="line"><a name="l15864"></a><span class="lineno">15864</span>&#160;      }</div><div class="line"><a name="l15865"></a><span class="lineno">15865</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {</div><div class="line"><a name="l15866"></a><span class="lineno">15866</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, callerid, value);</div><div class="line"><a name="l15867"></a><span class="lineno">15867</span>&#160;      }</div><div class="line"><a name="l15868"></a><span class="lineno">15868</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerchan&quot;</span>))) {</div><div class="line"><a name="l15869"></a><span class="lineno">15869</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, callerchan, value);</div><div class="line"><a name="l15870"></a><span class="lineno">15870</span>&#160;      }</div><div class="line"><a name="l15871"></a><span class="lineno">15871</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;exten&quot;</span>))) {</div><div class="line"><a name="l15872"></a><span class="lineno">15872</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, <a class="code" href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, value);</div><div class="line"><a name="l15873"></a><span class="lineno">15873</span>&#160;      }</div><div class="line"><a name="l15874"></a><span class="lineno">15874</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origdate&quot;</span>))) {</div><div class="line"><a name="l15875"></a><span class="lineno">15875</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, origdate, value);</div><div class="line"><a name="l15876"></a><span class="lineno">15876</span>&#160;      }</div><div class="line"><a name="l15877"></a><span class="lineno">15877</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {</div><div class="line"><a name="l15878"></a><span class="lineno">15878</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, origtime, value);</div><div class="line"><a name="l15879"></a><span class="lineno">15879</span>&#160;      }</div><div class="line"><a name="l15880"></a><span class="lineno">15880</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {</div><div class="line"><a name="l15881"></a><span class="lineno">15881</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, duration, value);</div><div class="line"><a name="l15882"></a><span class="lineno">15882</span>&#160;      }</div><div class="line"><a name="l15883"></a><span class="lineno">15883</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;flag&quot;</span>))) {</div><div class="line"><a name="l15884"></a><span class="lineno">15884</span>&#160;         <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, flag, value);</div><div class="line"><a name="l15885"></a><span class="lineno">15885</span>&#160;      }</div><div class="line"><a name="l15886"></a><span class="lineno">15886</span>&#160;      msg_snapshot-&gt;<a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html#a73d00a61bed6e8a91ac3befb90e2d28a">msg_number</a> = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;</div><div class="line"><a name="l15887"></a><span class="lineno">15887</span>&#160;      <a class="code" href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a>(msg_snapshot, folder_name, mailbox_folders[mailbox_index]);</div><div class="line"><a name="l15888"></a><span class="lineno">15888</span>&#160;</div><div class="line"><a name="l15889"></a><span class="lineno">15889</span>&#160;      <span class="comment">/* store msg snapshot in mailbox snapshot */</span></div><div class="line"><a name="l15890"></a><span class="lineno">15890</span>&#160;      <span class="keywordflow">switch</span> (sort_val) {</div><div class="line"><a name="l15891"></a><span class="lineno">15891</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l15892"></a><span class="lineno">15892</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491a564e6105590992ed518ac4dccbdc483b">AST_VM_SNAPSHOT_SORT_BY_ID</a>:</div><div class="line"><a name="l15893"></a><span class="lineno">15893</span>&#160;         <span class="keywordflow">if</span> (descending) {</div><div class="line"><a name="l15894"></a><span class="lineno">15894</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307">AST_LIST_INSERT_HEAD</a>(&amp;mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>[snapshot_index], msg_snapshot, msg);</div><div class="line"><a name="l15895"></a><span class="lineno">15895</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l15896"></a><span class="lineno">15896</span>&#160;            <a class="code" href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a>(&amp;mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>[snapshot_index], msg_snapshot, msg);</div><div class="line"><a name="l15897"></a><span class="lineno">15897</span>&#160;         }</div><div class="line"><a name="l15898"></a><span class="lineno">15898</span>&#160;         inserted = 1;</div><div class="line"><a name="l15899"></a><span class="lineno">15899</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15900"></a><span class="lineno">15900</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491ad95c70e1f5ce29d7ff275fea928b76ee">AST_VM_SNAPSHOT_SORT_BY_TIME</a>:</div><div class="line"><a name="l15901"></a><span class="lineno">15901</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>[snapshot_index], msg_snapshot_tmp, msg) {</div><div class="line"><a name="l15902"></a><span class="lineno">15902</span>&#160;            <span class="keywordtype">int</span> <a class="code" href="../../d5/d85/structval.html">val</a> = strcmp(msg_snapshot-&gt;<a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html#a1eb8e3f5b54979ef94248fa4f7bd3104">origtime</a>, msg_snapshot_tmp-&gt;<a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html#a1eb8e3f5b54979ef94248fa4f7bd3104">origtime</a>);</div><div class="line"><a name="l15903"></a><span class="lineno">15903</span>&#160;            <span class="keywordflow">if</span> (descending &amp;&amp; val &gt;= 0) {</div><div class="line"><a name="l15904"></a><span class="lineno">15904</span>&#160;               <a class="code" href="../../df/d90/linkedlists_8h.html#a83227c4f8c836f0452b607507c55752f">AST_LIST_INSERT_BEFORE_CURRENT</a>(msg_snapshot, msg);</div><div class="line"><a name="l15905"></a><span class="lineno">15905</span>&#160;               inserted = 1;</div><div class="line"><a name="l15906"></a><span class="lineno">15906</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l15907"></a><span class="lineno">15907</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!descending &amp;&amp; val &lt;= 0) {</div><div class="line"><a name="l15908"></a><span class="lineno">15908</span>&#160;               <a class="code" href="../../df/d90/linkedlists_8h.html#a83227c4f8c836f0452b607507c55752f">AST_LIST_INSERT_BEFORE_CURRENT</a>(msg_snapshot, msg);</div><div class="line"><a name="l15909"></a><span class="lineno">15909</span>&#160;               inserted = 1;</div><div class="line"><a name="l15910"></a><span class="lineno">15910</span>&#160;               <span class="keywordflow">break</span>;</div><div class="line"><a name="l15911"></a><span class="lineno">15911</span>&#160;            }</div><div class="line"><a name="l15912"></a><span class="lineno">15912</span>&#160;         }</div><div class="line"><a name="l15913"></a><span class="lineno">15913</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a>;</div><div class="line"><a name="l15914"></a><span class="lineno">15914</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l15915"></a><span class="lineno">15915</span>&#160;      }</div><div class="line"><a name="l15916"></a><span class="lineno">15916</span>&#160;</div><div class="line"><a name="l15917"></a><span class="lineno">15917</span>&#160;      <span class="keywordflow">if</span> (!inserted) {</div><div class="line"><a name="l15918"></a><span class="lineno">15918</span>&#160;         <a class="code" href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a>(&amp;mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>[snapshot_index], msg_snapshot, msg);</div><div class="line"><a name="l15919"></a><span class="lineno">15919</span>&#160;      }</div><div class="line"><a name="l15920"></a><span class="lineno">15920</span>&#160;</div><div class="line"><a name="l15921"></a><span class="lineno">15921</span>&#160;      mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#adf7744e2e72a9785679d9d326009e952">total_msg_num</a>++;</div><div class="line"><a name="l15922"></a><span class="lineno">15922</span>&#160;</div><div class="line"><a name="l15923"></a><span class="lineno">15923</span>&#160;      <span class="comment">/* cleanup configs and msg */</span></div><div class="line"><a name="l15924"></a><span class="lineno">15924</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l15925"></a><span class="lineno">15925</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l15926"></a><span class="lineno">15926</span>&#160;   }</div><div class="line"><a name="l15927"></a><span class="lineno">15927</span>&#160;</div><div class="line"><a name="l15928"></a><span class="lineno">15928</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l15929"></a><span class="lineno">15929</span>&#160;}</div><div class="line"><a name="l15930"></a><span class="lineno">15930</span>&#160;</div><div class="line"><a name="l15931"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#ae48d2d40fd20f61d2324906383df2d6e">15931</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#ae48d2d40fd20f61d2324906383df2d6e">vm_mailbox_snapshot_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line"><a name="l15932"></a><span class="lineno">15932</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line"><a name="l15933"></a><span class="lineno">15933</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *folder,</div><div class="line"><a name="l15934"></a><span class="lineno">15934</span>&#160;   <span class="keywordtype">int</span> descending,</div><div class="line"><a name="l15935"></a><span class="lineno">15935</span>&#160;   <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491">ast_vm_snapshot_sort_val</a> sort_val,</div><div class="line"><a name="l15936"></a><span class="lineno">15936</span>&#160;   <span class="keywordtype">int</span> combine_INBOX_and_OLD)</div><div class="line"><a name="l15937"></a><span class="lineno">15937</span>&#160;{</div><div class="line"><a name="l15938"></a><span class="lineno">15938</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *mailbox_snapshot;</div><div class="line"><a name="l15939"></a><span class="lineno">15939</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms;</div><div class="line"><a name="l15940"></a><span class="lineno">15940</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus;</div><div class="line"><a name="l15941"></a><span class="lineno">15941</span>&#160;   <span class="keywordtype">int</span> res;</div><div class="line"><a name="l15942"></a><span class="lineno">15942</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l15943"></a><span class="lineno">15943</span>&#160;   <span class="keywordtype">int</span> this_index_only = -1;</div><div class="line"><a name="l15944"></a><span class="lineno">15944</span>&#160;   <span class="keywordtype">int</span> open = 0;</div><div class="line"><a name="l15945"></a><span class="lineno">15945</span>&#160;   <span class="keywordtype">int</span> inbox_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(<span class="stringliteral">&quot;INBOX&quot;</span>);</div><div class="line"><a name="l15946"></a><span class="lineno">15946</span>&#160;   <span class="keywordtype">int</span> old_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(<span class="stringliteral">&quot;Old&quot;</span>);</div><div class="line"><a name="l15947"></a><span class="lineno">15947</span>&#160;   <span class="keywordtype">int</span> urgent_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(<span class="stringliteral">&quot;Urgent&quot;</span>);</div><div class="line"><a name="l15948"></a><span class="lineno">15948</span>&#160;</div><div class="line"><a name="l15949"></a><span class="lineno">15949</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) {</div><div class="line"><a name="l15950"></a><span class="lineno">15950</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot create a mailbox snapshot since no mailbox was specified\n&quot;</span>);</div><div class="line"><a name="l15951"></a><span class="lineno">15951</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15952"></a><span class="lineno">15952</span>&#160;   }</div><div class="line"><a name="l15953"></a><span class="lineno">15953</span>&#160;</div><div class="line"><a name="l15954"></a><span class="lineno">15954</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l15955"></a><span class="lineno">15955</span>&#160;</div><div class="line"><a name="l15956"></a><span class="lineno">15956</span>&#160;   <span class="keywordflow">if</span> (!(<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder))) {</div><div class="line"><a name="l15957"></a><span class="lineno">15957</span>&#160;      <span class="comment">/* find the folder index */</span></div><div class="line"><a name="l15958"></a><span class="lineno">15958</span>&#160;      <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mailbox_folders); i++) {</div><div class="line"><a name="l15959"></a><span class="lineno">15959</span>&#160;         <span class="keywordflow">if</span> (!strcasecmp(mailbox_folders[i], folder)) {</div><div class="line"><a name="l15960"></a><span class="lineno">15960</span>&#160;            this_index_only = i;</div><div class="line"><a name="l15961"></a><span class="lineno">15961</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l15962"></a><span class="lineno">15962</span>&#160;         }</div><div class="line"><a name="l15963"></a><span class="lineno">15963</span>&#160;      }</div><div class="line"><a name="l15964"></a><span class="lineno">15964</span>&#160;      <span class="keywordflow">if</span> (this_index_only == -1) {</div><div class="line"><a name="l15965"></a><span class="lineno">15965</span>&#160;         <span class="comment">/* Folder was specified and it did not match any folder in our list */</span></div><div class="line"><a name="l15966"></a><span class="lineno">15966</span>&#160;         <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15967"></a><span class="lineno">15967</span>&#160;      }</div><div class="line"><a name="l15968"></a><span class="lineno">15968</span>&#160;   }</div><div class="line"><a name="l15969"></a><span class="lineno">15969</span>&#160;</div><div class="line"><a name="l15970"></a><span class="lineno">15970</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox))) {</div><div class="line"><a name="l15971"></a><span class="lineno">15971</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to create mailbox snapshot for unknown voicemail user %s@%s\n&quot;</span>, mailbox, context);</div><div class="line"><a name="l15972"></a><span class="lineno">15972</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15973"></a><span class="lineno">15973</span>&#160;   }</div><div class="line"><a name="l15974"></a><span class="lineno">15974</span>&#160;</div><div class="line"><a name="l15975"></a><span class="lineno">15975</span>&#160;   <span class="keywordflow">if</span> (!(mailbox_snapshot = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*mailbox_snapshot)))) {</div><div class="line"><a name="l15976"></a><span class="lineno">15976</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to allocate memory for mailbox snapshot\n&quot;</span>);</div><div class="line"><a name="l15977"></a><span class="lineno">15977</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l15978"></a><span class="lineno">15978</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15979"></a><span class="lineno">15979</span>&#160;   }</div><div class="line"><a name="l15980"></a><span class="lineno">15980</span>&#160;</div><div class="line"><a name="l15981"></a><span class="lineno">15981</span>&#160;   <span class="keywordflow">if</span> (!(mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a> = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(<a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mailbox_folders), <span class="keyword">sizeof</span>(*mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>)))) {</div><div class="line"><a name="l15982"></a><span class="lineno">15982</span>&#160;      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mailbox_snapshot);</div><div class="line"><a name="l15983"></a><span class="lineno">15983</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l15984"></a><span class="lineno">15984</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l15985"></a><span class="lineno">15985</span>&#160;   }</div><div class="line"><a name="l15986"></a><span class="lineno">15986</span>&#160;</div><div class="line"><a name="l15987"></a><span class="lineno">15987</span>&#160;   mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a600bfb84722ece9ee0e2c0eb459dd5ec">folders</a> = <a class="code" href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mailbox_folders);</div><div class="line"><a name="l15988"></a><span class="lineno">15988</span>&#160;</div><div class="line"><a name="l15989"></a><span class="lineno">15989</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a600bfb84722ece9ee0e2c0eb459dd5ec">folders</a>; i++) {</div><div class="line"><a name="l15990"></a><span class="lineno">15990</span>&#160;      <span class="keywordtype">int</span> msg_folder_index = i;</div><div class="line"><a name="l15991"></a><span class="lineno">15991</span>&#160;</div><div class="line"><a name="l15992"></a><span class="lineno">15992</span>&#160;      <span class="comment">/* We want this message in the snapshot if any of the following:</span></div><div class="line"><a name="l15993"></a><span class="lineno">15993</span>&#160;<span class="comment">       *   No folder was specified.</span></div><div class="line"><a name="l15994"></a><span class="lineno">15994</span>&#160;<span class="comment">       *   The specified folder matches the current folder.</span></div><div class="line"><a name="l15995"></a><span class="lineno">15995</span>&#160;<span class="comment">       *   The specified folder is INBOX AND we were asked to combine messages AND the current folder is either Old or Urgent.</span></div><div class="line"><a name="l15996"></a><span class="lineno">15996</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l15997"></a><span class="lineno">15997</span>&#160;      <span class="keywordflow">if</span> (!(this_index_only == -1 || this_index_only == i || (this_index_only == inbox_index &amp;&amp; combine_INBOX_and_OLD &amp;&amp; (i == old_index || i == urgent_index)))) {</div><div class="line"><a name="l15998"></a><span class="lineno">15998</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l15999"></a><span class="lineno">15999</span>&#160;      }</div><div class="line"><a name="l16000"></a><span class="lineno">16000</span>&#160;</div><div class="line"><a name="l16001"></a><span class="lineno">16001</span>&#160;      <span class="comment">/* Make sure that Old or Urgent messages are marked as being in INBOX. */</span></div><div class="line"><a name="l16002"></a><span class="lineno">16002</span>&#160;      <span class="keywordflow">if</span> (combine_INBOX_and_OLD &amp;&amp; (i == old_index || i == urgent_index)) {</div><div class="line"><a name="l16003"></a><span class="lineno">16003</span>&#160;         msg_folder_index = inbox_index;</div><div class="line"><a name="l16004"></a><span class="lineno">16004</span>&#160;      }</div><div class="line"><a name="l16005"></a><span class="lineno">16005</span>&#160;</div><div class="line"><a name="l16006"></a><span class="lineno">16006</span>&#160;      memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));</div><div class="line"><a name="l16007"></a><span class="lineno">16007</span>&#160;      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, mailbox, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l16008"></a><span class="lineno">16008</span>&#160;      vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l16009"></a><span class="lineno">16009</span>&#160;      open = 0;</div><div class="line"><a name="l16010"></a><span class="lineno">16010</span>&#160;</div><div class="line"><a name="l16011"></a><span class="lineno">16011</span>&#160;      <span class="comment">/* open the mailbox state */</span></div><div class="line"><a name="l16012"></a><span class="lineno">16012</span>&#160;      <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, i)) &lt; 0) {</div><div class="line"><a name="l16013"></a><span class="lineno">16013</span>&#160;         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not open mailbox %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l16014"></a><span class="lineno">16014</span>&#160;         <span class="keywordflow">goto</span> snapshot_cleanup;</div><div class="line"><a name="l16015"></a><span class="lineno">16015</span>&#160;      }</div><div class="line"><a name="l16016"></a><span class="lineno">16016</span>&#160;      open = 1;</div><div class="line"><a name="l16017"></a><span class="lineno">16017</span>&#160;</div><div class="line"><a name="l16018"></a><span class="lineno">16018</span>&#160;      <span class="comment">/* Iterate through each msg, storing off info */</span></div><div class="line"><a name="l16019"></a><span class="lineno">16019</span>&#160;      <span class="keywordflow">if</span> (vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> != -1) {</div><div class="line"><a name="l16020"></a><span class="lineno">16020</span>&#160;         <span class="keywordflow">if</span> ((<a class="code" href="../../dc/df4/app__voicemail_8c.html#a690d04bb2d7fc3e5bbe62641861aa435">vm_msg_snapshot_create</a>(vmu, &amp;vms, mailbox_snapshot, msg_folder_index, i, descending, sort_val))) {</div><div class="line"><a name="l16021"></a><span class="lineno">16021</span>&#160;            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to create msg snapshots for %s@%s\n&quot;</span>, mailbox, context);</div><div class="line"><a name="l16022"></a><span class="lineno">16022</span>&#160;            <span class="keywordflow">goto</span> snapshot_cleanup;</div><div class="line"><a name="l16023"></a><span class="lineno">16023</span>&#160;         }</div><div class="line"><a name="l16024"></a><span class="lineno">16024</span>&#160;      }</div><div class="line"><a name="l16025"></a><span class="lineno">16025</span>&#160;</div><div class="line"><a name="l16026"></a><span class="lineno">16026</span>&#160;      <span class="comment">/* close mailbox */</span></div><div class="line"><a name="l16027"></a><span class="lineno">16027</span>&#160;      <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu) == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)) {</div><div class="line"><a name="l16028"></a><span class="lineno">16028</span>&#160;         <span class="keywordflow">goto</span> snapshot_cleanup;</div><div class="line"><a name="l16029"></a><span class="lineno">16029</span>&#160;      }</div><div class="line"><a name="l16030"></a><span class="lineno">16030</span>&#160;      open = 0;</div><div class="line"><a name="l16031"></a><span class="lineno">16031</span>&#160;   }</div><div class="line"><a name="l16032"></a><span class="lineno">16032</span>&#160;</div><div class="line"><a name="l16033"></a><span class="lineno">16033</span>&#160;snapshot_cleanup:</div><div class="line"><a name="l16034"></a><span class="lineno">16034</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; open) {</div><div class="line"><a name="l16035"></a><span class="lineno">16035</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l16036"></a><span class="lineno">16036</span>&#160;   }</div><div class="line"><a name="l16037"></a><span class="lineno">16037</span>&#160;</div><div class="line"><a name="l16038"></a><span class="lineno">16038</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l16039"></a><span class="lineno">16039</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l16040"></a><span class="lineno">16040</span>&#160;      vmstate_delete(&amp;vms);</div><div class="line"><a name="l16041"></a><span class="lineno">16041</span>&#160;   }</div><div class="line"><a name="l16042"></a><span class="lineno">16042</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l16043"></a><span class="lineno">16043</span>&#160;</div><div class="line"><a name="l16044"></a><span class="lineno">16044</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l16045"></a><span class="lineno">16045</span>&#160;   <span class="keywordflow">return</span> mailbox_snapshot;</div><div class="line"><a name="l16046"></a><span class="lineno">16046</span>&#160;}</div><div class="line"><a name="l16047"></a><span class="lineno">16047</span>&#160;</div><div class="line"><a name="l16048"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a654bcd2aee84a0c6d2f90e01f9b5acb8">16048</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a654bcd2aee84a0c6d2f90e01f9b5acb8">vm_mailbox_snapshot_destroy</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *mailbox_snapshot)</div><div class="line"><a name="l16049"></a><span class="lineno">16049</span>&#160;{</div><div class="line"><a name="l16050"></a><span class="lineno">16050</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l16051"></a><span class="lineno">16051</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a> *msg_snapshot;</div><div class="line"><a name="l16052"></a><span class="lineno">16052</span>&#160;</div><div class="line"><a name="l16053"></a><span class="lineno">16053</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a600bfb84722ece9ee0e2c0eb459dd5ec">folders</a>; i++) {</div><div class="line"><a name="l16054"></a><span class="lineno">16054</span>&#160;      <span class="keywordflow">while</span> ((msg_snapshot = <a class="code" href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a>(&amp;mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>[i], msg))) {</div><div class="line"><a name="l16055"></a><span class="lineno">16055</span>&#160;         msg_snapshot = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a2b120ac4209e9e13a383f706787249cf">vm_msg_snapshot_destroy</a>(msg_snapshot);</div><div class="line"><a name="l16056"></a><span class="lineno">16056</span>&#160;      }</div><div class="line"><a name="l16057"></a><span class="lineno">16057</span>&#160;   }</div><div class="line"><a name="l16058"></a><span class="lineno">16058</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mailbox_snapshot-&gt;<a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">snapshots</a>);</div><div class="line"><a name="l16059"></a><span class="lineno">16059</span>&#160;   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mailbox_snapshot);</div><div class="line"><a name="l16060"></a><span class="lineno">16060</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><a name="l16061"></a><span class="lineno">16061</span>&#160;}</div><div class="line"><a name="l16062"></a><span class="lineno">16062</span>&#160;<span class="comment"></span></div><div class="line"><a name="l16063"></a><span class="lineno">16063</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l16064"></a><span class="lineno">16064</span>&#160;<span class="comment"> * \brief common bounds checking and existence check for Voicemail API functions.</span></div><div class="line"><a name="l16065"></a><span class="lineno">16065</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l16066"></a><span class="lineno">16066</span>&#160;<span class="comment"> * \details</span></div><div class="line"><a name="l16067"></a><span class="lineno">16067</span>&#160;<span class="comment"> * This is called by vm_msg_move, vm_msg_remove, and vm_msg_forward to</span></div><div class="line"><a name="l16068"></a><span class="lineno">16068</span>&#160;<span class="comment"> * ensure that data passed in are valid. This ensures that given the</span></div><div class="line"><a name="l16069"></a><span class="lineno">16069</span>&#160;<span class="comment"> * desired message IDs, they can be found.</span></div><div class="line"><a name="l16070"></a><span class="lineno">16070</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l16071"></a><span class="lineno">16071</span>&#160;<span class="comment"> * \param vms The voicemail state corresponding to an open mailbox</span></div><div class="line"><a name="l16072"></a><span class="lineno">16072</span>&#160;<span class="comment"> * \param msg_ids An array of message identifiers</span></div><div class="line"><a name="l16073"></a><span class="lineno">16073</span>&#160;<span class="comment"> * \param num_msgs The number of identifiers in msg_ids</span></div><div class="line"><a name="l16074"></a><span class="lineno">16074</span>&#160;<span class="comment"> * \param msg_nums [out] The message indexes corresponding to the given</span></div><div class="line"><a name="l16075"></a><span class="lineno">16075</span>&#160;<span class="comment"> * \param vmu</span></div><div class="line"><a name="l16076"></a><span class="lineno">16076</span>&#160;<span class="comment"> * message IDs</span></div><div class="line"><a name="l16077"></a><span class="lineno">16077</span>&#160;<span class="comment"> * \pre vms must have open_mailbox() called on it prior to this function.</span></div><div class="line"><a name="l16078"></a><span class="lineno">16078</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l16079"></a><span class="lineno">16079</span>&#160;<span class="comment"> * \retval -1 Failure</span></div><div class="line"><a name="l16080"></a><span class="lineno">16080</span>&#160;<span class="comment"> * \retval 0 Success</span></div><div class="line"><a name="l16081"></a><span class="lineno">16081</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l16082"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">16082</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_ids [], <span class="keywordtype">size_t</span> num_msgs, <span class="keywordtype">int</span> *msg_nums, <span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l16083"></a><span class="lineno">16083</span>&#160;{</div><div class="line"><a name="l16084"></a><span class="lineno">16084</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l16085"></a><span class="lineno">16085</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l16086"></a><span class="lineno">16086</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; num_msgs; ++i) {</div><div class="line"><a name="l16087"></a><span class="lineno">16087</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id = msg_ids[i];</div><div class="line"><a name="l16088"></a><span class="lineno">16088</span>&#160;      <span class="keywordtype">int</span> found = 0;</div><div class="line"><a name="l16089"></a><span class="lineno">16089</span>&#160;      <span class="keywordflow">for</span> (vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt;= vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>; vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++) {</div><div class="line"><a name="l16090"></a><span class="lineno">16090</span>&#160;         <span class="keyword">const</span> <span class="keywordtype">char</span> *other_msg_id;</div><div class="line"><a name="l16091"></a><span class="lineno">16091</span>&#160;         <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l16092"></a><span class="lineno">16092</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l16093"></a><span class="lineno">16093</span>&#160;         <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l16094"></a><span class="lineno">16094</span>&#160;</div><div class="line"><a name="l16095"></a><span class="lineno">16095</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16096"></a><span class="lineno">16096</span>&#160;         snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l16097"></a><span class="lineno">16097</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l16098"></a><span class="lineno">16098</span>&#160;         msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l16099"></a><span class="lineno">16099</span>&#160;         <span class="keywordflow">if</span> (!msg_cfg || msg_cfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l16100"></a><span class="lineno">16100</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16101"></a><span class="lineno">16101</span>&#160;            res = -1;</div><div class="line"><a name="l16102"></a><span class="lineno">16102</span>&#160;            <span class="keywordflow">goto</span> <a class="code" href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a>;</div><div class="line"><a name="l16103"></a><span class="lineno">16103</span>&#160;         }</div><div class="line"><a name="l16104"></a><span class="lineno">16104</span>&#160;</div><div class="line"><a name="l16105"></a><span class="lineno">16105</span>&#160;         other_msg_id = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;msg_id&quot;</span>);</div><div class="line"><a name="l16106"></a><span class="lineno">16106</span>&#160;</div><div class="line"><a name="l16107"></a><span class="lineno">16107</span>&#160;         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(other_msg_id) &amp;&amp; !strcmp(other_msg_id, msg_id)) {</div><div class="line"><a name="l16108"></a><span class="lineno">16108</span>&#160;            <span class="comment">/* Message found. We can get out of this inner loop</span></div><div class="line"><a name="l16109"></a><span class="lineno">16109</span>&#160;<span class="comment">             * and move on to the next message to find</span></div><div class="line"><a name="l16110"></a><span class="lineno">16110</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l16111"></a><span class="lineno">16111</span>&#160;            found = 1;</div><div class="line"><a name="l16112"></a><span class="lineno">16112</span>&#160;            msg_nums[i] = vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;</div><div class="line"><a name="l16113"></a><span class="lineno">16113</span>&#160;            <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l16114"></a><span class="lineno">16114</span>&#160;            <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16115"></a><span class="lineno">16115</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l16116"></a><span class="lineno">16116</span>&#160;         }</div><div class="line"><a name="l16117"></a><span class="lineno">16117</span>&#160;         <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l16118"></a><span class="lineno">16118</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16119"></a><span class="lineno">16119</span>&#160;      }</div><div class="line"><a name="l16120"></a><span class="lineno">16120</span>&#160;      <span class="keywordflow">if</span> (!found) {</div><div class="line"><a name="l16121"></a><span class="lineno">16121</span>&#160;         <span class="comment">/* If we can&#39;t find one of the message IDs requested, then OH NO! */</span></div><div class="line"><a name="l16122"></a><span class="lineno">16122</span>&#160;         res = -1;</div><div class="line"><a name="l16123"></a><span class="lineno">16123</span>&#160;         <span class="keywordflow">goto</span> <a class="code" href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a>;</div><div class="line"><a name="l16124"></a><span class="lineno">16124</span>&#160;      }</div><div class="line"><a name="l16125"></a><span class="lineno">16125</span>&#160;   }</div><div class="line"><a name="l16126"></a><span class="lineno">16126</span>&#160;</div><div class="line"><a name="l16127"></a><span class="lineno">16127</span>&#160;<a class="code" href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a>:</div><div class="line"><a name="l16128"></a><span class="lineno">16128</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l16129"></a><span class="lineno">16129</span>&#160;}</div><div class="line"><a name="l16130"></a><span class="lineno">16130</span>&#160;</div><div class="line"><a name="l16131"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">16131</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(<span class="keyword">struct</span> <a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu)</div><div class="line"><a name="l16132"></a><span class="lineno">16132</span>&#160;{</div><div class="line"><a name="l16133"></a><span class="lineno">16133</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;</div><div class="line"><a name="l16134"></a><span class="lineno">16134</span>&#160;   <span class="keywordtype">char</span> ext_context[1024];</div><div class="line"><a name="l16135"></a><span class="lineno">16135</span>&#160;</div><div class="line"><a name="l16136"></a><span class="lineno">16136</span>&#160;   snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l16137"></a><span class="lineno">16137</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a>(vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"><a name="l16138"></a><span class="lineno">16138</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ace2a3d783f4f79818e14265ae719f06c">ast_app_inboxcount2</a>(ext_context, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);</div><div class="line"><a name="l16139"></a><span class="lineno">16139</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ext_context, urgent, <span class="keyword">new</span>, old);</div><div class="line"><a name="l16140"></a><span class="lineno">16140</span>&#160;}</div><div class="line"><a name="l16141"></a><span class="lineno">16141</span>&#160;</div><div class="line"><a name="l16142"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a90b1b36a3d0c11b8b335f20efe172552">16142</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a90b1b36a3d0c11b8b335f20efe172552">vm_msg_forward</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#a4540ed6a1ea3b69a813ff82e0cfb7587">from_mailbox</a>,</div><div class="line"><a name="l16143"></a><span class="lineno">16143</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *from_context,</div><div class="line"><a name="l16144"></a><span class="lineno">16144</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *from_folder,</div><div class="line"><a name="l16145"></a><span class="lineno">16145</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_mailbox,</div><div class="line"><a name="l16146"></a><span class="lineno">16146</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_context,</div><div class="line"><a name="l16147"></a><span class="lineno">16147</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_folder,</div><div class="line"><a name="l16148"></a><span class="lineno">16148</span>&#160;   <span class="keywordtype">size_t</span> num_msgs,</div><div class="line"><a name="l16149"></a><span class="lineno">16149</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_ids [],</div><div class="line"><a name="l16150"></a><span class="lineno">16150</span>&#160;   <span class="keywordtype">int</span> delete_old)</div><div class="line"><a name="l16151"></a><span class="lineno">16151</span>&#160;{</div><div class="line"><a name="l16152"></a><span class="lineno">16152</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> from_vms;</div><div class="line"><a name="l16153"></a><span class="lineno">16153</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus;</div><div class="line"><a name="l16154"></a><span class="lineno">16154</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *to_vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, to_vmus;</div><div class="line"><a name="l16155"></a><span class="lineno">16155</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l16156"></a><span class="lineno">16156</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l16157"></a><span class="lineno">16157</span>&#160;   <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l16158"></a><span class="lineno">16158</span>&#160;   <span class="keywordtype">int</span> from_folder_index;</div><div class="line"><a name="l16159"></a><span class="lineno">16159</span>&#160;   <span class="keywordtype">int</span> open = 0;</div><div class="line"><a name="l16160"></a><span class="lineno">16160</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l16161"></a><span class="lineno">16161</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l16162"></a><span class="lineno">16162</span>&#160;   <span class="keywordtype">int</span> *msg_nums;</div><div class="line"><a name="l16163"></a><span class="lineno">16163</span>&#160;</div><div class="line"><a name="l16164"></a><span class="lineno">16164</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(from_mailbox) || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(to_mailbox)) {</div><div class="line"><a name="l16165"></a><span class="lineno">16165</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot forward message because either the from or to mailbox was not specified\n&quot;</span>);</div><div class="line"><a name="l16166"></a><span class="lineno">16166</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16167"></a><span class="lineno">16167</span>&#160;   }</div><div class="line"><a name="l16168"></a><span class="lineno">16168</span>&#160;</div><div class="line"><a name="l16169"></a><span class="lineno">16169</span>&#160;   <span class="keywordflow">if</span> (!num_msgs) {</div><div class="line"><a name="l16170"></a><span class="lineno">16170</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages specified to forward: %zu\n&quot;</span>, num_msgs);</div><div class="line"><a name="l16171"></a><span class="lineno">16171</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16172"></a><span class="lineno">16172</span>&#160;   }</div><div class="line"><a name="l16173"></a><span class="lineno">16173</span>&#160;</div><div class="line"><a name="l16174"></a><span class="lineno">16174</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(from_folder) || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(to_folder)) {</div><div class="line"><a name="l16175"></a><span class="lineno">16175</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot forward message because the from_folder or to_folder was not specified\n&quot;</span>);</div><div class="line"><a name="l16176"></a><span class="lineno">16176</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16177"></a><span class="lineno">16177</span>&#160;   }</div><div class="line"><a name="l16178"></a><span class="lineno">16178</span>&#160;</div><div class="line"><a name="l16179"></a><span class="lineno">16179</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l16180"></a><span class="lineno">16180</span>&#160;   memset(&amp;to_vmus, 0, <span class="keyword">sizeof</span>(to_vmus));</div><div class="line"><a name="l16181"></a><span class="lineno">16181</span>&#160;   memset(&amp;from_vms, 0, <span class="keyword">sizeof</span>(from_vms));</div><div class="line"><a name="l16182"></a><span class="lineno">16182</span>&#160;</div><div class="line"><a name="l16183"></a><span class="lineno">16183</span>&#160;   from_folder_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(from_folder);</div><div class="line"><a name="l16184"></a><span class="lineno">16184</span>&#160;   <span class="keywordflow">if</span> (from_folder_index == -1) {</div><div class="line"><a name="l16185"></a><span class="lineno">16185</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16186"></a><span class="lineno">16186</span>&#160;   }</div><div class="line"><a name="l16187"></a><span class="lineno">16187</span>&#160;</div><div class="line"><a name="l16188"></a><span class="lineno">16188</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(to_folder) == -1) {</div><div class="line"><a name="l16189"></a><span class="lineno">16189</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16190"></a><span class="lineno">16190</span>&#160;   }</div><div class="line"><a name="l16191"></a><span class="lineno">16191</span>&#160;</div><div class="line"><a name="l16192"></a><span class="lineno">16192</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, from_context, from_mailbox))) {</div><div class="line"><a name="l16193"></a><span class="lineno">16193</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&#39;t find voicemail user to forward from (%s@%s)\n&quot;</span>, from_mailbox, from_context);</div><div class="line"><a name="l16194"></a><span class="lineno">16194</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16195"></a><span class="lineno">16195</span>&#160;   }</div><div class="line"><a name="l16196"></a><span class="lineno">16196</span>&#160;</div><div class="line"><a name="l16197"></a><span class="lineno">16197</span>&#160;   <span class="keywordflow">if</span> (!(to_vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;to_vmus, to_context, to_mailbox))) {</div><div class="line"><a name="l16198"></a><span class="lineno">16198</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&#39;t find voicemail user to forward to (%s@%s)\n&quot;</span>, to_mailbox, to_context);</div><div class="line"><a name="l16199"></a><span class="lineno">16199</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l16200"></a><span class="lineno">16200</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16201"></a><span class="lineno">16201</span>&#160;   }</div><div class="line"><a name="l16202"></a><span class="lineno">16202</span>&#160;</div><div class="line"><a name="l16203"></a><span class="lineno">16203</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, from_mailbox, <span class="keyword">sizeof</span>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l16204"></a><span class="lineno">16204</span>&#160;   from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l16205"></a><span class="lineno">16205</span>&#160;   open = 0;</div><div class="line"><a name="l16206"></a><span class="lineno">16206</span>&#160;</div><div class="line"><a name="l16207"></a><span class="lineno">16207</span>&#160;   <span class="comment">/* open the mailbox state */</span></div><div class="line"><a name="l16208"></a><span class="lineno">16208</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;from_vms, vmu, from_folder_index)) &lt; 0) {</div><div class="line"><a name="l16209"></a><span class="lineno">16209</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not open mailbox %s\n&quot;</span>, from_mailbox);</div><div class="line"><a name="l16210"></a><span class="lineno">16210</span>&#160;      res = -1;</div><div class="line"><a name="l16211"></a><span class="lineno">16211</span>&#160;      <span class="keywordflow">goto</span> vm_forward_cleanup;</div><div class="line"><a name="l16212"></a><span class="lineno">16212</span>&#160;   }</div><div class="line"><a name="l16213"></a><span class="lineno">16213</span>&#160;</div><div class="line"><a name="l16214"></a><span class="lineno">16214</span>&#160;   open = 1;</div><div class="line"><a name="l16215"></a><span class="lineno">16215</span>&#160;</div><div class="line"><a name="l16216"></a><span class="lineno">16216</span>&#160;   <span class="keywordflow">if</span> ((from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1) &lt; num_msgs) {</div><div class="line"><a name="l16217"></a><span class="lineno">16217</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Folder %s has less than %zu messages\n&quot;</span>, from_folder, num_msgs);</div><div class="line"><a name="l16218"></a><span class="lineno">16218</span>&#160;      res = -1;</div><div class="line"><a name="l16219"></a><span class="lineno">16219</span>&#160;      <span class="keywordflow">goto</span> vm_forward_cleanup;</div><div class="line"><a name="l16220"></a><span class="lineno">16220</span>&#160;   }</div><div class="line"><a name="l16221"></a><span class="lineno">16221</span>&#160;</div><div class="line"><a name="l16222"></a><span class="lineno">16222</span>&#160;   msg_nums = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * num_msgs);</div><div class="line"><a name="l16223"></a><span class="lineno">16223</span>&#160;</div><div class="line"><a name="l16224"></a><span class="lineno">16224</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(&amp;from_vms, msg_ids, num_msgs, msg_nums, vmu) &lt; 0)) {</div><div class="line"><a name="l16225"></a><span class="lineno">16225</span>&#160;      <span class="keywordflow">goto</span> vm_forward_cleanup;</div><div class="line"><a name="l16226"></a><span class="lineno">16226</span>&#160;   }</div><div class="line"><a name="l16227"></a><span class="lineno">16227</span>&#160;</div><div class="line"><a name="l16228"></a><span class="lineno">16228</span>&#160;   <span class="comment">/* Now we actually forward the messages */</span></div><div class="line"><a name="l16229"></a><span class="lineno">16229</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; num_msgs; i++) {</div><div class="line"><a name="l16230"></a><span class="lineno">16230</span>&#160;      <span class="keywordtype">int</span> cur_msg = msg_nums[i];</div><div class="line"><a name="l16231"></a><span class="lineno">16231</span>&#160;      <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l16232"></a><span class="lineno">16232</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;</div><div class="line"><a name="l16233"></a><span class="lineno">16233</span>&#160;</div><div class="line"><a name="l16234"></a><span class="lineno">16234</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, cur_msg);</div><div class="line"><a name="l16235"></a><span class="lineno">16235</span>&#160;      snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l16236"></a><span class="lineno">16236</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, cur_msg, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l16237"></a><span class="lineno">16237</span>&#160;      msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l16238"></a><span class="lineno">16238</span>&#160;      <span class="comment">/* XXX This likely will not fail since we previously ensured that the</span></div><div class="line"><a name="l16239"></a><span class="lineno">16239</span>&#160;<span class="comment">       * message we are looking for exists. However, there still could be some</span></div><div class="line"><a name="l16240"></a><span class="lineno">16240</span>&#160;<span class="comment">       * circumstance where this fails, so atomicity is not guaranteed.</span></div><div class="line"><a name="l16241"></a><span class="lineno">16241</span>&#160;<span class="comment">       */</span></div><div class="line"><a name="l16242"></a><span class="lineno">16242</span>&#160;      <span class="keywordflow">if</span> (!msg_cfg || msg_cfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l16243"></a><span class="lineno">16243</span>&#160;         <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, cur_msg);</div><div class="line"><a name="l16244"></a><span class="lineno">16244</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l16245"></a><span class="lineno">16245</span>&#160;      }</div><div class="line"><a name="l16246"></a><span class="lineno">16246</span>&#160;      <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {</div><div class="line"><a name="l16247"></a><span class="lineno">16247</span>&#160;         duration = atoi(value);</div><div class="line"><a name="l16248"></a><span class="lineno">16248</span>&#160;      }</div><div class="line"><a name="l16249"></a><span class="lineno">16249</span>&#160;</div><div class="line"><a name="l16250"></a><span class="lineno">16250</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039">copy_message</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmu, from_folder_index, cur_msg, duration, to_vmu, vmfmts, from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, <span class="stringliteral">&quot;&quot;</span>, to_folder);</div><div class="line"><a name="l16251"></a><span class="lineno">16251</span>&#160;</div><div class="line"><a name="l16252"></a><span class="lineno">16252</span>&#160;      <span class="keywordflow">if</span> (delete_old) {</div><div class="line"><a name="l16253"></a><span class="lineno">16253</span>&#160;         from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[cur_msg] = 1;</div><div class="line"><a name="l16254"></a><span class="lineno">16254</span>&#160;      }</div><div class="line"><a name="l16255"></a><span class="lineno">16255</span>&#160;      <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l16256"></a><span class="lineno">16256</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(from_vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, cur_msg);</div><div class="line"><a name="l16257"></a><span class="lineno">16257</span>&#160;   }</div><div class="line"><a name="l16258"></a><span class="lineno">16258</span>&#160;</div><div class="line"><a name="l16259"></a><span class="lineno">16259</span>&#160;   <span class="comment">/* close mailbox */</span></div><div class="line"><a name="l16260"></a><span class="lineno">16260</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;from_vms, vmu) == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)) {</div><div class="line"><a name="l16261"></a><span class="lineno">16261</span>&#160;      res = -1;</div><div class="line"><a name="l16262"></a><span class="lineno">16262</span>&#160;      <span class="keywordflow">goto</span> vm_forward_cleanup;</div><div class="line"><a name="l16263"></a><span class="lineno">16263</span>&#160;   }</div><div class="line"><a name="l16264"></a><span class="lineno">16264</span>&#160;   open = 0;</div><div class="line"><a name="l16265"></a><span class="lineno">16265</span>&#160;</div><div class="line"><a name="l16266"></a><span class="lineno">16266</span>&#160;vm_forward_cleanup:</div><div class="line"><a name="l16267"></a><span class="lineno">16267</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; open) {</div><div class="line"><a name="l16268"></a><span class="lineno">16268</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;from_vms, vmu);</div><div class="line"><a name="l16269"></a><span class="lineno">16269</span>&#160;   }</div><div class="line"><a name="l16270"></a><span class="lineno">16270</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l16271"></a><span class="lineno">16271</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l16272"></a><span class="lineno">16272</span>&#160;      vmstate_delete(&amp;from_vms);</div><div class="line"><a name="l16273"></a><span class="lineno">16273</span>&#160;   }</div><div class="line"><a name="l16274"></a><span class="lineno">16274</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l16275"></a><span class="lineno">16275</span>&#160;</div><div class="line"><a name="l16276"></a><span class="lineno">16276</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l16277"></a><span class="lineno">16277</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(to_vmu);</div><div class="line"><a name="l16278"></a><span class="lineno">16278</span>&#160;   }</div><div class="line"><a name="l16279"></a><span class="lineno">16279</span>&#160;</div><div class="line"><a name="l16280"></a><span class="lineno">16280</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l16281"></a><span class="lineno">16281</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(to_vmu);</div><div class="line"><a name="l16282"></a><span class="lineno">16282</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l16283"></a><span class="lineno">16283</span>&#160;}</div><div class="line"><a name="l16284"></a><span class="lineno">16284</span>&#160;</div><div class="line"><a name="l16285"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#aea7a0b8f32697c42dd05115e26a114d8">16285</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#aea7a0b8f32697c42dd05115e26a114d8">vm_msg_move</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line"><a name="l16286"></a><span class="lineno">16286</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line"><a name="l16287"></a><span class="lineno">16287</span>&#160;   <span class="keywordtype">size_t</span> num_msgs,</div><div class="line"><a name="l16288"></a><span class="lineno">16288</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *oldfolder,</div><div class="line"><a name="l16289"></a><span class="lineno">16289</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *old_msg_ids [],</div><div class="line"><a name="l16290"></a><span class="lineno">16290</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *newfolder)</div><div class="line"><a name="l16291"></a><span class="lineno">16291</span>&#160;{</div><div class="line"><a name="l16292"></a><span class="lineno">16292</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms;</div><div class="line"><a name="l16293"></a><span class="lineno">16293</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus;</div><div class="line"><a name="l16294"></a><span class="lineno">16294</span>&#160;   <span class="keywordtype">int</span> old_folder_index;</div><div class="line"><a name="l16295"></a><span class="lineno">16295</span>&#160;   <span class="keywordtype">int</span> new_folder_index;</div><div class="line"><a name="l16296"></a><span class="lineno">16296</span>&#160;   <span class="keywordtype">int</span> open = 0;</div><div class="line"><a name="l16297"></a><span class="lineno">16297</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l16298"></a><span class="lineno">16298</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l16299"></a><span class="lineno">16299</span>&#160;   <span class="keywordtype">int</span> *old_msg_nums;</div><div class="line"><a name="l16300"></a><span class="lineno">16300</span>&#160;</div><div class="line"><a name="l16301"></a><span class="lineno">16301</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) {</div><div class="line"><a name="l16302"></a><span class="lineno">16302</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot move message because no mailbox was specified\n&quot;</span>);</div><div class="line"><a name="l16303"></a><span class="lineno">16303</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16304"></a><span class="lineno">16304</span>&#160;   }</div><div class="line"><a name="l16305"></a><span class="lineno">16305</span>&#160;</div><div class="line"><a name="l16306"></a><span class="lineno">16306</span>&#160;   <span class="keywordflow">if</span> (!num_msgs) {</div><div class="line"><a name="l16307"></a><span class="lineno">16307</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages specified to move: %zu\n&quot;</span>, num_msgs);</div><div class="line"><a name="l16308"></a><span class="lineno">16308</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16309"></a><span class="lineno">16309</span>&#160;   }</div><div class="line"><a name="l16310"></a><span class="lineno">16310</span>&#160;</div><div class="line"><a name="l16311"></a><span class="lineno">16311</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(oldfolder) || <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(newfolder)) {</div><div class="line"><a name="l16312"></a><span class="lineno">16312</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot move message because either oldfolder or newfolder was not specified\n&quot;</span>);</div><div class="line"><a name="l16313"></a><span class="lineno">16313</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16314"></a><span class="lineno">16314</span>&#160;   }</div><div class="line"><a name="l16315"></a><span class="lineno">16315</span>&#160;</div><div class="line"><a name="l16316"></a><span class="lineno">16316</span>&#160;   old_folder_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(oldfolder);</div><div class="line"><a name="l16317"></a><span class="lineno">16317</span>&#160;   new_folder_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(newfolder);</div><div class="line"><a name="l16318"></a><span class="lineno">16318</span>&#160;</div><div class="line"><a name="l16319"></a><span class="lineno">16319</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l16320"></a><span class="lineno">16320</span>&#160;   memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));</div><div class="line"><a name="l16321"></a><span class="lineno">16321</span>&#160;</div><div class="line"><a name="l16322"></a><span class="lineno">16322</span>&#160;   <span class="keywordflow">if</span> (old_folder_index == -1 || new_folder_index == -1) {</div><div class="line"><a name="l16323"></a><span class="lineno">16323</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16324"></a><span class="lineno">16324</span>&#160;   }</div><div class="line"><a name="l16325"></a><span class="lineno">16325</span>&#160;</div><div class="line"><a name="l16326"></a><span class="lineno">16326</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox))) {</div><div class="line"><a name="l16327"></a><span class="lineno">16327</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16328"></a><span class="lineno">16328</span>&#160;   }</div><div class="line"><a name="l16329"></a><span class="lineno">16329</span>&#160;</div><div class="line"><a name="l16330"></a><span class="lineno">16330</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, mailbox, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l16331"></a><span class="lineno">16331</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l16332"></a><span class="lineno">16332</span>&#160;   open = 0;</div><div class="line"><a name="l16333"></a><span class="lineno">16333</span>&#160;</div><div class="line"><a name="l16334"></a><span class="lineno">16334</span>&#160;   <span class="comment">/* open the mailbox state */</span></div><div class="line"><a name="l16335"></a><span class="lineno">16335</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, old_folder_index)) &lt; 0) {</div><div class="line"><a name="l16336"></a><span class="lineno">16336</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not open mailbox %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l16337"></a><span class="lineno">16337</span>&#160;      res = -1;</div><div class="line"><a name="l16338"></a><span class="lineno">16338</span>&#160;      <span class="keywordflow">goto</span> vm_move_cleanup;</div><div class="line"><a name="l16339"></a><span class="lineno">16339</span>&#160;   }</div><div class="line"><a name="l16340"></a><span class="lineno">16340</span>&#160;</div><div class="line"><a name="l16341"></a><span class="lineno">16341</span>&#160;   open = 1;</div><div class="line"><a name="l16342"></a><span class="lineno">16342</span>&#160;</div><div class="line"><a name="l16343"></a><span class="lineno">16343</span>&#160;   <span class="keywordflow">if</span> ((vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1) &lt; num_msgs) {</div><div class="line"><a name="l16344"></a><span class="lineno">16344</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Folder %s has less than %zu messages\n&quot;</span>, oldfolder, num_msgs);</div><div class="line"><a name="l16345"></a><span class="lineno">16345</span>&#160;      res = -1;</div><div class="line"><a name="l16346"></a><span class="lineno">16346</span>&#160;      <span class="keywordflow">goto</span> vm_move_cleanup;</div><div class="line"><a name="l16347"></a><span class="lineno">16347</span>&#160;   }</div><div class="line"><a name="l16348"></a><span class="lineno">16348</span>&#160;</div><div class="line"><a name="l16349"></a><span class="lineno">16349</span>&#160;   old_msg_nums = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * num_msgs);</div><div class="line"><a name="l16350"></a><span class="lineno">16350</span>&#160;</div><div class="line"><a name="l16351"></a><span class="lineno">16351</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(&amp;vms, old_msg_ids, num_msgs, old_msg_nums, vmu)) &lt; 0) {</div><div class="line"><a name="l16352"></a><span class="lineno">16352</span>&#160;      <span class="keywordflow">goto</span> vm_move_cleanup;</div><div class="line"><a name="l16353"></a><span class="lineno">16353</span>&#160;   }</div><div class="line"><a name="l16354"></a><span class="lineno">16354</span>&#160;</div><div class="line"><a name="l16355"></a><span class="lineno">16355</span>&#160;   <span class="comment">/* Now actually move the message */</span></div><div class="line"><a name="l16356"></a><span class="lineno">16356</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; num_msgs; ++i) {</div><div class="line"><a name="l16357"></a><span class="lineno">16357</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a>(vmu, &amp;vms, old_msg_nums[i], new_folder_index, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)) {</div><div class="line"><a name="l16358"></a><span class="lineno">16358</span>&#160;         res = -1;</div><div class="line"><a name="l16359"></a><span class="lineno">16359</span>&#160;         <span class="keywordflow">goto</span> vm_move_cleanup;</div><div class="line"><a name="l16360"></a><span class="lineno">16360</span>&#160;      }</div><div class="line"><a name="l16361"></a><span class="lineno">16361</span>&#160;      vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[old_msg_nums[i]] = 1;</div><div class="line"><a name="l16362"></a><span class="lineno">16362</span>&#160;   }</div><div class="line"><a name="l16363"></a><span class="lineno">16363</span>&#160;</div><div class="line"><a name="l16364"></a><span class="lineno">16364</span>&#160;   <span class="comment">/* close mailbox */</span></div><div class="line"><a name="l16365"></a><span class="lineno">16365</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu) == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)) {</div><div class="line"><a name="l16366"></a><span class="lineno">16366</span>&#160;      res = -1;</div><div class="line"><a name="l16367"></a><span class="lineno">16367</span>&#160;      <span class="keywordflow">goto</span> vm_move_cleanup;</div><div class="line"><a name="l16368"></a><span class="lineno">16368</span>&#160;   }</div><div class="line"><a name="l16369"></a><span class="lineno">16369</span>&#160;   open = 0;</div><div class="line"><a name="l16370"></a><span class="lineno">16370</span>&#160;</div><div class="line"><a name="l16371"></a><span class="lineno">16371</span>&#160;vm_move_cleanup:</div><div class="line"><a name="l16372"></a><span class="lineno">16372</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; open) {</div><div class="line"><a name="l16373"></a><span class="lineno">16373</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l16374"></a><span class="lineno">16374</span>&#160;   }</div><div class="line"><a name="l16375"></a><span class="lineno">16375</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l16376"></a><span class="lineno">16376</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l16377"></a><span class="lineno">16377</span>&#160;      vmstate_delete(&amp;vms);</div><div class="line"><a name="l16378"></a><span class="lineno">16378</span>&#160;   }</div><div class="line"><a name="l16379"></a><span class="lineno">16379</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l16380"></a><span class="lineno">16380</span>&#160;</div><div class="line"><a name="l16381"></a><span class="lineno">16381</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l16382"></a><span class="lineno">16382</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(vmu);</div><div class="line"><a name="l16383"></a><span class="lineno">16383</span>&#160;   }</div><div class="line"><a name="l16384"></a><span class="lineno">16384</span>&#160;</div><div class="line"><a name="l16385"></a><span class="lineno">16385</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l16386"></a><span class="lineno">16386</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l16387"></a><span class="lineno">16387</span>&#160;}</div><div class="line"><a name="l16388"></a><span class="lineno">16388</span>&#160;</div><div class="line"><a name="l16389"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#abc03cd67e3d9bff7bde30ff5877c317f">16389</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abc03cd67e3d9bff7bde30ff5877c317f">vm_msg_remove</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line"><a name="l16390"></a><span class="lineno">16390</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line"><a name="l16391"></a><span class="lineno">16391</span>&#160;   <span class="keywordtype">size_t</span> num_msgs,</div><div class="line"><a name="l16392"></a><span class="lineno">16392</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *folder,</div><div class="line"><a name="l16393"></a><span class="lineno">16393</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msgs[])</div><div class="line"><a name="l16394"></a><span class="lineno">16394</span>&#160;{</div><div class="line"><a name="l16395"></a><span class="lineno">16395</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms;</div><div class="line"><a name="l16396"></a><span class="lineno">16396</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus;</div><div class="line"><a name="l16397"></a><span class="lineno">16397</span>&#160;   <span class="keywordtype">int</span> folder_index;</div><div class="line"><a name="l16398"></a><span class="lineno">16398</span>&#160;   <span class="keywordtype">int</span> open = 0;</div><div class="line"><a name="l16399"></a><span class="lineno">16399</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l16400"></a><span class="lineno">16400</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l16401"></a><span class="lineno">16401</span>&#160;   <span class="keywordtype">int</span> *msg_nums;</div><div class="line"><a name="l16402"></a><span class="lineno">16402</span>&#160;</div><div class="line"><a name="l16403"></a><span class="lineno">16403</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) {</div><div class="line"><a name="l16404"></a><span class="lineno">16404</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot remove message because no mailbox was specified\n&quot;</span>);</div><div class="line"><a name="l16405"></a><span class="lineno">16405</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16406"></a><span class="lineno">16406</span>&#160;   }</div><div class="line"><a name="l16407"></a><span class="lineno">16407</span>&#160;</div><div class="line"><a name="l16408"></a><span class="lineno">16408</span>&#160;   <span class="keywordflow">if</span> (!num_msgs) {</div><div class="line"><a name="l16409"></a><span class="lineno">16409</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages specified to remove: %zu\n&quot;</span>, num_msgs);</div><div class="line"><a name="l16410"></a><span class="lineno">16410</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16411"></a><span class="lineno">16411</span>&#160;   }</div><div class="line"><a name="l16412"></a><span class="lineno">16412</span>&#160;</div><div class="line"><a name="l16413"></a><span class="lineno">16413</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder)) {</div><div class="line"><a name="l16414"></a><span class="lineno">16414</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot remove message because no folder was specified\n&quot;</span>);</div><div class="line"><a name="l16415"></a><span class="lineno">16415</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16416"></a><span class="lineno">16416</span>&#160;   }</div><div class="line"><a name="l16417"></a><span class="lineno">16417</span>&#160;</div><div class="line"><a name="l16418"></a><span class="lineno">16418</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l16419"></a><span class="lineno">16419</span>&#160;   memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));</div><div class="line"><a name="l16420"></a><span class="lineno">16420</span>&#160;</div><div class="line"><a name="l16421"></a><span class="lineno">16421</span>&#160;   folder_index = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(folder);</div><div class="line"><a name="l16422"></a><span class="lineno">16422</span>&#160;   <span class="keywordflow">if</span> (folder_index == -1) {</div><div class="line"><a name="l16423"></a><span class="lineno">16423</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not remove msgs from unknown folder %s\n&quot;</span>, folder);</div><div class="line"><a name="l16424"></a><span class="lineno">16424</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16425"></a><span class="lineno">16425</span>&#160;   }</div><div class="line"><a name="l16426"></a><span class="lineno">16426</span>&#160;</div><div class="line"><a name="l16427"></a><span class="lineno">16427</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox))) {</div><div class="line"><a name="l16428"></a><span class="lineno">16428</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&#39;t find voicemail user to remove msg from (%s@%s)\n&quot;</span>, mailbox, context);</div><div class="line"><a name="l16429"></a><span class="lineno">16429</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16430"></a><span class="lineno">16430</span>&#160;   }</div><div class="line"><a name="l16431"></a><span class="lineno">16431</span>&#160;</div><div class="line"><a name="l16432"></a><span class="lineno">16432</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, mailbox, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l16433"></a><span class="lineno">16433</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l16434"></a><span class="lineno">16434</span>&#160;   open = 0;</div><div class="line"><a name="l16435"></a><span class="lineno">16435</span>&#160;</div><div class="line"><a name="l16436"></a><span class="lineno">16436</span>&#160;   <span class="comment">/* open the mailbox state */</span></div><div class="line"><a name="l16437"></a><span class="lineno">16437</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, folder_index)) &lt; 0) {</div><div class="line"><a name="l16438"></a><span class="lineno">16438</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not open mailbox %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l16439"></a><span class="lineno">16439</span>&#160;      res = -1;</div><div class="line"><a name="l16440"></a><span class="lineno">16440</span>&#160;      <span class="keywordflow">goto</span> vm_remove_cleanup;</div><div class="line"><a name="l16441"></a><span class="lineno">16441</span>&#160;   }</div><div class="line"><a name="l16442"></a><span class="lineno">16442</span>&#160;</div><div class="line"><a name="l16443"></a><span class="lineno">16443</span>&#160;   open = 1;</div><div class="line"><a name="l16444"></a><span class="lineno">16444</span>&#160;</div><div class="line"><a name="l16445"></a><span class="lineno">16445</span>&#160;   <span class="keywordflow">if</span> ((vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1) &lt; num_msgs) {</div><div class="line"><a name="l16446"></a><span class="lineno">16446</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Folder %s has less than %zu messages\n&quot;</span>, folder, num_msgs);</div><div class="line"><a name="l16447"></a><span class="lineno">16447</span>&#160;      res = -1;</div><div class="line"><a name="l16448"></a><span class="lineno">16448</span>&#160;      <span class="keywordflow">goto</span> vm_remove_cleanup;</div><div class="line"><a name="l16449"></a><span class="lineno">16449</span>&#160;   }</div><div class="line"><a name="l16450"></a><span class="lineno">16450</span>&#160;</div><div class="line"><a name="l16451"></a><span class="lineno">16451</span>&#160;   msg_nums = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * num_msgs);</div><div class="line"><a name="l16452"></a><span class="lineno">16452</span>&#160;</div><div class="line"><a name="l16453"></a><span class="lineno">16453</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(&amp;vms, msgs, num_msgs, msg_nums, vmu)) &lt; 0) {</div><div class="line"><a name="l16454"></a><span class="lineno">16454</span>&#160;      <span class="keywordflow">goto</span> vm_remove_cleanup;</div><div class="line"><a name="l16455"></a><span class="lineno">16455</span>&#160;   }</div><div class="line"><a name="l16456"></a><span class="lineno">16456</span>&#160;</div><div class="line"><a name="l16457"></a><span class="lineno">16457</span>&#160;   <span class="keywordflow">for</span> (i = 0; i &lt; num_msgs; i++) {</div><div class="line"><a name="l16458"></a><span class="lineno">16458</span>&#160;      vms.<a class="code" href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[msg_nums[i]] = 1;</div><div class="line"><a name="l16459"></a><span class="lineno">16459</span>&#160;   }</div><div class="line"><a name="l16460"></a><span class="lineno">16460</span>&#160;</div><div class="line"><a name="l16461"></a><span class="lineno">16461</span>&#160;   <span class="comment">/* close mailbox */</span></div><div class="line"><a name="l16462"></a><span class="lineno">16462</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu) == <a class="code" href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)) {</div><div class="line"><a name="l16463"></a><span class="lineno">16463</span>&#160;      res = -1;</div><div class="line"><a name="l16464"></a><span class="lineno">16464</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to close mailbox folder %s while removing msgs\n&quot;</span>, folder);</div><div class="line"><a name="l16465"></a><span class="lineno">16465</span>&#160;      <span class="keywordflow">goto</span> vm_remove_cleanup;</div><div class="line"><a name="l16466"></a><span class="lineno">16466</span>&#160;   }</div><div class="line"><a name="l16467"></a><span class="lineno">16467</span>&#160;   open = 0;</div><div class="line"><a name="l16468"></a><span class="lineno">16468</span>&#160;</div><div class="line"><a name="l16469"></a><span class="lineno">16469</span>&#160;vm_remove_cleanup:</div><div class="line"><a name="l16470"></a><span class="lineno">16470</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; open) {</div><div class="line"><a name="l16471"></a><span class="lineno">16471</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l16472"></a><span class="lineno">16472</span>&#160;   }</div><div class="line"><a name="l16473"></a><span class="lineno">16473</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l16474"></a><span class="lineno">16474</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l16475"></a><span class="lineno">16475</span>&#160;      vmstate_delete(&amp;vms);</div><div class="line"><a name="l16476"></a><span class="lineno">16476</span>&#160;   }</div><div class="line"><a name="l16477"></a><span class="lineno">16477</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l16478"></a><span class="lineno">16478</span>&#160;</div><div class="line"><a name="l16479"></a><span class="lineno">16479</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l16480"></a><span class="lineno">16480</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(vmu);</div><div class="line"><a name="l16481"></a><span class="lineno">16481</span>&#160;   }</div><div class="line"><a name="l16482"></a><span class="lineno">16482</span>&#160;</div><div class="line"><a name="l16483"></a><span class="lineno">16483</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l16484"></a><span class="lineno">16484</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l16485"></a><span class="lineno">16485</span>&#160;}</div><div class="line"><a name="l16486"></a><span class="lineno">16486</span>&#160;</div><div class="line"><a name="l16487"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a1a4393102d360b132fa006873ad4435c">16487</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#a1a4393102d360b132fa006873ad4435c">vm_msg_play</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line"><a name="l16488"></a><span class="lineno">16488</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line"><a name="l16489"></a><span class="lineno">16489</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line"><a name="l16490"></a><span class="lineno">16490</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *folder,</div><div class="line"><a name="l16491"></a><span class="lineno">16491</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_id,</div><div class="line"><a name="l16492"></a><span class="lineno">16492</span>&#160;   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac0c37deb099c676114ef0032ad449375">ast_vm_msg_play_cb</a> cb)</div><div class="line"><a name="l16493"></a><span class="lineno">16493</span>&#160;{</div><div class="line"><a name="l16494"></a><span class="lineno">16494</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d8f/structvm__state.html">vm_state</a> vms;</div><div class="line"><a name="l16495"></a><span class="lineno">16495</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../da/df6/structast__vm__user.html">ast_vm_user</a> *vmu = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vmus;</div><div class="line"><a name="l16496"></a><span class="lineno">16496</span>&#160;   <span class="keywordtype">int</span> res = 0;</div><div class="line"><a name="l16497"></a><span class="lineno">16497</span>&#160;   <span class="keywordtype">int</span> open = 0;</div><div class="line"><a name="l16498"></a><span class="lineno">16498</span>&#160;   <span class="keywordtype">int</span> i;</div><div class="line"><a name="l16499"></a><span class="lineno">16499</span>&#160;   <span class="keywordtype">char</span> filename[<a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line"><a name="l16500"></a><span class="lineno">16500</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dd/d18/structast__config.html">ast_config</a> *msg_cfg;</div><div class="line"><a name="l16501"></a><span class="lineno">16501</span>&#160;   <span class="keyword">struct </span><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> config_flags = { <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };</div><div class="line"><a name="l16502"></a><span class="lineno">16502</span>&#160;   <span class="keywordtype">int</span> duration = 0;</div><div class="line"><a name="l16503"></a><span class="lineno">16503</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;</div><div class="line"><a name="l16504"></a><span class="lineno">16504</span>&#160;</div><div class="line"><a name="l16505"></a><span class="lineno">16505</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(mailbox)) {</div><div class="line"><a name="l16506"></a><span class="lineno">16506</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot play message because no mailbox was specified\n&quot;</span>);</div><div class="line"><a name="l16507"></a><span class="lineno">16507</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16508"></a><span class="lineno">16508</span>&#160;   }</div><div class="line"><a name="l16509"></a><span class="lineno">16509</span>&#160;</div><div class="line"><a name="l16510"></a><span class="lineno">16510</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(folder)) {</div><div class="line"><a name="l16511"></a><span class="lineno">16511</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot play message because no folder was specified\n&quot;</span>);</div><div class="line"><a name="l16512"></a><span class="lineno">16512</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16513"></a><span class="lineno">16513</span>&#160;   }</div><div class="line"><a name="l16514"></a><span class="lineno">16514</span>&#160;</div><div class="line"><a name="l16515"></a><span class="lineno">16515</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(msg_id)) {</div><div class="line"><a name="l16516"></a><span class="lineno">16516</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot play message because no message number was specified\n&quot;</span>);</div><div class="line"><a name="l16517"></a><span class="lineno">16517</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16518"></a><span class="lineno">16518</span>&#160;   }</div><div class="line"><a name="l16519"></a><span class="lineno">16519</span>&#160;</div><div class="line"><a name="l16520"></a><span class="lineno">16520</span>&#160;   memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));</div><div class="line"><a name="l16521"></a><span class="lineno">16521</span>&#160;   memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));</div><div class="line"><a name="l16522"></a><span class="lineno">16522</span>&#160;</div><div class="line"><a name="l16523"></a><span class="lineno">16523</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(context)) {</div><div class="line"><a name="l16524"></a><span class="lineno">16524</span>&#160;      context = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l16525"></a><span class="lineno">16525</span>&#160;   }</div><div class="line"><a name="l16526"></a><span class="lineno">16526</span>&#160;</div><div class="line"><a name="l16527"></a><span class="lineno">16527</span>&#160;   <span class="keywordflow">if</span> (!(vmu = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a>(&amp;vmus, context, mailbox))) {</div><div class="line"><a name="l16528"></a><span class="lineno">16528</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l16529"></a><span class="lineno">16529</span>&#160;   }</div><div class="line"><a name="l16530"></a><span class="lineno">16530</span>&#160;</div><div class="line"><a name="l16531"></a><span class="lineno">16531</span>&#160;   i = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a>(folder);</div><div class="line"><a name="l16532"></a><span class="lineno">16532</span>&#160;   <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, mailbox, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));</div><div class="line"><a name="l16533"></a><span class="lineno">16533</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;</div><div class="line"><a name="l16534"></a><span class="lineno">16534</span>&#160;   <span class="keywordflow">if</span> ((res = <a class="code" href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, i)) &lt; 0) {</div><div class="line"><a name="l16535"></a><span class="lineno">16535</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not open mailbox %s\n&quot;</span>, mailbox);</div><div class="line"><a name="l16536"></a><span class="lineno">16536</span>&#160;      <span class="keywordflow">goto</span> play2_msg_cleanup;</div><div class="line"><a name="l16537"></a><span class="lineno">16537</span>&#160;   }</div><div class="line"><a name="l16538"></a><span class="lineno">16538</span>&#160;   open = 1;</div><div class="line"><a name="l16539"></a><span class="lineno">16539</span>&#160;</div><div class="line"><a name="l16540"></a><span class="lineno">16540</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a>(&amp;vms, &amp;msg_id, 1, &amp;vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu)) {</div><div class="line"><a name="l16541"></a><span class="lineno">16541</span>&#160;      res = -1;</div><div class="line"><a name="l16542"></a><span class="lineno">16542</span>&#160;      <span class="keywordflow">goto</span> play2_msg_cleanup;</div><div class="line"><a name="l16543"></a><span class="lineno">16543</span>&#160;   }</div><div class="line"><a name="l16544"></a><span class="lineno">16544</span>&#160;</div><div class="line"><a name="l16545"></a><span class="lineno">16545</span>&#160;   <span class="comment">/* Find the msg */</span></div><div class="line"><a name="l16546"></a><span class="lineno">16546</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16547"></a><span class="lineno">16547</span>&#160;   snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l16548"></a><span class="lineno">16548</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">mailbox</a>, vmu-&gt;<a class="code" href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">context</a>);</div><div class="line"><a name="l16549"></a><span class="lineno">16549</span>&#160;</div><div class="line"><a name="l16550"></a><span class="lineno">16550</span>&#160;   msg_cfg = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);</div><div class="line"><a name="l16551"></a><span class="lineno">16551</span>&#160;   <span class="keywordflow">if</span> (!msg_cfg || msg_cfg == <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {</div><div class="line"><a name="l16552"></a><span class="lineno">16552</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16553"></a><span class="lineno">16553</span>&#160;      res = -1;</div><div class="line"><a name="l16554"></a><span class="lineno">16554</span>&#160;      <span class="keywordflow">goto</span> play2_msg_cleanup;</div><div class="line"><a name="l16555"></a><span class="lineno">16555</span>&#160;   }</div><div class="line"><a name="l16556"></a><span class="lineno">16556</span>&#160;   <span class="keywordflow">if</span> ((value = <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {</div><div class="line"><a name="l16557"></a><span class="lineno">16557</span>&#160;      duration = atoi(value);</div><div class="line"><a name="l16558"></a><span class="lineno">16558</span>&#160;   }</div><div class="line"><a name="l16559"></a><span class="lineno">16559</span>&#160;   <a class="code" href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a>(msg_cfg);</div><div class="line"><a name="l16560"></a><span class="lineno">16560</span>&#160;</div><div class="line"><a name="l16561"></a><span class="lineno">16561</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l16562"></a><span class="lineno">16562</span>&#160;   <span class="comment">/*IMAP storage stores any prepended message from a forward</span></div><div class="line"><a name="l16563"></a><span class="lineno">16563</span>&#160;<span class="comment">    * as a separate file from the rest of the message</span></div><div class="line"><a name="l16564"></a><span class="lineno">16564</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l16565"></a><span class="lineno">16565</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(vms.introfn) &amp;&amp; <a class="code" href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a>(vms.introfn, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &gt; 0) {</div><div class="line"><a name="l16566"></a><span class="lineno">16566</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, &amp;vms, vms.introfn);</div><div class="line"><a name="l16567"></a><span class="lineno">16567</span>&#160;   }</div><div class="line"><a name="l16568"></a><span class="lineno">16568</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l16569"></a><span class="lineno">16569</span>&#160;   <span class="keywordflow">if</span> (cb) {</div><div class="line"><a name="l16570"></a><span class="lineno">16570</span>&#160;      cb(chan, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, duration);</div><div class="line"><a name="l16571"></a><span class="lineno">16571</span>&#160;   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, &amp;vms, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>)) &lt; 0) {</div><div class="line"><a name="l16572"></a><span class="lineno">16572</span>&#160;      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Playback of message %s failed\n&quot;</span>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);</div><div class="line"><a name="l16573"></a><span class="lineno">16573</span>&#160;   } <span class="keywordflow">else</span> {</div><div class="line"><a name="l16574"></a><span class="lineno">16574</span>&#160;      res = 0;</div><div class="line"><a name="l16575"></a><span class="lineno">16575</span>&#160;   }</div><div class="line"><a name="l16576"></a><span class="lineno">16576</span>&#160;</div><div class="line"><a name="l16577"></a><span class="lineno">16577</span>&#160;   vms.<a class="code" href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 1;</div><div class="line"><a name="l16578"></a><span class="lineno">16578</span>&#160;</div><div class="line"><a name="l16579"></a><span class="lineno">16579</span>&#160;   <span class="comment">/* cleanup configs and msg */</span></div><div class="line"><a name="l16580"></a><span class="lineno">16580</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms.<a class="code" href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms.<a class="code" href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);</div><div class="line"><a name="l16581"></a><span class="lineno">16581</span>&#160;</div><div class="line"><a name="l16582"></a><span class="lineno">16582</span>&#160;play2_msg_cleanup:</div><div class="line"><a name="l16583"></a><span class="lineno">16583</span>&#160;   <span class="keywordflow">if</span> (vmu &amp;&amp; open) {</div><div class="line"><a name="l16584"></a><span class="lineno">16584</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);</div><div class="line"><a name="l16585"></a><span class="lineno">16585</span>&#160;   }</div><div class="line"><a name="l16586"></a><span class="lineno">16586</span>&#160;</div><div class="line"><a name="l16587"></a><span class="lineno">16587</span>&#160;<span class="preprocessor">#ifdef IMAP_STORAGE</span></div><div class="line"><a name="l16588"></a><span class="lineno">16588</span>&#160;   <span class="keywordflow">if</span> (vmu) {</div><div class="line"><a name="l16589"></a><span class="lineno">16589</span>&#160;      vmstate_delete(&amp;vms);</div><div class="line"><a name="l16590"></a><span class="lineno">16590</span>&#160;   }</div><div class="line"><a name="l16591"></a><span class="lineno">16591</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l16592"></a><span class="lineno">16592</span>&#160;</div><div class="line"><a name="l16593"></a><span class="lineno">16593</span>&#160;   <span class="keywordflow">if</span> (!res) {</div><div class="line"><a name="l16594"></a><span class="lineno">16594</span>&#160;      <a class="code" href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a>(vmu);</div><div class="line"><a name="l16595"></a><span class="lineno">16595</span>&#160;   }</div><div class="line"><a name="l16596"></a><span class="lineno">16596</span>&#160;</div><div class="line"><a name="l16597"></a><span class="lineno">16597</span>&#160;   <a class="code" href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);</div><div class="line"><a name="l16598"></a><span class="lineno">16598</span>&#160;   <span class="keywordflow">return</span> res;</div><div class="line"><a name="l16599"></a><span class="lineno">16599</span>&#160;}</div><div class="line"><a name="l16600"></a><span class="lineno">16600</span>&#160;</div><div class="line"><a name="l16601"></a><span class="lineno">16601</span>&#160;<span class="comment">/* This is a workaround so that menuselect displays a proper description</span></div><div class="line"><a name="l16602"></a><span class="lineno">16602</span>&#160;<span class="comment"> * AST_MODULE_INFO(, , &quot;Comedian Mail (Voicemail System)&quot;</span></div><div class="line"><a name="l16603"></a><span class="lineno">16603</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l16604"></a><span class="lineno">16604</span>&#160;</div><div class="line"><a name="l16605"></a><span class="lineno">16605</span>&#160;<a class="code" href="../../d9/de9/res__phoneprov_8c.html#addaa208b0ed785225e24490fb9f28a80">AST_MODULE_INFO</a>(<a class="code" href="../../d5/d16/module_8h.html#aba2c8d4be709a254658b21a834f8294a">ASTERISK_GPL_KEY</a>, <a class="code" href="../../d5/d16/module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <a class="code" href="../../dc/df4/app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">tdesc</a>,</div><div class="line"><a name="l16606"></a><span class="lineno">16606</span>&#160;   .support_level = <a class="code" href="../../d5/d16/module_8h.html#ab35bc4efd9f79706300965c9d36a0ce5a634484c0074e7b6b630756fab09e2c15">AST_MODULE_SUPPORT_CORE</a>,</div><div class="line"><a name="l16607"></a><span class="lineno">16607</span>&#160;   .load = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,</div><div class="line"><a name="l16608"></a><span class="lineno">16608</span>&#160;   .unload = <a class="code" href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a>,</div><div class="line"><a name="l16609"></a><span class="lineno">16609</span>&#160;   .reload = reload,</div><div class="line"><a name="l16610"></a><span class="lineno">16610</span>&#160;   .optional_modules = <span class="stringliteral">&quot;res_adsi,res_smdi&quot;</span>,</div><div class="line"><a name="l16611"></a><span class="lineno"><a class="line" href="../../dc/df4/app__voicemail_8c.html#a4fb0aca9bbcdb9709fa52a70aded6cae">16611</a></span>&#160;);</div><div class="ttc" id="res__config__ldap_8c_html_a930c15eddfe0826ff30e658c9d50b9b4"><div class="ttname"><a href="../../dc/d12/res__config__ldap_8c.html#a930c15eddfe0826ff30e658c9d50b9b4">user</a></div><div class="ttdeci">static char user[512]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d12/res__config__ldap_8c_source.html#l00075">res_config_ldap.c:75</a></div></div>
<div class="ttc" id="structast__vm__user_html_a97d0f923218857a92e83d94dcbfe0263"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">ast_vm_user::volgain</a></div><div class="ttdeci">double volgain</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00791">app_voicemail.c:791</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1bb81e35de6fe1d146aff63f9d8b7809"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a></div><div class="ttdeci">#define VM_TEMPGREETWARN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00563">app_voicemail.c:563</a></div></div>
<div class="ttc" id="structast__vm__greeter__functions_html_a19dd3d3916fd1aa9a70c45c43d24b6f5"><div class="ttname"><a href="../../d0/d1e/structast__vm__greeter__functions.html#a19dd3d3916fd1aa9a70c45c43d24b6f5">ast_vm_greeter_functions::module_version</a></div><div class="ttdeci">unsigned int module_version</div><div class="ttdoc">The version of this function table. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00625">include/asterisk/app.h:625</a></div></div>
<div class="ttc" id="structast__custom__function_html_afcd1706c9144e6d6eee6127661ae3be2"><div class="ttname"><a href="../../db/dc0/structast__custom__function.html#afcd1706c9144e6d6eee6127661ae3be2">ast_custom_function::name</a></div><div class="ttdeci">const char * name</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de0/pbx_8h_source.html#l00119">pbx.h:119</a></div></div>
<div class="ttc" id="file_8h_html_aab7814972ae21f8cc68e1d62b97fc88b"><div class="ttname"><a href="../../d2/d4d/file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b">ast_filecopy</a></div><div class="ttdeci">int ast_filecopy(const char *oldname, const char *newname, const char *fmt)</div><div class="ttdoc">Copies a file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01108">file.c:1108</a></div></div>
<div class="ttc" id="channel_8h_html_ac2dc872b606534943c98304aed841b34"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a></div><div class="ttdeci">struct ast_party_caller * ast_channel_caller(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00888">channel_internal_api.c:888</a></div></div>
<div class="ttc" id="structmailbox__alias__mapping_html_a85bb287786245ade1ab8a939e4dc4723"><div class="ttname"><a href="../../d0/d11/structmailbox__alias__mapping.html#a85bb287786245ade1ab8a939e4dc4723">mailbox_alias_mapping::mailbox</a></div><div class="ttdeci">char * mailbox</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00962">app_voicemail.c:962</a></div></div>
<div class="ttc" id="structodbc__obj_html_ae83918cc26dc7acd65bbec1712593054"><div class="ttname"><a href="../../df/d36/structodbc__obj.html#ae83918cc26dc7acd65bbec1712593054">odbc_obj::con</a></div><div class="ttdeci">SQLHDBC con</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d96/res__odbc_8h_source.html#l00047">res_odbc.h:47</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a662135d8d43ad08325882645dc5f8df3"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a662135d8d43ad08325882645dc5f8df3">ast_category_new</a></div><div class="ttdeci">struct ast_category * ast_category_new(const char *name, const char *in_file, int lineno)</div><div class="ttdoc">Create a category. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l02790">extconf.c:2790</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a151aa2b14d2de12714ed26b49b535e62"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a151aa2b14d2de12714ed26b49b535e62">mwi_handle_unsubscribe2</a></div><div class="ttdeci">static int mwi_handle_unsubscribe2(void *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13144">app_voicemail.c:13144</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a1a03993603e2bc2463153857836645bb"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a1a03993603e2bc2463153857836645bb">ast_load_realtime</a></div><div class="ttdeci">struct ast_variable * ast_load_realtime(const char *family,...) attribute_sentinel</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03339">main/config.c:3339</a></div></div>
<div class="ttc" id="structast__variable_html_afaaf66cc5029a563bd0bb9df076ea14b"><div class="ttname"><a href="../../dd/d02/structast__variable.html#afaaf66cc5029a563bd0bb9df076ea14b">ast_variable::next</a></div><div class="ttdeci">struct ast_variable * next</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00090">include/asterisk/config.h:90</a></div></div>
<div class="ttc" id="threadstorage_8h_html_ac268c0a8272ec11e73269392507fb1a6"><div class="ttname"><a href="../../dc/d7d/threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6">AST_THREADSTORAGE</a></div><div class="ttdeci">#define AST_THREADSTORAGE(name)</div><div class="ttdoc">Define a thread storage variable. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d7d/threadstorage_8h_source.html#l00084">threadstorage.h:84</a></div></div>
<div class="ttc" id="chan__ooh323_8c_html_a4d63fdfe5451ec2248c16a2739190c56"><div class="ttname"><a href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a></div><div class="ttdeci">static const char type[]</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d49/chan__ooh323_8c_source.html#l00109">chan_ooh323.c:109</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af26771cdcac4d61f423adafa46ae9039"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af26771cdcac4d61f423adafa46ae9039">copy_message</a></div><div class="ttdeci">static int copy_message(struct ast_channel *chan, struct ast_vm_user *vmu, int imbox, int msgnum, long duration, struct ast_vm_user *recip, char *fmt, char *dir, const char *flag, const char *dest_folder)</div><div class="ttdoc">Copies a message from one mailbox to another. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05982">app_voicemail.c:5982</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a888d5641c2b819d8fa55a8c89d4aa301"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a></div><div class="ttdeci">static int saydurationminfo</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01007">app_voicemail.c:1007</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3c86d0596da9171b67c1de3e209237f0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3c86d0596da9171b67c1de3e209237f0">MSG_ID_LEN</a></div><div class="ttdeci">#define MSG_ID_LEN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l03739">app_voicemail.c:3739</a></div></div>
<div class="ttc" id="channel_8h_html_a493bdebe876caafb8ee535853310364a"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a493bdebe876caafb8ee535853310364a">ast_channel_lock</a></div><div class="ttdeci">#define ast_channel_lock(chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l02945">channel.h:2945</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7dd67802952f9785334caeff45282665"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">vm_intro_nl</a></div><div class="ttdeci">static int vm_intro_nl(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10117">app_voicemail.c:10117</a></div></div>
<div class="ttc" id="chan__alsa_8c_html_a78d4847658b695383d849efd12399b38"><div class="ttname"><a href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a></div><div class="ttdeci">static char exten[AST_MAX_EXTENSION]</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d45/chan__alsa_8c_source.html#l00118">chan_alsa.c:118</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad7cf03f8da8d217a3f3e964eda3c263"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a></div><div class="ttdeci">static char userscontext[AST_MAX_EXTENSION]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00899">app_voicemail.c:899</a></div></div>
<div class="ttc" id="structast__channel_html"><div class="ttname"><a href="../../df/d3c/structast__channel.html">ast_channel</a></div><div class="ttdoc">Main Channel structure associated with a channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00073">channel_internal_api.c:73</a></div></div>
<div class="ttc" id="adsi_8h_html_aecd73d8f8989dfd9ec9f751dcd40bc62"><div class="ttname"><a href="../../df/de2/adsi_8h.html#aecd73d8f8989dfd9ec9f751dcd40bc62">ast_adsi_voice_mode</a></div><div class="ttdeci">int ast_adsi_voice_mode(unsigned char *buf, int when)</div><div class="ttdoc">Puts CPE in voice mode. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00252">adsi.c:252</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_acda2b7f1e36ad72fc556cc67cb2004c0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acda2b7f1e36ad72fc556cc67cb2004c0">resequence_mailbox</a></div><div class="ttdeci">static int resequence_mailbox(struct ast_vm_user *vmu, char *dir, int stopcount)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07177">app_voicemail.c:7177</a></div></div>
<div class="ttc" id="mwi_8h_html_ab6397dc158885461fdc0a21138dda6f9"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#ab6397dc158885461fdc0a21138dda6f9">ast_delete_mwi_state_full</a></div><div class="ttdeci">int ast_delete_mwi_state_full(const char *mailbox, const char *context, struct ast_eid *eid)</div><div class="ttdoc">Delete MWI state cached by stasis with all parameters. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00399">mwi.c:399</a></div></div>
<div class="ttc" id="cli_8h_html_a5c4130cf8f1e93acfdd84416cebf1aef"><div class="ttname"><a href="../../dc/db0/cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a></div><div class="ttdeci">#define AST_CLI_DEFINE(fn, txt,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00197">cli.h:197</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a11fb20ac91a60a1586aa8183f5c0892f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f">vm_check_password_shell</a></div><div class="ttdeci">static char * vm_check_password_shell(char *command, char *buf, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01391">app_voicemail.c:1391</a></div></div>
<div class="ttc" id="structast__party__number_html_ab50d783982593ef993ea0b68f7ad8b80"><div class="ttname"><a href="../../d6/dbb/structast__party__number.html#ab50d783982593ef993ea0b68f7ad8b80">ast_party_number::str</a></div><div class="ttdeci">char * str</div><div class="ttdoc">Subscriber phone number (Malloced) </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00292">channel.h:292</a></div></div>
<div class="ttc" id="structvm__state_html_ae3e9c2dd4477c3dbccc953a5dc27da6f"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">vm_state::starting</a></div><div class="ttdeci">int starting</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00822">app_voicemail.c:822</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7ddd9d0b860a368069624140abecbbbc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a></div><div class="ttdeci">static void adsi_status(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07696">app_voicemail.c:7696</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a473721b764b20c167c95b99239bc0654"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a></div><div class="ttdeci">int ast_config_text_file_save(const char *filename, const struct ast_config *cfg, const char *generator)</div><div class="ttdoc">Save a config text file preserving the pre 13.2 behavior. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l02531">main/config.c:2531</a></div></div>
<div class="ttc" id="structmessage_html"><div class="ttname"><a href="../../d8/d9e/structmessage.html">message</a></div><div class="ttdef"><b>Definition:</b> <a href="../../db/d45/manager_8h_source.html#l00144">manager.h:144</a></div></div>
<div class="ttc" id="structvm__state_html_aef5ca4e8463cbf34719addd12f7bf3d5"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">vm_state::oldmessages</a></div><div class="ttdeci">int oldmessages</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00820">app_voicemail.c:820</a></div></div>
<div class="ttc" id="file_8h_html_a67c7e271b4ca70aca6d48fd48d121857"><div class="ttname"><a href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a></div><div class="ttdeci">int ast_streamfile(struct ast_channel *c, const char *filename, const char *preflang)</div><div class="ttdoc">Streams a file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01250">file.c:1250</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a9140a4e4d781264fa9469c52b1adae40"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a></div><div class="ttdeci">#define AST_LIST_LOCK(head)</div><div class="ttdoc">Locks a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00039">linkedlists.h:39</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad13b68ee650ddeaa242ba4dc5195c473"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473">free_vm_zones</a></div><div class="ttdeci">static void free_vm_zones(void)</div><div class="ttdoc">Free the zones structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13482">app_voicemail.c:13482</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a95f0f63bc1e6a4c06a3449e2375f74be"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a></div><div class="ttdeci">static char ext_pass_cmd[128]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00880">app_voicemail.c:880</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaea1c83faa41ab79a1342f34a3a346c1aec7326f60e7edad15d96ff935e5616d6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00600">app_voicemail.c:600</a></div></div>
<div class="ttc" id="lock_8h_html"><div class="ttname"><a href="../../dd/d42/lock_8h.html">lock.h</a></div><div class="ttdoc">Asterisk locking-related definitions: </div></div>
<div class="ttc" id="group__Group__AMI_html_gac2d42f7be13c532b6a70d50f1b8983d2"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a></div><div class="ttdeci">void astman_append(struct mansession *s, const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l03080">manager.c:3080</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a18febf331f4093f15f5d7f62dae4efd6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a18febf331f4093f15f5d7f62dae4efd6">vm_info_acf</a></div><div class="ttdeci">static struct ast_custom_function vm_info_acf</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12760">app_voicemail.c:12760</a></div></div>
<div class="ttc" id="asterisk_8h_html"><div class="ttname"><a href="../../db/db2/asterisk_8h.html">asterisk.h</a></div><div class="ttdoc">Asterisk main include file. File version handling, generic pbx functions. </div></div>
<div class="ttc" id="app__voicemail_8c_html_af48017d2539aef7a0f2aaf3923fbbc2b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af48017d2539aef7a0f2aaf3923fbbc2b">vm_play_folder_name_ja</a></div><div class="ttdeci">static int vm_play_folder_name_ja(struct ast_channel *chan, char *box)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09286">app_voicemail.c:9286</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a455a712ba9003532355a79aef9980eea"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a455a712ba9003532355a79aef9980eea">substitute_escapes</a></div><div class="ttdeci">static const char * substitute_escapes(const char *value)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13491">app_voicemail.c:13491</a></div></div>
<div class="ttc" id="structvm__zone_html_a824b6fba3cdf05b72afb1e22ef25a38c"><div class="ttname"><a href="../../d7/d13/structvm__zone.html#a824b6fba3cdf05b72afb1e22ef25a38c">vm_zone::list</a></div><div class="ttdeci">struct vm_zone::@83 list</div></div>
<div class="ttc" id="app__voicemail_8c_html_acb03f04b845165af39cce94f03ac972b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a></div><div class="ttdeci">static int minpassword</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00934">app_voicemail.c:934</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a20bc535b35844236bae4c89b484435c5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">vm_table</a></div><div class="ttdeci">static const struct ast_vm_functions vm_table</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15020">app_voicemail.c:15020</a></div></div>
<div class="ttc" id="astmm_8h_html_aa6bcdb74dc1508c22986f0adf171a0f2"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#aa6bcdb74dc1508c22986f0adf171a0f2">ast_realloc</a></div><div class="ttdeci">#define ast_realloc(p, len)</div><div class="ttdoc">A wrapper for realloc() </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00228">astmm.h:228</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a75f701e2fe322710cb7110c5f349b46b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a75f701e2fe322710cb7110c5f349b46b">vm_instructions_ja</a></div><div class="ttdeci">static int vm_instructions_ja(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int skipadvanced, int in_urgent)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10515">app_voicemail.c:10515</a></div></div>
<div class="ttc" id="adsi_8h_html_a664d01277c0ae1f12abbe6806ffcaccc"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a664d01277c0ae1f12abbe6806ffcaccc">ast_adsi_begin_download</a></div><div class="ttdeci">int ast_adsi_begin_download(struct ast_channel *chan, char *service, unsigned char *fdn, unsigned char *sec, int version)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00032">adsi.c:32</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad0f6114d9cab58a8ec3d9555cb466534"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a></div><div class="ttdeci">static int load_config(int reload)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13538">app_voicemail.c:13538</a></div></div>
<div class="ttc" id="isdn__lib_8c_html_ab9129b977a587b50ea801daac75e178f"><div class="ttname"><a href="../../de/dfe/isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a></div><div class="ttdeci">#define ARRAY_LEN(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dfe/isdn__lib_8c_source.html#l00042">isdn_lib.c:42</a></div></div>
<div class="ttc" id="structast__vm__user_html_a88979400522b0aea4a131fc82c69f74e"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a88979400522b0aea4a131fc82c69f74e">ast_vm_user::minsecs</a></div><div class="ttdeci">int minsecs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00776">app_voicemail.c:776</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a274f7d7e2262b906dcb14a625067f41f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f">apply_options_full</a></div><div class="ttdeci">static void apply_options_full(struct ast_vm_user *retval, struct ast_variable *var)</div><div class="ttdoc">Loads the options specific to a voicemail user. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01526">app_voicemail.c:1526</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5609ea8da6381561640e886177df9640"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5609ea8da6381561640e886177df9640">get_folder_ja</a></div><div class="ttdeci">static int get_folder_ja(struct ast_channel *chan, int start)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07865">app_voicemail.c:7865</a></div></div>
<div class="ttc" id="module_8h_html_adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314"><div class="ttname"><a href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d16/module_8h_source.html#l00070">module.h:70</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1f5a71f874226acc1147ab54fff050a3"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a></div><div class="ttdeci">static char mailcmd[160]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00924">app_voicemail.c:924</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0ae670a01db4e441f800b0831c5df5cc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0ae670a01db4e441f800b0831c5df5cc">MAX_VM_CONTEXT_LEN</a></div><div class="ttdeci">#define MAX_VM_CONTEXT_LEN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00749">app_voicemail.c:749</a></div></div>
<div class="ttc" id="channelstate_8h_html_a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc"><div class="ttname"><a href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d95/channelstate_8h_source.html#l00036">channelstate.h:36</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a823c8996a141b154215521998b4adedf"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a></div><div class="ttdeci">static FILE * vm_mkftemp(char *template)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01925">app_voicemail.c:1925</a></div></div>
<div class="ttc" id="structbaseio_html_a4c937bd693e91661c05e41cfe0cf7fe3"><div class="ttname"><a href="../../d5/d11/structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">baseio::iobuf</a></div><div class="ttdeci">unsigned char iobuf[BASEMAXINLINE]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00745">app_voicemail.c:745</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_adf398fc1e24857033174482891adab4a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#adf398fc1e24857033174482891adab4a">DEFAULT_LISTEN_CONTROL_REVERSE_KEY</a></div><div class="ttdeci">#define DEFAULT_LISTEN_CONTROL_REVERSE_KEY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00518">app_voicemail.c:518</a></div></div>
<div class="ttc" id="callerid_8h_html_af33ee38631fe79ab21d91bcd0634903a"><div class="ttname"><a href="../../de/d47/callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a></div><div class="ttdeci">int ast_callerid_split(const char *src, char *name, int namelen, char *num, int numlen)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dd5/callerid_8c_source.html#l01092">callerid.c:1092</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aab88842146c214975db358115d86c726"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a></div><div class="ttdeci">#define MAX_NUM_CID_CONTEXTS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00546">app_voicemail.c:546</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a097d7083995be395b171563aa8fd8a14"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14">vm_browse_messages_en</a></div><div class="ttdeci">static int vm_browse_messages_en(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Default English syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11015">app_voicemail.c:11015</a></div></div>
<div class="ttc" id="pbx_8h_html_a6e3dbc57c03c23543354ef108c31fac8"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a6e3dbc57c03c23543354ef108c31fac8">pbx_exec</a></div><div class="ttdeci">int pbx_exec(struct ast_channel *c, struct ast_app *app, const char *data)</div><div class="ttdoc">Execute an application. </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d16/pbx__app_8c_source.html#l00471">pbx_app.c:471</a></div></div>
<div class="ttc" id="structast__vm__user_html_a4cdc273d6b190940a91df6042d385099"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">ast_vm_user::maxmsg</a></div><div class="ttdeci">int maxmsg</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00777">app_voicemail.c:777</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3f746748b8e841890dd2a684011248f9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3f746748b8e841890dd2a684011248f9">vm_newuser</a></div><div class="ttdeci">static char vm_newuser[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00984">app_voicemail.c:984</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a641453ff932559ad5d8bcd3e9203bcf3"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3">rename_file</a></div><div class="ttdeci">static void rename_file(char *sfn, char *dfn)</div><div class="ttdoc">Renames a message in a mailbox folder. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04554">app_voicemail.c:4554</a></div></div>
<div class="ttc" id="module_8h_html_ab35bc4efd9f79706300965c9d36a0ce5a634484c0074e7b6b630756fab09e2c15"><div class="ttname"><a href="../../d5/d16/module_8h.html#ab35bc4efd9f79706300965c9d36a0ce5a634484c0074e7b6b630756fab09e2c15">AST_MODULE_SUPPORT_CORE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d16/module_8h_source.html#l00121">module.h:121</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ad7c2a7da4125347c06d9719580731228"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ad7c2a7da4125347c06d9719580731228">ast_unreplace_sigchld</a></div><div class="ttdeci">void ast_unreplace_sigchld(void)</div><div class="ttdoc">Restore the SIGCHLD handler. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l00815">extconf.c:815</a></div></div>
<div class="ttc" id="strings_8h_html"><div class="ttname"><a href="../../d6/d90/strings_8h.html">strings.h</a></div><div class="ttdoc">String manipulation functions. </div></div>
<div class="ttc" id="structast__vm__msg__snapshot_html_a73d00a61bed6e8a91ac3befb90e2d28a"><div class="ttname"><a href="../../dc/d95/structast__vm__msg__snapshot.html#a73d00a61bed6e8a91ac3befb90e2d28a">ast_vm_msg_snapshot::msg_number</a></div><div class="ttdeci">unsigned int msg_number</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00312">include/asterisk/app.h:312</a></div></div>
<div class="ttc" id="adsi_8h_html_a5f65b445dd274af93d891153a82808cf"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a></div><div class="ttdeci">#define ADSI_MSG_DISPLAY</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00032">adsi.h:32</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_adca07b25adb77cf322868e73ba5a39c8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a></div><div class="ttdeci">static int vm_play_folder_name(struct ast_channel *chan, char *mbox)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09328">app_voicemail.c:9328</a></div></div>
<div class="ttc" id="test__message_8c_html_a1fcdae79eb8b5dba56f672c597d577ae"><div class="ttname"><a href="../../d9/d7a/test__message_8c.html#a1fcdae79eb8b5dba56f672c597d577ae">TEST_EXTENSION</a></div><div class="ttdeci">#define TEST_EXTENSION</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d7a/test__message_8c_source.html#l00047">test_message.c:47</a></div></div>
<div class="ttc" id="structvm__state_html_a60b121e87a5e71fe64bae70e1721ac3c"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">vm_state::username</a></div><div class="ttdeci">char username[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00808">app_voicemail.c:808</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad4b005e7fb5a0027448862b2b0f9c8dd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a></div><div class="ttdeci">static unsigned char adsifdn[4]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01024">app_voicemail.c:1024</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abb5a064892dcd900e8fe8cee81d9da37"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a></div><div class="ttdeci">static int vm_instructions_en(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int skipadvanced, int in_urgent)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10427">app_voicemail.c:10427</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1d25d65364805271d7963230e7d80752"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752">manager_list_voicemail_users</a></div><div class="ttdeci">static int manager_list_voicemail_users(struct mansession *s, const struct message *m)</div><div class="ttdoc">Manager list voicemail users command. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13428">app_voicemail.c:13428</a></div></div>
<div class="ttc" id="channel_8h_html_afac6d7d115c1edfe3ad8a8c7fa5d59d1"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#afac6d7d115c1edfe3ad8a8c7fa5d59d1">ast_channel_set_writeformat</a></div><div class="ttdeci">void ast_channel_set_writeformat(struct ast_channel *chan, struct ast_format *format)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00840">channel_internal_api.c:840</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_adea5390496e5477192d86f340d512d04"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#adea5390496e5477192d86f340d512d04">ast_variables_destroy</a></div><div class="ttdeci">void ast_variables_destroy(struct ast_variable *var)</div><div class="ttdoc">Free variable list. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l01263">extconf.c:1263</a></div></div>
<div class="ttc" id="adsi_8h_html_a392cb4fb1c98045c30589b62edb127ca"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a392cb4fb1c98045c30589b62edb127ca">ast_adsi_data_mode</a></div><div class="ttdeci">int ast_adsi_data_mode(unsigned char *buf)</div><div class="ttdoc">Puts CPE in data mode. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00219">adsi.c:219</a></div></div>
<div class="ttc" id="structvm__zone_html_aad16c37028f0efbc3cf8c9186b770ab8"><div class="ttname"><a href="../../d7/d13/structvm__zone.html#aad16c37028f0efbc3cf8c9186b770ab8">vm_zone::timezone</a></div><div class="ttdeci">char timezone[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00799">app_voicemail.c:799</a></div></div>
<div class="ttc" id="structval_html"><div class="ttname"><a href="../../d5/d85/structval.html">val</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd1/ast__expr2_8c_source.html#l00325">ast_expr2.c:325</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_afb17050e49a14f2871fdbd560024a101"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101">free_vm_users</a></div><div class="ttdeci">static void free_vm_users(void)</div><div class="ttdoc">Free the users structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13470">app_voicemail.c:13470</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a776a062edcd1b6e8e2c17cf40af28af0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">vm_instructions_zh</a></div><div class="ttdeci">static int vm_instructions_zh(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int skipadvanced, int in_urgent)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10611">app_voicemail.c:10611</a></div></div>
<div class="ttc" id="file_8h_html_afa92b0106fb7a918ea994c2867ac0a04"><div class="ttname"><a href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a></div><div class="ttdeci">#define AST_DIGIT_ANY</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d4d/file_8h_source.html#l00048">file.h:48</a></div></div>
<div class="ttc" id="structast__vm__mailbox__snapshot_html_adf7744e2e72a9785679d9d326009e952"><div class="ttname"><a href="../../d3/dbc/structast__vm__mailbox__snapshot.html#adf7744e2e72a9785679d9d326009e952">ast_vm_mailbox_snapshot::total_msg_num</a></div><div class="ttdeci">int total_msg_num</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00318">include/asterisk/app.h:318</a></div></div>
<div class="ttc" id="cli_8h_html_a56b6b59ee2eaa994597a5b0f4e9f9d09"><div class="ttname"><a href="../../dc/db0/cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09">ast_cli_unregister_multiple</a></div><div class="ttdeci">int ast_cli_unregister_multiple(struct ast_cli_entry *e, int len)</div><div class="ttdoc">Unregister multiple commands. </div><div class="ttdef"><b>Definition:</b> <a href="../../da/d4d/clicompat_8c_source.html#l00030">clicompat.c:30</a></div></div>
<div class="ttc" id="structast__channel__tech_html_a00128f99123ef7844d506e8939bb1786"><div class="ttname"><a href="../../d4/d85/structast__channel__tech.html#a00128f99123ef7844d506e8939bb1786">ast_channel_tech::write</a></div><div class="ttdeci">int(*const write)(struct ast_channel *chan, struct ast_frame *frame)</div><div class="ttdoc">Write a frame, in standard format (see frame.h) </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00751">channel.h:751</a></div></div>
<div class="ttc" id="channel_8h_html_ab733a7825810b895a89b629e0ea89380"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#ab733a7825810b895a89b629e0ea89380">ast_channel_unref</a></div><div class="ttdeci">#define ast_channel_unref(c)</div><div class="ttdoc">Decrease channel reference count. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l02981">channel.h:2981</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af836feb1d14b54d1ae124391b455426c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af836feb1d14b54d1ae124391b455426c">voicemailmain_app</a></div><div class="ttdeci">static char * voicemailmain_app</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00907">app_voicemail.c:907</a></div></div>
<div class="ttc" id="astobj2_8h_html_ad9d009e87e737af900825b36db55a35caa13a6e0771cc457e86f425d95c3b8d54"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35caa13a6e0771cc457e86f425d95c3b8d54">OBJ_SEARCH_KEY</a></div><div class="ttdoc">The arg parameter is a search key, but is not an object. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01105">astobj2.h:1105</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea839b6e6f240aa580e222e9a21bcea333"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea839b6e6f240aa580e222e9a21bcea333">OPT_EARLYM_GREETING</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00590">app_voicemail.c:590</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa5e3e27fd305eed351172eff40037938"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">create_dirpath</a></div><div class="ttdeci">static int create_dirpath(char *dest, int len, const char *context, const char *ext, const char *folder)</div><div class="ttdoc">basically mkdir -p $dest/$context/$ext/$folder </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01948">app_voicemail.c:1948</a></div></div>
<div class="ttc" id="utils_8h_html_a67b6713ff86cf82aaed821e9a87d1c21"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a></div><div class="ttdeci">#define ast_set2_flag(p, value, flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00094">utils.h:94</a></div></div>
<div class="ttc" id="utils_8h_html_a00d4c9254c9827d6fa44f17a326744a5"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a></div><div class="ttdeci">#define ast_test_flag(p, flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00063">utils.h:63</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a690d04bb2d7fc3e5bbe62641861aa435"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a690d04bb2d7fc3e5bbe62641861aa435">vm_msg_snapshot_create</a></div><div class="ttdeci">static int vm_msg_snapshot_create(struct ast_vm_user *vmu, struct vm_state *vms, struct ast_vm_mailbox_snapshot *mailbox_snapshot, int snapshot_index, int mailbox_index, int descending, enum ast_vm_snapshot_sort_val sort_val)</div><div class="ttdoc">Create and store off all the msgs in an open mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15816">app_voicemail.c:15816</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_aef636ed2f3d33f4c7a1ba67eb7c4d052"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#aef636ed2f3d33f4c7a1ba67eb7c4d052">ast_variable_browse</a></div><div class="ttdeci">struct ast_variable * ast_variable_browse(const struct ast_config *config, const char *category_name)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l01216">extconf.c:1216</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a40dd33d7fa211edd276ab547f4ad5d73"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a40dd33d7fa211edd276ab547f4ad5d73">ast_vm_recording_data::recording_file</a></div><div class="ttdeci">const ast_string_field recording_file</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a960c0aad2b4d7e3e2917975674fe3afa"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a960c0aad2b4d7e3e2917975674fe3afa">pagerdateformat</a></div><div class="ttdeci">static char pagerdateformat[32]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01028">app_voicemail.c:1028</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa37835209fb22c9ca1e3f697b3da03f7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a></div><div class="ttdeci">static int adsi_logo(unsigned char *buf)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07311">app_voicemail.c:7311</a></div></div>
<div class="ttc" id="channel_8h_html_aef2af15a597c948e97628da6c5c84f28"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#aef2af15a597c948e97628da6c5c84f28">ast_indicate</a></div><div class="ttdeci">int ast_indicate(struct ast_channel *chan, int condition)</div><div class="ttdoc">Indicates condition of channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l04322">channel.c:4322</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9f77d88e0a6a07d752892fa046507c22"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">make_dir</a></div><div class="ttdeci">static int make_dir(char *dest, int len, const char *context, const char *ext, const char *folder)</div><div class="ttdoc">Creates a file system path expression for a folder within the voicemail data folder and the appropria...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01902">app_voicemail.c:1902</a></div></div>
<div class="ttc" id="time_8h_html"><div class="ttname"><a href="../../de/df7/time_8h.html">time.h</a></div><div class="ttdoc">Time-related functions and macros. </div></div>
<div class="ttc" id="structast__vm__user_html_ac92588540e8c1d014a08cd8a45462b19"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#ac92588540e8c1d014a08cd8a45462b19">ast_vm_user::flags</a></div><div class="ttdeci">unsigned int flags</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00774">app_voicemail.c:774</a></div></div>
<div class="ttc" id="structvm__state_html_a2bfed4d96614bbf76d9e6ab43d3b8d42"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">vm_state::deleted</a></div><div class="ttdeci">int * deleted</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00814">app_voicemail.c:814</a></div></div>
<div class="ttc" id="structast__party__id_html_aab4036618469f3fa9ab26a22726ba2db"><div class="ttname"><a href="../../d1/dcb/structast__party__id.html#aab4036618469f3fa9ab26a22726ba2db">ast_party_id::name</a></div><div class="ttdeci">struct ast_party_name name</div><div class="ttdoc">Subscriber name. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00341">channel.h:341</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_aea357396b4d70e149a76d9911689eb4b"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#aea357396b4d70e149a76d9911689eb4b">ast_vm_recording_data::mailbox</a></div><div class="ttdeci">const ast_string_field mailbox</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="eagi__proxy_8c_html_ac95651d79c608a3148973b5b1fc9e525"><div class="ttname"><a href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a></div><div class="ttdeci">char buf[BUFSIZE]</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d7c/eagi__proxy_8c_source.html#l00066">eagi_proxy.c:66</a></div></div>
<div class="ttc" id="astobj2_8h_html_ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01048">astobj2.h:1048</a></div></div>
<div class="ttc" id="namespacemake__ari__stubs_html_a40a5d58ffa6e88aa578d6683ac413105"><div class="ttname"><a href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">make_ari_stubs.file</a></div><div class="ttdeci">file</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d28/make__ari__stubs_8py_source.html#l00025">make_ari_stubs.py:25</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad6fa7eabdb6693aa433127102cd7abcd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad6fa7eabdb6693aa433127102cd7abcd">manager_status_voicemail_user</a></div><div class="ttdeci">static int manager_status_voicemail_user(struct mansession *s, const struct message *m)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13382">app_voicemail.c:13382</a></div></div>
<div class="ttc" id="misdn__config_8c_html_a92a7399cbb76f6349df98d9432ad52c6"><div class="ttname"><a href="../../d4/dfb/misdn__config_8c.html#a92a7399cbb76f6349df98d9432ad52c6">map</a></div><div class="ttdeci">static int * map</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dfb/misdn__config_8c_source.html#l00438">misdn_config.c:438</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab396ba916ebd13b58eedfb621a602413"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab396ba916ebd13b58eedfb621a602413">SMDI_MWI_WAIT_TIMEOUT</a></div><div class="ttdeci">#define SMDI_MWI_WAIT_TIMEOUT</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00503">app_voicemail.c:503</a></div></div>
<div class="ttc" id="dsp_8h_html"><div class="ttname"><a href="../../d3/d08/dsp_8h.html">dsp.h</a></div><div class="ttdoc">Convenient Signal Processing routines. </div></div>
<div class="ttc" id="app__voicemail_8c_html_a5fe40961f76694db47fb14e7b19ade9b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5fe40961f76694db47fb14e7b19ade9b">play_message_callerid</a></div><div class="ttdeci">static int play_message_callerid(struct ast_channel *chan, struct vm_state *vms, char *cid, const char *context, int callback, int saycidnumber)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08716">app_voicemail.c:8716</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a99015feb18d767bc5af10ee57f921c37"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a></div><div class="ttdeci">static int adsiver</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01026">app_voicemail.c:1026</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a67fca777538364c249bf1b66b2a22491ad95c70e1f5ce29d7ff275fea928b76ee"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491ad95c70e1f5ce29d7ff275fea928b76ee">AST_VM_SNAPSHOT_SORT_BY_TIME</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00297">include/asterisk/app.h:297</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaf8dbb4195a61c64d560b4c850dafb90"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90">inprocess_cmp_fn</a></div><div class="ttdeci">static int inprocess_cmp_fn(void *obj, void *arg, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01124">app_voicemail.c:1124</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad1982509765f4870f1f63412a53ea668"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a></div><div class="ttdeci">static int reload(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15045">app_voicemail.c:15045</a></div></div>
<div class="ttc" id="channel_8h_html_aa2df58e77751b741b6891afe210b5b8c"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#aa2df58e77751b741b6891afe210b5b8c">ast_channel_set_rawwriteformat</a></div><div class="ttdeci">void ast_channel_set_rawwriteformat(struct ast_channel *chan, struct ast_format *format)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00832">channel_internal_api.c:832</a></div></div>
<div class="ttc" id="test_8h_html_a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e"><div class="ttname"><a href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2adb2586ef58bb9dd2f84a7d592ecf3e0e">TEST_EXECUTE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00208">test.h:208</a></div></div>
<div class="ttc" id="utils_8h_html_ab5033a1f3d781d45e7ccc27598114510"><div class="ttname"><a href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a></div><div class="ttdeci">#define ast_set_flag(p, flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00070">utils.h:70</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae0e219c6e443e0d38b3ee75931222158"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">notify_new_message</a></div><div class="ttdeci">static int notify_new_message(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int msgnum, long duration, char *fmt, char *cidnum, char *cidname, const char *flag)</div><div class="ttdoc">Sends email notification that a user has a new voicemail waiting for them. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08155">app_voicemail.c:8155</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ac08f7eb1eb9476b30987c73e1052ada8"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8">AST_STANDARD_APP_ARGS</a></div><div class="ttdeci">#define AST_STANDARD_APP_ARGS(args, parse)</div><div class="ttdoc">Performs the &amp;#39;standard&amp;#39; argument separation process for an application. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01285">include/asterisk/app.h:1285</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a479e9d3cae1218f0f55e27d874a07a96"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a479e9d3cae1218f0f55e27d874a07a96">ast_install_vm_test_functions</a></div><div class="ttdeci">void ast_install_vm_test_functions(ast_vm_test_create_user_fn *vm_test_create_user_func, ast_vm_test_destroy_user_fn *vm_test_destroy_user_func)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00599">main/app.c:599</a></div></div>
<div class="ttc" id="group__Group__AMI_html_ga58c3e3da5d31739cafaee1df6ddf9342"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#ga58c3e3da5d31739cafaee1df6ddf9342">astman_send_list_complete_start</a></div><div class="ttdeci">void astman_send_list_complete_start(struct mansession *s, const struct message *m, const char *event_name, int count)</div><div class="ttdoc">Start the list complete event. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l03237">manager.c:3237</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a207c95b6a18096172f7278b3af01f96d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a></div><div class="ttdeci">#define ERROR_LOCK_PATH</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00567">app_voicemail.c:567</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af561c590ea94fc23f5f75e8a31b1a70a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a">handle_voicemail_show_users</a></div><div class="ttdeci">static char * handle_voicemail_show_users(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</div><div class="ttdoc">Show a list of voicemail users in the CLI. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12868">app_voicemail.c:12868</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849e">vm_option_flags</a></div><div class="ttdeci">vm_option_flags</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00580">app_voicemail.c:580</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af98522cd60be017011cde1f8522ed751"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751">vm_browse_messages_gr</a></div><div class="ttdeci">static int vm_browse_messages_gr(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Greek syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10963">app_voicemail.c:10963</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a15737b365a63c894e14d114db2ccddee"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a></div><div class="ttdeci">#define VM_SAYDURATION</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00553">app_voicemail.c:553</a></div></div>
<div class="ttc" id="structast__cli__entry_html"><div class="ttname"><a href="../../d8/d07/structast__cli__entry.html">ast_cli_entry</a></div><div class="ttdoc">descriptor for a cli entry. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00171">cli.h:171</a></div></div>
<div class="ttc" id="structast__cli__args_html_a98e1d8441ca58834f11f7367be4b3345"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#a98e1d8441ca58834f11f7367be4b3345">ast_cli_args::argc</a></div><div class="ttdeci">const int argc</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00160">cli.h:160</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00582">app_voicemail.c:582</a></div></div>
<div class="ttc" id="logger_8h_html_adf4476a6a4ea6c74231c826e899d7189"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a></div><div class="ttdeci">#define LOG_WARNING</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00274">logger.h:274</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_aec0281ec0a6743121492b2194649922f"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#aec0281ec0a6743121492b2194649922f">ast_uninstall_vm_test_functions</a></div><div class="ttdeci">void ast_uninstall_vm_test_functions(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00606">main/app.c:606</a></div></div>
<div class="ttc" id="structinprocess_html_a1f27749679e8054ef014a38569492895"><div class="ttname"><a href="../../de/d24/structinprocess.html#a1f27749679e8054ef014a38569492895">inprocess::context</a></div><div class="ttdeci">char * context</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01114">app_voicemail.c:1114</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aeab26b22621adc0bfdd81bca08ea0acf"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a></div><div class="ttdeci">static int sayname(struct ast_channel *chan, const char *mailbox, const char *context)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14359">app_voicemail.c:14359</a></div></div>
<div class="ttc" id="linkedlists_8h_html_ab48cb9e1e612dd486b747ba1c5d68d01"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a></div><div class="ttdeci">#define AST_LIST_UNLOCK(head)</div><div class="ttdoc">Attempts to unlock a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00139">linkedlists.h:139</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad87fa9ba37f50714bc922335b3b7ea91"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a></div><div class="ttdeci">static int maxsilence</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00919">app_voicemail.c:919</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_adb44a2647e8cd26cfb618f4ca0d0d1a7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#adb44a2647e8cd26cfb618f4ca0d0d1a7">alias_mailbox_mappings</a></div><div class="ttdeci">static struct ao2_container * alias_mailbox_mappings</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00967">app_voicemail.c:967</a></div></div>
<div class="ttc" id="utils_8h_html_a34ed7a76195d923c099606f796294a3b"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a34ed7a76195d923c099606f796294a3b">ast_file_is_readable</a></div><div class="ttdeci">int ast_file_is_readable(const char *filename)</div><div class="ttdoc">Test that a file exists and is readable by the effective user. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l02855">main/utils.c:2855</a></div></div>
<div class="ttc" id="strings_8h_html_a1ef7e2644ca7258070db316fdc0a465b"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a></div><div class="ttdeci">char * ast_str_buffer(const struct ast_str *buf)</div><div class="ttdoc">Returns the string buffer within the ast_str buf. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00714">strings.h:714</a></div></div>
<div class="ttc" id="structbaseio_html"><div class="ttname"><a href="../../d5/d11/structbaseio.html">baseio</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00740">app_voicemail.c:740</a></div></div>
<div class="ttc" id="structast__vm__greeter__functions_html"><div class="ttname"><a href="../../d0/d1e/structast__vm__greeter__functions.html">ast_vm_greeter_functions</a></div><div class="ttdoc">Voicemail greeter function table definition. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00618">include/asterisk/app.h:618</a></div></div>
<div class="ttc" id="res__adsi_8c_html_ac5f1985e4c8cb8439ac70ea293e819c7"><div class="ttname"><a href="../../dd/d27/res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">intro</a></div><div class="ttdeci">static char intro[ADSI_MAX_INTRO][20]</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d27/res__adsi_8c_source.html#l00065">res_adsi.c:65</a></div></div>
<div class="ttc" id="res__xmpp_8c_html_ac3e1795766a80ec63b157951b4b9a7d4"><div class="ttname"><a href="../../dc/d6b/res__xmpp_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a></div><div class="ttdeci">static int debug</div><div class="ttdoc">Global debug status. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d6b/res__xmpp_8c_source.html#l00435">res_xmpp.c:435</a></div></div>
<div class="ttc" id="taskprocessor_8h_html_ad4a3db2b08877779bd481a649318be7d"><div class="ttname"><a href="../../d0/d1e/taskprocessor_8h.html#ad4a3db2b08877779bd481a649318be7d">AST_TASKPROCESSOR_HIGH_WATER_LEVEL</a></div><div class="ttdeci">#define AST_TASKPROCESSOR_HIGH_WATER_LEVEL</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d1e/taskprocessor_8h_source.html#l00063">taskprocessor.h:63</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a19699e5ae6b6319ff1d158c855d2bc84"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a></div><div class="ttdeci">static int pwdchange</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00887">app_voicemail.c:887</a></div></div>
<div class="ttc" id="test__linkedlists_8c_html_a156f09c32102fa036620ad75c3ee4fbf"><div class="ttname"><a href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a></div><div class="ttdeci">static struct test_val d</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d6f/test__linkedlists_8c_source.html#l00049">test_linkedlists.c:49</a></div></div>
<div class="ttc" id="astobj2_8h_html_a47857055118a703ae87ea5ebaf4842ed"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a></div><div class="ttdeci">#define ao2_callback(c, flags, cb_fn, arg)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01716">astobj2.h:1716</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae55c18b0e0a94a34580e1ac4edf96c04"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae55c18b0e0a94a34580e1ac4edf96c04">vm_intro_ja</a></div><div class="ttdeci">static int vm_intro_ja(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09568">app_voicemail.c:9568</a></div></div>
<div class="ttc" id="taskprocessor_8h_html_ac999cc9523590a29dff6acbd9cad24a9"><div class="ttname"><a href="../../d0/d1e/taskprocessor_8h.html#ac999cc9523590a29dff6acbd9cad24a9">ast_taskprocessor_get</a></div><div class="ttdeci">struct ast_taskprocessor * ast_taskprocessor_get(const char *name, enum ast_tps_options create)</div><div class="ttdoc">Get a reference to a taskprocessor with the specified name and create the taskprocessor if necessary...</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/deb/taskprocessor_8c_source.html#l01044">taskprocessor.c:1044</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a66b6af9ceef39cb23b48501efe87219f"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a66b6af9ceef39cb23b48501efe87219f">ast_unload_realtime</a></div><div class="ttdeci">int ast_unload_realtime(const char *family)</div><div class="ttdoc">Release any resources cached for a realtime family. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03406">main/config.c:3406</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a8d1a63cdf2c7aff22a77b6e75d93b377"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a></div><div class="ttdeci">#define CONFIG_STATUS_FILEINVALID</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00060">include/asterisk/config.h:60</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a54ba5a3384c68e34bd62ee0a0da20e7a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a">vm_intro_de</a></div><div class="ttdeci">static int vm_intro_de(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09927">app_voicemail.c:9927</a></div></div>
<div class="ttc" id="structast__variable_html_a501b314f49b3a9ff6e7be599d94686ee"><div class="ttname"><a href="../../dd/d02/structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">ast_variable::lineno</a></div><div class="ttdeci">int lineno</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00095">include/asterisk/config.h:95</a></div></div>
<div class="ttc" id="res__ari__mailboxes_8c_html_a29d08f8b2448744d75ca9ebc4e218419"><div class="ttname"><a href="../../d0/dd5/res__ari__mailboxes_8c.html#a29d08f8b2448744d75ca9ebc4e218419">mailboxes</a></div><div class="ttdeci">static struct stasis_rest_handlers mailboxes</div><div class="ttdoc">REST handler for /api-docs/mailboxes.json. </div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd5/res__ari__mailboxes_8c_source.html#l00322">res_ari_mailboxes.c:322</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab46529fc3aca41f01be29d17fdcb2301"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a></div><div class="ttdeci">static int maxdeletedmsg</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00921">app_voicemail.c:921</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a6c4ee520c857eb74851962c54f6c2bf1"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a6c4ee520c857eb74851962c54f6c2bf1">ast_vm_recording_data::call_priority</a></div><div class="ttdeci">int call_priority</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00104">include/asterisk/app.h:104</a></div></div>
<div class="ttc" id="smdi_8h_html_ac5e5c2f622f22084f67a01e8f12eab8d"><div class="ttname"><a href="../../dc/dca/smdi_8h.html#ac5e5c2f622f22084f67a01e8f12eab8d">ast_smdi_interface_find</a></div><div class="ttdeci">struct ast_smdi_interface * ast_smdi_interface_find(const char *iface_name)</div><div class="ttdoc">Find an SMDI interface with the specified name. </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d96/res__smdi_8c_source.html#l00563">res_smdi.c:563</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a70050c138d17b318c0677ec4218064d3"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a70050c138d17b318c0677ec4218064d3">print_mappings</a></div><div class="ttdeci">static void print_mappings(void *v_obj, void *where, ao2_prnt_fn *prnt)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15099">app_voicemail.c:15099</a></div></div>
<div class="ttc" id="res__odbc_8h_html_a6c76549f7fd9feafdca9bf90f57f224a"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html#a6c76549f7fd9feafdca9bf90f57f224a">ast_odbc_prepare</a></div><div class="ttdeci">int ast_odbc_prepare(struct odbc_obj *obj, SQLHSTMT *stmt, const char *sql)</div><div class="ttdoc">Prepares a SQL query on a statement. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d4a/res__odbc_8c_source.html#l00463">res_odbc.c:463</a></div></div>
<div class="ttc" id="bt__open_8c_html_a1cdd2bb1a9a71d3e1120100229315d67"><div class="ttname"><a href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a></div><div class="ttdeci">static int tmp()</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1e/bt__open_8c_source.html#l00389">bt_open.c:389</a></div></div>
<div class="ttc" id="localtime_8h_html_ae9fbda728350a9a5b9c09b29214d718e"><div class="ttname"><a href="../../d5/deb/localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e">ast_localtime</a></div><div class="ttdeci">struct ast_tm * ast_localtime(const struct timeval *timep, struct ast_tm *p_tm, const char *zone)</div><div class="ttdoc">Timezone-independent version of localtime_r(3). </div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df8/localtime_8c_source.html#l01739">localtime.c:1739</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_adb02bb3719cdf90c200c1ca30caa26a2"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">tdesc</a></div><div class="ttdeci">#define tdesc</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00895">app_voicemail.c:895</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_acf98df015fe3d94786514c85bbc05353"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353">adsi_status2</a></div><div class="ttdeci">static void adsi_status2(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07743">app_voicemail.c:7743</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa9165d06328e9d07c0ccbdbf9325f9d1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1">copy_plain_file</a></div><div class="ttdeci">static void copy_plain_file(char *frompath, char *topath)</div><div class="ttdoc">Copies a voicemail information (envelope) file. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04694">app_voicemail.c:4694</a></div></div>
<div class="ttc" id="pbx__dundi_8c_html_aadd75c09e15efa9061997f033b3f224b"><div class="ttname"><a href="../../d1/dc0/pbx__dundi_8c.html#aadd75c09e15efa9061997f033b3f224b">email</a></div><div class="ttdeci">static char email[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc0/pbx__dundi_8c_source.html#l00206">pbx_dundi.c:206</a></div></div>
<div class="ttc" id="group__StasisTopicsAndMessages_html_ga26e335fc4e4c1e8d0023ae9c987ccb4b"><div class="ttname"><a href="../../df/deb/group__StasisTopicsAndMessages.html#ga26e335fc4e4c1e8d0023ae9c987ccb4b">ast_mwi_observer::on_subscribe</a></div><div class="ttdeci">void(* on_subscribe)(const char *mailbox, struct ast_mwi_subscriber *sub)</div><div class="ttdoc">Raised when MWI is being subscribed. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00259">mwi.h:259</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a73413880ef85ba50f1ad0087997a6d14"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a73413880ef85ba50f1ad0087997a6d14">vm_browse_messages_ja</a></div><div class="ttdeci">static int vm_browse_messages_ja(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Japanese syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11069">app_voicemail.c:11069</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00577">app_voicemail.c:577</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a910f835a41772603d33e200c956549ff"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a910f835a41772603d33e200c956549ff">ast_check_realtime</a></div><div class="ttdeci">int ast_check_realtime(const char *family)</div><div class="ttdoc">Check if realtime engine is configured for family. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03363">main/config.c:3363</a></div></div>
<div class="ttc" id="structast__variable_html"><div class="ttname"><a href="../../dd/d02/structast__variable.html">ast_variable</a></div><div class="ttdoc">Structure for variables, used for configurations and for channel variables. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00083">include/asterisk/config.h:83</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_afcbfdd6dfc8c5f0f549b0a5d7e263e97"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97">ast_close_fds_above_n</a></div><div class="ttdeci">void ast_close_fds_above_n(int n)</div><div class="ttdoc">Common routine for child processes, to close all fds prior to exec(2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l03042">main/app.c:3042</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaea1c83faa41ab79a1342f34a3a346c1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1">vm_option_args</a></div><div class="ttdeci">vm_option_args</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00594">app_voicemail.c:594</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6850fa64e511b2de06fd2dd36a267883"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6850fa64e511b2de06fd2dd36a267883">append_vmu_info_astman</a></div><div class="ttdeci">static int append_vmu_info_astman(struct mansession *s, struct ast_vm_user *vmu, const char *event_name, const char *actionid)</div><div class="ttdoc">Append vmu info string into given astman with event_name. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13227">app_voicemail.c:13227</a></div></div>
<div class="ttc" id="logger_8h_html_a2878d83e36d91850732bad997524e45e"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a></div><div class="ttdeci">#define AST_LOG_WARNING</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00279">logger.h:279</a></div></div>
<div class="ttc" id="ast__expr2f_8c_html_a1b0936415a643c88ce543099c10e0d7f"><div class="ttname"><a href="../../dc/df2/ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a></div><div class="ttdeci">#define var</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df2/ast__expr2f_8c_source.html#l00614">ast_expr2f.c:614</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a384d700a5c87a2551e5ee6ed5ab6b548"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a384d700a5c87a2551e5ee6ed5ab6b548">MAPPING_BUCKETS</a></div><div class="ttdeci">#define MAPPING_BUCKETS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00966">app_voicemail.c:966</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a44aadf5d5e3c3253c56d6986e012a767"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767">adsisec</a></div><div class="ttdeci">static unsigned char adsisec[4]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01025">app_voicemail.c:1025</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6f391f861982d42d13e6c08e00207abb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6f391f861982d42d13e6c08e00207abb">vm_sayname</a></div><div class="ttdeci">static int vm_sayname(struct ast_channel *chan, const char *mailbox_id)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14384">app_voicemail.c:14384</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a863d82d0cdc03163833e89dc36e3ad4c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">vm_intro_pt</a></div><div class="ttdeci">static int vm_intro_pt(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10168">app_voicemail.c:10168</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a469419101eb621ce1ead45b4792fb5a6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">count_messages</a></div><div class="ttdeci">static int count_messages(struct ast_vm_user *vmu, char *dir)</div><div class="ttdoc">Find all .txt files - even if they are not in sequence from 0000. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04524">app_voicemail.c:4524</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1eb1e0cbaef35879c60c6afd79dcc6af"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1eb1e0cbaef35879c60c6afd79dcc6af">DEFAULT_LISTEN_CONTROL_FORWARD_KEY</a></div><div class="ttdeci">#define DEFAULT_LISTEN_CONTROL_FORWARD_KEY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00517">app_voicemail.c:517</a></div></div>
<div class="ttc" id="adsi_8h_html_ae9091dd77412994b2a87c5b30dfb8f6a"><div class="ttname"><a href="../../df/de2/adsi_8h.html#ae9091dd77412994b2a87c5b30dfb8f6a">ast_adsi_set_keys</a></div><div class="ttdeci">int ast_adsi_set_keys(unsigned char *buf, unsigned char *keys)</div><div class="ttdoc">Set which soft keys should be displayed. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00307">adsi.c:307</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01166">include/asterisk/app.h:1166</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00572">app_voicemail.c:572</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaea1c83faa41ab79a1342f34a3a346c1ab3c235d8800fef13d32bda9908cb0599"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00596">app_voicemail.c:596</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a103e76ed4bd42f776f7f260080b98b3fabc16a274124ae96d43f8e52e344292c3"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fabc16a274124ae96d43f8e52e344292c3">CONFIG_FLAG_WITHCOMMENTS</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00041">include/asterisk/config.h:41</a></div></div>
<div class="ttc" id="linkedlists_8h_html_ae234825bcb65b88c0554b995ff1b8ba6"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6">AST_LIST_NEXT</a></div><div class="ttdeci">#define AST_LIST_NEXT(elm, field)</div><div class="ttdoc">Returns the next entry in the list after the given entry. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00438">linkedlists.h:438</a></div></div>
<div class="ttc" id="adsi_8h_html_ac80689408529c01f75cb698fc2e407fb"><div class="ttname"><a href="../../df/de2/adsi_8h.html#ac80689408529c01f75cb698fc2e407fb">ast_adsi_load_session</a></div><div class="ttdeci">int ast_adsi_load_session(struct ast_channel *chan, unsigned char *app, int ver, int data)</div><div class="ttdoc">Check if scripts for a given app are already loaded. Version may be -1, if any version is okay...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00076">adsi.c:76</a></div></div>
<div class="ttc" id="pbx_8h_html_a556749361c7b9109134c8d00ab4ef6bf"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a556749361c7b9109134c8d00ab4ef6bf">ast_str_substitute_variables</a></div><div class="ttdeci">void ast_str_substitute_variables(struct ast_str **buf, ssize_t maxlen, struct ast_channel *chan, const char *templ)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d8c/pbx__variables_8c_source.html#l00616">pbx_variables.c:616</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1663f2d08dd7c882b4eda7a725bbf275"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1663f2d08dd7c882b4eda7a725bbf275">manager_voicemail_refresh</a></div><div class="ttdeci">static int manager_voicemail_refresh(struct mansession *s, const struct message *m)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13375">app_voicemail.c:13375</a></div></div>
<div class="ttc" id="test_8h_html"><div class="ttname"><a href="../../d2/ddc/test_8h.html">test.h</a></div><div class="ttdoc">Test Framework API. </div></div>
<div class="ttc" id="app__voicemail_8c_html_af8fbf1ad20e08b5b0d68c2a5476cc10c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c">vm_intro_it</a></div><div class="ttdeci">static int vm_intro_it(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09733">app_voicemail.c:9733</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a98a361868421e789787246003ce2844f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a98a361868421e789787246003ce2844f">actual_load_config</a></div><div class="ttdeci">static int actual_load_config(int reload, struct ast_config *cfg, struct ast_config *ucfg)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13680">app_voicemail.c:13680</a></div></div>
<div class="ttc" id="say_8h_html_ac8bd6c34b6aa664adb9ebfab68a500ce"><div class="ttname"><a href="../../db/dce/say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce">ast_say_digit_str</a></div><div class="ttdeci">int ast_say_digit_str(struct ast_channel *chan, const char *num, const char *ints, const char *lang)</div><div class="ttdoc">says digits of a string </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l08355">channel.c:8355</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a78eb70f28d5f0960e183d68f2c3b6f92"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a></div><div class="ttdeci">#define VM_MESSAGEWRAP</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00565">app_voicemail.c:565</a></div></div>
<div class="ttc" id="manager_8h_html_ab5db3cc603d7e798d61cb4cd94fbb4e2"><div class="ttname"><a href="../../db/d45/manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a></div><div class="ttdeci">#define EVENT_FLAG_CALL</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d45/manager_8h_source.html#l00072">manager.h:72</a></div></div>
<div class="ttc" id="test_8h_html_a34f64a69c09d98ceb693b077efd7ef97"><div class="ttname"><a href="../../d2/ddc/test_8h.html#a34f64a69c09d98ceb693b077efd7ef97">AST_TEST_REGISTER</a></div><div class="ttdeci">#define AST_TEST_REGISTER(cb)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00127">test.h:127</a></div></div>
<div class="ttc" id="cli_8h_html_ab33e5350a923c3a8cedbeb496cd88ec9a71745eb63dd093f560a1add3e430d2a9"><div class="ttname"><a href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00152">cli.h:152</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6d1280b868a461dc347430bff8922eaf"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a></div><div class="ttdeci">static int messagecount(const char *mailbox_id, const char *folder)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06048">app_voicemail.c:6048</a></div></div>
<div class="ttc" id="structvm__state_html_ab866a3b365ca8eca41c286e4fe0031f8"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">vm_state::curmsg</a></div><div class="ttdeci">int curmsg</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00817">app_voicemail.c:817</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a924855b544cbe4f128ba7f92e929065f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a></div><div class="ttdeci">static int maxgreet</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00931">app_voicemail.c:931</a></div></div>
<div class="ttc" id="adsi_8h_html_adcf83d43ae50c9f89365699d8974c7b7"><div class="ttname"><a href="../../df/de2/adsi_8h.html#adcf83d43ae50c9f89365699d8974c7b7">ast_adsi_download_disconnect</a></div><div class="ttdeci">int ast_adsi_download_disconnect(unsigned char *buf)</div><div class="ttdoc">Disconnects (and hopefully saves) a downloaded script. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00208">adsi.c:208</a></div></div>
<div class="ttc" id="channelstate_8h_html_a03585bc87e5bbd0f4d11bc789734c660"><div class="ttname"><a href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660">ast_channel_state</a></div><div class="ttdeci">ast_channel_state</div><div class="ttdoc">ast_channel states </div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d95/channelstate_8h_source.html#l00035">channelstate.h:35</a></div></div>
<div class="ttc" id="structvm__state_html_a3e18d3cc05ec901b83a690c32f865de8"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">vm_state::curdir</a></div><div class="ttdeci">char curdir[PATH_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00810">app_voicemail.c:810</a></div></div>
<div class="ttc" id="structast__party__name_html_ab50d783982593ef993ea0b68f7ad8b80"><div class="ttname"><a href="../../d8/d6f/structast__party__name.html#ab50d783982593ef993ea0b68f7ad8b80">ast_party_name::str</a></div><div class="ttdeci">char * str</div><div class="ttdoc">Subscriber name (Malloced) </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00265">channel.h:265</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a84250923008fa3be2ba9f54e1cc3298a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a></div><div class="ttdeci">static void adsi_login(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07465">app_voicemail.c:7465</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a495591a348e5b9edcf4be80cb688ca89"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a></div><div class="ttdeci">static pthread_t poll_thread</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00949">app_voicemail.c:949</a></div></div>
<div class="ttc" id="structalias__mailbox__mapping_html_a103a957b017f6b717767bba130a02694"><div class="ttname"><a href="../../de/d16/structalias__mailbox__mapping.html#a103a957b017f6b717767bba130a02694">alias_mailbox_mapping::buf</a></div><div class="ttdeci">char buf[0]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00957">app_voicemail.c:957</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaea1c83faa41ab79a1342f34a3a346c1ace0cd0142789f22dc002e491bba8db66"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1ace0cd0142789f22dc002e491bba8db66">OPT_ARG_BEEP_TONE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00598">app_voicemail.c:598</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a134460fff8dee50c51edf76e5dd3a76b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a></div><div class="ttdeci">static int close_mailbox(struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09152">app_voicemail.c:9152</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaea1c83faa41ab79a1342f34a3a346c1af287dd95d8f656a0423cc51f3f63e1c5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1af287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00597">app_voicemail.c:597</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0a3bdd4928cf24add43a0a087998820d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a></div><div class="ttdeci">static char listen_control_reverse_key[12]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00977">app_voicemail.c:977</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a893427f4de0013bcc1a008cdd77111a4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a></div><div class="ttdeci">#define VM_ATTACH</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00559">app_voicemail.c:559</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a63158d120e779bf4b9e4e9fc1f70553b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a63158d120e779bf4b9e4e9fc1f70553b">vm_greeter_table</a></div><div class="ttdeci">static const struct ast_vm_greeter_functions vm_greeter_table</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15038">app_voicemail.c:15038</a></div></div>
<div class="ttc" id="strings_8h_html_a1088afdd862a49b0fce34ebe02df8ca1"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a1088afdd862a49b0fce34ebe02df8ca1">ast_str_append</a></div><div class="ttdeci">int ast_str_append(struct ast_str **buf, ssize_t max_len, const char *fmt,...)</div><div class="ttdoc">Append to a thread local dynamic string. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l01091">strings.h:1091</a></div></div>
<div class="ttc" id="cli_8h_html_aea8910ed9e301e7f741f87942c244eac"><div class="ttname"><a href="../../dc/db0/cli_8h.html#aea8910ed9e301e7f741f87942c244eac">ast_cli_register_multiple</a></div><div class="ttdeci">#define ast_cli_register_multiple(e, len)</div><div class="ttdoc">Register multiple commands. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00265">cli.h:265</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_aab65d2013da7fcbb28da422712bac5e8"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#aab65d2013da7fcbb28da422712bac5e8">ast_vm_unregister</a></div><div class="ttdeci">void ast_vm_unregister(const char *module_name)</div><div class="ttdoc">Unregister the specified voicemail provider. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00473">main/app.c:473</a></div></div>
<div class="ttc" id="func__realtime_8c_html_a13d23fea305bed9188c360e245c5c9f1"><div class="ttname"><a href="../../db/d09/func__realtime_8c.html#a13d23fea305bed9188c360e245c5c9f1">buf2</a></div><div class="ttdeci">static struct ast_threadstorage buf2</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d09/func__realtime_8c_source.html#l00179">func_realtime.c:179</a></div></div>
<div class="ttc" id="astobj2_8h_html_ad36841ab6daa3997f7ca7047ad2d033a"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#ad36841ab6daa3997f7ca7047ad2d033a">ao2_iterator_destroy</a></div><div class="ttdeci">void ao2_iterator_destroy(struct ao2_iterator *iter)</div><div class="ttdoc">Destroy a container iterator. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d22/astobj2__container_8c_source.html#l00534">astobj2_container.c:534</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abe15777a07ac747625b018ac01f92531"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">copy</a></div><div class="ttdeci">static int copy(char *infile, char *outfile)</div><div class="ttdoc">Utility function to copy a file. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04629">app_voicemail.c:4629</a></div></div>
<div class="ttc" id="time_8h_html_ad3899efb6f0e348556ef69f5b16aa7f7"><div class="ttname"><a href="../../de/df7/time_8h.html#ad3899efb6f0e348556ef69f5b16aa7f7">ast_tvnow</a></div><div class="ttdeci">struct timeval ast_tvnow(void)</div><div class="ttdoc">Returns current timeval. Meant to replace calls to gettimeofday(). </div><div class="ttdef"><b>Definition:</b> <a href="../../de/df7/time_8h_source.html#l00150">time.h:150</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a6c0c71b2a228214f089f4516a4d91793"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a6c0c71b2a228214f089f4516a4d91793">ast_play_and_prepend</a></div><div class="ttdeci">int ast_play_and_prepend(struct ast_channel *chan, char *playfile, char *recordfile, int maxtime_sec, char *fmt, int *duration, int *sound_duration, int beep, int silencethreshold, int maxsilence_ms)</div><div class="ttdoc">Record a file based on input frm a channel. Recording is performed in &amp;#39;prepend&amp;#39; mode which works a li...</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l02002">main/app.c:2002</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a789b147df36d769c1c0d55051f655c7f"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a789b147df36d769c1c0d55051f655c7f">VM_GREETER_MODULE_VERSION</a></div><div class="ttdeci">#define VM_GREETER_MODULE_VERSION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00615">include/asterisk/app.h:615</a></div></div>
<div class="ttc" id="structast__vm__user_html_a29b9b126bac9cc5f1cc334f140f39e8d"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">ast_vm_user::pager</a></div><div class="ttdeci">char pager[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00763">app_voicemail.c:763</a></div></div>
<div class="ttc" id="adsi_8h_html_a730b24255e33ddaa2bc4e52b51220100"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a></div><div class="ttdeci">#define ADSI_JUST_LEFT</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00112">adsi.h:112</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5e97aad653c098e2ccb57d624fb7f373"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5e97aad653c098e2ccb57d624fb7f373">vm_newuser_setup</a></div><div class="ttdeci">static int vm_newuser_setup(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10646">app_voicemail.c:10646</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3e31a9f80da1b70cf892de39b4bff759"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">INTRO</a></div><div class="ttdeci">#define INTRO</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00528">app_voicemail.c:528</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a4a1884cde93e53bef32ca85c194a1d05"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05">AST_LIST_EMPTY</a></div><div class="ttdeci">#define AST_LIST_EMPTY(head)</div><div class="ttdoc">Checks whether the specified list contains any entries. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00449">linkedlists.h:449</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad4786cc0738d237b7697e5448da7d22e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad4786cc0738d237b7697e5448da7d22e">locale</a></div><div class="ttdeci">static char locale[20]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00918">app_voicemail.c:918</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a878d95a3422bae307725f76c13fb62de"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a878d95a3422bae307725f76c13fb62de">play_message_by_id_helper</a></div><div class="ttdeci">static int play_message_by_id_helper(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, const char *msg_id)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11359">app_voicemail.c:11359</a></div></div>
<div class="ttc" id="group__Group__AMI_html_ga77315fa8e29950f0c88120501acda0a3"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3">astman_send_ack</a></div><div class="ttdeci">void astman_send_ack(struct mansession *s, const struct message *m, char *msg)</div><div class="ttdoc">Send ack in manager transaction. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l03191">manager.c:3191</a></div></div>
<div class="ttc" id="lock_8h_html_ac5e13c7fe64d3b271a52028b0a78b92b"><div class="ttname"><a href="../../dd/d42/lock_8h.html#ac5e13c7fe64d3b271a52028b0a78b92b">ast_mutex_lock</a></div><div class="ttdeci">#define ast_mutex_lock(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00187">lock.h:187</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1129848f393043d9157c3e2580a6f9a5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5">get_folder</a></div><div class="ttdeci">static int get_folder(struct ast_channel *chan, int start)</div><div class="ttdoc">get_folder: Folder menu Plays &quot;press 1 for INBOX messages&quot; etc. Should possibly be internationalized ...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07819">app_voicemail.c:7819</a></div></div>
<div class="ttc" id="channelstate_8h_html_a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d"><div class="ttname"><a href="../../d9/d95/channelstate_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d95/channelstate_8h_source.html#l00042">channelstate.h:42</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a98f2fd50c0a8f8bde6a369a4b296f447"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a98f2fd50c0a8f8bde6a369a4b296f447">get_folder_by_name</a></div><div class="ttdeci">static int get_folder_by_name(const char *name)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01977">app_voicemail.c:1977</a></div></div>
<div class="ttc" id="astobj2_8h_html_a9998bd156b936636a8780385e9a910b2"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a9998bd156b936636a8780385e9a910b2">ao2_unlock</a></div><div class="ttdeci">#define ao2_unlock(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l00730">astobj2.h:730</a></div></div>
<div class="ttc" id="test__linkedlists_8c_html_acd9db00336027462cfb25b97b5356883"><div class="ttname"><a href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a></div><div class="ttdeci">static struct test_val c</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d6f/test__linkedlists_8c_source.html#l00048">test_linkedlists.c:48</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6e510ae693179f025e8850a7e4963a3a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6e510ae693179f025e8850a7e4963a3a">aliasescontext</a></div><div class="ttdeci">static char aliasescontext[MAX_VM_CONTEXT_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00936">app_voicemail.c:936</a></div></div>
<div class="ttc" id="utils_8h_html_ab9da1c7265610eff83ed6146f104dc6f"><div class="ttname"><a href="../../d5/d60/utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a></div><div class="ttdeci">#define ast_copy_flags(dest, src, flagz)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00084">utils.h:84</a></div></div>
<div class="ttc" id="structvm__zone_html_a2fe313e9263c1c3aa2001f179977e0c3"><div class="ttname"><a href="../../d7/d13/structvm__zone.html#a2fe313e9263c1c3aa2001f179977e0c3">vm_zone::msg_format</a></div><div class="ttdeci">char msg_format[512]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00800">app_voicemail.c:800</a></div></div>
<div class="ttc" id="strings_8h_html_a7fc844c12b769ccded05e7514036e241"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a></div><div class="ttdeci">#define ast_str_alloca(init_len)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00800">strings.h:800</a></div></div>
<div class="ttc" id="network_8h_html_afd80ecbe3170ca4fc85b65cda8659f82"><div class="ttname"><a href="../../d9/d94/network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a></div><div class="ttdeci">#define MAXHOSTNAMELEN</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d94/network_8h_source.html#l00069">network.h:69</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_adab3ddaecf532e431905b714748fce1f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#adab3ddaecf532e431905b714748fce1f">load_aliases</a></div><div class="ttdeci">static void load_aliases(struct ast_config *cfg)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13606">app_voicemail.c:13606</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8c38a20df9d7ac0e6aa6e1d9e18e5356"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8c38a20df9d7ac0e6aa6e1d9e18e5356">vm_allocate_dh</a></div><div class="ttdeci">static int vm_allocate_dh(struct vm_state *vms, struct ast_vm_user *vmu, int count_msg)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l02021">app_voicemail.c:2021</a></div></div>
<div class="ttc" id="astmm_8h_html_ab263849d03fb892847be4986db759737"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a></div><div class="ttdeci">#define ast_strdup(str)</div><div class="ttdoc">A wrapper for strdup() </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00243">astmm.h:243</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3fd02e9399fad0b67dd0a7d6f4af464e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3fd02e9399fad0b67dd0a7d6f4af464e">sendmail</a></div><div class="ttdeci">static int sendmail(char *srcemail, struct ast_vm_user *vmu, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, char *attach, char *attach2, char *format, int duration, int attach_user_voicemail, struct ast_channel *chan, const char *category, const char *flag, const char *msg_id)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05520">app_voicemail.c:5520</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad09fa931f468002152a3cc2d5ce25eae"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a></div><div class="ttdeci">static int unload_module(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15050">app_voicemail.c:15050</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a42eb1cc1b531f7e8f240fbe0eb6ad1bb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">check_mime</a></div><div class="ttdeci">static int check_mime(const char *str)</div><div class="ttdoc">Check if the string would need encoding within the MIME standard, to avoid confusing certain mail sof...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05002">app_voicemail.c:5002</a></div></div>
<div class="ttc" id="app__jack_8c_html_af25d6dc49269fa2003ac7c7fa6f13915"><div class="ttname"><a href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a></div><div class="ttdeci">const char * str</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dcd/app__jack_8c_source.html#l00147">app_jack.c:147</a></div></div>
<div class="ttc" id="mwi_8h_html_aa878bb71532040c72e88ffa2f107d7b4"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#aa878bb71532040c72e88ffa2f107d7b4">ast_mwi_state_callback_subscribed</a></div><div class="ttdeci">void ast_mwi_state_callback_subscribed(on_mwi_state handler, void *data)</div><div class="ttdoc">For each managed mailbox that has a subscriber call the given handler. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00343">mwi.c:343</a></div></div>
<div class="ttc" id="file_8h_html"><div class="ttname"><a href="../../d2/d4d/file_8h.html">file.h</a></div><div class="ttdoc">Generic File Format Support. Should be included by clients of the file handling routines. File service providers should instead include mod_format.h. </div></div>
<div class="ttc" id="taskprocessor_8h_html_ad4d9150df7126ae11064d38c755d0813"><div class="ttname"><a href="../../d0/d1e/taskprocessor_8h.html#ad4d9150df7126ae11064d38c755d0813">ast_taskprocessor_alert_set_levels</a></div><div class="ttdeci">int ast_taskprocessor_alert_set_levels(struct ast_taskprocessor *tps, long low_water, long high_water)</div><div class="ttdoc">Set the high and low alert water marks of the given taskprocessor queue. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/deb/taskprocessor_8c_source.html#l00830">taskprocessor.c:830</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_acf07ed2eba262b9d8580db31f6a0bd1f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">poll_cond</a></div><div class="ttdeci">static ast_cond_t poll_cond</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00948">app_voicemail.c:948</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a1e5e3d08eff5e2357e75c01e127e7922"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a1e5e3d08eff5e2357e75c01e127e7922">ast_category_browse</a></div><div class="ttdeci">char * ast_category_browse(struct ast_config *config, const char *prev_name)</div><div class="ttdoc">Browse categories. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l03328">extconf.c:3328</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab5a51d8e382db73c64233a82ee99a4ef"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab5a51d8e382db73c64233a82ee99a4ef">mwi_handle_subscribe</a></div><div class="ttdeci">static void mwi_handle_subscribe(const char *id, struct ast_mwi_subscriber *sub)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13181">app_voicemail.c:13181</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa2f937e69f79fbfcbf13a8ca51adcce0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a></div><div class="ttdeci">static char externnotify[160]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00925">app_voicemail.c:925</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9cfc31f6dff7a6c4cca28ef985a18f9c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a></div><div class="ttdeci">static int inprocess_count(const char *context, const char *mailbox, int delta)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01133">app_voicemail.c:1133</a></div></div>
<div class="ttc" id="test__func__file_8c_html_a7df83d295429a2562396f1ec127a46c0"><div class="ttname"><a href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a></div><div class="ttdeci">const char * args</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/dde/test__func__file_8c_source.html#l00046">test_func_file.c:46</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_af6428878db94a4adf8136850e6a654f5"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a></div><div class="ttdeci">int ast_unlock_path(const char *path)</div><div class="ttdoc">Unlock a path. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l02473">main/app.c:2473</a></div></div>
<div class="ttc" id="mwi_8h_html_ae56e2e8831cc3919b5d92bad99786572"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#ae56e2e8831cc3919b5d92bad99786572">ast_mwi_subscriber_data</a></div><div class="ttdeci">struct ast_mwi_state * ast_mwi_subscriber_data(struct ast_mwi_subscriber *sub)</div><div class="ttdoc">Retrieves the state data object associated with the MWI subscriber. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00264">mwi.c:264</a></div></div>
<div class="ttc" id="structast__vm__user_html_a5d49a297933d69b1790ea84cfc316510"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">ast_vm_user::password</a></div><div class="ttdeci">char password[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00758">app_voicemail.c:758</a></div></div>
<div class="ttc" id="resample_8c_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d7f/resample_8c_source.html#l00096">resample.c:96</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac70fbae4ed48b5b48ff4b49f01e29f86"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86">inbuf</a></div><div class="ttdeci">static int inbuf(struct baseio *bio, FILE *fi)</div><div class="ttdoc">utility used by inchar(), for base_encode() </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04770">app_voicemail.c:4770</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a25d922d91d1c3a161cd27f74198f5b46"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a></div><div class="ttdeci">static int vmminsecs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00929">app_voicemail.c:929</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9c53251b14e2c73274d41136b84ca816"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a></div><div class="ttdeci">static char * emailsubject</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01017">app_voicemail.c:1017</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a3405b1282cefdceebba734b8e756c55d"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a3405b1282cefdceebba734b8e756c55d">ast_control_streamfile</a></div><div class="ttdeci">int ast_control_streamfile(struct ast_channel *chan, const char *file, const char *fwd, const char *rev, const char *stop, const char *pause, const char *restart, int skipms, long *offsetms)</div><div class="ttdoc">Stream a file with fast forward, pause, reverse, restart. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l01319">main/app.c:1319</a></div></div>
<div class="ttc" id="threadstorage_8h_html"><div class="ttname"><a href="../../dc/d7d/threadstorage_8h.html">threadstorage.h</a></div><div class="ttdoc">Definitions to aid in the use of thread local storage. </div></div>
<div class="ttc" id="eagi__proxy_8c_html_a8fd806ad19b8f5513a4cf18cbf77532c"><div class="ttname"><a href="../../dd/d7c/eagi__proxy_8c.html#a8fd806ad19b8f5513a4cf18cbf77532c">end</a></div><div class="ttdeci">char * end</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d7c/eagi__proxy_8c_source.html#l00073">eagi_proxy.c:73</a></div></div>
<div class="ttc" id="structinprocess_html_aaea3b00555054087360d600593121f95"><div class="ttname"><a href="../../de/d24/structinprocess.html#aaea3b00555054087360d600593121f95">inprocess::mailbox</a></div><div class="ttdeci">char mailbox[0]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01115">app_voicemail.c:1115</a></div></div>
<div class="ttc" id="file_8h_html_adb15d6efecc1a13b8835bee6d3562ddb"><div class="ttname"><a href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a></div><div class="ttdeci">int ast_filedelete(const char *filename, const char *fmt)</div><div class="ttdoc">Deletes a file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01098">file.c:1098</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a60729729bc8dbe0d6614f14fc5229148"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a></div><div class="ttdeci">#define DISPOSE(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00868">app_voicemail.c:868</a></div></div>
<div class="ttc" id="syslog_8c_html_ac4f474c82e82cbb89ca7c36dd52be0ed"><div class="ttname"><a href="../../d4/d2f/syslog_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a></div><div class="ttdeci">int value</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d2f/syslog_8c_source.html#l00037">syslog.c:37</a></div></div>
<div class="ttc" id="cli_8h_html_a791bf9f5637185bee5e8f0907c762130"><div class="ttname"><a href="../../dc/db0/cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a></div><div class="ttdeci">void ast_cli(int fd, const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d4d/clicompat_8c_source.html#l00006">clicompat.c:6</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a239bebe1697b474e6f84945e9fb9faee"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a></div><div class="ttdeci">#define CHUNKSIZE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00509">app_voicemail.c:509</a></div></div>
<div class="ttc" id="structvm__state_html_a7b855d6690caa0e60d0320cafd38051d"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">vm_state::fn</a></div><div class="ttdeci">char fn[PATH_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00812">app_voicemail.c:812</a></div></div>
<div class="ttc" id="adsi_8h_html"><div class="ttname"><a href="../../df/de2/adsi_8h.html">adsi.h</a></div><div class="ttdoc">ADSI Support (built upon Caller*ID) </div></div>
<div class="ttc" id="app__voicemail_8c_html_ab2462cdadf665ab4acb2ec25d83caa7f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f">vm_intro_en</a></div><div class="ttdeci">static int vm_intro_en(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09607">app_voicemail.c:9607</a></div></div>
<div class="ttc" id="structvm__state_html_a544d78076d61749c3919be3bbb87ca7f"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">vm_state::curbox</a></div><div class="ttdeci">char curbox[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00807">app_voicemail.c:807</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a94ba5ab9fffe6dd755ee95db7ff2432f"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a94ba5ab9fffe6dd755ee95db7ff2432f">ast_category_destroy</a></div><div class="ttdeci">void ast_category_destroy(struct ast_category *cat)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l02847">extconf.c:2847</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00581">app_voicemail.c:581</a></div></div>
<div class="ttc" id="ast__expr2f_8c_html_a5a634cf4429798b1c921a81de8250051"><div class="ttname"><a href="../../dc/df2/ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input</a></div><div class="ttdeci">static int input(yyscan_t yyscanner)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df2/ast__expr2f_8c_source.html#l01584">ast_expr2f.c:1584</a></div></div>
<div class="ttc" id="mwi_8h_html_ab2d839cf1f63bd9a19f5d6dff8484bcf"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#ab2d839cf1f63bd9a19f5d6dff8484bcf">ast_mwi_add_observer</a></div><div class="ttdeci">int ast_mwi_add_observer(struct ast_mwi_observer *observer)</div><div class="ttdoc">Add an observer to receive MWI state related events. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00296">mwi.c:296</a></div></div>
<div class="ttc" id="logger_8h_html_a6ff63e8955665c4a58b1598f2b07c51a"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a></div><div class="ttdeci">#define LOG_DEBUG</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00241">logger.h:241</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae5fdb2a8c5cd5f9cdcee895fa7ec421b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a></div><div class="ttdeci">static int inboxcount2(const char *mailbox, int *urgentmsgs, int *newmsgs, int *oldmsgs)</div><div class="ttdoc">Check the given mailbox&amp;#39;s message count. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06154">app_voicemail.c:6154</a></div></div>
<div class="ttc" id="channel_8h_html_adcfd8d241b6de48068ead143ac29978d"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#adcfd8d241b6de48068ead143ac29978d">ast_channel_setoption</a></div><div class="ttdeci">int ast_channel_setoption(struct ast_channel *channel, int option, void *data, int datalen, int block)</div><div class="ttdoc">Sets an option on a channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l07522">channel.c:7522</a></div></div>
<div class="ttc" id="structusers_html"><div class="ttname"><a href="../../d8/d63/structusers.html">users</a></div><div class="ttdoc">list of users found in the config file </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00915">app_voicemail.c:915</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abc03cd67e3d9bff7bde30ff5877c317f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abc03cd67e3d9bff7bde30ff5877c317f">vm_msg_remove</a></div><div class="ttdeci">static int vm_msg_remove(const char *mailbox, const char *context, size_t num_msgs, const char *folder, const char *msgs[])</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16389">app_voicemail.c:16389</a></div></div>
<div class="ttc" id="test_8h_html_a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b"><div class="ttname"><a href="../../d2/ddc/test_8h.html#a0689ac4326c7a771e1b6ed1e4cde53e2a21df97525a6ac371a7fb604dfa8ea67b">TEST_INIT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00207">test.h:207</a></div></div>
<div class="ttc" id="cdr__beanstalkd_8c_html_acec9ce2df15222151ad66fcb1d74eb9f"><div class="ttname"><a href="../../d9/d47/cdr__beanstalkd_8c.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a></div><div class="ttdeci">static int priority</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d47/cdr__beanstalkd_8c_source.html#l00076">cdr_beanstalkd.c:76</a></div></div>
<div class="ttc" id="http_8c_html_af9b32121c4ad80b0887a3d73fd24de5f"><div class="ttname"><a href="../../dd/d43/http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a></div><div class="ttdeci">const char * ext</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d43/http_8c_source.html#l00147">http.c:147</a></div></div>
<div class="ttc" id="module_8h_html_ad2ca15621101154f29748cf1dac3c3cf"><div class="ttname"><a href="../../d5/d16/module_8h.html#ad2ca15621101154f29748cf1dac3c3cf">ast_unregister_application</a></div><div class="ttdeci">int ast_unregister_application(const char *app)</div><div class="ttdoc">Unregister an application. </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d16/pbx__app_8c_source.html#l00392">pbx_app.c:392</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae09deda3da40a4bf19d532dbfc02504d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae09deda3da40a4bf19d532dbfc02504d">CHECK</a></div><div class="ttdeci">#define CHECK(u, attr, value)</div></div>
<div class="ttc" id="linkedlists_8h_html_a712c04b4493919a7052399cd30ee8fb9"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a></div><div class="ttdeci">#define AST_LIST_TRAVERSE_SAFE_END</div><div class="ttdoc">Closes a safe loop traversal block. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00614">linkedlists.h:614</a></div></div>
<div class="ttc" id="structast__mwi__subscriber_html"><div class="ttname"><a href="../../de/d41/structast__mwi__subscriber.html">ast_mwi_subscriber</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00219">mwi.c:219</a></div></div>
<div class="ttc" id="chan__mgcp_8c_html_a29e973bd94bfbaf59d939bd1bc988c32"><div class="ttname"><a href="../../d0/dd6/chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a></div><div class="ttdeci">static char cid_num[AST_MAX_EXTENSION]</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd6/chan__mgcp_8c_source.html#l00164">chan_mgcp.c:164</a></div></div>
<div class="ttc" id="lock_8h_html_ae2cdf274a5da241c3ad7324d82bf6af0"><div class="ttname"><a href="../../dd/d42/lock_8h.html#ae2cdf274a5da241c3ad7324d82bf6af0">ast_cond_signal</a></div><div class="ttdeci">#define ast_cond_signal(cond)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00201">lock.h:201</a></div></div>
<div class="ttc" id="channel_8h_html_a6610c8171ced0a69738622c11736ff5e"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a></div><div class="ttdeci">int ast_channel_priority(const struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00444">channel_internal_api.c:444</a></div></div>
<div class="ttc" id="structvm__state_html_a1051ba897840656830c47c213332b1a5"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a1051ba897840656830c47c213332b1a5">vm_state::urgentmessages</a></div><div class="ttdeci">int urgentmessages</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00821">app_voicemail.c:821</a></div></div>
<div class="ttc" id="cdr__mysql_8c_html_ab4fdb206838f2974bd15fc2ca1e9d366"><div class="ttname"><a href="../../d0/d29/cdr__mysql_8c.html#ab4fdb206838f2974bd15fc2ca1e9d366">password</a></div><div class="ttdeci">static struct ast_str * password</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d29/cdr__mysql_8c_source.html#l00077">cdr_mysql.c:77</a></div></div>
<div class="ttc" id="astobj2_8h_html_ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01043">astobj2.h:1043</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a80d52a4ea102b992a471e7515e675b20"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a80d52a4ea102b992a471e7515e675b20">ast_vm_recording_data::folder</a></div><div class="ttdeci">const ast_string_field folder</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5ab1eccc691707a65a8dcf627ae9e4b9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5ab1eccc691707a65a8dcf627ae9e4b9">playmsg_app</a></div><div class="ttdeci">static char * playmsg_app</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00911">app_voicemail.c:911</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af9bb0c022848cf3af1e8e51ae3c18e06"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a></div><div class="ttdeci">static struct ast_smdi_interface * smdi_iface</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00926">app_voicemail.c:926</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a72e263d6ba290a92142dbd1a61ccc44b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a></div><div class="ttdeci">static char fromstring[100]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01020">app_voicemail.c:1020</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_ab845019b2f1bb324ff57e14192d62c39"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#ab845019b2f1bb324ff57e14192d62c39">ast_update_realtime</a></div><div class="ttdeci">int ast_update_realtime(const char *family, const char *keyfield, const char *lookup,...) attribute_sentinel</div><div class="ttdoc">Update realtime configuration. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03489">main/config.c:3489</a></div></div>
<div class="ttc" id="chan__mgcp_8c_html_a9caa677def8fa97666646d9e2e607b7c"><div class="ttname"><a href="../../d0/dd6/chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a></div><div class="ttdeci">static int transfer</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd6/chan__mgcp_8c_source.html#l00194">chan_mgcp.c:194</a></div></div>
<div class="ttc" id="logger_8h_html_ad770f83c71e237e1f64163358ce4e13d"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a></div><div class="ttdeci">#define ast_verb(level,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00463">logger.h:463</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ac0c37deb099c676114ef0032ad449375"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ac0c37deb099c676114ef0032ad449375">ast_vm_msg_play_cb</a></div><div class="ttdeci">void() ast_vm_msg_play_cb(struct ast_channel *chan, const char *playfile, int duration)</div><div class="ttdoc">Voicemail playback callback function definition. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00332">include/asterisk/app.h:332</a></div></div>
<div class="ttc" id="structast__category_html"><div class="ttname"><a href="../../d7/db2/structast__category.html">ast_category</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l00225">main/config.c:225</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a59fa4e60d6824425c6874fa59b1dd56a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a59fa4e60d6824425c6874fa59b1dd56a">vm_app_options</a></div><div class="ttdeci">static const struct ast_app_option vm_app_options[128]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00621">app_voicemail.c:621</a></div></div>
<div class="ttc" id="structast__vm__user_html_a271ab6d982a21207ef9179b4c4f9c68e"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a271ab6d982a21207ef9179b4c4f9c68e">ast_vm_user::context</a></div><div class="ttdeci">char context[MAX_VM_CONTEXT_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00756">app_voicemail.c:756</a></div></div>
<div class="ttc" id="structast__vm__user_html_aa9d4a76241ab2a75118261777526e04b"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">ast_vm_user::exit</a></div><div class="ttdeci">char exit[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00772">app_voicemail.c:772</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_afcf0f4fdfdac15cb43d5a412394689d8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8">vm_intro_no</a></div><div class="ttdeci">static int vm_intro_no(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09883">app_voicemail.c:9883</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00589">app_voicemail.c:589</a></div></div>
<div class="ttc" id="lock_8h_html_a8a3bd496edfec04a95683ace66676200"><div class="ttname"><a href="../../dd/d42/lock_8h.html#a8a3bd496edfec04a95683ace66676200">ast_atomic_fetchadd_int</a></div><div class="ttdeci">int ast_atomic_fetchadd_int(volatile int *p, int v)</div><div class="ttdoc">Atomically add v to *p and return the previous value of *p. </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00755">lock.h:755</a></div></div>
<div class="ttc" id="structast__cli__args_html_a2a7a1aa13a4f14075411123a4495593c"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">ast_cli_args::line</a></div><div class="ttdeci">const char * line</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00162">cli.h:162</a></div></div>
<div class="ttc" id="pbx_8h_html_a965977ea9a3144bc203e0ce7a64680a1"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1">ast_custom_function_unregister</a></div><div class="ttdeci">int ast_custom_function_unregister(struct ast_custom_function *acf)</div><div class="ttdoc">Unregister a custom function. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d70/pbx__functions_8c_source.html#l00273">pbx_functions.c:273</a></div></div>
<div class="ttc" id="pbx_8h_html_a93f9868530c1e8a9d9d367d1ead8782e"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e">ast_canmatch_extension</a></div><div class="ttdeci">int ast_canmatch_extension(struct ast_channel *c, const char *context, const char *exten, int priority, const char *callerid)</div><div class="ttdoc">Looks for a valid matching extension. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d94/pbx_8c_source.html#l04194">pbx.c:4194</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0f36cea1aee9178611776ab267e0b4b3"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a></div><div class="ttdeci">#define VM_SAYCID</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00550">app_voicemail.c:550</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5e4fd0e364e72e18607259fe6d1f46cd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a></div><div class="ttdeci">static void adsi_message(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07542">app_voicemail.c:7542</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53ad71de7b33aec6afd846c491112bfc98d">OPT_PWLOC_VOICEMAILCONF</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00604">app_voicemail.c:604</a></div></div>
<div class="ttc" id="adsi_8h_html_aae985f992f116d9c01a729e8f6df8717"><div class="ttname"><a href="../../df/de2/adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a></div><div class="ttdeci">#define ADSI_COMM_PAGE</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00107">adsi.h:107</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aec217dce71a357d4890727f2a1a0a271"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">get_date</a></div><div class="ttdeci">static int get_date(char *s, int len)</div><div class="ttdoc">Gets the current date and time, as formatted string. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05726">app_voicemail.c:5726</a></div></div>
<div class="ttc" id="namespacesip__to__pjsip_html_a4540ed6a1ea3b69a813ff82e0cfb7587"><div class="ttname"><a href="../../dd/d17/namespacesip__to__pjsip.html#a4540ed6a1ea3b69a813ff82e0cfb7587">sip_to_pjsip.from_mailbox</a></div><div class="ttdeci">def from_mailbox(key, val, section, pjsip, nmapped)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d6f/sip__to__pjsip_8py_source.html#l00360">sip_to_pjsip.py:360</a></div></div>
<div class="ttc" id="pbx_8h_html_a98c5425b90ec7c5e136a40f529170b1b"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b">pbx_builtin_getvar_helper</a></div><div class="ttdeci">const char * pbx_builtin_getvar_helper(struct ast_channel *chan, const char *name)</div><div class="ttdoc">Return a pointer to the value of the corresponding channel variable. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d8c/pbx__variables_8c_source.html#l01000">pbx_variables.c:1000</a></div></div>
<div class="ttc" id="structvm__state_html_acd0537438c1edeacfc47aa30399cce8f"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#acd0537438c1edeacfc47aa30399cce8f">vm_state::dh_arraysize</a></div><div class="ttdeci">int dh_arraysize</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00816">app_voicemail.c:816</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_acbe52023b82676edbbbbefefc9971c35"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acbe52023b82676edbbbbefefc9971c35">STORE</a></div><div class="ttdeci">#define STORE(a, b, c, d, e, f, g, h, i, j, k)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00869">app_voicemail.c:869</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1a4393102d360b132fa006873ad4435c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1a4393102d360b132fa006873ad4435c">vm_msg_play</a></div><div class="ttdeci">static int vm_msg_play(struct ast_channel *chan, const char *mailbox, const char *context, const char *folder, const char *msg_num, ast_vm_msg_play_cb cb)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16487">app_voicemail.c:16487</a></div></div>
<div class="ttc" id="channel_8h_html_a9238c3318ae8d3bea2cbbe1d1e459eb7"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a></div><div class="ttdeci">#define MAX_LANGUAGE</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00173">channel.h:173</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_ab99aadde533836bd12636e2d3ab3912b"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#ab99aadde533836bd12636e2d3ab3912b">ast_vm_recording_data::recording_ext</a></div><div class="ttdeci">const ast_string_field recording_ext</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="test_8h_html_aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c"><div class="ttname"><a href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8cf2ae27807baf798d726d630693cc8c">AST_TEST_NOT_RUN</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00201">test.h:201</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaea1c83faa41ab79a1342f34a3a346c1a0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00595">app_voicemail.c:595</a></div></div>
<div class="ttc" id="stringfields_8h_html"><div class="ttname"><a href="../../d1/d0f/stringfields_8h.html">stringfields.h</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad24266c6fec5b36dd7d0cb6fdbd005fa"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a></div><div class="ttdeci">#define VM_SVMAIL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00551">app_voicemail.c:551</a></div></div>
<div class="ttc" id="utils_8h_html"><div class="ttname"><a href="../../d5/d60/utils_8h.html">utils.h</a></div><div class="ttdoc">Utility functions. </div></div>
<div class="ttc" id="astmm_8h_html_ada667b6f84a08e6848cb37c5ffb94a5f"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#ada667b6f84a08e6848cb37c5ffb94a5f">ast_asprintf</a></div><div class="ttdeci">#define ast_asprintf(ret, fmt,...)</div><div class="ttdoc">A wrapper for asprintf() </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00269">astmm.h:269</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8ee3d871c12c0ea00ab335527784d1ef"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8ee3d871c12c0ea00ab335527784d1ef">load_users</a></div><div class="ttdeci">static void load_users(struct ast_config *cfg)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13660">app_voicemail.c:13660</a></div></div>
<div class="ttc" id="structleave__vm__options_html_a5125979a5deda764b319cf472c97ac81"><div class="ttname"><a href="../../dd/df7/structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">leave_vm_options::exitcontext</a></div><div class="ttdeci">char * exitcontext</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06287">app_voicemail.c:6287</a></div></div>
<div class="ttc" id="group__Group__AMI_html_gac6a9f3498f9afffecfd78c485af41556"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556">astman_get_header</a></div><div class="ttdeci">const char * astman_get_header(const struct message *m, char *var)</div><div class="ttdoc">Get header from mananger transaction. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l02820">manager.c:2820</a></div></div>
<div class="ttc" id="astobj2_8h_html_af236ed10cd1eddcbad0579ed0cf9f4c5"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#af236ed10cd1eddcbad0579ed0cf9f4c5">ao2_prnt_fn</a></div><div class="ttdeci">void() ao2_prnt_fn(void *where, const char *fmt,...)</div><div class="ttdoc">Print output. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01442">astobj2.h:1442</a></div></div>
<div class="ttc" id="lock_8h_html_ab134d98cdfe7de0f7a72b377c0765dc7"><div class="ttname"><a href="../../dd/d42/lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a></div><div class="ttdeci">pthread_cond_t ast_cond_t</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00176">lock.h:176</a></div></div>
<div class="ttc" id="strings_8h_html_a372554b7a2d69a8bd3adac5157672036"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a></div><div class="ttdeci">#define ast_strlen_zero(foo)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00052">strings.h:52</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae659b15078c3f3e9df7bb0e43a2e1541"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae659b15078c3f3e9df7bb0e43a2e1541">mbox</a></div><div class="ttdeci">static const char * mbox(struct ast_vm_user *vmu, int id)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01961">app_voicemail.c:1961</a></div></div>
<div class="ttc" id="structast__smdi__mwi__message_html_a3b3500852ae2642c562389b5a8ce9654"><div class="ttname"><a href="../../d3/d61/structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">ast_smdi_mwi_message::cause</a></div><div class="ttdeci">char cause[SMDI_MWI_FAIL_CAUSE_LEN+1]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dca/smdi_8h_source.html#l00054">smdi.h:54</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a30c75d60cfd1f61e41c7275bb30c77f6"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a30c75d60cfd1f61e41c7275bb30c77f6">ast_update2_realtime</a></div><div class="ttdeci">int ast_update2_realtime(const char *family,...) attribute_sentinel</div><div class="ttdoc">Update realtime configuration. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03525">main/config.c:3525</a></div></div>
<div class="ttc" id="structconf_html"><div class="ttname"><a href="../../d6/de8/structconf.html">conf</a></div><div class="ttdoc">All configuration options for statsd client. </div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d0c/res__statsd_8c_source.html#l00095">res_statsd.c:95</a></div></div>
<div class="ttc" id="file_8h_html_a01771a318e7adea51499040f27b4278a"><div class="ttname"><a href="../../d2/d4d/file_8h.html#a01771a318e7adea51499040f27b4278a">ast_tellstream</a></div><div class="ttdeci">off_t ast_tellstream(struct ast_filestream *fs)</div><div class="ttdoc">Tell where we are in a stream. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01048">file.c:1048</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a351a8aa4db36ca91592694f589709456"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456">invent_message</a></div><div class="ttdeci">static int invent_message(struct ast_channel *chan, char *context, char *ext, int busy, char *ecodes)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05736">app_voicemail.c:5736</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a162bd6f075a05d0c1b4e9eb2c361facd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">make_file</a></div><div class="ttdeci">static int make_file(char *dest, const int len, const char *dir, const int num)</div><div class="ttdoc">Creates a file system path expression for a folder within the voicemail data folder and the appropria...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01919">app_voicemail.c:1919</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64acc9384c009ceb460c1acdc3b680683bd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64acc9384c009ceb460c1acdc3b680683bd">FAMILY_FOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00575">app_voicemail.c:575</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab89d128ff0a8b3ceab1ec2590bb98b2f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a></div><div class="ttdeci">static char * emailbody</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01016">app_voicemail.c:1016</a></div></div>
<div class="ttc" id="structast__vm__user_html_a36b53efe60d39090f903dc286807f5a2"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a36b53efe60d39090f903dc286807f5a2">ast_vm_user::list</a></div><div class="ttdeci">struct ast_vm_user::@82 list</div></div>
<div class="ttc" id="app__voicemail_8c_html_a6e1d84c64a8c41dcd08f8fc64c280b43"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6e1d84c64a8c41dcd08f8fc64c280b43">AO2_STRING_FIELD_HASH_FN</a></div><div class="ttdeci">AO2_STRING_FIELD_HASH_FN(alias_mailbox_mapping, alias)</div></div>
<div class="ttc" id="smdi_8h_html_a6c1ad3c56eeed633ea2f8c9efabe66ba"><div class="ttname"><a href="../../dc/dca/smdi_8h.html#a6c1ad3c56eeed633ea2f8c9efabe66ba">ast_smdi_mwi_set</a></div><div class="ttdeci">int ast_smdi_mwi_set(struct ast_smdi_interface *iface, const char *mailbox)</div><div class="ttdoc">Set the MWI indicator for a mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d96/res__smdi_8c_source.html#l00309">res_smdi.c:309</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a520a3c6b7d57903d9a616051da1a019d"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a520a3c6b7d57903d9a616051da1a019d">AST_APP_OPTIONS</a></div><div class="ttdeci">#define AST_APP_OPTIONS(holder, options...)</div><div class="ttdoc">Declares an array of options for an application. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01393">include/asterisk/app.h:1393</a></div></div>
<div class="ttc" id="channel_8h_html_af0566a4937a5bb1323825e4ef89c0e5a"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#af0566a4937a5bb1323825e4ef89c0e5a">ast_channel_tech_set</a></div><div class="ttdeci">void ast_channel_tech_set(struct ast_channel *chan, const struct ast_channel_tech *value)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00773">channel_internal_api.c:773</a></div></div>
<div class="ttc" id="test__amihooks_8c_html_a5992b274cfdcacdbc1fa8347fd01ebde"><div class="ttname"><a href="../../dc/dbf/test__amihooks_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a></div><div class="ttdeci">int done</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dbf/test__amihooks_8c_source.html#l00048">test_amihooks.c:48</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af86b40ad4c23d3535cc73c85d6830bf0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af86b40ad4c23d3535cc73c85d6830bf0">ALIASES_OUTPUT_FORMAT</a></div><div class="ttdeci">#define ALIASES_OUTPUT_FORMAT</div></div>
<div class="ttc" id="dsp_8h_html_a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f"><div class="ttname"><a href="../../d3/d08/dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d08/dsp_8h_source.html#l00073">dsp.h:73</a></div></div>
<div class="ttc" id="structnumber_html"><div class="ttname"><a href="../../d6/d49/structnumber.html">number</a></div><div class="ttdoc">Number structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d55/app__followme_8c_source.html#l00154">app_followme.c:154</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa57da8ecdd64dee4836a96e86dbd7687"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa57da8ecdd64dee4836a96e86dbd7687">add_message_id</a></div><div class="ttdeci">static int add_message_id(struct ast_config *msg_cfg, char *dir, int msg, char *filename, char *id, size_t id_size, struct ast_vm_user *vmu, int folder)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12356">app_voicemail.c:12356</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab2e4a0fb446018f4903da0873fa2c531"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab2e4a0fb446018f4903da0873fa2c531">AST_TEST_DEFINE</a></div><div class="ttdeci">AST_TEST_DEFINE(test_voicemail_vmuser)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12486">app_voicemail.c:12486</a></div></div>
<div class="ttc" id="adsi_8h_html_ae5cda91c55554914c5b7af2cfddca68f"><div class="ttname"><a href="../../df/de2/adsi_8h.html#ae5cda91c55554914c5b7af2cfddca68f">ADSI_DIR_FROM_LEFT</a></div><div class="ttdeci">#define ADSI_DIR_FROM_LEFT</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00120">adsi.h:120</a></div></div>
<div class="ttc" id="localtime_8h_html"><div class="ttname"><a href="../../d5/deb/localtime_8h.html">localtime.h</a></div><div class="ttdoc">Custom localtime functions for multiple timezones. </div></div>
<div class="ttc" id="app__voicemail_8c_html_a2632e0d8df527e365b09e974e75ffbc7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a></div><div class="ttdeci">static void adsi_begin(struct ast_channel *chan, int *useadsi)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07448">app_voicemail.c:7448</a></div></div>
<div class="ttc" id="strings_8h_html_aa3341f35cedca29e60bb7f3927204283"><div class="ttname"><a href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a></div><div class="ttdeci">int ast_str_set(struct ast_str **buf, ssize_t max_len, const char *fmt,...)</div><div class="ttdoc">Set a dynamic string using variable arguments. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l01065">strings.h:1065</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aab009b1bd02c3b2580f86581c9fa2c70"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aab009b1bd02c3b2580f86581c9fa2c70">DEFAULT_LISTEN_CONTROL_PAUSE_KEY</a></div><div class="ttdeci">#define DEFAULT_LISTEN_CONTROL_PAUSE_KEY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00519">app_voicemail.c:519</a></div></div>
<div class="ttc" id="structast__party__caller_html_a8791d240f8a9c2dc271a1c8542cfe8cc"><div class="ttname"><a href="../../d4/d77/structast__party__caller.html#a8791d240f8a9c2dc271a1c8542cfe8cc">ast_party_caller::id</a></div><div class="ttdeci">struct ast_party_id id</div><div class="ttdoc">Caller party ID. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00421">channel.h:421</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a011e3f0f5cd9056764ccaba9a75cc8c5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a></div><div class="ttdeci">static char pagerfromstring[100]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01021">app_voicemail.c:1021</a></div></div>
<div class="ttc" id="structvm__state_html_aa82b0f9cb665ad5b9c2516e9850e6a6b"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">vm_state::context</a></div><div class="ttdeci">char context[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00809">app_voicemail.c:809</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a74c57b5a842dcbc15cc991a31f679a13"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a74c57b5a842dcbc15cc991a31f679a13">ast_lock_path</a></div><div class="ttdeci">enum AST_LOCK_RESULT ast_lock_path(const char *path)</div><div class="ttdoc">Lock a filesystem path. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l02457">main/app.c:2457</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6865108119ce0a659ea9e383323b2d04"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a></div><div class="ttdeci">static char * pagerbody</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01018">app_voicemail.c:1018</a></div></div>
<div class="ttc" id="logger_8h_html_ad6810d73cb786e5e74c55c8bd8688e05"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a></div><div class="ttdeci">#define AST_LOG_NOTICE</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00268">logger.h:268</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html">config.h</a></div><div class="ttdoc">Configuration File Parser. </div></div>
<div class="ttc" id="structzones_html"><div class="ttname"><a href="../../d5/dd3/structzones.html">zones</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00916">app_voicemail.c:916</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a778f09605f89f85529e369351472b174"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a778f09605f89f85529e369351472b174">vm_change_password</a></div><div class="ttdeci">static void vm_change_password(struct ast_vm_user *vmu, const char *newpassword)</div><div class="ttdoc">The handler for the change password option. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01763">app_voicemail.c:1763</a></div></div>
<div class="ttc" id="astobj2_8h_html_a4b8c1cca9dace1cf1bbadc5039f3dedf"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a4b8c1cca9dace1cf1bbadc5039f3dedf">ao2_container_unregister</a></div><div class="ttdeci">void ao2_container_unregister(const char *name)</div><div class="ttdoc">Unregister a container for CLI stats and integrity check. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d22/astobj2__container_8c_source.html#l00985">astobj2_container.c:985</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a00e09a896f748874c9efe4fd1237cb54"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a00e09a896f748874c9efe4fd1237cb54">vm_browse_messages_vi</a></div><div class="ttdeci">static int vm_browse_messages_vi(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Vietnamese syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11176">app_voicemail.c:11176</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a04ac58e561105b9614ff3539c505ba13"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a></div><div class="ttdeci">#define VM_SEARCH</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00562">app_voicemail.c:562</a></div></div>
<div class="ttc" id="chan__mgcp_8c_html_a6b49cafa2a3d359a2e865992f551874a"><div class="ttname"><a href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a></div><div class="ttdeci">static char mailbox[AST_MAX_MAILBOX_UNIQUEID]</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd6/chan__mgcp_8c_source.html#l00204">chan_mgcp.c:204</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4a157c1f8c73923881f545c532236a22"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a></div><div class="ttdeci">static int vm_intro_multilang(struct ast_channel *chan, struct vm_state *vms, const char message_gender[])</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09461">app_voicemail.c:9461</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ace2a3d783f4f79818e14265ae719f06c"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ace2a3d783f4f79818e14265ae719f06c">ast_app_inboxcount2</a></div><div class="ttdeci">int ast_app_inboxcount2(const char *mailboxes, int *urgentmsgs, int *newmsgs, int *oldmsgs)</div><div class="ttdoc">Determine number of urgent/new/old messages in a mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00692">main/app.c:692</a></div></div>
<div class="ttc" id="strings_8h_html_a3b5457e5f5679935093d94b0f788769e"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a3b5457e5f5679935093d94b0f788769e">ast_get_time_t</a></div><div class="ttdeci">int ast_get_time_t(const char *src, time_t *dst, time_t _default, int *consumed)</div><div class="ttdoc">get values from config variables. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l02198">main/utils.c:2198</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6cd879daca608982739958c9f4bb787f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a></div><div class="ttdeci">#define VM_ENVELOPE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00552">app_voicemail.c:552</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a54d82ca3eb6fd49d52dfb684e64a6c23"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a54d82ca3eb6fd49d52dfb684e64a6c23">passwordlocation</a></div><div class="ttdeci">static int passwordlocation</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00935">app_voicemail.c:935</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae6cb2a817afda0bf313344240f1eacda"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a></div><div class="ttdeci">static char exitcontext[AST_MAX_CONTEXT]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01011">app_voicemail.c:1011</a></div></div>
<div class="ttc" id="astobj2_8h_html_abdb952d2373503555d96f02f130c5770"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#abdb952d2373503555d96f02f130c5770">ao2_container_register</a></div><div class="ttdeci">int ao2_container_register(const char *name, struct ao2_container *self, ao2_prnt_obj_fn *prnt_obj)</div><div class="ttdoc">Register a container for CLI stats and integrity check. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d22/astobj2__container_8c_source.html#l00958">astobj2_container.c:958</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2012b5c7bf02359d9f3f8925adda0188"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a></div><div class="ttdeci">static int wait_file2(struct ast_channel *chan, struct vm_state *vms, char *file)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08609">app_voicemail.c:8609</a></div></div>
<div class="ttc" id="logger_8h_html_a3f248112c8d6ce7e3959aa723dade648"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a></div><div class="ttdeci">#define ast_debug(level,...)</div><div class="ttdoc">Log a DEBUG message. </div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00452">logger.h:452</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eaa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00587">app_voicemail.c:587</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea53daa71cf2e363ddf352934ca66b60ee"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea53daa71cf2e363ddf352934ca66b60ee">OPT_BEEP</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00591">app_voicemail.c:591</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8d6ccf778afc7f44f12085c8c1b64c75"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8d6ccf778afc7f44f12085c8c1b64c75">sayname_app</a></div><div class="ttdeci">static char * sayname_app</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00913">app_voicemail.c:913</a></div></div>
<div class="ttc" id="astobj2_8c_html_a96a00b3a518d7f32b6d51dc28f09bf9b"><div class="ttname"><a href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a></div><div class="ttdeci">#define ast_log</div><div class="ttdef"><b>Definition:</b> <a href="../../da/df7/astobj2_8c_source.html#l00042">astobj2.c:42</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aba5f1994c382f15d5d1e053166da0108"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108">vm_browse_messages_it</a></div><div class="ttdeci">static int vm_browse_messages_it(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Italian syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11043">app_voicemail.c:11043</a></div></div>
<div class="ttc" id="adsi_8h_html_a7fb25cc4c49eef004a59d4488fbb3b53"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a7fb25cc4c49eef004a59d4488fbb3b53">ast_adsi_set_line</a></div><div class="ttdeci">int ast_adsi_set_line(unsigned char *buf, int page, int line)</div><div class="ttdoc">Sets the current line and page. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00285">adsi.c:285</a></div></div>
<div class="ttc" id="channel_8h_html_a921a2d48faa9ed99a59d33e7aefa7888"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a921a2d48faa9ed99a59d33e7aefa7888">ast_channel_set_rawreadformat</a></div><div class="ttdeci">void ast_channel_set_rawreadformat(struct ast_channel *chan, struct ast_format *format)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00828">channel_internal_api.c:828</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aca7150caac3749421acc40d7bc3483f1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aca7150caac3749421acc40d7bc3483f1">MINPASSWORD</a></div><div class="ttdeci">#define MINPASSWORD</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00535">app_voicemail.c:535</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a17cf878dcf1769f74b1a3714b793a039"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039">inprocess_hash_fn</a></div><div class="ttdeci">static int inprocess_hash_fn(const void *obj, const int flags)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01118">app_voicemail.c:1118</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a90b1b36a3d0c11b8b335f20efe172552"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a90b1b36a3d0c11b8b335f20efe172552">vm_msg_forward</a></div><div class="ttdeci">static int vm_msg_forward(const char *from_mailbox, const char *from_context, const char *from_folder, const char *to_mailbox, const char *to_context, const char *to_folder, size_t num_msgs, const char *msg_ids[], int delete_old)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16142">app_voicemail.c:16142</a></div></div>
<div class="ttc" id="structvm__state_html_a6d81f902729a57d095fa343793596c1e"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a6d81f902729a57d095fa343793596c1e">vm_state::repeats</a></div><div class="ttdeci">int repeats</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00823">app_voicemail.c:823</a></div></div>
<div class="ttc" id="compiler_8h_html_af2af475b85aef66019c417d8ded1c435"><div class="ttname"><a href="../../d4/dd1/compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a></div><div class="ttdeci">#define SENTINEL</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dd1/compiler_8h_source.html#l00087">compiler.h:87</a></div></div>
<div class="ttc" id="structtest__files_html_a9423e07ce9563b09e3058fbd8c0e1e59"><div class="ttname"><a href="../../d9/d1d/structtest__files.html#a9423e07ce9563b09e3058fbd8c0e1e59">test_files::txtfile</a></div><div class="ttdeci">char txtfile[256]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14573">app_voicemail.c:14573</a></div></div>
<div class="ttc" id="test__message_8c_html_ab8bcb9d3707a8934e7e925895847b0f6"><div class="ttname"><a href="../../d9/d7a/test__message_8c.html#ab8bcb9d3707a8934e7e925895847b0f6">TEST_CONTEXT</a></div><div class="ttdeci">#define TEST_CONTEXT</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d7a/test__message_8c_source.html#l00046">test_message.c:46</a></div></div>
<div class="ttc" id="structtest__files_html"><div class="ttname"><a href="../../d9/d1d/structtest__files.html">test_files</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14570">app_voicemail.c:14570</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5112d228e43a8e9393b797c45eba9adb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5112d228e43a8e9393b797c45eba9adb">load_zonemessages</a></div><div class="ttdeci">static void load_zonemessages(struct ast_config *cfg)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13625">app_voicemail.c:13625</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2b120ac4209e9e13a383f706787249cf"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2b120ac4209e9e13a383f706787249cf">vm_msg_snapshot_destroy</a></div><div class="ttdeci">static struct ast_vm_msg_snapshot * vm_msg_snapshot_destroy(struct ast_vm_msg_snapshot *msg_snapshot)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15764">app_voicemail.c:15764</a></div></div>
<div class="ttc" id="structast__vm__user_html_ad4786cc0738d237b7697e5448da7d22e"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#ad4786cc0738d237b7697e5448da7d22e">ast_vm_user::locale</a></div><div class="ttdeci">char locale[20]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00768">app_voicemail.c:768</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a0a07ddd6bbcf44485e01c14c96109482"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a></div><div class="ttdeci">#define ast_config_load(filename, flags)</div><div class="ttdoc">Load a config file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00179">include/asterisk/config.h:179</a></div></div>
<div class="ttc" id="structast__vm__user_html_a83f51ce5625200c6f2a1a892d0611dc8"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">ast_vm_user::dialout</a></div><div class="ttdeci">char dialout[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00770">app_voicemail.c:770</a></div></div>
<div class="ttc" id="structast__variable_html_a8556878012feffc9e0beb86cd78f424d"><div class="ttname"><a href="../../dd/d02/structast__variable.html#a8556878012feffc9e0beb86cd78f424d">ast_variable::value</a></div><div class="ttdeci">const char * value</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00087">include/asterisk/config.h:87</a></div></div>
<div class="ttc" id="adsi_8h_html_ac1207eca69705174ac9cdcc71d49fb2f"><div class="ttname"><a href="../../df/de2/adsi_8h.html#ac1207eca69705174ac9cdcc71d49fb2f">ast_adsi_input_format</a></div><div class="ttdeci">int ast_adsi_input_format(unsigned char *buf, int num, int dir, int wrap, char *format1, char *format2)</div><div class="ttdoc">Set input format. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00329">adsi.c:329</a></div></div>
<div class="ttc" id="extconf_8c_html_ae4c618117458ec0ed99d972e34964cfb"><div class="ttname"><a href="../../d4/dc5/extconf_8c.html#ae4c618117458ec0ed99d972e34964cfb">config_filename</a></div><div class="ttdeci">static char * config_filename</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l02121">extconf.c:2121</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abd383481e08b81dcccd729b13cdf0960"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">complete_voicemail_show_users</a></div><div class="ttdeci">static char * complete_voicemail_show_users(const char *line, const char *word, int pos, int state)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12845">app_voicemail.c:12845</a></div></div>
<div class="ttc" id="logger_8h_html_a2fdd5bff193a29ec6c7278da2851ea56"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a></div><div class="ttdeci">#define AST_LOG_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00290">logger.h:290</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64ae4c30257a35e061da61e8d4e8e8f9169"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64ae4c30257a35e061da61e8d4e8e8f9169">WORK_FOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00574">app_voicemail.c:574</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab6b048d794fbfa09f0e13c6b3c0a0f31"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">vm_intro_fr</a></div><div class="ttdeci">static int vm_intro_fr(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10074">app_voicemail.c:10074</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5bba9e85c2fe23ee80a59a7a00a5c74a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a">vm_browse_messages_es</a></div><div class="ttdeci">static int vm_browse_messages_es(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Spanish syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11096">app_voicemail.c:11096</a></div></div>
<div class="ttc" id="say_8h_html_aa8c3ccdaf588396ad33b5028e79aa1c4"><div class="ttname"><a href="../../db/dce/say_8h.html#aa8c3ccdaf588396ad33b5028e79aa1c4">ast_say_counted_noun</a></div><div class="ttdeci">int ast_say_counted_noun(struct ast_channel *chan, int num, const char *noun)</div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_abbd9786e26d09dce06c32a53fd3c0cc2"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2">ast_store_realtime</a></div><div class="ttdeci">int ast_store_realtime(const char *family,...) attribute_sentinel</div><div class="ttdoc">Create realtime configuration. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03570">main/config.c:3570</a></div></div>
<div class="ttc" id="muted_8c_html_a41c3a180b50c6b2ddcc1b6843a48f205"><div class="ttname"><a href="../../d0/d8a/muted_8c.html#a41c3a180b50c6b2ddcc1b6843a48f205">host</a></div><div class="ttdeci">static char host[256]</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d8a/muted_8c_source.html#l00077">muted.c:77</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6a1f2d69e0b6037e9ecd403ec97c0867"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6a1f2d69e0b6037e9ecd403ec97c0867">vmsayname_exec</a></div><div class="ttdeci">static int vmsayname_exec(struct ast_channel *chan, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14446">app_voicemail.c:14446</a></div></div>
<div class="ttc" id="strings_8h_html_a603020160399d4876ec09fd299ebcaf9"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a603020160399d4876ec09fd299ebcaf9">ast_build_string</a></div><div class="ttdeci">int ast_build_string(char **buffer, size_t *space, const char *fmt,...)</div><div class="ttdoc">Build a string in a buffer, designed to be called repeatedly. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l01919">main/utils.c:1919</a></div></div>
<div class="ttc" id="callerid_8h_html_a1c25633b1ed63682c95ec613d7cbe559"><div class="ttname"><a href="../../de/d47/callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a></div><div class="ttdeci">char * ast_callerid_merge(char *buf, int bufsiz, const char *name, const char *num, const char *unknown)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dd5/callerid_8c_source.html#l01073">callerid.c:1073</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6e31d0ed0d32a0655e13233ddf82bf43"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a></div><div class="ttdeci">#define MAXMSG</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00532">app_voicemail.c:532</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5ff423fdf598de1c23b18626a2b20c3c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">strip_control_and_high</a></div><div class="ttdeci">static char * strip_control_and_high(const char *input, char *buf, size_t buflen)</div><div class="ttdoc">Strips control and non 7-bit clean characters from input string. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01175">app_voicemail.c:1175</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a29e2f9d32a5e270df22ec41e8def7fab"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a29e2f9d32a5e270df22ec41e8def7fab">ast_vm_recording_data::call_macrocontext</a></div><div class="ttdeci">const ast_string_field call_macrocontext</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7cb6e4d2a6cf5eccead170cac7517d8c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a></div><div class="ttdeci">static int play_message(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08843">app_voicemail.c:8843</a></div></div>
<div class="ttc" id="channel_8h_html"><div class="ttname"><a href="../../d5/d7b/channel_8h.html">channel.h</a></div><div class="ttdoc">General Asterisk PBX channel definitions. </div></div>
<div class="ttc" id="structast__vm__user_html_ab46529fc3aca41f01be29d17fdcb2301"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">ast_vm_user::maxdeletedmsg</a></div><div class="ttdeci">int maxdeletedmsg</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00778">app_voicemail.c:778</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a403ec8b49645ea204e82cb72bb8cf9f4"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4">ast_realtime_require_field</a></div><div class="ttdeci">int ast_realtime_require_field(const char *family,...) attribute_sentinel</div><div class="ttdoc">Inform realtime what fields that may be stored. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03382">main/config.c:3382</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a695d5aca89839d016497739454f9779a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a></div><div class="ttdeci">static char dialcontext[AST_MAX_CONTEXT]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01009">app_voicemail.c:1009</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a95c962cfd04d0ad8f41215c1ece03e52"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a></div><div class="ttdeci">#define VM_FORCENAME</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00555">app_voicemail.c:555</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab59ca309f2489a3919dd084022d386d7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a></div><div class="ttdeci">#define VM_DELETE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00560">app_voicemail.c:560</a></div></div>
<div class="ttc" id="paths_8h_html"><div class="ttname"><a href="../../dd/df2/paths_8h.html">paths.h</a></div><div class="ttdoc">Asterisk file paths, configured in asterisk.conf. </div></div>
<div class="ttc" id="structalias__mailbox__mapping_html_a9027b352db4085a0122952932d065705"><div class="ttname"><a href="../../de/d16/structalias__mailbox__mapping.html#a9027b352db4085a0122952932d065705">alias_mailbox_mapping::alias</a></div><div class="ttdeci">char * alias</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00955">app_voicemail.c:955</a></div></div>
<div class="ttc" id="group__Group__AMI_html_gabf7c909efbfc26d0d9c66786c83b8f69"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#gabf7c909efbfc26d0d9c66786c83b8f69">astman_send_list_complete_end</a></div><div class="ttdeci">void astman_send_list_complete_end(struct mansession *s)</div><div class="ttdoc">End the list complete event. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l03245">manager.c:3245</a></div></div>
<div class="ttc" id="structodbc__obj_html"><div class="ttname"><a href="../../df/d36/structodbc__obj.html">odbc_obj</a></div><div class="ttdoc">ODBC container. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d96/res__odbc_8h_source.html#l00046">res_odbc.h:46</a></div></div>
<div class="ttc" id="func__strings_8c_html_ab8fe909862ff885d9e233ff9ad5e54dd"><div class="ttname"><a href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a></div><div class="ttdeci">static int quote(struct ast_channel *chan, const char *cmd, char *data, char *buf, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d1e/func__strings_8c_source.html#l01270">func_strings.c:1270</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aed86dceeb81c5f7d7d9ed8435651d0b1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aed86dceeb81c5f7d7d9ed8435651d0b1">mailbox_folders</a></div><div class="ttdeci">static const char *const mailbox_folders[]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00623">app_voicemail.c:623</a></div></div>
<div class="ttc" id="utils_8h_html_a1604b4d72144dd3d9f7da668e90337e9"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a></div><div class="ttdeci">#define RAII_VAR(vartype, varname, initval, dtor)</div><div class="ttdoc">Declare a variable that will call a destructor function when it goes out of scope. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00911">utils.h:911</a></div></div>
<div class="ttc" id="test_8h_html_a5e8fddded61f6989172c981256e7c9bd"><div class="ttname"><a href="../../d2/ddc/test_8h.html#a5e8fddded61f6989172c981256e7c9bd">ast_test_status_update</a></div><div class="ttdeci">#define ast_test_status_update(a, b, c...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00129">test.h:129</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a62e6fabd28e7d7a9941945c7fde3bda6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a></div><div class="ttdeci">#define VOICEMAIL_CONFIG</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00511">app_voicemail.c:511</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af29953afabaf5ed5338cb9a783599366"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af29953afabaf5ed5338cb9a783599366">vmauthenticate_app</a></div><div class="ttdeci">static char * vmauthenticate_app</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00909">app_voicemail.c:909</a></div></div>
<div class="ttc" id="structast__cli__args_html_acf64f219885421479997667d2ed3f08a"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#acf64f219885421479997667d2ed3f08a">ast_cli_args::fd</a></div><div class="ttdeci">const int fd</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00159">cli.h:159</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a31a8413227dec93cd93ebd54bc3b42c7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a31a8413227dec93cd93ebd54bc3b42c7">vm_execmain</a></div><div class="ttdeci">static int vm_execmain(struct ast_channel *chan, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11503">app_voicemail.c:11503</a></div></div>
<div class="ttc" id="channel_8h_html_a3c9c29fb2bc2b715fee335c1ffa50449"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a3c9c29fb2bc2b715fee335c1ffa50449">ast_channel_nativeformats_set</a></div><div class="ttdeci">void ast_channel_nativeformats_set(struct ast_channel *chan, struct ast_format_cap *value)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00677">channel_internal_api.c:677</a></div></div>
<div class="ttc" id="stringfields_8h_html_a871274fa4fd2687c7a44849a84df3665"><div class="ttname"><a href="../../d1/d0f/stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665">ast_string_field_init</a></div><div class="ttdeci">#define ast_string_field_init(x, size)</div><div class="ttdoc">Initialize a field pool and fields. </div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d0f/stringfields_8h_source.html#l00353">stringfields.h:353</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3888fe259904a2eb18b173cbf56bfa86"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a></div><div class="ttdeci">static struct ast_flags globalflags</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01005">app_voicemail.c:1005</a></div></div>
<div class="ttc" id="structast__vm__user_html_a4a081db7653645ce9fce8fd72e5a7bf1"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">ast_vm_user::zonetag</a></div><div class="ttdeci">char zonetag[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00767">app_voicemail.c:767</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5cd430011b0b3e307a37b2068dfd17f0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5cd430011b0b3e307a37b2068dfd17f0">notify_new_state</a></div><div class="ttdeci">static void notify_new_state(struct ast_vm_user *vmu)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16131">app_voicemail.c:16131</a></div></div>
<div class="ttc" id="structvm__state_html_add5b5c3d8e5133fbf295a7d302b7f300"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">vm_state::heard</a></div><div class="ttdeci">int * heard</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00815">app_voicemail.c:815</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a45a741eda0606c72d39d65668ef7d64c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c">change_password_realtime</a></div><div class="ttdeci">static int change_password_realtime(struct ast_vm_user *vmu, const char *password)</div><div class="ttdoc">Performs a change of the voicemail passowrd in the realtime engine. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01485">app_voicemail.c:1485</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7decd8d5e42401e22d0d86d150e70a04"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7decd8d5e42401e22d0d86d150e70a04">DEFAULT_LISTEN_CONTROL_STOP_KEY</a></div><div class="ttdeci">#define DEFAULT_LISTEN_CONTROL_STOP_KEY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00521">app_voicemail.c:521</a></div></div>
<div class="ttc" id="lock_8h_html_a6009440c7a72f8e2e3b1ec97641ad160"><div class="ttname"><a href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a></div><div class="ttdeci">#define AST_PTHREADT_NULL</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00066">lock.h:66</a></div></div>
<div class="ttc" id="structast__cli__args_html_acfc02ec89670db29251fda6a66602ce2"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#acfc02ec89670db29251fda6a66602ce2">ast_cli_args::n</a></div><div class="ttdeci">const int n</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00165">cli.h:165</a></div></div>
<div class="ttc" id="structast__vm__mailbox__snapshot_html_a600bfb84722ece9ee0e2c0eb459dd5ec"><div class="ttname"><a href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a600bfb84722ece9ee0e2c0eb459dd5ec">ast_vm_mailbox_snapshot::folders</a></div><div class="ttdeci">int folders</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00319">include/asterisk/app.h:319</a></div></div>
<div class="ttc" id="channel_8h_html_acc0ae2c008f4157736ef290e9ca62572"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#acc0ae2c008f4157736ef290e9ca62572">ast_dummy_channel_alloc</a></div><div class="ttdeci">#define ast_dummy_channel_alloc()</div><div class="ttdoc">Create a fake channel structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l01283">channel.h:1283</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00583">app_voicemail.c:583</a></div></div>
<div class="ttc" id="app__meetme_8c_html_ae9dd6bdb4c5c0529195a03583d0d4a8d"><div class="ttname"><a href="../../df/d44/app__meetme_8c.html#ae9dd6bdb4c5c0529195a03583d0d4a8d">last</a></div><div class="ttdeci">struct sla_ringing_trunk * last</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d44/app__meetme_8c_source.html#l01092">app_meetme.c:1092</a></div></div>
<div class="ttc" id="structast__custom__function_html"><div class="ttname"><a href="../../db/dc0/structast__custom__function.html">ast_custom_function</a></div><div class="ttdoc">Data structure associated with a custom dialplan function. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/de0/pbx_8h_source.html#l00118">pbx.h:118</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2df9fff4e7799595bf0571bcc81de9f3"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3">vm_browse_messages_zh</a></div><div class="ttdeci">static int vm_browse_messages_zh(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Chinese (Taiwan)syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11148">app_voicemail.c:11148</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3dd583755e5b2238016cdeb757a4ef0a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a">play_message_duration</a></div><div class="ttdeci">static int play_message_duration(struct ast_channel *chan, struct vm_state *vms, const char *duration, int minduration)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08793">app_voicemail.c:8793</a></div></div>
<div class="ttc" id="astobj2_8h_html"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html">astobj2.h</a></div></div>
<div class="ttc" id="app__meetme_8c_html_adf04f66344e3fb0a6f6a69bf39d19902"><div class="ttname"><a href="../../df/d44/app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a></div><div class="ttdeci">ast_mutex_t lock</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d44/app__meetme_8c_source.html#l01091">app_meetme.c:1091</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00585">app_voicemail.c:585</a></div></div>
<div class="ttc" id="structast__vm__msg__snapshot_html"><div class="ttname"><a href="../../dc/d95/structast__vm__msg__snapshot.html">ast_vm_msg_snapshot</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00300">include/asterisk/app.h:300</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abebd9f51e7ff2f4d68f3952210219b4e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a></div><div class="ttdeci">static int silencethreshold</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00922">app_voicemail.c:922</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3643ef3067a8048f7a36abee577fdfe9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">mb_poll_thread</a></div><div class="ttdeci">static void * mb_poll_thread(void *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13074">app_voicemail.c:13074</a></div></div>
<div class="ttc" id="channel_8h_html_af4e59494f74ad9e0c50170d9e276ad31"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a></div><div class="ttdeci">#define AST_MAX_EXTENSION</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00135">channel.h:135</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8c42b12ed750504118fedbddad35935f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8c42b12ed750504118fedbddad35935f">prep_email_sub_vars</a></div><div class="ttdeci">static void prep_email_sub_vars(struct ast_channel *ast, struct ast_vm_user *vmu, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, char *dur, char *date, const char *category, const char *flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04895">app_voicemail.c:4895</a></div></div>
<div class="ttc" id="structast__vm__user_html_a54d82ca3eb6fd49d52dfb684e64a6c23"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a54d82ca3eb6fd49d52dfb684e64a6c23">ast_vm_user::passwordlocation</a></div><div class="ttdeci">int passwordlocation</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00780">app_voicemail.c:780</a></div></div>
<div class="ttc" id="structast__vm__user_html_a92c95d4eb5c3e28079cff9abe1816423"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">ast_vm_user::saydurationm</a></div><div class="ttdeci">int saydurationm</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00775">app_voicemail.c:775</a></div></div>
<div class="ttc" id="structast__party__caller_html"><div class="ttname"><a href="../../d4/d77/structast__party__caller.html">ast_party_caller</a></div><div class="ttdoc">Caller Party information. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00419">channel.h:419</a></div></div>
<div class="ttc" id="linkedlists_8h_html_aa8ac496fa9c717d5afb99a02e1e2760c"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c">AST_LIST_REMOVE_CURRENT</a></div><div class="ttdeci">#define AST_LIST_REMOVE_CURRENT(field)</div><div class="ttdoc">Removes the current entry from a list during a traversal. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00556">linkedlists.h:556</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8385f761f8389d40838c0ce72226d8a7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a></div><div class="ttdeci">static char vm_reenterpassword[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00988">app_voicemail.c:988</a></div></div>
<div class="ttc" id="structextension_html"><div class="ttname"><a href="../../d0/d5a/structextension.html">extension</a></div><div class="ttdoc">structure to hold extensions </div><div class="ttdef"><b>Definition:</b> <a href="../../d9/de9/res__phoneprov_8c_source.html#l00287">res_phoneprov.c:287</a></div></div>
<div class="ttc" id="format__cache_8h_html_a3c4c5f669f55befda69aa08699545ec7"><div class="ttname"><a href="../../db/d1c/format__cache_8h.html#a3c4c5f669f55befda69aa08699545ec7">ast_format_gsm</a></div><div class="ttdeci">struct ast_format * ast_format_gsm</div><div class="ttdoc">Built-in cached gsm format. </div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d29/format__cache_8c_source.html#l00101">format_cache.c:101</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae27e109c42f23e01c83b3f39a99acd01"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a></div><div class="ttdeci">static int my_umask</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00883">app_voicemail.c:883</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_abbbec6ab9a303e865a1d1a261152540d"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a></div><div class="ttdeci">int ast_play_and_wait(struct ast_channel *chan, const char *fn)</div><div class="ttdoc">Play a stream and wait for a digit, returning the digit that was pressed. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l01470">main/app.c:1470</a></div></div>
<div class="ttc" id="astobj2_8h_html_aaca5e8eac39a22f9da1c36fc6c922270"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a></div><div class="ttdeci">#define ao2_ref(o, delta)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l00464">astobj2.h:464</a></div></div>
<div class="ttc" id="channel_8h_html_ab3786cbbff7a03241fc75dafa0c8a1c1"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#ab3786cbbff7a03241fc75dafa0c8a1c1">ast_channel_set_readformat</a></div><div class="ttdeci">void ast_channel_set_readformat(struct ast_channel *chan, struct ast_format *format)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00836">channel_internal_api.c:836</a></div></div>
<div class="ttc" id="astobj2_8h_html_a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01031">astobj2.h:1031</a></div></div>
<div class="ttc" id="strings_8h_html_a38a896048b2ca84076864505f0aa8f01"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a></div><div class="ttdeci">#define S_COR(a, b, c)</div><div class="ttdoc">returns the equivalent of logic or for strings, with an additional boolean check: second one if not e...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00085">strings.h:85</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a13a3ff0da2d7d40198b3eafbde0464a0"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a13a3ff0da2d7d40198b3eafbde0464a0">ast_play_and_record_full</a></div><div class="ttdeci">int ast_play_and_record_full(struct ast_channel *chan, const char *playfile, const char *recordfile, int maxtime_sec, const char *fmt, int *duration, int *sound_duration, int beep, int silencethreshold, int maxsilence_ms, const char *path, const char *acceptdtmf, const char *canceldtmf, int skip_confirmation_sound, enum ast_record_if_exists if_exists)</div><div class="ttdoc">Record a file based on input from a channel This function will play &quot;auth-thankyou&quot; upon successful r...</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l01992">main/app.c:1992</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a6b4d4d929013de7812fbba4e58353078"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a6b4d4d929013de7812fbba4e58353078">ast_config_destroy</a></div><div class="ttdeci">void ast_config_destroy(struct ast_config *config)</div><div class="ttdoc">Destroys a config. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l01290">extconf.c:1290</a></div></div>
<div class="ttc" id="structmansession_html"><div class="ttname"><a href="../../d2/d8a/structmansession.html">mansession</a></div><div class="ttdoc">In case you didn&amp;#39;t read that giant block of text above the mansession_session struct, the struct mansession is named this solely to keep the API the same in Asterisk. This structure really represents data that is different from Manager action to Manager action. The mansession_session pointer contained within points to session-specific data. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l01625">manager.c:1625</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a846b39f5cdf1508035ac658f26a5e933"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a846b39f5cdf1508035ac658f26a5e933">VM_MODULE_VERSION</a></div><div class="ttdeci">#define VM_MODULE_VERSION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00536">include/asterisk/app.h:536</a></div></div>
<div class="ttc" id="utils_8h_html_a7b4f10b070e95ba413e258a3e4b03c20"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a></div><div class="ttdeci">long int ast_random(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l02064">main/utils.c:2064</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7a373c1fb8aaab7b824683b13836068e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a></div><div class="ttdeci">static char cidinternalcontexts[MAX_NUM_CID_CONTEXTS][64]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01013">app_voicemail.c:1013</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a24e0f9feb18b6b7cc2bdcf0cabcab0a2"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2">free_zone</a></div><div class="ttdeci">static void free_zone(struct vm_zone *z)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05770">app_voicemail.c:5770</a></div></div>
<div class="ttc" id="astobj2_8h_html_aa9fdb5d0a6157a56060d9f7279fe6c49"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#aa9fdb5d0a6157a56060d9f7279fe6c49">ao2_lock</a></div><div class="ttdeci">#define ao2_lock(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l00718">astobj2.h:718</a></div></div>
<div class="ttc" id="group__StasisTopicsAndMessages_html_ga4369ae7c984aba22ce6d0e92718f2b29"><div class="ttname"><a href="../../df/deb/group__StasisTopicsAndMessages.html#ga4369ae7c984aba22ce6d0e92718f2b29">ast_mwi_state::old_msgs</a></div><div class="ttdeci">int old_msgs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00462">mwi.h:462</a></div></div>
<div class="ttc" id="time_8h_html_a1d774df72e3dbb623475783e06ce4f61"><div class="ttname"><a href="../../de/df7/time_8h.html#a1d774df72e3dbb623475783e06ce4f61">ast_samp2tv</a></div><div class="ttdeci">struct timeval ast_samp2tv(unsigned int _nsamp, unsigned int _rate)</div><div class="ttdoc">Returns a timeval corresponding to the duration of n samples at rate r. Useful to convert samples to ...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/df7/time_8h_source.html#l00238">time.h:238</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af54b6b5388c2838875f222a795850409"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af54b6b5388c2838875f222a795850409">vm_intro_se</a></div><div class="ttdeci">static int vm_intro_se(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09839">app_voicemail.c:9839</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a86e0b87be99e44b8431556b58fef88bc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc">check_password</a></div><div class="ttdeci">static int check_password(struct ast_vm_user *vmu, char *password)</div><div class="ttdoc">Check that password meets minimum required length. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01444">app_voicemail.c:1444</a></div></div>
<div class="ttc" id="astmm_8h_html_ab5f0750cc80ba337fdcbddea2d3a1ee6"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a></div><div class="ttdeci">#define ast_strdupa(s)</div><div class="ttdoc">duplicate a string in memory from the stack </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00300">astmm.h:300</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a384e77a1425177695933124d3643770e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a384e77a1425177695933124d3643770e">generate_msg_id</a></div><div class="ttdeci">static void generate_msg_id(char *dst)</div><div class="ttdoc">Sets the destination string to a uniquely identifying msg_id string. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06291">app_voicemail.c:6291</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa219febcd18002914767729f33e94f13"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a></div><div class="ttdeci">#define VM_MOVEHEARD</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00564">app_voicemail.c:564</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_addcd618c70c26637518d590003c700c2"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#addcd618c70c26637518d590003c700c2">addesc</a></div><div class="ttdeci">static char * addesc</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00901">app_voicemail.c:901</a></div></div>
<div class="ttc" id="structast__vm__msg__snapshot_html_a1eb8e3f5b54979ef94248fa4f7bd3104"><div class="ttname"><a href="../../dc/d95/structast__vm__msg__snapshot.html#a1eb8e3f5b54979ef94248fa4f7bd3104">ast_vm_msg_snapshot::origtime</a></div><div class="ttdeci">const ast_string_field origtime</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00311">include/asterisk/app.h:311</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2724cf00d9e64469d126a23ff80770c7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a></div><div class="ttdeci">static int say_and_wait(struct ast_channel *chan, int num, const char *language)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07207">app_voicemail.c:7207</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6039669cd57ff47a2df5e25685b660c4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6039669cd57ff47a2df5e25685b660c4">vm_index_to_foldername</a></div><div class="ttdeci">static const char * vm_index_to_foldername(int id)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01971">app_voicemail.c:1971</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad68d3cb9e27c8e0a284474dbab59f7b4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad68d3cb9e27c8e0a284474dbab59f7b4">queue_mwi_event</a></div><div class="ttdeci">static void queue_mwi_event(const char *channel_id, const char *box, int urgent, int new, int old)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08110">app_voicemail.c:8110</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5095feba60bfdcc711f49a0ad2e27985"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">COPY</a></div><div class="ttdeci">#define COPY(a, b, c, d, e, f, g, h)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00872">app_voicemail.c:872</a></div></div>
<div class="ttc" id="structbaseio_html_aaa24cfd3a54978c05a8d852aa7e77ec5"><div class="ttname"><a href="../../d5/d11/structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">baseio::iocp</a></div><div class="ttdeci">int iocp</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00741">app_voicemail.c:741</a></div></div>
<div class="ttc" id="format__cap_8h_html_ab4d69f2179ed5ca138c9b3d85334217f"><div class="ttname"><a href="../../d0/d3c/format__cap_8h.html#ab4d69f2179ed5ca138c9b3d85334217f">ast_format_cap_append</a></div><div class="ttdeci">#define ast_format_cap_append(cap, format, framing)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d3c/format__cap_8h_source.html#l00103">format_cap.h:103</a></div></div>
<div class="ttc" id="structast__vm__user_html"><div class="ttname"><a href="../../da/df6/structast__vm__user.html">ast_vm_user</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00755">app_voicemail.c:755</a></div></div>
<div class="ttc" id="chan__alsa_8c_html_adf416dc058363e2fd5750c77e2d78bee"><div class="ttname"><a href="../../da/d45/chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a></div><div class="ttdeci">static char language[MAX_LANGUAGE]</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d45/chan__alsa_8c_source.html#l00117">chan_alsa.c:117</a></div></div>
<div class="ttc" id="adsi_8h_html_a093a3e70337056f4bb6a2b965127cb34"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a093a3e70337056f4bb6a2b965127cb34">ast_adsi_display</a></div><div class="ttdeci">int ast_adsi_display(unsigned char *buf, int page, int line, int just, int wrap, char *col1, char *col2)</div><div class="ttdoc">Loads a line of info into the display. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00274">adsi.c:274</a></div></div>
<div class="ttc" id="structbaseio_html_aa3cbb055ee45b46498457488c3df39d8"><div class="ttname"><a href="../../d5/d11/structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">baseio::ateof</a></div><div class="ttdeci">int ateof</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00744">app_voicemail.c:744</a></div></div>
<div class="ttc" id="structast__variable_html_a8f8f80d37794cde9472343e4487ba3eb"><div class="ttname"><a href="../../dd/d02/structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">ast_variable::name</a></div><div class="ttdeci">const char * name</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00085">include/asterisk/config.h:85</a></div></div>
<div class="ttc" id="localtime_8h_html_ad5092e0e84f5959f275d6de28438250e"><div class="ttname"><a href="../../d5/deb/localtime_8h.html#ad5092e0e84f5959f275d6de28438250e">ast_strftime_locale</a></div><div class="ttdeci">int ast_strftime_locale(char *buf, size_t len, const char *format, const struct ast_tm *tm, const char *locale)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df8/localtime_8c_source.html#l02452">localtime.c:2452</a></div></div>
<div class="ttc" id="file_8h_html_aa526fd9bb57d7d9afac2113c30d236f8"><div class="ttname"><a href="../../d2/d4d/file_8h.html#aa526fd9bb57d7d9afac2113c30d236f8">ast_format_str_reduce</a></div><div class="ttdeci">char * ast_format_str_reduce(char *fmts)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01826">file.c:1826</a></div></div>
<div class="ttc" id="astmm_8h_html_ae63d4f486bcf6eac7c1593f867717d91"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a></div><div class="ttdeci">#define ast_malloc(len)</div><div class="ttdoc">A wrapper for malloc() </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00193">astmm.h:193</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad952a8efdeb4f2381c3d19d6e33e836"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a></div><div class="ttdeci">static int vm_authenticate(struct ast_channel *chan, char *mailbox, int mailbox_size, struct ast_vm_user *res_vmu, const char *context, const char *prefix, int skipuser, int max_logins, int silent)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11226">app_voicemail.c:11226</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4a081db7653645ce9fce8fd72e5a7bf1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a></div><div class="ttdeci">static char zonetag[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00917">app_voicemail.c:917</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a41d71eac4fa56d2c05f51e77c9391f3f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a41d71eac4fa56d2c05f51e77c9391f3f">poll_lock</a></div><div class="ttdeci">static ast_mutex_t poll_lock</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00947">app_voicemail.c:947</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a90dc3f3ee970394e0080300526390a84"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a></div><div class="ttdeci">#define ENDL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00542">app_voicemail.c:542</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa3e1184e10a123c4ed53c5918da34258"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa3e1184e10a123c4ed53c5918da34258">ast_str_quote</a></div><div class="ttdeci">static const char * ast_str_quote(struct ast_str **buf, ssize_t maxlen, const char *from)</div><div class="ttdoc">Wraps a character sequence in double quotes, escaping occurences of quotes within the string...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04957">app_voicemail.c:4957</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a845ca9725fdfa35cf3b3b6a7087b5921"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">advanced_options</a></div><div class="ttdeci">static int advanced_options(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int msg, int option, signed char record_gain)</div><div class="ttdoc">The advanced options within a message. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15305">app_voicemail.c:15305</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6f612696ee3ef9e74363b000efc92122"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a></div><div class="ttdeci">#define DELETE(a, b, c, d)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00873">app_voicemail.c:873</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a66581086d34dfe7ea86b0644bacef239"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a66581086d34dfe7ea86b0644bacef239">ast_variable_new</a></div><div class="ttdeci">#define ast_variable_new(name, value, filename)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00914">include/asterisk/config.h:914</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a616064b374d2f44d6fdab04f8509b138"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a616064b374d2f44d6fdab04f8509b138">write_password_to_file</a></div><div class="ttdeci">static int write_password_to_file(const char *secretfn, const char *password)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14413">app_voicemail.c:14413</a></div></div>
<div class="ttc" id="linkedlists_8h_html_aadfe2a69fbba4f27c201266a2ca5f989"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989">AST_LIST_REMOVE_HEAD</a></div><div class="ttdeci">#define AST_LIST_REMOVE_HEAD(head, field)</div><div class="ttdoc">Removes and returns the head entry from a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00832">linkedlists.h:832</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a97d0f923218857a92e83d94dcbfe0263"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a></div><div class="ttdeci">static double volgain</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00928">app_voicemail.c:928</a></div></div>
<div class="ttc" id="astobj2_8h_html_a2cf7e3433f08351aafe3b0cd31edf7f8a8ccf751bd6749d062999469f0694e7ad"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a8ccf751bd6749d062999469f0694e7ad">AO2_ALLOC_OPT_LOCK_MUTEX</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l00365">astobj2.h:365</a></div></div>
<div class="ttc" id="res__odbc_8h_html"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html">res_odbc.h</a></div><div class="ttdoc">ODBC resource manager. </div></div>
<div class="ttc" id="app__voicemail_8c_html_ab3318a367b69390dc5682a5f5e4b2999"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a></div><div class="ttdeci">static char VM_SPOOL_DIR[PATH_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00878">app_voicemail.c:878</a></div></div>
<div class="ttc" id="say_8h_html_a65e01efc9619fe3156d3f04068f99612"><div class="ttname"><a href="../../db/dce/say_8h.html#a65e01efc9619fe3156d3f04068f99612">ast_say_character_str</a></div><div class="ttdeci">int ast_say_character_str(struct ast_channel *chan, const char *num, const char *ints, const char *lang, enum ast_say_case_sensitivity sensitivity)</div><div class="ttdoc">function to pronounce character and phonetic strings </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l08367">channel.c:8367</a></div></div>
<div class="ttc" id="pbx_8h_html_a64a5b8fdc919806135ad427aca9e71b7"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a></div><div class="ttdeci">int ast_exists_extension(struct ast_channel *c, const char *context, const char *exten, int priority, const char *callerid)</div><div class="ttdoc">Determine whether an extension exists. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d94/pbx_8c_source.html#l04179">pbx.c:4179</a></div></div>
<div class="ttc" id="structvm__zone_html_a3777dbae63a15da001b2baa317a25149"><div class="ttname"><a href="../../d7/d13/structvm__zone.html#a3777dbae63a15da001b2baa317a25149">vm_zone::name</a></div><div class="ttdeci">char name[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00798">app_voicemail.c:798</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a14e2e330719d3180d96608a3b4aad429"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">last_message_index</a></div><div class="ttdeci">static int last_message_index(struct ast_vm_user *vmu, char *dir)</div><div class="ttdoc">Determines the highest message number in use for a given user and mailbox folder. ...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04578">app_voicemail.c:4578</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a32180eaceaf227ae3a255af5af2fa617"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a></div><div class="ttdeci">static void free_user(struct ast_vm_user *vmu)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01990">app_voicemail.c:1990</a></div></div>
<div class="ttc" id="format__cap_8h_html_aeb38ee3bdc8594745a707c0927146fdb"><div class="ttname"><a href="../../d0/d3c/format__cap_8h.html#aeb38ee3bdc8594745a707c0927146fdb">ast_format_cap_alloc</a></div><div class="ttdeci">#define ast_format_cap_alloc(flags)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d3c/format__cap_8h_source.html#l00052">format_cap.h:52</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_af40039f1c49c16d0f6fa33fe9c43a0cb"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb">ast_app_parse_options</a></div><div class="ttdeci">int ast_app_parse_options(const struct ast_app_option *options, struct ast_flags *flags, char **args, char *optstr)</div><div class="ttdoc">Parses a string containing application options and sets flags/arguments. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l02906">main/app.c:2906</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1efddf47b6f25c6e1b97e064e35c214e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e">vm_delete</a></div><div class="ttdeci">static int vm_delete(char *file)</div><div class="ttdoc">Removes the voicemail sound and information file. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04749">app_voicemail.c:4749</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a3aac6b809a257df6ea7c3d2a9d22b9f5"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a3aac6b809a257df6ea7c3d2a9d22b9f5">ast_config_new</a></div><div class="ttdeci">struct ast_config * ast_config_new(void)</div><div class="ttdoc">Create a new base configuration structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l03276">extconf.c:3276</a></div></div>
<div class="ttc" id="file_8h_html_ab4afbcd56a1aaf40eca3827e6d890372"><div class="ttname"><a href="../../d2/d4d/file_8h.html#ab4afbcd56a1aaf40eca3827e6d890372">ast_ratestream</a></div><div class="ttdeci">int ast_ratestream(struct ast_filestream *fs)</div><div class="ttdoc">Return the sample rate of the stream&amp;#39;s format. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01053">file.c:1053</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a73461ccedc28b990ab321ae8dae2e03b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a></div><div class="ttdeci">#define PWDCHANGE_INTERNAL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00885">app_voicemail.c:885</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a619a7ea83321438951dfe56b325c151a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a></div><div class="ttdeci">static int wait_file(struct ast_channel *chan, struct vm_state *vms, char *file)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08617">app_voicemail.c:8617</a></div></div>
<div class="ttc" id="structast__channel__tech_html"><div class="ttname"><a href="../../d4/d85/structast__channel__tech.html">ast_channel_tech</a></div><div class="ttdoc">Structure to describe a channel &quot;technology&quot;, ie a channel driver See for examples: ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00629">channel.h:629</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9f87d8b8ba9bcabcf8afeeec984731b2"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">apply_options</a></div><div class="ttdeci">static void apply_options(struct ast_vm_user *vmu, const char *options)</div><div class="ttdoc">Destructively Parse options and apply. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01507">app_voicemail.c:1507</a></div></div>
<div class="ttc" id="channel_8h_html_aa8b52fbc8168e939bc5553502367d46a"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a></div><div class="ttdeci">const char * ast_channel_exten(const struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00353">channel_internal_api.c:353</a></div></div>
<div class="ttc" id="pbx_8h_html"><div class="ttname"><a href="../../db/de0/pbx_8h.html">pbx.h</a></div><div class="ttdoc">Core PBX routines and definitions. </div></div>
<div class="ttc" id="app__voicemail_8c_html_a584c1c11a6620ca0ee6d3830689ebbea"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a></div><div class="ttdeci">static char vm_mismatch[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00989">app_voicemail.c:989</a></div></div>
<div class="ttc" id="hash_8c_html_a8fe83ac76edc595f6b98cd4a4127aed5"><div class="ttname"><a href="../../d1/d04/hash_8c.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a></div><div class="ttdeci">#define ERROR</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d04/hash_8c_source.html#l00085">hash.c:85</a></div></div>
<div class="ttc" id="structalias__mailbox__mapping_html"><div class="ttname"><a href="../../de/d16/structalias__mailbox__mapping.html">alias_mailbox_mapping</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00954">app_voicemail.c:954</a></div></div>
<div class="ttc" id="format__cap_8h_html_a51f3293ae7b01a8353bf4aa1204abba5ad111d20686641a6f0fc5efd33c82e97a"><div class="ttname"><a href="../../d0/d3c/format__cap_8h.html#a51f3293ae7b01a8353bf4aa1204abba5ad111d20686641a6f0fc5efd33c82e97a">AST_FORMAT_CAP_FLAG_DEFAULT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d3c/format__cap_8h_source.html#l00038">format_cap.h:38</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a50ae61db871bd4f0e0b8caa6c3e56810"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a50ae61db871bd4f0e0b8caa6c3e56810">ast_vm_greeter_unregister</a></div><div class="ttdeci">void ast_vm_greeter_unregister(const char *module_name)</div><div class="ttdoc">Unregister the specified voicemail greeter provider. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00584">main/app.c:584</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a8531d21b3ca3a109d9b8d0d88d079c3b"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a8531d21b3ca3a109d9b8d0d88d079c3b">ast_vm_recording_data::call_callerid</a></div><div class="ttdeci">const ast_string_field call_callerid</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5fb550720f95b169012042cdef395172"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a></div><div class="ttdeci">static char vm_pls_try_again[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00991">app_voicemail.c:991</a></div></div>
<div class="ttc" id="structmailbox__alias__mapping_html_a9027b352db4085a0122952932d065705"><div class="ttname"><a href="../../d0/d11/structmailbox__alias__mapping.html#a9027b352db4085a0122952932d065705">mailbox_alias_mapping::alias</a></div><div class="ttdeci">char * alias</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00961">app_voicemail.c:961</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a846844eb2c4eb44554445936b3770711"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a></div><div class="ttdeci">#define CONFIG_STATUS_FILEUNCHANGED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00059">include/asterisk/config.h:59</a></div></div>
<div class="ttc" id="structbaseio_html_a3e47346bcad694f3bfc4099f56531cee"><div class="ttname"><a href="../../d5/d11/structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">baseio::iolen</a></div><div class="ttdeci">int iolen</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00742">app_voicemail.c:742</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2bb6469a0976d1715c300b32332352d9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a></div><div class="ttdeci">static struct ast_taskprocessor * mwi_subscription_tps</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00952">app_voicemail.c:952</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a10f9ed9242a397abf76de1ed1fa33c3b"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b">AST_LIST_HEAD_STATIC</a></div><div class="ttdeci">#define AST_LIST_HEAD_STATIC(name, type)</div><div class="ttdoc">Defines a structure to be used to hold a list of specified type, statically initialized. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00290">linkedlists.h:290</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0358699b7469974a9d59e4b808640576"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a></div><div class="ttdeci">static char vm_invalid_password[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00990">app_voicemail.c:990</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8ff15b65c3b44614e084af8cd71a61b6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6">get_folder2</a></div><div class="ttdeci">static int get_folder2(struct ast_channel *chan, char *fn, int start)</div><div class="ttdoc">plays a prompt and waits for a keypress. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07904">app_voicemail.c:7904</a></div></div>
<div class="ttc" id="test_8h_html_a9482d93ea3931853331bdbc745ce7cb4"><div class="ttname"><a href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a></div><div class="ttdeci">#define ast_test_suite_event_notify(s, f,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00196">test.h:196</a></div></div>
<div class="ttc" id="astmm_8h_html_a249282ecc7ba5a1a49fa75e9a33d1717"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a></div><div class="ttdeci">#define ast_alloca(size)</div><div class="ttdoc">call __builtin_alloca to ensure we get gcc builtin semantics </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00290">astmm.h:290</a></div></div>
<div class="ttc" id="channel_8h_html_a3b6254f6d3832ef928f0a727113b1c63"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a3b6254f6d3832ef928f0a727113b1c63">ast_channel_uniqueid</a></div><div class="ttdeci">const char * ast_channel_uniqueid(const struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00305">channel_internal_api.c:305</a></div></div>
<div class="ttc" id="structast__cli__args_html_ad0a19c4d63698f9e9cfd5653e8851452"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#ad0a19c4d63698f9e9cfd5653e8851452">ast_cli_args::argv</a></div><div class="ttdeci">const char *const  * argv</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00161">cli.h:161</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af60e2269ce2d97043acafb2587162587"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587">apply_option</a></div><div class="ttdeci">static void apply_option(struct ast_vm_user *vmu, const char *var, const char *value)</div><div class="ttdoc">Sets a specific property value. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01252">app_voicemail.c:1252</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ab0f11affd99d055b676f1b883fb486a8"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ab0f11affd99d055b676f1b883fb486a8">ast_vm_register</a></div><div class="ttdeci">#define ast_vm_register(vm_table)</div><div class="ttdoc">See __ast_vm_register() </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00588">include/asterisk/app.h:588</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7b094a77bf9fe791f3d6fd3ba5e8a4e7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7b094a77bf9fe791f3d6fd3ba5e8a4e7">run_externnotify</a></div><div class="ttdeci">static void run_externnotify(const char *context, const char *extension, const char *flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06234">app_voicemail.c:6234</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a52a9526aa84df7047ca4cb9edad78fa5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">vm_intro</a></div><div class="ttdeci">static int vm_intro(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10361">app_voicemail.c:10361</a></div></div>
<div class="ttc" id="paths_8h_html_a63af4213b5b83f717398d8d62008a50d"><div class="ttname"><a href="../../dd/df2/paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a></div><div class="ttdeci">const char * ast_config_AST_DATA_DIR</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc5/options_8c_source.html#l00158">options.c:158</a></div></div>
<div class="ttc" id="group__Group__AMI_html_gafadf012f66a9fd7ecf985ec5b9dee101"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#gafadf012f66a9fd7ecf985ec5b9dee101">ast_manager_unregister</a></div><div class="ttdeci">int ast_manager_unregister(const char *action)</div><div class="ttdoc">Unregister a registered manager command. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l07258">manager.c:7258</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6b8784f6ee73401816e2d4fa3264b777"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">DEFAULT_POLL_FREQ</a></div><div class="ttdeci">#define DEFAULT_POLL_FREQ</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00943">app_voicemail.c:943</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a61f1dd805f377ec2c4e32c5ebf01397f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">VM_PBXSKIP</a></div><div class="ttdeci">#define VM_PBXSKIP</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00557">app_voicemail.c:557</a></div></div>
<div class="ttc" id="manager_8h_html"><div class="ttname"><a href="../../db/d45/manager_8h.html">manager.h</a></div><div class="ttdoc">The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk with third-party ...</div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00573">app_voicemail.c:573</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a92444ec75fa1e9945e824bb196fb04d2"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a></div><div class="ttdeci">#define HVSU_OUTPUT_FORMAT</div></div>
<div class="ttc" id="adsi_8h_html_ae3d9f4346bcdf8a8ff8b2c6ca2212949"><div class="ttname"><a href="../../df/de2/adsi_8h.html#ae3d9f4346bcdf8a8ff8b2c6ca2212949">ast_adsi_transmit_message</a></div><div class="ttdeci">int ast_adsi_transmit_message(struct ast_channel *chan, unsigned char *msg, int msglen, int msgtype)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00098">adsi.c:98</a></div></div>
<div class="ttc" id="structast__vm__user_html_a72e263d6ba290a92142dbd1a61ccc44b"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a72e263d6ba290a92142dbd1a61ccc44b">ast_vm_user::fromstring</a></div><div class="ttdeci">char fromstring[100]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00765">app_voicemail.c:765</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2f8ec3653f4ec69cd785b8026421a3ad"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a></div><div class="ttdeci">#define VM_OPERATOR</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00549">app_voicemail.c:549</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a761b2afbca06109ec90f4430bb8c0935"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a></div><div class="ttdeci">static int vm_intro_cs(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10231">app_voicemail.c:10231</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab42ffe446700ea9a17e5798eafabbde8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a></div><div class="ttdeci">static char callcontext[AST_MAX_CONTEXT]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01010">app_voicemail.c:1010</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1df943a05a384a407a19cf8831b2d237"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a></div><div class="ttdeci">static int skipms</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00932">app_voicemail.c:932</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0c73425198917b11dde1f5b059175f47"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47">adsi_password</a></div><div class="ttdeci">static void adsi_password(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07491">app_voicemail.c:7491</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a29ff8cd717c0c0bac60abbd827fec409"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a29ff8cd717c0c0bac60abbd827fec409">ast_load_realtime_multientry</a></div><div class="ttdeci">struct ast_config * ast_load_realtime_multientry(const char *family,...) attribute_sentinel</div><div class="ttdoc">Retrieve realtime configuration. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03452">main/config.c:3452</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac963b5fb03d8e52621fde667f8a76e43"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac963b5fb03d8e52621fde667f8a76e43">poll_subscribed_mailbox</a></div><div class="ttdeci">static int poll_subscribed_mailbox(struct ast_mwi_state *mwi_state, void *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13049">app_voicemail.c:13049</a></div></div>
<div class="ttc" id="say_8h_html_a7501ad5a3199320955b0386707878eb4"><div class="ttname"><a href="../../db/dce/say_8h.html#a7501ad5a3199320955b0386707878eb4">ast_say_date_with_format</a></div><div class="ttdeci">SAY_EXTERN int(* ast_say_date_with_format)(struct ast_channel *chan, time_t t, const char *ints, const char *lang, const char *format, const char *timezone) SAY_INIT(ast_say_date_with_format)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dce/say_8h_source.html#l00189">say.h:189</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fa3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00045">include/asterisk/config.h:45</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a547735280f0983afc46bf476d17be24a"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a547735280f0983afc46bf476d17be24a">AST_LIST_HEAD_NOLOCK_STATIC</a></div><div class="ttdeci">#define AST_LIST_HEAD_NOLOCK_STATIC(name, type)</div><div class="ttdoc">Defines a structure to be used to hold a list of specified type, statically initialized. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00345">linkedlists.h:345</a></div></div>
<div class="ttc" id="logger_8h_html_aced66975c154ea0e2a8ec3bc818b4e08"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a></div><div class="ttdeci">#define LOG_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00285">logger.h:285</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a4d258b4525e63c435d7de579d3f46960"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a></div><div class="ttdeci">#define AST_LIST_INSERT_TAIL(head, elm, field)</div><div class="ttdoc">Appends a list entry to the tail of a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00730">linkedlists.h:730</a></div></div>
<div class="ttc" id="astobj2_8h_html_aefc16f8aa9087cbc5c55c70cf1dd41b2"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#aefc16f8aa9087cbc5c55c70cf1dd41b2">ao2_container_alloc_hash</a></div><div class="ttdeci">#define ao2_container_alloc_hash(ao2_options, container_options, n_buckets, hash_fn, sort_fn, cmp_fn)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01310">astobj2.h:1310</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a17e9a183fe629a3a4658222d7ba95e1e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e">find_user_realtime</a></div><div class="ttdeci">static struct ast_vm_user * find_user_realtime(struct ast_vm_user *ivm, const char *context, const char *mailbox)</div><div class="ttdoc">Finds a voicemail user from the realtime engine. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01617">app_voicemail.c:1617</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a07c88336f106270f57593724e39f0604"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a07c88336f106270f57593724e39f0604">vm_test_destroy_user</a></div><div class="ttdeci">static int vm_test_destroy_user(const char *context, const char *mailbox)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15774">app_voicemail.c:15774</a></div></div>
<div class="ttc" id="res__odbc_8h_html_ac29fe8d9aba364c43aa8b5c47e48587e"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html#ac29fe8d9aba364c43aa8b5c47e48587e">ast_odbc_direct_execute</a></div><div class="ttdeci">SQLHSTMT ast_odbc_direct_execute(struct odbc_obj *obj, SQLHSTMT(*exec_cb)(struct odbc_obj *obj, void *data), void *data)</div><div class="ttdoc">Executes an non prepared statement and returns the resulting statement handle. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d4a/res__odbc_8c_source.html#l00369">res_odbc.c:369</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a672efc9a126f87f2aaab9f0bac2870f5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a></div><div class="ttdeci">static char ext_pass_check_cmd[128]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00881">app_voicemail.c:881</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a333bf47dfcf80161478d3d83a6c40821"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821">vm_play_folder_name_gr</a></div><div class="ttdeci">static int vm_play_folder_name_gr(struct ast_channel *chan, char *box)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09268">app_voicemail.c:9268</a></div></div>
<div class="ttc" id="strings_8h_html_a387a69b3871ca31061566a73f45d20f4"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a387a69b3871ca31061566a73f45d20f4">ast_true</a></div><div class="ttdeci">int attribute_pure ast_true(const char *val)</div><div class="ttdoc">Make sure something is true. Determine if a string containing a boolean value is &quot;true&quot;. This function checks to see whether a string passed to it is an indication of an &quot;true&quot; value. It checks to see if the string is &quot;yes&quot;, &quot;true&quot;, &quot;y&quot;, &quot;t&quot;, &quot;on&quot; or &quot;1&quot;. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l01951">main/utils.c:1951</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a398881abd8fa2cd896a061c3066c51fc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a398881abd8fa2cd896a061c3066c51fc">play_record_review</a></div><div class="ttdeci">static int play_record_review(struct ast_channel *chan, char *playfile, char *recordfile, int maxtime, char *fmt, int outsidecaller, struct ast_vm_user *vmu, int *duration, int *sound_duration, const char *unlockdir, signed char record_gain, struct vm_state *vms, char *flag, const char *msg_id, int forwardintro)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15504">app_voicemail.c:15504</a></div></div>
<div class="ttc" id="structast__vm__user_html_ab89d128ff0a8b3ceab1ec2590bb98b2f"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">ast_vm_user::emailbody</a></div><div class="ttdeci">char * emailbody</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00762">app_voicemail.c:762</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3247e9fdb87c86de8922299cab408461"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3247e9fdb87c86de8922299cab408461">AO2_STRING_FIELD_CMP_FN</a></div><div class="ttdeci">AO2_STRING_FIELD_CMP_FN(alias_mailbox_mapping, alias)</div></div>
<div class="ttc" id="app__voicemail_8c_html_ade4426f4085a7869e60fd75ac4fb52f9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9">vm_play_folder_name_ua</a></div><div class="ttdeci">static int vm_play_folder_name_ua(struct ast_channel *chan, char *box)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09315">app_voicemail.c:9315</a></div></div>
<div class="ttc" id="structast__str_html"><div class="ttname"><a href="../../dd/da2/structast__str.html">ast_str</a></div><div class="ttdoc">The descriptor of a dynamic string XXX storage will be optimized later if needed We use the ts field ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00584">strings.h:584</a></div></div>
<div class="ttc" id="structast__format__cap_html"><div class="ttname"><a href="../../d8/d69/structast__format__cap.html">ast_format_cap</a></div><div class="ttdoc">Format capabilities structure, holds formats + preference order + etc. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc9/format__cap_8c_source.html#l00054">format_cap.c:54</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a9fb5cf0385848033ee3e98625e5f9784"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a9fb5cf0385848033ee3e98625e5f9784">ast_safe_system</a></div><div class="ttdeci">int ast_safe_system(const char *s)</div><div class="ttdoc">Safely spawn an OS shell command while closing file descriptors. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l00829">extconf.c:829</a></div></div>
<div class="ttc" id="mwi_8h_html_ad200df5870ce5a601381c4e37f8a2197"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#ad200df5870ce5a601381c4e37f8a2197">ast_mwi_remove_observer</a></div><div class="ttdeci">void ast_mwi_remove_observer(struct ast_mwi_observer *observer)</div><div class="ttdoc">Remove an MWI state observer. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00302">mwi.c:302</a></div></div>
<div class="ttc" id="utils_2frame_8c_html_aadebe2487a2c5240ab6cd02c83add0bf"><div class="ttname"><a href="../../d6/d47/utils_2frame_8c.html#aadebe2487a2c5240ab6cd02c83add0bf">usage</a></div><div class="ttdeci">char * usage</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d47/utils_2frame_8c_source.html#l00037">utils/frame.c:37</a></div></div>
<div class="ttc" id="include_2asterisk_2frame_8h_html_a3e9274bcddca58b613f4e676b9943c03"><div class="ttname"><a href="../../d6/d66/include_2asterisk_2frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a></div><div class="ttdeci">#define AST_OPTION_RXGAIN</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d66/include_2asterisk_2frame_8h_source.html#l00453">include/asterisk/frame.h:453</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abd7ac3d7cb5ea27916252d4b9f045834"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abd7ac3d7cb5ea27916252d4b9f045834">handle_voicemail_show_aliases</a></div><div class="ttdeci">static char * handle_voicemail_show_aliases(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</div><div class="ttdoc">Show a list of voicemail zones in the CLI. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12980">app_voicemail.c:12980</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac258dc9954bb3f9738fd55cdae23d38c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a></div><div class="ttdeci">#define RENAME(a, b, c, d, e, f, g, h)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00871">app_voicemail.c:871</a></div></div>
<div class="ttc" id="include_2asterisk_2compat_8h_html_a09c40bd781f93eb20cdd2eedf34eadeb"><div class="ttname"><a href="../../de/da3/include_2asterisk_2compat_8h.html#a09c40bd781f93eb20cdd2eedf34eadeb">mkdtemp</a></div><div class="ttdeci">char * mkdtemp(char *template_s)</div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a7549377df87038be737e8cae73acaa9d"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a7549377df87038be737e8cae73acaa9d">AST_APP_OPTION_ARG</a></div><div class="ttdeci">#define AST_APP_OPTION_ARG(option, flagno, argno)</div><div class="ttdoc">Declares an application option that accepts an argument. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01413">include/asterisk/app.h:1413</a></div></div>
<div class="ttc" id="cli_8h_html_a0873456096960dab21fff0ce68c95acb"><div class="ttname"><a href="../../dc/db0/cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a></div><div class="ttdeci">#define CLI_SHOWUSAGE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00045">cli.h:45</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad1fbdf312bcc5372c9cc5836920b1d6c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c">forward_message</a></div><div class="ttdeci">static int forward_message(struct ast_channel *chan, char *context, struct vm_state *vms, struct ast_vm_user *sender, char *fmt, int is_new_message, signed char record_gain, int urgent)</div><div class="ttdoc">Sends a voicemail message to a mailbox recipient. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08269">app_voicemail.c:8269</a></div></div>
<div class="ttc" id="structast__vm__mailbox__snapshot_html_a1a119a01eb13505ebe560442a8e9cda8"><div class="ttname"><a href="../../d3/dbc/structast__vm__mailbox__snapshot.html#a1a119a01eb13505ebe560442a8e9cda8">ast_vm_mailbox_snapshot::snapshots</a></div><div class="ttdeci">struct ast_vm_mailbox_snapshot::@223 * snapshots</div></div>
<div class="ttc" id="structast__vm__greeter__functions_html_a4c2d9327de87c6be0b54f793adc7f1fb"><div class="ttname"><a href="../../d0/d1e/structast__vm__greeter__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">ast_vm_greeter_functions::module_name</a></div><div class="ttdeci">const char * module_name</div><div class="ttdoc">The name of the module that provides the voicemail greeter functionality. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00627">include/asterisk/app.h:627</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac71d7f348bf10bc8070f4658dce38b6b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a></div><div class="ttdeci">static unsigned int poll_mailboxes</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00940">app_voicemail.c:940</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa567daf2013573862651771d53d122f8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a></div><div class="ttdeci">static char listen_control_restart_key[12]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00979">app_voicemail.c:979</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a654bcd2aee84a0c6d2f90e01f9b5acb8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a654bcd2aee84a0c6d2f90e01f9b5acb8">vm_mailbox_snapshot_destroy</a></div><div class="ttdeci">static struct ast_vm_mailbox_snapshot * vm_mailbox_snapshot_destroy(struct ast_vm_mailbox_snapshot *mailbox_snapshot)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16048">app_voicemail.c:16048</a></div></div>
<div class="ttc" id="test_8h_html_a79bc64a935b14b1b181156e5ada58ead"><div class="ttname"><a href="../../d2/ddc/test_8h.html#a79bc64a935b14b1b181156e5ada58ead">AST_TEST_UNREGISTER</a></div><div class="ttdeci">#define AST_TEST_UNREGISTER(cb)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00128">test.h:128</a></div></div>
<div class="ttc" id="structast__vm__user_html_a7710710968414887abc3b7a89d22f83d"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">ast_vm_user::maxsecs</a></div><div class="ttdeci">int maxsecs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00779">app_voicemail.c:779</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5fa4f2ff0f951d5c25be41fadddb856a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5fa4f2ff0f951d5c25be41fadddb856a">OPERATOR_EXIT</a></div><div class="ttdeci">#define OPERATOR_EXIT</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00569">app_voicemail.c:569</a></div></div>
<div class="ttc" id="chan__sip_8c_html_a6763e6050c81d7501cebb1d4b1fc0970"><div class="ttname"><a href="../../d5/dfe/chan__sip_8c.html#a6763e6050c81d7501cebb1d4b1fc0970">aliases</a></div><div class="ttdeci">static const struct cfalias aliases[]</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/dfe/chan__sip_8c_source.html#l08510">chan_sip.c:8510</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_accfcb380df76a64251d88ef49c2dd4e3"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#accfcb380df76a64251d88ef49c2dd4e3">AST_NONSTANDARD_APP_ARGS</a></div><div class="ttdeci">#define AST_NONSTANDARD_APP_ARGS(args, parse, sep)</div><div class="ttdoc">Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01300">include/asterisk/app.h:1300</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a7faec841658b88ad0cfbc684853acad3"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a7faec841658b88ad0cfbc684853acad3">ast_vm_recording_data::context</a></div><div class="ttdeci">const ast_string_field context</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="manager_8h_html_acc12c2bc03dce67ddd1590d67ab11f4d"><div class="ttname"><a href="../../db/d45/manager_8h.html#acc12c2bc03dce67ddd1590d67ab11f4d">EVENT_FLAG_USER</a></div><div class="ttdeci">#define EVENT_FLAG_USER</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d45/manager_8h_source.html#l00077">manager.h:77</a></div></div>
<div class="ttc" id="namespacesip__to__pjsip_html_ab82f408a83ecba10ea39afd8abfd371e"><div class="ttname"><a href="../../dd/d17/namespacesip__to__pjsip.html#ab82f408a83ecba10ea39afd8abfd371e">sip_to_pjsip.info</a></div><div class="ttdeci">def info(msg)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d6f/sip__to__pjsip_8py_source.html#l01313">sip_to_pjsip.py:1313</a></div></div>
<div class="ttc" id="func__strings_8c_html_af24e73aaf92f3000fda15d285e66df24"><div class="ttname"><a href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a></div><div class="ttdeci">static int len(struct ast_channel *chan, const char *cmd, char *data, char *buf, size_t buflen)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d1e/func__strings_8c_source.html#l01344">func_strings.c:1344</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aed272644d27e1104b1115318e2be6fe4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a></div><div class="ttdeci">#define VM_REVIEW</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00548">app_voicemail.c:548</a></div></div>
<div class="ttc" id="main_2stdtime_2private_8h_html_ad65a8842cc674e3ddf69355898c0ecbf"><div class="ttname"><a href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a></div><div class="ttdeci">int errno</div></div>
<div class="ttc" id="app__voicemail_8c_html_a520e1cbd2171aa7abae658420d940fc7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7">vm_browse_messages</a></div><div class="ttdeci">static int vm_browse_messages(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Top level method to invoke the language variant vm_browse_messages_XX function. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11203">app_voicemail.c:11203</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_acc1a27de6051bbf777a3770d49305c1b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acc1a27de6051bbf777a3770d49305c1b">vm_intro_is</a></div><div class="ttdeci">static int vm_intro_is(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09664">app_voicemail.c:9664</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a7a4c7e208ffc4d11a1918beb0e920ec0"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0">ast_safe_fork</a></div><div class="ttdeci">int ast_safe_fork(int stop_reaper)</div><div class="ttdoc">Common routine to safely fork without a chance of a signal handler firing badly in the child...</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l03047">main/app.c:3047</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a12d07d7662dd94386a312ef17ade18f5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a></div><div class="ttdeci">static void adsi_folders(struct ast_channel *chan, int start, char *label)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07513">app_voicemail.c:7513</a></div></div>
<div class="ttc" id="time_8h_html_a97e1bb8fbd7a103212789e87e7ed6073"><div class="ttname"><a href="../../de/df7/time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073">ast_tvadd</a></div><div class="ttdeci">struct timeval ast_tvadd(struct timeval a, struct timeval b)</div><div class="ttdoc">Returns the sum of two timevals a + b. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l02283">extconf.c:2283</a></div></div>
<div class="ttc" id="structinprocess_html"><div class="ttname"><a href="../../de/d24/structinprocess.html">inprocess</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01112">app_voicemail.c:1112</a></div></div>
<div class="ttc" id="adsi_8h_html_a5c34c039ca9214ec4be70b2c4059f891"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a></div><div class="ttdeci">#define ADSI_KEY_SKT</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00117">adsi.h:117</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6b932796ecb15a8350a4bf3f9429045a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6b932796ecb15a8350a4bf3f9429045a">vm_intro_vi</a></div><div class="ttdeci">static int vm_intro_vi(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10331">app_voicemail.c:10331</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00076">include/asterisk/config.h:76</a></div></div>
<div class="ttc" id="astobj2_8h_html_a17990ea630db7dbd1252ef0132133a2b"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a17990ea630db7dbd1252ef0132133a2b">ao2_iterator_next</a></div><div class="ttdeci">#define ao2_iterator_next(iter)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01933">astobj2.h:1933</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a122be913e1f6ff9245316ee210430aff"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff">leave_voicemail</a></div><div class="ttdeci">static int leave_voicemail(struct ast_channel *chan, char *ext, struct leave_vm_options *options)</div><div class="ttdoc">Prompts the user and records a voicemail to a mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06601">app_voicemail.c:6601</a></div></div>
<div class="ttc" id="structbaseio_html_a4cd390d771f962d39585708c848317e5"><div class="ttname"><a href="../../d5/d11/structbaseio.html#a4cd390d771f962d39585708c848317e5">baseio::linelength</a></div><div class="ttdeci">int linelength</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00743">app_voicemail.c:743</a></div></div>
<div class="ttc" id="astobj2_8h_html_ae0422b60d8e25b6962b2d61ae4ddf724"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a></div><div class="ttdeci">#define ao2_alloc(data_size, destructor_fn)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l00411">astobj2.h:411</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1dcb0c236f2228fe4e16002f44afecaa"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa">ochar</a></div><div class="ttdeci">static int ochar(struct baseio *bio, int c, FILE *so)</div><div class="ttdoc">utility used by base_encode() </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04807">app_voicemail.c:4807</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00588">app_voicemail.c:588</a></div></div>
<div class="ttc" id="logger_8h_html_ad89ee324d180cdcd7defcc709ff9ca42"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a></div><div class="ttdeci">#define LOG_NOTICE</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00263">logger.h:263</a></div></div>
<div class="ttc" id="structvm__state_html_aeac36e072112b058cf05376bc10170a9"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#aeac36e072112b058cf05376bc10170a9">vm_state::vmbox</a></div><div class="ttdeci">char vmbox[PATH_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00811">app_voicemail.c:811</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_a6289cadce5fd2b3dbf516cdd824638f5"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#a6289cadce5fd2b3dbf516cdd824638f5">ast_vm_recording_data::call_callerchan</a></div><div class="ttdeci">const ast_string_field call_callerchan</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="pbx_8h_html_a8f7166f50cb9642179c9b321b8143f55"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a></div><div class="ttdeci">int ast_goto_if_exists(struct ast_channel *chan, const char *context, const char *exten, int priority)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d94/pbx_8c_source.html#l08793">pbx.c:8793</a></div></div>
<div class="ttc" id="test_8h_html_aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b"><div class="ttname"><a href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a7a3ab73c870a7ce6cf1a0f3cfd42a37b">AST_TEST_PASS</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00202">test.h:202</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a158fef5d62bdc9b70bcf52e13c6a76c1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">VOICEMAIL_DIR_MODE</a></div><div class="ttdeci">#define VOICEMAIL_DIR_MODE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00507">app_voicemail.c:507</a></div></div>
<div class="ttc" id="include_2asterisk_2compat_8h_html_a0d78ab95e54db8c72a64038cfefb5161"><div class="ttname"><a href="../../de/da3/include_2asterisk_2compat_8h.html#a0d78ab95e54db8c72a64038cfefb5161">strcasestr</a></div><div class="ttdeci">char * strcasestr(const char *, const char *)</div></div>
<div class="ttc" id="structast__config_html"><div class="ttname"><a href="../../dd/d18/structast__config.html">ast_config</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l00249">main/config.c:249</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a91eea11f926632631350a2c9678525aa"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa">adsi_goodbye</a></div><div class="ttdeci">static void adsi_goodbye(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07799">app_voicemail.c:7799</a></div></div>
<div class="ttc" id="file_8h_html_a36f6bba05952162d5d1ee7fb9819bd07"><div class="ttname"><a href="../../d2/d4d/file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07">ast_seekstream</a></div><div class="ttdeci">int ast_seekstream(struct ast_filestream *fs, off_t sample_offset, int whence)</div><div class="ttdoc">Seeks into stream. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01038">file.c:1038</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ade618edc558143e7341a4f3f25cabe60"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a></div><div class="ttdeci">static int vm_instructions(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int skipadvanced, int in_urgent)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10635">app_voicemail.c:10635</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a3008b2f4f236b72d8bcfb80e346324ef"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef">AST_LIST_TRAVERSE</a></div><div class="ttdeci">#define AST_LIST_TRAVERSE(head, var, field)</div><div class="ttdoc">Loops over (traverses) the entries in a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00490">linkedlists.h:490</a></div></div>
<div class="ttc" id="say_8h_html_ac3420184b387e73718d56aa73aa16b25"><div class="ttname"><a href="../../db/dce/say_8h.html#ac3420184b387e73718d56aa73aa16b25">ast_say_counted_adjective</a></div><div class="ttdeci">int ast_say_counted_adjective(struct ast_channel *chan, int num, const char *adjective, const char *gender)</div></div>
<div class="ttc" id="linkedlists_8h_html_a67508a613c8f337732e35d9367b43ae7"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7">AST_LIST_ENTRY</a></div><div class="ttdeci">#define AST_LIST_ENTRY(type)</div><div class="ttdoc">Declare a forward link structure inside a list entry. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00409">linkedlists.h:409</a></div></div>
<div class="ttc" id="func__realtime_8c_html_aef4a708d73ca36016d9360f84685350d"><div class="ttname"><a href="../../db/d09/func__realtime_8c.html#aef4a708d73ca36016d9360f84685350d">buf1</a></div><div class="ttdeci">static struct ast_threadstorage buf1</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d09/func__realtime_8c_source.html#l00178">func_realtime.c:178</a></div></div>
<div class="ttc" id="f2c_8h_html_abf5d144da384425ae6cb542ce6eec8d3"><div class="ttname"><a href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a></div><div class="ttdeci">long int flag</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dc2/f2c_8h_source.html#l00083">f2c.h:83</a></div></div>
<div class="ttc" id="linkedlists_8h_html_aa2ded2af046bb513f77056c27c083307"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307">AST_LIST_INSERT_HEAD</a></div><div class="ttdeci">#define AST_LIST_INSERT_HEAD(head, elm, field)</div><div class="ttdoc">Inserts a list entry at the head of a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00710">linkedlists.h:710</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae521e9b8082a7c9591e1a8dea8963a95"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae521e9b8082a7c9591e1a8dea8963a95">manager_match_mailbox</a></div><div class="ttdeci">static int manager_match_mailbox(struct ast_mwi_state *mwi_state, void *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13344">app_voicemail.c:13344</a></div></div>
<div class="ttc" id="channel_8h_html_af476c537b29be3f29240489032f9db39"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#af476c537b29be3f29240489032f9db39">ast_channel_unlock</a></div><div class="ttdeci">#define ast_channel_unlock(chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l02946">channel.h:2946</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6fb8f5e6825dfc89afea7b5b2955c061"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">find_user</a></div><div class="ttdeci">static struct ast_vm_user * find_user(struct ast_vm_user *ivm, const char *context, const char *mailbox)</div><div class="ttdoc">Finds a voicemail user from the users file or the realtime engine. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01658">app_voicemail.c:1658</a></div></div>
<div class="ttc" id="cli_8h_html_ae47751901c430ebb833e59291a5e0b3f"><div class="ttname"><a href="../../dc/db0/cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a></div><div class="ttdeci">#define CLI_FAILURE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00046">cli.h:46</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a54a9f8be551279c23e515e58a2bfee68"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a54a9f8be551279c23e515e58a2bfee68">vm_playmsgexec</a></div><div class="ttdeci">static int vm_playmsgexec(struct ast_channel *chan, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11464">app_voicemail.c:11464</a></div></div>
<div class="ttc" id="chan__mgcp_8c_html_a2e006acff60d9b3d65d7d60f975d6747"><div class="ttname"><a href="../../d0/dd6/chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a></div><div class="ttdeci">static void parse(struct mgcp_request *req)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd6/chan__mgcp_8c_source.html#l01872">chan_mgcp.c:1872</a></div></div>
<div class="ttc" id="channel_8h_html_abcf1aea85b924e9cd605040b86241e2a"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a></div><div class="ttdeci">#define AST_MAX_CONTEXT</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00136">channel.h:136</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad1a6f2e97555fbf7ccd23e3228e331ec"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad1a6f2e97555fbf7ccd23e3228e331ec">mwi_handle_subscribe2</a></div><div class="ttdeci">static int mwi_handle_subscribe2(void *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13174">app_voicemail.c:13174</a></div></div>
<div class="ttc" id="cdr__mysql_8c_html_a0980a105ccb863d8008eb6201a51da52"><div class="ttname"><a href="../../d0/d29/cdr__mysql_8c.html#a0980a105ccb863d8008eb6201a51da52">name</a></div><div class="ttdeci">static const char name[]</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d29/cdr__mysql_8c_source.html#l00074">cdr_mysql.c:74</a></div></div>
<div class="ttc" id="astmm_8h_html_a402072d6789f6ed9e3a81da27504127e"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a></div><div class="ttdeci">#define ast_free(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00182">astmm.h:182</a></div></div>
<div class="ttc" id="structast__cli__entry_html_ade9cba72805fe52685a1deea307a8e82"><div class="ttname"><a href="../../d8/d07/structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">ast_cli_entry::command</a></div><div class="ttdeci">char * command</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00186">cli.h:186</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6e97699b892f61cc208de9f991cfb293"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6e97699b892f61cc208de9f991cfb293">load_config_from_memory</a></div><div class="ttdeci">static int load_config_from_memory(int reload, struct ast_config *cfg, struct ast_config *ucfg)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13580">app_voicemail.c:13580</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0112f2b20b4dab6be869891f706a0464"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0112f2b20b4dab6be869891f706a0464">save_to_folder</a></div><div class="ttdeci">static int save_to_folder(struct ast_vm_user *vmu, struct vm_state *vms, int msg, int box, int *newmsg, int move)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07214">app_voicemail.c:7214</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a836c1d4ec952b85cec781651bebba908"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a></div><div class="ttdeci">static char emaildateformat[32]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01027">app_voicemail.c:1027</a></div></div>
<div class="ttc" id="mwi_8h_html_aa7789090f6f6177b5033d240bba65b93"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#aa7789090f6f6177b5033d240bba65b93">ast_mwi_state_callback_all</a></div><div class="ttdeci">void ast_mwi_state_callback_all(on_mwi_state handler, void *data)</div><div class="ttdoc">For each managed mailbox call the given handler. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/db4/mwi_8c_source.html#l00333">mwi.c:333</a></div></div>
<div class="ttc" id="astmm_8h_html_ae0cd4c5524b01287ab19cbe233d9cebb"><div class="ttname"><a href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a></div><div class="ttdeci">#define ast_calloc(num, len)</div><div class="ttdoc">A wrapper for calloc() </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d8a/astmm_8h_source.html#l00204">astmm.h:204</a></div></div>
<div class="ttc" id="utils_8h_html_a4781fd54a4ca8c7f0f8a32a6cce503c0"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a></div><div class="ttdeci">#define ast_pthread_create(a, b, c, d)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00559">utils.h:559</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3f31453846f663c1b3f842c32ba48739"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739">vm_browse_messages_pt</a></div><div class="ttdeci">static int vm_browse_messages_pt(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdoc">Portuguese syntax for &amp;#39;You have N messages&amp;#39; greeting. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11122">app_voicemail.c:11122</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a76ac04f58d94b23ce7ef0fd5c4b99de7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a76ac04f58d94b23ce7ef0fd5c4b99de7">mwi_handle_unsubscribe</a></div><div class="ttdeci">static void mwi_handle_unsubscribe(const char *id, struct ast_mwi_subscriber *sub)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13163">app_voicemail.c:13163</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6870514fab6ee520c54e40a7d49439d6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6870514fab6ee520c54e40a7d49439d6">separate_mailbox</a></div><div class="ttdeci">static int separate_mailbox(char *mailbox_id, char **mailbox, char **context)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01094">app_voicemail.c:1094</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6482df0b3a3887ad75f789f701d296da"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6482df0b3a3887ad75f789f701d296da">fake_write</a></div><div class="ttdeci">static int fake_write(struct ast_channel *ast, struct ast_frame *frame)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14470">app_voicemail.c:14470</a></div></div>
<div class="ttc" id="adsi_8h_html_acc50da4e3e25e75245268963ecc5fcd0"><div class="ttname"><a href="../../df/de2/adsi_8h.html#acc50da4e3e25e75245268963ecc5fcd0">ast_adsi_end_download</a></div><div class="ttdeci">int ast_adsi_end_download(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00043">adsi.c:43</a></div></div>
<div class="ttc" id="file_8h_html_a95b94a020720147325a486e210b36775"><div class="ttname"><a href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a></div><div class="ttdeci">int ast_stream_and_wait(struct ast_channel *chan, const char *file, const char *digits)</div><div class="ttdoc">stream file until digit If the file name is non-empty, try to play it. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01814">file.c:1814</a></div></div>
<div class="ttc" id="utils_8h_html_afb8683b4d96960d7a82a86a974a57599"><div class="ttname"><a href="../../d5/d60/utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a></div><div class="ttdeci">#define AST_FLAGS_ALL</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00196">utils.h:196</a></div></div>
<div class="ttc" id="res__odbc_8h_html_a28d298bdd4e1e12cb43b5c98d2128c90"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html#a28d298bdd4e1e12cb43b5c98d2128c90">ast_odbc_request_obj</a></div><div class="ttdeci">#define ast_odbc_request_obj(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d96/res__odbc_8h_source.html#l00122">res_odbc.h:122</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a59fdcd2fc4d13afb01e0b1faca7681f5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a59fdcd2fc4d13afb01e0b1faca7681f5">voicemail_app</a></div><div class="ttdeci">static char * voicemail_app</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00904">app_voicemail.c:904</a></div></div>
<div class="ttc" id="structalias__mailbox__mapping_html_a85bb287786245ade1ab8a939e4dc4723"><div class="ttname"><a href="../../de/d16/structalias__mailbox__mapping.html#a85bb287786245ade1ab8a939e4dc4723">alias_mailbox_mapping::mailbox</a></div><div class="ttdeci">char * mailbox</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00956">app_voicemail.c:956</a></div></div>
<div class="ttc" id="file_8h_html_ab53bd2c3c55d509790c7f7620aac6373"><div class="ttname"><a href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a></div><div class="ttdeci">int ast_closestream(struct ast_filestream *f)</div><div class="ttdoc">Closes a stream. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01068">file.c:1068</a></div></div>
<div class="ttc" id="channel_8h_html_a29557c4823f5e9c02519a01daf6a289c"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a29557c4823f5e9c02519a01daf6a289c">ast_hangup</a></div><div class="ttdeci">void ast_hangup(struct ast_channel *chan)</div><div class="ttdoc">Hang up a channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l02548">channel.c:2548</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00071">include/asterisk/config.h:71</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5b0be371bf94a4de90d8daff733c0d2e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e">inchar</a></div><div class="ttdeci">static int inchar(struct baseio *bio, FILE *fi)</div><div class="ttdoc">utility used by base_encode() </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04794">app_voicemail.c:4794</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac3382bf6da54c56b37069bd76bbdf4f9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a></div><div class="ttdeci">static int load_module(void)</div><div class="ttdoc">Load the module. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15123">app_voicemail.c:15123</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1e31aa9d6eb3fa3e9287e3f3c3c16969"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1e31aa9d6eb3fa3e9287e3f3c3c16969">BASELINELEN</a></div><div class="ttdeci">#define BASELINELEN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00537">app_voicemail.c:537</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_af6c7bd4912342953ac3eaf70e1284f5a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a></div><div class="ttdeci">static char vm_passchanged[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00987">app_voicemail.c:987</a></div></div>
<div class="ttc" id="smdi_8h_html"><div class="ttname"><a href="../../dc/dca/smdi_8h.html">smdi.h</a></div><div class="ttdoc">SMDI support for Asterisk. </div></div>
<div class="ttc" id="structast__cli__args_html_adc1f34651f7bbfa3ba5af27db5f53817"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">ast_cli_args::word</a></div><div class="ttdeci">const char * word</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00163">cli.h:163</a></div></div>
<div class="ttc" id="group__StasisTopicsAndMessages_html_ga0c3f093f91cee667b6ab2d5dfa4f760e"><div class="ttname"><a href="../../df/deb/group__StasisTopicsAndMessages.html#ga0c3f093f91cee667b6ab2d5dfa4f760e">ast_mwi_state::urgent_msgs</a></div><div class="ttdeci">int urgent_msgs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00466">mwi.h:466</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6261648db5348c63c5a399887cdc7bcb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6261648db5348c63c5a399887cdc7bcb">msg_create_from_file</a></div><div class="ttdeci">static int msg_create_from_file(struct ast_vm_recording_data *recdata)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06315">app_voicemail.c:6315</a></div></div>
<div class="ttc" id="adsi_8h_html_a21fe6b189347ac24dbcd134c03fcddf6"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a21fe6b189347ac24dbcd134c03fcddf6">ast_adsi_load_soft_key</a></div><div class="ttdeci">int ast_adsi_load_soft_key(unsigned char *buf, int key, const char *llabel, const char *slabel, char *ret, int data)</div><div class="ttdoc">Creates &quot;load soft key&quot; parameters. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00296">adsi.c:296</a></div></div>
<div class="ttc" id="structast__vm__user_html_a463fc22ce8b197bd60dbcdcbba158f4b"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a463fc22ce8b197bd60dbcdcbba158f4b">ast_vm_user::email</a></div><div class="ttdeci">char * email</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00760">app_voicemail.c:760</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9c4ef3c868dfcdfbedb244d4f882eec9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">maxlogins</a></div><div class="ttdeci">static int maxlogins</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00933">app_voicemail.c:933</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a61b77e9b543a66af82d7ac7d4d6b4ac8"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8">ast_variable_update</a></div><div class="ttdeci">int ast_variable_update(struct ast_category *category, const char *variable, const char *value, const char *match, unsigned int object)</div><div class="ttdoc">Update variable value within a config. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l01444">main/config.c:1444</a></div></div>
<div class="ttc" id="module_8h_html_adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57"><div class="ttname"><a href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a></div><div class="ttdoc">Module has failed to load, may be in an inconsistent state. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d16/module_8h_source.html#l00078">module.h:78</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a47ff5177c51504731acbd567efea2b17"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17">base_encode</a></div><div class="ttdeci">static int base_encode(char *filename, FILE *so)</div><div class="ttdoc">Performs a base 64 encode algorithm on the contents of a File. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04835">app_voicemail.c:4835</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7035bb955d2488f04c6750ff055f56c5"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a></div><div class="ttdeci">static struct ast_cli_entry cli_voicemail[]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13042">app_voicemail.c:13042</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53aacc871ae384346bcdded5a7655ff5a16">OPT_PWLOC_SPOOLDIR</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00605">app_voicemail.c:605</a></div></div>
<div class="ttc" id="paths_8h_html_a95c5b4ffe620dc96d1ea9311b35c4d4f"><div class="ttname"><a href="../../dd/df2/paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a></div><div class="ttdeci">const char * ast_config_AST_SPOOL_DIR</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc5/options_8c_source.html#l00154">options.c:154</a></div></div>
<div class="ttc" id="localtime_8h_html_aa8e63928b14a347bd3973d680b885f93"><div class="ttname"><a href="../../d5/deb/localtime_8h.html#aa8e63928b14a347bd3973d680b885f93">ast_strftime</a></div><div class="ttdeci">int ast_strftime(char *buf, size_t len, const char *format, const struct ast_tm *tm)</div><div class="ttdoc">Special version of strftime(3) that handles fractions of a second. Takes the same arguments as strfti...</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df8/localtime_8c_source.html#l02524">localtime.c:2524</a></div></div>
<div class="ttc" id="mwi_8h_html_a3cbb94b9d65cd0a9beb2276292946a61"><div class="ttname"><a href="../../dc/d33/mwi_8h.html#a3cbb94b9d65cd0a9beb2276292946a61">ast_publish_mwi_state_channel</a></div><div class="ttdeci">#define ast_publish_mwi_state_channel(mailbox, context, new_msgs, old_msgs, channel_id)</div><div class="ttdoc">Publish a MWI state update associated with some channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00397">mwi.h:397</a></div></div>
<div class="ttc" id="astobj2_8h_html_a911e0703891a9a7aaf73978152092586"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a911e0703891a9a7aaf73978152092586">ao2_find</a></div><div class="ttdeci">#define ao2_find(container, arg, flags)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01756">astobj2.h:1756</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa70bd2af552395335edf781d889e7d75"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa70bd2af552395335edf781d889e7d75">MAX_VM_MBOX_ID_LEN</a></div><div class="ttdeci">#define MAX_VM_MBOX_ID_LEN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00748">app_voicemail.c:748</a></div></div>
<div class="ttc" id="cdr__adaptive__odbc_8c_html_a605e5e635448d77ff0144fbd75e8af72"><div class="ttname"><a href="../../df/ddb/cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a></div><div class="ttdeci">static SQLHSTMT generic_prepare(struct odbc_obj *obj, void *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/ddb/cdr__adaptive__odbc_8c_source.html#l00327">cdr_adaptive_odbc.c:327</a></div></div>
<div class="ttc" id="adsi_8h_html_a2e0a51a5c3ebbb2933612622c37cd8e0"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a></div><div class="ttdeci">#define ADSI_MSG_DOWNLOAD</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00033">adsi.h:33</a></div></div>
<div class="ttc" id="taskprocessor_8h_html"><div class="ttname"><a href="../../d0/d1e/taskprocessor_8h.html">taskprocessor.h</a></div><div class="ttdoc">An API for managing task processing threads that can be shared across modules. </div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_af3f76858d4dd513e59dbe5e67bc46220"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#af3f76858d4dd513e59dbe5e67bc46220">ast_app_getdata</a></div><div class="ttdeci">int ast_app_getdata(struct ast_channel *c, const char *prompt, char *s, int maxlen, int timeout)</div><div class="ttdoc">Plays a stream and gets DTMF data from a channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00197">main/app.c:197</a></div></div>
<div class="ttc" id="include_2asterisk_2frame_8h_html_aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd"><div class="ttname"><a href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd">AST_CONTROL_PROGRESS</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d66/include_2asterisk_2frame_8h_source.html#l00291">include/asterisk/frame.h:291</a></div></div>
<div class="ttc" id="structstate_html"><div class="ttname"><a href="../../d4/d88/structstate.html">state</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df8/localtime_8c_source.html#l00158">localtime.c:158</a></div></div>
<div class="ttc" id="structast__smdi__mwi__message_html_aa117f98c3165cac31c1cb2da17475fcf"><div class="ttname"><a href="../../d3/d61/structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">ast_smdi_mwi_message::fwd_st</a></div><div class="ttdeci">char fwd_st[SMDI_MAX_STATION_NUM_LEN+1]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dca/smdi_8h_source.html#l00053">smdi.h:53</a></div></div>
<div class="ttc" id="structast__vm__user_html_adf416dc058363e2fd5750c77e2d78bee"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">ast_vm_user::language</a></div><div class="ttdeci">char language[MAX_LANGUAGE]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00766">app_voicemail.c:766</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abc8505638fbf1d579dfbd85d0f0b038f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a></div><div class="ttdeci">static char listen_control_pause_key[12]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00978">app_voicemail.c:978</a></div></div>
<div class="ttc" id="chan__unistim_8c_html_a8bd4accafd4e712317ed9a471738a971"><div class="ttname"><a href="../../d1/d6d/chan__unistim_8c.html#a8bd4accafd4e712317ed9a471738a971">charset</a></div><div class="ttdeci">charset</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d6d/chan__unistim_8c_source.html#l00336">chan_unistim.c:336</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a92d8fb2d08cf9220d520ae9691b5e6c4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a92d8fb2d08cf9220d520ae9691b5e6c4">SENDMAIL</a></div><div class="ttdeci">#define SENDMAIL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00526">app_voicemail.c:526</a></div></div>
<div class="ttc" id="structuser_html"><div class="ttname"><a href="../../d8/dbc/structuser.html">user</a></div><div class="ttdoc">structure to hold users read from users.conf </div><div class="ttdef"><b>Definition:</b> <a href="../../d9/de9/res__phoneprov_8c_source.html#l00312">res_phoneprov.c:312</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9d1c2464eb2f95034fffe04efdeba7d6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9d1c2464eb2f95034fffe04efdeba7d6">mailbox_alias_mappings</a></div><div class="ttdeci">static struct ao2_container * mailbox_alias_mappings</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00971">app_voicemail.c:971</a></div></div>
<div class="ttc" id="pbx__realtime_8c_html_a10b51e1931bd03dd172cbfb9d3d67efb"><div class="ttname"><a href="../../d2/d2c/pbx__realtime_8c.html#a10b51e1931bd03dd172cbfb9d3d67efb">cleanup</a></div><div class="ttdeci">static void * cleanup(void *unused)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d2c/pbx__realtime_8c_source.html#l00124">pbx_realtime.c:124</a></div></div>
<div class="ttc" id="structheader_html"><div class="ttname"><a href="../../d5/d65/structheader.html">header</a></div><div class="ttdef"><b>Definition:</b> <a href="../../db/d73/pjsip__global__headers_8c_source.html#l00047">pjsip_global_headers.c:47</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad32ab72f58e10936461fcd7a696e1fae"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae">vm_intro_es</a></div><div class="ttdeci">static int vm_intro_es(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09976">app_voicemail.c:9976</a></div></div>
<div class="ttc" id="structast__flags_html"><div class="ttname"><a href="../../dc/dac/structast__flags.html">ast_flags</a></div><div class="ttdoc">Structure used to handle boolean flags. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00199">utils.h:199</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a393ce5ed70ef6339066d87cae2cd598b"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a></div><div class="ttdeci">static char listen_control_forward_key[12]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00976">app_voicemail.c:976</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a76b4d3927cacd1bcd5da9ca8fe375cb6"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a76b4d3927cacd1bcd5da9ca8fe375cb6">ast_app_has_voicemail</a></div><div class="ttdeci">int ast_app_has_voicemail(const char *mailboxes, const char *folder)</div><div class="ttdoc">Determine if a given mailbox has any voicemail If folder is NULL, defaults to &quot;INBOX&quot;. If folder is &quot;INBOX&quot;, includes the number of messages in the &quot;Urgent&quot; folder. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00655">main/app.c:655</a></div></div>
<div class="ttc" id="utils_8h_html_a7b260320610a09017a9416398acd0a70"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a></div><div class="ttdeci">#define ast_clear_flag(p, flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/utils_8h_source.html#l00077">utils.h:77</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae5b8df477c0090cd6966ff1a60907a09"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae5b8df477c0090cd6966ff1a60907a09">ERROR_MAX_MSGS</a></div><div class="ttdeci">#define ERROR_MAX_MSGS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00568">app_voicemail.c:568</a></div></div>
<div class="ttc" id="channel_8h_html_ad2334e69c466aec25ba3cbba53b7201b"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#ad2334e69c466aec25ba3cbba53b7201b">ast_channel_redirecting</a></div><div class="ttdeci">struct ast_party_redirecting * ast_channel_redirecting(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00908">channel_internal_api.c:908</a></div></div>
<div class="ttc" id="logger_8h_html"><div class="ttname"><a href="../../d1/d8c/logger_8h.html">logger.h</a></div><div class="ttdoc">Support for logging to various files, console and syslog Configuration in file logger.conf. </div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a67fca777538364c249bf1b66b2a22491"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491">ast_vm_snapshot_sort_val</a></div><div class="ttdeci">ast_vm_snapshot_sort_val</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00295">include/asterisk/app.h:295</a></div></div>
<div class="ttc" id="chan__mgcp_8c_html_ade5a89f9bee15a492c760ec1765a292d"><div class="ttname"><a href="../../d0/dd6/chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a></div><div class="ttdeci">static char cid_name[AST_MAX_EXTENSION]</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd6/chan__mgcp_8c_source.html#l00165">chan_mgcp.c:165</a></div></div>
<div class="ttc" id="res__phoneprov_8c_html_addaa208b0ed785225e24490fb9f28a80"><div class="ttname"><a href="../../d9/de9/res__phoneprov_8c.html#addaa208b0ed785225e24490fb9f28a80">AST_MODULE_INFO</a></div><div class="ttdeci">AST_MODULE_INFO(ASTERISK_GPL_KEY, AST_MODFLAG_GLOBAL_SYMBOLS|AST_MODFLAG_LOAD_ORDER, &quot;HTTP Phone Provisioning&quot;,.support_level=AST_MODULE_SUPPORT_EXTENDED,.load=load_module,.unload=unload_module,.reload=reload,.load_pri=AST_MODPRI_CHANNEL_DEPEND,.requires=&quot;http&quot;,)</div></div>
<div class="ttc" id="structtest_html"><div class="ttname"><a href="../../d8/d89/structtest.html">test</a></div><div class="ttdef"><b>Definition:</b> <a href="../../de/d7d/test__logger_8c_source.html#l00043">test_logger.c:43</a></div></div>
<div class="ttc" id="structleave__vm__options_html"><div class="ttname"><a href="../../dd/df7/structleave__vm__options.html">leave_vm_options</a></div><div class="ttdoc">Options for leaving voicemail with the voicemail() application. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/dfe/app__minivm_8c_source.html#l00650">app_minivm.c:650</a></div></div>
<div class="ttc" id="module_8h_html_a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b"><div class="ttname"><a href="../../d5/d16/module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d16/module_8h_source.html#l00315">module.h:315</a></div></div>
<div class="ttc" id="structast__cli__entry_html_aef1bd6ad890a110b466cb0e8088507a2"><div class="ttname"><a href="../../d8/d07/structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">ast_cli_entry::usage</a></div><div class="ttdeci">const char * usage</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00177">cli.h:177</a></div></div>
<div class="ttc" id="channel_8h_html_a018b7a29cef2d62074dc46e9aaad0d1a"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a018b7a29cef2d62074dc46e9aaad0d1a">ast_channel_exten_set</a></div><div class="ttdeci">void ast_channel_exten_set(struct ast_channel *chan, const char *value)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00357">channel_internal_api.c:357</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a27203edbc5e249fcac868c0488271b29"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a27203edbc5e249fcac868c0488271b29">read_password_from_file</a></div><div class="ttdeci">static void read_password_from_file(const char *secretfn, char *password, int passwordlen)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14396">app_voicemail.c:14396</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0c4c042c64d338b5f15956bff0fd2ff7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7">vm_intro_pl</a></div><div class="ttdeci">static int vm_intro_pl(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09768">app_voicemail.c:9768</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a57a3200e5b440d7135eaf0450ea559fe"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a57a3200e5b440d7135eaf0450ea559fe">ast_variable_append</a></div><div class="ttdeci">void ast_variable_append(struct ast_category *category, struct ast_variable *variable)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l01178">extconf.c:1178</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a16254e1237610f11047a7558bbe1f207"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a16254e1237610f11047a7558bbe1f207">ast_app_messagecount</a></div><div class="ttdeci">int ast_app_messagecount(const char *mailbox_id, const char *folder)</div><div class="ttdoc">Get the number of messages in a given mailbox folder. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00718">main/app.c:718</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8315b0ac46c7de2ae3b6b79bf8a9fcbc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a></div><div class="ttdeci">static int open_mailbox(struct vm_state *vms, struct ast_vm_user *vmu, int box)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09099">app_voicemail.c:9099</a></div></div>
<div class="ttc" id="pbx_8h_html_a6e5b90edb84d216267148dddcffe9b9a"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a6e5b90edb84d216267148dddcffe9b9a">pbx_builtin_setvar_helper</a></div><div class="ttdeci">int pbx_builtin_setvar_helper(struct ast_channel *chan, const char *name, const char *value)</div><div class="ttdoc">Add a variable to the channel variable stack, removing the most recently set value for the same name...</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d8c/pbx__variables_8c_source.html#l01071">pbx_variables.c:1071</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a673a6b1672bc6b5a12dd7270e1a4cee0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">vm_intro_pt_BR</a></div><div class="ttdeci">static int vm_intro_pt_BR(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10029">app_voicemail.c:10029</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_aa422e1cc73c1ac4db7ed8cd1a0e36e1a"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#aa422e1cc73c1ac4db7ed8cd1a0e36e1a">ast_category_append</a></div><div class="ttdeci">void ast_category_append(struct ast_config *config, struct ast_category *cat)</div><div class="ttdoc">Appends a category to a config. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc5/extconf_8c_source.html#l02835">extconf.c:2835</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aaf72c03f2d29edec82911c55bd7c01a7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a></div><div class="ttdeci">#define RETRIEVE(a, b, c, d)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00867">app_voicemail.c:867</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ace804dd195bf827b988e3f2282422d25"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ace804dd195bf827b988e3f2282422d25">VALID_DTMF</a></div><div class="ttdeci">#define VALID_DTMF</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00522">app_voicemail.c:522</a></div></div>
<div class="ttc" id="include_2asterisk_2frame_8h_html_af203379aca2fd704fe8d86a9445596b6"><div class="ttname"><a href="../../d6/d66/include_2asterisk_2frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a></div><div class="ttdeci">struct ast_frame ast_null_frame</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d55/main_2frame_8c_source.html#l00079">main/frame.c:79</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9286e529100ea42afa05db24311cf965"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9286e529100ea42afa05db24311cf965">vm_msg_snapshot_alloc</a></div><div class="ttdeci">static struct ast_vm_msg_snapshot * vm_msg_snapshot_alloc(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15748">app_voicemail.c:15748</a></div></div>
<div class="ttc" id="channel_8h_html_a050bec9a4abc1a599b6573a6091b080c"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a></div><div class="ttdeci">int ast_waitfordigit(struct ast_channel *c, int ms)</div><div class="ttdoc">Waits for a digit. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l03184">channel.c:3184</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ac665722c9bfe6d9b506df95184aa236da8022c0ca0ab8535428aed27423a40e2c"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da8022c0ca0ab8535428aed27423a40e2c">AST_RECORD_IF_EXISTS_OVERWRITE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01078">include/asterisk/app.h:1078</a></div></div>
<div class="ttc" id="structast__vm__functions_html_a4c2d9327de87c6be0b54f793adc7f1fb"><div class="ttname"><a href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">ast_vm_functions::module_name</a></div><div class="ttdeci">const char * module_name</div><div class="ttdoc">The name of the module that provides the voicemail functionality. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00548">include/asterisk/app.h:548</a></div></div>
<div class="ttc" id="structleave__vm__options_html_a809cc53dfc8e9f1204c67c26aabaa322"><div class="ttname"><a href="../../dd/df7/structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">leave_vm_options::record_gain</a></div><div class="ttdeci">signed char record_gain</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dfe/app__minivm_8c_source.html#l00652">app_minivm.c:652</a></div></div>
<div class="ttc" id="res__odbc_8h_html_ac4f32679338ee77cd43a130162456dbb"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html#ac4f32679338ee77cd43a130162456dbb">ast_odbc_execute_sql</a></div><div class="ttdeci">SQLRETURN ast_odbc_execute_sql(struct odbc_obj *obj, SQLHSTMT *stmt, const char *sql)</div><div class="ttdoc">Execute a nonprepared SQL query. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d4a/res__odbc_8c_source.html#l00478">res_odbc.c:478</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad280fc888537444d3ec8eaad8fb5e53"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53">vm_passwordlocation</a></div><div class="ttdeci">vm_passwordlocation</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00603">app_voicemail.c:603</a></div></div>
<div class="ttc" id="strings_8h_html_a8239b9ad10367bfc936e9b60ff7706a8"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a8239b9ad10367bfc936e9b60ff7706a8">ast_str_reset</a></div><div class="ttdeci">void ast_str_reset(struct ast_str *buf)</div><div class="ttdoc">Reset the content of a dynamic string. Useful before a series of ast_str_append. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00653">strings.h:653</a></div></div>
<div class="ttc" id="manager_8h_html_a0b1b4140c2836696a6950e92ab48a580"><div class="ttname"><a href="../../db/d45/manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a></div><div class="ttdeci">#define EVENT_FLAG_REPORTING</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d45/manager_8h_source.html#l00080">manager.h:80</a></div></div>
<div class="ttc" id="cli_8h_html_a50989f00b32eeb2516a3803cb2ffb766"><div class="ttname"><a href="../../dc/db0/cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a></div><div class="ttdeci">#define CLI_SUCCESS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00044">cli.h:44</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a9ff7aa27ae5f1a980bcf81f91cd6e470"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a9ff7aa27ae5f1a980bcf81f91cd6e470">ast_variable_retrieve</a></div><div class="ttdeci">const char * ast_variable_retrieve(struct ast_config *config, const char *category, const char *variable)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l00694">main/config.c:694</a></div></div>
<div class="ttc" id="strings_8h_html_aabc005bd1c7e249e8f8659d57d4500b6"><div class="ttname"><a href="../../d6/d90/strings_8h.html#aabc005bd1c7e249e8f8659d57d4500b6">ast_str_strlen</a></div><div class="ttdeci">size_t ast_str_strlen(const struct ast_str *buf)</div><div class="ttdoc">Returns the current length of the string stored within buf. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00688">strings.h:688</a></div></div>
<div class="ttc" id="cli_8h_html_ab33e5350a923c3a8cedbeb496cd88ec9a76bf33139279b03ec1691f2be2d1be40"><div class="ttname"><a href="../../dc/db0/cli_8h.html#ab33e5350a923c3a8cedbeb496cd88ec9a76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00153">cli.h:153</a></div></div>
<div class="ttc" id="res__odbc_8h_html_ad1e82a2b1ba4eda1924d8b8f591de065"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065">ast_odbc_prepare_and_execute</a></div><div class="ttdeci">SQLHSTMT ast_odbc_prepare_and_execute(struct odbc_obj *obj, SQLHSTMT(*prepare_cb)(struct odbc_obj *obj, void *data), void *data)</div><div class="ttdoc">Prepares, executes, and returns the resulting statement handle. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d4a/res__odbc_8c_source.html#l00407">res_odbc.c:407</a></div></div>
<div class="ttc" id="adsi_8h_html_ae053c0d0d34986cdafa06dab80d836b9"><div class="ttname"><a href="../../df/de2/adsi_8h.html#ae053c0d0d34986cdafa06dab80d836b9">ast_adsi_available</a></div><div class="ttdeci">int ast_adsi_available(struct ast_channel *chan)</div><div class="ttdoc">Returns non-zero if Channel does or might support ADSI. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00263">adsi.c:263</a></div></div>
<div class="ttc" id="include_2asterisk_2compat_8h_html_a40eca58273c74a20a17f137d18ba826c"><div class="ttname"><a href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a></div><div class="ttdeci">char * strsep(char **str, const char *delims)</div></div>
<div class="ttc" id="structast__vm__recording__data_html"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html">ast_vm_recording_data</a></div><div class="ttdoc">Structure used for ast_copy_recording_to_vm in order to cleanly supply data needed for making the rec...</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00090">include/asterisk/app.h:90</a></div></div>
<div class="ttc" id="structast__vm__user_html_a0d189d088982b574837ebaee7cd4ccbd"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">ast_vm_user::serveremail</a></div><div class="ttdeci">char serveremail[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00764">app_voicemail.c:764</a></div></div>
<div class="ttc" id="structast__taskprocessor_html"><div class="ttname"><a href="../../db/d17/structast__taskprocessor.html">ast_taskprocessor</a></div><div class="ttdoc">A ast_taskprocessor structure is a singleton by name. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/deb/taskprocessor_8c_source.html#l00069">taskprocessor.c:69</a></div></div>
<div class="ttc" id="taskprocessor_8h_html_a6b2508ba0a6b8f43ae6d3963f3189585"><div class="ttname"><a href="../../d0/d1e/taskprocessor_8h.html#a6b2508ba0a6b8f43ae6d3963f3189585">ast_taskprocessor_push</a></div><div class="ttdeci">int ast_taskprocessor_push(struct ast_taskprocessor *tps, int(*task_exe)(void *datap), void *datap) attribute_warn_unused_result</div><div class="ttdoc">Push a task into the specified taskprocessor queue and signal the taskprocessor thread. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/deb/taskprocessor_8c_source.html#l01175">taskprocessor.c:1175</a></div></div>
<div class="ttc" id="structkeys_html"><div class="ttname"><a href="../../d2/df1/structkeys.html">keys</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d7/dbb/res__crypto_8c_source.html#l00094">res_crypto.c:94</a></div></div>
<div class="ttc" id="structast__filestream_html"><div class="ttname"><a href="../../db/dbc/structast__filestream.html">ast_filestream</a></div><div class="ttdoc">This structure is allocated by file.c in one chunk, together with buf_size and desc_size bytes of mem...</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d5d/mod__format_8h_source.html#l00101">mod_format.h:101</a></div></div>
<div class="ttc" id="utils_2frame_8c_html_a48bc11919b2752df9d14ce89557cfb25"><div class="ttname"><a href="../../d6/d47/utils_2frame_8c.html#a48bc11919b2752df9d14ce89557cfb25">out</a></div><div class="ttdeci">FILE * out</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d47/utils_2frame_8c_source.html#l00033">utils/frame.c:33</a></div></div>
<div class="ttc" id="structast__vm__user_html_aef31b648e7b4ff25544d343ac1ff926e"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">ast_vm_user::attachfmt</a></div><div class="ttdeci">char attachfmt[20]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00773">app_voicemail.c:773</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_adaba37f7e2da2832461a35139379eae1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a></div><div class="ttdeci">static int vmmaxsecs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00930">app_voicemail.c:930</a></div></div>
<div class="ttc" id="structao2__iterator_html"><div class="ttname"><a href="../../d9/d97/structao2__iterator.html">ao2_iterator</a></div><div class="ttdoc">When we need to walk through a container, we use an ao2_iterator to keep track of the current positio...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01841">astobj2.h:1841</a></div></div>
<div class="ttc" id="astobj2_8h_html_a6321ee982370c55ab3c24c72c562cbdd"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a></div><div class="ttdeci">#define ao2_cleanup(obj)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01958">astobj2.h:1958</a></div></div>
<div class="ttc" id="say_8h_html_a899e1f86b2d65a32eeb6e17aabfa1f12"><div class="ttname"><a href="../../db/dce/say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12">ast_say_number</a></div><div class="ttdeci">int ast_say_number(struct ast_channel *chan, int num, const char *ints, const char *lang, const char *options)</div><div class="ttdoc">says a number </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l08337">channel.c:8337</a></div></div>
<div class="ttc" id="cli_8h_html"><div class="ttname"><a href="../../dc/db0/cli_8h.html">cli.h</a></div><div class="ttdoc">Standard Command Line Interface. </div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a944fdb5d328401dee4c35ebd413d3bc3"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3">ast_destroy_realtime</a></div><div class="ttdeci">int ast_destroy_realtime(const char *family, const char *keyfield, const char *lookup,...) attribute_sentinel</div><div class="ttdoc">Destroy realtime configuration. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l03606">main/config.c:3606</a></div></div>
<div class="ttc" id="structinprocess_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="../../de/d24/structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">inprocess::count</a></div><div class="ttdeci">int count</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01113">app_voicemail.c:1113</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae092e449709dbba8ef9a27ce9531b1d7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a></div><div class="ttdeci">static int has_voicemail(const char *mailbox, const char *folder)</div><div class="ttdoc">Determines if the given folder has messages. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06124">app_voicemail.c:6124</a></div></div>
<div class="ttc" id="channel_8h_html_aca211972dac7b8f3f08a283bfe0aa8bf"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#aca211972dac7b8f3f08a283bfe0aa8bf">ast_channel_context_set</a></div><div class="ttdeci">void ast_channel_context_set(struct ast_channel *chan, const char *value)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00348">channel_internal_api.c:348</a></div></div>
<div class="ttc" id="app__audiosocket_8c_html_aec23fc5034c3bb08140fc021f4955877"><div class="ttname"><a href="../../d9/daa/app__audiosocket_8c.html#aec23fc5034c3bb08140fc021f4955877">AST_MODULE</a></div><div class="ttdeci">#define AST_MODULE</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/daa/app__audiosocket_8c_source.html#l00045">app_audiosocket.c:45</a></div></div>
<div class="ttc" id="strings_8h_html_ac4040268f7b6ed77dfc49c7767626369"><div class="ttname"><a href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a></div><div class="ttdeci">void ast_copy_string(char *dst, const char *src, size_t size)</div><div class="ttdoc">Size-limited null-terminating string copy. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00401">strings.h:401</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abf3444228de1ea70778be8dbea3cee15"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">start_poll_thread</a></div><div class="ttdeci">static void start_poll_thread(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13197">app_voicemail.c:13197</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a831a6a1e183f3f25a93692de2fdc5404"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">vm_intro_zh</a></div><div class="ttdeci">static int vm_intro_zh(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10292">app_voicemail.c:10292</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aabf07ec03610021ae7c6f07e486ae9d9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9">vm_play_folder_name_pl</a></div><div class="ttdeci">static int vm_play_folder_name_pl(struct ast_channel *chan, char *box)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09299">app_voicemail.c:9299</a></div></div>
<div class="ttc" id="structvm__state_html"><div class="ttname"><a href="../../dd/d8f/structvm__state.html">vm_state</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00806">app_voicemail.c:806</a></div></div>
<div class="ttc" id="strings_8h_html_a2faaa16929951bfd2802b7829a100ba2"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a></div><div class="ttdeci">#define S_OR(a, b)</div><div class="ttdoc">returns the equivalent of logic or for strings: first one if not empty, otherwise second one...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00079">strings.h:79</a></div></div>
<div class="ttc" id="taskprocessor_8h_html_a32492eb2480cb8c46ad669622cff8556"><div class="ttname"><a href="../../d0/d1e/taskprocessor_8h.html#a32492eb2480cb8c46ad669622cff8556">ast_taskprocessor_unreference</a></div><div class="ttdeci">void * ast_taskprocessor_unreference(struct ast_taskprocessor *tps)</div><div class="ttdoc">Unreference the specified taskprocessor and its reference count will decrement. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/deb/taskprocessor_8c_source.html#l01109">taskprocessor.c:1109</a></div></div>
<div class="ttc" id="logger_8h_html_a739c2b2152120f3ac341424b9a595562"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#a739c2b2152120f3ac341424b9a595562">AST_LOG_DEBUG</a></div><div class="ttdeci">#define AST_LOG_DEBUG</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00246">logger.h:246</a></div></div>
<div class="ttc" id="structast__app_html"><div class="ttname"><a href="../../d0/da3/structast__app.html">ast_app</a></div><div class="ttdoc">ast_app: A registered application </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d16/pbx__app_8c_source.html#l00045">pbx_app.c:45</a></div></div>
<div class="ttc" id="structast__vm__user_html_a252682ca5737fd5b54db768e742bac81"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">ast_vm_user::uniqueid</a></div><div class="ttdeci">char uniqueid[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00771">app_voicemail.c:771</a></div></div>
<div class="ttc" id="channel_8h_html_a7ca2fda13b129a55c251b56729de285b"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a></div><div class="ttdeci">const char * ast_channel_name(const struct ast_channel *chan)</div></div>
<div class="ttc" id="app__voicemail_8c_html_a6780ac062d86803af3bdc7f9525ffb37"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a></div><div class="ttdeci">static struct ast_vm_user * find_or_create(const char *context, const char *box)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12385">app_voicemail.c:12385</a></div></div>
<div class="ttc" id="strings_8h_html_a6c3dc0bad204e9dd9890325c1c861e38"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38">ast_false</a></div><div class="ttdeci">int attribute_pure ast_false(const char *val)</div><div class="ttdoc">Make sure something is false. Determine if a string containing a boolean value is &quot;false&quot;...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l01968">main/utils.c:1968</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7b7715fe7d49edf843394ee1232f7de1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">vm_lock_path</a></div><div class="ttdeci">static int vm_lock_path(const char *path)</div><div class="ttdoc">Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not if the path does not exist...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l03729">app_voicemail.c:3729</a></div></div>
<div class="ttc" id="structast__cli__args_html_a4b911d12699acbbb5a8b62355b35bae8"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html#a4b911d12699acbbb5a8b62355b35bae8">ast_cli_args::pos</a></div><div class="ttdeci">const int pos</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00164">cli.h:164</a></div></div>
<div class="ttc" id="structast__mwi__observer_html"><div class="ttname"><a href="../../d1/dbb/structast__mwi__observer.html">ast_mwi_observer</a></div><div class="ttdoc">MWI state event interface. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00252">mwi.h:252</a></div></div>
<div class="ttc" id="group__StasisTopicsAndMessages_html_ga70de9f16a229e2c5bf1a973372949d3e"><div class="ttname"><a href="../../df/deb/group__StasisTopicsAndMessages.html#ga70de9f16a229e2c5bf1a973372949d3e">ast_mwi_state::new_msgs</a></div><div class="ttdeci">int new_msgs</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00461">mwi.h:461</a></div></div>
<div class="ttc" id="file_8h_html_affc21cb57c6bf72a2cb7ec8a379b2137"><div class="ttname"><a href="../../d2/d4d/file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137">ast_waitstream</a></div><div class="ttdeci">int ast_waitstream(struct ast_channel *c, const char *breakon)</div><div class="ttdoc">Waits for a stream to stop or digit to be pressed. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01776">file.c:1776</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab38caff0330c37e2ce31314733755404"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">vm_options</a></div><div class="ttdeci">static int vm_options(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10744">app_voicemail.c:10744</a></div></div>
<div class="ttc" id="file_8h_html_ab9b8ab8e5ee34c9b4da25779255cafde"><div class="ttname"><a href="../../d2/d4d/file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde">ast_fileexists</a></div><div class="ttdeci">int ast_fileexists(const char *filename, const char *fmt, const char *preflang)</div><div class="ttdoc">Checks for the existence of a given file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01086">file.c:1086</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a17fd24c96e8f7a2a8ec8190f40dbbcba"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba">handle_voicemail_reload</a></div><div class="ttdeci">static char * handle_voicemail_reload(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</div><div class="ttdoc">Reload voicemail configuration from the CLI. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13020">app_voicemail.c:13020</a></div></div>
<div class="ttc" id="group__StasisTopicsAndMessages_html_ga753c7b39e3284d771f13f513b003d033"><div class="ttname"><a href="../../df/deb/group__StasisTopicsAndMessages.html#ga753c7b39e3284d771f13f513b003d033">ast_mwi_state::uniqueid</a></div><div class="ttdeci">const ast_string_field uniqueid</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00460">mwi.h:460</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0aef50eb58931d34f6a6d4ad18182d7c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a></div><div class="ttdeci">#define EXISTS(a, b, c, d)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00870">app_voicemail.c:870</a></div></div>
<div class="ttc" id="structast__vm__user_html_a13b594c1beccc30477c646a703f17d71"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">ast_vm_user::callback</a></div><div class="ttdeci">char callback[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00769">app_voicemail.c:769</a></div></div>
<div class="ttc" id="mwi_8h_html"><div class="ttname"><a href="../../dc/d33/mwi_8h.html">mwi.h</a></div><div class="ttdoc">Asterisk MWI API. </div></div>
<div class="ttc" id="app__voicemail_8c_html_a8dd478366d9ea311c99d0e564bfb1cee"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8dd478366d9ea311c99d0e564bfb1cee">free_user_final</a></div><div class="ttdeci">static void free_user_final(struct ast_vm_user *vmu)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l02008">app_voicemail.c:2008</a></div></div>
<div class="ttc" id="hsearch_8c_html_ad0f0f85b3cab490a81baa02c4b9edf45"><div class="ttname"><a href="../../db/d37/hsearch_8c.html#ad0f0f85b3cab490a81baa02c4b9edf45">retval</a></div><div class="ttdeci">static ENTRY retval</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d37/hsearch_8c_source.html#l00050">hsearch.c:50</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a491df09940a15d84df48c9c1e683acca"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a></div><div class="ttdeci">#define VM_SKIPAFTERCMD</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00554">app_voicemail.c:554</a></div></div>
<div class="ttc" id="channel_8h_html_aec583a3e25358ee552a4f3df53914cd0"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#aec583a3e25358ee552a4f3df53914cd0">ast_answer</a></div><div class="ttdeci">int ast_answer(struct ast_channel *chan)</div><div class="ttdoc">Answer a channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l02814">channel.c:2814</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac5e05af0fcfd551b8996cad383a2a56c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">vm_browse_messages_he</a></div><div class="ttdeci">static int vm_browse_messages_he(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10991">app_voicemail.c:10991</a></div></div>
<div class="ttc" id="structodbc__obj_html_a35f93192e944901f5d3da32e8e937902"><div class="ttname"><a href="../../df/d36/structodbc__obj.html#a35f93192e944901f5d3da32e8e937902">odbc_obj::next</a></div><div class="ttdeci">struct odbc_obj * next</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d96/res__odbc_8h_source.html#l00055">res_odbc.h:55</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4c15fe41c8c6d5f4bd864ecec999afdc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a></div><div class="ttdeci">static char * pagersubject</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01019">app_voicemail.c:1019</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae8319c0fa0dcbae2fa2039e6a61ed7bb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a></div><div class="ttdeci">static int dialout(struct ast_channel *chan, struct ast_vm_user *vmu, char *num, char *outgoing_context)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15233">app_voicemail.c:15233</a></div></div>
<div class="ttc" id="structast__vm__user_html_a9c53251b14e2c73274d41136b84ca816"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">ast_vm_user::emailsubject</a></div><div class="ttdeci">char * emailsubject</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00761">app_voicemail.c:761</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8aaeb2a0ce8bd9fc6543ba7547ea2cfd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a></div><div class="ttdeci">#define BASEMAXINLINE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00538">app_voicemail.c:538</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a11889eb6139e5f1151409abc2b076aa8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">show_users_realtime</a></div><div class="ttdeci">static char * show_users_realtime(int fd, const char *context)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12806">app_voicemail.c:12806</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a85d50dd448c64ed2edf77efc42dc51fa"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a></div><div class="ttdeci">static int __has_voicemail(const char *context, const char *mailbox, const char *folder, int shortcircuit)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06061">app_voicemail.c:6061</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7b5b2246bf0b55e177486fa6beb330cc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">append_mailbox</a></div><div class="ttdeci">static int append_mailbox(const char *context, const char *box, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12425">app_voicemail.c:12425</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64">vm_box</a></div><div class="ttdeci">vm_box</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00571">app_voicemail.c:571</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aac932b3188d5baf5f0f91b47ee656b79"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a></div><div class="ttdeci">static int inboxcount(const char *mailbox, int *newmsgs, int *oldmsgs)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06224">app_voicemail.c:6224</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_ad9fd2625614158b152434e45acf1d78b"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#ad9fd2625614158b152434e45acf1d78b">ast_config_option</a></div><div class="ttdeci">const char * ast_config_option(struct ast_config *cfg, const char *cat, const char *var)</div><div class="ttdoc">Retrieve a configuration variable within the configuration set. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l00684">main/config.c:684</a></div></div>
<div class="ttc" id="res__corosync_8c_html_a8e51289dd0fc7415cee40e7a57b49fdf"><div class="ttname"><a href="../../d1/da4/res__corosync_8c.html#a8e51289dd0fc7415cee40e7a57b49fdf">sub</a></div><div class="ttdeci">struct stasis_forward * sub</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/da4/res__corosync_8c_source.html#l00240">res_corosync.c:240</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ab5fdc062c2a85b1d3739a861d3d3232f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a></div><div class="ttdeci">static void vm_change_password_shell(struct ast_vm_user *vmu, char *newpassword)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01876">app_voicemail.c:1876</a></div></div>
<div class="ttc" id="structast__frame_html"><div class="ttname"><a href="../../d0/d99/structast__frame.html">ast_frame</a></div><div class="ttdoc">Data structure associated with a single frame of data. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d66/include_2asterisk_2frame_8h_source.html#l00165">include/asterisk/frame.h:165</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae5938cc449b29ca82b939b7d746b5689"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a></div><div class="ttdeci">#define MAXMSGLIMIT</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00533">app_voicemail.c:533</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849eae46e13cc6d4a1bfd34b1a4a939cf64f3"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849eae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00586">app_voicemail.c:586</a></div></div>
<div class="ttc" id="file_8h_html_ad572060ea434390db3d1ccde4511dfcd"><div class="ttname"><a href="../../d2/d4d/file_8h.html#ad572060ea434390db3d1ccde4511dfcd">ast_readfile</a></div><div class="ttdeci">struct ast_filestream * ast_readfile(const char *filename, const char *type, const char *comment, int flags, int check, mode_t mode)</div><div class="ttdoc">Starts reading from a file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01309">file.c:1309</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad280fc888537444d3ec8eaad8fb5e53a4ea71034662c0e0c184ccfbd68c9e519"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad280fc888537444d3ec8eaad8fb5e53a4ea71034662c0e0c184ccfbd68c9e519">OPT_PWLOC_USERSCONF</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00606">app_voicemail.c:606</a></div></div>
<div class="ttc" id="channel_8h_html_a9abe31fe40dcd03cd2957e5309e32ac6"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a></div><div class="ttdeci">const char * ast_channel_language(const struct ast_channel *chan)</div></div>
<div class="ttc" id="app__voicemail_8c_html_af1678d06f5af8cd60ec0ff15490331ab"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a></div><div class="ttdeci">#define VM_ALLOCED</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00561">app_voicemail.c:561</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a120b9c8ba5c2f37645d9d3683655e9f9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a120b9c8ba5c2f37645d9d3683655e9f9">VMSTATE_MAX_MSG_ARRAY</a></div><div class="ttdeci">#define VMSTATE_MAX_MSG_ARRAY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00803">app_voicemail.c:803</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac9d8114df0acde590ff96c9c3758b6fe"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe">sendpage</a></div><div class="ttdeci">static int sendpage(char *srcemail, char *pager, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, int duration, struct ast_vm_user *vmu, const char *category, const char *flag)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05571">app_voicemail.c:5571</a></div></div>
<div class="ttc" id="structast__vm__functions_html_a19dd3d3916fd1aa9a70c45c43d24b6f5"><div class="ttname"><a href="../../df/d7c/structast__vm__functions.html#a19dd3d3916fd1aa9a70c45c43d24b6f5">ast_vm_functions::module_version</a></div><div class="ttdeci">unsigned int module_version</div><div class="ttdoc">The version of this function table. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00546">include/asterisk/app.h:546</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0265d0e785a2da7fb9857b6be6f8d6e1"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">vm_password</a></div><div class="ttdeci">static char vm_password[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00985">app_voicemail.c:985</a></div></div>
<div class="ttc" id="structast__cli__args_html"><div class="ttname"><a href="../../d3/dad/structast__cli__args.html">ast_cli_args</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00158">cli.h:158</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a777bfeec35518998fe5509e9a266216c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c">adsi_load_vmail</a></div><div class="ttdeci">static int adsi_load_vmail(struct ast_channel *chan, int *useadsi)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07319">app_voicemail.c:7319</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a44be24993dd8a1b6ba1dbbf5963be7f7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7">play_message_category</a></div><div class="ttdeci">static int play_message_category(struct ast_channel *chan, const char *category)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08623">app_voicemail.c:8623</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad10d8bd23492e02853159d49d2956c6"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6">handle_voicemail_show_zones</a></div><div class="ttdeci">static char * handle_voicemail_show_zones(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</div><div class="ttdoc">Show a list of voicemail zones in the CLI. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12944">app_voicemail.c:12944</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5e790f0ee1dbde79705c49bf33a1060d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5e790f0ee1dbde79705c49bf33a1060d">ASTERISK_USERNAME</a></div><div class="ttdeci">#define ASTERISK_USERNAME</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00512">app_voicemail.c:512</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac663639047fe35b19abc88a4c6a9c0fb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a></div><div class="ttdeci">#define VM_DIRECFORWARD</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00558">app_voicemail.c:558</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad7a947388a2ca648ab06fc5c510524d4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a></div><div class="ttdeci">#define VOICEMAIL_FILE_MODE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00508">app_voicemail.c:508</a></div></div>
<div class="ttc" id="file_8h_html_a57ea6065cde7fb5258c1f6a4595643ba"><div class="ttname"><a href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a></div><div class="ttdeci">int ast_filerename(const char *oldname, const char *newname, const char *fmt)</div><div class="ttdoc">Renames a file. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l01103">file.c:1103</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a65bc5b2d2cc590500653759b41108ac4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a65bc5b2d2cc590500653759b41108ac4">mwi_observer</a></div><div class="ttdeci">struct ast_mwi_observer mwi_observer</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13192">app_voicemail.c:13192</a></div></div>
<div class="ttc" id="channel_8h_html_a582dee4d5ea9b2ff6f309f0c5239f6bd"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a></div><div class="ttdeci">const char * ast_channel_context(const struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00344">channel_internal_api.c:344</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ad390f774c486c5adb506f2862564c57a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a></div><div class="ttdeci">#define PWDCHANGE_EXTERNAL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00886">app_voicemail.c:886</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa93908872a830d4aecaca36f45bd0273"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273">vm_forwardoptions</a></div><div class="ttdeci">static int vm_forwardoptions(struct ast_channel *chan, struct ast_vm_user *vmu, char *curdir, int curmsg, char *vm_fmts, char *context, signed char record_gain, long *duration, struct vm_state *vms, char *flag)</div><div class="ttdoc">presents the option to prepend to an existing message when forwarding it. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07948">app_voicemail.c:7948</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9609372d445390793d9721bf721b9ccb"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">is_valid_dtmf</a></div><div class="ttdeci">static int is_valid_dtmf(const char *key)</div><div class="ttdoc">Determines if a DTMF key entered is valid. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01592">app_voicemail.c:1592</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a368cc0cb8f1c6fa742a6c6741ceb874e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a368cc0cb8f1c6fa742a6c6741ceb874e">UPDATE_MSG_ID</a></div><div class="ttdeci">#define UPDATE_MSG_ID(a, b, c, d, e, f)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00874">app_voicemail.c:874</a></div></div>
<div class="ttc" id="app__queue_8c_html_acd1f0e9b4730ec60f62cb0806cb06ef1"><div class="ttname"><a href="../../da/dfb/app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a></div><div class="ttdeci">enum queue_result id</div><div class="ttdef"><b>Definition:</b> <a href="../../da/dfb/app__queue_8c_source.html#l01507">app_queue.c:1507</a></div></div>
<div class="ttc" id="linkedlists_8h_html_aa5be52067bf16bdc7e56ca19b5ba858d"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a></div><div class="ttdeci">#define AST_LIST_TRAVERSE_SAFE_BEGIN(head, var, field)</div><div class="ttdoc">Loops safely over (traverses) the entries in a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00528">linkedlists.h:528</a></div></div>
<div class="ttc" id="asterisk_8h_html_ae688d728e1acdfe5988c7db45d6f0166"><div class="ttname"><a href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a></div><div class="ttdeci">#define PATH_MAX</div><div class="ttdef"><b>Definition:</b> <a href="../../db/db2/asterisk_8h_source.html#l00040">asterisk.h:40</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ae48d2d40fd20f61d2324906383df2d6e"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ae48d2d40fd20f61d2324906383df2d6e">vm_mailbox_snapshot_create</a></div><div class="ttdeci">static struct ast_vm_mailbox_snapshot * vm_mailbox_snapshot_create(const char *mailbox, const char *context, const char *folder, int descending, enum ast_vm_snapshot_sort_val sort_val, int combine_INBOX_and_OLD)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15931">app_voicemail.c:15931</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4ace316d9392f91668365780d1c2d020"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4ace316d9392f91668365780d1c2d020">vm_exec</a></div><div class="ttdeci">static int vm_exec(struct ast_channel *chan, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12278">app_voicemail.c:12278</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_ab72e1828c8ae3ac5b663c22ac5f7f7eb"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#ab72e1828c8ae3ac5b663c22ac5f7f7eb">ast_vm_recording_data::call_context</a></div><div class="ttdeci">const ast_string_field call_context</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="adsi_8h_html_abbaf47d66d63f4844a68ddfa8209e73e"><div class="ttname"><a href="../../df/de2/adsi_8h.html#abbaf47d66d63f4844a68ddfa8209e73e">ast_adsi_input_control</a></div><div class="ttdeci">int ast_adsi_input_control(unsigned char *buf, int page, int line, int display, int format, int just)</div><div class="ttdoc">Set input information. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00318">adsi.c:318</a></div></div>
<div class="ttc" id="structast__vm__user_html_a162e24ed53cba3299d6623f91c8910d9"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">ast_vm_user::fullname</a></div><div class="ttdeci">char fullname[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00759">app_voicemail.c:759</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a9b7212bac1c90a7a89c6e8c87792c3db"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a9b7212bac1c90a7a89c6e8c87792c3db">HVSZ_OUTPUT_FORMAT</a></div><div class="ttdeci">#define HVSZ_OUTPUT_FORMAT</div></div>
<div class="ttc" id="lock_8h_html_a76e8ed6bb354be6c6dd9e51acc1d7a1b"><div class="ttname"><a href="../../dd/d42/lock_8h.html#a76e8ed6bb354be6c6dd9e51acc1d7a1b">ast_mutex_init</a></div><div class="ttdeci">#define ast_mutex_init(pmutex)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00184">lock.h:184</a></div></div>
<div class="ttc" id="structao2__container_html"><div class="ttname"><a href="../../d2/da9/structao2__container.html">ao2_container</a></div><div class="ttdoc">Generic container type. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d20/astobj2__container__private_8h_source.html#l00282">astobj2_container_private.h:282</a></div></div>
<div class="ttc" id="strings_8h_html_afe8f5f844f2fd5f5bd5d0be5ef671481"><div class="ttname"><a href="../../d6/d90/strings_8h.html#afe8f5f844f2fd5f5bd5d0be5ef671481">ast_str_thread_get</a></div><div class="ttdeci">struct ast_str * ast_str_thread_get(struct ast_threadstorage *ts, size_t init_len)</div><div class="ttdoc">Retrieve a thread locally stored dynamic string. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00861">strings.h:861</a></div></div>
<div class="ttc" id="structast__party__name_html_aaa04218f9e3a9065afa8be2491da8904"><div class="ttname"><a href="../../d8/d6f/structast__party__name.html#aaa04218f9e3a9065afa8be2491da8904">ast_party_name::valid</a></div><div class="ttdeci">unsigned char valid</div><div class="ttdoc">TRUE if the name information is valid/present. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00280">channel.h:280</a></div></div>
<div class="ttc" id="structleave__vm__options_html_af6bfb925eef61f402344b58d506fe856"><div class="ttname"><a href="../../dd/df7/structleave__vm__options.html#af6bfb925eef61f402344b58d506fe856">leave_vm_options::beeptone</a></div><div class="ttdeci">char * beeptone</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l06288">app_voicemail.c:6288</a></div></div>
<div class="ttc" id="test__http__media__cache_8c_html_a80c8e3ae5087d90d422675d034eeebc7"><div class="ttname"><a href="../../d4/d45/test__http__media__cache_8c.html#a80c8e3ae5087d90d422675d034eeebc7">options</a></div><div class="ttdeci">static struct test_options options</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d45/test__http__media__cache_8c_source.html#l00062">test_http_media_cache.c:62</a></div></div>
<div class="ttc" id="smdi_8h_html_a9debceb53aa38da429365ca91e50cd35"><div class="ttname"><a href="../../dc/dca/smdi_8h.html#a9debceb53aa38da429365ca91e50cd35">ast_smdi_mwi_unset</a></div><div class="ttdeci">int ast_smdi_mwi_unset(struct ast_smdi_interface *iface, const char *mailbox)</div><div class="ttdoc">Unset the MWI indicator for a mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d96/res__smdi_8c_source.html#l00314">res_smdi.c:314</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a13d1fdecce26d4bee1b43cff66d1c544"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">VM_FWDURGAUTO</a></div><div class="ttdeci">#define VM_FWDURGAUTO</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00566">app_voicemail.c:566</a></div></div>
<div class="ttc" id="chan__alsa_8c_html_ac25ea00ee3f082df06e0cf468cbde240"><div class="ttname"><a href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a></div><div class="ttdeci">static char context[AST_MAX_CONTEXT]</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d45/chan__alsa_8c_source.html#l00116">chan_alsa.c:116</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aea7a0b8f32697c42dd05115e26a114d8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aea7a0b8f32697c42dd05115e26a114d8">vm_msg_move</a></div><div class="ttdeci">static int vm_msg_move(const char *mailbox, const char *context, size_t num_msgs, const char *oldfolder, const char *old_msg_ids[], const char *newfolder)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16285">app_voicemail.c:16285</a></div></div>
<div class="ttc" id="channel_8h_html_ae68c6e4af7aba456ec08906cb9fb3140"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a></div><div class="ttdeci">int ast_readstring(struct ast_channel *c, char *s, int len, int timeout, int rtimeout, char *enders)</div><div class="ttdoc">Reads multiple digits. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l06655">channel.c:6655</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_aca036489931bf5571e2472331c8ac80b"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#aca036489931bf5571e2472331c8ac80b">AST_APP_OPTION</a></div><div class="ttdeci">#define AST_APP_OPTION(option, flagno)</div><div class="ttdoc">Declares an application option that does not accept an argument. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01402">include/asterisk/app.h:1402</a></div></div>
<div class="ttc" id="lock_8h_html_ab8977a71822daa556f19f30ba6eec765"><div class="ttname"><a href="../../dd/d42/lock_8h.html#ab8977a71822daa556f19f30ba6eec765">ast_mutex_destroy</a></div><div class="ttdeci">#define ast_mutex_destroy(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00186">lock.h:186</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7f75e8f7c2c64f3b17397c3117fe2799"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7f75e8f7c2c64f3b17397c3117fe2799">acf_vm_info</a></div><div class="ttdeci">static int acf_vm_info(struct ast_channel *chan, const char *cmd, char *args, char *buf, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12679">app_voicemail.c:12679</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3cf5a09db1d2106c64a9bba41797ba69"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3cf5a09db1d2106c64a9bba41797ba69">vm_login</a></div><div class="ttdeci">static char vm_login[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00983">app_voicemail.c:983</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a976052ba6bdad7e94e60cd4bc1c3f3b2"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a976052ba6bdad7e94e60cd4bc1c3f3b2">ast_category_get</a></div><div class="ttdeci">struct ast_category * ast_category_get(const struct ast_config *config, const char *category_name, const char *filter)</div><div class="ttdoc">Retrieve a category if it exists. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d9d/main_2config_8c_source.html#l01022">main/config.c:1022</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa3e040b5c57658872817f5859bc653d4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a></div><div class="ttdeci">static unsigned char poll_thread_run</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00950">app_voicemail.c:950</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a83bcf8b9ba093cbeda85ae8621dbd5fa"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a83bcf8b9ba093cbeda85ae8621dbd5fa">message_range_and_existence_check</a></div><div class="ttdeci">static int message_range_and_existence_check(struct vm_state *vms, const char *msg_ids [], size_t num_msgs, int *msg_nums, struct ast_vm_user *vmu)</div><div class="ttdoc">common bounds checking and existence check for Voicemail API functions. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l16082">app_voicemail.c:16082</a></div></div>
<div class="ttc" id="linkedlists_8h_html_a83227c4f8c836f0452b607507c55752f"><div class="ttname"><a href="../../df/d90/linkedlists_8h.html#a83227c4f8c836f0452b607507c55752f">AST_LIST_INSERT_BEFORE_CURRENT</a></div><div class="ttdeci">#define AST_LIST_INSERT_BEFORE_CURRENT(elm, field)</div><div class="ttdoc">Inserts a list entry before the current entry during a traversal. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d90/linkedlists_8h_source.html#l00598">linkedlists.h:598</a></div></div>
<div class="ttc" id="adsi_8h_html_a4cd092c7df03685491cb6f7c145654cd"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a4cd092c7df03685491cb6f7c145654cd">ast_adsi_unload_session</a></div><div class="ttdeci">int ast_adsi_unload_session(struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d78/adsi_8c_source.html#l00087">adsi.c:87</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa3dbfac8e2b5d54afabfa52585d42873"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa3dbfac8e2b5d54afabfa52585d42873">vm_test_create_user</a></div><div class="ttdeci">static int vm_test_create_user(const char *context, const char *mailbox)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l15792">app_voicemail.c:15792</a></div></div>
<div class="ttc" id="say_8h_html_ab73ba7bbfc3824448a2cd4f0c6d050c6ade020c4d50637c2dd5eeb9dc7905a04f"><div class="ttname"><a href="../../db/dce/say_8h.html#ab73ba7bbfc3824448a2cd4f0c6d050c6ade020c4d50637c2dd5eeb9dc7905a04f">AST_SAY_CASE_NONE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../db/dce/say_8h_source.html#l00163">say.h:163</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4cdc273d6b190940a91df6042d385099"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a></div><div class="ttdeci">static int maxmsg</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00920">app_voicemail.c:920</a></div></div>
<div class="ttc" id="channel_8h_html_adf593d68a333075c1fcae8a73b68c069"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#adf593d68a333075c1fcae8a73b68c069">ast_channel_macrocontext</a></div><div class="ttdeci">const char * ast_channel_macrocontext(const struct ast_channel *chan)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00362">channel_internal_api.c:362</a></div></div>
<div class="ttc" id="res__odbc_8h_html_a78d14d1dd01c269c9c0a47b49475eeea"><div class="ttname"><a href="../../de/d96/res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea">ast_odbc_release_obj</a></div><div class="ttdeci">void ast_odbc_release_obj(struct odbc_obj *obj)</div><div class="ttdoc">Releases an ODBC object previously allocated by ast_odbc_request_obj() </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d4a/res__odbc_8c_source.html#l00813">res_odbc.c:813</a></div></div>
<div class="ttc" id="structast__mwi__state_html"><div class="ttname"><a href="../../d6/d45/structast__mwi__state.html">ast_mwi_state</a></div><div class="ttdoc">The structure that contains MWI state. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d33/mwi_8h_source.html#l00457">mwi.h:457</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4828365cfe2e6c17f8c6371761cdb990"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4828365cfe2e6c17f8c6371761cdb990">fake_read</a></div><div class="ttdeci">static struct ast_frame * fake_read(struct ast_channel *ast)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l14475">app_voicemail.c:14475</a></div></div>
<div class="ttc" id="pbx_8h_html_ad4a6912dcd2ad44a186d0a284afafc51"><div class="ttname"><a href="../../db/de0/pbx_8h.html#ad4a6912dcd2ad44a186d0a284afafc51">pbx_findapp</a></div><div class="ttdeci">struct ast_app * pbx_findapp(const char *app)</div><div class="ttdoc">Look up an application. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/db7/ael__main_8c_source.html#l00165">ael_main.c:165</a></div></div>
<div class="ttc" id="channel_8h_html_afdaf014aa17389de35cba4df16860b0d"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#afdaf014aa17389de35cba4df16860b0d">ast_party_caller_init</a></div><div class="ttdeci">void ast_party_caller_init(struct ast_party_caller *init)</div><div class="ttdoc">Initialize the given caller structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d28/channel_8c_source.html#l01978">channel.c:1978</a></div></div>
<div class="ttc" id="manager_8h_html_a5b63b8a8faede2d852e071e1f7b31c11"><div class="ttname"><a href="../../db/d45/manager_8h.html#a5b63b8a8faede2d852e071e1f7b31c11">ast_manager_register_xml</a></div><div class="ttdeci">#define ast_manager_register_xml(action, authority, func)</div><div class="ttdoc">Register a manager callback using XML documentation to describe the manager. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d45/manager_8h_source.html#l00186">manager.h:186</a></div></div>
<div class="ttc" id="say_8h_html"><div class="ttname"><a href="../../db/dce/say_8h.html">say.h</a></div><div class="ttdoc">Say numbers and dates (maybe words one day too) </div></div>
<div class="ttc" id="app__voicemail_8c_html_a592ba317beefe6a1db0f55adf1e6d0d4"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4">adsi_delete</a></div><div class="ttdeci">static void adsi_delete(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l07644">app_voicemail.c:7644</a></div></div>
<div class="ttc" id="module_8h_html_aba2c8d4be709a254658b21a834f8294a"><div class="ttname"><a href="../../d5/d16/module_8h.html#aba2c8d4be709a254658b21a834f8294a">ASTERISK_GPL_KEY</a></div><div class="ttdeci">#define ASTERISK_GPL_KEY</div><div class="ttdoc">The text the key() function should return. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d16/module_8h_source.html#l00046">module.h:46</a></div></div>
<div class="ttc" id="logger_8h_html_a33f6031de4ab6d1406465a7a3ee18e86"><div class="ttname"><a href="../../d1/d8c/logger_8h.html#a33f6031de4ab6d1406465a7a3ee18e86">DEBUG_ATLEAST</a></div><div class="ttdeci">#define DEBUG_ATLEAST(level)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d8c/logger_8h_source.html#l00441">logger.h:441</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2fda4e7676a3733ec25d0d2dec3cc49d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a></div><div class="ttdeci">static char vm_newpassword[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00986">app_voicemail.c:986</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a1ce9d52d6c8efefeaaba20da07437fe0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a1ce9d52d6c8efefeaaba20da07437fe0">make_email_file</a></div><div class="ttdeci">static void make_email_file(FILE *p, char *srcemail, struct ast_vm_user *vmu, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, char *attach, char *attach2, char *format, int duration, int attach_user_voicemail, struct ast_channel *chan, const char *category, int imap, const char *flag, const char *msg_id)</div><div class="ttdoc">Creates the email file to be sent to indicate a new voicemail exists for a user. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05085">app_voicemail.c:5085</a></div></div>
<div class="ttc" id="channel_8h_html_ae56cab679c0cda6436b930bc74297895"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#ae56cab679c0cda6436b930bc74297895">ast_channel_priority_set</a></div><div class="ttdeci">void ast_channel_priority_set(struct ast_channel *chan, int value)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/de2/channel__internal__api_8c_source.html#l00448">channel_internal_api.c:448</a></div></div>
<div class="ttc" id="cli_8h_html_a7cc1753a05a0821f6c70dd2bccfbab5c"><div class="ttname"><a href="../../dc/db0/cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a></div><div class="ttdeci">#define RESULT_SUCCESS</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/db0/cli_8h_source.html#l00040">cli.h:40</a></div></div>
<div class="ttc" id="channel_8h_html_a2f18aafad0442206e71033ac6676dbb5"><div class="ttname"><a href="../../d5/d7b/channel_8h.html#a2f18aafad0442206e71033ac6676dbb5">ast_channel_alloc</a></div><div class="ttdeci">#define ast_channel_alloc(needqueue, state, cid_num, cid_name, acctcode, exten, context, assignedids, requestor, amaflag,...)</div><div class="ttdoc">Create a channel structure. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l01259">channel.h:1259</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_ac80ec334a4e45426a7c522b34d1c4774"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#ac80ec334a4e45426a7c522b34d1c4774">vmu_tm</a></div><div class="ttdeci">static const struct ast_tm * vmu_tm(const struct ast_vm_user *vmu, struct ast_tm *tm)</div><div class="ttdoc">fill in *tm for current time according to the proper timezone, if any. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l04979">app_voicemail.c:4979</a></div></div>
<div class="ttc" id="smdi_8h_html_a57edcf9aa93ccef269ad6ba1d2222609"><div class="ttname"><a href="../../dc/dca/smdi_8h.html#a57edcf9aa93ccef269ad6ba1d2222609">ast_smdi_mwi_message_wait_station</a></div><div class="ttdeci">struct ast_smdi_mwi_message * ast_smdi_mwi_message_wait_station(struct ast_smdi_interface *iface, int timeout, const char *station)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d96/res__smdi_8c_source.html#l00556">res_smdi.c:556</a></div></div>
<div class="ttc" id="dsp_8h_html_aab28c68838eaed4e0c89460a4e554cca"><div class="ttname"><a href="../../d3/d08/dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca">ast_dsp_get_threshold_from_settings</a></div><div class="ttdeci">int ast_dsp_get_threshold_from_settings(enum threshold which)</div><div class="ttdoc">Get silence threshold from dsp.conf. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/dsp_8c_source.html#l01996">dsp.c:1996</a></div></div>
<div class="ttc" id="group__Group__AMI_html_ga31a02a7d3cc36aa66ebebdedfc574d1c"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c">astman_send_error</a></div><div class="ttdeci">void astman_send_error(struct mansession *s, const struct message *m, char *error)</div><div class="ttdoc">Send error in manager transaction. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l03159">manager.c:3159</a></div></div>
<div class="ttc" id="module_8h_html"><div class="ttname"><a href="../../d5/d16/module_8h.html">module.h</a></div><div class="ttdoc">Asterisk module definitions. </div></div>
<div class="ttc" id="structast__vm__functions_html"><div class="ttname"><a href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a></div><div class="ttdoc">Voicemail function table definition. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00539">include/asterisk/app.h:539</a></div></div>
<div class="ttc" id="structmailbox__alias__mapping_html"><div class="ttname"><a href="../../d0/d11/structmailbox__alias__mapping.html">mailbox_alias_mapping</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00960">app_voicemail.c:960</a></div></div>
<div class="ttc" id="res__phoneprov_8c_html_a9a2102f5ce1bbef671a27b071df6d806"><div class="ttname"><a href="../../d9/de9/res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a></div><div class="ttdeci">static void delete_file(struct phoneprov_file *file)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/de9/res__phoneprov_8c_source.html#l00388">res_phoneprov.c:388</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2033797bc323fad1d911cd46640e3fdd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2033797bc323fad1d911cd46640e3fdd">msg_id_incrementor</a></div><div class="ttdeci">static int msg_id_incrementor</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l03742">app_voicemail.c:3742</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a4e21bf8fea26018015ea015f7c04b14f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a></div><div class="ttdeci">static char vmfmts[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00927">app_voicemail.c:927</a></div></div>
<div class="ttc" id="chan__alsa_8c_html_a98f5e70e98f6dc48e3c5ba316066d540"><div class="ttname"><a href="../../da/d45/chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a></div><div class="ttdeci">static snd_pcm_format_t format</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d45/chan__alsa_8c_source.html#l00102">chan_alsa.c:102</a></div></div>
<div class="ttc" id="adsi_8h_html_a518a772e38d00198d7570756559c0761"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a></div><div class="ttdeci">#define ADSI_JUST_CENT</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00114">adsi.h:114</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a3b021ce22e11ba21591a3907cbbc12d8"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a3b021ce22e11ba21591a3907cbbc12d8">vmauthenticate</a></div><div class="ttdeci">static int vmauthenticate(struct ast_channel *chan, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l12765">app_voicemail.c:12765</a></div></div>
<div class="ttc" id="structast__vm__user_html_a2d59a1b699769cca24979c79c22056be"><div class="ttname"><a href="../../da/df6/structast__vm__user.html#a2d59a1b699769cca24979c79c22056be">ast_vm_user::mailbox</a></div><div class="ttdeci">char mailbox[MAX_VM_MBOX_ID_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00757">app_voicemail.c:757</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a80cd3f6f786b59b742bcecfc0b3be7c2"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2">AST_DECLARE_APP_ARGS</a></div><div class="ttdeci">#define AST_DECLARE_APP_ARGS(name, arglist)</div><div class="ttdoc">Declare a structure to hold an application&amp;#39;s arguments. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01249">include/asterisk/app.h:1249</a></div></div>
<div class="ttc" id="stringfields_8h_html_abf60f862ae6a141d2f86a0f5e82792de"><div class="ttname"><a href="../../d1/d0f/stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de">ast_string_field_free_memory</a></div><div class="ttdeci">#define ast_string_field_free_memory(x)</div><div class="ttdoc">free all memory - to be called before destroying the object </div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d0f/stringfields_8h_source.html#l00368">stringfields.h:368</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a0d189d088982b574837ebaee7cd4ccbd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a></div><div class="ttdeci">static char serveremail[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00923">app_voicemail.c:923</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ae574544d8785072b67887b3aaff45af0"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ae574544d8785072b67887b3aaff45af0">ast_vm_greeter_register</a></div><div class="ttdeci">#define ast_vm_greeter_register(vm_table)</div><div class="ttdoc">See __ast_vm_greeter_register() </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00657">include/asterisk/app.h:657</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html">app.h</a></div><div class="ttdoc">Application convenience functions, designed to give consistent look and feel to Asterisk apps...</div></div>
<div class="ttc" id="app__voicemail_8c_html_a26fee1cad75593ff650106610fa528ae"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a26fee1cad75593ff650106610fa528ae">alias_mailbox_mapping_create</a></div><div class="ttdeci">static struct alias_mailbox_mapping * alias_mailbox_mapping_create(const char *alias, const char *mailbox)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13588">app_voicemail.c:13588</a></div></div>
<div class="ttc" id="structvm__state_html_a661d8b405850d3a0c8aaa328b2b06fd1"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">vm_state::newmessages</a></div><div class="ttdeci">int newmessages</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00819">app_voicemail.c:819</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa5c83ea260e72cddc8570b487f766dca"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa5c83ea260e72cddc8570b487f766dca">play_message_by_id</a></div><div class="ttdeci">static int play_message_by_id(struct ast_channel *chan, const char *mailbox, const char *context, const char *msg_id)</div><div class="ttdoc">Finds a message in a specific mailbox by msg_id and plays it to the channel. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l11402">app_voicemail.c:11402</a></div></div>
<div class="ttc" id="structast__party__number_html_aaa04218f9e3a9065afa8be2491da8904"><div class="ttname"><a href="../../d6/dbb/structast__party__number.html#aaa04218f9e3a9065afa8be2491da8904">ast_party_number::valid</a></div><div class="ttdeci">unsigned char valid</div><div class="ttdoc">TRUE if the number information is valid/present. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00298">channel.h:298</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a53ca119641b390bae11bbec1aded6f8a"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a53ca119641b390bae11bbec1aded6f8a">ast_str_encode_mime</a></div><div class="ttdeci">static const char * ast_str_encode_mime(struct ast_str **end, ssize_t maxlen, const char *start, size_t preamble, size_t postamble)</div><div class="ttdoc">Encode a string according to the MIME rules for encoding strings that are not 7-bit clean or contain ...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05029">app_voicemail.c:5029</a></div></div>
<div class="ttc" id="astobj2_8h_html_ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01053">astobj2.h:1053</a></div></div>
<div class="ttc" id="structvm__zone_html"><div class="ttname"><a href="../../d7/d13/structvm__zone.html">vm_zone</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00796">app_voicemail.c:796</a></div></div>
<div class="ttc" id="astobj2_8h_html_a91d5d37d00874ae7a92d1a15c0a3b3a6"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a91d5d37d00874ae7a92d1a15c0a3b3a6">ao2_iterator_init</a></div><div class="ttdeci">struct ao2_iterator ao2_iterator_init(struct ao2_container *c, int flags) attribute_warn_unused_result</div><div class="ttdoc">Create an iterator for a container. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d22/astobj2__container_8c_source.html#l00485">astobj2_container.c:485</a></div></div>
<div class="ttc" id="lock_8h_html_a6add1f30b2d53ca9384b15529a6f126e"><div class="ttname"><a href="../../dd/d42/lock_8h.html#a6add1f30b2d53ca9384b15529a6f126e">ast_cond_timedwait</a></div><div class="ttdeci">#define ast_cond_timedwait(cond, mutex, time)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00204">lock.h:204</a></div></div>
<div class="ttc" id="adsi_8h_html_a002af0b7a6a7398c3a1bfd2f412a7e8b"><div class="ttname"><a href="../../df/de2/adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a></div><div class="ttdeci">#define ADSI_KEY_APPS</div><div class="ttdef"><b>Definition:</b> <a href="../../df/de2/adsi_8h_source.html#l00109">adsi.h:109</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a5f1d643f9da1c26606a787f68555aa04"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a5f1d643f9da1c26606a787f68555aa04">valid_config</a></div><div class="ttdeci">static int valid_config(const struct ast_config *cfg)</div><div class="ttdoc">Check if configuration file is valid. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01751">app_voicemail.c:1751</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a7250744aee6e9088d51d864c9deefe1f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a></div><div class="ttdeci">static char listen_control_stop_key[12]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00980">app_voicemail.c:980</a></div></div>
<div class="ttc" id="pbx_8h_html_a8af0e93442a9e468425f63cc52b0ac7b"><div class="ttname"><a href="../../db/de0/pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b">ast_custom_function_register</a></div><div class="ttdeci">#define ast_custom_function_register(acf)</div><div class="ttdoc">Register a custom function. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/de0/pbx_8h_source.html#l01508">pbx.h:1508</a></div></div>
<div class="ttc" id="lock_8h_html_ac840092853644cea0a186efdc58985f5"><div class="ttname"><a href="../../dd/d42/lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a></div><div class="ttdeci">#define AST_MUTEX_DEFINE_STATIC(mutex)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00518">lock.h:518</a></div></div>
<div class="ttc" id="file_8h_html_a3092bf11d4bba66f646562759608b1bc"><div class="ttname"><a href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a></div><div class="ttdeci">int ast_stopstream(struct ast_channel *c)</div><div class="ttdoc">Stops a stream. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l00187">file.c:187</a></div></div>
<div class="ttc" id="structast__vm__mailbox__snapshot_html"><div class="ttname"><a href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00317">include/asterisk/app.h:317</a></div></div>
<div class="ttc" id="module_8h_html_afba4eb7a910b10969041ae4cd488729d"><div class="ttname"><a href="../../d5/d16/module_8h.html#afba4eb7a910b10969041ae4cd488729d">ast_register_application_xml</a></div><div class="ttdeci">#define ast_register_application_xml(app, execute)</div><div class="ttdoc">Register an application using XML documentation. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d16/module_8h_source.html#l00626">module.h:626</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa2008dd91df3ec0b2625cdac457c8eaf"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a></div><div class="ttdeci">static int add_email_attachment(FILE *p, struct ast_vm_user *vmu, char *format, char *attach, char *greeting_attachment, char *mailbox, char *bound, char *filename, int last, int msgnum)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l05384">app_voicemail.c:5384</a></div></div>
<div class="ttc" id="structast__mutex__info_html"><div class="ttname"><a href="../../d8/dc5/structast__mutex__info.html">ast_mutex_info</a></div><div class="ttdoc">Structure for mutex and tracking information. </div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00135">lock.h:135</a></div></div>
<div class="ttc" id="structast__smdi__mwi__message_html"><div class="ttname"><a href="../../d3/d61/structast__smdi__mwi__message.html">ast_smdi_mwi_message</a></div><div class="ttdoc">An SMDI message waiting indicator message. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dca/smdi_8h_source.html#l00051">smdi.h:51</a></div></div>
<div class="ttc" id="structvm__state_html_a11dec1601684237c86e01cdb42901ace"><div class="ttname"><a href="../../dd/d8f/structvm__state.html#a11dec1601684237c86e01cdb42901ace">vm_state::lastmsg</a></div><div class="ttdeci">int lastmsg</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00818">app_voicemail.c:818</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa8ca9b5f9691b29d6124f113ca609b64a3009ee50d2975ad7932cb6e7f610e64f"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa8ca9b5f9691b29d6124f113ca609b64a3009ee50d2975ad7932cb6e7f610e64f">FRIENDS_FOLDER</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00576">app_voicemail.c:576</a></div></div>
<div class="ttc" id="structast__vm__recording__data_html_abb2534e0096a9f91aa1541900be4edf1"><div class="ttname"><a href="../../df/d45/structast__vm__recording__data.html#abb2534e0096a9f91aa1541900be4edf1">ast_vm_recording_data::call_extension</a></div><div class="ttdeci">const ast_string_field call_extension</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00103">include/asterisk/app.h:103</a></div></div>
<div class="ttc" id="app__jack_8c_html_ac191e5810fa65e63095409471eb5648f"><div class="ttname"><a href="../../de/dcd/app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a></div><div class="ttdeci">jack_status_t status</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dcd/app__jack_8c_source.html#l00146">app_jack.c:146</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a464e68010ebec43ad6eb83fd63494e01"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">reset_user_pw</a></div><div class="ttdeci">static int reset_user_pw(const char *context, const char *mailbox, const char *newpass)</div><div class="ttdoc">Resets a user password to a specified password. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01729">app_voicemail.c:1729</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a336fb8db39bd98439132b0eda882849ea6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00584">app_voicemail.c:584</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a84938e9680eec2be638d77ef2cb011fc"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a84938e9680eec2be638d77ef2cb011fc">MAX_VM_MAILBOX_LEN</a></div><div class="ttdeci">#define MAX_VM_MAILBOX_LEN</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00751">app_voicemail.c:751</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a77ed313dc3dbb0b5336dd7eb091aa9b9"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a></div><div class="ttdeci">#define VM_FORCEGREET</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00556">app_voicemail.c:556</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a724057a0c369a6b5dd798ccc31cf53f2"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a724057a0c369a6b5dd798ccc31cf53f2">DEFAULT_LISTEN_CONTROL_RESTART_KEY</a></div><div class="ttdeci">#define DEFAULT_LISTEN_CONTROL_RESTART_KEY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00520">app_voicemail.c:520</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_acd54de61052c34990c4d76a8400c759c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a></div><div class="ttdeci">static unsigned int poll_freq</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00945">app_voicemail.c:945</a></div></div>
<div class="ttc" id="format__cache_8h_html"><div class="ttname"><a href="../../db/d1c/format__cache_8h.html">format_cache.h</a></div><div class="ttdoc">Media Format Cache API. </div></div>
<div class="ttc" id="strings_8h_html_a9c34c6c6b8daaba24c0406270f3cf697"><div class="ttname"><a href="../../d6/d90/strings_8h.html#a9c34c6c6b8daaba24c0406270f3cf697">ast_str_create</a></div><div class="ttdeci">#define ast_str_create(init_len)</div><div class="ttdoc">Create a malloc&amp;#39;ed dynamic length string. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d90/strings_8h_source.html#l00620">strings.h:620</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a8ae605b4118ef2bd9426f2b057835778"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a></div><div class="ttdeci">struct ao2_container * inprocess_container</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01110">app_voicemail.c:1110</a></div></div>
<div class="ttc" id="codecs_2gsm_2inc_2private_8h_html_a0b023cbb2bf7d034c2269d58d7455ac8"><div class="ttname"><a href="../../d6/da0/codecs_2gsm_2inc_2private_8h.html#a0b023cbb2bf7d034c2269d58d7455ac8">word</a></div><div class="ttdeci">short word</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/da0/codecs_2gsm_2inc_2private_8h_source.html#l00012">codecs/gsm/inc/private.h:12</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_ab45a61007ccd8ca2ea062f42b83b18ff"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#ab45a61007ccd8ca2ea062f42b83b18ff">ast_app_inboxcount</a></div><div class="ttdeci">int ast_app_inboxcount(const char *mailboxes, int *newmsgs, int *oldmsgs)</div><div class="ttdoc">Determine number of new/old messages in a mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d83/main_2app_8c_source.html#l00677">main/app.c:677</a></div></div>
<div class="ttc" id="lock_8h_html_a873f9ce8c6287a32d48c83133e124418"><div class="ttname"><a href="../../dd/d42/lock_8h.html#a873f9ce8c6287a32d48c83133e124418">ast_mutex_unlock</a></div><div class="ttdeci">#define ast_mutex_unlock(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d42/lock_8h_source.html#l00188">lock.h:188</a></div></div>
<div class="ttc" id="structast__smdi__interface_html"><div class="ttname"><a href="../../d8/d32/structast__smdi__interface.html">ast_smdi_interface</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d96/res__smdi_8c_source.html#l00167">res_smdi.c:167</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a6d6a58b45f010bc03c6410ccdc2d06dd"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a></div><div class="ttdeci">static void stop_poll_thread(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l13209">app_voicemail.c:13209</a></div></div>
<div class="ttc" id="http_8c_html_a6f25bc812d09fedb86bf394c01061c56"><div class="ttname"><a href="../../dd/d43/http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a></div><div class="ttdeci">static char prefix[MAX_PREFIX]</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d43/http_8c_source.html#l00141">http.c:141</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a29779fb1f6d01dc8ed301b23a394daa0"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">populate_defaults</a></div><div class="ttdeci">static void populate_defaults(struct ast_vm_user *vmu)</div><div class="ttdoc">Sets default voicemail system options to a voicemail user. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01205">app_voicemail.c:1205</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_afa9da39009fbb2a8ca57396c57eb8f6c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c">vm_intro_gr</a></div><div class="ttdeci">static int vm_intro_gr(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09367">app_voicemail.c:9367</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a968fb00e5d6578cbdd7faa2069ac8650"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650">vm_tempgreeting</a></div><div class="ttdeci">static int vm_tempgreeting(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain)</div><div class="ttdoc">The handler for &amp;#39;record a temporary greeting&amp;#39;. </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l10888">app_voicemail.c:10888</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a037e9a5b28477b17e7c9acbe7ecb21d5"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5">AST_APP_ARG</a></div><div class="ttdeci">#define AST_APP_ARG(name)</div><div class="ttdoc">Define an application argument. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l01232">include/asterisk/app.h:1232</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aad39d37394ef9bcd11d7b2cf55f6b08d"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aad39d37394ef9bcd11d7b2cf55f6b08d">vm_prepend_timeout</a></div><div class="ttdeci">static char vm_prepend_timeout[80]</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l01003">app_voicemail.c:1003</a></div></div>
<div class="ttc" id="utils_8h_html_a7c38859ed90e96df2b0a0fdf843769d0"><div class="ttname"><a href="../../d5/d60/utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0">ast_mkdir</a></div><div class="ttdeci">int ast_mkdir(const char *path, int mode)</div><div class="ttdoc">Recursively create directory path. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d1f/main_2utils_8c_source.html#l02231">main/utils.c:2231</a></div></div>
<div class="ttc" id="callerid_8h_html_a39e03ca4e8df3a1d2c75e888d76201df"><div class="ttname"><a href="../../de/d47/callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df">ast_callerid_parse</a></div><div class="ttdeci">int ast_callerid_parse(char *instr, char **name, char **location)</div><div class="ttdoc">Destructively parse inbuf into name and location (or number) </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dd5/callerid_8c_source.html#l01008">callerid.c:1008</a></div></div>
<div class="ttc" id="stringfields_8h_html_a653461abd6e0d16e4e3326ab90e0501d"><div class="ttname"><a href="../../d1/d0f/stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d">ast_string_field_set</a></div><div class="ttdeci">#define ast_string_field_set(x, field, data)</div><div class="ttdoc">Set a field to a simple string value. </div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d0f/stringfields_8h_source.html#l00514">stringfields.h:514</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_a2febb422c919a552aaf9cc3d4ebc801c"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c">vm_intro_he</a></div><div class="ttdeci">static int vm_intro_he(struct ast_channel *chan, struct vm_state *vms)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l09501">app_voicemail.c:9501</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_abf5e7cf8ce333dece7920d64415b41d7"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#abf5e7cf8ce333dece7920d64415b41d7">MAX_MAIL_BODY_CONTENT_SIZE</a></div><div class="ttdeci">#define MAX_MAIL_BODY_CONTENT_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l00530">app_voicemail.c:530</a></div></div>
<div class="ttc" id="structast__tm_html"><div class="ttname"><a href="../../d5/d84/structast__tm.html">ast_tm</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/deb/localtime_8h_source.html#l00035">localtime.h:35</a></div></div>
<div class="ttc" id="include_2asterisk_2config_8h_html_a103e76ed4bd42f776f7f260080b98b3fafa887389dc380bbdcffb65fec379f037"><div class="ttname"><a href="../../d3/de6/include_2asterisk_2config_8h.html#a103e76ed4bd42f776f7f260080b98b3fafa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/de6/include_2asterisk_2config_8h_source.html#l00043">include/asterisk/config.h:43</a></div></div>
<div class="ttc" id="app__voicemail_8c_html_aa3b980dbdb4e669b052e22cde8e2d220"><div class="ttname"><a href="../../dc/df4/app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a></div><div class="ttdeci">static int play_message_datetime(struct ast_channel *chan, struct ast_vm_user *vmu, const char *origtime, const char *filename)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/df4/app__voicemail_8c_source.html#l08638">app_voicemail.c:8638</a></div></div>
<div class="ttc" id="group__Group__AMI_html_ga0ee6ee1f4d200f711e2983bffe770a72"><div class="ttname"><a href="../../df/d72/group__Group__AMI.html#ga0ee6ee1f4d200f711e2983bffe770a72">astman_send_listack</a></div><div class="ttdeci">void astman_send_listack(struct mansession *s, const struct message *m, char *msg, char *listflag)</div><div class="ttdoc">Send ack in manager transaction to begin a list. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d10/manager_8c_source.html#l03201">manager.c:3201</a></div></div>
<div class="ttc" id="test__linkedlists_8c_html_a13dd15487fee89a002d17ef3aff62d02"><div class="ttname"><a href="../../d7/d6f/test__linkedlists_8c.html#a13dd15487fee89a002d17ef3aff62d02">a</a></div><div class="ttdeci">static struct test_val a</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d6f/test__linkedlists_8c_source.html#l00046">test_linkedlists.c:46</a></div></div>
<div class="ttc" id="structast__party__id_html_aca2d7de6c89f201dc8bd0a2642d2a352"><div class="ttname"><a href="../../d1/dcb/structast__party__id.html#aca2d7de6c89f201dc8bd0a2642d2a352">ast_party_id::number</a></div><div class="ttdeci">struct ast_party_number number</div><div class="ttdoc">Subscriber phone number. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d7b/channel_8h_source.html#l00343">channel.h:343</a></div></div>
<div class="ttc" id="include_2asterisk_2app_8h_html_a67fca777538364c249bf1b66b2a22491a564e6105590992ed518ac4dccbdc483b"><div class="ttname"><a href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491a564e6105590992ed518ac4dccbdc483b">AST_VM_SNAPSHOT_SORT_BY_ID</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d93/include_2asterisk_2app_8h_source.html#l00296">include/asterisk/app.h:296</a></div></div>
<div class="ttc" id="astobj2_8h_html_a1ad9f122bcae95a470639402faa3d2ee"><div class="ttname"><a href="../../d5/da5/astobj2_8h.html#a1ad9f122bcae95a470639402faa3d2ee">ao2_link</a></div><div class="ttdeci">#define ao2_link(container, obj)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/da5/astobj2_8h_source.html#l01549">astobj2.h:1549</a></div></div>
<div class="ttc" id="test_8h_html_aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6"><div class="ttname"><a href="../../d2/ddc/test_8h.html#aad2aec78205d328d23894a6598cc4044a8a11a3a19eb4c9fd2ba654d95df1adb6">AST_TEST_FAIL</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/ddc/test_8h_source.html#l00203">test.h:203</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 8 2021 19:43:05 for Asterisk - The Open Source Telephony Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
