<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asterisk - The Open Source Telephony Project: astcanary.c File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Asterisk - The Open Source Telephony Project
   &#160;<span id="projectnumber">18.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_cbdb8362360e11eafe2fa3bc74cf0ffd.html">utils</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">astcanary.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;sys/types.h&gt;</code><br />
<code>#include &lt;sys/stat.h&gt;</code><br />
<code>#include &lt;sys/time.h&gt;</code><br />
<code>#include &lt;sys/resource.h&gt;</code><br />
<code>#include &lt;utime.h&gt;</code><br />
<code>#include &lt;fcntl.h&gt;</code><br />
<code>#include &lt;unistd.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for astcanary.c:</div>
<div class="dyncontent">
<div class="center"><img src="../../de/d11/astcanary_8c__incl.png" border="0" usemap="#astcanary_8c" alt=""/></div>
<map name="astcanary_8c" id="astcanary_8c">
</map>
</div>
</div>
<p><a href="../../d4/d9e/astcanary_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a0ddf1224851353fc92bfbff6f499fa97"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d9e/astcanary_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
<tr class="separator:a0ddf1224851353fc92bfbff6f499fa97"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a0b57f9e1b56b77bd0a99f9ba78e7d4cd"><td class="memItemLeft" align="right" valign="top">static const char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d9e/astcanary_8c.html#a0b57f9e1b56b77bd0a99f9ba78e7d4cd">explanation</a> []</td></tr>
<tr class="memdesc:a0b57f9e1b56b77bd0a99f9ba78e7d4cd"><td class="mdescLeft">&#160;</td><td class="mdescRight">At one time, canaries were carried along with coal miners down into a mine. Their purpose was to alert the miners when they had drilled into a pocket of methane gas or another noxious substance. The canary, being the most sensitive animal, would immediately fall over. Seeing this, the miners could take action to escape the mine, seeing an imminent danger.  <a href="#a0b57f9e1b56b77bd0a99f9ba78e7d4cd">More...</a><br /></td></tr>
<tr class="separator:a0b57f9e1b56b77bd0a99f9ba78e7d4cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a0ddf1224851353fc92bfbff6f499fa97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ddf1224851353fc92bfbff6f499fa97">&#9670;&nbsp;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>argv</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section note"><dt>Note</dt><dd>See <a href="http://www.opengroup.org/onlinepubs/009695399/basedefs/xbd_chap03.html#tag_03_265">http://www.opengroup.org/onlinepubs/009695399/basedefs/xbd_chap03.html#tag_03_265</a> for a justification of this approach. The PPID after the creator dies in Linux and most other Unix-like systems will be 1, but this is not strictly the case. The POSIX specification allows it to be an implementation-defined system process. However, it most certainly will not be the original parent PID, which makes the following code POSIX-compliant.</dd></dl>

<p class="definition">Definition at line <a class="el" href="../../d4/d9e/astcanary_8c_source.html#l00092">92</a> of file <a class="el" href="../../d4/d9e/astcanary_8c_source.html">astcanary.c</a>.</p>

<p class="reference">References <a class="el" href="../../d4/d9e/astcanary_8c_source.html#l00079">explanation</a>, <a class="el" href="../../dc/d7f/resample_8c_source.html#l00096">NULL</a>, and <a class="el" href="../../db/db2/asterisk_8h_source.html#l00048">setpriority</a>.</p>
<div class="fragment"><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;{</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;   <span class="keywordtype">int</span> fd;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;   pid_t parent;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;   <span class="keywordflow">if</span> (argc &lt; 3) {</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      fprintf(stderr, <span class="stringliteral">&quot;Usage: %s &lt;monitor-filename&gt; &lt;ppid&gt;\n&quot;</span>, argv[0]);</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      exit(1);</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;   }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;   <span class="comment">/* Run at normal priority */</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;   <a class="code" href="../../db/db2/asterisk_8h.html#aa074a86999c2684cd7ed271c4d275081">setpriority</a>(PRIO_PROCESS, 0, 0);</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment">   /*!\note</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment">    * See http://www.opengroup.org/onlinepubs/009695399/basedefs/xbd_chap03.html#tag_03_265</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">    * for a justification of this approach.  The PPID after the creator dies in Linux and</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">    * most other Unix-like systems will be 1, but this is not strictly the case.  The POSIX</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">    * specification allows it to be an implementation-defined system process.  However, it</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">    * most certainly will not be the original parent PID, which makes the following code</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">    * POSIX-compliant.</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;   <span class="keywordflow">for</span> (parent = atoi(argv[2]); parent == getppid() ;) {</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      <span class="comment">/* Update the modification times (checked from Asterisk) */</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      <span class="keywordflow">if</span> (utime(argv[1], <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;         <span class="comment">/* Recreate the file if it doesn&#39;t exist */</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;         <span class="keywordflow">if</span> ((fd = open(argv[1], O_RDWR | O_TRUNC | O_CREAT, 0777)) &gt; -1) {</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">if</span> (write(fd, <a class="code" href="../../d4/d9e/astcanary_8c.html#a0b57f9e1b56b77bd0a99f9ba78e7d4cd">explanation</a>, strlen(<a class="code" href="../../d4/d9e/astcanary_8c.html#a0b57f9e1b56b77bd0a99f9ba78e7d4cd">explanation</a>)) &lt; 0) {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;               exit(1);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            }</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            close(fd);</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;         } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            exit(1);</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;         }</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;      }</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;      <span class="comment">/* Run occasionally */</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      sleep(5);</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;   }</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;   <span class="comment">/* Exit when the parent dies */</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div><div class="ttc" id="astcanary_8c_html_a0b57f9e1b56b77bd0a99f9ba78e7d4cd"><div class="ttname"><a href="../../d4/d9e/astcanary_8c.html#a0b57f9e1b56b77bd0a99f9ba78e7d4cd">explanation</a></div><div class="ttdeci">static const char explanation[]</div><div class="ttdoc">At one time, canaries were carried along with coal miners down into a mine. Their purpose was to aler...</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d9e/astcanary_8c_source.html#l00079">astcanary.c:79</a></div></div>
<div class="ttc" id="resample_8c_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d7f/resample_8c_source.html#l00096">resample.c:96</a></div></div>
<div class="ttc" id="asterisk_8h_html_aa074a86999c2684cd7ed271c4d275081"><div class="ttname"><a href="../../db/db2/asterisk_8h.html#aa074a86999c2684cd7ed271c4d275081">setpriority</a></div><div class="ttdeci">#define setpriority</div><div class="ttdef"><b>Definition:</b> <a href="../../db/db2/asterisk_8h_source.html#l00048">asterisk.h:48</a></div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a0b57f9e1b56b77bd0a99f9ba78e7d4cd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0b57f9e1b56b77bd0a99f9ba78e7d4cd">&#9670;&nbsp;</a></span>explanation</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char explanation[]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>At one time, canaries were carried along with coal miners down into a mine. Their purpose was to alert the miners when they had drilled into a pocket of methane gas or another noxious substance. The canary, being the most sensitive animal, would immediately fall over. Seeing this, the miners could take action to escape the mine, seeing an imminent danger. </p>
<p>This process serves a similar purpose, though with the realtime priority being the reason. When a thread starts running away with the processor, it is typically difficult to tell what thread caused the problem, as the machine acts as if it is locked up (in fact, what has happened is that Asterisk runs at a higher priority than even the login shell, so the runaway thread hogs all available CPU time.</p>
<p>If that happens, this canary process will cease to get any process time, which we can monitor with a realtime thread in Asterisk. Should that happen, that monitoring thread may take immediate action to slow down Asterisk to regular priority, thus allowing an administrator to login to the system and restart Asterisk or perhaps take another course of action (such as retrieving a backtrace to let the developers know what precisely went wrong).</p>
<p>Note that according to POSIX.1, all threads inside a single process must share the same priority, so when the monitoring thread deprioritizes itself, it deprioritizes all threads at the same time. This is also why this canary must exist as a completely separate process and not simply as a thread within Asterisk itself.</p>
<p>Quote: "The nice value set with <a class="el" href="../../db/db2/asterisk_8h.html#aa074a86999c2684cd7ed271c4d275081">setpriority()</a> shall be applied to the process. If the process is multi-threaded, the nice value shall affect all system scope threads in the process."</p>
<p>Source: <a href="http://www.opengroup.org/onlinepubs/000095399/functions/setpriority.html">http://www.opengroup.org/onlinepubs/000095399/functions/setpriority.html</a></p>
<p>In answer to the question, what aren't system scope threads, the answer is, in Asterisk, nothing. Process scope threads are the alternative, but they aren't supported in Linux. </p>

<p class="definition">Definition at line <a class="el" href="../../d4/d9e/astcanary_8c_source.html#l00079">79</a> of file <a class="el" href="../../d4/d9e/astcanary_8c_source.html">astcanary.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="../../d4/d9e/astcanary_8c_source.html#l00092">main()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 8 2021 19:44:46 for Asterisk - The Open Source Telephony Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
