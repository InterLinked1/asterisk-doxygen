<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asterisk - The Open Source Telephony Project: /usr/src/asterisk-18.5.0/main/app.c</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Asterisk - The Open Source Telephony Project
   &#160;<span id="projectnumber">18.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/usr/src/asterisk-18.5.0/main/app.c</div>  </div>
</div><!--header-->
<div class="contents">
<dl class="section user"><dt>This is an example of how to develop an app.</dt><dd>Application Skeleton is an example of creating an application for Asterisk. <pre class="fragment">/*
 * Asterisk -- An open source telephony toolkit.
 *
 * Copyright (C) &lt;Year&gt;, &lt;Your Name Here&gt;
 *
 * &lt;Your Name Here&gt; &lt;&lt;Your Email Here&gt;&gt;
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
 * Please follow coding guidelines
 * https://wiki.asterisk.org/wiki/display/AST/Coding+Guidelines
 */

/*! \file
 *
 * \brief Skeleton application
 *
 * \author\verbatim &lt;Your Name Here&gt; &lt;&lt;Your Email Here&gt;&gt; \endverbatim
 *
 * This is a skeleton for development of an Asterisk application
 * \ingroup applications
 */

/*! \li \ref app_skel.c uses configuration file \ref app_skel.conf
 * \addtogroup configuration_file Configuration Files
 */

/*!
 * \page app_skel.conf app_skel.conf
 * \verbinclude app_skel.conf.sample
 */

/*** MODULEINFO
	&lt;defaultenabled&gt;no&lt;/defaultenabled&gt;
	&lt;support_level&gt;core&lt;/support_level&gt;
 ***/

#include "asterisk.h"

#include &lt;math.h&gt; /* log10 */
#include "asterisk/file.h"
#include "asterisk/channel.h"
#include "asterisk/pbx.h"
#include "asterisk/module.h"
#include "asterisk/lock.h"
#include "asterisk/app.h"
#include "asterisk/config.h"
#include "asterisk/config_options.h"
#include "asterisk/say.h"
#include "asterisk/astobj2.h"
#include "asterisk/acl.h"
#include "asterisk/netsock2.h"
#include "asterisk/strings.h"
#include "asterisk/cli.h"

/*** DOCUMENTATION
	&lt;application name="SkelGuessNumber" language="en_US"&gt;
		&lt;synopsis&gt;
			An example number guessing game
		&lt;/synopsis&gt;
		&lt;syntax&gt;
			&lt;parameter name="level" required="true"/&gt;
			&lt;parameter name="options"&gt;
				&lt;optionlist&gt;
					&lt;option name="c"&gt;
						&lt;para&gt;The computer should cheat&lt;/para&gt;
					&lt;/option&gt;
					&lt;option name="n"&gt;
						&lt;para&gt;How many games to play before hanging up&lt;/para&gt;
					&lt;/option&gt;
				&lt;/optionlist&gt;
			&lt;/parameter&gt;
		&lt;/syntax&gt;
		&lt;description&gt;
		&lt;para&gt;This simple number guessing application is a template to build other applications
		from. It shows you the basic structure to create your own Asterisk applications.&lt;/para&gt;
		&lt;/description&gt;
	&lt;/application&gt;

	&lt;configInfo name="app_skel" language="en_US"&gt;
		&lt;configFile name="app_skel.conf"&gt;
			&lt;configObject name="globals"&gt;
				&lt;synopsis&gt;Options that apply globally to app_skel&lt;/synopsis&gt;
				&lt;configOption name="games"&gt;
					&lt;synopsis&gt;The number of games a single execution of SkelGuessNumber will play&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="cheat"&gt;
					&lt;synopsis&gt;Should the computer cheat?&lt;/synopsis&gt;
					&lt;description&gt;&lt;para&gt;If enabled, the computer will ignore winning guesses.&lt;/para&gt;&lt;/description&gt;
				&lt;/configOption&gt;
			&lt;/configObject&gt;
			&lt;configObject name="sounds"&gt;
				&lt;synopsis&gt;Prompts for SkelGuessNumber to play&lt;/synopsis&gt;
				&lt;configOption name="prompt" default="please-enter-your&amp;amp;number&amp;amp;queue-less-than"&gt;
					&lt;synopsis&gt;A prompt directing the user to enter a number less than the max number&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="wrong_guess" default="vm-pls-try-again"&gt;
					&lt;synopsis&gt;The sound file to play when a wrong guess is made&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="right_guess" default="auth-thankyou"&gt;
					&lt;synopsis&gt;The sound file to play when a correct guess is made&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="too_low"&gt;
					&lt;synopsis&gt;The sound file to play when a guess is too low&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="too_high"&gt;
					&lt;synopsis&gt;The sound file to play when a guess is too high&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="lose" default="vm-goodbye"&gt;
					&lt;synopsis&gt;The sound file to play when a player loses&lt;/synopsis&gt;
				&lt;/configOption&gt;
			&lt;/configObject&gt;
			&lt;configObject name="level"&gt;
				&lt;synopsis&gt;Defined levels for the SkelGuessNumber game&lt;/synopsis&gt;
				&lt;configOption name="max_number"&gt;
					&lt;synopsis&gt;The maximum in the range of numbers to guess (1 is the implied minimum)&lt;/synopsis&gt;
				&lt;/configOption&gt;
				&lt;configOption name="max_guesses"&gt;
					&lt;synopsis&gt;The maximum number of guesses before a game is considered lost&lt;/synopsis&gt;
				&lt;/configOption&gt;
			&lt;/configObject&gt;
		&lt;/configFile&gt;
	&lt;/configInfo&gt;
 ***/

static char *app = "SkelGuessNumber";

enum option_flags {
	OPTION_CHEAT    = (1 &lt;&lt; 0),
	OPTION_NUMGAMES = (1 &lt;&lt; 1),
};

enum option_args {
	OPTION_ARG_NUMGAMES,
	/* This *must* be the last value in this enum! */
	OPTION_ARG_ARRAY_SIZE,
};

AST_APP_OPTIONS(app_opts,{
	AST_APP_OPTION('c', OPTION_CHEAT),
	AST_APP_OPTION_ARG('n', OPTION_NUMGAMES, OPTION_ARG_NUMGAMES),
});

/*! \brief A structure to hold global configuration-related options */
struct skel_global_config {
	AST_DECLARE_STRING_FIELDS(
		AST_STRING_FIELD(prompt); /*!&lt; The comma-separated list of sounds to prompt to enter a number */
		AST_STRING_FIELD(wrong);  /*!&lt; The comma-separated list of sounds to indicate a wrong guess */
		AST_STRING_FIELD(right);  /*!&lt; The comma-separated list of sounds to indicate a right guess */
		AST_STRING_FIELD(high);   /*!&lt; The comma-separated list of sounds to indicate a high guess */
		AST_STRING_FIELD(low);    /*!&lt; The comma-separated list of sounds to indicate a low guess */
		AST_STRING_FIELD(lose);  /*!&lt; The comma-separated list of sounds to indicate a lost game */
	);
	uint32_t num_games;    /*!&lt; The number of games to play before hanging up */
	unsigned char cheat:1; /*!&lt; Whether the computer can cheat or not */
};

/*! \brief A structure to maintain level state across reloads */
struct skel_level_state {
	uint32_t wins;      /*!&lt; How many wins for this level */
	uint32_t losses;    /*!&lt; How many losses for this level */
	double avg_guesses; /*!&lt; The average number of guesses to win for this level */
};

/*! \brief Object to hold level config information.
 * \note This object should hold a reference to an object that holds state across reloads.
 * The other fields are just examples of the kind of data that might be stored in an level.
 */
struct skel_level {
	AST_DECLARE_STRING_FIELDS(
		AST_STRING_FIELD(name);      /*!&lt; The name of the level */
	);
	uint32_t max_num;                /*!&lt; The upper value on th range of numbers to guess */
	uint32_t max_guesses;            /*!&lt; The maximum number of guesses before losing */
	struct skel_level_state *state;  /*!&lt; A pointer to level state that must exist across all reloads */
};

/*! \brief Information about a currently running set of games
 * \note Because we want to be able to show true running information about the games
 * regardless of whether or not a reload has modified what the level looks like, it
 * is important to either copy the information we need from the level to the
 * current_game struct, or as we do here, store a reference to the level as it is for
 * the running game.
 */
struct skel_current_game {
	uint32_t total_games;          /*! The total number of games for this call to the app */
	uint32_t games_left;           /*! How many games are left to play in this set */
	uint32_t cheat;                /*! Whether or not cheating was enabled for the game */
	struct skel_level *level_info; /*! The level information for the running game */
};

/* Treat the levels as an array--there won't be many and this will maintain the order */
#define LEVEL_BUCKETS 1

/*! \brief A container that holds all config-related information
 * \note This object should contain a pointer to structs for global data and containers for
 * any levels that are configured. Objects of this type will be swapped out on reload. If an
 * level needs to maintain state across reloads, it needs to allocate a refcounted object to
 * hold that state and ensure that a reference is passed to that state when creating a new
 * level for reload. */
struct skel_config {
	struct skel_global_config *global;
	struct ao2_container *levels;
};

/* Config Options API callbacks */

/*! \brief Allocate a skel_config to hold a snapshot of the complete results of parsing a config
 * \internal
 * \returns A void pointer to a newly allocated skel_config
 */
static void *skel_config_alloc(void);

/*! \brief Allocate a skel_level based on a category in a configuration file
 * \param cat The category to base the level on
 * \returns A void pointer to a newly allocated skel_level
 */
static void *skel_level_alloc(const char *cat);

/*! \brief Find a skel level in the specified container
 * \note This function *does not* look for a skel_level in the active container. It is used
 * internally by the Config Options code to check if an level has already been added to the
 * container that will be swapped for the live container on a successul reload.
 *
 * \param tmp_container A non-active container to search for a level
 * \param category The category associated with the level to check for
 * \retval non-NULL The level from the container
 * \retval NULL The level does not exist in the container
 */
static void *skel_level_find(struct ao2_container *tmp_container, const char *category);

/*! \brief An aco_type structure to link the "general" category to the skel_global_config type */
static struct aco_type global_option = {
	.type = ACO_GLOBAL,
	.name = "globals",
	.item_offset = offsetof(struct skel_config, global),
	.category_match = ACO_WHITELIST_EXACT,
	.category = "general",
};

struct aco_type *global_options[] = ACO_TYPES(&amp;global_option);

/*! \brief An aco_type structure to link the "sounds" category to the skel_global_config type */
static struct aco_type sound_option = {
	.type = ACO_GLOBAL,
	.name = "sounds",
	.item_offset = offsetof(struct skel_config, global),
	.category_match = ACO_WHITELIST_EXACT,
	.category = "sounds",
};

struct aco_type *sound_options[] = ACO_TYPES(&amp;sound_option);

static const char *level_categories[] = {
	"general",
	"sounds",
	NULL,
};

/*! \brief An aco_type structure to link the everything but the "general" and "sounds" categories to the skel_level type */
static struct aco_type level_option = {
	.type = ACO_ITEM,
	.name = "level",
	.category_match = ACO_BLACKLIST_ARRAY,
	.category = (const char *)level_categories,
	.item_alloc = skel_level_alloc,
	.item_find = skel_level_find,
	.item_offset = offsetof(struct skel_config, levels),
};

struct aco_type *level_options[] = ACO_TYPES(&amp;level_option);

struct aco_file app_skel_conf = {
	.filename = "app_skel.conf",
	.types = ACO_TYPES(&amp;global_option, &amp;sound_option, &amp;level_option),
};

/*! \brief A global object container that will contain the skel_config that gets swapped out on reloads */
static AO2_GLOBAL_OBJ_STATIC(globals);

/*! \brief The container of active games */
static struct ao2_container *games;

/*! \brief Register information about the configs being processed by this module */
CONFIG_INFO_STANDARD(cfg_info, globals, skel_config_alloc,
	.files = ACO_FILES(&amp;app_skel_conf),
);

static void skel_global_config_destructor(void *obj)
{
	struct skel_global_config *global = obj;
	ast_string_field_free_memory(global);
}

static void skel_game_destructor(void *obj)
{
	struct skel_current_game *game = obj;
	ao2_cleanup(game-&gt;level_info);
}

static void skel_state_destructor(void *obj)
{
	return;
}

static struct skel_current_game *skel_game_alloc(struct skel_level *level)
{
	struct skel_current_game *game;
	if (!(game = ao2_alloc(sizeof(struct skel_current_game), skel_game_destructor))) {
		return NULL;
	}
	ao2_ref(level, +1);
	game-&gt;level_info = level;
	return game;
}

static void skel_level_destructor(void *obj)
{
	struct skel_level *level = obj;
	ast_string_field_free_memory(level);
	ao2_cleanup(level-&gt;state);
}

static int skel_level_hash(const void *obj, const int flags)
{
	const struct skel_level *level = obj;
	const char *name = (flags &amp; OBJ_KEY) ? obj : level-&gt;name;
	return ast_str_case_hash(name);
}

static int skel_level_cmp(void *obj, void *arg, int flags)
{
	struct skel_level *one = obj, *two = arg;
	const char *match = (flags &amp; OBJ_KEY) ? arg : two-&gt;name;
	return strcasecmp(one-&gt;name, match) ? 0 : (CMP_MATCH | CMP_STOP);
}

/*! \brief A custom bitfield handler
 * \internal
 * \note It is not possible to take the address of a bitfield, therefor all
 * bitfields in the config struct will have to use a custom handler
 * \param opt The opaque config option
 * \param var The ast_variable containing the option name and value
 * \param obj The object registerd for this option type
 * \retval 0 Success
 * \retval non-zero Failure
 */
static int custom_bitfield_handler(const struct aco_option *opt, struct ast_variable *var, void *obj)
{
	struct skel_global_config *global = obj;

	if (!strcasecmp(var-&gt;name, "cheat")) {
		global-&gt;cheat = ast_true(var-&gt;value);
	} else {
		return -1;
	}

	return 0;
}

static void play_files_helper(struct ast_channel *chan, const char *prompts)
{
	char *prompt, *rest = ast_strdupa(prompts);

	ast_stopstream(chan);
	while ((prompt = strsep(&amp;rest, "&amp;")) &amp;&amp; !ast_stream_and_wait(chan, prompt, "")) {
		ast_stopstream(chan);
	}
}

static int app_exec(struct ast_channel *chan, const char *data)
{
	int win = 0;
	uint32_t guesses;
	RAII_VAR(struct skel_config *, cfg, ao2_global_obj_ref(globals), ao2_cleanup);
	RAII_VAR(struct skel_level *, level, NULL, ao2_cleanup);
	RAII_VAR(struct skel_current_game *, game, NULL, ao2_cleanup);
	char *parse, *opts[OPTION_ARG_ARRAY_SIZE];
	struct ast_flags flags;
	AST_DECLARE_APP_ARGS(args,
		AST_APP_ARG(level);
		AST_APP_ARG(options);
	);

	if (!cfg) {
		ast_log(LOG_ERROR, "Couldn't access configuratino data!\n");
		return -1;
	}

	if (ast_strlen_zero(data)) {
		ast_log(LOG_WARNING, "%s requires an argument (level[,options])\n", app);
		return -1;
	}

	/* We need to make a copy of the input string if we are going to modify it! */
	parse = ast_strdupa(data);

	AST_STANDARD_APP_ARGS(args, parse);

	if (args.argc == 2) {
		ast_app_parse_options(app_opts, &amp;flags, opts, args.options);
	}

	if (ast_strlen_zero(args.level)) {
		ast_log(LOG_ERROR, "%s requires a level argument\n", app);
		return -1;
	}

	if (!(level = ao2_find(cfg-&gt;levels, args.level, OBJ_KEY))) {
		ast_log(LOG_ERROR, "Unknown level: %s\n", args.level);
		return -1;
	}

	if (!(game = skel_game_alloc(level))) {
		return -1;
	}

	ao2_link(games, game);

	/* Use app-specified values, or the options specified in [general] if they aren't passed to the app */
	if (!ast_test_flag(&amp;flags, OPTION_NUMGAMES) ||
			ast_strlen_zero(opts[OPTION_ARG_NUMGAMES]) ||
			ast_parse_arg(opts[OPTION_ARG_NUMGAMES], PARSE_UINT32, &amp;game-&gt;total_games)) {
		game-&gt;total_games = cfg-&gt;global-&gt;num_games;
	}
	game-&gt;games_left = game-&gt;total_games;
	game-&gt;cheat = ast_test_flag(&amp;flags, OPTION_CHEAT) || cfg-&gt;global-&gt;cheat;

	for (game-&gt;games_left = game-&gt;total_games; game-&gt;games_left; game-&gt;games_left--) {
		uint32_t num = ast_random() % level-&gt;max_num; /* random number between 0 and level-&gt;max_num */

		ast_debug(1, "They should totally should guess %u\n", num);

		/* Play the prompt */
		play_files_helper(chan, cfg-&gt;global-&gt;prompt);
		ast_say_number(chan, level-&gt;max_num, "", ast_channel_language(chan), "");

		for (guesses = 0; guesses &lt; level-&gt;max_guesses; guesses++) {
			size_t buflen = log10(level-&gt;max_num) + 1;
			char buf[buflen];
			int guess;
			buf[buflen] = '\0';

			/* Read the number pressed */
			ast_readstring(chan, buf, buflen - 1, 2000, 10000, "");
			if (ast_parse_arg(buf, PARSE_INT32 | PARSE_IN_RANGE, &amp;guess, 0, level-&gt;max_num)) {
				if (guesses &lt; level-&gt;max_guesses - 1) {
					play_files_helper(chan, cfg-&gt;global-&gt;wrong);
				}
				continue;
			}

			/* Inform whether the guess was right, low, or high */
			if (guess == num &amp;&amp; !game-&gt;cheat) {
				/* win */
				win = 1;
				play_files_helper(chan, cfg-&gt;global-&gt;right);
				guesses++;
				break;
			} else if (guess &lt; num) {
				play_files_helper(chan, cfg-&gt;global-&gt;low);
			} else {
				play_files_helper(chan, cfg-&gt;global-&gt;high);
			}

			if (guesses &lt; level-&gt;max_guesses - 1) {
				play_files_helper(chan, cfg-&gt;global-&gt;wrong);
			}
		}

		/* Process game stats */
		ao2_lock(level-&gt;state);
		if (win) {
			++level-&gt;state-&gt;wins;
			level-&gt;state-&gt;avg_guesses = ((level-&gt;state-&gt;wins - 1) * level-&gt;state-&gt;avg_guesses + guesses) / level-&gt;state-&gt;wins;
		} else {
			/* lose */
			level-&gt;state-&gt;losses++;
			play_files_helper(chan, cfg-&gt;global-&gt;lose);
		}
		ao2_unlock(level-&gt;state);
	}

	ao2_unlink(games, game);

	return 0;
}

static struct skel_level *skel_state_alloc(const char *name)
{
	struct skel_level *level;

	if (!(level = ao2_alloc(sizeof(*level), skel_state_destructor))) {
		return NULL;
	}

	return level;
}

static void *skel_level_find(struct ao2_container *tmp_container, const char *category)
{
	return ao2_find(tmp_container, category, OBJ_KEY);
}

/*! \brief Look up an existing state object, or create a new one
 * \internal
 * \note Since the reload code will create a new level from scratch, it
 * is important for any state that must persist between reloads to be
 * in a separate refcounted object. This function allows the level alloc
 * function to get a ref to an existing state object if it exists,
 * otherwise it will return a reference to a newly allocated state object.
 */
static void *skel_find_or_create_state(const char *category)
{
	RAII_VAR(struct skel_config *, cfg, ao2_global_obj_ref(globals), ao2_cleanup);
	RAII_VAR(struct skel_level *, level, NULL, ao2_cleanup);
	if (!cfg || !cfg-&gt;levels || !(level = ao2_find(cfg-&gt;levels, category, OBJ_KEY))) {
		return skel_state_alloc(category);
	}
	ao2_ref(level-&gt;state, +1);
	return level-&gt;state;
}

static void *skel_level_alloc(const char *cat)
{
	struct skel_level *level;

	if (!(level = ao2_alloc(sizeof(*level), skel_level_destructor))) {
		return NULL;
	}

	if (ast_string_field_init(level, 128)) {
		ao2_ref(level, -1);
		return NULL;
	}

	/* Since the level has state information that needs to persist between reloads,
	 * it is important to handle that here in the level's allocation function.
	 * If not separated out into its own object, the data would be destroyed on
	 * reload. */
	if (!(level-&gt;state = skel_find_or_create_state(cat))) {
		ao2_ref(level, -1);
		return NULL;
	}

	ast_string_field_set(level, name, cat);

	return level;
}

static void skel_config_destructor(void *obj)
{
	struct skel_config *cfg = obj;
	ao2_cleanup(cfg-&gt;global);
	ao2_cleanup(cfg-&gt;levels);
}

static void *skel_config_alloc(void)
{
	struct skel_config *cfg;

	if (!(cfg = ao2_alloc(sizeof(*cfg), skel_config_destructor))) {
		return NULL;
	}

	/* Allocate/initialize memory */
	if (!(cfg-&gt;global = ao2_alloc(sizeof(*cfg-&gt;global), skel_global_config_destructor))) {
		goto error;
	}

	if (ast_string_field_init(cfg-&gt;global, 128)) {
		goto error;
	}

	cfg-&gt;levels = ao2_container_alloc_hash(AO2_ALLOC_OPT_LOCK_MUTEX, 0, LEVEL_BUCKETS,
		skel_level_hash, NULL, skel_level_cmp);
	if (!cfg-&gt;levels) {
		goto error;
	}

	return cfg;
error:
	ao2_ref(cfg, -1);
	return NULL;
}

static char *handle_skel_show_config(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)
{
	RAII_VAR(struct skel_config *, cfg, NULL, ao2_cleanup);

	switch(cmd) {
	case CLI_INIT:
		e-&gt;command = "skel show config";
		e-&gt;usage =
			"Usage: skel show config\n"
			"       List app_skel global config\n";
		return NULL;
	case CLI_GENERATE:
		return NULL;
	}

	if (!(cfg = ao2_global_obj_ref(globals)) || !cfg-&gt;global) {
		return NULL;
	}

	ast_cli(a-&gt;fd, "games per call:  %u\n", cfg-&gt;global-&gt;num_games);
	ast_cli(a-&gt;fd, "computer cheats: %s\n", AST_CLI_YESNO(cfg-&gt;global-&gt;cheat));
	ast_cli(a-&gt;fd, "\n");
	ast_cli(a-&gt;fd, "Sounds\n");
	ast_cli(a-&gt;fd, "  prompt:      %s\n", cfg-&gt;global-&gt;prompt);
	ast_cli(a-&gt;fd, "  wrong guess: %s\n", cfg-&gt;global-&gt;wrong);
	ast_cli(a-&gt;fd, "  right guess: %s\n", cfg-&gt;global-&gt;right);

	return CLI_SUCCESS;
}

static char *handle_skel_show_games(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)
{
	struct ao2_iterator iter;
	struct skel_current_game *game;

	switch(cmd) {
	case CLI_INIT:
		e-&gt;command = "skel show games";
		e-&gt;usage =
			"Usage: skel show games\n"
			"       List app_skel active games\n";
		return NULL;
	case CLI_GENERATE:
		return NULL;
	}

#define SKEL_FORMAT "%-15.15s %-15.15s %-15.15s\n"
#define SKEL_FORMAT1 "%-15.15s %-15u %-15u\n"
	ast_cli(a-&gt;fd, SKEL_FORMAT, "Level", "Total Games", "Games Left");
	iter = ao2_iterator_init(games, 0);
	while ((game = ao2_iterator_next(&amp;iter))) {
		ast_cli(a-&gt;fd, SKEL_FORMAT1, game-&gt;level_info-&gt;name, game-&gt;total_games, game-&gt;games_left);
		ao2_ref(game, -1);
	}
	ao2_iterator_destroy(&amp;iter);
#undef SKEL_FORMAT
#undef SKEL_FORMAT1
	return CLI_SUCCESS;
}

static char *handle_skel_show_levels(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)
{
	RAII_VAR(struct skel_config *, cfg, NULL, ao2_cleanup);
	struct ao2_iterator iter;
	struct skel_level *level;

	switch(cmd) {
	case CLI_INIT:
		e-&gt;command = "skel show levels";
		e-&gt;usage =
			"Usage: skel show levels\n"
			"       List the app_skel levels\n";
		return NULL;
	case CLI_GENERATE:
		return NULL;
	}

	if (!(cfg = ao2_global_obj_ref(globals)) || !cfg-&gt;levels) {
		return NULL;
	}

#define SKEL_FORMAT "%-15.15s %-11.11s %-12.12s %-8.8s %-8.8s %-12.12s\n"
#define SKEL_FORMAT1 "%-15.15s %-11u %-12u %-8u %-8u %-8f\n"
	ast_cli(a-&gt;fd, SKEL_FORMAT, "Name", "Max number", "Max Guesses", "Wins", "Losses", "Avg Guesses");
	iter = ao2_iterator_init(cfg-&gt;levels, 0);
	while ((level = ao2_iterator_next(&amp;iter))) {
		ast_cli(a-&gt;fd, SKEL_FORMAT1, level-&gt;name, level-&gt;max_num, level-&gt;max_guesses, level-&gt;state-&gt;wins, level-&gt;state-&gt;losses, level-&gt;state-&gt;avg_guesses);
		ao2_ref(level, -1);
	}
	ao2_iterator_destroy(&amp;iter);
#undef SKEL_FORMAT
#undef SKEL_FORMAT1

	return CLI_SUCCESS;
}

static struct ast_cli_entry skel_cli[] = {
	AST_CLI_DEFINE(handle_skel_show_config, "Show app_skel global config options"),
	AST_CLI_DEFINE(handle_skel_show_levels, "Show app_skel levels"),
	AST_CLI_DEFINE(handle_skel_show_games, "Show app_skel active games"),
};

static int reload_module(void)
{
	if (aco_process_config(&amp;cfg_info, 1) == ACO_PROCESS_ERROR) {
		return AST_MODULE_LOAD_DECLINE;
	}

	return 0;
}

static int unload_module(void)
{
	ast_cli_unregister_multiple(skel_cli, ARRAY_LEN(skel_cli));
	aco_info_destroy(&amp;cfg_info);
	ao2_global_obj_release(globals);
	ao2_cleanup(games);
	return ast_unregister_application(app);
}

/*!
 * \brief Load the module
 *
 * Module loading including tests for configuration or dependencies.
 * This function can return AST_MODULE_LOAD_FAILURE, AST_MODULE_LOAD_DECLINE,
 * or AST_MODULE_LOAD_SUCCESS. If a dependency or environment variable fails
 * tests return AST_MODULE_LOAD_FAILURE. If the module can not load the
 * configuration file or other non-critical problem return
 * AST_MODULE_LOAD_DECLINE. On success return AST_MODULE_LOAD_SUCCESS.
 */
static int load_module(void)
{
	if (aco_info_init(&amp;cfg_info)) {
		goto error;
	}

	games = ao2_container_alloc_list(AO2_ALLOC_OPT_LOCK_MUTEX, 0, NULL, NULL);
	if (!games) {
		goto error;
	}

	/* Global options */
	aco_option_register(&amp;cfg_info, "games", ACO_EXACT, global_options, "3", OPT_UINT_T, 0, FLDSET(struct skel_global_config, num_games));
	aco_option_register_custom(&amp;cfg_info, "cheat", ACO_EXACT, global_options, "no", custom_bitfield_handler, 0);

	/* Sound options */
	aco_option_register(&amp;cfg_info, "prompt", ACO_EXACT, sound_options, "please-enter-your&amp;number&amp;queue-less-than", OPT_STRINGFIELD_T, 0, STRFLDSET(struct skel_global_config, prompt));
	aco_option_register(&amp;cfg_info, "wrong_guess", ACO_EXACT, sound_options, "vm-pls-try-again", OPT_STRINGFIELD_T, 0, STRFLDSET(struct skel_global_config, wrong));
	aco_option_register(&amp;cfg_info, "right_guess", ACO_EXACT, sound_options, "auth-thankyou", OPT_STRINGFIELD_T, 0, STRFLDSET(struct skel_global_config, right));
	aco_option_register(&amp;cfg_info, "too_high", ACO_EXACT, sound_options, "high", OPT_STRINGFIELD_T, 0, STRFLDSET(struct skel_global_config, high));
	aco_option_register(&amp;cfg_info, "too_low", ACO_EXACT, sound_options, "low", OPT_STRINGFIELD_T, 0, STRFLDSET(struct skel_global_config, low));
	aco_option_register(&amp;cfg_info, "lose", ACO_EXACT, sound_options, "vm-goodbye", OPT_STRINGFIELD_T, 0, STRFLDSET(struct skel_global_config, lose));

	/* Level options */
	aco_option_register(&amp;cfg_info, "max_number", ACO_EXACT, level_options, NULL, OPT_UINT_T, 0, FLDSET(struct skel_level, max_num));
	aco_option_register(&amp;cfg_info, "max_guesses", ACO_EXACT, level_options, NULL, OPT_UINT_T, 0, FLDSET(struct skel_level, max_guesses));

	if (aco_process_config(&amp;cfg_info, 0) == ACO_PROCESS_ERROR) {
		goto error;
	}

	ast_cli_register_multiple(skel_cli, ARRAY_LEN(skel_cli));
	if (ast_register_application_xml(app, app_exec)) {
		goto error;
	}
	return AST_MODULE_LOAD_SUCCESS;

error:
	aco_info_destroy(&amp;cfg_info);
	ao2_cleanup(games);
	return AST_MODULE_LOAD_DECLINE;
}

AST_MODULE_INFO(ASTERISK_GPL_KEY, AST_MODFLAG_DEFAULT, "Skeleton (sample) Application",
	.support_level = AST_MODULE_SUPPORT_CORE,
	.load = load_module,
	.unload = unload_module,
	.reload = reload_module,
);
</pre></dd></dl>
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Asterisk -- An open source telephony toolkit.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * See http://www.asterisk.org for more information about</span></div><div class="line"><span class="comment"> * the Asterisk project. Please do not directly contact</span></div><div class="line"><span class="comment"> * any of the maintainers of this project for assistance;</span></div><div class="line"><span class="comment"> * the project provides a web site, mailing lists and IRC</span></div><div class="line"><span class="comment"> * channels for your use.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is free software, distributed under the terms of</span></div><div class="line"><span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span></div><div class="line"><span class="comment"> * at the top of the source tree.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*! \file</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * \brief Convenient Application Routines</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** \example</span></div><div class="line"><span class="comment"> * \par This is an example of how to develop an app.</span></div><div class="line"><span class="comment"> * Application Skeleton is an example of creating an application for Asterisk.</span></div><div class="line"><span class="comment"> * \verbinclude app_skel.c</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="comment">/*** MODULEINFO</span></div><div class="line"><span class="comment">   &lt;support_level&gt;core&lt;/support_level&gt;</span></div><div class="line"><span class="comment"> ***/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../db/db2/asterisk_8h.html">asterisk.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef HAVE_SYS_STAT_H</span></div><div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#include &lt;regex.h&gt;</span>          <span class="comment">/* for regcomp(3) */</span></div><div class="line"><span class="preprocessor">#include &lt;sys/file.h&gt;</span>       <span class="comment">/* for flock(2) */</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span>         <span class="comment">/* for pthread_sigmask(3) */</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span>         <span class="comment">/* for closefrom(3) */</span></div><div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/wait.h&gt;</span>       <span class="comment">/* for waitpid(2) */</span></div><div class="line"><span class="preprocessor">#ifndef HAVE_CLOSEFROM</span></div><div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span>         <span class="comment">/* for opendir(3)   */</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#ifdef HAVE_CAP</span></div><div class="line"><span class="preprocessor">#include &lt;sys/capability.h&gt;</span></div><div class="line"><span class="preprocessor">#endif </span><span class="comment">/* HAVE_CAP */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dd/df2/paths_8h.html">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_DATA_DIR */</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d7b/channel_8h.html">asterisk/channel.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../db/de0/pbx_8h.html">asterisk/pbx.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4d/file_8h.html">asterisk/file.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html">asterisk/app.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/d08/dsp_8h.html">asterisk/dsp.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d60/utils_8h.html">asterisk/utils.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dd/d42/lock_8h.html">asterisk/lock.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d0f/indications_8h.html">asterisk/indications.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d90/linkedlists_8h.html">asterisk/linkedlists.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d7d/threadstorage_8h.html">asterisk/threadstorage.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/ddc/test_8h.html">asterisk/test.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d16/module_8h.html">asterisk/module.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d5/da5/astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dd/d79/stasis_8h.html">asterisk/stasis.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d9/d4a/stasis__channels_8h.html">asterisk/stasis_channels.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d4/d05/json_8h.html">asterisk/json.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../db/d1c/format__cache_8h.html">asterisk/format_cache.h</a>&quot;</span></div><div class="line"></div><div class="line"><a name="a0"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a081cae3d9afd0b524cb602f94091ed7a">AST_THREADSTORAGE_PUBLIC</a>(ast_str_thread_global_buf);</div><div class="line"></div><div class="line"><span class="keyword">static</span> pthread_t <a name="a1"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a30573cb092e715a2e4bbc2d77b9fc1df">shaun_of_the_dead_thread</a> = <a name="a2"></a><a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a name="_a3"></a><a class="code" href="../../d9/dee/structzombie.html">zombie</a> {</div><div class="line">   pid_t <a name="a4"></a><a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>;</div><div class="line">   <a name="a5"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7">AST_LIST_ENTRY</a>(<a class="code" href="../../d9/dee/structzombie.html">zombie</a>) <a name="a6"></a><a class="code" href="../../d9/dee/structzombie.html#a5bd10d1c7630722dd91dbfca2156072c">list</a>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a name="a7"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b">AST_LIST_HEAD_STATIC</a>(<a name="_a8"></a><a class="code" href="../../dc/d57/structzombies.html">zombies</a>, <a class="code" href="../../d9/dee/structzombie.html">zombie</a>);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef HAVE_CAP</span></div><div class="line"><span class="keyword">static</span> cap_t <a name="a9"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a0e01e4a7836c72a22f08f824d366ffb0">child_cap</a>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * @{ \brief Define \ref stasis topic objects</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a10"></a><a class="code" href="../../d9/d1d/structstasis__topic.html">stasis_topic</a> *<a name="a11"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a6faa8563ee6f21a1e504dd8b7c3dd5b2">queue_topic_all</a>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a12"></a><a class="code" href="../../d1/d65/structstasis__topic__pool.html">stasis_topic_pool</a> *<a name="a13"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a674c31d6219e0edf34999357375f77da">queue_topic_pool</a>;</div><div class="line"><span class="comment">/* @} */</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *<a name="a14"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a7696b4a837797103e8fad638d5b4615d">shaun_of_the_dead</a>(<span class="keywordtype">void</span> *data)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d9/dee/structzombie.html">zombie</a> *cur;</div><div class="line">   <span class="keywordtype">int</span> <a name="a15"></a><a class="code" href="../../de/dcd/app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;</div><div class="line">   <span class="keywordflow">for</span> (;;) {</div><div class="line">      <span class="keywordflow">if</span> (!<a name="a16"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05">AST_LIST_EMPTY</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>)) {</div><div class="line">         <span class="comment">/* Don&#39;t allow cancellation while we have a lock. */</span></div><div class="line">         pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, <a name="a17"></a><a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">         <a name="a18"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>);</div><div class="line">         <a name="a19"></a><a class="code" href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>, cur, <a class="code" href="../../d9/dee/structzombie.html#a5bd10d1c7630722dd91dbfca2156072c">list</a>) {</div><div class="line">            <span class="keywordflow">if</span> (waitpid(cur-&gt;<a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>, &amp;status, WNOHANG) != 0) {</div><div class="line">               <a name="a20"></a><a class="code" href="../../df/d90/linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c">AST_LIST_REMOVE_CURRENT</a>(<a class="code" href="../../d9/dee/structzombie.html#a5bd10d1c7630722dd91dbfca2156072c">list</a>);</div><div class="line">               <a name="a21"></a><a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cur);</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <a name="a22"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a></div><div class="line">         <a name="a23"></a><a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>);</div><div class="line">         pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">      }</div><div class="line">      pthread_testcancel();</div><div class="line">      <span class="comment">/* Wait for 60 seconds, without engaging in a busy loop. */</span></div><div class="line">      <a name="a24"></a><a class="code" href="../../d4/dfb/poll-compat_8h.html#a5a0c58fa8311e94cd0ed34382aa822f9">ast_poll</a>(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a name="a25"></a><a class="code" href="../../df/d90/linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5">AST_LIST_FIRST</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>) ? 5000 : 60000);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#define AST_MAX_FORMATS 10</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a name="a26"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a39918fd433ac42184b152c86016ef139">AST_RWLIST_HEAD_STATIC</a>(<a name="_a27"></a><a class="code" href="../../d9/d28/structgroups.html">groups</a>, <a name="_a28"></a><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a>);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*!</span></div><div class="line"><span class="comment"> * \brief This function presents a dialtone and reads an extension into &#39;collect&#39;</span></div><div class="line"><span class="comment"> * which must be a pointer to a **pre-initialized** array of char having a</span></div><div class="line"><span class="comment"> * size of &#39;size&#39; suitable for writing to.  It will collect no more than the smaller</span></div><div class="line"><span class="comment"> * of &#39;maxlen&#39; or &#39;size&#39; minus the original strlen() of collect digits.</span></div><div class="line"><span class="comment"> * \param chan struct.</span></div><div class="line"><span class="comment"> * \param context</span></div><div class="line"><span class="comment"> * \param collect</span></div><div class="line"><span class="comment"> * \param size</span></div><div class="line"><span class="comment"> * \param maxlen</span></div><div class="line"><span class="comment"> * \param timeout timeout in milliseconds</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * \return 0 if extension does not exist, 1 if extension exists</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keywordtype">int</span> <a name="a29"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af4825b337b9cd145a059852ce85ec6cd">ast_app_dtget</a>(<span class="keyword">struct</span> <a name="_a30"></a><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a31"></a><a class="code" href="../../da/d45/chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">char</span> *collect, <span class="keywordtype">size_t</span> size, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">int</span> <a name="a32"></a><a class="code" href="../../d0/d29/cdr__mysql_8c.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a name="_a33"></a><a class="code" href="../../d5/dab/structast__tone__zone__sound.html">ast_tone_zone_sound</a> *ts;</div><div class="line">   <span class="keywordtype">int</span> res = 0, x = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (maxlen &gt; size) {</div><div class="line">      maxlen = size;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!timeout) {</div><div class="line">      <span class="keywordflow">if</span> (<a name="a34"></a><a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan) &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan)-&gt;dtimeoutms) {</div><div class="line">         timeout = <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan)-&gt;<a name="a35"></a><a class="code" href="../../d6/d83/structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a>;</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         timeout = 5000;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((ts = <a name="a36"></a><a class="code" href="../../d2/d0f/indications_8h.html#a516be2823557000dcd4be685a44d1d09">ast_get_indication_tone</a>(<a name="a37"></a><a class="code" href="../../d5/d7b/channel_8h.html#a673d53e20b8ac75477469442f51314e1">ast_channel_zone</a>(chan), <span class="stringliteral">&quot;dial&quot;</span>))) {</div><div class="line">      res = <a name="a38"></a><a class="code" href="../../d2/d0f/indications_8h.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, ts-&gt;<a name="a39"></a><a class="code" href="../../d5/dab/structast__tone__zone__sound.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, 0);</div><div class="line">      ts = <a name="a40"></a><a class="code" href="../../d2/d0f/indications_8h.html#a8b52ace68f21c0ac24414f038471647d">ast_tone_zone_sound_unref</a>(ts);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a name="a41"></a><a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a name="a42"></a><a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Huh....? no dial for indications?\n&quot;</span>);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span> (x = strlen(collect); x &lt; maxlen; ) {</div><div class="line">      res = <a name="a43"></a><a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, timeout);</div><div class="line">      <span class="keywordflow">if</span> (!<a name="a44"></a><a class="code" href="../../db/de0/pbx_8h.html#aa73d176ed4f1ce51e5db6beafba45fe3">ast_ignore_pattern</a>(context, collect)) {</div><div class="line">         <a name="a45"></a><a class="code" href="../../d2/d0f/indications_8h.html#a9d5be069b7060d326a213f5d60b8dc77">ast_playtones_stop</a>(chan);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (res &lt; 1) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (res == <span class="charliteral">&#39;#&#39;</span>) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">      collect[x++] = res;</div><div class="line">      <span class="keywordflow">if</span> (!<a name="a46"></a><a class="code" href="../../db/de0/pbx_8h.html#ac359af75b9494f50904583d2168a7577">ast_matchmore_extension</a>(chan, context, collect, 1,</div><div class="line">         <a name="a47"></a><a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a name="a48"></a><a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a name="_a49"></a><a class="code" href="../../d6/d49/structnumber.html">number</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d6/d49/structnumber.html">number</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (res &gt;= 0) {</div><div class="line">      res = <a name="a50"></a><a class="code" href="../../db/de0/pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7">ast_exists_extension</a>(chan, context, collect, 1,</div><div class="line">         <a class="code" href="../../d6/d90/strings_8h.html#a38a896048b2ca84076864505f0aa8f01">S_COR</a>(<a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d6/d49/structnumber.html">number</a>.valid, <a class="code" href="../../d5/d7b/channel_8h.html#ac2dc872b606534943c98304aed841b34">ast_channel_caller</a>(chan)-&gt;<span class="keywordtype">id</span>.<a class="code" href="../../d6/d49/structnumber.html">number</a>.str, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) ? 1 : 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*!</span></div><div class="line"><span class="comment"> * \brief ast_app_getdata</span></div><div class="line"><span class="comment"> * \param c The channel to read from</span></div><div class="line"><span class="comment"> * \param prompt The file to stream to the channel</span></div><div class="line"><span class="comment"> * \param s The string to read in to.  Must be at least the size of your length</span></div><div class="line"><span class="comment"> * \param maxlen How many digits to read (maximum)</span></div><div class="line"><span class="comment"> * \param timeout set timeout to 0 for &quot;standard&quot; timeouts. Set timeout to -1 for</span></div><div class="line"><span class="comment"> *      &quot;ludicrous time&quot; (essentially never times out) */</span></div><div class="line"><span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a10624bc470a4ac2634221dfa74bdb17f">ast_getdata_result</a> <a name="a51"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af3f76858d4dd513e59dbe5e67bc46220">ast_app_getdata</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *<a name="a52"></a><a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a53"></a><a class="code" href="../../d5/d03/asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a>, <span class="keywordtype">char</span> *s, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">int</span> timeout)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0, to, fto;</div><div class="line">   <span class="keywordtype">char</span> *front, *filename;</div><div class="line"></div><div class="line">   <span class="comment">/* XXX Merge with full version? XXX */</span></div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (maxlen)</div><div class="line">      s[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!prompt)</div><div class="line">      prompt = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"></div><div class="line">   filename = <a name="a54"></a><a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(prompt);</div><div class="line">   <span class="keywordflow">while</span> ((front = <a name="a55"></a><a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;filename, <span class="stringliteral">&quot;&amp;&quot;</span>))) {</div><div class="line">      <span class="keywordflow">if</span> (!<a name="a56"></a><a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(front)) {</div><div class="line">         res = <a name="a57"></a><a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(c, front, <a name="a58"></a><a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(c));</div><div class="line">         <span class="keywordflow">if</span> (res)</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(filename)) {</div><div class="line">         <span class="comment">/* set timeouts for the last prompt */</span></div><div class="line">         fto = <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(c) ? <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(c)-&gt;<a name="a59"></a><a class="code" href="../../d6/d83/structast__pbx.html#a765bfb11e07b0f90c235c9af9d7f46fa">rtimeoutms</a> : 6000;</div><div class="line">         to = <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(c) ? <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(c)-&gt;<a class="code" href="../../d6/d83/structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> : 2000;</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> (timeout &gt; 0) {</div><div class="line">            fto = to = <a class="code" href="../../d0/d29/cdr__mysql_8c.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (timeout &lt; 0) {</div><div class="line">            fto = to = 1000000000;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <span class="comment">/* there is more than one prompt, so</span></div><div class="line"><span class="comment">          * get rid of the long timeout between</span></div><div class="line"><span class="comment">          * prompts, and make it 50ms */</span></div><div class="line">         fto = 50;</div><div class="line">         to = <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(c) ? <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(c)-&gt;<a class="code" href="../../d6/d83/structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> : 2000;</div><div class="line">      }</div><div class="line">      res = <a name="a60"></a><a class="code" href="../../d5/d7b/channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(c, s, maxlen, to, fto, <span class="stringliteral">&quot;#&quot;</span>);</div><div class="line">      <span class="keywordflow">if</span> (res == <a name="a61"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a10624bc470a4ac2634221dfa74bdb17fa94425459ee6ac7993c6289fde4d4ea8c">AST_GETDATA_EMPTY_END_TERMINATED</a>) {</div><div class="line">         <span class="keywordflow">return</span> res;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(s)) {</div><div class="line">         <span class="keywordflow">return</span> res;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* The lock type used by ast_lock_path() / ast_unlock_path() */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241">AST_LOCK_TYPE</a> <a class="code" href="../../dd/d42/lock_8h.html#a91005557686d603e1210a200ef97153d">ast_lock_type</a> = <a name="a62"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a63"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a102e325938d4d6617af28b7f1afce7ef">ast_app_getdata_full</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *prompt, <span class="keywordtype">char</span> *s, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res, to = 2000, fto = 6000;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(prompt)) {</div><div class="line">      res = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(c, prompt, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(c));</div><div class="line">      <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">         <span class="keywordflow">return</span> res;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (timeout &gt; 0) {</div><div class="line">      fto = to = <a class="code" href="../../d0/d29/cdr__mysql_8c.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (timeout &lt; 0) {</div><div class="line">      fto = to = 1000000000;</div><div class="line">   }</div><div class="line"></div><div class="line">   res = <a name="a64"></a><a class="code" href="../../d5/d7b/channel_8h.html#a1d7f4bf19db3f1b8a3524593f002fedf">ast_readstring_full</a>(c, s, maxlen, to, fto, <span class="stringliteral">&quot;#&quot;</span>, audiofd, ctrlfd);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a65"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aaf3af8d672383b48d194deb468074cbe">ast_app_exec_macro</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *autoservice_chan, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *macro_chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *macro_args)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a name="_a66"></a><a class="code" href="../../d0/da3/structast__app.html">ast_app</a> *macro_app;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line"></div><div class="line">   macro_app = <a name="a67"></a><a class="code" href="../../db/de0/pbx_8h.html#ad4a6912dcd2ad44a186d0a284afafc51">pbx_findapp</a>(<span class="stringliteral">&quot;Macro&quot;</span>);</div><div class="line">   <span class="keywordflow">if</span> (!macro_app) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a name="a68"></a><a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,</div><div class="line">         <span class="stringliteral">&quot;Cannot run &#39;Macro(%s)&#39;.  The application is not available.\n&quot;</span>, macro_args);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (autoservice_chan) {</div><div class="line">      <a name="a69"></a><a class="code" href="../../d5/d7b/channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9">ast_autoservice_start</a>(autoservice_chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   <a name="a70"></a><a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;%s Original location: %s,%s,%d\n&quot;</span>, <a name="a71"></a><a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(macro_chan),</div><div class="line">      <a name="a72"></a><a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(macro_chan), <a name="a73"></a><a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(macro_chan),</div><div class="line">      <a name="a74"></a><a class="code" href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a>(macro_chan));</div><div class="line"></div><div class="line">   res = <a name="a75"></a><a class="code" href="../../db/de0/pbx_8h.html#a6e3dbc57c03c23543354ef108c31fac8">pbx_exec</a>(macro_chan, macro_app, macro_args);</div><div class="line">   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;Macro exited with status %d\n&quot;</span>, res);</div><div class="line"></div><div class="line">   <span class="comment">/*</span></div><div class="line"><span class="comment">    * Assume anything negative from Macro is an error.</span></div><div class="line"><span class="comment">    * Anything else is success.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">      res = -1;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      res = 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(4, <span class="stringliteral">&quot;%s Ending location: %s,%s,%d\n&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(macro_chan),</div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#a582dee4d5ea9b2ff6f309f0c5239f6bd">ast_channel_context</a>(macro_chan), <a class="code" href="../../d5/d7b/channel_8h.html#aa8b52fbc8168e939bc5553502367d46a">ast_channel_exten</a>(macro_chan),</div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#a6610c8171ced0a69738622c11736ff5e">ast_channel_priority</a>(macro_chan));</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (autoservice_chan) {</div><div class="line">      <a name="a76"></a><a class="code" href="../../d5/d7b/channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b">ast_autoservice_stop</a>(autoservice_chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a name="a77"></a><a class="code" href="../../d5/d7b/channel_8h.html#a723ac44c92b9edb6c1a731e01edacb4a">ast_check_hangup_locked</a>(macro_chan)) {</div><div class="line">      <a name="a78"></a><a class="code" href="../../d5/d7b/channel_8h.html#a30bcf0418189567bc84ff32034f79f28">ast_queue_hangup</a>(macro_chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a79"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a2fdf117969c2c1d8e1f0044d7c3ecd3b">ast_app_run_macro</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *autoservice_chan, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *macro_chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *macro_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *macro_args)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordtype">char</span> *args_str;</div><div class="line">   <span class="keywordtype">size_t</span> args_len;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(macro_args)) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aaf3af8d672383b48d194deb468074cbe">ast_app_exec_macro</a>(autoservice_chan, macro_chan, macro_name);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Create the Macro application argument string. */</span></div><div class="line">   args_len = strlen(macro_name) + strlen(macro_args) + 2;</div><div class="line">   args_str = <a name="a80"></a><a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>(args_len);</div><div class="line">   <span class="keywordflow">if</span> (!args_str) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   snprintf(args_str, args_len, <span class="stringliteral">&quot;%s,%s&quot;</span>, macro_name, macro_args);</div><div class="line"></div><div class="line">   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aaf3af8d672383b48d194deb468074cbe">ast_app_exec_macro</a>(autoservice_chan, macro_chan, args_str);</div><div class="line">   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(args_str);</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* BUGBUG this is not thread safe. */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a81"></a><a class="code" href="../../d9/d3e/structast__app__stack__funcs.html">ast_app_stack_funcs</a> *<a name="a82"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a469da08184562e4040d91459db01be10">app_stack_callbacks</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a83"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a82224d29f5f5288c09279a9a6a69f09c">ast_install_stack_functions</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d9/d3e/structast__app__stack__funcs.html">ast_app_stack_funcs</a> *funcs)</div><div class="line">{</div><div class="line">   app_stack_callbacks = funcs;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a84"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1a168653d77787b51d3447e5e80d42bb">ast_app_expand_sub_args</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a85"></a><a class="code" href="../../d5/dde/test__func__file_8c.html#a7df83d295429a2562396f1ec127a46c0">args</a>)</div><div class="line">{</div><div class="line">   <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d9/d3e/structast__app__stack__funcs.html">ast_app_stack_funcs</a> *funcs;</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *new_args;</div><div class="line"></div><div class="line">   funcs = <a class="code" href="../../d3/d83/main_2app_8c.html#a469da08184562e4040d91459db01be10">app_stack_callbacks</a>;</div><div class="line">   <span class="keywordflow">if</span> (!funcs || !funcs-&gt;<a name="a86"></a><a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a8ff1d595c8e420c7910771bf9b24794e">expand_sub_args</a> || !<a name="a87"></a><a class="code" href="../../d5/d16/module_8h.html#ad2dd3dce05926913c40b883cc7cff0a8">ast_module_running_ref</a>(funcs-&gt;<a name="a88"></a><a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a59fcda1946fe2178896b5967065904e6">module</a>)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,</div><div class="line">         <span class="stringliteral">&quot;Cannot expand &#39;Gosub(%s)&#39; arguments.  The app_stack module is not available.\n&quot;</span>,</div><div class="line">         args);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   new_args = funcs-&gt;<a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a8ff1d595c8e420c7910771bf9b24794e">expand_sub_args</a>(chan, args);</div><div class="line">   <a name="a89"></a><a class="code" href="../../d5/d16/module_8h.html#a15896c26e51e8162df5eb9a0124c841f">ast_module_unref</a>(funcs-&gt;<a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a59fcda1946fe2178896b5967065904e6">module</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> new_args;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a90"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aee5e20694b04eee43463fde6cf121d06">ast_app_exec_sub</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *autoservice_chan, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *sub_chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *sub_args, <span class="keywordtype">int</span> <a name="a91"></a><a class="code" href="../../de/d26/app__externalivr_8c.html#ad7e8792fbe134499827a9171f0f6491ea96a84a93b0268cefea3c2be2d521e2c5">ignore_hangup</a>)</div><div class="line">{</div><div class="line">   <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d9/d3e/structast__app__stack__funcs.html">ast_app_stack_funcs</a> *funcs;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line"></div><div class="line">   funcs = <a class="code" href="../../d3/d83/main_2app_8c.html#a469da08184562e4040d91459db01be10">app_stack_callbacks</a>;</div><div class="line">   <span class="keywordflow">if</span> (!funcs || !funcs-&gt;<a name="a92"></a><a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a55ff830cab7753e929ad073af898830d">run_sub</a> || !<a class="code" href="../../d5/d16/module_8h.html#ad2dd3dce05926913c40b883cc7cff0a8">ast_module_running_ref</a>(funcs-&gt;<a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a59fcda1946fe2178896b5967065904e6">module</a>)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,</div><div class="line">         <span class="stringliteral">&quot;Cannot run &#39;Gosub(%s)&#39;.  The app_stack module is not available.\n&quot;</span>,</div><div class="line">         sub_args);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (autoservice_chan) {</div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9">ast_autoservice_start</a>(autoservice_chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   res = funcs-&gt;<a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a55ff830cab7753e929ad073af898830d">run_sub</a>(sub_chan, sub_args, ignore_hangup);</div><div class="line">   <a class="code" href="../../d5/d16/module_8h.html#a15896c26e51e8162df5eb9a0124c841f">ast_module_unref</a>(funcs-&gt;<a class="code" href="../../d9/d3e/structast__app__stack__funcs.html#a59fcda1946fe2178896b5967065904e6">module</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (autoservice_chan) {</div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b">ast_autoservice_stop</a>(autoservice_chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!ignore_hangup &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a723ac44c92b9edb6c1a731e01edacb4a">ast_check_hangup_locked</a>(sub_chan)) {</div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#a30bcf0418189567bc84ff32034f79f28">ast_queue_hangup</a>(sub_chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a93"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a437a314deb7eb7260014426c55e8289c">ast_app_run_sub</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *autoservice_chan, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *sub_chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *sub_location, <span class="keyword">const</span> <span class="keywordtype">char</span> *sub_args, <span class="keywordtype">int</span> ignore_hangup)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordtype">char</span> *args_str;</div><div class="line">   <span class="keywordtype">size_t</span> args_len;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(sub_args)) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aee5e20694b04eee43463fde6cf121d06">ast_app_exec_sub</a>(autoservice_chan, sub_chan, sub_location, ignore_hangup);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Create the Gosub application argument string. */</span></div><div class="line">   args_len = strlen(sub_location) + strlen(sub_args) + 3;</div><div class="line">   args_str = <a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>(args_len);</div><div class="line">   <span class="keywordflow">if</span> (!args_str) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   snprintf(args_str, args_len, <span class="stringliteral">&quot;%s(%s)&quot;</span>, sub_location, sub_args);</div><div class="line"></div><div class="line">   res = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aee5e20694b04eee43463fde6cf121d06">ast_app_exec_sub</a>(autoservice_chan, sub_chan, args_str, ignore_hangup);</div><div class="line">   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(args_str);</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*! \brief The container for the voicemail provider */</span></div><div class="line"><span class="keyword">static</span> <a name="a94"></a><a class="code" href="../../d5/da5/astobj2_8h.html#a1a0a7797433247c77accfd5a94d9e4a5">AO2_GLOBAL_OBJ_STATIC</a>(vm_provider);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*! Voicemail not registered warning */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a95"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ac3f5ef8c1385be5dc0d39b54436fbb85">vm_warnings</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a96"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ae0d83cafb3ae5725be81625b4a211f84">ast_vm_is_registered</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a name="_a97"></a><a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *<a name="a98"></a><a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;</div><div class="line">   <span class="keywordtype">int</span> is_registered;</div><div class="line"></div><div class="line">   table = <a name="a99"></a><a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_provider);</div><div class="line">   is_registered = table ? 1 : 0;</div><div class="line">   <a name="a100"></a><a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(table);</div><div class="line">   <span class="keywordflow">return</span> is_registered;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a101"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1ab8f4fb96c8ae6e8a04d9dcd30f160b">__ast_vm_register</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *<a name="a102"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">vm_table</a>, <span class="keyword">struct</span> <a name="_a103"></a><a class="code" href="../../d9/df5/structast__module.html">ast_module</a> *<a name="a104"></a><a class="code" href="../../df/d7c/structast__vm__functions.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>)</div><div class="line">{</div><div class="line">   <a name="a105"></a><a class="code" href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *, <a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!vm_table-&gt;<a name="a106"></a><a class="code" href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a name="a107"></a><a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Voicemail provider missing required information.\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (vm_table-&gt;<a name="a108"></a><a class="code" href="../../df/d7c/structast__vm__functions.html#a19dd3d3916fd1aa9a70c45c43d24b6f5">module_version</a> != <a name="a109"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a846b39f5cdf1508035ac658f26a5e933">VM_MODULE_VERSION</a>) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Voicemail provider &#39;%s&#39; has incorrect version\n&quot;</span>,</div><div class="line">         vm_table-&gt;<a class="code" href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a> = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_provider);</div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Voicemail provider already registered by %s.\n&quot;</span>,</div><div class="line">         <a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>-&gt;module_name);</div><div class="line">      <span class="keywordflow">return</span> <a name="a110"></a><a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a> = <a name="a111"></a><a class="code" href="../../d5/da5/astobj2_8h.html#ab3c44e28d661616129b7819069effe61">ao2_alloc_options</a>(<span class="keyword">sizeof</span>(*<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a name="a112"></a><a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a23b60f2636bcfbc4dfeea6cc21bf847b">AO2_ALLOC_OPT_LOCK_NOLOCK</a>);</div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   *<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a> = *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">vm_table</a>;</div><div class="line">   <a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>-&gt;module = <a class="code" href="../../df/d7c/structast__vm__functions.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>;</div><div class="line"></div><div class="line">   <a name="a113"></a><a class="code" href="../../d5/da5/astobj2_8h.html#a3a11e1a1d3e99bed3ea0a7c57a3880d7">ao2_global_obj_replace_unref</a>(vm_provider, <a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>);</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a114"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aab65d2013da7fcbb28da422712bac5e8">ast_vm_unregister</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;</div><div class="line"></div><div class="line">   table = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_provider);</div><div class="line">   <span class="keywordflow">if</span> (table &amp;&amp; !strcmp(table-&gt;<a class="code" href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>, module_name)) {</div><div class="line">      <a name="a115"></a><a class="code" href="../../d5/da5/astobj2_8h.html#ac0e1cbc7cf050c8b7b8e3a8fee92c50e">ao2_global_obj_release</a>(vm_provider);</div><div class="line">   }</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(table);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><span class="comment">/*! \brief Holding container for the voicemail provider used while testing */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d5/da5/astobj2_8h.html#a1a0a7797433247c77accfd5a94d9e4a5">AO2_GLOBAL_OBJ_STATIC</a>(vm_provider_holder);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a116"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a0140ad24206ae7215b855360b9f3c2af">provider_is_swapped</a> = 0;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a117"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a014da687f3ee9369aaccf3535cbca3ef">ast_vm_test_swap_table_in</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *vm_table)</div><div class="line">{</div><div class="line">   <a class="code" href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *, holding_table, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>);</div><div class="line">   <a class="code" href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *, new_table, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (provider_is_swapped) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Attempted to swap in test function table without swapping out old test table.\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   holding_table = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_provider);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (holding_table) {</div><div class="line">      <a class="code" href="../../d5/da5/astobj2_8h.html#a3a11e1a1d3e99bed3ea0a7c57a3880d7">ao2_global_obj_replace_unref</a>(vm_provider_holder, holding_table);</div><div class="line">   }</div><div class="line"></div><div class="line">   new_table = <a class="code" href="../../d5/da5/astobj2_8h.html#ab3c44e28d661616129b7819069effe61">ao2_alloc_options</a>(<span class="keyword">sizeof</span>(*new_table), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a23b60f2636bcfbc4dfeea6cc21bf847b">AO2_ALLOC_OPT_LOCK_NOLOCK</a>);</div><div class="line">   <span class="keywordflow">if</span> (!new_table) {</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line">   *new_table = *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">vm_table</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a3a11e1a1d3e99bed3ea0a7c57a3880d7">ao2_global_obj_replace_unref</a>(vm_provider, new_table);</div><div class="line">   provider_is_swapped = 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a118"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a049ae8f14b4d323f5c357f6956b909b0">ast_vm_test_swap_table_out</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <a class="code" href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d7c/structast__vm__functions.html">ast_vm_functions</a> *, held_table, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!provider_is_swapped) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Attempted to swap out test function table, but none is currently installed.\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   held_table = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_provider_holder);</div><div class="line">   <span class="keywordflow">if</span> (!held_table) {</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a3a11e1a1d3e99bed3ea0a7c57a3880d7">ao2_global_obj_replace_unref</a>(vm_provider, held_table);</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#ac0e1cbc7cf050c8b7b8e3a8fee92c50e">ao2_global_obj_release</a>(vm_provider_holder);</div><div class="line">   provider_is_swapped = 0;</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*! \brief The container for the voicemail greeter provider */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d5/da5/astobj2_8h.html#a1a0a7797433247c77accfd5a94d9e4a5">AO2_GLOBAL_OBJ_STATIC</a>(vm_greeter_provider);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*! Voicemail greeter not registered warning */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a119"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ab690c43575fbc376d43f93e542265f2d">vm_greeter_warnings</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a120"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aa0ccb2aa4c974e75e9654a0e0a03ebc6">ast_vm_greeter_is_registered</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a name="_a121"></a><a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html">ast_vm_greeter_functions</a> *<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;</div><div class="line">   <span class="keywordtype">int</span> is_registered;</div><div class="line"></div><div class="line">   table = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_greeter_provider);</div><div class="line">   is_registered = table ? 1 : 0;</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(table);</div><div class="line">   <span class="keywordflow">return</span> is_registered;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a122"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a0354eb3cde675cc872e2e445ad7de7d7">__ast_vm_greeter_register</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html">ast_vm_greeter_functions</a> *vm_table, <span class="keyword">struct</span> <a class="code" href="../../d9/df5/structast__module.html">ast_module</a> *module)</div><div class="line">{</div><div class="line">   <a class="code" href="../../d5/d60/utils_8h.html#a1604b4d72144dd3d9f7da668e90337e9">RAII_VAR</a>(<span class="keyword">struct</span> <a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html">ast_vm_greeter_functions</a> *, table, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!vm_table-&gt;<a name="a123"></a><a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Voicemail greeter provider missing required information.\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (vm_table-&gt;<a name="a124"></a><a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a19dd3d3916fd1aa9a70c45c43d24b6f5">module_version</a> != <a name="a125"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a789b147df36d769c1c0d55051f655c7f">VM_GREETER_MODULE_VERSION</a>) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Voicemail greeter provider &#39;%s&#39; has incorrect version\n&quot;</span>,</div><div class="line">         vm_table-&gt;<a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   table = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_greeter_provider);</div><div class="line">   <span class="keywordflow">if</span> (table) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Voicemail greeter provider already registered by %s.\n&quot;</span>,</div><div class="line">         table-&gt;<a class="code" href="../../df/d7c/structast__vm__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d5/d16/module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   table = <a class="code" href="../../d5/da5/astobj2_8h.html#ab3c44e28d661616129b7819069effe61">ao2_alloc_options</a>(<span class="keyword">sizeof</span>(*table), <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/da5/astobj2_8h.html#a2cf7e3433f08351aafe3b0cd31edf7f8a23b60f2636bcfbc4dfeea6cc21bf847b">AO2_ALLOC_OPT_LOCK_NOLOCK</a>);</div><div class="line">   <span class="keywordflow">if</span> (!table) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   *table = *<a class="code" href="../../dc/df4/app__voicemail_8c.html#a20bc535b35844236bae4c89b484435c5">vm_table</a>;</div><div class="line">   table-&gt;<a class="code" href="../../df/d7c/structast__vm__functions.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a> = <a name="a126"></a><a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a8637433cfbb88aeb10ce2ed5dcba0eb1">module</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a3a11e1a1d3e99bed3ea0a7c57a3880d7">ao2_global_obj_replace_unref</a>(vm_greeter_provider, table);</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a127"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a50ae61db871bd4f0e0b8caa6c3e56810">ast_vm_greeter_unregister</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *module_name)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html">ast_vm_greeter_functions</a> *<a class="code" href="../../d8/d56/cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>;</div><div class="line"></div><div class="line">   table = <a class="code" href="../../d5/da5/astobj2_8h.html#a86d8d6c3c8866ed0a60121da055cd225">ao2_global_obj_ref</a>(vm_greeter_provider);</div><div class="line">   <span class="keywordflow">if</span> (table &amp;&amp; !strcmp(table-&gt;<a class="code" href="../../d0/d1e/structast__vm__greeter__functions.html#a4c2d9327de87c6be0b54f793adc7f1fb">module_name</a>, module_name)) {</div><div class="line">      <a class="code" href="../../d5/da5/astobj2_8h.html#ac0e1cbc7cf050c8b7b8e3a8fee92c50e">ao2_global_obj_release</a>(vm_greeter_provider);</div><div class="line">   }</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(table);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><span class="keyword">static</span> <a name="a128"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aeb09d8464050290e0a6f655e1f99497d">ast_vm_test_create_user_fn</a> *<a name="a129"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ad3925a12ca1909720e1f4d7ea01fa8a3">ast_vm_test_create_user_func</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"><span class="keyword">static</span> <a name="a130"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a4261c8076caaeb90e900f834b912ee4b">ast_vm_test_destroy_user_fn</a> *<a name="a131"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ac6b468fe42cea720c3ce8c7c4f0ea2c9">ast_vm_test_destroy_user_func</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a132"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a479e9d3cae1218f0f55e27d874a07a96">ast_install_vm_test_functions</a>(<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aeb09d8464050290e0a6f655e1f99497d">ast_vm_test_create_user_fn</a> *vm_test_create_user_func,</div><div class="line">   <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a4261c8076caaeb90e900f834b912ee4b">ast_vm_test_destroy_user_fn</a> *vm_test_destroy_user_func)</div><div class="line">{</div><div class="line">   ast_vm_test_create_user_func = vm_test_create_user_func;</div><div class="line">   ast_vm_test_destroy_user_func = vm_test_destroy_user_func;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a133"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aec0281ec0a6743121492b2194649922f">ast_uninstall_vm_test_functions</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   ast_vm_test_create_user_func = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   ast_vm_test_destroy_user_func = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a134"></a><a class="code" href="../../d3/d83/main_2app_8c.html#aed4788fab39ac1980d266aba2cbc6fc4">vm_warn_no_provider</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (vm_warnings++ % 10 == 0) {</div><div class="line">      <a name="a135"></a><a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;No voicemail provider registered.\n&quot;</span>);</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#define VM_API_CALL(res, api_call, api_parms)                        \</span></div><div class="line"><span class="preprocessor">   do {                                                  \</span></div><div class="line"><span class="preprocessor">      struct ast_vm_functions *table;                             \</span></div><div class="line"><span class="preprocessor">      table = ao2_global_obj_ref(vm_provider);                    \</span></div><div class="line"><span class="preprocessor">      if (!table) {                                         \</span></div><div class="line"><span class="preprocessor">         vm_warn_no_provider();                                \</span></div><div class="line"><span class="preprocessor">      } else if (table-&gt;api_call) {                            \</span></div><div class="line"><span class="preprocessor">         ast_module_ref(table-&gt;module);                           \</span></div><div class="line"><span class="preprocessor">         (res) = table-&gt;api_call api_parms;                       \</span></div><div class="line"><span class="preprocessor">         ast_module_unref(table-&gt;module);                      \</span></div><div class="line"><span class="preprocessor">      }                                                  \</span></div><div class="line"><span class="preprocessor">      ao2_cleanup(table);                                      \</span></div><div class="line"><span class="preprocessor">   } while (0)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a136"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ad6e29bc97e7d1b6d5bcc5199f16d9853">vm_greeter_warn_no_provider</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (vm_greeter_warnings++ % 10 == 0) {</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;No voicemail greeter provider registered.\n&quot;</span>);</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#define VM_GREETER_API_CALL(res, api_call, api_parms)                \</span></div><div class="line"><span class="preprocessor">   do {                                                  \</span></div><div class="line"><span class="preprocessor">      struct ast_vm_greeter_functions *table;                        \</span></div><div class="line"><span class="preprocessor">      table = ao2_global_obj_ref(vm_greeter_provider);               \</span></div><div class="line"><span class="preprocessor">      if (!table) {                                         \</span></div><div class="line"><span class="preprocessor">         vm_greeter_warn_no_provider();                           \</span></div><div class="line"><span class="preprocessor">      } else if (table-&gt;api_call) {                            \</span></div><div class="line"><span class="preprocessor">         ast_module_ref(table-&gt;module);                           \</span></div><div class="line"><span class="preprocessor">         (res) = table-&gt;api_call api_parms;                       \</span></div><div class="line"><span class="preprocessor">         ast_module_unref(table-&gt;module);                      \</span></div><div class="line"><span class="preprocessor">      }                                                  \</span></div><div class="line"><span class="preprocessor">      ao2_cleanup(table);                                      \</span></div><div class="line"><span class="preprocessor">   } while (0)</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a137"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a76b4d3927cacd1bcd5da9ca8fe375cb6">ast_app_has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a138"></a><a class="code" href="../../d0/dd5/res__ari__mailboxes_8c.html#a29d08f8b2448744d75ca9ebc4e218419">mailboxes</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <a name="a139"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, <a name="a140"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">has_voicemail</a>, (mailboxes, folder));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*!</span></div><div class="line"><span class="comment"> * \internal</span></div><div class="line"><span class="comment"> * \brief Function used as a callback for ast_copy_recording_to_vm when a real one isn&#39;t installed.</span></div><div class="line"><span class="comment"> * \param vm_rec_data Stores crucial information about the voicemail that will basically just be used</span></div><div class="line"><span class="comment"> * to figure out what the name of the recipient was supposed to be</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> <a name="a141"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a9f71d68f1b317e6d4ad5f8f820d4b50a">ast_app_copy_recording_to_vm</a>(<span class="keyword">struct</span> <a name="_a142"></a><a class="code" href="../../df/d45/structast__vm__recording__data.html">ast_vm_recording_data</a> *vm_rec_data)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = -1;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, copy_recording_to_vm, (vm_rec_data));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a143"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ab45a61007ccd8ca2ea062f42b83b18ff">ast_app_inboxcount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxes, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (newmsgs) {</div><div class="line">      *newmsgs = 0;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line">      *oldmsgs = 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, <a name="a144"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>, (mailboxes, newmsgs, oldmsgs));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a145"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ace2a3d783f4f79818e14265ae719f06c">ast_app_inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxes, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (newmsgs) {</div><div class="line">      *newmsgs = 0;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (oldmsgs) {</div><div class="line">      *oldmsgs = 0;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (urgentmsgs) {</div><div class="line">      *urgentmsgs = 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, <a name="a146"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>, (mailboxes, urgentmsgs, newmsgs, oldmsgs));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a147"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac225a06b0204b02af4a1b22976383336">ast_app_sayname</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = -1;</div><div class="line"></div><div class="line">   <a name="a148"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a83280de5f04985d9f2f1c2485ae5d906">VM_GREETER_API_CALL</a>(res, <a name="a149"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a>, (chan, mailbox_id));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a150"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a16254e1237610f11047a7558bbe1f207">ast_app_messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, <a name="a151"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#a6d1280b868a461dc347430bff8922eaf">messagecount</a>, (mailbox_id, folder));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a152"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad88659eefe2c62ca92a698a2f2d0afb9">ast_vm_index_to_foldername</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div><div class="line">{</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *res = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, index_to_foldername, (<span class="keywordtype">id</span>));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a name="_a153"></a><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *<a name="a154"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ae5d77d1c2cf9d8e187cb6559021f87c5">ast_vm_mailbox_snapshot_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a155"></a><a class="code" href="../../d0/dd6/chan__mgcp_8c.html#a6b49cafa2a3d359a2e865992f551874a">mailbox</a>,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *folder,</div><div class="line">   <span class="keywordtype">int</span> descending,</div><div class="line">   <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a67fca777538364c249bf1b66b2a22491">ast_vm_snapshot_sort_val</a> sort_val,</div><div class="line">   <span class="keywordtype">int</span> combine_INBOX_and_OLD)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *res = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, mailbox_snapshot_create, (mailbox, context, folder, descending,</div><div class="line">      sort_val, combine_INBOX_and_OLD));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *<a name="a156"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a632bfa316101ce8087f60f59ff909294">ast_vm_mailbox_snapshot_destroy</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *mailbox_snapshot)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d3/dbc/structast__vm__mailbox__snapshot.html">ast_vm_mailbox_snapshot</a> *res = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, mailbox_snapshot_destroy, (mailbox_snapshot));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a157"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad3e7b70282176e60ba4ec190646960f5">ast_vm_msg_move</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line">   <span class="keywordtype">size_t</span> num_msgs,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *oldfolder,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *old_msg_ids[],</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *newfolder)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, msg_move, (mailbox, context, num_msgs, oldfolder, old_msg_ids,</div><div class="line">      newfolder));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a158"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af5e9114c54a30de9136f699a43ca7740">ast_vm_msg_remove</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line">   <span class="keywordtype">size_t</span> num_msgs,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *folder,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *msgs[])</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, msg_remove, (mailbox, context, num_msgs, folder, msgs));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a159"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a89e14848a8f26e967c13e5be34db8154">ast_vm_msg_forward</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a160"></a><a class="code" href="../../dd/d17/namespacesip__to__pjsip.html#a4540ed6a1ea3b69a813ff82e0cfb7587">from_mailbox</a>,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *from_context,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *from_folder,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_mailbox,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_context,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_folder,</div><div class="line">   <span class="keywordtype">size_t</span> num_msgs,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_ids[],</div><div class="line">   <span class="keywordtype">int</span> delete_old)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, msg_forward, (from_mailbox, from_context, from_folder, to_mailbox,</div><div class="line">      to_context, to_folder, num_msgs, msg_ids, delete_old));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a161"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a36f60973de7a0415ed23fb2d635b8613">ast_vm_msg_play</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *context,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *folder,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *msg_num,</div><div class="line">   <a name="a162"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac0c37deb099c676114ef0032ad449375">ast_vm_msg_play_cb</a> *cb)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a12c075dae5bb61a239b853abf865fd67">VM_API_CALL</a>(res, msg_play, (chan, mailbox, context, folder, msg_num, cb));</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef TEST_FRAMEWORK</span></div><div class="line"><span class="keywordtype">int</span> <a name="a163"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#addab2e19809d9d8d6dcde9548982b4bd">ast_vm_test_create_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (ast_vm_test_create_user_func) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#ad3925a12ca1909720e1f4d7ea01fa8a3">ast_vm_test_create_user_func</a>(context, mailbox);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a164"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a93e94d3cc629fd826c72c14f59367e1e">ast_vm_test_destroy_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (ast_vm_test_destroy_user_func) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#ac6b468fe42cea720c3ce8c7c4f0ea2c9">ast_vm_test_destroy_user_func</a>(context, mailbox);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a165"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a8a4b283e6ec48c7198ec3444e70c7398">external_sleep</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> ms)</div><div class="line">{</div><div class="line">   usleep(ms * 1000);</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a166"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a05cbe2ad6e9abffb950e49b86e17b6a3">mf_stream</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits, <span class="keywordtype">int</span> between, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration,</div><div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> durationkp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> durationst, <span class="keywordtype">int</span> is_external)</div><div class="line">{</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keyword">struct </span><a name="_a167"></a><a class="code" href="../../d9/da1/structast__silence__generator.html">ast_silence_generator</a> *silgen = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   int (*my_sleep)(<span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> ms);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (is_external) {</div><div class="line">      my_sleep = <a class="code" href="../../d3/d83/main_2app_8c.html#a8a4b283e6ec48c7198ec3444e70c7398">external_sleep</a>;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      my_sleep = <a name="a168"></a><a class="code" href="../../d5/d7b/channel_8h.html#af10e3bd01602095e1908d3926afc3b76">ast_safe_sleep</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!between) {</div><div class="line">      between = 100;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Need a quiet time before sending digits. */</span></div><div class="line">   <span class="keywordflow">if</span> (<a name="a169"></a><a class="code" href="../../d7/d5b/options_8h.html#afe8795c4ec744506a9300700fc0813dc">ast_opt_transmit_silence</a>) {</div><div class="line">      silgen = <a name="a170"></a><a class="code" href="../../d5/d7b/channel_8h.html#a2a2e0ff24c57491a877cac39cb670024">ast_channel_start_silence_generator</a>(chan);</div><div class="line">   }</div><div class="line">   res = my_sleep(chan, 100);</div><div class="line">   <span class="keywordflow">if</span> (res) {</div><div class="line">      <span class="keywordflow">goto</span> mf_stream_cleanup;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span> (ptr = digits; *ptr; ptr++) {</div><div class="line">      <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789*#ABCwWfF&quot;</span>, *ptr)) {</div><div class="line">         <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;f&#39;</span> || *ptr == <span class="charliteral">&#39;F&#39;</span>) {</div><div class="line">            <span class="comment">/* ignore return values if not supported by channel */</span></div><div class="line">            <a name="a171"></a><a class="code" href="../../d5/d7b/channel_8h.html#aef2af15a597c948e97628da6c5c84f28">ast_indicate</a>(chan, <a name="a172"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a>);</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;w&#39;</span> || *ptr == <span class="charliteral">&#39;W&#39;</span>) {</div><div class="line">            <span class="comment">/* ignore return values if not supported by channel */</span></div><div class="line">            <a class="code" href="../../d5/d7b/channel_8h.html#aef2af15a597c948e97628da6c5c84f28">ast_indicate</a>(chan, <a name="a173"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a195b2c39c09113953814aa800dd06e7f">AST_CONTROL_WINK</a>);</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <span class="comment">/* Character represents valid MF */</span></div><div class="line">            <a name="a174"></a><a class="code" href="../../d5/d7b/channel_8h.html#ac48cc3fb7a20c85c97950b685e756ef7">ast_senddigit_mf</a>(chan, *ptr, duration, durationkp, durationst, is_external);</div><div class="line">         }</div><div class="line">         <span class="comment">/* pause between digits */</span></div><div class="line">         <span class="comment">/* The DSP code in Asterisk does not currently properly receive repeated tones</span></div><div class="line"><span class="comment">            if no audio is sent in the middle. Simply sending audio (even 0 Hz)</span></div><div class="line"><span class="comment">            works around this limitation and guarantees the correct behavior.</span></div><div class="line"><span class="comment">            */</span></div><div class="line">         <a class="code" href="../../d2/d0f/indications_8h.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, <span class="stringliteral">&quot;0&quot;</span>, 0);</div><div class="line">         res = my_sleep(chan, between);</div><div class="line">         <a name="a175"></a><a class="code" href="../../d5/d7b/channel_8h.html#a7f947d997e2f6c1a995d2e093240cbc9">ast_senddigit_mf_end</a>(chan);</div><div class="line">         <span class="keywordflow">if</span> (res) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Illegal MF character &#39;%c&#39; in string. (0-9*#ABCwWfF allowed)\n&quot;</span>, *ptr);</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">mf_stream_cleanup:</div><div class="line">   <span class="keywordflow">if</span> (silgen) {</div><div class="line">      <a name="a176"></a><a class="code" href="../../d5/d7b/channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d">ast_channel_stop_silence_generator</a>(chan, silgen);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a177"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a47f4c14a6af38c0332d1e7b5639ce3a1">dtmf_stream</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits, <span class="keywordtype">int</span> between, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration, <span class="keywordtype">int</span> is_external)</div><div class="line">{</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d9/da1/structast__silence__generator.html">ast_silence_generator</a> *silgen = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   int (*my_sleep)(<span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">int</span> ms);</div><div class="line">   int (*my_senddigit)(<span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> <a name="a178"></a><a class="code" href="../../dc/d5c/app__alarmreceiver_8c.html#ac2c887b7f7b359bfdda8a128980f5081">digit</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (is_external) {</div><div class="line">      my_sleep = <a class="code" href="../../d3/d83/main_2app_8c.html#a8a4b283e6ec48c7198ec3444e70c7398">external_sleep</a>;</div><div class="line">      my_senddigit = <a name="a179"></a><a class="code" href="../../d5/d7b/channel_8h.html#a82a0d60133ec689b693bcbe296914c75">ast_senddigit_external</a>;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      my_sleep = <a class="code" href="../../d5/d7b/channel_8h.html#af10e3bd01602095e1908d3926afc3b76">ast_safe_sleep</a>;</div><div class="line">      my_senddigit = <a name="a180"></a><a class="code" href="../../d5/d7b/channel_8h.html#a48a8b376caf908979e96af8641591c92">ast_senddigit</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!between) {</div><div class="line">      between = 100;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Need a quiet time before sending digits. */</span></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5b/options_8h.html#afe8795c4ec744506a9300700fc0813dc">ast_opt_transmit_silence</a>) {</div><div class="line">      silgen = <a class="code" href="../../d5/d7b/channel_8h.html#a2a2e0ff24c57491a877cac39cb670024">ast_channel_start_silence_generator</a>(chan);</div><div class="line">   }</div><div class="line">   res = my_sleep(chan, 100);</div><div class="line">   <span class="keywordflow">if</span> (res) {</div><div class="line">      <span class="keywordflow">goto</span> dtmf_stream_cleanup;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span> (ptr = digits; *ptr; ptr++) {</div><div class="line">      <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;w&#39;</span>) {</div><div class="line">         <span class="comment">/* &#39;w&#39; -- wait half a second */</span></div><div class="line">         res = my_sleep(chan, 500);</div><div class="line">         <span class="keywordflow">if</span> (res) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;W&#39;</span>) {</div><div class="line">         <span class="comment">/* &#39;W&#39; -- wait a second */</span></div><div class="line">         res = my_sleep(chan, 1000);</div><div class="line">         <span class="keywordflow">if</span> (res) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789*#abcdfABCDF&quot;</span>, *ptr)) {</div><div class="line">         <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;f&#39;</span> || *ptr == <span class="charliteral">&#39;F&#39;</span>) {</div><div class="line">            <span class="comment">/* ignore return values if not supported by channel */</span></div><div class="line">            <a class="code" href="../../d5/d7b/channel_8h.html#aef2af15a597c948e97628da6c5c84f28">ast_indicate</a>(chan, <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a>);</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <span class="comment">/* Character represents valid DTMF */</span></div><div class="line">            my_senddigit(chan, *ptr, duration);</div><div class="line">         }</div><div class="line">         <span class="comment">/* pause between digits */</span></div><div class="line">         res = my_sleep(chan, between);</div><div class="line">         <span class="keywordflow">if</span> (res) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Illegal DTMF character &#39;%c&#39; in string. (0-9*#aAbBcCdD allowed)\n&quot;</span>, *ptr);</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">dtmf_stream_cleanup:</div><div class="line">   <span class="keywordflow">if</span> (silgen) {</div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d">ast_channel_stop_silence_generator</a>(chan, silgen);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a181"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aea588ff21e48ab0fcdaef5beb911ea56">ast_mf_stream</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *peer, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits, <span class="keywordtype">int</span> between, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration,</div><div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> durationkp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> durationst, <span class="keywordtype">int</span> is_external)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordflow">if</span> (!is_external &amp;&amp; peer &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9">ast_autoservice_start</a>(peer)) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   res = <a class="code" href="../../d3/d83/main_2app_8c.html#a05cbe2ad6e9abffb950e49b86e17b6a3">mf_stream</a>(chan, digits, between, duration, durationkp, durationst, is_external);</div><div class="line">   <span class="keywordflow">if</span> (!is_external &amp;&amp; peer &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b">ast_autoservice_stop</a>(peer)) {</div><div class="line">      res = -1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a182"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af20b8ac2e28e659be352bbaecdf0ab03">ast_dtmf_stream</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *peer, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits, <span class="keywordtype">int</span> between, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (peer &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9">ast_autoservice_start</a>(peer)) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   res = <a class="code" href="../../d3/d83/main_2app_8c.html#a47f4c14a6af38c0332d1e7b5639ce3a1">dtmf_stream</a>(chan, digits, between, duration, 0);</div><div class="line">   <span class="keywordflow">if</span> (peer &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b">ast_autoservice_stop</a>(peer)) {</div><div class="line">      res = -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a183"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a36e4844e25a7e967607eb4812667a26a">ast_dtmf_stream_external</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *digits, <span class="keywordtype">int</span> between, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)</div><div class="line">{</div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a47f4c14a6af38c0332d1e7b5639ce3a1">dtmf_stream</a>(chan, digits, between, duration, 1);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a name="_a184"></a><a class="code" href="../../db/d07/structlinear__state.html">linear_state</a> {</div><div class="line">   <span class="keywordtype">int</span> fd;</div><div class="line">   <span class="keywordtype">int</span> autoclose;</div><div class="line">   <span class="keywordtype">int</span> allowoverride;</div><div class="line">   <span class="keyword">struct </span><a name="_a185"></a><a class="code" href="../../d0/d98/structast__format.html">ast_format</a> *origwfmt;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a186"></a><a class="code" href="../../d3/d83/main_2app_8c.html#afc3d301641817be1e994258ceb1960c4">linear_release</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *params)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../db/d07/structlinear__state.html">linear_state</a> *ls = params;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (ls-&gt;<a name="a187"></a><a class="code" href="../../db/d07/structlinear__state.html#a67c7e065450c2a224e067625e9cdaa0c">origwfmt</a> &amp;&amp; <a name="a188"></a><a class="code" href="../../d5/d7b/channel_8h.html#abbdfb98077180544657b2d16c5d25f74">ast_set_write_format</a>(chan, ls-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a67c7e065450c2a224e067625e9cdaa0c">origwfmt</a>)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore channel &#39;%s&#39; to format &#39;%s&#39;\n&quot;</span>,</div><div class="line">         <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan), <a name="a189"></a><a class="code" href="../../d0/d0a/format_8h.html#a082f0fca94b18ba466f6e28d3ccb2fc8">ast_format_get_name</a>(ls-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a67c7e065450c2a224e067625e9cdaa0c">origwfmt</a>));</div><div class="line">   }</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(ls-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a67c7e065450c2a224e067625e9cdaa0c">origwfmt</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (ls-&gt;<a name="a190"></a><a class="code" href="../../db/d07/structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a>) {</div><div class="line">      close(ls-&gt;<a name="a191"></a><a class="code" href="../../db/d07/structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a192"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a3c664af67de1b256b0fa742ec5b8fff2">linear_generator</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a name="a193"></a><a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> samples)</div><div class="line">{</div><div class="line">   <span class="keywordtype">short</span> <a name="a194"></a><a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>[2048 + <a name="a195"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ac8f7380b8620c80443286b44481f641c">AST_FRIENDLY_OFFSET</a> / 2];</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../db/d07/structlinear__state.html">linear_state</a> *ls = data;</div><div class="line">   <span class="keyword">struct </span><a name="_a196"></a><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> f = {</div><div class="line">      .<a name="a197"></a><a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a name="a198"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>,</div><div class="line">      .data.ptr = buf + <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ac8f7380b8620c80443286b44481f641c">AST_FRIENDLY_OFFSET</a> / 2,</div><div class="line">      .offset = <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ac8f7380b8620c80443286b44481f641c">AST_FRIENDLY_OFFSET</a>,</div><div class="line">   };</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line"></div><div class="line">   f.<a name="a199"></a><a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a name="a200"></a><a class="code" href="../../d1/d9f/structast__frame__subclass.html#ab425a484a0916077c5a30d9d7b229b44">format</a> = <a name="a201"></a><a class="code" href="../../db/d1c/format__cache_8h.html#a771d7c34570e8e492c25a0c2eb41889d">ast_format_slin</a>;</div><div class="line"></div><div class="line">   len = samples * 2;</div><div class="line">   <span class="keywordflow">if</span> (len &gt; <span class="keyword">sizeof</span>(buf) - <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ac8f7380b8620c80443286b44481f641c">AST_FRIENDLY_OFFSET</a>) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&#39;t generate %d bytes of data!\n&quot;</span> , len);</div><div class="line">      len = <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>) - <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ac8f7380b8620c80443286b44481f641c">AST_FRIENDLY_OFFSET</a>;</div><div class="line">   }</div><div class="line">   res = read(ls-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, buf + <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ac8f7380b8620c80443286b44481f641c">AST_FRIENDLY_OFFSET</a>/2, len);</div><div class="line">   <span class="keywordflow">if</span> (res &gt; 0) {</div><div class="line">      f.<a name="a202"></a><a class="code" href="../../d0/d99/structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res;</div><div class="line">      f.<a name="a203"></a><a class="code" href="../../d0/d99/structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = res / 2;</div><div class="line">      <a name="a204"></a><a class="code" href="../../d5/d7b/channel_8h.html#a79c413d51b7135404d5cacf811649a61">ast_write</a>(chan, &amp;f);</div><div class="line">      <span class="keywordflow">if</span> (res == len) {</div><div class="line">         <span class="keywordflow">return</span> 0;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> -1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *<a name="a205"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a9917c0ec59881e0ae404e044bf8628cb">linear_alloc</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">void</span> *params)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../db/d07/structlinear__state.html">linear_state</a> *ls = params;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!params) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* In this case, params is already malloc&#39;d */</span></div><div class="line">   <span class="keywordflow">if</span> (ls-&gt;<a name="a206"></a><a class="code" href="../../db/d07/structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">allowoverride</a>) {</div><div class="line">      <a name="a207"></a><a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a name="a208"></a><a class="code" href="../../d5/d7b/channel_8h.html#a91de92158876186d28ba1773877f2732">ast_channel_flags</a>(chan), <a name="a209"></a><a class="code" href="../../d5/d7b/channel_8h.html#a82f2c6e4d47f62f6b65c5887eb096fd5a9deec175d13a40a6a5fdb527b13c6878">AST_FLAG_WRITE_INT</a>);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a name="a210"></a><a class="code" href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a91de92158876186d28ba1773877f2732">ast_channel_flags</a>(chan), <a class="code" href="../../d5/d7b/channel_8h.html#a82f2c6e4d47f62f6b65c5887eb096fd5a9deec175d13a40a6a5fdb527b13c6878">AST_FLAG_WRITE_INT</a>);</div><div class="line">   }</div><div class="line"></div><div class="line">   ls-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a67c7e065450c2a224e067625e9cdaa0c">origwfmt</a> = <a name="a211"></a><a class="code" href="../../d5/da5/astobj2_8h.html#ac438c3fcd3150481fad38689fd813a15">ao2_bump</a>(<a name="a212"></a><a class="code" href="../../d5/d7b/channel_8h.html#a1dc625bd14a7875b04bfe0c388858929">ast_channel_writeformat</a>(chan));</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7b/channel_8h.html#abbdfb98077180544657b2d16c5d25f74">ast_set_write_format</a>(chan, <a class="code" href="../../db/d1c/format__cache_8h.html#a771d7c34570e8e492c25a0c2eb41889d">ast_format_slin</a>)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set &#39;%s&#39; to linear format (write)\n&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan));</div><div class="line">      <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(ls-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a67c7e065450c2a224e067625e9cdaa0c">origwfmt</a>);</div><div class="line">      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ls);</div><div class="line">      ls = params = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> params;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a213"></a><a class="code" href="../../de/d2a/structast__generator.html">ast_generator</a> <a name="a214"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a50b7bd92df6d7d96811b86030c0265b1">linearstream</a> =</div><div class="line">{</div><div class="line">   .<a name="a215"></a><a class="code" href="../../de/d2a/structast__generator.html#a77c293dc8108e06e2a81a1fdafc8fd97">alloc</a> = <a class="code" href="../../d3/d83/main_2app_8c.html#a9917c0ec59881e0ae404e044bf8628cb">linear_alloc</a>,</div><div class="line">   .release = <a class="code" href="../../d3/d83/main_2app_8c.html#afc3d301641817be1e994258ceb1960c4">linear_release</a>,</div><div class="line">   .generate = <a class="code" href="../../d3/d83/main_2app_8c.html#a3c664af67de1b256b0fa742ec5b8fff2">linear_generator</a>,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a216"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a2566e275a6e912943c68cbfc867cc60a">ast_linear_stream</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> allowoverride)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../db/d07/structlinear__state.html">linear_state</a> *lin;</div><div class="line">   <span class="keywordtype">char</span> tmpf[256];</div><div class="line">   <span class="keywordtype">int</span> <a class="code" href="../../db/d07/structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a> = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (fd &lt; 0) {</div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(filename)) {</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line"></div><div class="line">      autoclose = 1;</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (filename[0] == <span class="charliteral">&#39;/&#39;</span>) {</div><div class="line">         <a name="a217"></a><a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmpf, filename, <span class="keyword">sizeof</span>(tmpf));</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         snprintf(tmpf, <span class="keyword">sizeof</span>(tmpf), <span class="stringliteral">&quot;%s/%s/%s&quot;</span>, <a name="a218"></a><a class="code" href="../../dd/df2/paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>, <span class="stringliteral">&quot;sounds&quot;</span>, filename);</div><div class="line">      }</div><div class="line"></div><div class="line">      fd = open(tmpf, O_RDONLY);</div><div class="line">      <span class="keywordflow">if</span> (fd &lt; 0) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open file &#39;%s&#39;: %s\n&quot;</span>, tmpf, strerror(<a name="a219"></a><a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   lin = <a name="a220"></a><a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*lin));</div><div class="line">   <span class="keywordflow">if</span> (!lin) {</div><div class="line">      <span class="keywordflow">if</span> (autoclose) {</div><div class="line">         close(fd);</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   lin-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = <a class="code" href="../../db/d07/structlinear__state.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;</div><div class="line">   lin-&gt;<a class="code" href="../../db/d07/structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">allowoverride</a> = <a class="code" href="../../db/d07/structlinear__state.html#ab6d0ae4f4fba3a46c253a118a8d1bf72">allowoverride</a>;</div><div class="line">   lin-&gt;<a class="code" href="../../db/d07/structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a> = <a class="code" href="../../db/d07/structlinear__state.html#a766c6d52861f6f0ddb14b6d579ecb331">autoclose</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> <a name="a221"></a><a class="code" href="../../d5/d7b/channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;linearstream, lin);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a222"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a320dd3e6327e693d76625f9bed7a7a81">control_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a223"></a><a class="code" href="../../d2/dc8/namespacemake__ari__stubs.html#a40a5d58ffa6e88aa578d6683ac413105">file</a>,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *fwd,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *rev,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a224"></a><a class="code" href="../../df/d44/app__meetme_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a225"></a><a class="code" href="../../d3/d5a/ccss_8c.html#a8bd1c39b4993f80f1bf674e3a1d717dd">suspend</a>,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *restart,</div><div class="line">   <span class="keywordtype">int</span> <a name="a226"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a>,</div><div class="line">   <span class="keywordtype">long</span> *offsetms,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *lang,</div><div class="line">   <a name="a227"></a><a class="code" href="../../d2/d4d/file_8h.html#a2d5138e99197a1d01f7a2ed07830476e">ast_waitstream_fr_cb</a> cb)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *breaks = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">char</span> *<a name="a228"></a><a class="code" href="../../dd/d7c/eagi__proxy_8c.html#a8fd806ad19b8f5513a4cf18cbf77532c">end</a> = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">int</span> blen = 2;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordtype">long</span> pause_restart_point = 0;</div><div class="line">   <span class="keywordtype">long</span> offset = 0;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d9/da1/structast__silence__generator.html">ast_silence_generator</a> *silgen = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!file) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (offsetms) {</div><div class="line">      offset = *offsetms * 8; <span class="comment">/* XXX Assumes 8kHz */</span></div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (lang == <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div><div class="line">      lang = <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (stop) {</div><div class="line">      blen += strlen(stop);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (suspend) {</div><div class="line">      blen += strlen(suspend);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (restart) {</div><div class="line">      blen += strlen(restart);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (blen &gt; 2) {</div><div class="line">      breaks = <a name="a229"></a><a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(blen + 1);</div><div class="line">      breaks[0] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">      <span class="keywordflow">if</span> (stop) {</div><div class="line">         strcat(breaks, stop);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (suspend) {</div><div class="line">         strcat(breaks, suspend);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (restart) {</div><div class="line">         strcat(breaks, restart);</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((end = strchr(file, <span class="charliteral">&#39;:&#39;</span>))) {</div><div class="line">      <span class="keywordflow">if</span> (!strcasecmp(end, <span class="stringliteral">&quot;:end&quot;</span>)) {</div><div class="line">         *end = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">         end++;</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         end = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span> (;;) {</div><div class="line">      <a name="a230"></a><a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line">      res = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, file, lang);</div><div class="line">      <span class="keywordflow">if</span> (!res) {</div><div class="line">         <span class="keywordflow">if</span> (pause_restart_point) {</div><div class="line">            <a name="a231"></a><a class="code" href="../../d2/d4d/file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07">ast_seekstream</a>(<a name="a232"></a><a class="code" href="../../d5/d7b/channel_8h.html#a043ef90a065fe177af7b21a6045b6506">ast_channel_stream</a>(chan), pause_restart_point, SEEK_SET);</div><div class="line">            pause_restart_point = 0;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (end || offset &lt; 0) {</div><div class="line">            <span class="keywordflow">if</span> (offset == -8) {</div><div class="line">               offset = 0;</div><div class="line">            }</div><div class="line">            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;ControlPlayback seek to offset %ld from end\n&quot;</span>, offset);</div><div class="line"></div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07">ast_seekstream</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a043ef90a065fe177af7b21a6045b6506">ast_channel_stream</a>(chan), offset, SEEK_END);</div><div class="line">            end = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">            offset = 0;</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (offset) {</div><div class="line">            <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;ControlPlayback seek to offset %ld\n&quot;</span>, offset);</div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a36f6bba05952162d5d1ee7fb9819bd07">ast_seekstream</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a043ef90a065fe177af7b21a6045b6506">ast_channel_stream</a>(chan), offset, SEEK_SET);</div><div class="line">            offset = 0;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (cb) {</div><div class="line">            res = <a name="a233"></a><a class="code" href="../../d2/d4d/file_8h.html#a1d269d89440f69d13458394efc73f2d2">ast_waitstream_fr_w_cb</a>(chan, breaks, fwd, rev, skipms, cb);</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            res = <a name="a234"></a><a class="code" href="../../d2/d4d/file_8h.html#a5ce837632e3746a3af17f8311060e510">ast_waitstream_fr</a>(chan, breaks, fwd, rev, skipms);</div><div class="line">         }</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (res &lt; 1) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="comment">/* We go at next loop if we got the restart char */</span></div><div class="line">      <span class="keywordflow">if</span> ((restart &amp;&amp; strchr(restart, res)) || res == <a name="a235"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a32b72bba20e26bcd2d5a299c5d939bce">AST_CONTROL_STREAM_RESTART</a>) {</div><div class="line">         <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;we&#39;ll restart the stream here at next loop\n&quot;</span>);</div><div class="line">         pause_restart_point = 0;</div><div class="line">         <a name="a236"></a><a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>,<span class="stringliteral">&quot;Channel: %s\r\n&quot;</span></div><div class="line">            <span class="stringliteral">&quot;Control: %s\r\n&quot;</span>,</div><div class="line">            <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan),</div><div class="line">            <span class="stringliteral">&quot;Restart&quot;</span>);</div><div class="line">         <span class="keywordflow">continue</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> ((suspend &amp;&amp; strchr(suspend, res)) || res == <a name="a237"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a32e9dbe9416e847668084be16d4698c9">AST_CONTROL_STREAM_SUSPEND</a>) {</div><div class="line">         pause_restart_point = <a name="a238"></a><a class="code" href="../../d2/d4d/file_8h.html#a01771a318e7adea51499040f27b4278a">ast_tellstream</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a043ef90a065fe177af7b21a6045b6506">ast_channel_stream</a>(chan));</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5b/options_8h.html#afe8795c4ec744506a9300700fc0813dc">ast_opt_transmit_silence</a>) {</div><div class="line">            silgen = <a class="code" href="../../d5/d7b/channel_8h.html#a2a2e0ff24c57491a877cac39cb670024">ast_channel_start_silence_generator</a>(chan);</div><div class="line">         }</div><div class="line">         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>,<span class="stringliteral">&quot;Channel: %s\r\n&quot;</span></div><div class="line">            <span class="stringliteral">&quot;Control: %s\r\n&quot;</span>,</div><div class="line">            <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan),</div><div class="line">            <span class="stringliteral">&quot;Pause&quot;</span>);</div><div class="line">         <span class="keywordflow">for</span> (;;) {</div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line">            <span class="keywordflow">if</span> (!(res = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 1000))) {</div><div class="line">               <span class="keywordflow">continue</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1 || (suspend &amp;&amp; strchr(suspend, res)) || (stop &amp;&amp; strchr(stop, res))</div><div class="line">                  || res == <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a32e9dbe9416e847668084be16d4698c9">AST_CONTROL_STREAM_SUSPEND</a> || res == <a name="a239"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390aa95eb913e6cbbac8a34e69905245fdf4">AST_CONTROL_STREAM_STOP</a>) {</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (silgen) {</div><div class="line">            <a class="code" href="../../d5/d7b/channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d">ast_channel_stop_silence_generator</a>(chan, silgen);</div><div class="line">            silgen = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">         }</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> ((suspend &amp;&amp; (res == *suspend)) || res == <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a32e9dbe9416e847668084be16d4698c9">AST_CONTROL_STREAM_SUSPEND</a>) {</div><div class="line">            res = 0;</div><div class="line">            <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>,<span class="stringliteral">&quot;Channel: %s\r\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;Control: %s\r\n&quot;</span>,</div><div class="line">               <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan),</div><div class="line">               <span class="stringliteral">&quot;Unpause&quot;</span>);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">         }</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (res == -1) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="comment">/* if we get one of our stop chars, return it to the calling function */</span></div><div class="line">      <span class="keywordflow">if</span> ((stop &amp;&amp; strchr(stop, res)) || res == <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390aa95eb913e6cbbac8a34e69905245fdf4">AST_CONTROL_STREAM_STOP</a>) {</div><div class="line">         <a class="code" href="../../d2/ddc/test_8h.html#a9482d93ea3931853331bdbc745ce7cb4">ast_test_suite_event_notify</a>(<span class="stringliteral">&quot;PLAYBACK&quot;</span>,<span class="stringliteral">&quot;Channel: %s\r\n&quot;</span></div><div class="line">            <span class="stringliteral">&quot;Control: %s\r\n&quot;</span>,</div><div class="line">            <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan),</div><div class="line">            <span class="stringliteral">&quot;Stop&quot;</span>);</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (pause_restart_point) {</div><div class="line">      offset = pause_restart_point;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d7b/channel_8h.html#a043ef90a065fe177af7b21a6045b6506">ast_channel_stream</a>(chan)) {</div><div class="line">         offset = <a class="code" href="../../d2/d4d/file_8h.html#a01771a318e7adea51499040f27b4278a">ast_tellstream</a>(<a class="code" href="../../d5/d7b/channel_8h.html#a043ef90a065fe177af7b21a6045b6506">ast_channel_stream</a>(chan));</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         offset = -8;  <span class="comment">/* indicate end of file */</span></div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (offsetms) {</div><div class="line">      *offsetms = offset / 8; <span class="comment">/* samples --&gt; ms ... XXX Assumes 8 kHz */</span></div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a240"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aa4fef057c6ed4a990591215b0f3ed66d">ast_control_streamfile_w_cb</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *file,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *fwd,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *rev,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *stop,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *suspend,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *restart,</div><div class="line">   <span class="keywordtype">int</span> skipms,</div><div class="line">   <span class="keywordtype">long</span> *offsetms,</div><div class="line">   <a class="code" href="../../d2/d4d/file_8h.html#a2d5138e99197a1d01f7a2ed07830476e">ast_waitstream_fr_cb</a> cb)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a320dd3e6327e693d76625f9bed7a7a81">control_streamfile</a>(chan, file, fwd, rev, stop, suspend, restart, skipms, offsetms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, cb);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a241"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a3405b1282cefdceebba734b8e756c55d">ast_control_streamfile</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *file,</div><div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *fwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *rev,</div><div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *stop, <span class="keyword">const</span> <span class="keywordtype">char</span> *suspend,</div><div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *restart, <span class="keywordtype">int</span> skipms, <span class="keywordtype">long</span> *offsetms)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a320dd3e6327e693d76625f9bed7a7a81">control_streamfile</a>(chan, file, fwd, rev, stop, suspend, restart, skipms, offsetms, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a242"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abef8d08064d7b1ea69da238a4d9fff9c">ast_control_streamfile_lang</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *file,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *fwd, <span class="keyword">const</span> <span class="keywordtype">char</span> *rev, <span class="keyword">const</span> <span class="keywordtype">char</span> *stop, <span class="keyword">const</span> <span class="keywordtype">char</span> *suspend,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *restart, <span class="keywordtype">int</span> skipms, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keywordtype">long</span> *offsetms)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a320dd3e6327e693d76625f9bed7a7a81">control_streamfile</a>(chan, file, fwd, rev, stop, suspend, restart, skipms, offsetms, lang, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">enum</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5">control_tone_frame_response_result</a> {</div><div class="line">   <a name="a243"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a44b954d1e48690a36cb2e1a054132635">CONTROL_TONE_RESPONSE_FAILED</a> = -1,</div><div class="line">   <a name="a244"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a5818a4ce31515b52e000e1050d93c8c6">CONTROL_TONE_RESPONSE_NORMAL</a> = 0,</div><div class="line">   <a name="a245"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5aefb1f436a8fb0238eb8c6dcb092431f5">CONTROL_TONE_RESPONSE_FINISHED</a> = 1,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5">control_tone_frame_response_result</a> <a name="a246"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a00f5bb2146302815137be471686d1b23">control_tone_frame_response</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *fr, <span class="keyword">struct</span> <a class="code" href="../../d5/dab/structast__tone__zone__sound.html">ast_tone_zone_sound</a> *ts, <span class="keyword">const</span> <span class="keywordtype">char</span> *tone, <span class="keywordtype">int</span> *paused)</div><div class="line">{</div><div class="line">   <span class="keywordflow">switch</span> (fr-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a name="a247"></a><a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>) {</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390aa95eb913e6cbbac8a34e69905245fdf4">AST_CONTROL_STREAM_STOP</a>:</div><div class="line">      <a class="code" href="../../d2/d0f/indications_8h.html#a9d5be069b7060d326a213f5d60b8dc77">ast_playtones_stop</a>(chan);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5aefb1f436a8fb0238eb8c6dcb092431f5">CONTROL_TONE_RESPONSE_FINISHED</a>;</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a32e9dbe9416e847668084be16d4698c9">AST_CONTROL_STREAM_SUSPEND</a>:</div><div class="line">      <span class="keywordflow">if</span> (*paused) {</div><div class="line">         *paused = 0;</div><div class="line">         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0f/indications_8h.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, ts ? ts-&gt;<a class="code" href="../../d5/dab/structast__tone__zone__sound.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> : tone, 0)) {</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a44b954d1e48690a36cb2e1a054132635">CONTROL_TONE_RESPONSE_FAILED</a>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         *paused = 1;</div><div class="line">         <a class="code" href="../../d2/d0f/indications_8h.html#a9d5be069b7060d326a213f5d60b8dc77">ast_playtones_stop</a>(chan);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a5818a4ce31515b52e000e1050d93c8c6">CONTROL_TONE_RESPONSE_NORMAL</a>;</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a32b72bba20e26bcd2d5a299c5d939bce">AST_CONTROL_STREAM_RESTART</a>:</div><div class="line">      <a class="code" href="../../d2/d0f/indications_8h.html#a9d5be069b7060d326a213f5d60b8dc77">ast_playtones_stop</a>(chan);</div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0f/indications_8h.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, ts ? ts-&gt;<a class="code" href="../../d5/dab/structast__tone__zone__sound.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> : tone, 0)) {</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a44b954d1e48690a36cb2e1a054132635">CONTROL_TONE_RESPONSE_FAILED</a>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a5818a4ce31515b52e000e1050d93c8c6">CONTROL_TONE_RESPONSE_NORMAL</a>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a248"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a4e1f998aacd5c878a02040883b846bd7">AST_CONTROL_STREAM_REVERSE</a>:</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Media control operation &#39;reverse&#39; not supported for media type &#39;tone&#39;\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a5818a4ce31515b52e000e1050d93c8c6">CONTROL_TONE_RESPONSE_NORMAL</a>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a249"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390ae8e6b1d91a861c33a3de923b24f54dec">AST_CONTROL_STREAM_FORWARD</a>:</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Media control operation &#39;forward&#39; not supported for media type &#39;tone&#39;\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a5818a4ce31515b52e000e1050d93c8c6">CONTROL_TONE_RESPONSE_NORMAL</a>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a250"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>:</div><div class="line">   <span class="keywordflow">case</span> <a name="a251"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>:</div><div class="line">   <span class="keywordflow">case</span> <a name="a252"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>:</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5aefb1f436a8fb0238eb8c6dcb092431f5">CONTROL_TONE_RESPONSE_FINISHED</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a5818a4ce31515b52e000e1050d93c8c6">CONTROL_TONE_RESPONSE_NORMAL</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a253"></a><a class="code" href="../../d3/d83/main_2app_8c.html#af6b32f07971af303a81aa940a347fddb">parse_tone_uri</a>(<span class="keywordtype">char</span> *tone_parser,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> **tone_indication,</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> **tone_zone)</div><div class="line">{</div><div class="line">   *tone_indication = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tone_parser, <span class="stringliteral">&quot;;&quot;</span>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(tone_parser)) {</div><div class="line">      <span class="comment">/* Only the indication is included */</span></div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!(strncmp(tone_parser, <span class="stringliteral">&quot;tonezone=&quot;</span>, 9))) {</div><div class="line">      *tone_zone = tone_parser + 9;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unexpected Tone URI component: %s\n&quot;</span>, tone_parser);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a254"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a52431d7ad64408a4a7abbaad3f34acea">ast_control_tone</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *tone)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a name="_a255"></a><a class="code" href="../../dd/d77/structast__tone__zone.html">ast_tone_zone</a> *zone = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d5/dab/structast__tone__zone__sound.html">ast_tone_zone_sound</a> *ts;</div><div class="line">   <span class="keywordtype">int</span> paused = 0;</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line"></div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *tone_indication = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *tone_zone = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">char</span> *tone_uri_parser;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(tone)) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   tone_uri_parser = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(tone);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#af6b32f07971af303a81aa940a347fddb">parse_tone_uri</a>(tone_uri_parser, &amp;tone_indication, &amp;tone_zone)) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (tone_zone) {</div><div class="line">      zone = <a name="a256"></a><a class="code" href="../../d2/d0f/indications_8h.html#a52513ad3507d90dc2baf7cfec7b201a7">ast_get_indication_zone</a>(tone_zone);</div><div class="line">   }</div><div class="line"></div><div class="line">   ts = <a class="code" href="../../d2/d0f/indications_8h.html#a516be2823557000dcd4be685a44d1d09">ast_get_indication_tone</a>(zone ? zone : <a class="code" href="../../d5/d7b/channel_8h.html#a673d53e20b8ac75477469442f51314e1">ast_channel_zone</a>(chan), tone_indication);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0f/indications_8h.html#a544e8a1dd4a986b00754103dda6a7d3b">ast_playtones_start</a>(chan, 0, ts ? ts-&gt;<a class="code" href="../../d5/dab/structast__tone__zone__sound.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> : tone_indication, 0)) {</div><div class="line">      res = -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">while</span> (!res) {</div><div class="line">      <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *fr;</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (<a name="a257"></a><a class="code" href="../../d5/d7b/channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc">ast_waitfor</a>(chan, -1) &lt; 0) {</div><div class="line">         res = -1;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      fr = <a name="a258"></a><a class="code" href="../../d5/d7b/channel_8h.html#a1950f7fe77c02d233de02d299bab8c15">ast_read_noaudio</a>(chan);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (!fr) {</div><div class="line">         res = -1;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a name="a259"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) {</div><div class="line">         <span class="keywordflow">continue</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      res = <a class="code" href="../../d3/d83/main_2app_8c.html#a00f5bb2146302815137be471686d1b23">control_tone_frame_response</a>(chan, fr, ts, tone_indication, &amp;paused);</div><div class="line">      <span class="keywordflow">if</span> (res == <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5aefb1f436a8fb0238eb8c6dcb092431f5">CONTROL_TONE_RESPONSE_FINISHED</a>) {</div><div class="line">         res = 0;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="../../d3/d83/main_2app_8c.html#a8a71094a6fa4c99ee8ba96185eab3ea5a44b954d1e48690a36cb2e1a054132635">CONTROL_TONE_RESPONSE_FAILED</a>) {</div><div class="line">         res = -1;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (ts) {</div><div class="line">      <a class="code" href="../../d2/d0f/indications_8h.html#a8b52ace68f21c0ac24414f038471647d">ast_tone_zone_sound_unref</a>(ts);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (zone) {</div><div class="line">      <a name="a260"></a><a class="code" href="../../d2/d0f/indications_8h.html#ae4e735983064b7fe22ffc0fc046d700e">ast_tone_zone_unref</a>(zone);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a261"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *fn)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> <a name="a262"></a><a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a> = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((d = <a class="code" href="../../d2/d4d/file_8h.html#a67c7e271b4ca70aca6d48fd48d121857">ast_streamfile</a>(chan, fn, <a class="code" href="../../d5/d7b/channel_8h.html#a9abe31fe40dcd03cd2957e5309e32ac6">ast_channel_language</a>(chan)))) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   d = <a name="a263"></a><a class="code" href="../../d2/d4d/file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137">ast_waitstream</a>(chan, <a name="a264"></a><a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);</div><div class="line"></div><div class="line">   <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d7/d6f/test__linkedlists_8c.html#a156f09c32102fa036620ad75c3ee4fbf">d</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*!</span></div><div class="line"><span class="comment"> * \brief Construct a silence frame of the same duration as \a orig.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The \a orig frame must be \ref AST_FORMAT_SLINEAR.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * \param orig Frame as basis for silence to generate.</span></div><div class="line"><span class="comment"> * \return New frame of silence; free with ast_frfree().</span></div><div class="line"><span class="comment"> * \return \c NULL on error.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *<a name="a265"></a><a class="code" href="../../d3/d83/main_2app_8c.html#acebf42e1b2956855f73e9dd7ef66d785">make_silence</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *orig)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *silence;</div><div class="line">   <span class="keywordtype">size_t</span> size;</div><div class="line">   <span class="keywordtype">size_t</span> <a class="code" href="../../d0/d99/structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;</div><div class="line">   <span class="keywordtype">size_t</span> samples = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!orig) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">do</span> {</div><div class="line">      <span class="keywordflow">if</span> (<a name="a266"></a><a class="code" href="../../d0/d0a/format_8h.html#a738c58eca291b71de4422e95bff27400">ast_format_cmp</a>(orig-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#ab425a484a0916077c5a30d9d7b229b44">format</a>, <a class="code" href="../../db/d1c/format__cache_8h.html#a771d7c34570e8e492c25a0c2eb41889d">ast_format_slin</a>) == <a name="a267"></a><a class="code" href="../../d0/d0a/format_8h.html#a79bdf0b3c0616d9950d00cfeb62295c3ad88eb6e1d9b89b5e60412393b887391c">AST_FORMAT_CMP_NOT_EQUAL</a>) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Attempting to silence non-slin frame\n&quot;</span>);</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">      }</div><div class="line"></div><div class="line">      samples += orig-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;</div><div class="line"></div><div class="line">      orig = <a name="a268"></a><a class="code" href="../../df/d90/linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6">AST_LIST_NEXT</a>(orig, <a name="_a269"></a><a class="code" href="../../d9/d42/structframe__list.html">frame_list</a>);</div><div class="line">   } <span class="keywordflow">while</span> (orig);</div><div class="line"></div><div class="line">   <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Silencing %zu samples\n&quot;</span>, samples);</div><div class="line"></div><div class="line"></div><div class="line">   datalen = <span class="keyword">sizeof</span>(short) * samples;</div><div class="line">   size = <span class="keyword">sizeof</span>(*silence) + <a class="code" href="../../d0/d99/structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;</div><div class="line">   silence = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, size);</div><div class="line">   <span class="keywordflow">if</span> (!silence) {</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   silence-&gt;<a name="a270"></a><a class="code" href="../../d0/d99/structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = <a name="a271"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a22c49dfda592a2adb1fbaeaaa6ed3b7f">AST_MALLOCD_HDR</a>;</div><div class="line">   silence-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;</div><div class="line">   silence-&gt;<a name="a272"></a><a class="code" href="../../d0/d99/structast__frame.html#a4027905f872af30d910929b07e261ca5">data</a>.<a name="a273"></a><a class="code" href="../../d0/d99/structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = (<span class="keywordtype">void</span> *)(silence + 1);</div><div class="line">   silence-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="../../d0/d99/structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;</div><div class="line">   silence-&gt;<a class="code" href="../../d0/d99/structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = <a class="code" href="../../d0/d99/structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;</div><div class="line"></div><div class="line">   silence-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#ab425a484a0916077c5a30d9d7b229b44">format</a> = <a class="code" href="../../d5/da5/astobj2_8h.html#ac438c3fcd3150481fad38689fd813a15">ao2_bump</a>(<a class="code" href="../../db/d1c/format__cache_8h.html#a771d7c34570e8e492c25a0c2eb41889d">ast_format_slin</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> silence;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*!</span></div><div class="line"><span class="comment"> * \brief Sets a channel&#39;s read format to \ref AST_FORMAT_SLINEAR, recording</span></div><div class="line"><span class="comment"> * its original format.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * \param chan Channel to modify.</span></div><div class="line"><span class="comment"> * \param[out] orig_format Output variable to store channel&#39;s original read</span></div><div class="line"><span class="comment"> *                         format.</span></div><div class="line"><span class="comment"> * \return 0 on success.</span></div><div class="line"><span class="comment"> * \return -1 on error.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a274"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ae16884d936b144343ed8d1b9fbe60617">set_read_to_slin</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../d0/d98/structast__format.html">ast_format</a> **orig_format)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (!chan || !orig_format) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   *orig_format = <a class="code" href="../../d5/da5/astobj2_8h.html#ac438c3fcd3150481fad38689fd813a15">ao2_bump</a>(<a name="a275"></a><a class="code" href="../../d5/d7b/channel_8h.html#aaced431562223538a94e0e69cf94151a">ast_channel_readformat</a>(chan));</div><div class="line">   <span class="keywordflow">return</span> <a name="a276"></a><a class="code" href="../../d5/d7b/channel_8h.html#a9107a83365cbf327cc0d12cb0dbd28d8">ast_set_read_format</a>(chan, <a class="code" href="../../db/d1c/format__cache_8h.html#a771d7c34570e8e492c25a0c2eb41889d">ast_format_slin</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a277"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a3773ab842af7870b63ad24f3c4d4a541">global_silence_threshold</a> = 128;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a278"></a><a class="code" href="../../de/dfe/app__minivm_8c.html#a0442dc13ea144464c2b3f9aa6e2d6417">global_maxsilence</a> = 0;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*! Optionally play a sound file or a beep, then record audio and video from the channel.</span></div><div class="line"><span class="comment"> * \param chan Channel to playback to/record from.</span></div><div class="line"><span class="comment"> * \param playfile Filename of sound to play before recording begins.</span></div><div class="line"><span class="comment"> * \param recordfile Filename to record to.</span></div><div class="line"><span class="comment"> * \param maxtime Maximum length of recording (in seconds).</span></div><div class="line"><span class="comment"> * \param fmt Format(s) to record message in. Multiple formats may be specified by separating them with a &#39;|&#39;.</span></div><div class="line"><span class="comment"> * \param duration Where to store actual length of the recorded message (in milliseconds).</span></div><div class="line"><span class="comment"> * \param sound_duration Where to store the length of the recorded message (in milliseconds), minus any silence</span></div><div class="line"><span class="comment"> * \param beep Whether to play a beep before starting to record.</span></div><div class="line"><span class="comment"> * \param silencethreshold</span></div><div class="line"><span class="comment"> * \param maxsilence Length of silence that will end a recording (in milliseconds).</span></div><div class="line"><span class="comment"> * \param path Optional filesystem path to unlock.</span></div><div class="line"><span class="comment"> * \param prepend If true, prepend the recorded audio to an existing file and follow prepend mode recording rules</span></div><div class="line"><span class="comment"> * \param acceptdtmf DTMF digits that will end the recording.</span></div><div class="line"><span class="comment"> * \param canceldtmf DTMF digits that will cancel the recording.</span></div><div class="line"><span class="comment"> * \param skip_confirmation_sound If true, don&#39;t play auth-thankyou at end. Nice for custom recording prompts in apps.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * \retval -1 failure or hangup</span></div><div class="line"><span class="comment"> * \retval &#39;S&#39; Recording ended from silence timeout</span></div><div class="line"><span class="comment"> * \retval &#39;t&#39; Recording ended from the message exceeding the maximum duration, or via DTMF in prepend mode</span></div><div class="line"><span class="comment"> * \retval dtmfchar Recording ended via the return value&#39;s DTMF character for either cancel or accept.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a279"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a62eed141a738ca542b4373a0b078e431">__ast_play_and_record</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> *sound_duration, <span class="keywordtype">int</span> beep, <span class="keywordtype">int</span> <a name="a280"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <span class="keywordtype">int</span> <a name="a281"></a><a class="code" href="../../dc/df4/app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> prepend, <span class="keyword">const</span> <span class="keywordtype">char</span> *acceptdtmf, <span class="keyword">const</span> <span class="keywordtype">char</span> *canceldtmf, <span class="keywordtype">int</span> skip_confirmation_sound, <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236d">ast_record_if_exists</a> if_exists)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> d = 0;</div><div class="line">   <span class="keywordtype">char</span> *fmts;</div><div class="line">   <span class="keywordtype">char</span> <a name="a282"></a><a class="code" href="../../d2/d7e/ael__lex_8c.html#a43be22b7a1b528eaf759e034ec581543">comment</a>[256];</div><div class="line">   <span class="keywordtype">int</span> x, fmtcnt = 1, res = -1, outmsg = 0;</div><div class="line">   <span class="keyword">struct </span><a name="_a283"></a><a class="code" href="../../db/dbc/structast__filestream.html">ast_filestream</a> *others[<a name="a284"></a><a class="code" href="../../d2/d4d/file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *sfmt[<a class="code" href="../../d2/d4d/file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];</div><div class="line">   <span class="keywordtype">char</span> *stringp = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   time_t start, <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#a8fd806ad19b8f5513a4cf18cbf77532c">end</a>;</div><div class="line">   <span class="keyword">struct </span><a name="_a285"></a><a class="code" href="../../d6/de5/structast__dsp.html">ast_dsp</a> *sildet = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;   <span class="comment">/* silence detector dsp */</span></div><div class="line">   <span class="keywordtype">int</span> <a name="a286"></a><a class="code" href="../../d6/de5/structast__dsp.html#a37f3ccbb8c8ee286cec59a4b0340e924">totalsilence</a> = 0;</div><div class="line">   <span class="keywordtype">int</span> dspsilence = 0;</div><div class="line">   <span class="keywordtype">int</span> olddspsilence = 0;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d98/structast__format.html">ast_format</a> *rfmt = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d9/da1/structast__silence__generator.html">ast_silence_generator</a> *silgen = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">char</span> prependfile[<a name="a287"></a><a class="code" href="../../db/db2/asterisk_8h.html#ae688d728e1acdfe5988c7db45d6f0166">PATH_MAX</a>];</div><div class="line">   <span class="keywordtype">int</span> ioflags;   <span class="comment">/* IO flags for writing output file */</span></div><div class="line"></div><div class="line">   ioflags = O_CREAT|O_WRONLY;</div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (if_exists) {</div><div class="line">   <span class="keywordflow">case</span> <a name="a288"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da1bede8c45deb750da65ee623e4f40d40">AST_RECORD_IF_EXISTS_FAIL</a>:</div><div class="line">      ioflags |= O_EXCL;</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a289"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da8022c0ca0ab8535428aed27423a40e2c">AST_RECORD_IF_EXISTS_OVERWRITE</a>:</div><div class="line">      ioflags |= O_TRUNC;</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a290"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da2e88c94599603bf2929a8c9d1f58b13f">AST_RECORD_IF_EXISTS_APPEND</a>:</div><div class="line">      ioflags |= O_APPEND;</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a291"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236dadba683b279266f012721bd3839da240d">AST_RECORD_IF_EXISTS_ERROR</a>:</div><div class="line">      <a name="a292"></a><a class="code" href="../../d5/d60/utils_8h.html#a24374da24af1931d8a7ccde5b352bb2c">ast_assert</a>(0);</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (silencethreshold &lt; 0) {</div><div class="line">      silencethreshold = <a class="code" href="../../d3/d83/main_2app_8c.html#a3773ab842af7870b63ad24f3c4d4a541">global_silence_threshold</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (maxsilence &lt; 0) {</div><div class="line">      maxsilence = <a class="code" href="../../de/dfe/app__minivm_8c.html#a0442dc13ea144464c2b3f9aa6e2d6417">global_maxsilence</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* barf if no pointer passed to store duration in */</span></div><div class="line">   <span class="keywordflow">if</span> (!duration) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error play_and_record called without duration pointer\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;play_and_record: %s, %s, &#39;%s&#39;\n&quot;</span>, playfile ? playfile : <span class="stringliteral">&quot;&lt;None&gt;&quot;</span>, recordfile, fmt);</div><div class="line">   snprintf(comment, <span class="keyword">sizeof</span>(comment), <span class="stringliteral">&quot;Playing %s, Recording to: %s on %s\n&quot;</span>, playfile ? playfile : <span class="stringliteral">&quot;&lt;None&gt;&quot;</span>, recordfile, <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan));</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (playfile || beep) {</div><div class="line">      <span class="keywordflow">if</span> (!beep) {</div><div class="line">         d = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, playfile);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (d &gt; -1) {</div><div class="line">         d = <a name="a293"></a><a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (d &lt; 0) {</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (prepend) {</div><div class="line">      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(prependfile, recordfile, <span class="keyword">sizeof</span>(prependfile));</div><div class="line">      strncat(prependfile, <span class="stringliteral">&quot;-prepend&quot;</span>, <span class="keyword">sizeof</span>(prependfile) - strlen(prependfile) - 1);</div><div class="line">   }</div><div class="line"></div><div class="line">   fmts = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(fmt);</div><div class="line"></div><div class="line">   stringp = fmts;</div><div class="line">   <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);</div><div class="line">   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Recording Formats: sfmts=%s\n&quot;</span>, fmts);</div><div class="line">   sfmt[0] = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(fmts);</div><div class="line"></div><div class="line">   <span class="keywordflow">while</span> ((fmt = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>))) {</div><div class="line">      <span class="keywordflow">if</span> (fmtcnt &gt; <a class="code" href="../../d2/d4d/file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a> - 1) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Please increase AST_MAX_FORMATS in file.h\n&quot;</span>);</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * Storage for &#39;fmt&#39; is on the stack and held by &#39;fmts&#39;, which is maintained for</span></div><div class="line"><span class="comment">       * the rest of this function. So okay to not duplicate &#39;fmt&#39; here, but only keep</span></div><div class="line"><span class="comment">       * a pointer to it.</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      sfmt[fmtcnt++] = fmt;</div><div class="line">   }</div><div class="line"></div><div class="line">   end = start = time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);  <span class="comment">/* pre-initialize end to be same as start in case we never get into loop */</span></div><div class="line">   <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {</div><div class="line">      others[x] = <a name="a294"></a><a class="code" href="../../d2/d4d/file_8h.html#a964f8ef393c07609d7b9e02937faed52">ast_writefile</a>(prepend ? prependfile : recordfile, sfmt[x], comment, ioflags, 0, <a name="a295"></a><a class="code" href="../../db/db2/asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;x=%d, open writing:  %s format: %s, %p\n&quot;</span>, x, prepend ? prependfile : recordfile, sfmt[x], others[x]);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (!others[x]) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (path) {</div><div class="line">      <a name="a296"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(path);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (maxsilence &gt; 0) {</div><div class="line">      sildet = <a name="a297"></a><a class="code" href="../../d3/d08/dsp_8h.html#a0a60e93006c8e1ca8fda922ae0e0da2c">ast_dsp_new</a>(); <span class="comment">/* Create the silence detector */</span></div><div class="line">      <span class="keywordflow">if</span> (!sildet) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create silence detector :(\n&quot;</span>);</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line">      <a name="a298"></a><a class="code" href="../../d3/d08/dsp_8h.html#a06a0b883127ba1f853e9e0fa5f29d81b">ast_dsp_set_threshold</a>(sildet, silencethreshold);</div><div class="line">      res = <a class="code" href="../../d3/d83/main_2app_8c.html#ae16884d936b144343ed8d1b9fbe60617">set_read_to_slin</a>(chan, &amp;rfmt);</div><div class="line">      <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set to linear mode, giving up\n&quot;</span>);</div><div class="line">         <a name="a299"></a><a class="code" href="../../d3/d08/dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);</div><div class="line">         <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(rfmt);</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!prepend) {</div><div class="line">      <span class="comment">/* Request a video update */</span></div><div class="line">      <a class="code" href="../../d5/d7b/channel_8h.html#aef2af15a597c948e97628da6c5c84f28">ast_indicate</a>(chan, <a name="a300"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5b/options_8h.html#afe8795c4ec744506a9300700fc0813dc">ast_opt_transmit_silence</a>) {</div><div class="line">         silgen = <a class="code" href="../../d5/d7b/channel_8h.html#a2a2e0ff24c57491a877cac39cb670024">ast_channel_start_silence_generator</a>(chan);</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (x == fmtcnt) {</div><div class="line">      <span class="comment">/* Loop, writing the packets we read to the writer(s), until</span></div><div class="line"><span class="comment">       * we have reason to stop. */</span></div><div class="line">      <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *f;</div><div class="line">      <span class="keywordtype">int</span> paused = 0;</div><div class="line">      <span class="keywordtype">int</span> <a name="a301"></a><a class="code" href="../../d0/d8a/muted_8c.html#a89e6edfc95e7880a0713bd96189f7ec3">muted</a> = 0;</div><div class="line">      time_t pause_start = 0;</div><div class="line">      <span class="keywordtype">int</span> paused_secs = 0;</div><div class="line">      <span class="keywordtype">int</span> pausedsilence = 0;</div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (;;) {</div><div class="line">         <span class="keywordflow">if</span> (!(res = <a class="code" href="../../d5/d7b/channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc">ast_waitfor</a>(chan, 2000))) {</div><div class="line">            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;One waitfor failed, trying another\n&quot;</span>);</div><div class="line">            <span class="comment">/* Try one more time in case of masq */</span></div><div class="line">            <span class="keywordflow">if</span> (!(res = <a class="code" href="../../d5/d7b/channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc">ast_waitfor</a>(chan, 2000))) {</div><div class="line">               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No audio available on %s??\n&quot;</span>, <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan));</div><div class="line">               res = -1;</div><div class="line">            }</div><div class="line">         }</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">            f = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (!(f = <a name="a302"></a><a class="code" href="../../d5/d7b/channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1">ast_read</a>(chan))) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {</div><div class="line">            <span class="comment">/* write each format */</span></div><div class="line">            <span class="keywordflow">if</span> (paused) {</div><div class="line">               <span class="comment">/* It&#39;s all good */</span></div><div class="line">               res = 0;</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">               <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *silence = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">               <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *orig = f;</div><div class="line"></div><div class="line">               <span class="keywordflow">if</span> (muted) {</div><div class="line">                  silence = <a class="code" href="../../d3/d83/main_2app_8c.html#acebf42e1b2956855f73e9dd7ef66d785">make_silence</a>(orig);</div><div class="line">                  <span class="keywordflow">if</span> (!silence) {</div><div class="line">                     <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error creating silence\n&quot;</span>);</div><div class="line">                     <span class="keywordflow">break</span>;</div><div class="line">                  }</div><div class="line">                  f = silence;</div><div class="line">               }</div><div class="line">               <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {</div><div class="line">                  <span class="keywordflow">if</span> (prepend &amp;&amp; !others[x]) {</div><div class="line">                     <span class="keywordflow">break</span>;</div><div class="line">                  }</div><div class="line">                  res = <a name="a303"></a><a class="code" href="../../d2/d4d/file_8h.html#a3608386b919ef0949d2858cdeb02d12e">ast_writestream</a>(others[x], f);</div><div class="line">               }</div><div class="line">               <a name="a304"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a31a8e2bf0224cfe62148232ed25e1aea">ast_frame_dtor</a>(silence);</div><div class="line">               f = orig;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/* Silence Detection */</span></div><div class="line">            <span class="keywordflow">if</span> (maxsilence &gt; 0) {</div><div class="line">               dspsilence = 0;</div><div class="line">               <a name="a305"></a><a class="code" href="../../d3/d08/dsp_8h.html#a3f3b67988bffb3addfbc8a4688fa466d">ast_dsp_silence</a>(sildet, f, &amp;dspsilence);</div><div class="line">               <span class="keywordflow">if</span> (olddspsilence &gt; dspsilence) {</div><div class="line">                  totalsilence += olddspsilence;</div><div class="line">               }</div><div class="line">               olddspsilence = dspsilence;</div><div class="line"></div><div class="line">               <span class="keywordflow">if</span> (paused) {</div><div class="line">                  <span class="comment">/* record how much silence there was while we are paused */</span></div><div class="line">                  pausedsilence = dspsilence;</div><div class="line">               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dspsilence &gt; pausedsilence) {</div><div class="line">                  <span class="comment">/* ignore the paused silence */</span></div><div class="line">                  dspsilence -= pausedsilence;</div><div class="line">               } <span class="keywordflow">else</span> {</div><div class="line">                  <span class="comment">/* dspsilence has reset, reset pausedsilence */</span></div><div class="line">                  pausedsilence = 0;</div><div class="line">               }</div><div class="line"></div><div class="line">               <span class="keywordflow">if</span> (dspsilence &gt; maxsilence) {</div><div class="line">                  <span class="comment">/* Ended happily with silence */</span></div><div class="line">                  <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Recording automatically stopped after a silence of %d seconds\n&quot;</span>, dspsilence/1000);</div><div class="line">                  res = <span class="charliteral">&#39;S&#39;</span>;</div><div class="line">                  outmsg = 2;</div><div class="line">                  <span class="keywordflow">break</span>;</div><div class="line">               }</div><div class="line">            }</div><div class="line">            <span class="comment">/* Exit on any error */</span></div><div class="line">            <span class="keywordflow">if</span> (res) {</div><div class="line">               <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error writing frame\n&quot;</span>);</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a name="a306"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {</div><div class="line">            <span class="comment">/* Write only once */</span></div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a3608386b919ef0949d2858cdeb02d12e">ast_writestream</a>(others[0], f);</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a name="a307"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {</div><div class="line">            <span class="keywordflow">if</span> (prepend) {</div><div class="line">            <span class="comment">/* stop recording with any digit */</span></div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User ended message by pressing %c\n&quot;</span>, f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>);</div><div class="line">               res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line">               outmsg = 2;</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">if</span> (strchr(acceptdtmf, f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>)) {</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User ended message by pressing %c\n&quot;</span>, f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>);</div><div class="line">               res = f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>;</div><div class="line">               outmsg = 2;</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">if</span> (strchr(canceldtmf, f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>)) {</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User canceled message by pressing %c\n&quot;</span>, f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>);</div><div class="line">               res = f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a>;</div><div class="line">               outmsg = 0;</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) {</div><div class="line">            <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a> == <a name="a308"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a192282f4ac45366cf94839e59e4659c2">AST_CONTROL_RECORD_CANCEL</a>) {</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message canceled by control\n&quot;</span>);</div><div class="line">               outmsg = 0; <span class="comment">/* cancels the recording */</span></div><div class="line">               res = 0;</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a> == <a name="a309"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a84c4783c63eaa92e3ae2230e7f506401">AST_CONTROL_RECORD_STOP</a>) {</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message ended by control\n&quot;</span>);</div><div class="line">               res = 0;</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a> == <a name="a310"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390aef1bbb9ea8c75f2833076b583f99cdec">AST_CONTROL_RECORD_SUSPEND</a>) {</div><div class="line">               paused = !paused;</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message %spaused by control\n&quot;</span>,</div><div class="line">                  paused ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>);</div><div class="line">               <span class="keywordflow">if</span> (paused) {</div><div class="line">                  pause_start = time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">               } <span class="keywordflow">else</span> {</div><div class="line">                  paused_secs += time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) - pause_start;</div><div class="line">               }</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d0/d99/structast__frame.html#a27237c48fdcd22556401f20c693811db">subclass</a>.<a class="code" href="../../d1/d9f/structast__frame__subclass.html#adece183191b0e700e039e59101e06105">integer</a> == <a name="a311"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#aedda41918e992000fe921f8f7363b390a9ed4c9cba00cfa3b18500f56d6210523">AST_CONTROL_RECORD_MUTE</a>) {</div><div class="line">               muted = !<a class="code" href="../../d0/d8a/muted_8c.html#a89e6edfc95e7880a0713bd96189f7ec3">muted</a>;</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message %smuted by control\n&quot;</span>,</div><div class="line">                  muted ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>);</div><div class="line">               <span class="comment">/* We can only silence slin frames, so</span></div><div class="line"><span class="comment">                * set the mode, if we haven&#39;t already</span></div><div class="line"><span class="comment">                * for sildet</span></div><div class="line"><span class="comment">                */</span></div><div class="line">               <span class="keywordflow">if</span> (muted &amp;&amp; !rfmt) {</div><div class="line">                  <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Setting read format to linear mode\n&quot;</span>);</div><div class="line">                  res = <a class="code" href="../../d3/d83/main_2app_8c.html#ae16884d936b144343ed8d1b9fbe60617">set_read_to_slin</a>(chan, &amp;rfmt);</div><div class="line">                  <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">                     <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set to linear mode, giving up\n&quot;</span>);</div><div class="line">                     <span class="keywordflow">break</span>;</div><div class="line">                  }</div><div class="line">               }</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (maxtime &amp;&amp; !paused) {</div><div class="line">            end = time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">            <span class="keywordflow">if</span> (maxtime &lt; (end - start - paused_secs)) {</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Took too long, cutting it short...\n&quot;</span>);</div><div class="line">               res = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line">               outmsg = 2;</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <a name="a312"></a><a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (!f) {</div><div class="line">         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hung up\n&quot;</span>);</div><div class="line">         res = -1;</div><div class="line">         outmsg = 1;</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);</div><div class="line">      }</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error creating writestream &#39;%s&#39;, format &#39;%s&#39;\n&quot;</span>, recordfile, sfmt[x]);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!prepend) {</div><div class="line">      <span class="keywordflow">if</span> (silgen) {</div><div class="line">         <a class="code" href="../../d5/d7b/channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d">ast_channel_stop_silence_generator</a>(chan, silgen);</div><div class="line">      }</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /*!\note</span></div><div class="line"><span class="comment">    * Instead of asking how much time passed (end - start), calculate the number</span></div><div class="line"><span class="comment">    * of seconds of audio which actually went into the file.  This fixes a</span></div><div class="line"><span class="comment">    * problem where audio is stopped up on the network and never gets to us.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * Note that we still want to use the number of seconds passed for the max</span></div><div class="line"><span class="comment">    * message, otherwise we could get a situation where this stream is never</span></div><div class="line"><span class="comment">    * closed (which would create a resource leak).</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   *duration = others[0] ? <a class="code" href="../../d2/d4d/file_8h.html#a01771a318e7adea51499040f27b4278a">ast_tellstream</a>(others[0]) / 8000 : 0;</div><div class="line">   <span class="keywordflow">if</span> (sound_duration) {</div><div class="line">      *sound_duration = *duration;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!prepend) {</div><div class="line">      <span class="comment">/* Reduce duration by a total silence amount */</span></div><div class="line">      <span class="keywordflow">if</span> (olddspsilence &lt;= dspsilence) {</div><div class="line">         totalsilence += dspsilence;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (sound_duration) {</div><div class="line">         <span class="keywordflow">if</span> (totalsilence &gt; 0) {</div><div class="line">            *sound_duration -= (totalsilence - 200) / 1000;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (*sound_duration &lt; 0) {</div><div class="line">            *sound_duration = 0;</div><div class="line">         }</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (dspsilence &gt; 0) {</div><div class="line">         *duration -= (dspsilence - 200) / 1000;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (*duration &lt; 0) {</div><div class="line">         *duration = 0;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {</div><div class="line">         <span class="keywordflow">if</span> (!others[x]) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }<span class="comment"></span></div><div class="line"><span class="comment">         /*!\note</span></div><div class="line"><span class="comment">          * If we ended with silence, trim all but the first 200ms of silence</span></div><div class="line"><span class="comment">          * off the recording.  However, if we ended with &#39;#&#39;, we don&#39;t want</span></div><div class="line"><span class="comment">          * to trim ANY part of the recording.</span></div><div class="line"><span class="comment">          */</span></div><div class="line">         <span class="keywordflow">if</span> (res &gt; 0 &amp;&amp; dspsilence) {</div><div class="line">            <span class="comment">/* rewind only the trailing silence */</span></div><div class="line">            <a name="a313"></a><a class="code" href="../../d2/d4d/file_8h.html#a4c7c02a659b09bb06dd63e1f42692666">ast_stream_rewind</a>(others[x], dspsilence - 200);</div><div class="line">         }</div><div class="line">         <a name="a314"></a><a class="code" href="../../d2/d4d/file_8h.html#aa647ac352a00b559131f90ffffea2c3c">ast_truncstream</a>(others[x]);</div><div class="line">         <a name="a315"></a><a class="code" href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a>(others[x]);</div><div class="line">      }</div><div class="line">   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prepend &amp;&amp; outmsg) {</div><div class="line">      <span class="keyword">struct </span><a class="code" href="../../db/dbc/structast__filestream.html">ast_filestream</a> *realfiles[<a class="code" href="../../d2/d4d/file_8h.html#aa932272aad0c1610b79e9b04e54e57ea">AST_MAX_FORMATS</a>];</div><div class="line">      <span class="keyword">struct </span><a class="code" href="../../d0/d99/structast__frame.html">ast_frame</a> *fr;</div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {</div><div class="line">         snprintf(comment, <span class="keyword">sizeof</span>(comment), <span class="stringliteral">&quot;Opening the real file %s.%s\n&quot;</span>, recordfile, sfmt[x]);</div><div class="line">         realfiles[x] = <a name="a316"></a><a class="code" href="../../d2/d4d/file_8h.html#ad572060ea434390db3d1ccde4511dfcd">ast_readfile</a>(recordfile, sfmt[x], comment, O_RDONLY, 0, 0);</div><div class="line">         <span class="keywordflow">if</span> (!others[x]) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (!realfiles[x]) {</div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a>(others[x]);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">         }<span class="comment"></span></div><div class="line"><span class="comment">         /*!\note Same logic as above. */</span></div><div class="line">         <span class="keywordflow">if</span> (dspsilence) {</div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a4c7c02a659b09bb06dd63e1f42692666">ast_stream_rewind</a>(others[x], dspsilence - 200);</div><div class="line">         }</div><div class="line">         <a class="code" href="../../d2/d4d/file_8h.html#aa647ac352a00b559131f90ffffea2c3c">ast_truncstream</a>(others[x]);</div><div class="line">         <span class="comment">/* add the original file too */</span></div><div class="line">         <span class="keywordflow">while</span> ((fr = <a name="a317"></a><a class="code" href="../../d2/d4d/file_8h.html#a962bc31d7a953b0a0290c72b168d41a7">ast_readframe</a>(realfiles[x]))) {</div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a3608386b919ef0949d2858cdeb02d12e">ast_writestream</a>(others[x], fr);</div><div class="line">            <a class="code" href="../../d6/d66/include_2asterisk_2frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);</div><div class="line">         }</div><div class="line">         <a class="code" href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a>(others[x]);</div><div class="line">         <a class="code" href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a>(realfiles[x]);</div><div class="line">         <a name="a318"></a><a class="code" href="../../d2/d4d/file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba">ast_filerename</a>(prependfile, recordfile, sfmt[x]);</div><div class="line">         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Recording Format: sfmts=%s, prependfile %s, recordfile %s\n&quot;</span>, sfmt[x], prependfile, recordfile);</div><div class="line">         <a name="a319"></a><a class="code" href="../../d2/d4d/file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb">ast_filedelete</a>(prependfile, sfmt[x]);</div><div class="line">      }</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <span class="keywordflow">for</span> (x = 0; x &lt; fmtcnt; x++) {</div><div class="line">         <span class="keywordflow">if</span> (!others[x]) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         <a class="code" href="../../d2/d4d/file_8h.html#ab53bd2c3c55d509790c7f7620aac6373">ast_closestream</a>(others[x]);</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (rfmt &amp;&amp; <a class="code" href="../../d5/d7b/channel_8h.html#a9107a83365cbf327cc0d12cb0dbd28d8">ast_set_read_format</a>(chan, rfmt)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore format %s to channel &#39;%s&#39;\n&quot;</span>, <a class="code" href="../../d0/d0a/format_8h.html#a082f0fca94b18ba466f6e28d3ccb2fc8">ast_format_get_name</a>(rfmt), <a class="code" href="../../d5/d7b/channel_8h.html#a7ca2fda13b129a55c251b56729de285b">ast_channel_name</a>(chan));</div><div class="line">   }</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(rfmt);</div><div class="line">   <span class="keywordflow">if</span> ((outmsg == 2) &amp;&amp; (!skip_confirmation_sound)) {</div><div class="line">      <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;auth-thankyou&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (sildet) {</div><div class="line">      <a class="code" href="../../d3/d08/dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(sildet);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a name="a320"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a28df6ce01a3a3bc9f0495c070443b4ee">default_acceptdtmf</a>[] = <span class="stringliteral">&quot;#&quot;</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a name="a321"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a652c75796183b2b640cc95dc58b76bab">default_canceldtmf</a>[] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a322"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a13a3ff0da2d7d40198b3eafbde0464a0">ast_play_and_record_full</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> *sound_duration, <span class="keywordtype">int</span> beep, <span class="keywordtype">int</span> silencethreshold, <span class="keywordtype">int</span> maxsilence, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *acceptdtmf, <span class="keyword">const</span> <span class="keywordtype">char</span> *canceldtmf, <span class="keywordtype">int</span> skip_confirmation_sound, <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236d">ast_record_if_exists</a> if_exists)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a62eed141a738ca542b4373a0b078e431">__ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, sound_duration, beep, silencethreshold, maxsilence, path, 0, <a name="a323"></a><a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(acceptdtmf, <span class="stringliteral">&quot;&quot;</span>), <a class="code" href="../../d6/d90/strings_8h.html#a2faaa16929951bfd2802b7829a100ba2">S_OR</a>(canceldtmf, default_canceldtmf), skip_confirmation_sound, if_exists);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a324"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a675ebd613588a960e37bd6fa2477f30f">ast_play_and_record</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> *sound_duration, <span class="keywordtype">int</span> silencethreshold, <span class="keywordtype">int</span> maxsilence, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a62eed141a738ca542b4373a0b078e431">__ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, sound_duration, 0, silencethreshold, maxsilence, path, 0, default_acceptdtmf, default_canceldtmf, 0, <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da8022c0ca0ab8535428aed27423a40e2c">AST_RECORD_IF_EXISTS_OVERWRITE</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a325"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a6c0c71b2a228214f089f4516a4d91793">ast_play_and_prepend</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keywordtype">char</span> *playfile, <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keywordtype">int</span> *sound_duration, <span class="keywordtype">int</span> beep, <span class="keywordtype">int</span> silencethreshold, <span class="keywordtype">int</span> maxsilence)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a62eed141a738ca542b4373a0b078e431">__ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, sound_duration, beep, silencethreshold, maxsilence, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1, default_acceptdtmf, default_canceldtmf, 1, <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac665722c9bfe6d9b506df95184aa236da8022c0ca0ab8535428aed27423a40e2c">AST_RECORD_IF_EXISTS_OVERWRITE</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Channel group core functions */</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a326"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ab926dd29fc418cde5b67a00ba914cd2c">ast_app_group_split_group</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a name="_a327"></a><a class="code" href="../../d3/d08/structgroup.html">group</a>, <span class="keywordtype">int</span> group_max, <span class="keywordtype">char</span> *category, <span class="keywordtype">int</span> category_max)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line">   <span class="keywordtype">char</span> <a name="a328"></a><a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>[256];</div><div class="line">   <span class="keywordtype">char</span> *grp = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *cat = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(data)) {</div><div class="line">      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(tmp, data, <span class="keyword">sizeof</span>(tmp));</div><div class="line">      grp = <a class="code" href="../../de/d1e/bt__open_8c.html#a1cdd2bb1a9a71d3e1120100229315d67">tmp</a>;</div><div class="line">      <span class="keywordflow">if</span> ((cat = strchr(tmp, <span class="charliteral">&#39;@&#39;</span>))) {</div><div class="line">         *cat++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(grp)) {</div><div class="line">      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(group, grp, group_max);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      *group = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(cat)) {</div><div class="line">      <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(category, cat, category_max);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a329"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a6bd3fac13a76cd864600a84ffd66724e">ast_app_group_set_channel</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line">   <span class="keywordtype">char</span> group[80] = <span class="stringliteral">&quot;&quot;</span>, category[80] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a> *gi = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">size_t</span> len = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ab926dd29fc418cde5b67a00ba914cd2c">ast_app_group_split_group</a>(data, group, <span class="keyword">sizeof</span>(group), category, <span class="keyword">sizeof</span>(category))) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Calculate memory we will need if this is new */</span></div><div class="line">   len = <span class="keyword">sizeof</span>(*gi) + strlen(group) + 1;</div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category)) {</div><div class="line">      len += strlen(category) + 1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a name="a330"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">   <a name="a331"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>, gi, <a name="a332"></a><a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>) {</div><div class="line">      <span class="keywordflow">if</span> ((gi-&gt;<a name="a333"></a><a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == chan) &amp;&amp; ((<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category) &amp;&amp; <a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(gi-&gt;<a name="a334"></a><a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>)) || (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; !strcasecmp(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, category)))) {</div><div class="line">         <a name="a335"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>);</div><div class="line">         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(gi);</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <a name="a336"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(group)) {</div><div class="line">      <span class="comment">/* Enable unsetting the group */</span></div><div class="line">   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((gi = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, len))) {</div><div class="line">      gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;</div><div class="line">      gi-&gt;<a name="a337"></a><a class="code" href="../../d0/d07/structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a> = (<span class="keywordtype">char</span> *) gi + <span class="keyword">sizeof</span>(*gi);</div><div class="line">      strcpy(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, group);</div><div class="line">      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category)) {</div><div class="line">         gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a> = (<span class="keywordtype">char</span> *) gi + <span class="keyword">sizeof</span>(*gi) + strlen(group) + 1;</div><div class="line">         strcpy(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, category);</div><div class="line">      }</div><div class="line">      <a name="a338"></a><a class="code" href="../../df/d90/linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>, gi, <a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      res = -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a name="a339"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a340"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a026ae712c21ad8f1e8cde66467153838">ast_app_group_get_count</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *group, <span class="keyword">const</span> <span class="keywordtype">char</span> *category)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a> *gi = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">int</span> count = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(group)) {</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a name="a341"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">   <a name="a342"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>, gi, <a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>) {</div><div class="line">      <span class="keywordflow">if</span> (!strcasecmp(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, group) &amp;&amp; (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category) || (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; !strcasecmp(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, category)))) {</div><div class="line">         count++;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> count;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a343"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a687e664c7fb3bb2acb4f5fa17f28d3a2">ast_app_group_match_get_count</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *groupmatch, <span class="keyword">const</span> <span class="keywordtype">char</span> *category)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a> *gi = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   regex_t regexbuf_group;</div><div class="line">   regex_t regexbuf_category;</div><div class="line">   <span class="keywordtype">int</span> count = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(groupmatch)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;groupmatch empty\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* if regex compilation fails, return zero matches */</span></div><div class="line">   <span class="keywordflow">if</span> (regcomp(&amp;regexbuf_group, groupmatch, REG_EXTENDED | REG_NOSUB)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Regex compile failed on: %s\n&quot;</span>, groupmatch);</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category) &amp;&amp; regcomp(&amp;regexbuf_category, category, REG_EXTENDED | REG_NOSUB)) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Regex compile failed on: %s\n&quot;</span>, category);</div><div class="line">      regfree(&amp;regexbuf_group);</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>, gi, <a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>) {</div><div class="line">      <span class="keywordflow">if</span> (!regexec(&amp;regexbuf_group, gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0) &amp;&amp; (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category) || (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) &amp;&amp; !regexec(&amp;regexbuf_category, gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>, 0, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)))) {</div><div class="line">         count++;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line"></div><div class="line">   regfree(&amp;regexbuf_group);</div><div class="line">   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(category)) {</div><div class="line">      regfree(&amp;regexbuf_category);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> count;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a344"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a69e90e401aa3da48a6eef5139727cbb3">ast_app_group_update</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *old, <span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *<span class="keyword">new</span>)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a> *gi = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>, gi, <a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>) {</div><div class="line">      <span class="keywordflow">if</span> (gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == old) {</div><div class="line">         gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <span class="keyword">new</span>;</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == <span class="keyword">new</span>) {</div><div class="line">         <a class="code" href="../../df/d90/linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>);</div><div class="line">         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(gi);</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a345"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#add0f96b4b815205f528f5248ccb3d515">ast_app_group_discard</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan)</div><div class="line">{</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a> *gi = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line"></div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>, gi, <a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>) {</div><div class="line">      <span class="keywordflow">if</span> (gi-&gt;<a class="code" href="../../d0/d07/structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a> == chan) {</div><div class="line">         <a class="code" href="../../df/d90/linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="../../d0/d07/structast__group__info.html#acd9586542829317c2b39f35b99d63d56">group_list</a>);</div><div class="line">         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(gi);</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a346"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a6d1783b818b130e529c611e710beafe9">ast_app_group_list_wrlock</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a347"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#afa354da7388ee1882ac981396f143bda">ast_app_group_list_rdlock</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d0/d07/structast__group__info.html">ast_group_info</a> *<a name="a348"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ae351dc6f23997a800e7a743d6411b8e7">ast_app_group_list_head</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a name="a349"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a64835fe6d570951b2a0404799c3d116f">AST_RWLIST_FIRST</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a350"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aa3d01e65e04cddfa84781590b37732e8">ast_app_group_list_unlock</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="../../d9/d28/structgroups.html">groups</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a name="a351"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1b65265bef5e0d7110092144ba9ee4da">__ast_app_separate_args</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">char</span> delim, <span class="keywordtype">int</span> remove_chars, <span class="keywordtype">char</span> **<a name="a352"></a><a class="code" href="../../d9/d1e/func__strings_8c.html#ab6e308b3a41c01e08d252e071511495c">array</a>, <span class="keywordtype">int</span> arraylen)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> argc;</div><div class="line">   <span class="keywordtype">char</span> *scan, *wasdelim = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keywordtype">int</span> <a name="a353"></a><a class="code" href="../../d2/d7e/ael__lex_8c.html#a0dec70156318396f15cc8305df9918ab">paren</a> = 0, <a name="a354"></a><a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> = 0, bracket = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!array || !arraylen) {</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   memset(array, 0, arraylen * <span class="keyword">sizeof</span>(*array));</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!buf) {</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   scan = <a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span> (argc = 0; *scan &amp;&amp; (argc &lt; arraylen - 1); argc++) {</div><div class="line">      array[argc] = scan;</div><div class="line">      <span class="keywordflow">for</span> (; *scan; scan++) {</div><div class="line">         <span class="keywordflow">if</span> (*scan == <span class="charliteral">&#39;(&#39;</span>) {</div><div class="line">            paren++;</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&#39;)&#39;</span>) {</div><div class="line">            <span class="keywordflow">if</span> (paren) {</div><div class="line">               paren--;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&#39;[&#39;</span>) {</div><div class="line">            bracket++;</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&#39;]&#39;</span>) {</div><div class="line">            <span class="keywordflow">if</span> (bracket) {</div><div class="line">               bracket--;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&#39;&quot;&#39;</span> &amp;&amp; delim != <span class="charliteral">&#39;&quot;&#39;</span>) {</div><div class="line">            <a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> = <a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> ? 0 : 1;</div><div class="line">            <span class="keywordflow">if</span> (remove_chars) {</div><div class="line">               <span class="comment">/* Remove quote character from argument */</span></div><div class="line">               memmove(scan, scan + 1, strlen(scan));</div><div class="line">               scan--;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*scan == <span class="charliteral">&#39;\\&#39;</span>) {</div><div class="line">            <span class="keywordflow">if</span> (remove_chars) {</div><div class="line">               <span class="comment">/* Literal character, don&#39;t parse */</span></div><div class="line">               memmove(scan, scan + 1, strlen(scan));</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">               scan++;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*scan == delim) &amp;&amp; !paren &amp;&amp; !<a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> &amp;&amp; !bracket) {</div><div class="line">            wasdelim = scan;</div><div class="line">            *scan++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* If the last character in the original string was the delimiter, then</span></div><div class="line"><span class="comment">    * there is one additional argument. */</span></div><div class="line">   <span class="keywordflow">if</span> (*scan || (scan &gt; buf &amp;&amp; (scan - 1) == wasdelim)) {</div><div class="line">      array[argc++] = scan;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> argc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> <a name="a355"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a5e3efda31e8018f394246681664d447c">ast_lock_path_lockfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *s;</div><div class="line">   <span class="keywordtype">char</span> *fs;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordtype">int</span> fd;</div><div class="line">   <span class="keywordtype">int</span> lp = strlen(path);</div><div class="line">   time_t start;</div><div class="line"></div><div class="line">   s = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(lp + 10);</div><div class="line">   fs = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(lp + 20);</div><div class="line"></div><div class="line">   snprintf(fs, strlen(path) + 19, <span class="stringliteral">&quot;%s/.lock-%08lx&quot;</span>, path, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a name="a356"></a><a class="code" href="../../d5/d60/utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());</div><div class="line">   fd = open(fs, O_WRONLY | O_CREAT | O_EXCL, <a class="code" href="../../db/db2/asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);</div><div class="line">   <span class="keywordflow">if</span> (fd &lt; 0) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create lock file &#39;%s&#39;: %s\n&quot;</span>, path, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">      <span class="keywordflow">return</span> <a name="a357"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca46f6f55c5ee9576afd8dde6376c2b01a">AST_LOCK_PATH_NOT_FOUND</a>;</div><div class="line">   }</div><div class="line">   close(fd);</div><div class="line"></div><div class="line">   snprintf(s, strlen(path) + 9, <span class="stringliteral">&quot;%s/.lock&quot;</span>, path);</div><div class="line">   start = time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">   <span class="keywordflow">while</span> (((res = link(fs, s)) &lt; 0) &amp;&amp; (<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EEXIST) &amp;&amp; (time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) - start &lt; 5)) {</div><div class="line">      sched_yield();</div><div class="line">   }</div><div class="line"></div><div class="line">   unlink(fs);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (res) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock path &#39;%s&#39;: %s\n&quot;</span>, path, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">      <span class="keywordflow">return</span> <a name="a358"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a>;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Locked path &#39;%s&#39;\n&quot;</span>, path);</div><div class="line">      <span class="keywordflow">return</span> <a name="a359"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca37bdbc92223520af2a24d5bfd6f561bb">AST_LOCK_SUCCESS</a>;</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a360"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a41764988af00a30b8de64b8a37e8228d">ast_unlock_path_lockfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *s;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line"></div><div class="line">   s = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(strlen(path) + 10);</div><div class="line"></div><div class="line">   snprintf(s, strlen(path) + 9, <span class="stringliteral">&quot;%s/%s&quot;</span>, path, <span class="stringliteral">&quot;.lock&quot;</span>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((res = unlink(s))) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not unlock path &#39;%s&#39;: %s\n&quot;</span>, path, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Unlocked path &#39;%s&#39;\n&quot;</span>, path);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a name="_a361"></a><a class="code" href="../../da/da7/structpath__lock.html">path_lock</a> {</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7">AST_LIST_ENTRY</a>(<a class="code" href="../../da/da7/structpath__lock.html">path_lock</a>) le;</div><div class="line">   <span class="keywordtype">int</span> fd;</div><div class="line">   <span class="keywordtype">char</span> *path;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../df/d90/linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b">AST_LIST_HEAD_STATIC</a>(<a name="_a362"></a><a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>, <a class="code" href="../../da/da7/structpath__lock.html">path_lock</a>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a363"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(<span class="keyword">struct</span> <a class="code" href="../../da/da7/structpath__lock.html">path_lock</a> *obj)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (obj-&gt;<a name="a364"></a><a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &gt;= 0) {</div><div class="line">      close(obj-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (obj-&gt;<a name="a365"></a><a class="code" href="../../da/da7/structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>) {</div><div class="line">      <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>);</div><div class="line">   }</div><div class="line">   <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> <a name="a366"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a631aa3756c80daa3b4c825189cfc183c">ast_lock_path_flock</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *fs;</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordtype">int</span> fd;</div><div class="line">   time_t start;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../da/da7/structpath__lock.html">path_lock</a> *pl;</div><div class="line">   <span class="keyword">struct </span>stat st, ost;</div><div class="line"></div><div class="line">   fs = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(strlen(path) + 20);</div><div class="line"></div><div class="line">   snprintf(fs, strlen(path) + 19, <span class="stringliteral">&quot;%s/lock&quot;</span>, path);</div><div class="line">   <span class="keywordflow">if</span> (lstat(fs, &amp;st) == 0) {</div><div class="line">      <span class="keywordflow">if</span> ((st.st_mode &amp; S_IFMT) == S_IFLNK) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &quot;</span></div><div class="line">               <span class="stringliteral">&quot;&#39;%s&#39;: it&#39;s already a symbolic link\n&quot;</span>,</div><div class="line">               fs);</div><div class="line">         <span class="keywordflow">return</span> <a name="a367"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (st.st_nlink &gt; 1) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &quot;</span></div><div class="line">               <span class="stringliteral">&quot;&#39;%s&#39;: %u hard links exist\n&quot;</span>,</div><div class="line">               fs, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) st.st_nlink);</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> ((fd = open(fs, O_WRONLY | O_CREAT, 0600)) &lt; 0) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &#39;%s&#39;: %s\n&quot;</span>,</div><div class="line">            fs, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca46f6f55c5ee9576afd8dde6376c2b01a">AST_LOCK_PATH_NOT_FOUND</a>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (!(pl = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*pl)))) {</div><div class="line">      <span class="comment">/* We don&#39;t unlink the lock file here, on the possibility that</span></div><div class="line"><span class="comment">       * someone else created it - better to leave a little mess</span></div><div class="line"><span class="comment">       * than create a big one by destroying someone else&#39;s lock</span></div><div class="line"><span class="comment">       * and causing something to be corrupted.</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      close(fd);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;</div><div class="line">   }</div><div class="line">   pl-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fd;</div><div class="line">   pl-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a> = <a name="a368"></a><a class="code" href="../../d8/d8a/astmm_8h.html#ab263849d03fb892847be4986db759737">ast_strdup</a>(path);</div><div class="line"></div><div class="line">   time(&amp;start);</div><div class="line">   <span class="keywordflow">while</span> (</div><div class="line">      #ifdef SOLARIS</div><div class="line">      ((res = fcntl(pl-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, F_SETLK, fcntl(pl-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, F_GETFL) | O_NONBLOCK)) &lt; 0) &amp;&amp;</div><div class="line">      #else</div><div class="line">      ((res = flock(pl-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, LOCK_EX | LOCK_NB)) &lt; 0) &amp;&amp;</div><div class="line">      #endif</div><div class="line">         (<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EWOULDBLOCK) &amp;&amp;</div><div class="line">         (time(<a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) - start &lt; 5))</div><div class="line">      usleep(1000);</div><div class="line">   <span class="keywordflow">if</span> (res) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock path &#39;%s&#39;: %s\n&quot;</span>,</div><div class="line">            path, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">      <span class="comment">/* No unlinking of lock done, since we tried and failed to</span></div><div class="line"><span class="comment">       * flock() it.</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      <a class="code" href="../../d3/d83/main_2app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(pl);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Check for the race where the file is recreated or deleted out from</span></div><div class="line"><span class="comment">    * underneath us.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordflow">if</span> (lstat(fs, &amp;st) != 0 &amp;&amp; fstat(pl-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;ost) != 0 &amp;&amp;</div><div class="line">         st.st_dev != ost.st_dev &amp;&amp;</div><div class="line">         st.st_ino != ost.st_ino) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create lock file &#39;%s&#39;: &quot;</span></div><div class="line">            <span class="stringliteral">&quot;file changed underneath us\n&quot;</span>, fs);</div><div class="line">      <a class="code" href="../../d3/d83/main_2app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(pl);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* Success: file created, flocked, and is the one we started with */</span></div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>);</div><div class="line">   <a name="a369"></a><a class="code" href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>, pl, le);</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>);</div><div class="line"></div><div class="line">   <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Locked path &#39;%s&#39;\n&quot;</span>, path);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca37bdbc92223520af2a24d5bfd6f561bb">AST_LOCK_SUCCESS</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a370"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a195e5dc48a8d508fb6d85597ce9df398">ast_unlock_path_flock</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *s;</div><div class="line">   <span class="keyword">struct </span><a class="code" href="../../da/da7/structpath__lock.html">path_lock</a> *p;</div><div class="line"></div><div class="line">   s = <a class="code" href="../../d8/d8a/astmm_8h.html#a249282ecc7ba5a1a49fa75e9a33d1717">ast_alloca</a>(strlen(path) + 20);</div><div class="line"></div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>);</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>, p, <a name="a371"></a><a class="code" href="../../da/da7/structpath__lock.html#ab7e7a3bd703a1bac62bcb7bb93580399">le</a>) {</div><div class="line">      <span class="keywordflow">if</span> (!strcmp(p-&gt;<a class="code" href="../../da/da7/structpath__lock.html#a44196e6a5696d10442c29e639437196e">path</a>, path)) {</div><div class="line">         <a class="code" href="../../df/d90/linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c">AST_LIST_REMOVE_CURRENT</a>(<a class="code" href="../../da/da7/structpath__lock.html#ab7e7a3bd703a1bac62bcb7bb93580399">le</a>);</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9">AST_LIST_TRAVERSE_SAFE_END</a>;</div><div class="line">   <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../d4/d9f/structpath__lock__list.html">path_lock_list</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (p) {</div><div class="line">      snprintf(s, strlen(path) + 19, <span class="stringliteral">&quot;%s/lock&quot;</span>, path);</div><div class="line">      unlink(s);</div><div class="line">      <a class="code" href="../../d3/d83/main_2app_8c.html#a76f6ec06f0249fceeecd10687cb62e7d">path_lock_destroy</a>(p);</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Unlocked path &#39;%s&#39;\n&quot;</span>, path);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Failed to unlock path &#39;%s&#39;: &quot;</span></div><div class="line">            <span class="stringliteral">&quot;lock not found\n&quot;</span>, path);</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a372"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#aaef9c9ee6c9e05a6675201486ea2f02e">ast_set_lock_type</a>(<span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241">AST_LOCK_TYPE</a> <a name="a373"></a><a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a>)</div><div class="line">{</div><div class="line">   ast_lock_type = <a class="code" href="../../d7/d49/chan__ooh323_8c.html#a4d63fdfe5451ec2248c16a2739190c56">type</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> <a name="a374"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a74c57b5a842dcbc15cc991a31f679a13">ast_lock_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8c">AST_LOCK_RESULT</a> r = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8cac59129c6f641d69ad14017c1ba1f2635">AST_LOCK_FAILURE</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (ast_lock_type) {</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>:</div><div class="line">      r = <a class="code" href="../../d3/d83/main_2app_8c.html#a5e3efda31e8018f394246681664d447c">ast_lock_path_lockfile</a>(path);</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a375"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241a78cd7e44280d287fc0168a0c31b75e3f">AST_LOCK_TYPE_FLOCK</a>:</div><div class="line">      r = <a class="code" href="../../d3/d83/main_2app_8c.html#a631aa3756c80daa3b4c825189cfc183c">ast_lock_path_flock</a>(path);</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> r;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af6428878db94a4adf8136850e6a654f5">ast_unlock_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> r = 0;</div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (ast_lock_type) {</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241a599f18fdf355d7530bb754b8c66d6de7">AST_LOCK_TYPE_LOCKFILE</a>:</div><div class="line">      r = <a class="code" href="../../d3/d83/main_2app_8c.html#a41764988af00a30b8de64b8a37e8228d">ast_unlock_path_lockfile</a>(path);</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a889fad4c6cc627add80454ae61b53241a78cd7e44280d287fc0168a0c31b75e3f">AST_LOCK_TYPE_FLOCK</a>:</div><div class="line">      r = <a class="code" href="../../d3/d83/main_2app_8c.html#a195e5dc48a8d508fb6d85597ce9df398">ast_unlock_path_flock</a>(path);</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> r;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a376"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a88b6ee77eea0c8a6cc0a315e1c1fc815">ast_record_review</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *playfile, <span class="keyword">const</span> <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> *duration, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> <a class="code" href="../../dc/df4/app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>;</div><div class="line">   <span class="keywordtype">int</span> maxsilence = 0;</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line">   <span class="keywordtype">int</span> cmd = 0;</div><div class="line">   <span class="keywordtype">int</span> max_attempts = 3;</div><div class="line">   <span class="keywordtype">int</span> attempts = 0;</div><div class="line">   <span class="keywordtype">int</span> recorded = 0;</div><div class="line">   <span class="keywordtype">int</span> message_exists = 0;</div><div class="line">   <span class="comment">/* Note that urgent and private are for flagging messages as such in the future */</span></div><div class="line"></div><div class="line">   <span class="comment">/* barf if no pointer passed to store duration in */</span></div><div class="line">   <span class="keywordflow">if</span> (!duration) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error ast_record_review called without duration pointer\n&quot;</span>);</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   cmd = <span class="charliteral">&#39;3&#39;</span>;   <span class="comment">/* Want to start by recording */</span></div><div class="line"></div><div class="line">   silencethreshold = <a name="a377"></a><a class="code" href="../../d3/d08/dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca">ast_dsp_get_threshold_from_settings</a>(<a name="a378"></a><a class="code" href="../../d3/d08/dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a>);</div><div class="line"></div><div class="line">   <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&#39;t&#39;</span>)) {</div><div class="line">      <span class="keywordflow">switch</span> (cmd) {</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:</div><div class="line">         <span class="keywordflow">if</span> (!message_exists) {</div><div class="line">            <span class="comment">/* In this case, 1 is to record a message */</span></div><div class="line">            cmd = <span class="charliteral">&#39;3&#39;</span>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line">            <span class="keywordflow">return</span> res;</div><div class="line">         }</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;2&#39;</span>:</div><div class="line">         <span class="comment">/* Review */</span></div><div class="line">         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Reviewing the recording\n&quot;</span>);</div><div class="line">         cmd = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, recordfile, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>:</div><div class="line">         message_exists = 0;</div><div class="line">         <span class="comment">/* Record */</span></div><div class="line">         <a class="code" href="../../d1/d8c/logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;R%secording\n&quot;</span>, recorded == 1 ? <span class="stringliteral">&quot;e-r&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">         recorded = 1;</div><div class="line">         <span class="keywordflow">if</span> ((cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a675ebd613588a960e37bd6fa2477f30f">ast_play_and_record</a>(chan, playfile, recordfile, maxtime, fmt, duration, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, silencethreshold, maxsilence, path)) == -1) {</div><div class="line">            <span class="comment">/* User has hung up, no options to give */</span></div><div class="line">            <span class="keywordflow">return</span> cmd;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;0&#39;</span>) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;*&#39;</span>) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <span class="comment">/* If all is well, a message exists */</span></div><div class="line">            message_exists = 1;</div><div class="line">            cmd = 0;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;4&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;5&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;6&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;7&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;8&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;9&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;#&#39;</span>:</div><div class="line">         cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">         <span class="keywordflow">if</span> (message_exists) {</div><div class="line">            cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review&quot;</span>);</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <span class="keywordflow">if</span> (!(cmd = <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#abbbec6ab9a303e865a1d1a261152540d">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-torerecord&quot;</span>))) {</div><div class="line">               cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 600);</div><div class="line">            }</div><div class="line">         }</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> (!cmd) {</div><div class="line">            cmd = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, 6000);</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (!cmd) {</div><div class="line">            attempts++;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (attempts &gt; max_attempts) {</div><div class="line">            cmd = <span class="charliteral">&#39;t&#39;</span>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (cmd == <span class="charliteral">&#39;t&#39;</span>) {</div><div class="line">      cmd = 0;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> cmd;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#define RES_UPONE (1 &lt;&lt; 16)</span></div><div class="line"><span class="preprocessor">#define RES_EXIT  (1 &lt;&lt; 17)</span></div><div class="line"><span class="preprocessor">#define RES_REPEAT (1 &lt;&lt; 18)</span></div><div class="line"><span class="preprocessor">#define RES_RESTART ((1 &lt;&lt; 19) | RES_REPEAT)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a379"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a name="_a380"></a><a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">void</span> *cbdata);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a381"></a><a class="code" href="../../d3/d83/main_2app_8c.html#af708a8d2a35e2699cd5b4851c20110e1">ivr_dispatch</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a name="_a382"></a><a class="code" href="../../d1/d18/structast__ivr__option.html">ast_ivr_option</a> *option, <span class="keywordtype">char</span> *<a name="a383"></a><a class="code" href="../../da/d45/chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">void</span> *cbdata)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   int (*ivr_func)(<span class="keyword">struct </span><a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *, <span class="keywordtype">void</span> *);</div><div class="line">   <span class="keywordtype">char</span> *<a class="code" href="../../d7/d6f/test__linkedlists_8c.html#acd9db00336027462cfb25b97b5356883">c</a>;</div><div class="line">   <span class="keywordtype">char</span> *n;</div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (option-&gt;<a name="a384"></a><a class="code" href="../../d1/d18/structast__ivr__option.html#af5aafe3716e15fcb2fb46ac4a7dc10d1">action</a>) {</div><div class="line">   <span class="keywordflow">case</span> <a name="a385"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a23d56e69a479b44ce2f89034fda4ed9a">AST_ACTION_UPONE</a>:</div><div class="line">      <span class="keywordflow">return</span> <a name="a386"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a99e8fc9c191dce9a869c02541d31d178">RES_UPONE</a>;</div><div class="line">   <span class="keywordflow">case</span> <a name="a387"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a9f49762cd1386370ddc2f8fc64965b88">AST_ACTION_EXIT</a>:</div><div class="line">      <span class="keywordflow">return</span> <a name="a388"></a><a class="code" href="../../d3/d83/main_2app_8c.html#ac68f484b9b363ef1c76def178529aadf">RES_EXIT</a> | (((<span class="keywordtype">unsigned</span> long)(option-&gt;<a name="a389"></a><a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>)) &amp; 0xffff);</div><div class="line">   <span class="keywordflow">case</span> <a name="a390"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5ae951cfbea814df40816b70a1eeba65e8">AST_ACTION_REPEAT</a>:</div><div class="line">      <span class="keywordflow">return</span> <a name="a391"></a><a class="code" href="../../d3/d83/main_2app_8c.html#add236e92599b4e2157db3bb1fc4a2757">RES_REPEAT</a> | (((<span class="keywordtype">unsigned</span> long)(option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>)) &amp; 0xffff);</div><div class="line">   <span class="keywordflow">case</span> <a name="a392"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a53ddb6911a10ea526b86f4cde6b2ce80">AST_ACTION_RESTART</a>:</div><div class="line">      <span class="keywordflow">return</span> <a name="a393"></a><a class="code" href="../../d3/d83/main_2app_8c.html#afe510b02adee23bac957dd9db3333dba">RES_RESTART</a> ;</div><div class="line">   <span class="keywordflow">case</span> <a name="a394"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a9470126e5a37e3044d577f6ba1140644">AST_ACTION_NOOP</a>:</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   <span class="keywordflow">case</span> <a name="a395"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5ab738e4ae4a7e6b7cd68b13d2a58985ba">AST_ACTION_BACKGROUND</a>:</div><div class="line">      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>, <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);</div><div class="line">      <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to find file &#39;%s&#39;!\n&quot;</span>, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);</div><div class="line">         res = 0;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> res;</div><div class="line">   <span class="keywordflow">case</span> <a name="a396"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a4bd0306ccd5256f1b150ec9b1d220f0f">AST_ACTION_PLAYBACK</a>:</div><div class="line">      res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">      <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to find file &#39;%s&#39;!\n&quot;</span>, (<span class="keywordtype">char</span> *)option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);</div><div class="line">         res = 0;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> res;</div><div class="line">   <span class="keywordflow">case</span> <a name="a397"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5adc38e521e86969765c95912988cf6e2a">AST_ACTION_MENU</a>:</div><div class="line">      <span class="keywordflow">if</span> ((res = <a class="code" href="../../d3/d83/main_2app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(chan, (<span class="keyword">struct</span> <a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *)option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>, cbdata)) == -2) {</div><div class="line">         <span class="comment">/* Do not pass entry errors back up, treat as though it was an &quot;UPONE&quot; */</span></div><div class="line">         res = 0;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> res;</div><div class="line">   <span class="keywordflow">case</span> <a name="a398"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5ac8b97828ca2347ecf4bf942478ddf0ba">AST_ACTION_WAITOPTION</a>:</div><div class="line">      <span class="keywordflow">if</span> (!(res = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan) ? <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan)-&gt;rtimeoutms : 10000))) {</div><div class="line">         <span class="keywordflow">return</span> <span class="charliteral">&#39;t&#39;</span>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> res;</div><div class="line">   <span class="keywordflow">case</span> <a name="a399"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a911a0be3e05292936e4e6f8646194f7f">AST_ACTION_CALLBACK</a>:</div><div class="line">      ivr_func = option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>;</div><div class="line">      res = ivr_func(chan, cbdata);</div><div class="line">      <span class="keywordflow">return</span> res;</div><div class="line">   <span class="keywordflow">case</span> <a name="a400"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5af34630ccb66618ee9dfef4d14423a6d0">AST_ACTION_TRANSFER</a>:</div><div class="line">      res = <a name="a401"></a><a class="code" href="../../db/de0/pbx_8h.html#ae9b65b0515d88371a5293dd354bfd92f">ast_parseable_goto</a>(chan, option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   <span class="keywordflow">case</span> <a name="a402"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a5a5e2a82ee86aab6a69decbb02514e68">AST_ACTION_PLAYLIST</a>:</div><div class="line">   <span class="keywordflow">case</span> <a name="a403"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a363ce24d1bbcbf4687e4fd21aa1ee621">AST_ACTION_BACKLIST</a>:</div><div class="line">      res = 0;</div><div class="line">      c = <a class="code" href="../../d8/d8a/astmm_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6">ast_strdupa</a>(option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#a473bb69c3a842a12c60b111dc807bf64">adata</a>);</div><div class="line">      <span class="keywordflow">while</span> ((n = <a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c, <span class="stringliteral">&quot;;&quot;</span>))) {</div><div class="line">         <span class="keywordflow">if</span> ((res = <a class="code" href="../../d2/d4d/file_8h.html#a95b94a020720147325a486e210b36775">ast_stream_and_wait</a>(chan, n,</div><div class="line">               (option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#af5aafe3716e15fcb2fb46ac4a7dc10d1">action</a> == <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad4d301d1d98ab8020c6104e3fb58e2d5a363ce24d1bbcbf4687e4fd21aa1ee621">AST_ACTION_BACKLIST</a>) ? <a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a> : <span class="stringliteral">&quot;&quot;</span>))) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">      <a class="code" href="../../d2/d4d/file_8h.html#a3092bf11d4bba66f646562759608b1bc">ast_stopstream</a>(chan);</div><div class="line">      <span class="keywordflow">return</span> res;</div><div class="line">   <span class="keywordflow">default</span>:</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unknown dispatch function %u, ignoring!\n&quot;</span>, option-&gt;<a class="code" href="../../d1/d18/structast__ivr__option.html#af5aafe3716e15fcb2fb46ac4a7dc10d1">action</a>);</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> -1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a404"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">char</span> *option)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> <a name="a405"></a><a class="code" href="../../df/d3c/structast__channel.html#ab06e9aa782b61ccfb42f7c48996f6ed4">x</a>;</div><div class="line">   <span class="keywordflow">for</span> (x = 0; menu-&gt;<a name="a406"></a><a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[<a class="code" href="../../df/d3c/structast__channel.html#ab06e9aa782b61ccfb42f7c48996f6ed4">x</a>].<a name="a407"></a><a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>; x++) {</div><div class="line">      <span class="keywordflow">if</span> (!strcasecmp(menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>, option)) {</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="../../df/d3c/structast__channel.html#ab06e9aa782b61ccfb42f7c48996f6ed4">x</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> -1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a408"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a490ba593992b218981f3dc2a41f15ac4">option_matchmore</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">char</span> *option)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> <a class="code" href="../../df/d3c/structast__channel.html#ab06e9aa782b61ccfb42f7c48996f6ed4">x</a>;</div><div class="line">   <span class="keywordflow">for</span> (x = 0; menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[<a class="code" href="../../df/d3c/structast__channel.html#ab06e9aa782b61ccfb42f7c48996f6ed4">x</a>].<a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>; x++) {</div><div class="line">      <span class="keywordflow">if</span> ((!strncasecmp(menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>, option, strlen(option))) &amp;&amp;</div><div class="line">            (menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[x].<a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>[strlen(option)])) {</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="../../df/d3c/structast__channel.html#ab06e9aa782b61ccfb42f7c48996f6ed4">x</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> -1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a409"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a8e4d0cf43a02ec7e663a50cee18315d2">read_newoption</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">char</span> *exten, <span class="keywordtype">int</span> maxexten)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line">   <span class="keywordtype">int</span> ms;</div><div class="line">   <span class="keywordflow">while</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a490ba593992b218981f3dc2a41f15ac4">option_matchmore</a>(menu, exten)) {</div><div class="line">      ms = <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan) ? <a class="code" href="../../d5/d7b/channel_8h.html#a488b7d6f7488bedc53be45d4ef4471c9">ast_channel_pbx</a>(chan)-&gt;<a class="code" href="../../d6/d83/structast__pbx.html#a80a133d151de25445e8dfd09953a0872">dtimeoutms</a> : 5000;</div><div class="line">      <span class="keywordflow">if</span> (strlen(exten) &gt;= maxexten - 1) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> ((res = <a class="code" href="../../d5/d7b/channel_8h.html#a050bec9a4abc1a599b6573a6091b080c">ast_waitfordigit</a>(chan, ms)) &lt; 1) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">      exten[strlen(exten) + 1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">      exten[strlen(exten)] = res;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> res &gt; 0 ? 0 : res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">void</span> *cbdata)</div><div class="line">{</div><div class="line">   <span class="comment">/* Execute an IVR menu structure */</span></div><div class="line">   <span class="keywordtype">int</span> res = 0;</div><div class="line">   <span class="keywordtype">int</span> pos = 0;</div><div class="line">   <span class="keywordtype">int</span> retries = 0;</div><div class="line">   <span class="keywordtype">char</span> exten[<a name="a410"></a><a class="code" href="../../d5/d7b/channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;s&quot;</span>;</div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;s&quot;</span>) &lt; 0) {</div><div class="line">      strcpy(exten, <span class="stringliteral">&quot;g&quot;</span>);</div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;g&quot;</span>) &lt; 0) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No &#39;s&#39; nor &#39;g&#39; extension in menu &#39;%s&#39;!\n&quot;</span>, menu-&gt;<a name="a411"></a><a class="code" href="../../dd/d62/structast__ivr__menu.html#af06d911bb9e05f491ef3da520d03796c">title</a>);</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">while</span> (!res) {</div><div class="line">      <span class="keywordflow">while</span> (menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[pos].<a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>) {</div><div class="line">         <span class="keywordflow">if</span> (!strcasecmp(menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a>[pos].<a class="code" href="../../d1/d18/structast__ivr__option.html#a756aafa2c9b99eaa7eb7f8886c7a8cb2">option</a>, exten)) {</div><div class="line">            res = <a class="code" href="../../d3/d83/main_2app_8c.html#af708a8d2a35e2699cd5b4851c20110e1">ivr_dispatch</a>(chan, menu-&gt;<a class="code" href="../../dd/d62/structast__ivr__menu.html#a8c135e2e13bd106dbf11387dba36d840">options</a> + pos, exten, cbdata);</div><div class="line">            <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;IVR Dispatch of &#39;%s&#39; (pos %d) yields %d\n&quot;</span>, exten, pos, res);</div><div class="line">            <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp; <a class="code" href="../../d3/d83/main_2app_8c.html#a99e8fc9c191dce9a869c02541d31d178">RES_UPONE</a>) {</div><div class="line">               <span class="keywordflow">return</span> 0;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp; <a class="code" href="../../d3/d83/main_2app_8c.html#ac68f484b9b363ef1c76def178529aadf">RES_EXIT</a>) {</div><div class="line">               <span class="keywordflow">return</span> res;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp; <a class="code" href="../../d3/d83/main_2app_8c.html#add236e92599b4e2157db3bb1fc4a2757">RES_REPEAT</a>) {</div><div class="line">               <span class="keywordtype">int</span> <a name="a412"></a><a class="code" href="../../dd/d27/res__adsi_8c.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a> = res &amp; 0xffff;</div><div class="line">               <span class="keywordflow">if</span> ((res &amp; <a class="code" href="../../d3/d83/main_2app_8c.html#afe510b02adee23bac957dd9db3333dba">RES_RESTART</a>) == RES_RESTART) {</div><div class="line">                  retries = 0;</div><div class="line">               } <span class="keywordflow">else</span> {</div><div class="line">                  retries++;</div><div class="line">               }</div><div class="line">               <span class="keywordflow">if</span> (!maxretries) {</div><div class="line">                  maxretries = 3;</div><div class="line">               }</div><div class="line">               <span class="keywordflow">if</span> ((maxretries &gt; 0) &amp;&amp; (retries &gt;= maxretries)) {</div><div class="line">                  <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Max retries %d exceeded\n&quot;</span>, maxretries);</div><div class="line">                  <span class="keywordflow">return</span> -2;</div><div class="line">               } <span class="keywordflow">else</span> {</div><div class="line">                  <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;g&quot;</span>) &gt; -1) {</div><div class="line">                     strcpy(exten, <span class="stringliteral">&quot;g&quot;</span>);</div><div class="line">                  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;s&quot;</span>) &gt; -1) {</div><div class="line">                     strcpy(exten, <span class="stringliteral">&quot;s&quot;</span>);</div><div class="line">                  }</div><div class="line">               }</div><div class="line">               pos = 0;</div><div class="line">               <span class="keywordflow">continue</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp;&amp; strchr(<a class="code" href="../../d2/d4d/file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, res)) {</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Got start of extension, %c\n&quot;</span>, res);</div><div class="line">               exten[1] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">               exten[0] = res;</div><div class="line">               <span class="keywordflow">if</span> ((res = <a class="code" href="../../d3/d83/main_2app_8c.html#a8e4d0cf43a02ec7e663a50cee18315d2">read_newoption</a>(chan, menu, exten, <span class="keyword">sizeof</span>(exten)))) {</div><div class="line">                  <span class="keywordflow">break</span>;</div><div class="line">               }</div><div class="line">               <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, exten) &lt; 0) {</div><div class="line">                  <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a1b6fbacce14cf53fecf5be43487c0493">option_exists</a>(menu, <span class="stringliteral">&quot;i&quot;</span>)) {</div><div class="line">                     <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Invalid extension entered, going to &#39;i&#39;!\n&quot;</span>);</div><div class="line">                     strcpy(exten, <span class="stringliteral">&quot;i&quot;</span>);</div><div class="line">                     pos = 0;</div><div class="line">                     <span class="keywordflow">continue</span>;</div><div class="line">                  } <span class="keywordflow">else</span> {</div><div class="line">                     <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Aborting on invalid entry, with no &#39;i&#39; option!\n&quot;</span>);</div><div class="line">                     res = -2;</div><div class="line">                     <span class="keywordflow">break</span>;</div><div class="line">                  }</div><div class="line">               } <span class="keywordflow">else</span> {</div><div class="line">                  <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;New existing extension: %s\n&quot;</span>, exten);</div><div class="line">                  pos = 0;</div><div class="line">                  <span class="keywordflow">continue</span>;</div><div class="line">               }</div><div class="line">            }</div><div class="line">         }</div><div class="line">         pos++;</div><div class="line">      }</div><div class="line">      <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(1, <span class="stringliteral">&quot;Stopping option &#39;%s&#39;, res is %d\n&quot;</span>, exten, res);</div><div class="line">      pos = 0;</div><div class="line">      <span class="keywordflow">if</span> (!strcasecmp(exten, <span class="stringliteral">&quot;s&quot;</span>)) {</div><div class="line">         strcpy(exten, <span class="stringliteral">&quot;g&quot;</span>);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a413"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a855c3d16ea8884345a7b1c3fe5a16577">ast_ivr_menu_run</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d3c/structast__channel.html">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="../../dd/d62/structast__ivr__menu.html">ast_ivr_menu</a> *menu, <span class="keywordtype">void</span> *cbdata)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res = <a class="code" href="../../d3/d83/main_2app_8c.html#a09ef1fec8abab2315272f9300705ef04">ast_ivr_menu_run_internal</a>(chan, menu, cbdata);</div><div class="line">   <span class="comment">/* Hide internal coding */</span></div><div class="line">   <span class="keywordflow">return</span> res &gt; 0 ? 0 : res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *<a name="a414"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac5aea5ca8a190e3a89d29b74a09cdb3e">ast_read_textfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> fd, count = 0, res;</div><div class="line">   <span class="keywordtype">char</span> *output = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <span class="keyword">struct </span>stat filesize;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (stat(filename, &amp;filesize) == -1) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error can&#39;t stat %s\n&quot;</span>, filename);</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   count = filesize.st_size + 1;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((fd = open(filename, O_RDONLY)) &lt; 0) {</div><div class="line">      <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open file &#39;%s&#39; for reading: %s\n&quot;</span>, filename, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((output = <a class="code" href="../../d8/d8a/astmm_8h.html#ae63d4f486bcf6eac7c1593f867717d91">ast_malloc</a>(count))) {</div><div class="line">      res = read(fd, output, count - 1);</div><div class="line">      <span class="keywordflow">if</span> (res == count - 1) {</div><div class="line">         output[res] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Short read of %s (%d of %d): %s\n&quot;</span>, filename, res, count - 1, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">         <a class="code" href="../../d8/d8a/astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(output);</div><div class="line">         output = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   close(fd);</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> output;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a415"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a16e02ee9c475cbde97e26554a975e7eb">parse_options</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a name="_a416"></a><a class="code" href="../../d2/d8d/structast__app__option.html">ast_app_option</a> *<a name="a417"></a><a class="code" href="../../d4/d45/test__http__media__cache_8c.html#a80c8e3ae5087d90d422675d034eeebc7">options</a>, <span class="keywordtype">void</span> *_flags, <span class="keywordtype">char</span> **args, <span class="keywordtype">char</span> *optstr, <span class="keywordtype">int</span> flaglen)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *s, *arg;</div><div class="line">   <span class="keywordtype">int</span> curarg, res = 0;</div><div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> argloc;</div><div class="line">   <span class="keyword">struct </span><a name="_a418"></a><a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> *<a name="a419"></a><a class="code" href="../../dc/dac/structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = _flags;</div><div class="line">   <span class="keyword">struct </span><a name="_a420"></a><a class="code" href="../../d5/d10/structast__flags64.html">ast_flags64</a> *flags64 = _flags;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (flaglen == 32) {</div><div class="line">      <a class="code" href="../../d5/d60/utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(flags, <a name="a421"></a><a class="code" href="../../d5/d60/utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      flags64-&gt;<a name="a422"></a><a class="code" href="../../d5/d10/structast__flags64.html#a899a76dc5f03f0d4ea3793c339e07ee9">flags</a> = 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (!optstr) {</div><div class="line">      <span class="keywordflow">return</span> 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   s = optstr;</div><div class="line">   <span class="keywordflow">while</span> (*s) {</div><div class="line">      curarg = *s++ &amp; 0x7f;   <span class="comment">/* the array (in app.h) has 128 entries */</span></div><div class="line">      argloc = options[curarg].<a name="a423"></a><a class="code" href="../../d2/d8d/structast__app__option.html#a7fba4686db1ab2c33d8920fb7019d916">arg_index</a>;</div><div class="line">      <span class="keywordflow">if</span> (*s == <span class="charliteral">&#39;(&#39;</span>) {</div><div class="line">         <span class="keywordtype">int</span> paren = 1, <a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> = 0;</div><div class="line">         <span class="keywordtype">int</span> parsequotes = (s[1] == <span class="charliteral">&#39;&quot;&#39;</span>) ? 1 : 0;</div><div class="line"></div><div class="line">         <span class="comment">/* Has argument */</span></div><div class="line">         arg = ++s;</div><div class="line">         <span class="keywordflow">for</span> (; *s; s++) {</div><div class="line">            <span class="keywordflow">if</span> (*s == <span class="charliteral">&#39;(&#39;</span> &amp;&amp; !<a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a>) {</div><div class="line">               paren++;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">&#39;)&#39;</span> &amp;&amp; !<a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a>) {</div><div class="line">               <span class="comment">/* Count parentheses, unless they&#39;re within quotes (or backslashed, below) */</span></div><div class="line">               paren--;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">&#39;&quot;&#39;</span> &amp;&amp; parsequotes) {</div><div class="line">               <span class="comment">/* Leave embedded quotes alone, unless they are the first character */</span></div><div class="line">               <a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> = <a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> ? 0 : 1;</div><div class="line">               <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(s, s + 1, INT_MAX);</div><div class="line">               s--;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">&#39;\\&#39;</span>) {</div><div class="line">               <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a>) {</div><div class="line">                  <span class="comment">/* If a backslash is found outside of quotes, remove it */</span></div><div class="line">                  <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(s, s + 1, INT_MAX);</div><div class="line">               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1e/func__strings_8c.html#ab8fe909862ff885d9e233ff9ad5e54dd">quote</a> &amp;&amp; s[1] == <span class="charliteral">&#39;&quot;&#39;</span>) {</div><div class="line">                  <span class="comment">/* Backslash for a quote character within quotes, remove the backslash */</span></div><div class="line">                  <a class="code" href="../../d6/d90/strings_8h.html#ac4040268f7b6ed77dfc49c7767626369">ast_copy_string</a>(s, s + 1, INT_MAX);</div><div class="line">               } <span class="keywordflow">else</span> {</div><div class="line">                  <span class="comment">/* Backslash within quotes, keep both characters */</span></div><div class="line">                  s++;</div><div class="line">               }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (paren == 0) {</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <span class="comment">/* This will find the closing paren we found above, or none, if the string ended before we found one. */</span></div><div class="line">         <span class="keywordflow">if</span> ((s = strchr(s, <span class="charliteral">&#39;)&#39;</span>))) {</div><div class="line">            <span class="keywordflow">if</span> (argloc) {</div><div class="line">               args[argloc - 1] = arg;</div><div class="line">            }</div><div class="line">            *s++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Missing closing parenthesis for argument &#39;%c&#39; in string &#39;%s&#39;\n&quot;</span>, curarg, arg);</div><div class="line">            res = -1;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argloc) {</div><div class="line">         args[argloc - 1] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">if</span> (flaglen == 32) {</div><div class="line">         <a class="code" href="../../d5/d60/utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(flags, options[curarg].<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a name="a424"></a><a class="code" href="../../d5/d60/utils_8h.html#ab2de736b42974f12ec7d57c41d234bf4">ast_set_flag64</a>(flags64, options[curarg].<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>);</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a425"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb">ast_app_parse_options</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d2/d8d/structast__app__option.html">ast_app_option</a> *options, <span class="keyword">struct</span> <a class="code" href="../../dc/dac/structast__flags.html">ast_flags</a> *flags, <span class="keywordtype">char</span> **args, <span class="keywordtype">char</span> *optstr)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a16e02ee9c475cbde97e26554a975e7eb">parse_options</a>(options, flags, args, optstr, 32);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a426"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#af85cb9dfd2fea9cfe820d2323c7dd471">ast_app_parse_options64</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d2/d8d/structast__app__option.html">ast_app_option</a> *options, <span class="keyword">struct</span> <a class="code" href="../../d5/d10/structast__flags64.html">ast_flags64</a> *flags, <span class="keywordtype">char</span> **args, <span class="keywordtype">char</span> *optstr)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a16e02ee9c475cbde97e26554a975e7eb">parse_options</a>(options, flags, args, optstr, 64);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a427"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#adc36d870f1a77a726a74f4891f1365d3">ast_app_options2str64</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d2/d8d/structast__app__option.html">ast_app_option</a> *options, <span class="keyword">struct</span> <a class="code" href="../../d5/d10/structast__flags64.html">ast_flags64</a> *flags, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len)</div><div class="line">{</div><div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, found = 0;</div><div class="line">   <span class="keywordflow">for</span> (i = 32; i &lt; 128 &amp;&amp; found &lt; <a class="code" href="../../d9/d1e/func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>; i++) {</div><div class="line">      <span class="keywordflow">if</span> (<a name="a428"></a><a class="code" href="../../d5/d60/utils_8h.html#a17ef965a8317b037c32e9b58c3765b1a">ast_test_flag64</a>(flags, options[i].<a class="code" href="../../dc/dc2/f2c_8h.html#abf5d144da384425ae6cb542ce6eec8d3">flag</a>)) {</div><div class="line">         buf[found++] = i;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   buf[found] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a429"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1e8f73e62b3c2243eca582ee0d8d6147">ast_get_encoded_char</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stream, <span class="keywordtype">char</span> *<a name="a430"></a><a class="code" href="../../de/d1b/cel__pgsql_8c.html#ad6c487210772a9b4b0ca04b04b847d4c">result</a>, <span class="keywordtype">size_t</span> *consumed)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> i;</div><div class="line">   *consumed = 1;</div><div class="line">   *result = 0;</div><div class="line">   <span class="keywordflow">if</span> (<a class="code" href="../../d6/d90/strings_8h.html#a372554b7a2d69a8bd3adac5157672036">ast_strlen_zero</a>(stream)) {</div><div class="line">      *consumed = 0;</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (*stream == <span class="charliteral">&#39;\\&#39;</span>) {</div><div class="line">      *consumed = 2;</div><div class="line">      <span class="keywordflow">switch</span> (*(stream + 1)) {</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div><div class="line">         *result = <span class="charliteral">&#39;\n&#39;</span>;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div><div class="line">         *result = <span class="charliteral">&#39;\r&#39;</span>;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div><div class="line">         *result = <span class="charliteral">&#39;\t&#39;</span>;</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>:</div><div class="line">         <span class="comment">/* Hexadecimal */</span></div><div class="line">         <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789ABCDEFabcdef&quot;</span>, *(stream + 2)) &amp;&amp; *(stream + 2) != <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">            *consumed = 3;</div><div class="line">            <span class="keywordflow">if</span> (*(stream + 2) &lt;= <span class="charliteral">&#39;9&#39;</span>) {</div><div class="line">               *result = *(stream + 2) - <span class="charliteral">&#39;0&#39;</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(stream + 2) &lt;= <span class="charliteral">&#39;F&#39;</span>) {</div><div class="line">               *result = *(stream + 2) - <span class="charliteral">&#39;A&#39;</span> + 10;</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">               *result = *(stream + 2) - <span class="charliteral">&#39;a&#39;</span> + 10;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Illegal character &#39;%c&#39; in hexadecimal string\n&quot;</span>, *(stream + 2));</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">         }</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;0123456789ABCDEFabcdef&quot;</span>, *(stream + 3)) &amp;&amp; *(stream + 3) != <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">            *consumed = 4;</div><div class="line">            *result &lt;&lt;= 4;</div><div class="line">            <span class="keywordflow">if</span> (*(stream + 3) &lt;= <span class="charliteral">&#39;9&#39;</span>) {</div><div class="line">               *result += *(stream + 3) - <span class="charliteral">&#39;0&#39;</span>;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(stream + 3) &lt;= <span class="charliteral">&#39;F&#39;</span>) {</div><div class="line">               *result += *(stream + 3) - <span class="charliteral">&#39;A&#39;</span> + 10;</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">               *result += *(stream + 3) - <span class="charliteral">&#39;a&#39;</span> + 10;</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;0&#39;</span>:</div><div class="line">         <span class="comment">/* Octal */</span></div><div class="line">         *consumed = 2;</div><div class="line">         <span class="keywordflow">for</span> (i = 2; ; i++) {</div><div class="line">            <span class="keywordflow">if</span> (strchr(<span class="stringliteral">&quot;01234567&quot;</span>, *(stream + i)) &amp;&amp; *(stream + i) != <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">               (*consumed)++;</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;result was %d, &quot;</span>, *result);</div><div class="line">               *result &lt;&lt;= 3;</div><div class="line">               *result += *(stream + i) - <span class="charliteral">&#39;0&#39;</span>;</div><div class="line">               <a class="code" href="../../d1/d8c/logger_8h.html#a3f248112c8d6ce7e3959aa723dade648">ast_debug</a>(5, <span class="stringliteral">&quot;is now %d\n&quot;</span>, *result);</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">               <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">         *result = *(stream + 1);</div><div class="line">      }</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      *result = *stream;</div><div class="line">      *consumed = 1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *<a name="a431"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a2fdf311701900d162bced0d30e923b92">ast_get_encoded_str</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *stream, <span class="keywordtype">char</span> *result, <span class="keywordtype">size_t</span> result_size)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> *cur = <a class="code" href="../../de/d1b/cel__pgsql_8c.html#ad6c487210772a9b4b0ca04b04b847d4c">result</a>;</div><div class="line">   <span class="keywordtype">size_t</span> consumed;</div><div class="line"></div><div class="line">   <span class="keywordflow">while</span> (cur &lt; result + result_size - 1 &amp;&amp; !<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1e8f73e62b3c2243eca582ee0d8d6147">ast_get_encoded_char</a>(stream, cur, &amp;consumed)) {</div><div class="line">      cur++;</div><div class="line">      stream += consumed;</div><div class="line">   }</div><div class="line">   *cur = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../de/d1b/cel__pgsql_8c.html#ad6c487210772a9b4b0ca04b04b847d4c">result</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a432"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1528703fa0e2ea11fcab7e04f8e0a6cb">ast_str_get_encoded_str</a>(<span class="keyword">struct</span> <a name="_a433"></a><a class="code" href="../../dd/da2/structast__str.html">ast_str</a> **<a name="a434"></a><a class="code" href="../../de/dcd/app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <span class="keywordtype">int</span> maxlen, <span class="keyword">const</span> <span class="keywordtype">char</span> *stream)</div><div class="line">{</div><div class="line">   <span class="keywordtype">char</span> <a name="a435"></a><a class="code" href="../../d9/dee/structzombie.html#a5f5910a6fe98c12053e406a34e17f076">next</a>, *<a class="code" href="../../dd/d7c/eagi__proxy_8c.html#ac95651d79c608a3148973b5b1fc9e525">buf</a>;</div><div class="line">   <span class="keywordtype">size_t</span> offset = 0;</div><div class="line">   <span class="keywordtype">size_t</span> consumed;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (strchr(stream, <span class="charliteral">&#39;\\&#39;</span>)) {</div><div class="line">      <span class="keywordflow">while</span> (!<a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1e8f73e62b3c2243eca582ee0d8d6147">ast_get_encoded_char</a>(stream, &amp;next, &amp;consumed)) {</div><div class="line">         <span class="keywordflow">if</span> (offset + 2 &gt; <a name="a436"></a><a class="code" href="../../d6/d90/strings_8h.html#ae99d6f51ac4be6b72f8b63892cd949e1">ast_str_size</a>(*str) &amp;&amp; maxlen &gt; -1) {</div><div class="line">            <a name="a437"></a><a class="code" href="../../d6/d90/strings_8h.html#aa3d67163f6a94e575ee602933adf1eab">ast_str_make_space</a>(str, maxlen &gt; 0 ? maxlen : (<a class="code" href="../../d6/d90/strings_8h.html#ae99d6f51ac4be6b72f8b63892cd949e1">ast_str_size</a>(*str) + 48) * 2 - 48);</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (offset + 2 &gt; <a class="code" href="../../d6/d90/strings_8h.html#ae99d6f51ac4be6b72f8b63892cd949e1">ast_str_size</a>(*str)) {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         buf = <a name="a438"></a><a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(*str);</div><div class="line">         buf[offset++] = <a class="code" href="../../d9/dee/structzombie.html#a5f5910a6fe98c12053e406a34e17f076">next</a>;</div><div class="line">         stream += consumed;</div><div class="line">      }</div><div class="line">      buf = <a class="code" href="../../d6/d90/strings_8h.html#a1ef7e2644ca7258070db316fdc0a465b">ast_str_buffer</a>(*str);</div><div class="line">      buf[offset++] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line">      <a name="a439"></a><a class="code" href="../../d6/d90/strings_8h.html#aa64825674476f476402283fe4bd7ee51">ast_str_update</a>(*str);</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <a name="a440"></a><a class="code" href="../../d6/d90/strings_8h.html#aa3341f35cedca29e60bb7f3927204283">ast_str_set</a>(str, maxlen, <span class="stringliteral">&quot;%s&quot;</span>, stream);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a441"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97">ast_close_fds_above_n</a>(<span class="keywordtype">int</span> n)</div><div class="line">{</div><div class="line">   <a name="a442"></a><a class="code" href="../../de/da3/include_2asterisk_2compat_8h.html#aae1c872491c8aaf5d990b5a868cb22ca">closefrom</a>(n + 1);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a443"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0">ast_safe_fork</a>(<span class="keywordtype">int</span> stop_reaper)</div><div class="line">{</div><div class="line">   sigset_t signal_set, old_set;</div><div class="line">   <span class="keywordtype">int</span> <a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>;</div><div class="line"></div><div class="line">   <span class="comment">/* Don&#39;t let the default signal handler for children reap our status */</span></div><div class="line">   <span class="keywordflow">if</span> (stop_reaper) {</div><div class="line">      <a name="a444"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a6de8ef28c39cc39978497de1918bfd70">ast_replace_sigchld</a>();</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">/* GCC 4.9 gives a bogus &quot;right-hand operand of comma expression has</span></div><div class="line"><span class="comment">    * no effect&quot; warning */</span></div><div class="line">   (void) sigfillset(&amp;signal_set);</div><div class="line">   pthread_sigmask(SIG_BLOCK, &amp;signal_set, &amp;old_set);</div><div class="line"></div><div class="line">   pid = fork();</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (pid != 0) {</div><div class="line">      <span class="comment">/* Fork failed or parent */</span></div><div class="line">      pthread_sigmask(SIG_SETMASK, &amp;old_set, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">      <span class="keywordflow">if</span> (!stop_reaper &amp;&amp; pid &gt; 0) {</div><div class="line">         <span class="keyword">struct </span><a class="code" href="../../d9/dee/structzombie.html">zombie</a> *cur = <a class="code" href="../../d8/d8a/astmm_8h.html#ae0cd4c5524b01287ab19cbe233d9cebb">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*cur));</div><div class="line">         <span class="keywordflow">if</span> (cur) {</div><div class="line">            cur-&gt;<a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a> = <a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>;</div><div class="line">            <a class="code" href="../../df/d90/linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40">AST_LIST_LOCK</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>);</div><div class="line">            <a class="code" href="../../df/d90/linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>, cur, <a class="code" href="../../d9/dee/structzombie.html#a5bd10d1c7630722dd91dbfca2156072c">list</a>);</div><div class="line">            <a class="code" href="../../df/d90/linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="../../dc/d57/structzombies.html">zombies</a>);</div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d83/main_2app_8c.html#a30573cb092e715a2e4bbc2d77b9fc1df">shaun_of_the_dead_thread</a> == <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {</div><div class="line">               <span class="keywordflow">if</span> (<a name="a445"></a><a class="code" href="../../d5/d60/utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;<a class="code" href="../../d3/d83/main_2app_8c.html#a30573cb092e715a2e4bbc2d77b9fc1df">shaun_of_the_dead_thread</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d83/main_2app_8c.html#a7696b4a837797103e8fad638d5b4615d">shaun_of_the_dead</a>, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line">                  <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Shaun of the Dead wants to kill zombies, but can&#39;t?!!\n&quot;</span>);</div><div class="line">                  <a class="code" href="../../d3/d83/main_2app_8c.html#a30573cb092e715a2e4bbc2d77b9fc1df">shaun_of_the_dead_thread</a> = <a class="code" href="../../dd/d42/lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;</div><div class="line">               }</div><div class="line">            }</div><div class="line">         }</div><div class="line">      }</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>;</div><div class="line">   } <span class="keywordflow">else</span> {</div><div class="line">      <span class="comment">/* Child */</span></div><div class="line"><span class="preprocessor">#ifdef HAVE_CAP</span></div><div class="line">      cap_set_proc(<a class="code" href="../../d3/d83/main_2app_8c.html#a0e01e4a7836c72a22f08f824d366ffb0">child_cap</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">      <span class="comment">/* Before we unblock our signals, return our trapped signals back to the defaults */</span></div><div class="line">      signal(SIGHUP, SIG_DFL);</div><div class="line">      signal(SIGCHLD, SIG_DFL);</div><div class="line">      signal(SIGINT, SIG_DFL);</div><div class="line">      signal(SIGURG, SIG_DFL);</div><div class="line">      signal(SIGTERM, SIG_DFL);</div><div class="line">      signal(SIGPIPE, SIG_DFL);</div><div class="line">      signal(SIGXFSZ, SIG_DFL);</div><div class="line"></div><div class="line">      <span class="comment">/* unblock important signal handlers */</span></div><div class="line">      <span class="keywordflow">if</span> (pthread_sigmask(SIG_UNBLOCK, &amp;signal_set, <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {</div><div class="line">         <a class="code" href="../../da/df7/astobj2_8c.html#a96a00b3a518d7f32b6d51dc28f09bf9b">ast_log</a>(<a class="code" href="../../d1/d8c/logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unable to unblock signals: %s\n&quot;</span>, strerror(<a class="code" href="../../d1/d6e/main_2stdtime_2private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));</div><div class="line">         _exit(1);</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../d9/dee/structzombie.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>;</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a446"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a1044fae6847dc8986a212af0af492a23">ast_safe_fork_cleanup</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <a name="a447"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ad7c2a7da4125347c06d9719580731228">ast_unreplace_sigchld</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a448"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a33ca869933a6085e179804d610790845">ast_app_parse_timelen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *timestr, <span class="keywordtype">int</span> *result, <span class="keyword">enum</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155">ast_timelen</a> unit)</div><div class="line">{</div><div class="line">   <span class="keywordtype">int</span> res;</div><div class="line">   <span class="keywordtype">char</span> u[10];</div><div class="line"><span class="preprocessor">#ifdef HAVE_LONG_DOUBLE_WIDER</span></div><div class="line">   <span class="keywordtype">long</span> <span class="keywordtype">double</span> amount;</div><div class="line"><span class="preprocessor">   #define FMT &quot;%30Lf%9s&quot;</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line">   <span class="keywordtype">double</span> amount;</div><div class="line"><span class="preprocessor">   #define FMT &quot;%30lf%9s&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">   <span class="keywordflow">if</span> (!timestr) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line"></div><div class="line">   res = sscanf(timestr, <a name="a449"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a3dfb8ef0d04e938194da60b4420c7517">FMT</a>, &amp;amount, u);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (res == 0 || res == EOF) {</div><div class="line"><span class="preprocessor">#undef FMT</span></div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 2) {</div><div class="line">      <span class="keywordflow">switch</span> (u[0]) {</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;H&#39;</span>:</div><div class="line">         unit = <a name="a450"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a9e86fde4889019aa4529786d4cc7246a">TIMELEN_HOURS</a>;</div><div class="line">         <span class="keywordflow">if</span> (u[1] != <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:</div><div class="line">         unit = <a name="a451"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a99025f253e368c2e42b6e431451a518b">TIMELEN_SECONDS</a>;</div><div class="line">         <span class="keywordflow">if</span> (u[1] != <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div><div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:</div><div class="line">         <span class="keywordflow">if</span> (toupper(u[1]) == <span class="charliteral">&#39;S&#39;</span>) {</div><div class="line">            unit = <a name="a452"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a018e6dbbefd4b00f8c5c45df1f371d1b">TIMELEN_MILLISECONDS</a>;</div><div class="line">            <span class="keywordflow">if</span> (u[2] != <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">               <span class="keywordflow">return</span> -1;</div><div class="line">            }</div><div class="line">         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u[1] == <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line">            unit = <a name="a453"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a3f58d4b5b86ee51110b8cf9afd803a06">TIMELEN_MINUTES</a>;</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">         <span class="keywordflow">return</span> -1;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (unit) {</div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a9e86fde4889019aa4529786d4cc7246a">TIMELEN_HOURS</a>:</div><div class="line">      amount *= 60;</div><div class="line">      <span class="comment">/* fall-through */</span></div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a3f58d4b5b86ee51110b8cf9afd803a06">TIMELEN_MINUTES</a>:</div><div class="line">      amount *= 60;</div><div class="line">      <span class="comment">/* fall-through */</span></div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a99025f253e368c2e42b6e431451a518b">TIMELEN_SECONDS</a>:</div><div class="line">      amount *= 1000;</div><div class="line">      <span class="comment">/* fall-through */</span></div><div class="line">   <span class="keywordflow">case</span> <a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ac1d6b3a36d31df3737b9a83c3a9b1155a018e6dbbefd4b00f8c5c45df1f371d1b">TIMELEN_MILLISECONDS</a>:</div><div class="line">      ;</div><div class="line">   }</div><div class="line">   *result = amount &gt; INT_MAX ? INT_MAX : (int) amount;</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d9/d1d/structstasis__topic.html">stasis_topic</a> *<a name="a454"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#ade65e4a6a8802772595db25eb8e500ea">ast_queue_topic_all</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="../../d3/d83/main_2app_8c.html#a6faa8563ee6f21a1e504dd8b7c3dd5b2">queue_topic_all</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../d9/d1d/structstasis__topic.html">stasis_topic</a> *<a name="a455"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a88bee182f285c3e0b206c1de01324fc4">ast_queue_topic</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *queuename)</div><div class="line">{</div><div class="line">   <span class="keywordflow">return</span> <a name="a456"></a><a class="code" href="../../dd/d79/stasis_8h.html#a1ee1df597af46f3b489cce002b604a89">stasis_topic_pool_get_topic</a>(queue_topic_pool, queuename);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a457"></a><a class="code" href="../../d3/d83/main_2app_8c.html#a7ed4aae8b86b928d2c0e0b84db9f5a15">app_cleanup</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#ifdef HAS_CAP</span></div><div class="line">   cap_free(<a class="code" href="../../d3/d83/main_2app_8c.html#a0e01e4a7836c72a22f08f824d366ffb0">child_cap</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(queue_topic_pool);</div><div class="line">   queue_topic_pool = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">   <a class="code" href="../../d5/da5/astobj2_8h.html#a6321ee982370c55ab3c24c72c562cbdd">ao2_cleanup</a>(queue_topic_all);</div><div class="line">   queue_topic_all = <a class="code" href="../../dc/d7f/resample_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a458"></a><a class="code" href="../../d3/d93/include_2asterisk_2app_8h.html#a2e2efabbeb1c8c68790bb90ce01c4578">app_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <a name="a459"></a><a class="code" href="../../db/db2/asterisk_8h.html#a412442e1beffe5bec07ed2e9ea72afc3">ast_register_cleanup</a>(<a class="code" href="../../d3/d83/main_2app_8c.html#a7ed4aae8b86b928d2c0e0b84db9f5a15">app_cleanup</a>);</div><div class="line"><span class="preprocessor">#ifdef HAVE_CAP</span></div><div class="line">   <a class="code" href="../../d3/d83/main_2app_8c.html#a0e01e4a7836c72a22f08f824d366ffb0">child_cap</a> = cap_from_text(<span class="stringliteral">&quot;cap_net_admin-eip&quot;</span>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">   queue_topic_all = <a name="a460"></a><a class="code" href="../../dd/d79/stasis_8h.html#acac26206b971b094c90839b4049cb6cc">stasis_topic_create</a>(<span class="stringliteral">&quot;queue:all&quot;</span>);</div><div class="line">   <span class="keywordflow">if</span> (!queue_topic_all) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   queue_topic_pool = <a name="a461"></a><a class="code" href="../../dd/d79/stasis_8h.html#aeb9a69946c2be89329630328f125330d">stasis_topic_pool_create</a>(queue_topic_all);</div><div class="line">   <span class="keywordflow">if</span> (!queue_topic_pool) {</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 8 2021 19:42:56 for Asterisk - The Open Source Telephony Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
